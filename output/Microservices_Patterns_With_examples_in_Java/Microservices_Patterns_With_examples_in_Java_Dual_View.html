<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microservices_Patterns_With_examples_in_Java - نسخه دوزبانه</title>
    <link rel="stylesheet" href="fontiran.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
    <style>
        @page {
            size: A3 landscape;
            margin: 1cm;
        }
        body {
            font-family: IRANSansX, Tahoma, Arial, sans-serif;
            line-height: 1.8;
            margin: 0;
            padding: 20px;
            background-color: white;
        }
        .book-title {
            text-align: center;
            font-size: 24pt;
            margin: 2cm 0 1cm 0;
        }
        .book-subtitle {
            text-align: center;
            font-size: 18pt;
            margin-bottom: 2cm;
        }
        .dual-page-container {
            display: flex;
            flex-wrap: wrap;
        }
        .dual-page-spread {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 1cm;
            page-break-after: always;
        }
        .page {
            width: 48%;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 1cm;
            margin: 0 0.5%;
            box-sizing: border-box;
        }
        .persian-page {
            text-align: right;
            direction: rtl;
        }
        .original-page {
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .original-page img {
            max-width: 100%;
            max-height: 100%;
        }
        .persian-translation {
            font-size: 14pt;
        }
        .page-images {
            text-align: center;
            margin-top: 1cm;
        }
        .page-images img {
            max-width: 100%;
            height: auto;
            margin: 0.5cm 0;
        }
        pre {
            direction: ltr;
            text-align: left;
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
        }
        code {
            font-family: 'Courier New', Courier, monospace;
            direction: ltr;
            text-align: left;
        }
        span[dir="ltr"] {
            display: inline-block;
            direction: ltr;
            text-align: left;
        }
    </style>
</head>
<body>
    <h1 class="book-title">Microservices_Patterns_With_examples_in_Java</h1>
    <h2 class="book-subtitle">نسخه دوزبانه</h2>
    
    <div class="dual-page-container">
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>
<strong style="font-size: 1.5em;">M A N N I N G</strong>
</p>
<p>
<em style="font-size: 1.2em;">Chris Richardson</em>
</p>
</div>
</div>
                <div class="page-images">
<div class="page-image"><img alt="Image from page 1" src="page_0001/image_1.png"/></div>
<div class="page-image"><img alt="Image from page 1" src="page_0001/image_2.png"/></div>
<div class="page-image"><img alt="Image from page 1" src="page_0001/image_3.png"/></div>
<div class="page-image"><img alt="Image from page 1" src="page_0001/image_4.png"/></div>
<div class="page-image"><img alt="Image from page 1" src="page_0001/image_5.png"/></div>
<div class="page-image"><img alt="Image from page 1" src="page_0001/image_6.png"/></div>
<div class="page-image"><img alt="Image from page 1" src="page_0001/image_7.png"/></div>
<div class="page-image"><img alt="Image from page 1" src="page_0001/image_8.png"/></div>
</div>
            </div>
            <div class="page original-page">
                <img src="page_0001_original/original_page.png" alt="Original Page 1">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3 style="font-size: 1.5em;">List of Patterns</h3>
<h4>Application architecture patterns</h4>
<ul>
<li><strong>Monolithic architecture</strong> (40)</li>
<li><strong>Microservice architecture</strong> (40)</li>
</ul>
<h4>Decomposition patterns</h4>
<ul>
<li>Decompose by business capability (51)</li>
<li>Decompose by subdomain (54)</li>
</ul>
<h4>Messaging style patterns</h4>
<ul>
<li>Messaging (85)</li>
<li>Remote procedure invocation (72)</li>
</ul>
<h4>Reliable communications patterns</h4>
<ul>
<li>Circuit breaker (78)</li>
</ul>
<h4>Service discovery patterns</h4>
<ul>
<li>3rd party registration (85)</li>
<li>Client-side discovery (83)</li>
<li>Self-registration (82)</li>
<li>Server-side discovery (85)</li>
</ul>
<h4>Transactional messaging patterns</h4>
<ul>
<li>Polling publisher (98)</li>
<li>Transaction log tailing (99)</li>
<li>Transactional outbox (98)</li>
</ul>
<h4>Data consistency patterns</h4>
<ul>
<li>Saga (114)</li>
</ul>
<h4>Business logic design patterns</h4>
<ul>
<li>Aggregate (150)</li>
<li>Domain event (160)</li>
<li>Domain model (150)</li>
<li>Event sourcing (184)</li>
<li>Transaction script (149)</li>
</ul>
<h4>Querying patterns</h4>
<ul>
<li>API composition (223)</li>
<li>Command query responsibility segregation (228)</li>
</ul>
<h4>External API patterns</h4>
<ul>
<li>API gateway (259)</li>
<li>Backends for frontends (265)</li>
</ul>
<h4>Testing patterns</h4>
<ul>
<li>Consumer-driven contract test (302)</li>
<li>Consumer-side contract test (303)</li>
<li>Service component test (335)</li>
</ul>
<h4>Security patterns</h4>
<ul>
<li>Access token (354)</li>
</ul>
<h4>Cross-cutting concerns patterns</h4>
<ul>
<li>Externalized configuration (361)</li>
<li>Microservice chassis (379)</li>
</ul>
<h4>Observability patterns</h4>
<ul>
<li>Application metrics (373)</li>
<li>Audit logging (377)</li>
<li>Distributed tracing (370)</li>
<li>Exception tracking (376)</li>
<li>Health check API (366)</li>
<li>Log aggregation (368)</li>
</ul>
<h4>Deployment patterns</h4>
<ul>
<li>Deploy a service as a container (393)</li>
<li>Deploy a service as a VM (390)</li>
<li>Language-specific packaging format (387)</li>
<li>Service mesh (380)</li>
<li>Serverless deployment (416)</li>
<li>Sidecar (410)</li>
</ul>
<h4>Refactoring to microservices patterns</h4>
<ul>
<li>Anti-corruption layer (447)</li>
<li>Strangler application (432)</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0002_original/original_page.png" alt="Original Page 2">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3 style="font-size: 1.5em;">Microservices Patterns</h3>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0003_original/original_page.png" alt="Original Page 3">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3 style="font-size: 1.5em;">Microservices Patterns</h3>
<p style="font-style: italic;">WITH EXAMPLES IN JAVA</p>
<p>
<strong style="font-size: 1.2em;">CHRIS RICHARDSON</strong>
</p>
<p>
<strong style="font-size: 1.2em;">M A N N I N G</strong>
</p>
<p>SHELTER ISLAND</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0005_original/original_page.png" alt="Original Page 5">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>برای اطلاعات online و سفارش این و سایر کتاب‌های Manning، لطفاً از وب‌سایت
    <a href="http://www.manning.com">www.manning.com</a> بازدید کنید. ناشر برای این کتاب
    در صورت سفارش عمده، تخفیف ارائه می‌دهد.</p>
<p>برای اطلاعات بیشتر، لطفاً با بخش فروش ویژه تماس بگیرید:</p>
<p>
<strong>Special Sales Department</strong>
<br/>
    Manning Publications Co.
    <br/>
    20 Baldwin Road
    <br/>
    PO Box 761
    <br/>
    Shelter Island, NY 11964
    <br/>
    Email: <a href="mailto:orders@manning.com">orders@manning.com</a>
</p>
<p>©2019 by Chris Richardson. All rights reserved.</p>
<p>
    هیچ بخشی از این publication نباید تکثیر، در یک system بازیابی ذخیره یا منتقل شود،
    به هر form یا توسط means الکترونیکی، مکانیکی، فتوکپی یا غیره، بدون written قبلی
    از publisher.
  </p>
<p>
    بسیاری از designations مورد استفاده توسط تولیدکنندگان و فروشندگان برای تمایز محصولاتشان به عنوان
    trademarks ادعا شده‌اند. در جایی که آن designations در کتاب ظاهر می‌شوند، و Manning
    Publications از یک trademark claim آگاه بود، designations در initial caps
    یا all caps چاپ شده‌اند.
  </p>
<p>
    با درک اهمیت حفظ آنچه نوشته شده است، این policy از Manning است که کتاب‌هایی را که منتشر می‌کنیم
    روی کاغذ acid-free چاپ کنیم و ما بهترین تلاش خود را در این راستا انجام می‌دهیم.
    همچنین با درک مسئولیت خود در حفظ منابع سیاره‌مان، کتاب‌های Manning
    بر روی کاغذی چاپ می‌شوند که حداقل 15 درصد آن بازیافتی است و بدون استفاده از
    کلر عنصری پردازش شده است.
  </p>
<p>Manning Publications Co.</p>
<p>
    Development editor: Marina Michaels
    <br/>
    20 Baldwin Road
    <br/>
    Technical development editor: Christian Mennerich
    <br/>
    PO Box 761
    <br/>
    Review editor: Aleksandar Dragosavljevic´
    <br/>
    Shelter Island, NY 11964
    <br/>
    Project editor: Lori Weidert
    <br/>
    Copy editor: Corbin Collins
    <br/>
    Proofreader: Alyson Brener
    <br/>
    Technical proofreader: Andy Miles
    <br/>
    Typesetter: Dennis Dalinnik
    <br/>
    Cover designer: Marija Tudor
    <br/>
    ISBN: 9781617294549
    <br/>
    Printed in the United States of America
    <br/>
    1 2 3 4 5 6 7 8 9 10 – DP – 23 22 21 20 19 18
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0006_original/original_page.png" alt="Original Page 6">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>
    Where you see wrong or inequality or injustice, speak out, because this is your country.
    This is your democracy. Make it. Protect it. Pass it on.
  </p>
<p>
    — Thurgood Marshall, Justice of the Supreme Court
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0007_original/original_page.png" alt="Original Page 7">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p style="font-size: 1.2em;">vii</p>
<p>brief contents</p>
<ol>
<li>
      ■
      Escaping monolithic hell
      <span style="float: right;">1</span>
</li>
<li>
      ■
      Decomposition strategies
      <span style="float: right;">33</span>
</li>
<li>
      ■
      Interprocess communication in a microservice architecture
      <span style="float: right;">65</span>
</li>
<li>
      ■
      Managing transactions with sagas
      <span style="float: right;">110</span>
</li>
<li>
      ■
      Designing business logic in a microservice architecture
      <span style="float: right;">146</span>
</li>
<li>
      ■
      Developing business logic with event sourcing
      <span style="float: right;">183</span>
</li>
<li>
      ■
      Implementing queries in a microservice architecture
      <span style="float: right;">220</span>
</li>
<li>
      ■
      External API patterns
      <span style="float: right;">253</span>
</li>
<li>
      ■
      Testing microservices: Part 1
      <span style="float: right;">292</span>
</li>
<li>
      ■
      Testing microservices: Part 2
      <span style="float: right;">318</span>
</li>
<li>
      ■
      Developing production-ready services
      <span style="float: right;">348</span>
</li>
<li>
      ■
      Deploying microservices
      <span style="float: right;">383</span>
</li>
<li>
      ■
      Refactoring to microservices
      <span style="float: right;">428</span>
</li>
</ol>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0009_original/original_page.png" alt="Original Page 9">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p style="font-size: 1.2em;">ix</p>
<p>contents</p>
<p>preface <span style="float: right;">xvii</span></p>
<p>acknowledgments <span style="float: right;">xx</span></p>
<p>about this book <span style="float: right;">xxii</span></p>
<p>about the cover illustration <span style="float: right;">xxvi</span></p>
<p>
    1
    <br/>
    ■
    Escaping monolithic hell
    <span style="float: right;">1</span>
</p>
<p>
    1.1
    <br/>
    The slow march toward monolithic hell
    <span style="float: right;">2</span>
</p>
<p>The architecture of the FTGO application <span style="float: right;">3</span></p>
<p>
    ■The benefits of the monolithic architecture
    <span style="float: right;">4</span>
</p>
<p>
    ■Living in monolithic hell
    <span style="float: right;">4</span>
</p>
<p>
    1.2
    <br/>
    Why this book is relevant to you
    <span style="float: right;">7</span>
</p>
<p>
    1.3
    <br/>
    What you’ll learn in this book
    <span style="float: right;">7</span>
</p>
<p>
    1.4
    <br/>
    Microservice architecture to the rescue
    <span style="float: right;">8</span>
</p>
<p>Scale cube and microservices <span style="float: right;">8</span></p>
<p>
    ■Microservices as a form of modularity
    <span style="float: right;">11</span>
</p>
<p>
    ■Each service has its own database
    <span style="float: right;">12</span>
</p>
<p>The FTGO microservice architecture <span style="float: right;">12</span></p>
<p>
    ■Comparing the microservice architecture and SOA
    <span style="float: right;">13</span>
</p>
<p>
    1.5
    <br/>
    Benefits and drawbacks of the microservice architecture
    <span style="float: right;">14</span>
</p>
<p>Benefits of the microservice architecture <span style="float: right;">14</span></p>
<p>
    ■Drawbacks of the microservice architecture
    <span style="float: right;">17</span>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0011_original/original_page.png" alt="Original Page 11">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p style="font-size: 1.2em;">CONTENTS</p>
<p style="float: right;">x</p>
<p>
    1.6
    <br/>
    The Microservice architecture pattern language
    <span style="float: right;">19</span>
</p>
<p>Microservice architecture is not a silver bullet <span style="float: right;">19</span></p>
<p>
    ■Patterns and pattern languages
    <span style="float: right;">20</span>
</p>
<p>
    ■Overview of the Microservice architecture pattern language
    <span style="float: right;">23</span>
</p>
<p>
    1.7
    <br/>
    Beyond microservices: Process and organization
    <span style="float: right;">29</span>
</p>
<p>Software development and delivery organization <span style="float: right;">29</span></p>
<p>
    ■Software development and delivery process
    <span style="float: right;">30</span>
</p>
<p>
    ■The human side of adopting microservices
    <span style="float: right;">31</span>
</p>
<p>
    2
    <br/>
    Decomposition strategies
    <span style="float: right;">33</span>
</p>
<p>
    2.1
    <br/>
    What is the microservice architecture exactly?
    <span style="float: right;">34</span>
</p>
<p>What is software architecture and why does it matter? <span style="float: right;">34</span></p>
<p>Overview of architectural styles <span style="float: right;">37</span></p>
<p>
    ■The microservice architecture is an architectural style
    <span style="float: right;">40</span>
</p>
<p>
    2.2
    <br/>
    Defining an application’s microservice architecture
    <span style="float: right;">44</span>
</p>
<p>Identifying the system operations <span style="float: right;">45</span></p>
<p>
    ■Defining services by applying the Decompose by business capability pattern
    <span style="float: right;">51</span>
</p>
<p>Defining services by applying the Decompose by sub-domain pattern <span style="float: right;">54</span></p>
<p>
    ■Decomposition guidelines
    <span style="float: right;">56</span>
</p>
<p>
    ■Obstacles to decomposing an application into services
    <span style="float: right;">57</span>
</p>
<p>
    ■Defining service APIs
    <span style="float: right;">61</span>
</p>
<p>
    3
    <br/>
    Interprocess communication in a microservice architecture
    <span style="float: right;">65</span>
</p>
<p>
    3.1
    <br/>
    Overview of interprocess communication in a microservice architecture
    <span style="float: right;">66</span>
</p>
<p>Interaction styles <span style="float: right;">67</span></p>
<p>
    ■Defining APIs in a microservice architecture
    <span style="float: right;">68</span>
</p>
<p>
    ■Evolving APIs
    <span style="float: right;">69</span>
</p>
<p>
    ■Message formats
    <span style="float: right;">71</span>
</p>
<p>
    3.2
    <br/>
    Communicating using the synchronous Remote procedure invocation pattern
    <span style="float: right;">72</span>
</p>
<p>Using REST <span style="float: right;">73</span></p>
<p>
    ■Using gRPC
    <span style="float: right;">76</span>
</p>
<p>
    ■Handling partial failure using the Circuit breaker pattern
    <span style="float: right;">77</span>
</p>
<p>
    ■Using service discovery
    <span style="float: right;">80</span>
</p>
<p>
    3.3
    <br/>
    Communicating using the Asynchronous messaging pattern
    <span style="float: right;">85</span>
</p>
<p>Overview of messaging <span style="float: right;">86</span></p>
<p>
    ■Implementing the interaction styles using messaging
    <span style="float: right;">87</span>
</p>
<p>
    ■Creating an API specification for a messaging-based service API
    <span style="float: right;">89</span>
</p>
<p>
    ■Using a message broker
    <span style="float: right;">90</span>
</p>
<p>Competing receivers and message ordering <span style="float: right;">94</span></p>
<p>
    ■Handling duplicate messages
    <span style="float: right;">95</span>
</p>
<p>
    ■Transactional messaging
    <span style="float: right;">97</span>
</p>
<p>Libraries and frameworks for messaging <span style="float: right;">100</span></p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0012_original/original_page.png" alt="Original Page 12">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p style="font-size: 1.2em;">CONTENTS</p>
<p style="float: right;">xi</p>
<p>
    3.4
    <br/>
    Using asynchronous messaging to improve availability
    <span style="float: right;">103</span>
</p>
<p>Synchronous communication reduces availability <span style="float: right;">103</span></p>
<p>Eliminating synchronous interaction <span style="float: right;">104</span></p>
<p>
    4
    <br/>
    Managing transactions with sagas
    <span style="float: right;">110</span>
</p>
<p>
    4.1
    <br/>
    Transaction management in a microservice architecture
    <span style="float: right;">111</span>
</p>
<p>The need for distributed transactions in a microservice architecture <span style="float: right;">112</span></p>
<p>
    ■The trouble with distributed transactions
    <span style="float: right;">112</span>
</p>
<p>
    ■Using the Saga pattern to maintain data consistency
    <span style="float: right;">114</span>
</p>
<p>
    4.2
    <br/>
    Coordinating sagas
    <span style="float: right;">117</span>
</p>
<p>Choreography-based sagas <span style="float: right;">118</span></p>
<p>
    ■Orchestration-based sagas
    <span style="float: right;">121</span>
</p>
<p>
    4.3
    <br/>
    Handling the lack of isolation
    <span style="float: right;">126</span>
</p>
<p>Overview of anomalies <span style="float: right;">127</span></p>
<p>
    ■Countermeasures for handling the lack of isolation
    <span style="float: right;">128</span>
</p>
<p>
    4.4
    <br/>
    The design of the Order Service and the Create Order Saga
    <span style="float: right;">132</span>
</p>
<p>The OrderService class <span style="float: right;">133</span></p>
<p>
    ■The implementation of the Create Order Saga
    <span style="float: right;">135</span>
</p>
<p>
    ■The OrderCommandHandlers class
    <span style="float: right;">142</span>
</p>
<p>The OrderServiceConfiguration class <span style="float: right;">143</span></p>
<p>
    5
    <br/>
    Designing business logic in a microservice architecture
    <span style="float: right;">146</span>
</p>
<p>
    5.1
    <br/>
    Business logic organization patterns
    <span style="float: right;">147</span>
</p>
<p>Designing business logic using the Transaction script pattern <span style="float: right;">149</span></p>
<p>Designing business logic using the Domain model pattern <span style="float: right;">150</span></p>
<p>About Domain-driven design <span style="float: right;">151</span></p>
<p>
    5.2
    <br/>
    Designing a domain model using the DDD aggregate pattern
    <span style="float: right;">152</span>
</p>
<p>The problem with fuzzy boundaries <span style="float: right;">153</span></p>
<p>
    ■Aggregates have explicit boundaries
    <span style="float: right;">154</span>
</p>
<p>
    ■Aggregate rules
    <span style="float: right;">155</span>
</p>
<p>
    ■Aggregate granularity
    <span style="float: right;">158</span>
</p>
<p>
    ■Designing business logic with aggregates
    <span style="float: right;">159</span>
</p>
<p>
    5.3
    <br/>
    Publishing domain events
    <span style="float: right;">160</span>
</p>
<p>Why publish change events? <span style="float: right;">160</span></p>
<p>
    ■What is a domain event?
    <span style="float: right;">161</span>
</p>
<p>
    ■Event enrichment
    <span style="float: right;">161</span>
</p>
<p>
    ■Identifying domain events
    <span style="float: right;">162</span>
</p>
<p>
    ■Generating and publishing domain events
    <span style="float: right;">164</span>
</p>
<p>Consuming domain events <span style="float: right;">167</span></p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0013_original/original_page.png" alt="Original Page 13">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p style="font-size: 1.2em;">CONTENTS</p>
<p style="float: right;">xii</p>
<p>
    5.4
    <br/>
    Kitchen Service business logic
    <span style="float: right;">168</span>
</p>
<p>The Ticket aggregate <span style="float: right;">169</span></p>
<p>
    5.5
    <br/>
    Order Service business logic
    <span style="float: right;">173</span>
</p>
<p>The Order Aggregate <span style="float: right;">175</span></p>
<p>
    ■The OrderService class
    <span style="float: right;">180</span>
</p>
<p>
    6
    <br/>
    Developing business logic with event sourcing
    <span style="float: right;">183</span>
</p>
<p>
    6.1
    <br/>
    Developing business logic using event sourcing
    <span style="float: right;">184</span>
</p>
<p>The trouble with traditional persistence <span style="float: right;">185</span></p>
<p>
    ■Overview of event sourcing
    <span style="float: right;">186</span>
</p>
<p>
    ■Handling concurrent updates using optimistic locking
    <span style="float: right;">193</span>
</p>
<p>
    ■Event sourcing and publishing events
    <span style="float: right;">194</span>
</p>
<p>Using snapshots to improve performance <span style="float: right;">195</span></p>
<p>
    ■Idempotent message processing
    <span style="float: right;">197</span>
</p>
<p>
    ■Evolving domain events
    <span style="float: right;">198</span>
</p>
<p>Benefits of event sourcing <span style="float: right;">199</span></p>
<p>
    ■Drawbacks of event sourcing
    <span style="float: right;">200</span>
</p>
<p>
    6.2
    <br/>
    Implementing an event store
    <span style="float: right;">202</span>
</p>
<p>How the Eventuate Local event store works <span style="float: right;">203</span></p>
<p>
    ■The Eventuate client framework for Java
    <span style="float: right;">205</span>
</p>
<p>
    6.3
    <br/>
    Using sagas and event sourcing together
    <span style="float: right;">209</span>
</p>
<p>Implementing choreography-based sagas using event sourcing <span style="float: right;">210</span></p>
<p>Creating an orchestration-based saga <span style="float: right;">211</span></p>
<p>
    ■Implementing an event sourcing-based saga participant
    <span style="float: right;">213</span>
</p>
<p>
    ■Implementing saga orchestrators using event sourcing
    <span style="float: right;">216</span>
</p>
<p>
    7
    <br/>
    Implementing queries in a microservice architecture
    <span style="float: right;">220</span>
</p>
<p>
    7.1
    <br/>
    Querying using the API composition pattern
    <span style="float: right;">221</span>
</p>
<p>The findOrder() query operation <span style="float: right;">221</span></p>
<p>
    ■Overview of the API composition pattern
    <span style="float: right;">222</span>
</p>
<p>
    ■Implementing the findOrder() query operation using the API composition pattern
    <span style="float: right;">224</span>
</p>
<p>
    ■API composition design issues
    <span style="float: right;">225</span>
</p>
<p>
    ■The benefits and drawbacks of the API composition pattern
    <span style="float: right;">227</span>
</p>
<p>
    7.2
    <br/>
    Using the CQRS pattern
    <span style="float: right;">228</span>
</p>
<p>Motivations for using CQRS <span style="float: right;">229</span></p>
<p>
    ■Overview of CQRS
    <span style="float: right;">232</span>
</p>
<p>The benefits of CQRS <span style="float: right;">235</span></p>
<p>
    ■The drawbacks of CQRS
    <span style="float: right;">236</span>
</p>
<p>
    7.3
    <br/>
    Designing CQRS views
    <span style="float: right;">236</span>
</p>
<p>Choosing a view datastore <span style="float: right;">237</span></p>
<p>
    ■Data access module design
    <span style="float: right;">239</span>
</p>
<p>Adding and updating CQRS views <span style="float: right;">241</span></p>
<p>
    7.4
    <br/>
    Implementing a CQRS view with AWS DynamoDB
    <span style="float: right;">242</span>
</p>
<p>The OrderHistoryEventHandlers module <span style="float: right;">243</span></p>
<p>Data modeling and query design with DynamoDB <span style="float: right;">244</span></p>
<p>The OrderHistoryDaoDynamoDb class <span style="float: right;">249</span></p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0014_original/original_page.png" alt="Original Page 14">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p style="font-size: 1.2em;">CONTENTS</p>
<p style="float: right;">xiii</p>
<p>
    8
    <br/>
    External API patterns
    <span style="float: right;">253</span>
</p>
<p>
    8.1
    <br/>
    External API design issues
    <span style="float: right;">254</span>
</p>
<p>API design issues for the FTGO mobile client <span style="float: right;">255</span></p>
<p>
    ■API design issues for other kinds of clients
    <span style="float: right;">258</span>
</p>
<p>
    8.2
    <br/>
    The API gateway pattern
    <span style="float: right;">259</span>
</p>
<p>Overview of the API gateway pattern <span style="float: right;">259</span></p>
<p>
    ■Benefits and drawbacks of an API gateway
    <span style="float: right;">267</span>
</p>
<p>
    ■Netflix as an example of an API gateway
    <span style="float: right;">267</span>
</p>
<p>
    ■API gateway design issues
    <span style="float: right;">268</span>
</p>
<p>
    8.3
    <br/>
    Implementing an API gateway
    <span style="float: right;">271</span>
</p>
<p>Using an off-the-shelf API gateway product/service <span style="float: right;">271</span></p>
<p>Developing your own API gateway <span style="float: right;">273</span></p>
<p>
    ■Implementing an API gateway using GraphQL
    <span style="float: right;">279</span>
</p>
<p>
    9
    <br/>
    Testing microservices: Part 1
    <span style="float: right;">292</span>
</p>
<p>
    9.1
    <br/>
    Testing strategies for microservice architectures
    <span style="float: right;">294</span>
</p>
<p>Overview of testing <span style="float: right;">294</span></p>
<p>
    ■The challenge of testing microservices
    <span style="float: right;">299</span>
</p>
<p>
    ■The deployment pipeline
    <span style="float: right;">305</span>
</p>
<p>
    9.2
    <br/>
    Writing unit tests for a service
    <span style="float: right;">307</span>
</p>
<p>Developing unit tests for entities <span style="float: right;">309</span></p>
<p>
    ■Writing unit tests for value objects
    <span style="float: right;">310</span>
</p>
<p>
    ■Developing unit tests for sagas
    <span style="float: right;">310</span>
</p>
<p>
    ■Writing unit tests for domain services
    <span style="float: right;">312</span>
</p>
<p>
    ■Developing unit tests for controllers
    <span style="float: right;">313</span>
</p>
<p>
    ■Writing unit tests for event and message handlers
    <span style="float: right;">315</span>
</p>
<p>
    10
    <br/>
    Testing microservices: Part 2
    <span style="float: right;">318</span>
</p>
<p>
    10.1
    <br/>
    Writing integration tests
    <span style="float: right;">319</span>
</p>
<p>Persistence integration tests <span style="float: right;">321</span></p>
<p>
    ■Integration testing REST-based request/response style interactions
    <span style="float: right;">322</span>
</p>
<p>
    ■Integration testing publish/subscribe-style interactions
    <span style="float: right;">326</span>
</p>
<p>
    ■Integration contract tests for asynchronous request/response interactions
    <span style="float: right;">330</span>
</p>
<p>
    10.2
    <br/>
    Developing component tests
    <span style="float: right;">335</span>
</p>
<p>Defining acceptance tests <span style="float: right;">336</span></p>
<p>
    ■Writing acceptance tests using Gherkin
    <span style="float: right;">337</span>
</p>
<p>
    ■Designing component tests
    <span style="float: right;">339</span>
</p>
<p>
    ■Writing component tests for the FTGO Order Service
    <span style="float: right;">340</span>
</p>
<p>
    10.3
    <br/>
    Writing end-to-end tests
    <span style="float: right;">345</span>
</p>
<p>Designing end-to-end tests <span style="float: right;">345</span></p>
<p>
    ■Writing end-to-end tests
    <span style="float: right;">346</span>
</p>
<p>Running end-to-end tests <span style="float: right;">346</span></p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0015_original/original_page.png" alt="Original Page 15">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p style="font-size: 1.2em;">CONTENTS</p>
<p style="float: right;">xiv</p>
<p>
    11
    <br/>
    Developing production-ready services
    <span style="float: right;">348</span>
</p>
<p>
    11.1
    <br/>
    Developing secure services
    <span style="float: right;">349</span>
</p>
<p>Overview of security in a traditional monolithic application <span style="float: right;">350</span></p>
<p>Implementing security in a microservice architecture <span style="float: right;">353</span></p>
<p>
    11.2
    <br/>
    Designing configurable services
    <span style="float: right;">360</span>
</p>
<p>Using push-based externalized configuration <span style="float: right;">362</span></p>
<p>
    ■Using pull-based externalized configuration
    <span style="float: right;">363</span>
</p>
<p>
    11.3
    <br/>
    Designing observable services
    <span style="float: right;">364</span>
</p>
<p>Using the Health check API pattern <span style="float: right;">366</span></p>
<p>
    ■Applying the Log aggregation pattern
    <span style="float: right;">368</span>
</p>
<p>
    ■Using the Distributed tracing pattern
    <span style="float: right;">370</span>
</p>
<p>
    ■Applying the Application metrics pattern
    <span style="float: right;">373</span>
</p>
<p>Using the Exception tracking pattern <span style="float: right;">376</span></p>
<p>
    ■Applying the Audit logging pattern
    <span style="float: right;">377</span>
</p>
<p>
    11.4
    <br/>
    Developing services using the Microservice chassis pattern
    <span style="float: right;">378</span>
</p>
<p>Using a microservice chassis <span style="float: right;">379</span></p>
<p>
    ■From microservice chassis to service mesh
    <span style="float: right;">380</span>
</p>
<p>
    12
    <br/>
    Deploying microservices
    <span style="float: right;">383</span>
</p>
<p>
    12.1
    <br/>
    Deploying services using the Language-specific packaging format pattern
    <span style="float: right;">386</span>
</p>
<p>Benefits of the Service as a language-specific package pattern <span style="float: right;">388</span></p>
<p>Drawbacks of the Service as a language-specific package pattern <span style="float: right;">389</span></p>
<p>
    12.2
    <br/>
    Deploying services using the Service as a virtual machine pattern
    <span style="float: right;">390</span>
</p>
<p>The benefits of deploying services as VMs <span style="float: right;">392</span></p>
<p>
    ■The drawbacks of deploying services as VMs
    <span style="float: right;">392</span>
</p>
<p>
    12.3
    <br/>
    Deploying services using the Service as a container pattern
    <span style="float: right;">393</span>
</p>
<p>Deploying services using Docker <span style="float: right;">395</span></p>
<p>
    ■Benefits of deploying services as containers
    <span style="float: right;">398</span>
</p>
<p>
    ■Drawbacks of deploying services as containers
    <span style="float: right;">399</span>
</p>
<p>
    12.4
    <br/>
    Deploying the FTGO application with Kubernetes
    <span style="float: right;">399</span>
</p>
<p>Overview of Kubernetes <span style="float: right;">399</span></p>
<p>
    ■Deploying the Restaurant service on Kubernetes
    <span style="float: right;">402</span>
</p>
<p>
    ■Deploying the API gateway
    <span style="float: right;">405</span>
</p>
<p>Zero-downtime deployments <span style="float: right;">406</span></p>
<p>
    ■Using a service mesh to separate deployment from release
    <span style="float: right;">407</span>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0016_original/original_page.png" alt="Original Page 16">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p style="font-size: 1.2em;">CONTENTS</p>
<p style="float: right;">xv</p>
<p>
    12.5
    <br/>
    Deploying services using the Serverless deployment pattern
    <span style="float: right;">415</span>
</p>
<p>Overview of serverless deployment with AWS Lambda <span style="float: right;">416</span></p>
<p>Developing a lambda function <span style="float: right;">417</span></p>
<p>
    ■Invoking lambda functions
    <span style="float: right;">417</span>
</p>
<p>
    ■Benefits of using lambda functions
    <span style="float: right;">418</span>
</p>
<p>Drawbacks of using lambda functions <span style="float: right;">419</span></p>
<p>
    12.6
    <br/>
    Deploying a RESTful service using AWS Lambda and AWS Gateway
    <span style="float: right;">419</span>
</p>
<p>The design of the AWS Lambda version of Restaurant Service <span style="float: right;">419</span></p>
<p>Packaging the service as ZIP file <span style="float: right;">424</span></p>
<p>
    ■Deploying lambda functions using the Serverless framework
    <span style="float: right;">425</span>
</p>
<p>
    13
    <br/>
    Refactoring to microservices
    <span style="float: right;">428</span>
</p>
<p>
    13.1
    <br/>
    Overview of refactoring to microservices
    <span style="float: right;">429</span>
</p>
<p>Why refactor a monolith? <span style="float: right;">429</span></p>
<p>
    ■Strangling the monolith
    <span style="float: right;">430</span>
</p>
<p>
    13.2
    <br/>
    Strategies for refactoring a monolith to microservices
    <span style="float: right;">433</span>
</p>
<p>Implement new features as services <span style="float: right;">434</span></p>
<p>
    ■Separate presentation tier from the backend
    <span style="float: right;">436</span>
</p>
<p>
    ■Extract business capabilities into services
    <span style="float: right;">437</span>
</p>
<p>
    13.3
    <br/>
    Designing how the service and the monolith collaborate
    <span style="float: right;">443</span>
</p>
<p>Designing the integration glue <span style="float: right;">444</span></p>
<p>
    ■Maintaining data consistency across a service and a monolith
    <span style="float: right;">449</span>
</p>
<p>
    ■Handling authentication and authorization
    <span style="float: right;">453</span>
</p>
<p>
    13.4
    <br/>
    Implementing a new feature as a service: handling misdelivered orders
    <span style="float: right;">455</span>
</p>
<p>The design of Delayed Delivery Service <span style="float: right;">456</span></p>
<p>
    ■Designing the integration glue for Delayed Delivery Service
    <span style="float: right;">457</span>
</p>
<p>
    13.5
    <br/>
    Breaking apart the monolith: extracting delivery management
    <span style="float: right;">459</span>
</p>
<p>Overview of existing delivery management functionality <span style="float: right;">460</span></p>
<p>Overview of Delivery Service <span style="float: right;">462</span></p>
<p>
    ■Designing the Delivery Service domain model
    <span style="float: right;">463</span>
</p>
<p>
    ■The design of the Delivery Service integration glue
    <span style="float: right;">465</span>
</p>
<p>
    ■Changing the FTGO monolith to interact with Delivery Service
    <span style="float: right;">467</span>
</p>
<p>index <span style="float: right;">473</span></p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0017_original/original_page.png" alt="Original Page 17">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>پیشگفتار</mark></h3>
<p>یکی از نقل قول‌های مورد علاقه‌ی من این است:</p>
<p><em>"آینده از قبل اینجاست—فقط به طور مساوی توزیع نشده است."</em></p>
<p>— ویلیام گیبسون، نویسنده داستان‌های علمی تخیلی</p>
<p>
   خلاصه این نقل قول این است که ایده‌ها و تکنولوژی‌های جدید مدتی طول می‌کشد تا
   در یک جامعه پخش شوند و به طور گسترده پذیرفته شوند. یک مثال خوب از انتشار
   آهسته‌ی ایده‌ها، داستان چگونگی کشف
   microservices توسط من است. این ماجرا در سال 2006 آغاز شد، زمانی که، پس از
   اینکه از یک سخنرانی توسط یک مبلغ AWS الهام گرفتم، مسیری را شروع کردم که در
   نهایت منجر به ایجاد Cloud Foundry اصلی توسط من شد. (تنها وجه اشتراک با Cloud Foundry
   امروزی نام آن است.) Cloud Foundry یک Platform-as-a-Service (PaaS) برای
   اتوماسیون استقرار برنامه‌های Java بر روی EC2 بود. مانند هر
   application دیگری از نوع enterprise Java که ساخته بودم، Cloud Foundry من دارای
   یک معماری monolith بود که متشکل از یک فایل Java Web Application Archive (WAR) بود.
  </p>
<p>
   بسته‌بندی یک مجموعه متنوع و پیچیده از توابع مانند provisioning، configuration،
   monitoring و management در یک monolith، چالش‌هایی را هم در توسعه و هم در
   operations ایجاد کرد. به عنوان مثال، شما نمی‌توانستید UI را بدون تست و
   redeploy کردن کل application تغییر دهید. و از آنجایی که جزء monitoring و management
   به یک موتور Complex Event Processing (CEP) متکی بود که state را در حافظه نگه می‌داشت، ما
   نمی‌توانستیم چندین instance از application را اجرا کنیم! اعتراف به این موضوع شرم‌آور است،
   اما تنها چیزی که می‌توانم بگویم این است که من یک software developer هستم و "بگذارید آن کس که
   بی‌گناه است، اولین سنگ را پرتاب کند."
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0019_original/original_page.png" alt="Original Page 19">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>PREFACE</mark></h3>
<p>
   به وضوح، این application به سرعت از معماری monolith خود فراتر رفته بود، اما چه
   جایگزینی وجود داشت؟ پاسخ مدتی در جامعه software در شرکت‌هایی مانند eBay و Amazon
   وجود داشت. به عنوان مثال، Amazon
   مهاجرت از monolith را در حدود سال 2002 آغاز کرد
   (
   <a href="https://plus.google.com/110981030061712822816/posts/AaygmbzVeRq" target="_blank">
    https://plus.google.com/110981030061712822816/
    posts/AaygmbzVeRq
   </a>
   ). معماری جدید، monolith را با مجموعه‌ای از
   loosely coupled services جایگزین کرد. Services توسط چیزی که Amazon آن را two-pizza
   teams می‌نامد، متعلق به آن هستند—تیم‌هایی به اندازه کافی کوچک که با دو پیتزا تغذیه
   شوند.
  </p>
<p>
   Amazon این معماری را برای تسریع سرعت توسعه software اتخاذ کرده بود تا شرکت
   بتواند سریع‌تر نوآوری کند و به طور موثرتری رقابت کند. نتایج چشمگیر است: طبق گزارش‌ها،
   Amazon هر 11.6 ثانیه تغییراتی را در production پیاده‌سازی می‌کند!
  </p>
<p>
   در اوایل سال 2010، پس از اینکه به پروژه‌های دیگری منتقل شدم، آینده معماری
   software سرانجام با من همگام شد. در آن زمان بود که کتاب The Art of Scalability:
   Scalable Web Architecture, Processes, and Organizations for the Modern Enterprise
   (Addison-Wesley Professional, 2009) نوشته Michael T. Fisher و Martin L. Abbott
   را خواندم. یک ایده کلیدی در آن کتاب، scale cube است که، همانطور که در فصل 2
   توضیح داده شده است، یک مدل سه بعدی برای مقیاس‌بندی یک application است. مقیاس‌بندی
   محور Y که توسط scale cube تعریف شده است، یک application را به صورت functional به
   services تجزیه می‌کند. در گذشته، این کاملاً واضح بود، اما برای من در آن زمان، یک لحظه
   a-ha بود! من می‌توانستم چالش‌هایی را که دو سال قبل با آن مواجه بودم با
   architecting Cloud Foundry به عنوان مجموعه‌ای از services حل کنم!
  </p>
<p>
   در آوریل 2012، اولین سخنرانی خود را در مورد این رویکرد معماری ارائه دادم، با عنوان
   “Decomposing Applications of Deployability and Scalability”
   (
   <a href="www.slideshare.net/chris.e.richardson/decomposing-applications-for-scalability-and-deployability-april-2012" target="_blank">www.slideshare.net/chris.e.richardson/decomposing-applications-for-scalability-and-deployability-april-2012</a>
   ). در آن زمان، اصطلاحاً
   accepted برای این نوع معماری وجود نداشت. من گاهی اوقات آن را modular، polyglot
   architecture می‌نامیدم، زیرا services می‌توانستند به زبان‌های مختلف نوشته شوند.
  </p>
<p>
   اما در مثالی دیگر از اینکه چگونه آینده به طور نامساوی توزیع شده است، اصطلاح
   microservice در یک کارگاه معماری software در سال 2011 برای توصیف این نوع
   architecture استفاده شد
   (
   <a href="https://en.wikipedia.org/wiki/Microservices" target="_blank">https://en.wikipedia.org/wiki/Microservices</a>
   ).
   من اولین بار این اصطلاح را زمانی شنیدم که Fred George در Oredev 2013 سخنرانی
   کرد و آن را دوست داشتم!
  </p>
<p>
   در ژانویه 2014، وب‌سایت
   <a href="https://microservices.io" target="_blank">https://microservices.io</a>
   را برای مستندسازی الگوهای architecture و design که با آن مواجه شده بودم، ایجاد
   کردم. سپس در مارس 2014، James Lewis و Martin Fowler یک پست وبلاگ در مورد
   microservices منتشر کردند (
   <a href="https://martinfowler.com/articles/microservices.html" target="_blank">https://martinfowler.com/articles/microservices.html</a>
   ). با popularizing اصطلاح microservices، پست وبلاگ باعث شد تا جامعه software حول
   این مفهوم متمرکز شود.
  </p>
<p>
   ایده teams کوچک و loosely coupled که به سرعت و به طور قابل اعتماد
   microservices را توسعه و ارائه می‌دهند، به آرامی در حال انتشار در جامعه software
   است. اما احتمالاً این vision از آینده با واقعیت روزانه شما بسیار متفاوت است. امروزه،
   business-critical enterprise applications معمولاً monoliths بزرگی هستند که توسط
   تیم‌های بزرگ توسعه یافته‌اند. releases از software به ندرت اتفاق می‌افتد و اغلب برای
   همه افراد درگیر دردناک است. IT اغلب برای همگام شدن با نیازهای business تلاش
   می‌کند. شما می‌پرسید چگونه می‌توانید معماری microservice را اتخاذ کنید.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0020_original/original_page.png" alt="Original Page 20">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p><strong>پیشگفتار</strong></p>
<p>هدف از این کتاب پاسخ به این سوال است. این کتاب درک خوبی از معماری <strong>Microservice</strong>، مزایا و معایب آن و زمان استفاده از آن به شما ارائه می‌دهد.
  </p>
<p>
   این کتاب نحوه حل چالش‌های طراحی متعددی را که با آن‌ها روبرو خواهید شد، از جمله نحوه مدیریت داده‌های توزیع‌شده، شرح می‌دهد. همچنین نحوه refactor کردن یک application <strong>Monolith</strong> به معماری <strong>Microservice</strong> را پوشش می‌دهد. اما این کتاب یک manifesto <strong>Microservices</strong> نیست.
  </p>
<p>
   در عوض، حول مجموعه‌ای از <strong>patterns</strong> سازماندهی شده است. یک <strong>pattern</strong> یک راه‌حل قابل استفاده مجدد برای یک مشکل است که در یک زمینه خاص رخ می‌دهد. زیبایی یک <strong>pattern</strong> این است که علاوه بر توصیف مزایای راه‌حل، معایب و مشکلاتی را که باید برای پیاده‌سازی موفقیت‌آمیز یک راه‌حل برطرف کنید، نیز شرح می‌دهد. بر اساس تجربه‌ام، این نوع عینیت در تفکر در مورد راه‌حل‌ها منجر به تصمیم‌گیری بسیار بهتر می‌شود. امیدوارم از خواندن این کتاب لذت ببرید و به شما بیاموزد که چگونه <strong>Microservices</strong> را با موفقیت توسعه دهید.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0021_original/original_page.png" alt="Original Page 21">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p><strong>تشکر و قدردانی</strong></p>
<p>اگرچه نوشتن یک فعالیت انفرادی است، اما به تعداد زیادی از افراد نیاز دارد تا پیش‌نویس‌های اولیه را به یک کتاب نهایی تبدیل کنند.</p>
<p>
   اول، می‌خواهم از <strong>Erin Twohey</strong> و <strong>Michael Stevens</strong> از <strong>Manning</strong> برای تشویق مداومشان به نوشتن یک کتاب دیگر تشکر کنم. همچنین می‌خواهم از ویراستاران توسعه‌دهنده من، <strong>Cynthia Kane</strong> و <strong>Marina Michaels</strong> تشکر کنم. <strong>Cynthia Kane</strong> من را شروع کرد و در چند فصل اول با من کار کرد. <strong>Marina Michaels</strong> از <strong>Cynthia</strong> کار را به دست گرفت و تا انتها با من کار کرد. من برای انتقادات دقیق و سازنده <strong>Marina</strong> از فصل‌هایم، تا ابد سپاسگزار خواهم بود. و می‌خواهم از بقیه تیم <strong>Manning</strong> که در انتشار این کتاب نقش داشته‌اند تشکر کنم.
  </p>
<p>
   من می‌خواهم از ویراستار توسعه فنی‌ام، <strong>Christian Mennerich</strong>، تصحیح‌کننده فنی‌ام، <strong>Andy Miles</strong>، و همه بازبین‌های خارجی‌ام تشکر کنم: <strong>Andy Kirsch</strong>، <strong>Antonio Pessolano</strong>، <strong>Areg Melik-Adamyan</strong>، <strong>Cage Slagel</strong>، <strong>Carlos Curotto</strong>، <strong>Dror Helper</strong>، <strong>Eros Pedrini</strong>، <strong>Hugo Cruz</strong>، <strong>Irina Romanenko</strong>، <strong>Jesse Rosalia</strong>، <strong>Joe Justesen</strong>، <strong>John Guthrie</strong>، <strong>Keerthi Shetty</strong>، <strong>Michele Mauro</strong>، <strong>Paul Grebenc</strong>، <strong>Pethuru Raj</strong>، <strong>Potito Coluccelli</strong>، <strong>Shobha Iyer</strong>، <strong>Simeon Leyzerzon</strong>، <strong>Srihari Sridharan</strong>، <strong>Tim Moore</strong>، <strong>Tony Sweets</strong>، <strong>Trent Whiteley</strong>، <strong>Wes Shaddix</strong>، <strong>William E. Wheeler</strong>، و <strong>Zoltan Hamori</strong>.
  </p>
<p>
   همچنین می‌خواهم از همه کسانی که <strong>MEAP</strong> را خریداری کردند و در انجمن یا مستقیماً برای من بازخورد ارائه کردند، تشکر کنم.
  </p>
<p>
   من می‌خواهم از برگزارکنندگان و شرکت‌کنندگان در همه کنفرانس‌ها و <strong>meetup</strong>هایی که در آن‌ها صحبت کرده‌ام، برای فرصت ارائه و بازبینی ایده‌هایم تشکر کنم. و می‌خواهم از مشتریان مشاوره و آموزش من در سراسر جهان تشکر کنم که به من این فرصت را دادند تا به آن‌ها کمک کنم ایده‌هایم را عملی کنند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0022_original/original_page.png" alt="Original Page 22">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p><strong>تشکر و قدردانی</strong></p>
<p>من می‌خواهم از همکارانم <strong>Andrew</strong>، <strong>Valentin</strong>، <strong>Artem</strong> و <strong>Stanislav</strong> در <strong>Eventuate, Inc.</strong> برای مشارکت‌هایشان در محصول <strong>Eventuate</strong> و پروژه‌های منبع باز تشکر کنم.</p>
<p>
   در نهایت، می‌خواهم از همسرم، <strong>Laura</strong>، و فرزندانم، <strong>Ellie</strong>، <strong>Thomas</strong> و <strong>Janet</strong> برای حمایت و درکشان در 18 ماه گذشته تشکر کنم. در حالی که به لپ‌تاپم چسبیده بودم، رفتن به بازی‌های فوتبال <strong>Ellie</strong> را از دست دادم، تماشای یادگیری <strong>Thomas</strong> برای پرواز با شبیه‌ساز پروازش را از دست دادم، و امتحان رستوران‌های جدید با <strong>Janet</strong> را از دست دادم.
  </p>
<p>
   با تشکر از همه شما!
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0023_original/original_page.png" alt="Original Page 23">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p><strong>درباره این کتاب</strong></p>
<p>هدف از این کتاب این است که به شما آموزش دهد چگونه با موفقیت applications را با استفاده از معماری <strong>Microservice</strong> توسعه دهید.</p>
<p>
   این کتاب نه تنها در مورد مزایای معماری <strong>Microservice</strong> بحث می‌کند، بلکه معایب آن را نیز توضیح می‌دهد. شما یاد خواهید گرفت که چه زمانی باید استفاده از معماری <strong>Monolithic</strong> را در نظر بگیرید و چه زمانی استفاده از <strong>Microservices</strong> منطقی است.
  </p>
<p>
<strong>چه کسانی باید این کتاب را بخوانند</strong>
</p>
<p>تمرکز این کتاب بر معماری و توسعه است. این کتاب برای هر کسی که مسئول توسعه و ارائه <strong>software</strong> است، مانند <strong>developers</strong>، <strong>architects</strong>، <strong>CTOs</strong> یا <strong>VPs</strong> مهندسی در نظر گرفته شده است.</p>
<p>
   این کتاب بر توضیح <strong>Microservice architecture patterns</strong> و سایر مفاهیم متمرکز است. هدف من این است که شما این مطالب را بدون توجه به <strong>technology stack</strong>ی که استفاده می‌کنید، در دسترس بیابید. شما فقط باید با اصول اولیه معماری و طراحی <strong>enterprise application</strong> آشنا باشید. به طور خاص، شما باید مفاهیمی مانند معماری <strong>three-tier</strong>، طراحی <strong>web application</strong>، پایگاه‌های داده رابطه‌ای، <strong>interprocess communication</strong> با استفاده از <strong>messaging</strong> و <strong>REST</strong> و اصول اولیه امنیت <strong>application</strong> را درک کنید. با این حال، مثال‌های کد از <strong>Java</strong> و فریم‌ورک <strong>Spring</strong> استفاده می‌کنند. برای اینکه بیشترین بهره را از آن‌ها ببرید، باید با فریم‌ورک <strong>Spring</strong> آشنا باشید.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0024_original/original_page.png" alt="Original Page 24">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p><strong>درباره این کتاب</strong></p>
<p><strong>Roadmap</strong></p>
<p>این کتاب شامل 13 فصل است:</p>
<ul>
<li>
    فصل 1 علائم جهنم <strong>Monolithic</strong> را توصیف می‌کند، که زمانی رخ می‌دهد که یک <strong>application</strong> از معماری خود فراتر می‌رود، و در مورد چگونگی فرار با اتخاذ معماری <strong>Microservice</strong> توصیه می‌کند. همچنین مروری بر زبان <strong>Microservice architecture pattern</strong> ارائه می‌دهد، که موضوع سازمان‌دهی برای اکثر کتاب است.
   </li>
<li>
    فصل 2 توضیح می‌دهد که چرا معماری <strong>software</strong> مهم است و <strong>patterns</strong>ی را که می‌توانید برای تجزیه یک <strong>application</strong> به مجموعه‌ای از <strong>services</strong> استفاده کنید، شرح می‌دهد. همچنین توضیح می‌دهد که چگونه بر موانع مختلفی که معمولاً در این مسیر با آن مواجه می‌شوید غلبه کنید.
   </li>
<li>
    فصل 3 الگوهای مختلف برای ارتباط محکم و بین فرآیندی را در معماری <strong>Microservice</strong> توصیف می‌کند. توضیح می‌دهد که چرا ارتباط ناهمزمان و مبتنی بر پیام اغلب بهترین انتخاب است.
   </li>
<li>
    فصل 4 توضیح می‌دهد که چگونه با استفاده از <strong>Saga pattern</strong>، سازگاری داده‌ها را در <strong>services</strong> حفظ کنید. یک <strong>saga</strong> دنباله‌ای از <strong>transactions</strong> محلی است که با استفاده از <strong>messaging</strong> ناهمزمان هماهنگ شده‌اند.
   </li>
<li>
    فصل 5 نحوه طراحی <strong>business logic</strong> را برای یک <strong>service</strong> با استفاده از الگوهای رویداد <strong>Domain-driven design (DDD) Aggregate</strong> و <strong>Domain</strong> توضیح می‌دهد.
   </li>
<li>
    فصل 6 بر اساس فصل 5 ساخته شده است و نحوه توسعه <strong>business logic</strong> را با استفاده از <strong>Event sourcing pattern</strong> توضیح می‌دهد، یک راه ساختار یافته <strong>event-centric</strong> برای ساختار <strong>business logic</strong> و پایداری <strong>domain objects</strong>.
   </li>
<li>
    فصل 7 نحوه پیاده‌سازی <strong>queries</strong> را توصیف می‌کند که داده‌های پراکنده در چندین <strong>service</strong> را با استفاده از <strong>API composition pattern</strong> یا الگوی <strong>Command query responsibility segregation (CQRS)</strong> بازیابی می‌کند.
   </li>
<li>
    فصل 8 <strong>API patterns</strong> خارجی را برای رسیدگی به درخواست‌ها از مجموعه‌ای متنوع از <strong>clients</strong> خارجی، مانند <strong>applications</strong> تلفن همراه، <strong>applications</strong> مبتنی بر <strong>browser-based JavaScript</strong> و <strong>applications</strong> شخص ثالث پوشش می‌دهد.
   </li>
<li>
    فصل 9 اولین فصل از دو فصل در مورد تکنیک‌های تست خودکار برای <strong>Microservices</strong> است. مفاهیم مهم تست مانند هرم تست را معرفی می‌کند، که نسبت نسبی هر نوع تست را در <strong>test suite</strong> شما توصیف می‌کند. همچنین نشان می‌دهد که چگونه <strong>unit tests</strong> را بنویسید، که پایه هرم تست را تشکیل می‌دهند.
   </li>
<li>
    فصل 10 بر اساس فصل 9 ساخته شده است و نحوه نوشتن انواع دیگر تست‌ها در هرم تست، از جمله <strong>integration tests</strong>، <strong>consumer contract tests</strong> و <strong>component tests</strong> را شرح می‌دهد.
   </li>
<li>
    فصل 11 جنبه‌های مختلف توسعه <strong>services</strong> آماده تولید را پوشش می‌دهد، از جمله امنیت، الگوی پیکربندی خارجی و الگوهای مشاهده <strong>service</strong>. الگوهای مشاهده <strong>service</strong> شامل <strong>Log aggregation</strong>، <strong>Application metrics</strong> و <strong>Distributed tracing</strong> هستند.
   </li>
<li>
    فصل 12 الگوهای استقرار مختلفی را که می‌توانید برای استقرار <strong>services</strong> استفاده کنید، از جمله ماشین‌های مجازی، <strong>containers</strong> و <strong>serverless</strong>، شرح می‌دهد. همچنین
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0025_original/original_page.png" alt="Original Page 25">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p><strong>درباره این کتاب</strong></p>
<p>
   ...در مورد مزایای استفاده از یک <strong>service mesh</strong>، لایه‌ای از <strong>software</strong> <strong>networking</strong> که ارتباطات را در یک معماری <strong>Microservice</strong> میانجی‌گری می‌کند، بحث می‌کند.
  </p>
<ul>
<li>
    فصل 13 توضیح می‌دهد که چگونه یک معماری <strong>Monolithic</strong> را با استفاده از الگوی <strong>Strangler application</strong>، به‌صورت افزایشی <strong>refactor</strong> کنید: پیاده‌سازی ویژگی‌های جدید به عنوان <strong>services</strong> و استخراج ماژول‌ها از <strong>Monolith</strong> و تبدیل آن‌ها به <strong>services</strong>.
   </li>
</ul>
<p>
   همانطور که در این فصل‌ها پیش می‌روید، در مورد جنبه‌های مختلف معماری <strong>Microservice</strong> یاد خواهید گرفت.
  </p>
<p>
<strong>درباره کد</strong>
</p>
<p>
   این کتاب شامل نمونه‌های زیادی از کد منبع است که هم در فهرست‌های شماره‌گذاری شده و هم به‌صورت <strong>inline</strong> با متن معمولی قرار دارند. در هر دو مورد، کد منبع در یک فونت با عرض ثابت مانند این قالب‌بندی شده است تا آن را از متن معمولی جدا کند. گاهی اوقات کد نیز به صورت <strong>bold</strong> است تا کدی را که از مراحل قبلی در فصل تغییر کرده است، برجسته کند، مانند زمانی که یک ویژگی جدید به یک خط کد موجود اضافه می‌شود. در بسیاری از موارد، کد منبع اصلی <strong>reformatted</strong> شده است. ناشر، شکستگی خط و <strong>reworked indentation</strong> را برای تطبیق فضای صفحه موجود در کتاب اضافه کرده است. در موارد نادر، حتی این کافی نبود و فهرست‌ها شامل نشانگرهای ادامه خط (➥) می‌شوند. علاوه بر این، نظرات موجود در کد منبع اغلب از فهرست‌ها حذف شده‌اند، زمانی که کد در متن شرح داده می‌شود. توضیحات کد، بسیاری از فهرست‌ها را همراهی می‌کند و مفاهیم مهم را برجسته می‌کند.
  </p>
<p>
   هر فصل، به جز فصل‌های 1، 2 و 13، حاوی کدهایی از <strong>application</strong> نمونه همراه است. می‌توانید کد این <strong>application</strong> را در یک <strong>GitHub repository</strong> پیدا کنید:
   <a href="https://github.com/microservices-patterns/ftgo-application">https://github.com/microservices-patterns/ftgo-application</a>.
  </p>
<p>
<strong>انجمن کتاب</strong>
</p>
<p>
   خرید <strong>Microservices Patterns</strong> شامل دسترسی رایگان به یک انجمن وب خصوصی است که توسط <strong>Manning Publications</strong> اجرا می‌شود و در آن می‌توانید در مورد کتاب نظر دهید، سؤالات فنی بپرسید، راه‌حل‌های خود را برای تمرین‌ها به اشتراک بگذارید و از نویسنده و سایر کاربران کمک دریافت کنید. برای دسترسی به انجمن و اشتراک در آن، مرورگر وب خود را به
   <a href="https://forums.manning.com/forums/microservices-patterns">https://forums.manning.com/forums/microservices-patterns</a> هدایت کنید. همچنین می‌توانید در مورد انجمن‌های <strong>Manning</strong> و قوانین رفتار در
   <a href="https://forums.manning.com/forums/about">https://forums.manning.com/forums/about</a> اطلاعات بیشتری کسب کنید.
  </p>
<p>
   تعهد <strong>Manning</strong> به خوانندگان ما این است که بستری را فراهم کنیم که در آن گفتگوی معناداری بین خوانندگان فردی و بین خوانندگان و نویسنده انجام شود. این تعهدی به هیچ میزان خاصی از مشارکت از طرف نویسنده نیست، که سهم او در انجمن همچنان داوطلبانه (و بدون حقوق) است. ما پیشنهاد می‌کنیم از نویسنده چند سؤال چالش برانگیز بپرسید مبادا علاقه‌اش منحرف شود! انجمن و بایگانی بحث‌های قبلی تا زمانی که کتاب چاپ شود، از وب‌سایت ناشر در دسترس خواهد بود.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0026_original/original_page.png" alt="Original Page 26">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p><strong>درباره این کتاب</strong></p>
<p><strong>Other online resources</strong></p>
<p>منبع عالی دیگر برای یادگیری معماری <strong>Microservice</strong>، وب‌سایت من
   <a href="http://microservices.io">http://microservices.io</a> است.
  </p>
<p>
   این وب‌سایت نه تنها شامل زبان کامل <strong>pattern</strong> است، بلکه پیوندهایی به منابع دیگر مانند مقالات، <strong>presentations</strong> و کد نمونه نیز دارد.
  </p>
<p>
<strong>درباره نویسنده</strong>
</p>
<p>
<strong>Chris Richardson</strong> یک <strong>developer</strong> و <strong>architect</strong> است. او یک <strong>Java Champion</strong>، یک <strong>JavaOne rock star</strong>، و نویسنده
   <strong>POJOs in Action (Manning, 2006)</strong> است، که نحوه ساخت <strong>enterprise Java applications</strong> را با فریم‌ورک‌هایی مانند <strong>Spring</strong> و <strong>Hibernate</strong> شرح می‌دهد.
  </p>
<p>
<strong>Chris</strong> همچنین بنیانگذار
   <a href="http://CloudFoundry.com">CloudFoundry.com</a> اصلی بود، یک <strong>Java PaaS</strong> اولیه برای <strong>Amazon EC2</strong>.
  </p>
<p>
   امروزه، او یک رهبر فکری شناخته شده در <strong>Microservices</strong> است و به‌طور منظم در کنفرانس‌های بین‌المللی سخنرانی می‌کند. <strong>Chris</strong> خالق
   <strong>Microservices.io</strong>، یک زبان <strong>pattern</strong> برای <strong>microservices</strong> است. او مشاوره و آموزش <strong>microservices</strong> را به سازمان‌های سراسر جهان که معماری
   <strong>microservice</strong> را اتخاذ می‌کنند، ارائه می‌دهد. <strong>Chris</strong> در حال کار بر روی سومین <strong>startup</strong> خود است: <strong>Eventuate.io</strong>، یک پلتفرم <strong>application</strong> برای توسعه
   <strong>microservices</strong> تراکنشی.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0027_original/original_page.png" alt="Original Page 27">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p><strong>درباره تصویر روی جلد</strong></p>
<p><strong>Jefferys</strong></p>
<p>شکل روی جلد
   <strong>Microservices Patterns</strong> با عنوان "عادت یک برده موریسکو در سال 1568" است. این تصویر از مجموعه لباس‌های ملل مختلف توماس <strong>Jefferys</strong>، باستان و مدرن (چهار جلد)، لندن، که بین سال‌های 1757 و 1772 منتشر شده است، گرفته شده است. صفحه عنوان بیان می‌کند که این‌ها حکاکی‌های مسی با رنگ دستی هستند که با صمغ عربی برجسته شده‌اند.
  </p>
<p>
   توماس <strong>Jefferys (1719–1771)</strong> را "جغرافیدان پادشاه جرج سوم" می‌نامیدند. او یک نقشه‌کش انگلیسی بود که رهبر تأمین‌کننده نقشه‌های روزگار خود بود. او نقشه‌ها را برای دولت و سایر نهادهای رسمی حکاکی و چاپ کرد و طیف گسترده‌ای از نقشه‌ها و اطلس‌های تجاری، به‌ویژه آمریکای شمالی، تولید کرد. کار او به عنوان نقشه‌کش، علاقه‌ای به آداب و رسوم لباس‌های محلی سرزمین‌هایی که نقشه‌برداری و نقشه‌برداری می‌کرد، برانگیخت، که به طرز درخشانی در این مجموعه به نمایش گذاشته شده است. مجذوب شدن در سرزمین‌های دوردست و مسافرت برای تفریح، پدیده‌های نسبتاً جدیدی در اواخر قرن 18 بود، و مجموعه‌هایی مانند این مجموعه محبوب بودند و هم گردشگر و هم مسافر صندلی راحتی را به ساکنان کشورهای دیگر معرفی می‌کردند.
  </p>
<p>
   تنوع نقاشی‌های موجود در جلدهای
   <strong>Jefferys</strong>، به وضوح از منحصربه‌فرد بودن و فردیت ملت‌های جهان در حدود 200 سال پیش حکایت دارد. از آن زمان، قوانین لباس تغییر کرده است، و تنوع منطقه‌ای و کشوری، که در آن زمان بسیار غنی بود، محو شده است. اکنون اغلب تشخیص ساکنان یک قاره از قاره دیگر دشوار است. شاید، تلاش برای مشاهده خوش‌بینانه آن، ما تنوع فرهنگی و بصری را با یک زندگی شخصی متنوع‌تر - یا یک زندگی فکری و فنی متنوع‌تر و جالب‌تر - مبادله کرده‌ایم.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0028_original/original_page.png" alt="Original Page 28">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p><strong>درباره تصویر روی جلد</strong></p>
<p>در زمانی که تشخیص یک کتاب کامپیوتری از کتاب دیگر دشوار است، <strong>Manning</strong> خلاقیت و ابتکار کسب‌وکار کامپیوتری را با جلد کتاب‌هایی که بر اساس تنوع غنی زندگی منطقه‌ای دو قرن پیش است، جشن می‌گیرد و با تصاویر
   <strong>Jeffreys</strong> دوباره زنده می‌شود.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0029_original/original_page.png" alt="Original Page 29">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<p>فقط ظهر دوشنبه بود، اما ماری، <strong>CTO</strong> شرکت <strong>Food to Go, Inc. (FTGO)</strong>، قبلاً احساس ناامیدی می‌کرد. روز او واقعاً خوب شروع شده بود. او هفته قبل را با سایر معماران و <strong>developers</strong> <strong>software</strong> در یک کنفرانس عالی سپری کرده بود و در مورد آخرین تکنیک‌های توسعه <strong>software</strong>، از جمله استقرار مداوم و معماری <strong>Microservice</strong>، آموزش دیده بود. ماری همچنین با همکلاسی‌های سابق علوم کامپیوتر خود از ایالت
   <strong>North Carolina A&amp;T</strong> ملاقات کرده و داستان‌های رهبری فناوری را به اشتراک گذاشته بود. این کنفرانس باعث شد او احساس قدرت کند و مشتاقانه بخواهد نحوه توسعه <strong>software</strong> <strong>FTGO</strong> را بهبود بخشد.
  </p>
<p>
   این فصل موارد زیر را پوشش می‌دهد
  </p>
<ul>
<li>
    علائم جهنم <strong>Monolithic</strong> و نحوه
    <br/>
    فرار از آن با اتخاذ معماری <strong>Microservice</strong>
</li>
<li>
    ویژگی‌های اساسی معماری <strong>Microservice</strong> و مزایا و معایب آن
   </li>
<li>
    چگونه <strong>Microservices</strong> سبک توسعه <strong>DevOps</strong> را
    <br/>
    از برنامه‌های بزرگ و پیچیده فعال می‌کنند
   </li>
<li>
    زبان <strong>Microservice architecture pattern</strong> و چرا باید از آن استفاده کنید
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0031_original/original_page.png" alt="Original Page 31">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>2</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<p>متأسفانه، آن احساس به سرعت از بین رفت. او صبح اول را در دفتر دوباره در یک جلسه دردناک دیگر با مهندسین ارشد و افراد تجاری سپری کرده بود. آن‌ها دو ساعت را صرف بحث در مورد این موضوع کردند که چرا تیم توسعه قرار است تاریخ انتشار بحرانی دیگری را از دست بدهد. متأسفانه، این نوع جلسه در چند سال گذشته به طور فزاینده‌ای رایج شده است. علیرغم اتخاذ <strong>agile</strong>، سرعت توسعه در حال کاهش بود و رسیدن به اهداف کسب‌وکار را تقریباً غیرممکن می‌کرد. و، بدتر از آن، به نظر نمی‌رسید راه‌حل ساده‌ای وجود داشته باشد.</p>
<p>
   این کنفرانس باعث شد ماری متوجه شود که <strong>FTGO</strong> از یک مورد جهنم <strong>monolithic</strong> رنج می‌برد و درمان آن اتخاذ معماری <strong>microservice</strong> است. اما معماری <strong>microservice</strong> و شیوه‌های توسعه <strong>software</strong> پیشرفته مرتبط که در کنفرانس توضیح داده شد، مانند یک رویای دست‌نیافتنی بود. برای ماری مشخص نبود که چگونه می‌تواند با آتش‌های امروز مبارزه کند و در عین حال نحوه توسعه <strong>software</strong> را در <strong>FTGO</strong> بهبود بخشد.
  </p>
<p>
   خوشبختانه، همانطور که در این کتاب یاد خواهید گرفت، یک راه وجود دارد. اما ابتدا، بیایید به مشکلاتی که <strong>FTGO</strong> با آن مواجه است و اینکه چگونه به آنجا رسیده‌اند، نگاهی بیندازیم.
  </p>
<p>1.1</p>
<p><strong>The slow march toward monolithic hell</strong></p>
<p>از زمان راه‌اندازی در اواخر سال 2005، <strong>FTGO</strong> با جهش و مرزها رشد کرده است. امروزه، این شرکت یکی از شرکت‌های پیشرو در زمینه تحویل غذا به صورت آنلاین در ایالات متحده است. این کسب و کار حتی قصد دارد در خارج از کشور گسترش یابد، اگرچه این برنامه‌ها به دلیل تاخیر در پیاده‌سازی ویژگی‌های لازم در معرض خطر هستند.</p>
<p>
   در هسته خود، <strong>application</strong> <strong>FTGO</strong> بسیار ساده است. مصرف‌کنندگان از وب‌سایت <strong>FTGO</strong> یا <strong>mobile application</strong> برای ثبت سفارش غذا در رستوران‌های محلی استفاده می‌کنند.
   <strong>FTGO</strong> شبکه‌ای از پیک‌ها را هماهنگ می‌کند که سفارش‌ها را تحویل می‌دهند. همچنین مسئول پرداخت به پیک‌ها و رستوران‌ها است. رستوران‌ها از وب‌سایت <strong>FTGO</strong> برای ویرایش منوهای خود و مدیریت سفارشات استفاده می‌کنند. این <strong>application</strong> از سرویس‌های وب مختلفی از جمله <strong>Stripe</strong> برای پرداخت‌ها، <strong>Twilio</strong> برای پیام‌رسانی، و <strong>Amazon Simple Email Service (SES)</strong> برای ایمیل استفاده می‌کند.
  </p>
<p>
   مانند بسیاری از <strong>applications</strong> سازمانی قدیمی دیگر، <strong>application</strong> <strong>FTGO</strong> یک <strong>monolith</strong> است که از یک فایل بایگانی <strong>Java Web Application (WAR)</strong> تشکیل شده است. در طول سال‌ها، به یک <strong>application</strong> بزرگ و پیچیده تبدیل شده است. علیرغم بهترین تلاش‌های تیم توسعه <strong>FTGO</strong>، این <strong>application</strong> به نمونه‌ای از الگوی <strong>Big Ball of Mud</strong> (www.laputan.org/mud/) تبدیل شده است. به نقل از <strong>Foote</strong> و <strong>Yoder</strong>، نویسندگان آن الگو، این یک "جنگل کد اسپاگتی، ساختار آشفته، گسترده، شلخته، نوار چسب و سیم بسته‌بندی است."
   سرعت تحویل <strong>software</strong> کاهش یافته است. بدتر از آن، <strong>application</strong> <strong>FTGO</strong> با استفاده از برخی از فریم‌ورک‌های فزاینده منسوخ نوشته شده است. <strong>application</strong> <strong>FTGO</strong> تمام علائم جهنم <strong>monolithic</strong> را نشان می‌دهد.
  </p>
<p>
   بخش بعدی معماری <strong>application</strong> <strong>FTGO</strong> را توضیح می‌دهد. سپس در مورد اینکه چرا معماری <strong>monolithic</strong> در ابتدا خوب عمل کرد صحبت می‌کند. ما به این موضوع می‌پردازیم که چگونه <strong>application</strong> <strong>FTGO</strong> از معماری خود فراتر رفته است و چگونه این امر منجر به جهنم <strong>monolithic</strong> شده است.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0032_original/original_page.png" alt="Original Page 32">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>3</p>
<p><strong>The slow march toward monolithic hell</strong></p>
<p>1.1.1</p>
<p><strong>The architecture of the FTGO application</strong></p>
<p><strong>FTGO</strong> یک <strong>application</strong> <strong>Java</strong> سازمانی معمولی است. شکل 1.1 معماری آن را نشان می‌دهد. <strong>application</strong> <strong>FTGO</strong> دارای یک معماری شش ضلعی است، که یک سبک معماری است که در فصل 2 با جزئیات بیشتری توضیح داده شده است. در یک معماری شش ضلعی، هسته <strong>application</strong> از <strong>business logic</strong> تشکیل شده است. اطراف <strong>business logic</strong> آداپتورهای مختلفی وجود دارد که رابط‌های کاربری را پیاده‌سازی می‌کنند و با سیستم‌های خارجی ادغام می‌شوند.</p>
<p>
<strong>business logic</strong> شامل ماژول‌هایی است که هر کدام مجموعه‌ای از <strong>domain objects</strong> هستند. نمونه‌هایی از این ماژول‌ها شامل <strong>Order Management</strong>، <strong>Delivery Management</strong>، <strong>Billing</strong> و <strong>Payments</strong> است. چندین آداپتور وجود دارد که با سیستم‌های خارجی ارتباط برقرار می‌کنند. برخی آداپتورهای <strong>inbound</strong> هستند که درخواست‌ها را با فراخوانی <strong>business logic</strong>، از جمله <strong>REST API</strong> و آداپتورهای <strong>Web UI</strong>، مدیریت می‌کنند. برخی دیگر آداپتورهای <strong>outbound</strong> هستند، که <strong>business logic</strong> را قادر می‌سازند تا به پایگاه داده <strong>MySQL</strong> دسترسی پیدا کرده و سرویس‌های ابری مانند <strong>Twilio</strong> و
   <strong>Stripe</strong> را فراخوانی کنند.
  </p>
<p>
   علیرغم داشتن یک معماری منطقی ماژولار، <strong>application</strong> <strong>FTGO</strong> به عنوان یک فایل
   <strong>WAR</strong> واحد بسته‌بندی می‌شود. این <strong>application</strong> نمونه‌ای از سبک
   <strong>monolithic</strong> است که به طور گسترده استفاده می‌شود.
  </p>
<p>
   درخواست شده توسط <strong>mobile applications</strong>
</p>
<p><strong>Twilio</strong></p>
<p><strong>messaging</strong></p>
<p><strong>service</strong></p>
<p>سرویس‌های ابری</p>
<p><strong>FTGO application</strong></p>
<p><strong>AWS SES</strong></p>
<p>ایمیل</p>
<p><strong>service</strong></p>
<p><strong>Stripe</strong></p>
<p>پرداخت</p>
<p><strong>service</strong></p>
<p>آداپتورها سرویس‌های ابری را فراخوانی می‌کنند.</p>
<p><strong>Twilio</strong></p>
<p><strong>adapter</strong></p>
<p>پیک</p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p>وب</p>
<p><strong>UI</strong></p>
<p><strong>MySQL</strong></p>
<p><strong>adapter</strong></p>
<p>مدیریت رستوران</p>
<p>پرداخت‌ها</p>
<p>صورتحساب</p>
<p>اعلان</p>
<p>سفارش</p>
<p>مدیریت</p>
<p>تحویل</p>
<p>مدیریت</p>
<p><strong>Amazon</strong></p>
<p><strong>SES</strong></p>
<p><strong>adapter</strong></p>
<p><strong>Stripe</strong></p>
<p><strong>adapter</strong></p>
<p>مصرف‌کننده</p>
<p>رستوران</p>
<p><strong>MySQL</strong></p>
<p>شکل 1.1</p>
<p><strong>application</strong> <strong>FTGO</strong> دارای معماری شش ضلعی است. این معماری از <strong>business logic</strong> تشکیل شده است که توسط آداپتورهایی احاطه شده است که رابط‌های کاربری را پیاده‌سازی می‌کنند و با سیستم‌های خارجی، مانند <strong>mobile applications</strong> و سرویس‌های ابری برای پرداخت‌ها، پیام‌رسانی و ایمیل، ارتباط برقرار می‌کنند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0033_original/original_page.png" alt="Original Page 33">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>4</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<p>از معماری <strong>software</strong>، که یک سیستم را به عنوان یک مؤلفه قابل اجرا یا استقرار واحد ساختار می‌دهد. اگر <strong>application</strong> <strong>FTGO</strong> به زبان <strong>Go</strong> (<strong>GoLang</strong>) نوشته شده بود، یک فایل اجرایی واحد بود. نسخه
   <strong>Ruby</strong> یا <strong>NodeJS</strong> از این <strong>application</strong> یک سلسله‌مراتب دایرکتوری از کد منبع خواهد بود. معماری <strong>monolithic</strong> ذاتاً بد نیست. <strong>developers</strong> <strong>FTGO</strong> زمانی که معماری <strong>monolithic</strong> را برای <strong>application</strong> خود انتخاب کردند، تصمیم درستی گرفتند.
  </p>
<p>1.1.2</p>
<p><strong>The benefits of the monolithic architecture</strong></p>
<p>در روزهای اولیه <strong>FTGO</strong>، زمانی که <strong>application</strong> نسبتاً کوچک بود، معماری <strong>monolithic</strong> <strong>application</strong> مزایای زیادی داشت:</p>
<ul>
<li>
    ساختن <strong>Simple</strong> — <strong>IDEs</strong> و سایر ابزارهای <strong>developer</strong> بر ساختن یک <strong>application</strong> واحد متمرکز هستند.
   </li>
<li>
    آسان برای ایجاد تغییرات اساسی در <strong>application</strong> - شما می‌توانید کد و <strong>database schema</strong> را تغییر دهید، بسازید و استقرار دهید.
   </li>
<li>
    تست کردن <strong>Straightforward</strong> — <strong>developers</strong> تست‌های <strong>end-to-end</strong> را نوشتند که <strong>application</strong> را راه‌اندازی می‌کرد، <strong>REST API</strong> را فراخوانی می‌کرد و <strong>UI</strong> را با
    <strong>Selenium</strong> تست می‌کرد.
   </li>
<li>
    راه‌اندازی <strong>Straightforward</strong> — تنها کاری که یک <strong>developer</strong> باید انجام می‌داد این بود که فایل
    <strong>WAR</strong> را در یک سروری که <strong>Tomcat</strong> نصب شده بود کپی کند.
   </li>
<li>
<strong>Easy to scale</strong>—<strong>FTGO</strong> چندین نمونه از <strong>application</strong> را در پشت یک
    <strong>load balancer</strong> اجرا کرد.
   </li>
</ul>
<p>
   با گذشت زمان، توسعه، تست، استقرار و مقیاس‌بندی بسیار دشوارتر شد. بیایید نگاهی بیندازیم که چرا.
  </p>
<p>1.1.3</p>
<p><strong>Living in monolithic hell</strong></p>
<p>متأسفانه، همانطور که <strong>developers</strong> <strong>FTGO</strong> کشف کرده‌اند، معماری <strong>monolithic</strong> دارای یک محدودیت بزرگ است. <strong>applications</strong> موفق مانند <strong>application</strong> <strong>FTGO</strong> عادت دارند که از معماری
   <strong>monolithic</strong> فراتر بروند. در هر <strong>sprint</strong>، تیم توسعه <strong>FTGO</strong> چند داستان دیگر را پیاده‌سازی کرد که باعث بزرگتر شدن <strong>code base</strong> شد. علاوه بر این، با موفقیت بیشتر شرکت، اندازه تیم توسعه به طور پیوسته افزایش یافت.</p>
<p>
   این نه تنها باعث افزایش سرعت رشد <strong>code base</strong> شد، بلکه سربار مدیریت را نیز افزایش داد.
  </p>
<p>
   همانطور که شکل 1.2 نشان می‌دهد، <strong>application</strong> <strong>FTGO</strong> که زمانی کوچک و ساده بود، در طول سال‌ها به یک <strong>monolith</strong> هیولا تبدیل شده است. به طور مشابه، تیم توسعه کوچک اکنون به تیم‌های <strong>Scrum</strong> متعددی تبدیل شده است که هر کدام بر روی یک حوزه عملکردی خاص کار می‌کنند.
   در نتیجه فراتر رفتن از معماری خود، <strong>FTGO</strong> در جهنم <strong>monolithic</strong> قرار دارد. توسعه کند و دردناک است. توسعه و استقرار <strong>Agile</strong> غیرممکن است. بیایید نگاهی بیندازیم که چرا این اتفاق افتاده است.
  </p>
<p><strong>COMPLEXITY INTIMIDATES DEVELOPERS</strong></p>
<p>یک مشکل اساسی در <strong>application</strong> <strong>FTGO</strong> این است که بیش از حد پیچیده است. برای اینکه هر <strong>developer</strong> آن را به طور کامل درک کند، بسیار بزرگ است. در نتیجه، رفع اشکالات و پیاده‌سازی صحیح ویژگی‌های جدید دشوار و زمان‌بر شده است. مهلت‌ها از دست می‌روند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0034_original/original_page.png" alt="Original Page 34">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>5</p>
<p><strong>The slow march toward monolithic hell</strong></p>
<p>برای بدتر کردن اوضاع، این پیچیدگی طاقت‌فرسا تمایل به یک مارپیچ نزولی دارد. اگر <strong>code base</strong> دشوار است، یک <strong>developer</strong> تغییرات را به درستی انجام نمی‌دهد. هر تغییر باعث می‌شود <strong>code base</strong> به طور فزاینده‌ای پیچیده‌تر و درک آن دشوارتر شود. معماری تمیز و ماژولار که قبلاً در شکل 1.1 نشان داده شد، واقعیت را منعکس نمی‌کند. <strong>FTGO</strong> به تدریج در حال تبدیل شدن به یک توپ بزرگ و غیرقابل درک و هیولایی از گل است.</p>
<p>
   ماری به یاد می‌آورد که اخیراً در کنفرانسی شرکت کرده بود که در آن با <strong>developer</strong>ی ملاقات کرد که در حال نوشتن ابزاری برای تجزیه و تحلیل وابستگی‌ها بین هزاران <strong>JAR</strong> در <strong>application</strong> چند میلیون خطی (<strong>LOC</strong>) بود. در آن زمان، آن ابزار چیزی به نظر می‌رسید که <strong>FTGO</strong> می‌توانست از آن استفاده کند. اکنون او مطمئن نیست. ماری گمان می‌کند که یک رویکرد بهتر، مهاجرت به معماری است که برای یک <strong>application</strong> پیچیده مناسب‌تر است:
   <strong>microservices</strong>.
  </p>
<p><strong>DEVELOPMENT IS SLOW</strong></p>
<p>علاوه بر مبارزه با پیچیدگی طاقت‌فرسا، <strong>developers</strong> <strong>FTGO</strong> وظایف توسعه روزانه را کند می‌یابند. <strong>application</strong> بزرگ، <strong>IDE</strong> <strong>developer</strong> را اضافه بار می‌کند و کند می‌کند. ساخت <strong>application</strong> <strong>FTGO</strong> زمان زیادی می‌برد. علاوه بر این، از آنجایی که بسیار بزرگ است، راه‌اندازی <strong>application</strong> زمان زیادی می‌برد. در نتیجه، حلقه ویرایش-ساخت-اجرا-تست زمان زیادی می‌برد که به شدت بر بهره‌وری تأثیر می‌گذارد.</p>
<p><strong>PATH FROM COMMIT TO DEPLOYMENT IS LONG AND ARDUOUS</strong></p>
<p>مشکل دیگر در مورد <strong>application</strong> <strong>FTGO</strong> این است که استقرار تغییرات در تولید یک فرآیند طولانی و دردناک است. این تیم معمولاً به‌روزرسانی‌ها را یک بار در ماه، معمولاً اواخر شب جمعه یا شنبه، در تولید مستقر می‌کند. ماری همچنان می‌خواند که وضعیت هنر برای <strong>applications</strong> <strong>Software-as-a-Service (SaaS)</strong> استقرار مداوم است:</p>
<p>سازمان توسعه بزرگ</p>
<p><strong>code base</strong> واحد ایجاد می‌کند</p>
<p>سربار ارتباطات و</p>
<p>هماهنگی</p>
<p>بزرگ، پیچیده</p>
<p>غیرقابل اعتماد، دشوار</p>
<p>برای حفظ</p>
<p>مسیر از <strong>commit</strong> کد به</p>
<p>تولید دشوار است.</p>
<p>تغییرات در صف باقی می‌مانند تا</p>
<p>آن‌ها را بتوان به صورت دستی تست کرد.</p>
<p>تیم مدیریت سفارش</p>
<p>تیم مدیریت رستوران</p>
<p>تیم مدیریت تحویل</p>
<p>توسعه <strong>FTGO</strong></p>
<p>تولید</p>
<p><strong>Jenkins</strong></p>
<p><strong>Cl</strong></p>
<p>لیست کارها</p>
<p><strong>Deployment pipeline</strong></p>
<p>منبع</p>
<p>کد</p>
<p><strong>repository</strong></p>
<p>دستی</p>
<p>تست کردن</p>
<p><strong>FTGO</strong></p>
<p><strong>application</strong></p>
<p>شکل 1.2</p>
<p>یک مورد از جهنم <strong>monolithic</strong>. تیم توسعه‌دهنده بزرگ <strong>FTGO</strong> تغییرات خود را در یک مخزن کد منبع واحد متعهد می‌کند. مسیر از <strong>commit</strong> کد به تولید طولانی و دشوار است و شامل تست دستی است. <strong>application</strong> <strong>FTGO</strong> بزرگ، پیچیده، غیرقابل اعتماد و دشوار برای نگهداری است.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0035_original/original_page.png" alt="Original Page 35">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>6</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<p>استقرار تغییرات در تولید چندین بار در روز در ساعات کاری. ظاهراً، از سال 2011،
   <strong>Amazon.com</strong> یک تغییر را هر 11.6 ثانیه در تولید مستقر کرد بدون اینکه هرگز بر کاربر تأثیر بگذارد! برای <strong>developers</strong> <strong>FTGO</strong>، به‌روزرسانی تولید بیش از یک بار در ماه مانند یک رویای دور به نظر می‌رسد. و اتخاذ استقرار مداوم تقریباً غیرممکن به نظر می‌رسد.
  </p>
<p>
<strong>FTGO</strong> تا حدی <strong>agile</strong> را اتخاذ کرده است. تیم مهندسی به دسته‌ها تقسیم شده و از <strong>sprints</strong> دو هفته‌ای استفاده می‌کند. متأسفانه، سفر از کد کامل تا اجرا در تولید طولانی و دشوار است. یک مشکل با تعداد زیادی از <strong>developers</strong> که به همان <strong>code base</strong> متعهد هستند این است که <strong>build</strong> اغلب در یک حالت غیرقابل انتشار است. هنگامی که <strong>developers</strong> <strong>FTGO</strong> سعی کردند این مشکل را با استفاده از شاخه‌های ویژگی حل کنند، تلاش آن‌ها منجر به ادغام‌های طولانی و دردناک شد. در نتیجه، پس از اینکه یک تیم <strong>sprint</strong> خود را تکمیل می‌کند، یک دوره طولانی از تست و تثبیت کد دنبال می‌شود.
  </p>
<p>
   دلیل دیگر اینکه تغییرات خیلی طول می‌کشد تا وارد تولید شود این است که تست زمان زیادی می‌برد. از آنجایی که <strong>code base</strong> بسیار پیچیده است و تأثیر یک تغییر به خوبی درک نشده است، <strong>developers</strong> و سرور <strong>Continuous Integration (CI)</strong> باید کل مجموعه تست را اجرا کنند. برخی از بخش‌های سیستم حتی نیاز به تست دستی دارند. همچنین زمان می‌برد تا علت خرابی تست تشخیص داده و برطرف شود. در نتیجه، تکمیل یک چرخه تست چند روز طول می‌کشد.
  </p>
<p><strong>SCALING IS DIFFICULT</strong></p>
<p>تیم <strong>FTGO</strong> همچنین در مقیاس‌بندی <strong>application</strong> خود مشکل دارد. این به این دلیل است که ماژول‌های مختلف <strong>application</strong> الزامات منابع متناقضی دارند. به عنوان مثال، داده‌های رستوران در یک پایگاه داده بزرگ درون حافظه ذخیره می‌شوند که در حالت ایده‌آل بر روی سرورهایی با حافظه زیاد مستقر شده‌اند. در مقابل، ماژول پردازش تصویر <strong>CPU</strong> فشرده است و بهترین عملکرد را در سرورهایی با <strong>CPU</strong> زیاد دارد. از آنجایی که این ماژول‌ها بخشی از یک <strong>application</strong> هستند، <strong>FTGO</strong> باید در پیکربندی سرور سازش کند.</p>
<p><strong>DELIVERING A RELIABLE MONOLITH IS CHALLENGING</strong></p>
<p>مشکل دیگر در <strong>application</strong> <strong>FTGO</strong>، عدم اطمینان‌پذیری است. در نتیجه، قطعی‌های مکرر تولید وجود دارد. یک دلیل غیرقابل اطمینان بودن آن این است که تست کامل <strong>application</strong> به دلیل اندازه بزرگ آن دشوار است. این عدم قابلیت تست به این معنی است که <strong>bugs</strong> راه خود را به تولید باز می‌کنند. برای بدتر کردن اوضاع، <strong>application</strong> فاقد جداسازی خطا است، زیرا همه ماژول‌ها در یک فرآیند اجرا می‌شوند. هر از چند گاهی، یک باگ در یک ماژول - به عنوان مثال، نشت حافظه - تمام نمونه‌های <strong>application</strong> را یکی یکی خراب می‌کند. <strong>developers</strong> <strong>FTGO</strong> از اینکه در اواسط شب به دلیل قطعی تولید، صفحه بندی شوند لذت نمی‌برند. مردم کسب‌وکار، ضرر درآمد و اعتماد را حتی کمتر دوست دارند.</p>
<p><strong>LOCKED INTO INCREASINGLY OBSOLETE TECHNOLOGY STACK</strong></p>
<p>جنبه نهایی جهنم <strong>monolithic</strong> که توسط تیم <strong>FTGO</strong> تجربه شده است این است که معماری آن‌ها را مجبور می‌کند از یک <strong>technology stack</strong> استفاده کنند که به طور فزاینده‌ای منسوخ می‌شود. معماری <strong>monolithic</strong> اتخاذ فریم‌ورک‌ها و زبان‌های جدید را دشوار می‌کند. بازنویسی کل <strong>application</strong> <strong>monolithic</strong> به طوری که از یک فناوری جدید و احتمالاً بهتر استفاده کند، بسیار پرهزینه و خطرناک خواهد بود. در نتیجه، <strong>developers</strong></p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0036_original/original_page.png" alt="Original Page 36">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>7</p>
<p><strong>What you’ll learn in this book</strong></p>
<p>با انتخاب‌های فناوری که در ابتدای پروژه انجام داده‌اند، گیر کرده‌اند. اغلب، آن‌ها باید برنامه‌ای را که با استفاده از یک <strong>technology stack</strong> به طور فزاینده‌ای منسوخ شده است، نگهداری کنند.
  </p>
<p>
   فریم‌ورک <strong>Spring</strong> همچنان به تکامل خود ادامه می‌دهد در حالی که با عقب سازگار است، بنابراین از نظر تئوری <strong>FTGO</strong> ممکن است قادر به ارتقا بوده باشد. متأسفانه، <strong>application</strong> <strong>FTGO</strong> از نسخه‌های فریم‌ورک‌هایی استفاده می‌کند که با نسخه‌های جدیدتر <strong>Spring</strong> ناسازگار هستند. تیم توسعه هرگز زمان لازم برای ارتقای آن فریم‌ورک‌ها را پیدا نکرده است. در نتیجه، بخش‌های اصلی <strong>application</strong> با استفاده از فریم‌ورک‌های منسوخ نوشته شده‌اند.
   علاوه بر این، <strong>developers</strong> <strong>FTGO</strong> می‌خواهند زبان‌های غیر
   <strong>JVM</strong> مانند <strong>GoLang</strong> و <strong>NodeJS</strong> را آزمایش کنند. متأسفانه، این کار با یک <strong>application monolithic</strong> امکان‌پذیر نیست.
  </p>
<p>1.2</p>
<p><strong>Why this book is relevant to you</strong></p>
<p>احتمالاً شما یک <strong>developer</strong>، <strong>architect</strong>، <strong>CTO</strong> یا <strong>VP</strong> مهندسی هستید. شما مسئول یک <strong>application</strong> هستید که از معماری <strong>monolithic</strong> خود فراتر رفته است. مانند ماری در <strong>FTGO</strong>، شما با تحویل <strong>software</strong> دست و پنجه نرم می‌کنید و می‌خواهید بدانید چگونه از جهنم <strong>monolith</strong> فرار کنید. یا شاید شما می‌ترسید که سازمان شما در مسیر جهنم <strong>monolithic</strong> قرار دارد و می‌خواهید بدانید چگونه جهت را تغییر دهید قبل از اینکه دیر شود. اگر نیاز دارید از جهنم <strong>monolithic</strong> فرار کنید یا از آن اجتناب کنید، این کتاب برای شماست.</p>
<p>
   این کتاب زمان زیادی را صرف توضیح مفاهیم معماری <strong>microservice</strong> می‌کند. هدف من این است که شما این مطالب را بدون توجه به <strong>technology stack</strong>ی که استفاده می‌کنید، در دسترس بدانید. تنها چیزی که نیاز دارید این است که با اصول اولیه معماری و طراحی <strong>application</strong> سازمانی آشنا باشید. به طور خاص، شما باید موارد زیر را بدانید:
  </p>
<ul>
<li>معماری <strong>Three-tier</strong></li>
<li>طراحی <strong>Web application</strong></li>
<li>نحوه توسعه <strong>business logic</strong> با استفاده از طراحی شی گرا</li>
<li>نحوه استفاده از <strong>RDBMS</strong>: <strong>SQL</strong> و <strong>ACID transactions</strong></li>
<li>نحوه استفاده از <strong>interprocess communication</strong> با استفاده از یک <strong>message broker</strong> و <strong>REST APIs</strong></li>
<li>امنیت، از جمله <strong>authentication</strong> و <strong>authorization</strong></li>
</ul>
<p>
   مثال‌های کد در این کتاب با استفاده از <strong>Java</strong> و فریم‌ورک <strong>Spring</strong> نوشته شده‌اند. این بدان معناست که برای اینکه بیشترین بهره را از مثال‌ها ببرید، باید با فریم‌ورک <strong>Spring</strong> نیز آشنا باشید.
  </p>
<p>1.3</p>
<p><strong>What you’ll learn in this book</strong></p>
<p>تا زمانی که خواندن این کتاب را به پایان رسانده‌اید، موارد زیر را درک خواهید کرد:</p>
<ul>
<li>
    ویژگی‌های اساسی معماری <strong>microservice</strong>، مزایا و معایب آن، و زمان استفاده از آن
   </li>
<li>
    الگوهای مدیریت داده‌های توزیع شده
   </li>
<li>
    استراتژی‌های تست <strong>microservice</strong> مؤثر
   </li>
<li>
    گزینه‌های استقرار برای <strong>microservices</strong>
</li>
<li>
    استراتژی‌هایی برای <strong>refactoring</strong> یک <strong>application monolithic</strong> به معماری <strong>microservice</strong>
</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0037_original/original_page.png" alt="Original Page 37">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>8</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<p>شما همچنین قادر خواهید بود موارد زیر را انجام دهید:</p>
<ul>
<li>معماری یک <strong>application</strong> را با استفاده از الگوی معماری <strong>microservice</strong> انجام دهید</li>
<li><strong>business logic</strong> را برای یک <strong>service</strong> توسعه دهید</li>
<li>از <strong>sagas</strong> برای حفظ سازگاری داده‌ها در <strong>services</strong> استفاده کنید</li>
<li>پیاده‌سازی <strong>queries</strong> که <strong>services</strong> را پوشش می‌دهند</li>
<li>به طور موثر <strong>microservices</strong> را تست کنید</li>
<li>توسعه <strong>services</strong> آماده تولید که ایمن، قابل تنظیم و قابل مشاهده هستند</li>
<li>یک <strong>application monolithic</strong> موجود را به <strong>services refactor</strong> کنید</li>
</ul>
<p>1.4</p>
<p><strong>Microservice architecture to the rescue</strong></p>
<p>ماری به این نتیجه رسیده است که
   <strong>FTGO</strong> باید به معماری <strong>microservice</strong> مهاجرت کند.
  </p>
<p>
   جالب اینجاست که معماری <strong>software</strong> ارتباط بسیار کمی با الزامات عملکردی دارد. شما می‌توانید مجموعه‌ای از موارد استفاده - الزامات عملکردی <strong>application</strong> - را با هر معماری پیاده‌سازی کنید. در واقع، این یک امر رایج برای <strong>applications</strong> موفق است، مانند <strong>application</strong> <strong>FTGO</strong>، که توپ‌های بزرگی از گل هستند.
  </p>
<p>
   با این حال، معماری مهم است، زیرا بر آنچه به اصطلاح الزامات کیفیت <strong>service</strong> تأثیر می‌گذارد، که الزامات غیر عملکردی، ویژگی‌های کیفیت یا <strong>ilities</strong> نیز نامیده می‌شوند. با رشد <strong>application</strong> <strong>FTGO</strong>، ویژگی‌های کیفیت مختلفی آسیب دیده‌اند، که بارزترین آن‌ها بر سرعت تحویل <strong>software</strong> تأثیر می‌گذارند: قابلیت نگهداری، قابلیت توسعه و قابلیت تست.
  </p>
<p>
   از یک طرف، یک تیم منضبط می‌تواند سرعت نزول خود را به سمت جهنم <strong>monolithic</strong> کاهش دهد. اعضای تیم می‌توانند سخت کار کنند تا ماژولار بودن <strong>application</strong> خود را حفظ کنند. آن‌ها می‌توانند تست‌های خودکار جامع بنویسند. از سوی دیگر، آن‌ها نمی‌توانند از مسائل یک تیم بزرگ که روی یک <strong>application monolithic</strong> واحد کار می‌کنند، اجتناب کنند. آن‌ها همچنین نمی‌توانند مشکل یک <strong>technology stack</strong> به طور فزاینده منسوخ را حل کنند. بهترین کاری که یک تیم می‌تواند انجام دهد این است که اجتناب‌ناپذیر را به تأخیر بیندازد. برای فرار از جهنم <strong>monolithic</strong>، آن‌ها باید به یک معماری جدید مهاجرت کنند: معماری
   <strong>Microservice</strong>.
  </p>
<p>
   امروزه، اجماع فزاینده این است که اگر در حال ساخت یک <strong>application</strong> بزرگ و پیچیده هستید، باید استفاده از معماری
   <strong>microservice</strong> را در نظر بگیرید. اما <strong>microservices</strong> دقیقاً چیست؟ متأسفانه، نام آن کمکی نمی‌کند زیرا اندازه را بیش از حد مورد تاکید قرار می‌دهد. تعاریف متعددی از معماری
   <strong>microservice</strong> وجود دارد. برخی نام را خیلی تحت‌الفظی می‌گیرند و ادعا می‌کنند که یک <strong>service</strong> باید کوچک باشد - به عنوان مثال، 100
   <strong>LOC</strong>. دیگران ادعا می‌کنند که توسعه یک <strong>service</strong> تنها دو هفته زمان می‌برد. <strong>Adrian Cockcroft</strong>، سابقاً از
   <strong>Netflix</strong>، معماری <strong>microservice</strong> را به عنوان یک معماری <strong>service-oriented</strong> تعریف می‌کند که از عناصر <strong>loosely coupled</strong> تشکیل شده است که دارای زمینه‌های محدود هستند. این تعریف بدی نیست، اما کمی متراکم است. بیایید ببینیم آیا می‌توانیم بهتر عمل کنیم.
  </p>
<p>1.4.1</p>
<p><strong>Scale cube and microservices</strong></p>
<p>تعریف من از معماری <strong>microservice</strong> از کتاب عالی <strong>Martin Abbott</strong> و <strong>Michael Fisher</strong> با عنوان <strong>The Art of Scalability (Addison-Wesley, 2015)</strong> الهام گرفته شده است. این</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0038_original/original_page.png" alt="Original Page 38">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>9</p>
<p><strong>Microservice architecture to the rescue</strong></p>
<p>این کتاب یک مدل مقیاس‌پذیری سه‌بعدی مفید را توصیف می‌کند: <strong>scale cube</strong>، که در شکل 1.3 نشان داده شده است.</p>
<p>
   این مدل سه روش برای مقیاس‌بندی یک <strong>application</strong> را تعریف می‌کند:
   <strong>X</strong>،
   <strong>Y</strong> و
   <strong>Z</strong>.
  </p>
<p><strong>X-AXIS SCALING LOAD BALANCES REQUESTS ACROSS MULTIPLE INSTANCES</strong></p>
<p>مقیاس‌بندی محور
   <strong>X</strong> یک راه رایج برای مقیاس‌بندی یک <strong>application monolithic</strong> است. شکل 1.4 نحوه عملکرد مقیاس‌بندی محور <strong>X</strong> را نشان می‌دهد. شما چندین نمونه از <strong>application</strong> را در پشت یک
   <strong>load balancer</strong> اجرا می‌کنید.
   <strong>load balancer</strong> درخواست‌ها را بین
   <strong>N</strong> نمونه یکسان از <strong>application</strong> توزیع می‌کند. این یک راه عالی برای بهبود ظرفیت و در دسترس بودن یک <strong>application</strong> است.
  </p>
<p><strong>Z-AXIS SCALING ROUTES REQUESTS BASED ON AN ATTRIBUTE OF THE REQUEST</strong></p>
<p>مقیاس‌بندی محور
   <strong>Z</strong> همچنین چندین نمونه از <strong>application monolith</strong> را اجرا می‌کند، اما بر خلاف مقیاس‌بندی محور <strong>X</strong>، هر نمونه فقط مسئول زیرمجموعه‌ای از داده‌ها است. شکل 1.5 نحوه عملکرد مقیاس‌بندی محور <strong>Z</strong> را نشان می‌دهد. مسیریاب جلوی نمونه‌ها از یک ویژگی درخواست برای هدایت آن به نمونه مناسب استفاده می‌کند. به عنوان مثال، یک <strong>application</strong> ممکن است درخواست‌ها را با استفاده از <strong>userId</strong> مسیریابی کند.
  </p>
<p>
   در این مثال، هر نمونه <strong>application</strong> مسئول زیرمجموعه‌ای از کاربران است. مسیریاب از <strong>userId</strong> مشخص شده توسط سربرگ <strong>Authorization</strong> درخواست برای انتخاب یکی از
  </p>
<p>
<strong>Microservices</strong>
</p>
<p>مقیاس‌بندی محور
   <strong>Y</strong>،
   به عنوان مثال، تجزیه عملکردی
  </p>
<p>مقیاس‌بندی با تقسیم</p>
<p>چیزهایی که متفاوت هستند، مانند</p>
<p>به وسیله عملکرد.</p>
<p>مقیاس‌بندی محور
   <strong>X</strong>،
   به عنوان مثال، تکرار افقی
  </p>
<p>مقیاس‌بندی با کلون کردن.</p>
<p>مقیاس‌بندی محور
   <strong>Z</strong>،
   به عنوان مثال، پارتیشن‌بندی داده‌ها
  </p>
<p>مقیاس‌بندی با تقسیم</p>
<p>چیزهای مشابه، مانند</p>
<p>با <strong>customer ID</strong>.</p>
<p>یک</p>
<p>نمونه</p>
<p>بسیاری از</p>
<p>نمونه‌ها</p>
<p>یک</p>
<p>پارتیشن</p>
<p>بسیاری از</p>
<p>پارتیشن‌ها</p>
<p><strong>Monolith</strong></p>
<p>شکل 1.3</p>
<p><strong>scale cube</strong> سه روش جداگانه برای مقیاس‌بندی یک <strong>application</strong> را تعریف می‌کند: مقیاس‌بندی محور <strong>X</strong> درخواست‌ها را در چندین نمونه یکسان متعادل می‌کند. مقیاس‌بندی محور
   <strong>Z</strong> درخواست‌ها را بر اساس یک ویژگی از درخواست مسیریابی می‌کند. محور
   <strong>Y</strong> یک <strong>application</strong> را از نظر عملکردی به <strong>services</strong> تجزیه می‌کند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0039_original/original_page.png" alt="Original Page 39">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>10</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<p><strong>the N identical instances of the application</strong>. مقیاس‌بندی محور <strong>Z</strong> یک راه عالی برای مقیاس‌بندی یک <strong>application</strong> برای رسیدگی به افزایش حجم <strong>transaction</strong> و داده‌ها است.</p>
<p><strong>Y-AXIS SCALING FUNCTIONALLY DECOMPOSES AN APPLICATION INTO SERVICES</strong></p>
<p>مقیاس‌بندی محور <strong>X</strong> و <strong>Z</strong> ظرفیت و در دسترس بودن <strong>application</strong> را بهبود می‌بخشند. اما هیچ رویکردی مشکل افزایش پیچیدگی توسعه و <strong>application</strong> را حل نمی‌کند. برای حل این مشکلات، باید مقیاس‌بندی محور
   <strong>Y</strong>، یا تجزیه عملکردی را اعمال کنید. شکل 1.6 نشان می‌دهد که مقیاس‌بندی محور
   <strong>Y</strong> چگونه کار می‌کند: با تقسیم یک <strong>application monolithic</strong> به مجموعه‌ای از
   <strong>services</strong>.</p>
<p>نمونه <strong>Application</strong> 1</p>
<p><strong>N</strong> نمونه <strong>application</strong> یکسان</p>
<p>نمونه <strong>Application</strong> 2</p>
<p><strong>Load</strong></p>
<p><strong>balancer</strong></p>
<p>مشتری</p>
<p>درخواست</p>
<p>نمونه <strong>Application</strong> 3</p>
<p>درخواست‌ها را با استفاده از یک</p>
<p>الگوریتم تعادل بار مسیریابی کنید.</p>
<p>شکل 1.4</p>
<p>مقیاس‌بندی محور
   <strong>X</strong> چندین نمونه یکسان از <strong>application monolithic</strong> را در پشت یک
   <strong>load balancer</strong> اجرا می‌کند.</p>
<p>نمونه <strong>Application</strong> 1</p>
<p><strong>N</strong> نمونه <strong>application</strong> یکسان</p>
<p>نمونه <strong>Application</strong> 2</p>
<p>مشتری</p>
<p>روتر</p>
<p>درخواست:</p>
<p><strong>GET /...</strong></p>
<p>مجوز:</p>
<p><strong>userId:password</strong></p>
<p>نمونه <strong>Application</strong> 3</p>
<p>کاربران: <strong>a–h</strong></p>
<p>کاربران: <strong>i-p</strong></p>
<p>کاربران: <strong>r–z</strong></p>
<p>از <strong>userId</strong> برای تصمیم‌گیری استفاده می‌کند</p>
<p>کجا درخواست‌ها را مسیریابی کند</p>
<p>هر نمونه مسئول</p>
<p>برای زیرمجموعه‌ای از کاربران.</p>
<p>شکل 1.5</p>
<p>مقیاس‌بندی محور
   <strong>Z</strong> چندین نمونه یکسان از <strong>application monolithic</strong> را در پشت یک مسیریاب اجرا می‌کند، که بر اساس یک ویژگی درخواست مسیریابی می‌کند. هر نمونه مسئول زیرمجموعه‌ای از داده‌ها است.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0040_original/original_page.png" alt="Original Page 40">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>11</p>
<p><strong>Microservice architecture to the rescue</strong></p>
<p>یک <strong>service</strong> یک <strong>mini application</strong> است که عملکردی با تمرکز محدود را پیاده‌سازی می‌کند، مانند مدیریت سفارش، مدیریت مشتری و غیره. یک <strong>service</strong> با استفاده از مقیاس‌بندی محور <strong>X</strong> مقیاس‌بندی می‌شود، اگرچه برخی از <strong>services</strong> ممکن است از مقیاس‌بندی محور
   <strong>Z</strong> نیز استفاده کنند. به عنوان مثال،
   <strong>Order service</strong> شامل مجموعه‌ای از نمونه‌های <strong>service</strong> با <strong>load-balanced</strong> است.
  </p>
<p>
   تعریف سطح بالای معماری <strong>microservice</strong> (<strong>microservices</strong>) یک سبک معماری است که یک <strong>application</strong> را به طور عملکردی به مجموعه‌ای از <strong>services</strong> تجزیه می‌کند. توجه داشته باشید که این تعریف چیزی در مورد اندازه نمی‌گوید. در عوض، چیزی که مهم است این است که هر
   <strong>service</strong> مجموعه‌ای متمرکز و منسجم از مسئولیت‌ها را دارد. در ادامه کتاب در مورد معنای آن بحث خواهم کرد.
  </p>
<p>
   اکنون بیایید نگاهی بیندازیم که چگونه معماری <strong>microservice</strong> یک نوع ماژولار است.
  </p>
<p>1.4.2</p>
<p><strong>Microservices as a form of modularity</strong></p>
<p>ماژولار بودن در هنگام توسعه <strong>applications</strong> بزرگ و پیچیده ضروری است. یک <strong>application</strong> مدرن مانند
   <strong>FTGO</strong> برای توسعه توسط یک فرد بسیار بزرگ است. همچنین برای اینکه توسط یک فرد واحد درک شود، بسیار پیچیده است.
   <strong>Applications</strong> باید به ماژول‌هایی تجزیه شوند که توسط افراد مختلف توسعه یافته و درک می‌شوند. در یک <strong>application monolithic</strong>، ماژول‌ها با استفاده از ترکیبی از سازه‌های زبان برنامه‌نویسی (مانند بسته‌های <strong>Java</strong>) و مصنوعات ساخت (مانند فایل‌های <strong>Java JAR</strong>) تعریف می‌شوند. با این حال، همانطور که
   <strong>developers</strong> <strong>FTGO</strong> کشف کرده‌اند، این رویکرد در عمل خوب عمل نمی‌کند. <strong>applications monolithic</strong> طولانی‌مدت معمولاً به توپ‌های بزرگ گل تبدیل می‌شوند.
  </p>
<p>
   معماری <strong>microservice</strong> از <strong>services</strong> به عنوان واحد ماژولار استفاده می‌کند. یک
   <strong>service</strong> دارای یک
   <strong>API</strong> است، که یک مرز غیرقابل نفوذ است که نقض آن دشوار است. شما نمی‌توانید
  </p>
<p><strong>Order</strong></p>
<p><strong>Service</strong></p>
<p><strong>Application</strong></p>
<p><strong>Customer</strong></p>
<p><strong>Service</strong></p>
<p>مشتری</p>
<p><strong>Service</strong></p>
<p>درخواست‌ها را مرور کنید</p>
<p>درخواست‌ها را مرور کنید</p>
<p><strong>Order</strong></p>
<p><strong>Service</strong></p>
<p>نمونه 1</p>
<p><strong>Order service</strong></p>
<p><strong>Order</strong></p>
<p><strong>Service</strong></p>
<p>نمونه 2</p>
<p><strong>Order</strong></p>
<p><strong>Service</strong></p>
<p>نمونه 3</p>
<p><strong>Load</strong></p>
<p><strong>balancer</strong></p>
<p>درخواست</p>
<p>مقیاس‌بندی محور
   <strong>Y</strong> عملکرد را تجزیه می‌کند</p>
<p>یک <strong>application</strong> به <strong>services</strong>.</p>
<p>هر <strong>service</strong> معمولاً با استفاده از</p>
<p>مقیاس‌بندی محور <strong>X</strong> و احتمالاً مقیاس‌بندی محور <strong>Z</strong>.</p>
<p>شکل 1.6</p>
<p>مقیاس‌بندی محور
   <strong>Y</strong> <strong>application</strong> را به مجموعه‌ای از <strong>services</strong> تقسیم می‌کند. هر <strong>service</strong> مسئول یک عملکرد خاص است. یک
   <strong>service</strong> با استفاده از مقیاس‌بندی محور <strong>X</strong> و احتمالاً مقیاس‌بندی محور <strong>Z</strong> مقیاس‌بندی می‌شود.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0041_original/original_page.png" alt="Original Page 41">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>12</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<p><strong>the API</strong> و دسترسی به یک کلاس داخلی است، همانطور که می‌توانید با یک بسته
   <strong>Java</strong> انجام دهید. در نتیجه، حفظ ماژولار بودن <strong>application</strong> در طول زمان بسیار آسان‌تر است. مزایای دیگری نیز برای استفاده از <strong>services</strong> به عنوان بلوک‌های سازنده وجود دارد، از جمله توانایی استقرار و مقیاس‌بندی آن‌ها به طور مستقل.
  </p>
<p>1.4.3</p>
<p><strong>Each service has its own database</strong></p>
<p>یک ویژگی کلیدی معماری <strong>microservice</strong> این است که <strong>services</strong>
<strong>loosely coupled</strong> هستند و فقط از طریق <strong>APIs</strong> ارتباط برقرار می‌کنند. یک راه برای دستیابی به
   <strong>loose coupling</strong> این است که هر <strong>service</strong> <strong>datastore</strong> خود را داشته باشد. به عنوان مثال، در فروشگاه آنلاین، <strong>Order Service</strong> دارای یک پایگاه داده است که شامل جدول
   <strong>ORDERS</strong> است، و <strong>Customer Service</strong> دارای پایگاه داده خود است که شامل جدول
   <strong>CUSTOMERS</strong> است. در زمان توسعه، <strong>developers</strong> می‌توانند طرحواره یک <strong>service</strong> را بدون نیاز به هماهنگی با <strong>developers</strong> که روی <strong>services</strong> دیگر کار می‌کنند، تغییر دهند. در زمان اجرا، <strong>services</strong> از یکدیگر جدا شده‌اند - به عنوان مثال، یک <strong>service</strong> هرگز مسدود نخواهد شد زیرا <strong>service</strong> دیگری قفل پایگاه داده را نگه می‌دارد.
  </p>
<p>
   اکنون که معماری <strong>microservice</strong> را تعریف کردیم و برخی از ویژگی‌های ضروری آن را توصیف کردیم، بیایید نگاهی بیندازیم که چگونه این امر برای <strong>application</strong> <strong>FTGO</strong> اعمال می‌شود.
  </p>
<p>1.4.4</p>
<p><strong>The FTGO microservice architecture</strong></p>
<p>بقیه این کتاب، معماری <strong>microservice</strong> <strong>application</strong> <strong>FTGO</strong> را با جزئیات مورد بحث قرار می‌دهد. اما ابتدا بیایید به سرعت نگاهی بیندازیم که اعمال مقیاس‌بندی محور
   <strong>Y</strong> به این <strong>application</strong> چه معنایی دارد. اگر تجزیه محور <strong>Y</strong> را روی <strong>application</strong> <strong>FTGO</strong> اعمال کنیم، معماری نشان داده شده در شکل 1.7 را به دست می‌آوریم. <strong>application</strong> تجزیه شده از <strong>services</strong> <strong>frontend</strong> و <strong>backend</strong> متعددی تشکیل شده است. ما همچنین مقیاس‌بندی محور <strong>X</strong> و احتمالاً <strong>Z</strong> را اعمال می‌کنیم، به طوری که در زمان اجرا چندین نمونه از هر <strong>service</strong> وجود داشته باشد.
  </p>
<p>
<strong>services</strong> <strong>frontend</strong> شامل یک <strong>API gateway</strong> و <strong>Restaurant Web UI</strong> است.
   <strong>API gateway</strong>، که نقش <strong>facade</strong> را ایفا می‌کند و در فصل 8 با جزئیات توضیح داده شده است، <strong>REST APIs</strong> را ارائه می‌دهد که توسط <strong>applications</strong> <strong>mobile</strong> مصرف‌کنندگان و پیک‌ها استفاده می‌شود.
   <strong>Restaurant Web UI</strong> رابط وب را پیاده‌سازی می‌کند که توسط رستوران‌ها برای مدیریت منوها و پردازش سفارشات استفاده می‌شود.
  </p>
<p>
<strong>business logic</strong> <strong>application</strong> <strong>FTGO</strong> از <strong>services</strong> <strong>backend</strong> متعددی تشکیل شده است. هر <strong>service backend</strong> دارای یک
   <strong>REST API</strong> و <strong>datastore</strong> خصوصی خود است. <strong>services backend</strong> شامل موارد زیر است:
  </p>
<ul>
<li>
<strong>Order Service</strong>—مدیریت سفارشات
   </li>
<li>
<strong>Delivery Service</strong>—مدیریت تحویل سفارشات از رستوران‌ها به مصرف‌کنندگان
   </li>
</ul>
<p>نگران نباشید: <strong>Loose coupling</strong> لری الیسون را ثروتمندتر نمی‌کند</p>
<p>الزامی برای اینکه هر <strong>service</strong> پایگاه داده خود را داشته باشد به این معنی نیست که سرور پایگاه داده خود را دارد. به عنوان مثال، شما مجبور نیستید 10 برابر بیشتر از لایسنس‌های <strong>Oracle RDBMS</strong> هزینه کنید. فصل 2 این موضوع را با جزئیات بررسی می‌کند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0042_original/original_page.png" alt="Original Page 42">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>13</p>
<p><strong>Microservice architecture to the rescue</strong></p>
<ul>
<li>
<strong>Restaurant Service</strong>—اطلاعات مربوط به رستوران‌ها را نگهداری می‌کند
   </li>
<li>
<strong>Kitchen Service</strong>—مدیریت آماده‌سازی سفارشات
   </li>
<li>
<strong>Accounting Service</strong>—رسیدگی به صورتحساب و پرداخت‌ها
   </li>
</ul>
<p>بسیاری از <strong>services</strong> با ماژول‌هایی که قبلاً در این فصل توضیح داده شد، مطابقت دارند. آنچه متفاوت است این است که هر <strong>service</strong> و
   <strong>API</strong> آن بسیار واضح تعریف شده است. هر کدام را می‌توان به طور مستقل توسعه داد، تست کرد، مستقر کرد و مقیاس‌بندی کرد. همچنین، این معماری کار خوبی در حفظ ماژولار بودن انجام می‌دهد. یک <strong>developer</strong> نمی‌تواند <strong>API</strong> یک <strong>service</strong> را دور بزند و به مؤلفه‌های داخلی آن دسترسی پیدا کند. فصل 13 نحوه تبدیل یک <strong>application monolithic</strong> موجود را به <strong>microservices</strong> توضیح می‌دهد.
  </p>
<p>1.4.5</p>
<p><strong>Comparing the microservice architecture and SOA</strong></p>
<p>برخی از منتقدان معماری <strong>microservice</strong> ادعا می‌کنند که این چیز جدیدی نیست - این معماری <strong>service-oriented (SOA)</strong> است. در سطح بسیار بالایی، شباهت‌هایی وجود دارد.
   <strong>SOA</strong> و معماری <strong>microservice</strong> سبک‌های معماری هستند که یک سیستم را به صورت مجموعه‌ای از <strong>services</strong> ساختار می‌دهند. اما همانطور که جدول 1.1 نشان می‌دهد، هنگامی که عمیق‌تر می‌شوید، با تفاوت‌های قابل توجهی مواجه می‌شوید.</p>
<p><strong>Amazon</strong></p>
<p><strong>SES</strong></p>
<p>آداپتور</p>
<p><strong>Twilio</strong></p>
<p>آداپتور</p>
<p><strong>Stripe</strong></p>
<p>آداپتور</p>
<p><strong>The API Gateway routes</strong></p>
<p>درخواست‌ها از <strong>mobile</strong></p>
<p><strong>applications</strong> به <strong>services</strong>.</p>
<p><strong>Services</strong> دارای <strong>APIs</strong> هستند.</p>
<p>داده‌های یک <strong>service</strong> خصوصی است.</p>
<p><strong>Services</strong> مربوط به قابلیت‌های تجاری/</p>
<p><strong>domain-driven design (DDD)</strong> زیر دامنه‌ها</p>
<p><strong>API</strong></p>
<p><strong>Gateway</strong></p>
<p>رستوران</p>
<p>وب <strong>UI</strong></p>
<p><strong>Order</strong></p>
<p><strong>Service</strong></p>
<p>پیک</p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p>مصرف‌کننده</p>
<p>رستوران</p>
<p>رستوران</p>
<p><strong>Service</strong></p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p><strong>Accounting</strong></p>
<p><strong>Service</strong></p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p>اعلان</p>
<p><strong>Service</strong></p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p>آشپزخانه</p>
<p><strong>Service</strong></p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p>تحویل</p>
<p><strong>Service</strong></p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p>شکل 1.7</p>
<p>برخی از <strong>services</strong> از نسخه مبتنی بر معماری
   <strong>microservice</strong> از <strong>application</strong> <strong>FTGO</strong>. یک <strong>API Gateway</strong> درخواست‌ها را از <strong>mobile applications</strong> به <strong>services</strong> هدایت می‌کند. <strong>services</strong> از طریق <strong>APIs</strong> با هم همکاری می‌کنند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0043_original/original_page.png" alt="Original Page 43">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>14</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<p><strong>SOA</strong> و معماری <strong>microservice</strong> معمولاً از <strong>technology stacks</strong> متفاوتی استفاده می‌کنند. <strong>applications SOA</strong> معمولاً از فناوری‌های سنگین وزن مانند
   <strong>SOAP</strong> و سایر استانداردهای <strong>WS*</strong> استفاده می‌کنند. آن‌ها اغلب از یک <strong>ESB</strong>، یک لوله هوشمند که حاوی منطق تجاری و پردازش پیام برای یکپارچه‌سازی <strong>services</strong> است، استفاده می‌کنند.
   <strong>Applications</strong> ساخته شده با استفاده از معماری <strong>microservice</strong> تمایل به استفاده از فناوری‌های منبع باز سبک وزن دارند. <strong>services</strong> از طریق لوله‌های احمقانه، مانند <strong>message brokers</strong> یا پروتکل‌های سبک مانند <strong>REST</strong> یا
   <strong>gRPC</strong> ارتباط برقرار می‌کنند.
  </p>
<p>
<strong>SOA</strong> و معماری <strong>microservice</strong> همچنین در نحوه برخورد آن‌ها با داده‌ها متفاوت هستند.
   <strong>applications SOA</strong> معمولاً یک مدل داده جهانی دارند و پایگاه‌های داده را به اشتراک می‌گذارند. در مقابل، همانطور که قبلاً ذکر شد، در معماری
   <strong>microservice</strong> هر <strong>service</strong> پایگاه داده خود را دارد. علاوه بر این، همانطور که در فصل 2 توضیح داده شد، معمولاً فرض می‌شود که هر <strong>service</strong> مدل <strong>domain</strong> خود را دارد.
  </p>
<p>
   تفاوت کلیدی دیگر بین <strong>SOA</strong> و معماری <strong>microservice</strong> اندازه <strong>services</strong> است.
   <strong>SOA</strong> معمولاً برای یکپارچه‌سازی <strong>applications</strong> بزرگ، پیچیده و <strong>monolithic</strong> استفاده می‌شود. اگرچه <strong>services</strong> در معماری <strong>microservice</strong> همیشه کوچک نیستند، اما تقریباً همیشه بسیار کوچکتر هستند. در نتیجه، یک <strong>application SOA</strong> معمولاً از چند <strong>service</strong> بزرگ تشکیل شده است، در حالی که یک
   <strong>application</strong> مبتنی بر <strong>microservices</strong> معمولاً از ده‌ها یا صدها <strong>services</strong> کوچکتر تشکیل شده است.
  </p>
<p>1.5</p>
<p><strong>Benefits and drawbacks of the microservice architecture</strong></p>
<p>بیایید ابتدا مزایا را در نظر بگیریم و سپس به معایب نگاهی می‌اندازیم.</p>
<p>1.5.1</p>
<p><strong>Benefits of the microservice architecture</strong></p>
<p>معماری <strong>microservice</strong> دارای مزایای زیر است:</p>
<ul>
<li>این امکان را برای تحویل و استقرار مداوم <strong>applications</strong> بزرگ و پیچیده فراهم می‌کند.</li>
<li><strong>Services</strong> کوچک هستند و به راحتی نگهداری می‌شوند.</li>
<li><strong>Services</strong> به طور مستقل قابل استقرار هستند.</li>
<li><strong>Services</strong> به طور مستقل قابل مقیاس‌بندی هستند.</li>
<li>معماری <strong>microservice</strong> تیم‌ها را قادر می‌سازد تا مستقل باشند.</li>
<li>آزمایش و اتخاذ آسان فناوری‌های جدید را مجاز می‌کند.</li>
<li>دارای جداسازی خطای بهتر است.</li>
</ul>
<p>جدول 1.1</p>
<p>مقایسه <strong>SOA</strong> با <strong>microservices</strong></p>
<p><strong>SOA</strong></p>
<p><strong>Microservices</strong></p>
<p>ارتباط بین سرویس</p>
<p>لوله‌های هوشمند، مانند <strong>Enterprise Ser-</strong></p>
<p><strong>vice Bus</strong>، با استفاده از پروتکل‌های سنگین،</p>
<p>مانند <strong>SOAP</strong> و سایر استانداردهای <strong>WS*</strong>.</p>
<p>لوله‌های احمقانه، مانند یک <strong>message</strong></p>
<p><strong>broker</strong>، یا ارتباط مستقیم <strong>service-to-service</strong>،</p>
<p>با استفاده از پروتکل‌های سبک مانند
   <strong>REST</strong> یا
   <strong>gRPC</strong>
</p>
<p>داده‌ها</p>
<p>مدل داده‌های جهانی و داده‌های مشترک</p>
<p>پایگاه‌ها</p>
<p>مدل داده و پایگاه داده در هر <strong>service</strong></p>
<p><strong>service</strong> معمولی</p>
<p><strong>application</strong> بزرگتر <strong>monolithic</strong></p>
<p><strong>Service</strong> کوچکتر</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0044_original/original_page.png" alt="Original Page 44">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>15</p>
<p><strong>Benefits and drawbacks of the microservice architecture</strong></p>
<p>بیایید به هر مزیت نگاهی بیندازیم.</p>
<p><strong>ENABLES THE CONTINUOUS DELIVERY AND DEPLOYMENT OF LARGE, COMPLEX APPLICATIONS</strong></p>
<p>مهم‌ترین مزیت معماری <strong>microservice</strong> این است که امکان تحویل و استقرار مداوم <strong>applications</strong> بزرگ و پیچیده را فراهم می‌کند. همانطور که در بخش 1.7 توضیح داده شد، تحویل/استقرار مداوم بخشی از
   <strong>DevOps</strong> است، مجموعه‌ای از شیوه‌ها برای تحویل سریع، مکرر و قابل اطمینان <strong>software</strong>. سازمان‌های
   <strong>DevOps</strong> با عملکرد بالا معمولاً تغییرات را با مشکلات تولید بسیار کمی در تولید مستقر می‌کنند.
  </p>
<p>
   سه راه وجود دارد که معماری <strong>microservice</strong> تحویل/استقرار مداوم را فعال می‌کند:
  </p>
<ul>
<li>
    این قابلیت تست مورد نیاز برای تحویل/استقرار مداوم را دارد - تست خودکار یک روش کلیدی برای تحویل/استقرار مداوم است. از آنجایی که هر <strong>service</strong> در یک معماری
    <strong>microservice</strong> نسبتاً کوچک است، تست‌های خودکار بسیار آسان‌تر نوشته می‌شوند و سریع‌تر اجرا می‌شوند. در نتیجه، <strong>application</strong> باگ‌های کمتری خواهد داشت.
   </li>
<li>
    این قابلیت استقرار مورد نیاز برای تحویل/استقرار مداوم را دارد - هر <strong>service</strong> را می‌توان به طور مستقل از سایر <strong>services</strong> مستقر کرد. اگر <strong>developers</strong> مسئول یک <strong>service</strong> نیاز به استقرار تغییری دارند که محلی برای آن <strong>service</strong> است، نیازی به هماهنگی با <strong>developers</strong> دیگر ندارند. آن‌ها می‌توانند تغییرات خود را مستقر کنند. در نتیجه، استقرار مکرر تغییرات در تولید بسیار آسان‌تر است.
   </li>
<li>
    این تیم‌های توسعه را قادر می‌سازد تا مستقل و <strong>loosely coupled</strong> باشند - شما می‌توانید سازمان مهندسی را به عنوان مجموعه‌ای از تیم‌های کوچک (به عنوان مثال، دو پیتزا) ساختار دهید. هر تیم منحصراً مسئول توسعه و استقرار یک یا چند <strong>service</strong> مرتبط است. همانطور که شکل 1.8 نشان می‌دهد، هر تیم می‌تواند <strong>services</strong> خود را به طور مستقل از همه تیم‌های دیگر توسعه، استقرار و مقیاس‌بندی کند. در نتیجه، سرعت توسعه بسیار بالاتر است.
   </li>
</ul>
<p>
   توانایی انجام تحویل و استقرار مداوم، مزایای تجاری متعددی دارد:
  </p>
<ul>
<li>
    زمان ورود به بازار را کاهش می‌دهد، که به کسب‌وکار اجازه می‌دهد تا به سرعت به بازخورد مشتریان واکنش نشان دهد.
   </li>
<li>
    این کسب‌وکار را قادر می‌سازد تا نوع خدمات قابل اعتمادی را که مشتریان امروزی انتظار دارند، ارائه دهد.
   </li>
<li>
    رضایت کارکنان بالاتر است زیرا زمان بیشتری صرف ارائه ویژگی‌های ارزشمند می‌شود تا مبارزه با آتش.
   </li>
</ul>
<p>در نتیجه، معماری <strong>microservice</strong> به میزهای شرط‌بندی هر کسب‌وکاری تبدیل شده است که به فناوری <strong>software</strong> متکی است.</p>
<p><strong>EACH SERVICE IS SMALL AND EASILY MAINTAINED</strong></p>
<p>یکی دیگر از مزایای معماری <strong>microservice</strong> این است که هر <strong>service</strong> نسبتاً کوچک است. درک کد برای یک <strong>developer</strong> آسان‌تر است. <strong>code base</strong> کوچک،
   <strong>IDE</strong> را کند نمی‌کند و <strong>developers</strong> را سازنده‌تر می‌کند. و هر <strong>service</strong> معمولاً خیلی سریع‌تر از یک <strong>monolith</strong> بزرگ شروع می‌شود، که این امر نیز <strong>developers</strong> را سازنده‌تر می‌کند و سرعت استقرار را افزایش می‌دهد.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0045_original/original_page.png" alt="Original Page 45">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>16</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<p><strong>SERVICES ARE INDEPENDENTLY SCALABLE</strong></p>
<p>هر <strong>service</strong> در یک معماری <strong>microservice</strong> را می‌توان به طور مستقل از سایر
   <strong>services</strong> با استفاده از کلون‌سازی محور <strong>X</strong> و پارتیشن‌بندی محور <strong>Z</strong> مقیاس‌بندی کرد. علاوه بر این، هر <strong>service</strong> را می‌توان بر روی سخت‌افزاری مستقر کرد که برای الزامات منابع آن مناسب است. این بسیار متفاوت از زمانی است که از معماری <strong>monolithic</strong> استفاده می‌کنید، که در آن مؤلفه‌هایی با الزامات منابع بسیار متفاوت - به عنوان مثال، <strong>CPU</strong> فشرده در مقابل <strong>memory</strong> فشرده - باید با هم مستقر شوند.
  </p>
<p><strong>BETTER FAULT ISOLATION</strong></p>
<p>معماری <strong>microservice</strong> دارای جداسازی خطای بهتری است. به عنوان مثال، نشت حافظه در یک <strong>service</strong> فقط بر آن <strong>service</strong> تأثیر می‌گذارد. سایر <strong>services</strong> به طور معمول به رسیدگی به درخواست‌ها ادامه خواهند داد. در مقایسه، یک مؤلفه بد رفتار معماری <strong>monolithic</strong>، کل سیستم را از کار می‌اندازد.</p>
<p><strong>EASILY EXPERIMENT WITH AND ADOPT NEW TECHNOLOGIES</strong></p>
<p>آخرین مورد، اما نه کم‌اهمیت، معماری <strong>microservice</strong> هرگونه تعهد بلندمدت به یک <strong>technology stack</strong> را حذف می‌کند. در اصل، هنگام توسعه یک <strong>service</strong> جدید،
   <strong>developers</strong> آزاد هستند که هر زبانی را انتخاب کنند و فریم‌ورک‌هایی را انتخاب کنند که برای آن
   <strong>service</strong> مناسب هستند.
  </p>
<p>تیم‌های کوچک، مستقل،</p>
<p><strong>loosely coupled</strong></p>
<p>هر <strong>service</strong> دارد</p>
<p><strong>source</strong></p>
<p>کد</p>
<p><strong>repository</strong> خود را.</p>
<p>هر <strong>service</strong> دارد</p>
<p>خودکار</p>
<p><strong>deployment pipeline</strong></p>
<p><strong>services</strong> کوچک، ساده،</p>
<p>قابل اعتماد، آسان برای</p>
<p>حفظ</p>
<p>تیم مدیریت سفارش</p>
<p>تیم مدیریت رستوران</p>
<p>تیم مدیریت تحویل</p>
<p>توسعه <strong>FTGO</strong></p>
<p>تولید</p>
<p><strong>Jenkins Cl</strong></p>
<p><strong>Deployment pipeline</strong></p>
<p><strong>Order Service</strong></p>
<p>کد منبع</p>
<p><strong>repository</strong></p>
<p><strong>Order Service</strong></p>
<p><strong>Jenkins Cl</strong></p>
<p><strong>Deployment pipeline</strong></p>
<p>رستوران</p>
<p><strong>Service</strong></p>
<p>کد منبع</p>
<p><strong>repository</strong></p>
<p>رستوران</p>
<p><strong>Service</strong></p>
<p><strong>Jenkins Cl</strong></p>
<p><strong>Deployment pipeline</strong></p>
<p>تحویل</p>
<p><strong>Service</strong></p>
<p>کد منبع</p>
<p><strong>repository</strong></p>
<p>تحویل</p>
<p>شکل 1.8</p>
<p><strong>application</strong> مبتنی بر <strong>microservices</strong> <strong>FTGO</strong> از مجموعه‌ای از <strong>services</strong> <strong>loosely coupled</strong> تشکیل شده است. هر تیم <strong>services</strong> خود را به طور مستقل توسعه، تست و مستقر می‌کند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0046_original/original_page.png" alt="Original Page 46">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>17</p>
<p><strong>Benefits and drawbacks of the microservice architecture</strong></p>
<p>در بسیاری از سازمان‌ها، محدود کردن انتخاب‌ها منطقی است، اما نکته کلیدی این است که شما توسط تصمیمات گذشته محدود نشده‌اید.
  </p>
<p>
   علاوه بر این، از آنجایی که <strong>services</strong> کوچک هستند، بازنویسی آن‌ها با استفاده از زبان‌ها و فناوری‌های بهتر عملی می‌شود. اگر آزمایش یک فناوری جدید شکست بخورد، می‌توانید آن کار را بدون به خطر انداختن کل پروژه دور بریزید. این کاملاً متفاوت از زمانی است که از معماری <strong>monolithic</strong> استفاده می‌کنید، که در آن انتخاب‌های فناوری اولیه شما، توانایی شما را برای استفاده از زبان‌ها و فریم‌ورک‌های مختلف در آینده به شدت محدود می‌کند.
  </p>
<p>1.5.2</p>
<p><strong>Drawbacks of the microservice architecture</strong></p>
<p>مطمئناً، هیچ فناوری گلوله نقره‌ای نیست و معماری <strong>microservice</strong> دارای تعدادی معایب و مشکلات مهم است. در واقع بیشتر این کتاب در مورد چگونگی پرداختن به این معایب و مسائل است. همانطور که در مورد چالش‌ها می‌خوانید، نگران نباشید. در ادامه این کتاب راه‌هایی برای رسیدگی به آن‌ها شرح می‌دهم.</p>
<p>در اینجا معایب و مشکلات اصلی معماری <strong>microservice</strong> آمده است:</p>
<ul>
<li>
    یافتن مجموعه مناسبی از <strong>services</strong> یک چالش است.
   </li>
<li>
    سیستم‌های توزیع شده پیچیده هستند، که توسعه، تست و استقرار را دشوار می‌کند.
   </li>
<li>
    استقرار ویژگی‌هایی که چندین <strong>service</strong> را در بر می‌گیرند، به هماهنگی دقیق نیاز دارد.
   </li>
<li>
    تصمیم‌گیری در مورد زمان اتخاذ معماری <strong>microservice</strong> دشوار است.
   </li>
</ul>
<p>بیایید به نوبه خود به هر یک نگاهی بیندازیم.</p>
<p><strong>FINDING THE RIGHT SERVICES IS CHALLENGING</strong></p>
<p>یک چالش در استفاده از معماری <strong>microservice</strong> این است که هیچ الگوریتم مشخص و خوش‌تعریفی برای تجزیه یک سیستم به <strong>services</strong> وجود ندارد. مانند بسیاری از توسعه <strong>software</strong>، این تا حدودی یک هنر است. برای بدتر کردن اوضاع، اگر یک سیستم را به اشتباه تجزیه کنید، یک <strong>monolith</strong> توزیع شده می‌سازید، سیستمی متشکل از <strong>services</strong> <strong>coupled</strong> که باید با هم مستقر شوند. یک <strong>monolith</strong> توزیع شده دارای معایب معماری <strong>monolithic</strong> و معماری <strong>microservice</strong> است.</p>
<p><strong>DISTRIBUTED SYSTEMS ARE COMPLEX</strong></p>
<p>یکی دیگر از مسائل مربوط به استفاده از معماری <strong>microservice</strong> این است که
   <strong>developers</strong> باید با پیچیدگی‌های اضافی ایجاد یک سیستم توزیع شده مقابله کنند. <strong>Services</strong> باید از یک مکانیزم ارتباط بین فرآیندی استفاده کنند. این پیچیده‌تر از یک فراخوانی متد ساده است. علاوه بر این، یک <strong>service</strong> باید طوری طراحی شود که از خرابی جزئی استفاده کند و با <strong>service</strong> از راه دور که یا در دسترس نیست یا تاخیر بالایی دارد، مقابله کند.</p>
<p>
   پیاده‌سازی موارد استفاده که <strong>services</strong> متعددی را در بر می‌گیرند، نیازمند استفاده از تکنیک‌های ناآشنا است. هر <strong>service</strong> پایگاه داده خود را دارد، که پیاده‌سازی <strong>transactions</strong> و <strong>queries</strong> را که <strong>services</strong> را پوشش می‌دهند، به یک چالش تبدیل می‌کند. همانطور که در فصل 4 توضیح داده شد، یک <strong>application</strong> مبتنی بر
   <strong>microservices</strong> باید از آنچه به عنوان <strong>sagas</strong> شناخته می‌شود برای حفظ سازگاری داده‌ها در <strong>services</strong> استفاده کند. فصل 7 توضیح می‌دهد که یک <strong>application</strong> مبتنی بر <strong>microservices</strong> نمی‌تواند داده‌ها را از چندین <strong>service</strong> با استفاده از <strong>queries</strong> ساده بازیابی کند. در عوض، باید <strong>queries</strong> را با استفاده از ترکیب <strong>API</strong> یا
   <strong>CQRS views</strong> پیاده‌سازی کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0047_original/original_page.png" alt="Original Page 47">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>18</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<p><strong>IDEs</strong> و سایر ابزارهای توسعه بر ساخت <strong>applications monolithic</strong> متمرکز شده‌اند و پشتیبانی صریحی برای توسعه <strong>applications</strong> توزیع شده ارائه نمی‌دهند. نوشتن تست‌های خودکار که شامل <strong>services</strong> متعدد می‌شود، یک چالش است. این‌ها همه مسائلی هستند که مختص معماری <strong>microservice</strong> هستند. در نتیجه، <strong>developers</strong> سازمان شما باید مهارت‌های پیچیده توسعه و تحویل <strong>software</strong> را داشته باشند تا بتوانند با موفقیت از <strong>microservices</strong> استفاده کنند.</p>
<p>
   معماری <strong>microservice</strong> همچنین پیچیدگی عملیاتی قابل توجهی را معرفی می‌کند. قطعات متحرک بسیار بیشتری - نمونه‌های متعددی از انواع مختلف <strong>service</strong> - باید در تولید مدیریت شوند. برای استقرار موفقیت‌آمیز <strong>microservices</strong>، به سطح بالایی از اتوماسیون نیاز دارید. شما باید از فناوری‌هایی مانند موارد زیر استفاده کنید:
  </p>
<ul>
<li>
    ابزارهای استقرار خودکار، مانند <strong>Netflix Spinnaker</strong>
</li>
<li>
    یک <strong>PaaS</strong> آماده، مانند
    <strong>Pivotal Cloud Foundry</strong> یا
    <strong>Red Hat OpenShift</strong>
</li>
<li>
    یک پلتفرم <strong>Docker orchestration</strong>، مانند <strong>Docker Swarm</strong> یا <strong>Kubernetes</strong>
</li>
</ul>
<p>گزینه‌های استقرار را با جزئیات بیشتری در فصل 12 شرح می‌دهم.</p>
<p><strong>DEPLOYING FEATURES SPANNING MULTIPLE SERVICES NEEDS CAREFUL COORDINATION</strong></p>
<p>چالش دیگر در استفاده از معماری <strong>microservice</strong> این است که استقرار ویژگی‌هایی که چندین <strong>service</strong> را در بر می‌گیرند، به هماهنگی دقیق بین تیم‌های توسعه مختلف نیاز دارد. شما باید یک برنامه راه‌اندازی ایجاد کنید که استقرار <strong>service</strong> را بر اساس وابستگی‌های بین <strong>services</strong> سفارش دهد. این کاملاً متفاوت از معماری <strong>monolithic</strong> است، جایی که می‌توانید به راحتی به‌روزرسانی‌ها را به مؤلفه‌های متعدد به‌طور اتمی مستقر کنید.</p>
<p><strong>DECIDING WHEN TO ADOPT IS DIFFICULT</strong></p>
<p>مسئله دیگر در استفاده از معماری <strong>microservice</strong> این است که در چه مرحله‌ای از چرخه عمر <strong>application</strong> باید از این معماری استفاده کنید. هنگام توسعه اولین نسخه از یک <strong>application</strong>، اغلب مشکلاتی را که این معماری حل می‌کند، ندارید. علاوه بر این، استفاده از یک معماری پیچیده و توزیع شده، توسعه را کند می‌کند. این می‌تواند یک معضل بزرگ برای استارتاپ‌ها باشد، جایی که بزرگترین مشکل معمولاً این است که چگونه مدل کسب‌وکار و <strong>application</strong> همراه را به سرعت تکامل دهیم.</p>
<p>
   استفاده از معماری <strong>microservice</strong>، تکرار سریع را بسیار دشوارتر می‌کند. یک استارتاپ تقریباً مطمئناً باید با یک <strong>application monolithic</strong> شروع کند.
  </p>
<p>
   اما بعداً، زمانی که مشکل چگونگی رسیدگی به پیچیدگی است، در این زمان منطقی است که <strong>application</strong> را از نظر عملکردی به مجموعه‌ای از
   <strong>microservices</strong> تجزیه کنید. ممکن است <strong>refactoring</strong> را به دلیل وابستگی‌های درهم دشوار بدانید. فصل 13 استراتژی‌هایی را برای <strong>refactoring</strong> یک <strong>application monolithic</strong> به <strong>microservices</strong> بررسی می‌کند.
  </p>
<p>
   همانطور که می‌بینید، معماری <strong>microservice</strong> مزایای زیادی را ارائه می‌دهد، اما دارای معایب قابل توجهی نیز است. به دلیل این مسائل، اتخاذ معماری
   <strong>microservice</strong> نباید با بی‌توجهی انجام شود. اما برای <strong>applications</strong> پیچیده، مانند یک <strong>application web</strong> رو به مصرف‌کننده یا <strong>application SaaS</strong>، معمولاً انتخاب درستی است. سایت‌های شناخته شده‌ای مانند <strong>eBay</strong> (www.slideshare.net/RandyShoup/the-ebay-architecture-striking-a-balance-between-site-stability-feature-velocity-performance-and-cost)،
   <strong>Amazon.com</strong>، <strong>Groupon</strong> و
   <strong>Gilt</strong> همگی از یک معماری <strong>monolithic</strong> به معماری <strong>microservice</strong> تکامل یافته‌اند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0048_original/original_page.png" alt="Original Page 48">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>19</p>
<p><strong>The Microservice architecture pattern language</strong></p>
<p>هنگام استفاده از معماری <strong>microservice</strong> باید به مسائل طراحی و معماری متعددی رسیدگی کنید.
   علاوه بر این، بسیاری از این مسائل راه‌حل‌های متعددی دارند که هر کدام مجموعه‌ای متفاوت از
   <strong>trade-offs</strong> دارند. هیچ راه‌حل واحد و کاملی وجود ندارد. برای کمک به هدایت تصمیم‌گیری شما، من زبان <strong>pattern</strong> معماری <strong>Microservice</strong> را ایجاد کرده‌ام. من در طول بقیه کتاب به این زبان <strong>pattern</strong> استناد می‌کنم، همانطور که شما را در مورد معماری <strong>microservice</strong> آموزش می‌دهم. بیایید نگاهی بیندازیم که یک زبان <strong>pattern</strong> چیست و چرا مفید است.
  </p>
<p>1.6</p>
<p><strong>The Microservice architecture pattern language</strong></p>
<p>معماری و طراحی همه در مورد تصمیم‌گیری است. شما باید تصمیم بگیرید که آیا معماری <strong>monolithic</strong> یا <strong>microservice</strong> بهترین گزینه برای <strong>application</strong> شما است. هنگام اتخاذ این تصمیمات، باید <strong>trade-offs</strong> زیادی را در نظر بگیرید. اگر معماری
   <strong>microservice</strong> را انتخاب کنید، باید به مسائل زیادی رسیدگی کنید.
  </p>
<p>یک راه خوب برای توصیف گزینه‌های مختلف معماری و طراحی و بهبود تصمیم‌گیری، استفاده از یک زبان <strong>pattern</strong> است. بیایید ابتدا نگاهی بیندازیم که چرا به الگوها و یک زبان <strong>pattern</strong> نیاز داریم و سپس نگاهی به زبان <strong>pattern</strong> معماری <strong>Microservice</strong> خواهیم داشت.</p>
<p>1.6.1</p>
<p><strong>Microservice architecture is not a silver bullet</strong></p>
<p>در سال 1986، فرد بروکس، نویسنده
   <strong>The Mythical Man-Month (Addison-Wesley Professional, 1995)</strong>، گفت که در مهندسی <strong>software</strong>، هیچ گلوله نقره‌ای وجود ندارد. این بدان معناست که هیچ تکنیک یا فناوری وجود ندارد که در صورت اتخاذ، ده برابر باعث افزایش بهره‌وری شما شود. با این حال، دهه‌ها بعد، <strong>developers</strong> همچنان با اشتیاق در مورد گلوله‌های نقره‌ای مورد علاقه خود بحث می‌کنند، کاملاً متقاعد شده‌اند که فناوری مورد علاقه آن‌ها باعث افزایش عظیم بهره‌وری آن‌ها می‌شود.
  </p>
<p>بسیاری از بحث‌ها از <strong>suck/rock dichotomy</strong> (http://nealford.com/memeagora/2009/08/05/suck-rock-dichotomy.html) پیروی می‌کنند، اصطلاحی که توسط نیل فورد ابداع شده است و چگونگی هر چیزی را در دنیای
   <strong>software</strong> توصیف می‌کند که یا زشت است یا می‌درخشد، بدون هیچ حد وسطی. این بحث‌ها این ساختار را دارند: اگر
   <strong>X</strong> را انجام دهید، یک توله سگ می‌میرد، بنابراین شما باید <strong>Y</strong> را انجام دهید. به عنوان مثال، برنامه‌نویسی همزمان در مقابل واکنشی، شی گرا در مقابل عملکردی، <strong>Java</strong> در مقابل <strong>JavaScript</strong>، <strong>REST</strong> در مقابل پیام‌رسانی. البته، واقعیت بسیار ظریف‌تر است. هر فناوری دارای معایب و محدودیت‌هایی است که اغلب توسط طرفداران آن نادیده گرفته می‌شود. در نتیجه، اتخاذ یک فناوری معمولاً از چرخه تبلیغاتی <strong>Gartner</strong> (https://en.wikipedia.org/wiki/Hype_cycle) پیروی می‌کند، که در آن یک فناوری نوظهور از پنج مرحله عبور می‌کند، از جمله اوج انتظارات تورمی (می‌درخشد)، به دنبال آن فرورفتگی ناامیدی (زشت) و پایان یافتن به فلات بهره‌وری (اکنون ما <strong>trade-offs</strong> را درک می‌کنیم و چه زمانی از آن استفاده کنیم).</p>
<p><strong>Microservices</strong> از پدیده گلوله نقره‌ای مصون نیستند. اینکه آیا این معماری برای <strong>application</strong> شما مناسب است یا خیر، به عوامل زیادی بستگی دارد. در نتیجه، توصیه بد این است که همیشه از معماری <strong>microservice</strong> استفاده کنید، اما توصیه بد این است که هرگز از آن استفاده نکنید. مانند بسیاری از موارد، این بستگی دارد.</p>
<p>دلیل اصلی این بحث‌های قطبی شده و پرهیاهو در مورد فناوری این است که انسان‌ها در درجه اول تحت تأثیر احساسات خود قرار دارند. جاناتان هایدت، در اثر عالی خود</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0049_original/original_page.png" alt="Original Page 49">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>20</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<p>کتاب
   <strong>The Righteous Mind: Why Good People Are Divided by Politics and Religion (Vintage, 2013)</strong>، از استعاره یک فیل و سوارکارش برای توصیف چگونگی عملکرد ذهن انسان استفاده می‌کند. فیل نشان‌دهنده قسمت احساسی مغز انسان است. این فیل اکثر تصمیمات را می‌گیرد. سوارکار نشان‌دهنده بخش منطقی مغز است. این سوارکار گاهی اوقات می‌تواند بر فیل تأثیر بگذارد، اما بیشتر توجیهاتی را برای تصمیمات فیل ارائه می‌دهد.
  </p>
<p>
   ما - جامعه توسعه <strong>software</strong> - باید بر طبیعت احساسی خود غلبه کنیم و راه بهتری برای بحث و اعمال فناوری پیدا کنیم. یک راه عالی برای بحث و توصیف فناوری، استفاده از فرمت <strong>pattern</strong> است، زیرا عینی است. به عنوان مثال، هنگام توصیف یک فناوری در قالب
   <strong>pattern</strong>، باید معایب را توصیف کنید. بیایید نگاهی به قالب <strong>pattern</strong> بیندازیم.
  </p>
<p>1.6.2</p>
<p><strong>Patterns and pattern languages</strong></p>
<p>یک <strong>pattern</strong> یک راه‌حل قابل استفاده مجدد برای یک مشکل است که در یک زمینه خاص رخ می‌دهد. این ایده‌ای است که منشأ آن در معماری دنیای واقعی است و ثابت شده است که در معماری و طراحی <strong>software</strong> مفید است. مفهوم یک <strong>pattern</strong> توسط
   <strong>Christopher Alexander</strong>، یک معمار دنیای واقعی، ایجاد شد. او همچنین مفهوم یک زبان <strong>pattern</strong>، مجموعه‌ای از الگوهای مرتبط که مشکلات را در یک دامنه خاص حل می‌کنند، ایجاد کرد. کتاب او
   <strong>A Pattern Language: Towns, Buildings, Construction (Oxford University Press, 1977)</strong> یک زبان <strong>pattern</strong> برای معماری را توصیف می‌کند که از 253 <strong>pattern</strong> تشکیل شده است. الگوها از راه‌حل‌هایی برای مشکلات سطح بالا، مانند مکان قرارگیری یک شهر (”دسترسی به آب”)، تا مشکلات سطح پایین، مانند نحوه طراحی یک اتاق (”نور در دو طرف هر اتاق”) متغیر هستند. هر یک از این الگوها یک مشکل را با چیدمان اشیاء فیزیکی که دامنه آن‌ها از شهرها تا پنجره‌ها متغیر است، حل می‌کند.
  </p>
<p>نوشته‌های
   <strong>Christopher Alexander</strong>، جامعه <strong>software</strong> را برانگیخت تا مفهوم الگوها و زبان‌های <strong>pattern</strong> را اتخاذ کنند. کتاب <strong>Design Patterns: Elements of Reusable Object-Oriented Software (Addison-Wesley Professional, 1994)</strong>، توسط
   <strong>Erich Gamma, Richard Helm, Ralph Johnson, and John Vlissides</strong> مجموعه‌ای از الگوهای طراحی شی گرا است. این کتاب الگوها را در بین <strong>developers software</strong> محبوب کرد. از اواسط دهه 1990، <strong>developers software</strong> الگوهای <strong>software</strong> متعددی را مستند کرده‌اند. یک <strong>pattern software</strong>، یک معماری یا مشکل طراحی <strong>software</strong> را با تعریف مجموعه‌ای از عناصر <strong>software</strong> در حال همکاری حل می‌کند.
  </p>
<p>به عنوان مثال، بیایید تصور کنیم که شما در حال ساخت یک <strong>application</strong> بانکی هستید که باید از انواع سیاست‌های <strong>overdraft</strong> پشتیبانی کند. هر سیاست محدودیت‌هایی را در مورد موجودی حساب و هزینه‌های دریافتی برای یک حساب <strong>overdrawn</strong> تعریف می‌کند. شما می‌توانید این مشکل را با استفاده از الگوی
   <strong>Strategy</strong>، که یک <strong>pattern</strong> شناخته شده از کتاب کلاسیک <strong>Design Patterns</strong> است، حل کنید. راه‌حل تعریف شده توسط الگوی
   <strong>Strategy</strong> از سه بخش تشکیل شده است:</p>
<ul>
<li>یک رابط استراتژی به نام
    <strong>Overdraft</strong> که الگوریتم <strong>overdraft</strong> را کپسوله می‌کند
   </li>
<li>یک یا چند کلاس استراتژی بتنی، یکی برای هر زمینه خاص</li>
<li>کلاس <strong>Account</strong> که از الگوریتم استفاده می‌کند</li>
</ul>
<p>الگوی
   <strong>Strategy</strong> یک الگوی طراحی شی گرا است، بنابراین عناصر راه‌حل کلاس هستند. در ادامه این بخش، الگوهای طراحی سطح بالا را شرح می‌دهم، که در آن راه‌حل از <strong>services</strong> در حال همکاری تشکیل شده است.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0050_original/original_page.png" alt="Original Page 50">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>21</p>
<p><strong>The Microservice architecture pattern language</strong></p>
<p>یک دلیل ارزشمند بودن <strong>patterns</strong> این است که یک <strong>pattern</strong> باید زمینه‌ای را که در آن اعمال می‌شود، توصیف کند. این ایده که یک راه‌حل مختص یک زمینه خاص است و ممکن است در زمینه‌های دیگر خوب عمل نکند، پیشرفتی نسبت به نحوه بحث معمول فناوری دارد. به عنوان مثال، یک راه‌حل که مشکل را در مقیاس
   <strong>Netflix</strong> حل می‌کند، ممکن است بهترین رویکرد برای یک <strong>application</strong> با کاربران کمتر نباشد.
  </p>
<p>با این حال، ارزش یک <strong>pattern</strong>، فراتر از این است که شما را ملزم به در نظر گرفتن زمینه یک مشکل کند. این شما را مجبور می‌کند که جنبه‌های حیاتی دیگر، اما اغلب نادیده گرفته شده، از یک راه‌حل را توصیف کنید. یک ساختار <strong>pattern</strong> که معمولاً استفاده می‌شود شامل سه بخش ارزشمند است:</p>
<ul>
<li>نیروها</li>
<li>زمینه نتیجه</li>
<li>الگوهای مرتبط</li>
</ul>
<p>بیایید به هر یک از این موارد، با شروع از نیروها، نگاهی بیندازیم.</p>
<p><strong>FORCES: THE ISSUES THAT YOU MUST ADDRESS WHEN SOLVING A PROBLEM</strong></p>
<p>بخش نیروهای یک <strong>pattern</strong>، نیروها (مسائل) را توصیف می‌کند که هنگام حل یک مشکل در یک زمینه معین باید به آن‌ها رسیدگی کنید. نیروها می‌توانند با هم تضاد داشته باشند، بنابراین ممکن است نتوانید همه آن‌ها را حل کنید. اینکه کدام نیروها مهم‌تر هستند به زمینه بستگی دارد. شما باید اولویت‌بندی کنید که برخی از نیروها را نسبت به دیگران حل کنید. به عنوان مثال، کد باید به راحتی قابل درک باشد و عملکرد خوبی داشته باشد. کدی که به سبک واکنشی نوشته شده است عملکرد بهتری نسبت به کد همزمان دارد، اما اغلب درک آن دشوارتر است. فهرست کردن صریح نیروها مفید است زیرا مشخص می‌کند که کدام مسائل باید حل شوند.</p>
<p><strong>RESULTING CONTEXT: THE CONSEQUENCES OF APPLYING A PATTERN</strong></p>
<p>بخش زمینه حاصل یک <strong>pattern</strong>، عواقب اعمال <strong>pattern</strong> را توصیف می‌کند. این شامل سه قسمت است:</p>
<ul>
<li>مزایا - مزایای <strong>pattern</strong>، از جمله نیروهایی که حل شده‌اند</li>
<li>معایب - معایب <strong>pattern</strong>، از جمله نیروهای حل نشده</li>
<li>مسائل - مشکلات جدیدی که با اعمال <strong>pattern</strong> معرفی شده‌اند</li>
</ul>
<p>زمینه حاصل، دیدگاهی کامل‌تر و کم‌طرفدارانه از راه‌حل ارائه می‌دهد که امکان تصمیم‌گیری بهتر در طراحی را فراهم می‌کند.</p>
<p><strong>RELATED PATTERNS: THE FIVE DIFFERENT TYPES OF RELATIONSHIPS</strong></p>
<p>بخش الگوهای مرتبط یک <strong>pattern</strong>، رابطه بین <strong>pattern</strong> و سایر الگوها را توصیف می‌کند. پنج نوع رابطه بین الگوها وجود دارد:</p>
<ul>
<li>
    پیشینی - یک الگوی پیشینی، الگویی است که نیاز به این <strong>pattern</strong> را ایجاد می‌کند. به عنوان مثال، الگوی معماری <strong>Microservice</strong>، پیشینی سایر الگوها در زبان <strong>pattern</strong>، به جز الگوی معماری <strong>monolithic</strong> است.
   </li>
<li>
    جانشین - الگویی که مشکلی را که توسط این <strong>pattern</strong> معرفی شده است، حل می‌کند. به عنوان مثال، اگر الگوی معماری <strong>Microservice</strong> را اعمال کنید، باید
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0051_original/original_page.png" alt="Original Page 51">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>22</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<p>سپس الگوهای جانشین متعددی را اعمال می‌کنید، از جمله الگوهای کشف <strong>service</strong> و الگوی
   <strong>Circuit breaker</strong>.
  </p>
<ul>
<li>جایگزین - الگویی که یک راه‌حل جایگزین برای این <strong>pattern</strong> ارائه می‌دهد. به عنوان مثال، الگوی معماری
    <strong>Monolithic</strong> و الگوی معماری <strong>Microservice</strong> راه‌های جایگزینی برای معماری یک <strong>application</strong> هستند. شما یکی یا دیگری را انتخاب می‌کنید.
   </li>
<li>
    تعمیم - الگویی که یک راه‌حل کلی برای یک مشکل است. به عنوان مثال، در فصل 12 در مورد پیاده‌سازی‌های مختلف الگوی <strong>Single service per host</strong> یاد خواهید گرفت.
   </li>
<li>
    تخصص - یک فرم تخصصی از یک <strong>pattern</strong> خاص. به عنوان مثال، در فصل 12 یاد خواهید گرفت که الگوی
    <strong>Deploy a service as a container</strong> یک تخصص از
    <strong>Single service per host</strong> است.
   </li>
</ul>
<p>علاوه بر این، می‌توانید الگوهایی را که به مسائل در یک زمینه مشکل خاص می‌پردازند، در گروه‌ها سازماندهی کنید. توصیف صریح الگوهای مرتبط، راهنمایی‌های ارزشمندی را در مورد چگونگی حل مؤثر یک مشکل خاص ارائه می‌دهد. شکل 1.9 نحوه نمایش بصری روابط بین الگوها را نشان می‌دهد.</p>
<p>انواع مختلف روابط بین الگوها که در شکل 1.9 نشان داده شده است، به صورت زیر نشان داده می‌شود:</p>
<ul>
<li>نماینده رابطه پیشینی-جانشین</li>
<li>الگوهایی که راه‌حل‌های جایگزین برای یک مشکل هستند</li>
<li>نشان می‌دهد که یک <strong>pattern</strong> یک تخصص از یک <strong>pattern</strong> دیگر است</li>
<li>الگوهایی که برای یک حوزه مشکل خاص اعمال می‌شوند</li>
</ul>
<p><strong>Pattern</strong></p>
<p>حوزه مشکل</p>
<p>استقرار</p>
<p>معماری <strong>Monolithic</strong></p>
<p>کلید</p>
<p>معماری <strong>Microservice</strong></p>
<p>یک <strong>service</strong> واحد</p>
<p>در هر میزبان</p>
<p><strong>Service-per-container</strong></p>
<p>عمومی</p>
<p>جایگزین <strong>A</strong></p>
<p>پیشینی</p>
<p>خاص</p>
<p>جایگزین <strong>B</strong></p>
<p>جانشین</p>
<p>شکل 1.9</p>
<p>نمایش بصری انواع مختلف روابط بین الگوها: یک الگوی جانشین، مشکلی را که با اعمال الگوی پیشینی ایجاد شده است، حل می‌کند. دو یا چند الگو می‌توانند راه‌حل‌های جایگزینی برای یک مشکل باشند. یک <strong>pattern</strong> می‌تواند یک تخصص از یک <strong>pattern</strong> دیگر باشد. و الگوهایی که مشکلات را در یک زمینه حل می‌کنند، می‌توانند گروه‌بندی یا تعمیم داده شوند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0052_original/original_page.png" alt="Original Page 52">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>23</p>
<p><strong>The Microservice architecture pattern language</strong></p>
<p>مجموعه‌ای از الگوهای مرتبط از طریق این روابط، گاهی اوقات آنچه را که به عنوان یک زبان <strong>pattern</strong> شناخته می‌شود، تشکیل می‌دهند. الگوهای موجود در یک زبان <strong>pattern</strong> با هم کار می‌کنند تا مشکلات را در یک دامنه خاص حل کنند. به طور خاص، من زبان <strong>pattern</strong> معماری <strong>Microservice</strong> را ایجاد کرده‌ام. این مجموعه‌ای از معماری <strong>software</strong> و الگوهای طراحی به هم پیوسته برای <strong>microservices</strong> است. بیایید نگاهی به این زبان <strong>pattern</strong> بیندازیم.</p>
<p>1.6.3</p>
<p><strong>Overview of the Microservice architecture pattern language</strong></p>
<p>زبان <strong>pattern</strong> معماری <strong>Microservice</strong> مجموعه‌ای از الگوها است که به شما کمک می‌کند تا یک <strong>application</strong> را با استفاده از معماری <strong>microservice</strong> معماری کنید. شکل 1.10 ساختار سطح بالای زبان <strong>pattern</strong> را نشان می‌دهد. زبان <strong>pattern</strong> ابتدا به شما کمک می‌کند تا تصمیم بگیرید که آیا از معماری
   <strong>microservice</strong> استفاده کنید یا خیر. این معماری <strong>monolithic</strong> و معماری <strong>microservice</strong> را به همراه مزایا و معایب آن‌ها توصیف می‌کند. سپس، اگر معماری <strong>microservice</strong> برای <strong>application</strong> شما مناسب است، زبان <strong>pattern</strong> به شما کمک می‌کند تا با حل مسائل مختلف معماری و طراحی از آن به طور مؤثر استفاده کنید.
  </p>
<p>زبان <strong>pattern</strong> شامل چندین گروه از الگوها است. در سمت چپ در شکل 1.10 گروه الگوهای معماری <strong>application</strong>، الگوی معماری <strong>Monolithic</strong> و الگوی معماری <strong>Microservice</strong> قرار دارد. این‌ها الگوهایی هستند که ما در مورد آن‌ها بحث کرده‌ایم.</p>
<p>عمومی</p>
<p>جایگزین <strong>A</strong></p>
<p>پیشینی</p>
<p>خاص</p>
<p>جایگزین <strong>B</strong></p>
<p>جانشین</p>
<p>تجزیه</p>
<p>الگوهای زیرساخت <strong>Application</strong></p>
<p>الگوهای ارتباطی</p>
<p>الگوهای زیرساخت</p>
<p>الگوهای <strong>Microservice</strong></p>
<p>معماری <strong>Application</strong></p>
<p>الگوهای <strong>Application</strong></p>
<p>تست</p>
<p>قابلیت مشاهده</p>
<p>حفظ</p>
<p>یکپارچگی داده</p>
<p>معماری پایگاه داده</p>
<p>کلید</p>
<p>پرس و جو</p>
<p>امنیت</p>
<p>مشکلات متقاطع</p>
<p>قابلیت اطمینان</p>
<p>خارجی</p>
<p><strong>API</strong></p>
<p>سبک ارتباطی</p>
<p>کشف</p>
<p>پیام‌رسانی تراکنشی</p>
<p>حوزه مشکل</p>
<p>استقرار</p>
<p>معماری <strong>Monolithic</strong></p>
<p>معماری <strong>Microservice</strong></p>
<p>شکل 1.10</p>
<p>یک نمای سطح بالا از زبان <strong>pattern</strong> معماری <strong>Microservice</strong> که مناطق مختلف مشکلی را که الگوها حل می‌کنند، نشان می‌دهد. در سمت چپ الگوهای معماری <strong>application</strong> قرار دارند: معماری <strong>Monolithic</strong> و معماری <strong>Microservice</strong>. تمام گروه‌های دیگر الگوها مشکلاتی را حل می‌کنند که از انتخاب الگوی معماری <strong>Microservice</strong> ناشی می‌شود.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0053_original/original_page.png" alt="Original Page 53">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>24</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<p>در این فصل. بقیه زبان <strong>pattern</strong> شامل گروه‌هایی از الگوها است که راه‌حل‌هایی برای مسائلی هستند که با استفاده از الگوی معماری <strong>Microservice</strong> معرفی شده‌اند.
  </p>
<p>الگوها نیز به سه لایه تقسیم می‌شوند:</p>
<ul>
<li>
    الگوهای زیرساختی - این‌ها مشکلاتی را حل می‌کنند که بیشتر مسائل زیرساختی در خارج از توسعه هستند.
   </li>
<li>
    زیرساخت <strong>Application</strong> - اینها برای مسائل زیرساختی هستند که بر توسعه نیز تأثیر می‌گذارند.
   </li>
<li>الگوهای <strong>Application</strong> - این‌ها مشکلاتی را حل می‌کنند که <strong>developers</strong> با آن مواجه هستند.</li>
</ul>
<p>این الگوها بر اساس نوع مشکلی که حل می‌کنند، با هم گروه‌بندی شده‌اند. بیایید به گروه‌های اصلی الگوها نگاهی بیندازیم.</p>
<p><strong>PATTERNS FOR DECOMPOSING AN APPLICATION INTO SERVICES</strong></p>
<p>تصمیم‌گیری در مورد چگونگی تجزیه یک سیستم به مجموعه‌ای از <strong>services</strong>، یک هنر است، اما تعدادی استراتژی وجود دارد که می‌تواند کمک کند. دو الگوی تجزیه نشان داده شده در شکل 1.11 استراتژی‌های متفاوتی هستند که می‌توانید برای تعریف معماری
   <strong>application</strong> خود استفاده کنید.
  </p>
<p>فصل 2 این الگوها را با جزئیات شرح می‌دهد.</p>
<p><strong>COMMUNICATION PATTERNS</strong></p>
<p>یک <strong>application</strong> که با استفاده از معماری <strong>microservice</strong> ساخته شده است، یک سیستم توزیع شده است. در نتیجه، ارتباط بین فرآیندی (<strong>IPC</strong>) بخش مهمی از معماری
   <strong>microservice</strong> است. شما باید تصمیمات مختلف معماری و طراحی را در مورد نحوه ارتباط <strong>services</strong> خود با یکدیگر و دنیای بیرون اتخاذ کنید. شکل 1.12 الگوهای ارتباطی را نشان می‌دهد، که به پنج گروه سازماندهی شده‌اند:</p>
<ul>
<li>سبک ارتباط - از چه نوع مکانیزم <strong>IPC</strong> باید استفاده کنید؟</li>
<li>کشف - چگونه یک <strong>client</strong> یک <strong>service</strong> آدرس <strong>IP</strong> یک نمونه <strong>service</strong> را تعیین می‌کند تا، به عنوان مثال، یک درخواست <strong>HTTP</strong> را انجام دهد؟</li>
<li>قابلیت اطمینان - چگونه می‌توانید اطمینان حاصل کنید که ارتباط بین <strong>services</strong> قابل اعتماد است، حتی اگر <strong>services</strong> در دسترس نباشند؟</li>
<li>پیام‌رسانی تراکنشی - چگونه باید ارسال پیام‌ها و انتشار رویدادها را با <strong>database transactions</strong> که داده‌های تجاری را به‌روز می‌کنند، ادغام کنید؟</li>
<li>
<strong>API</strong> خارجی - چگونه <strong>clients</strong> <strong>application</strong> شما با <strong>services</strong> ارتباط برقرار می‌کنند؟
   </li>
</ul>
<p>تجزیه بر اساس</p>
<p>قابلیت کسب و کار</p>
<p>تجزیه بر اساس</p>
<p>زیر دامنه</p>
<p>عمومی</p>
<p>جایگزین <strong>A</strong></p>
<p>پیشینی</p>
<p>خاص</p>
<p>جایگزین <strong>B</strong></p>
<p>جانشین</p>
<p>کلید</p>
<p>حوزه مشکل</p>
<p>شکل 1.11</p>
<p>دو الگوی تجزیه وجود دارد: تجزیه بر اساس قابلیت‌های تجاری، که <strong>services</strong> را حول قابلیت‌های تجاری سازماندهی می‌کند، و تجزیه بر اساس زیردامنه، که <strong>services</strong> را حول زیر دامنه‌های طراحی مبتنی بر دامنه (<strong>DDD</strong>) سازماندهی می‌کند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0054_original/original_page.png" alt="Original Page 54">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>25</p>
<p><strong>The Microservice architecture pattern language</strong></p>
<p>فصل 3 به چهار گروه اول الگوها می‌پردازد: سبک ارتباط، کشف، قابلیت اطمینان و پیام‌رسانی تراکنشی. فصل 8 به الگوهای <strong>API</strong> خارجی می‌پردازد.
  </p>
<p><strong>DATA CONSISTENCY PATTERNS FOR IMPLEMENTING TRANSACTION MANAGEMENT</strong></p>
<p>همانطور که قبلاً ذکر شد، برای اطمینان از
   <strong>loose coupling</strong>، هر <strong>service</strong> پایگاه داده خود را دارد. متأسفانه، داشتن یک پایگاه داده در هر <strong>service</strong>، برخی از مسائل مهم را معرفی می‌کند. من در فصل 4 شرح می‌دهم که رویکرد سنتی استفاده از <strong>transactions</strong> توزیع شده (<strong>2PC</strong>) یک گزینه مناسب برای یک <strong>application</strong> مدرن نیست. در عوض، یک <strong>application</strong> باید با استفاده از الگوی <strong>Saga</strong>، سازگاری داده‌ها را حفظ کند. شکل 1.13 الگوهای مرتبط با داده را نشان می‌دهد.
  </p>
<p>فصل‌های 4، 5 و 6 این الگوها را با جزئیات بیشتری شرح می‌دهند.</p>
<p><strong>PATTERNS FOR QUERYING DATA IN A MICROSERVICE ARCHITECTURE</strong></p>
<p>مسئله دیگر در مورد استفاده از یک پایگاه داده در هر <strong>service</strong> این است که برخی از <strong>queries</strong> نیاز به پیوستن به داده‌هایی دارند که متعلق به <strong>services</strong> متعدد هستند. داده‌های یک <strong>service</strong> فقط از طریق <strong>API</strong> آن قابل دسترسی هستند، بنابراین شما نمی‌توانید از <strong>queries</strong> توزیع شده در برابر پایگاه داده آن استفاده کنید. شکل 1.14 چند الگویی را نشان می‌دهد که می‌توانید برای پیاده‌سازی <strong>queries</strong> استفاده کنید.</p>
<p><strong>Polling</strong></p>
<p>ناشر</p>
<p>تراکنش</p>
<p>دنباله <strong>log</strong></p>
<p>پیام‌رسانی تراکنشی</p>
<p>خروجی تراکنشی</p>
<p>پیام‌رسانی</p>
<p>فراخوانی <strong>procedure</strong> از راه دور</p>
<p><strong>Circuit</strong></p>
<p><strong>breaker</strong></p>
<p>سبک ارتباطی</p>
<p>قابلیت اطمینان</p>
<p>مخصوص دامنه</p>
<p>ثبت‌نام خودکار</p>
<p>کشف در سمت <strong>Client</strong></p>
<p>کشف</p>
<p><strong>API</strong> خارجی</p>
<p>ثبت‌نام شخص ثالث</p>
<p><strong>API gateway</strong></p>
<p><strong>Backend</strong> برای</p>
<p><strong>frontend</strong></p>
<p>کشف در سمت سرور</p>
<p>رجیستری <strong>Service</strong></p>
<p>عمومی</p>
<p>جایگزین <strong>A</strong></p>
<p>پیشینی</p>
<p>خاص</p>
<p>جایگزین <strong>B</strong></p>
<p>جانشین</p>
<p>کلید</p>
<p>حوزه مشکل</p>
<p>شکل 1.12</p>
<p>پنج گروه از الگوهای ارتباطی</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0055_original/original_page.png" alt="Original Page 55">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>26</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<p>گاهی اوقات می‌توانید از الگوی <strong>API composition</strong> استفاده کنید، که <strong>APIs</strong> یک یا چند <strong>service</strong> را فراخوانی کرده و نتایج را جمع‌آوری می‌کند. زمان‌های دیگر، شما باید از الگوی تفکیک مسئولیت پرس و جوی دستور (<strong>CQRS</strong>) استفاده کنید، که یک یا چند نسخه کپی‌شده قابل جستجوی داده‌ها را حفظ می‌کند. فصل 7 به راه‌های مختلف پیاده‌سازی <strong>queries</strong> می‌پردازد.</p>
<p><strong>SERVICE DEPLOYMENT PATTERNS</strong></p>
<p>استقرار یک <strong>application monolithic</strong> همیشه آسان نیست، اما از این جهت که یک <strong>application</strong> واحد برای استقرار وجود دارد، ساده است. شما باید چندین نمونه از <strong>application</strong> را در پشت یک
   <strong>load balancer</strong> اجرا کنید.
  </p>
<p>
   در مقایسه، استقرار یک <strong>application</strong> مبتنی بر <strong>microservices</strong> بسیار پیچیده‌تر است. ممکن است ده‌ها یا صدها <strong>service</strong> وجود داشته باشد که به زبان‌ها و فریم‌ورک‌های مختلف نوشته شده‌اند. قطعات متحرک بیشتری وجود دارد که باید مدیریت شوند. شکل 1.15 الگوهای استقرار را نشان می‌دهد.
  </p>
<p>راه سنتی و اغلب دستی استقرار <strong>applications</strong> در یک قالب بسته‌بندی خاص زبان، به عنوان مثال فایل‌های
   <strong>WAR</strong>، مقیاس‌پذیر نیست تا از معماری <strong>microservice</strong> پشتیبانی کند. شما به یک زیرساخت استقرار بسیار خودکار نیاز دارید. در حالت ایده‌آل، باید از یک پلتفرم استقرار استفاده کنید که یک
   <strong>UI</strong> ساده (خط فرمان یا
   <strong>GUI</strong>) را برای استقرار و مدیریت <strong>services</strong> خود به <strong>developer</strong> ارائه می‌دهد. پلتفرم استقرار معمولاً بر اساس ماشین‌های مجازی (<strong>VMs</strong>)، <strong>containers</strong> یا فناوری <strong>serverless</strong> خواهد بود. فصل 12 به گزینه‌های استقرار مختلف می‌پردازد.
  </p>
<p>پایگاه داده در هر</p>
<p><strong>service</strong></p>
<p><strong>Saga</strong></p>
<p><strong>Event</strong></p>
<p><strong>sourcing</strong></p>
<p>رویداد <strong>Domain</strong></p>
<p><strong>Aggregate</strong></p>
<p>عمومی</p>
<p>جایگزین <strong>A</strong></p>
<p>پیشینی</p>
<p>خاص</p>
<p>جایگزین <strong>B</strong></p>
<p>جانشین</p>
<p>کلید</p>
<p>حوزه مشکل</p>
<p>شکل 1.13</p>
<p>از آنجایی که هر <strong>service</strong> پایگاه داده خود را دارد، شما باید از الگوی <strong>Saga</strong> برای حفظ سازگاری داده‌ها در <strong>services</strong> استفاده کنید.</p>
<p><strong>CQRS</strong></p>
<p><strong>API</strong></p>
<p>ترکیب</p>
<p>پایگاه داده در هر</p>
<p><strong>service</strong></p>
<p>عمومی</p>
<p>جایگزین <strong>A</strong></p>
<p>پیشینی</p>
<p>خاص</p>
<p>جایگزین <strong>B</strong></p>
<p>جانشین</p>
<p>کلید</p>
<p>حوزه مشکل</p>
<p>شکل 1.14</p>
<p>از آنجایی که هر <strong>service</strong> پایگاه داده خود را دارد، شما باید از یکی از الگوهای پرس و جو برای بازیابی داده‌های پراکنده در چندین <strong>services</strong> استفاده کنید.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0056_original/original_page.png" alt="Original Page 56">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>27</p>
<p><strong>The Microservice architecture pattern language</strong></p>
<p><strong>OBSERVABILITY PATTERNS PROVIDE INSIGHT INTO APPLICATION BEHAVIOR</strong></p>
<p>یک بخش کلیدی از راه‌اندازی یک <strong>application</strong>، درک رفتار زمان اجرای آن و عیب‌یابی مشکلاتی مانند درخواست‌های ناموفق و تأخیر بالا است. اگرچه درک و عیب‌یابی یک <strong>application monolithic</strong> همیشه آسان نیست، اما این به این دلیل کمک می‌کند که درخواست‌ها به روشی ساده و سرراست مدیریت می‌شوند. هر درخواست ورودی به یک نمونه <strong>application</strong> خاص <strong>load balanced</strong> می‌شود، که چند تماس به پایگاه داده برقرار می‌کند و پاسخ را برمی‌گرداند. به عنوان مثال، اگر نیاز دارید بدانید که چگونه یک درخواست خاص مدیریت شده است، به فایل <strong>log</strong> نمونه <strong>application</strong> که درخواست را مدیریت کرده است، نگاه می‌کنید.</p>
<p>
   در مقابل، درک و تشخیص مشکلات در معماری <strong>microservice</strong> بسیار پیچیده‌تر است. یک درخواست می‌تواند قبل از اینکه پاسخی در نهایت به یک <strong>client</strong> بازگردانده شود، بین چندین <strong>service</strong> جابه‌جا شود. در نتیجه، یک فایل
   <strong>log</strong> واحد برای بررسی وجود ندارد. به طور مشابه، مشکلات مربوط به تأخیر تشخیص آن دشوارتر است زیرا چندین مظنون وجود دارد.
  </p>
<p>شما می‌توانید از الگوهای زیر برای طراحی <strong>services</strong> قابل مشاهده استفاده کنید:</p>
<ul>
<li>
<strong>Health check API</strong>—یک <strong>endpoint</strong> را در معرض دید قرار دهید که سلامت <strong>service</strong> را برمی‌گرداند.
   </li>
<li>
    تجمیع <strong>Log</strong>—فعالیت <strong>service</strong> را ثبت کنید و <strong>logs</strong> را در یک سرور ثبت مرکزی بنویسید، که جستجو و هشدار را ارائه می‌دهد.
   </li>
</ul>
<p>رویکرد سنتی استقرار</p>
<p><strong>services</strong> با استفاده از بسته‌بندی مختص زبان آن‌ها، مانند فایل‌های <strong>WAR</strong></p>
<p>پلتفرم خودکار و سلف سرویس</p>
<p>برای استقرار</p>
<p>و مدیریت <strong>services</strong></p>
<p>یک رویکرد مدرن،</p>
<p>که کد شما را اجرا می‌کند</p>
<p>بدون اینکه شما نگران</p>
<p>مدیریت زیرساخت باشید</p>
<p>یک رویکرد مدرن، که</p>
<p><strong>technology stack</strong> یک <strong>service</strong> را کپسوله می‌کند</p>
<p><strong>Service-per-VM</strong></p>
<p><strong>Service-per-container</strong></p>
<p>استقرار <strong>Serverless</strong></p>
<p><strong>Service</strong></p>
<p>پلتفرم استقرار</p>
<p><strong>General</strong></p>
<p>جایگزین <strong>A</strong></p>
<p>پیشینی</p>
<p>خاص</p>
<p>جایگزین <strong>B</strong></p>
<p>جانشین</p>
<p>کلید</p>
<p>حوزه مشکل</p>
<p>شکل 1.15</p>
<p>الگوهای متعددی برای استقرار <strong>microservices</strong>. رویکرد سنتی این است که <strong>services</strong> را در یک قالب بسته‌بندی خاص زبان مستقر کنید. دو رویکرد مدرن برای استقرار <strong>services</strong> وجود دارد. اولین مورد، <strong>services</strong> را به عنوان
   <strong>VM</strong> یا <strong>container</strong> مستقر می‌کند. دومی رویکرد <strong>serverless</strong> است. شما به سادگی کد <strong>service</strong> را آپلود می‌کنید و پلتفرم <strong>serverless</strong> آن را اجرا می‌کند. شما باید از یک پلتفرم استقرار <strong>service</strong> استفاده کنید، که یک پلتفرم خودکار و سلف سرویس برای استقرار و مدیریت <strong>services</strong> است.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0057_original/original_page.png" alt="Original Page 57">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>28</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<ul>
<li><strong>Distributed tracing</strong>—به هر درخواست خارجی یک
    <strong>ID</strong> منحصر به فرد اختصاص دهید و درخواست‌ها را همانطور که بین <strong>services</strong> جریان دارند، ردیابی کنید.
   </li>
<li>
    ردیابی <strong>Exception</strong> - <strong>exceptions</strong> را به یک سرویس ردیابی <strong>exception</strong> گزارش دهید، که <strong>exceptions</strong> را حذف می‌کند، به <strong>developers</strong> هشدار می‌دهد و راه‌حل هر
    <strong>exception</strong> را ردیابی می‌کند.
   </li>
<li>
<strong>Application metrics</strong>—متریک‌هایی مانند شمارنده‌ها و گیج‌ها را حفظ کنید و آن‌ها را در معرض یک سرور متریک قرار دهید.
   </li>
<li>
<strong>Audit logging</strong>—اعمال کاربر را ثبت کنید.
   </li>
</ul>
<p>فصل 11 این الگوها را با جزئیات بیشتری شرح می‌دهد.</p>
<p><strong>PATTERNS FOR THE AUTOMATED TESTING OF SERVICES</strong></p>
<p>معماری <strong>microservice</strong>، تست <strong>services</strong> فردی را آسان‌تر می‌کند، زیرا آن‌ها بسیار کوچکتر از <strong>application monolithic</strong> هستند. در عین حال، مهم است که تست کنید که <strong>services</strong> مختلف با هم کار می‌کنند در حالی که از استفاده از تست‌های <strong>end-to-end</strong> پیچیده، کند و شکننده که چندین <strong>services</strong> را با هم تست می‌کنند، اجتناب کنید. در اینجا الگوهایی برای ساده‌سازی تست با تست <strong>services</strong> به صورت ایزوله آمده است:</p>
<ul>
<li>تست قرارداد <strong>Consumer-driven</strong>—تأیید کنید که یک <strong>service</strong> انتظارات <strong>clients</strong> خود را برآورده می‌کند.</li>
<li>تست قرارداد <strong>Consumer-side</strong>—تأیید کنید که <strong>client</strong> یک <strong>service</strong> می‌تواند با <strong>service</strong> ارتباط برقرار کند.</li>
<li>تست کامپوننت <strong>Service</strong>—یک <strong>service</strong> را به صورت مجزا تست کنید.</li>
</ul>
<p>فصل‌های 9 و 10 این الگوهای تست را با جزئیات بیشتری شرح می‌دهند.</p>
<p><strong>PATTERNS FOR HANDLING CROSS-CUTTING CONCERNS</strong></p>
<p>در معماری <strong>microservice</strong>، نگرانی‌های متعددی وجود دارد که هر <strong>service</strong> باید پیاده‌سازی کند، از جمله الگوهای مشاهده و الگوهای کشف. همچنین باید الگوی پیکربندی خارجی را پیاده‌سازی کند، که پارامترهای پیکربندی مانند اعتبارنامه‌های پایگاه داده را در زمان اجرا به یک <strong>service</strong> ارائه می‌دهد. هنگام توسعه یک <strong>service</strong> جدید، از نو پیاده‌سازی این نگرانی‌ها زمان‌بر خواهد بود. یک رویکرد بسیار بهتر، اعمال الگوی
   <strong>Microservice Chassis</strong> و ساخت <strong>services</strong> بر روی یک فریم‌ورک است که این نگرانی‌ها را مدیریت می‌کند. فصل 11 این الگوها را با جزئیات بیشتری شرح می‌دهد.</p>
<p><strong>SECURITY PATTERNS</strong></p>
<p>در یک معماری <strong>microservice</strong>، کاربران معمولاً توسط <strong>API gateway</strong> احراز هویت می‌شوند. سپس باید اطلاعات مربوط به کاربر، مانند هویت و نقش‌ها، را به <strong>services</strong> که فراخوانی می‌کند، منتقل کند. یک راه‌حل رایج، اعمال الگوی توکن دسترسی است.
   <strong>API gateway</strong> یک توکن دسترسی، مانند
   <strong>JWT (JSON Web Token)</strong> را به <strong>services</strong> منتقل می‌کند، که می‌تواند توکن را اعتباردهی کرده و اطلاعاتی در مورد کاربر به دست آورد. فصل 11 الگوی توکن دسترسی را با جزئیات بیشتری مورد بحث قرار می‌دهد.</p>
<p>جای تعجب نیست که الگوهای موجود در زبان <strong>pattern</strong> معماری <strong>Microservice</strong> بر حل مشکلات معمار و طراحی متمرکز شده‌اند. شما مطمئناً به درستی نیاز دارید</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0058_original/original_page.png" alt="Original Page 58">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>29</p>
<p><strong>Beyond microservices: Process and organization</strong></p>
<p>معماری یک <strong>software</strong> را با موفقیت توسعه دهید، اما این تنها نگرانی نیست. شما همچنین باید فرآیند و سازمان را در نظر بگیرید.
  </p>
<p>1.7</p>
<p><strong>Beyond microservices: Process and organization</strong></p>
<p>برای یک <strong>application</strong> بزرگ و پیچیده، معماری <strong>microservice</strong> معمولاً بهترین انتخاب است. اما علاوه بر داشتن معماری مناسب، توسعه <strong>software</strong> موفق، مستلزم این است که شما همچنین سازمان، و فرآیندهای توسعه و تحویل را داشته باشید. شکل 1.16 روابط بین فرآیند، سازمان و معماری را نشان می‌دهد.
  </p>
<p>من قبلاً معماری <strong>microservice</strong> را توضیح داده‌ام. بیایید به سازمان و فرآیند نگاهی بیندازیم.</p>
<p>1.7.1</p>
<p><strong>Software development and delivery organization</strong></p>
<p>موفقیت اجتناب‌ناپذیر به این معنی است که تیم مهندسی رشد خواهد کرد. از یک سو، این یک چیز خوب است زیرا <strong>developers</strong> بیشتر می‌توانند کارهای بیشتری انجام دهند. مشکل تیم‌های بزرگ این است که، همانطور که فرد بروکس در
   <strong>The Mythical Man-Month</strong> نوشت، سربار ارتباطی یک تیم با اندازه <strong>N</strong> برابر <strong>O(N 2)</strong> است. اگر تیم خیلی بزرگ شود، به دلیل سربار ارتباطی، ناکارآمد خواهد شد. به عنوان مثال، تصور کنید که سعی می‌کنید با 20 نفر یک
   <strong>standup</strong> روزانه انجام دهید.
  </p>
<p>راه‌حل این است که یک تیم واحد بزرگ را به یک تیم از تیم‌ها <strong>refactor</strong> کنید. هر تیم کوچک است، متشکل از حداکثر 8 تا 12 نفر. این تیم دارای یک مأموریت تجاری محور است: توسعه و احتمالاً راه‌اندازی یک یا چند <strong>service</strong> که یک ویژگی یا یک قابلیت تجاری را پیاده‌سازی می‌کنند. این تیم چند منظوره است و می‌تواند
   <strong>services</strong> خود را بدون نیاز به برقراری ارتباط مکرر یا هماهنگی با سایر تیم‌ها توسعه، تست و استقرار دهد.</p>
<p>فعال می‌کند</p>
<p>فعال می‌کند</p>
<p>معماری:</p>
<p>معماری <strong>Microservice</strong></p>
<p>سازمان:</p>
<p>تیم‌های کوچک، مستقل،</p>
<p>چند منظوره</p>
<p>فرآیند:</p>
<p>تحویل/استقرار
   <strong>DevOps/continuous</strong></p>
<p>فعال می‌کند</p>
<p>تحویل سریع، مکرر،</p>
<p>و قابل اطمینان</p>
<p>از <strong>software</strong></p>
<p>شکل 1.16</p>
<p>تحویل سریع، مکرر و قابل اطمینان <strong>applications</strong> بزرگ و پیچیده به ترکیبی از <strong>DevOps</strong> نیاز دارد، که شامل تحویل/استقرار مداوم، تیم‌های کوچک و مستقل و معماری <strong>microservice</strong> است.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0059_original/original_page.png" alt="Original Page 59">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>30</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<p>سرعت تیم‌ها به طور قابل توجهی بیشتر از یک تیم بزرگ واحد است. همانطور که قبلاً در بخش 1.5.1 توضیح داده شد، معماری <strong>microservice</strong> نقش کلیدی در قادر ساختن تیم‌ها به استقلال دارد. هر تیم می‌تواند <strong>services</strong> خود را بدون هماهنگی با تیم‌های دیگر توسعه، استقرار و مقیاس‌بندی کند. علاوه بر این، مشخص است که در صورت عدم رعایت
   <strong>SLA</strong> یک <strong>service</strong> با چه کسی تماس بگیرید.
  </p>
<p>
   علاوه بر این، سازمان توسعه بسیار مقیاس‌پذیرتر است. شما سازمان را با افزودن تیم‌ها توسعه می‌دهید. اگر یک تیم واحد بیش از حد بزرگ شود، آن را و <strong>service</strong> یا <strong>services</strong> مرتبط با آن را تقسیم می‌کنید. از آنجایی که تیم‌ها <strong>loosely coupled</strong> هستند، از سربار ارتباطی یک تیم بزرگ اجتناب می‌کنید. در نتیجه، می‌توانید بدون تأثیر بر بهره‌وری، افراد را اضافه کنید.
  </p>
<p>1.7.2</p>
<p><strong>Software development and delivery process</strong></p>
<p>استفاده از معماری <strong>microservice</strong> با فرآیند توسعه
   <strong>waterfall</strong> مانند راندن یک فراری با اسب است - شما بیشتر مزایای استفاده از <strong>microservices</strong> را هدر می‌دهید. اگر می‌خواهید یک <strong>application</strong> را با معماری <strong>microservice</strong> توسعه دهید، ضروری است که توسعه <strong>agile</strong> و شیوه‌های استقرار مانند
   <strong>Scrum</strong> یا <strong>Kanban</strong> را اتخاذ کنید. بهتر از آن، باید تحویل/استقرار مداوم را تمرین کنید، که بخشی از
   <strong>DevOps</strong> است.
  </p>
<p><strong>Jez Humble</strong> (https://continuousdelivery.com/)
   تحویل مداوم را به شرح زیر تعریف می‌کند:</p>
<p>
   تحویل مداوم توانایی دریافت تغییرات از همه انواع - از جمله ویژگی‌های جدید، تغییرات پیکربندی، رفع اشکال و آزمایش‌ها - در تولید یا در اختیار کاربران، ایمن و سریع به روشی پایدار است.
  </p>
<p>
   یک ویژگی کلیدی تحویل مداوم این است که <strong>software</strong> همیشه قابل انتشار است. این امر به سطح بالایی از اتوماسیون، از جمله تست خودکار، متکی است. استقرار مداوم، تحویل مداوم را یک قدم فراتر در عمل استقرار خودکار کد قابل انتشار در تولید می‌برد. سازمان‌های با عملکرد بالا
  </p>
<p>مانور معکوس <strong>Conway</strong></p>
<p>به منظور ارائه مؤثر <strong>software</strong> هنگام استفاده از معماری <strong>microservice</strong>، باید قانون
   <strong>Conway</strong> (https://en.wikipedia.org/wiki/Conway%27s_law) را در نظر بگیرید، که موارد زیر را بیان می‌کند:</p>
<p>سازمان‌هایی که سیستم‌ها را طراحی می‌کنند ... محدود شده‌اند تا طرح‌هایی را تولید کنند که نسخه‌هایی از ساختارهای ارتباطی این سازمان‌ها هستند.</p>
<p>ملوین کانوی</p>
<p>به عبارت دیگر، معماری <strong>application</strong> شما، ساختار سازمانی را که آن را توسعه داده است، منعکس می‌کند. بنابراین، مهم است که قانون
   <strong>Conway</strong> را برعکس اعمال کنید (www.thoughtworks.com/radar/techniques/inverse-conway-maneuver) و سازمان خود را طوری طراحی کنید که ساختار آن، معماری <strong>microservice</strong> شما را منعکس کند. با این کار، اطمینان حاصل می‌کنید که تیم‌های توسعه شما به اندازه <strong>services</strong> <strong>loosely coupled</strong> هستند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0060_original/original_page.png" alt="Original Page 60">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>31</p>
<p><strong>Beyond microservices: Process and organization</strong></p>
<p>سازمان‌هایی که تحویل مداوم را تمرین می‌کنند، چندین بار در روز در تولید مستقر می‌شوند، خرابی‌های تولید بسیار کمتری دارند و به سرعت از هر موردی که رخ می‌دهد، بازیابی می‌کنند (https://puppet.com/resources/whitepaper/state-of-devops-report). همانطور که قبلاً در بخش 1.5.1 توضیح داده شد، معماری <strong>microservice</strong> مستقیماً از تحویل/استقرار مداوم پشتیبانی می‌کند.</p>
<p>1.7.3</p>
<p><strong>The human side of adopting microservices</strong></p>
<p>اتخاذ معماری <strong>microservice</strong>، معماری، سازمان و فرآیندهای توسعه شما را تغییر می‌دهد. با این حال، در نهایت، این محیط کاری مردم را تغییر می‌دهد، که، همانطور که قبلاً ذکر شد، موجوداتی احساسی هستند. اگر نادیده گرفته شوند، احساسات آن‌ها می‌تواند اتخاذ <strong>microservices</strong> را به یک سواری ناهموار تبدیل کند. ماری و سایر رهبران
   <strong>FTGO</strong> برای تغییر نحوه توسعه <strong>software</strong> <strong>FTGO</strong> تلاش خواهند کرد.
  </p>
<p>کتاب پرفروش
   <strong>Managing Transitions (Da Capo Lifelong Books, 2017, https://wmbridges.com/books)</strong> اثر ویلیام و سوزان بریجز مفهوم یک
   <strong>transition</strong> را معرفی می‌کند، که به فرآیند چگونگی واکنش احساسی افراد به یک تغییر اشاره دارد. این یک
   <strong>Three-stage Transition Model</strong> را توصیف می‌کند:
  </p>
<p>1. پایان دادن، از دست دادن و رها کردن - دوره آشفتگی احساسی و مقاومت، زمانی که افراد با تغییری مواجه می‌شوند که آن‌ها را از منطقه راحتی خود خارج می‌کند. آن‌ها اغلب فقدان روش قدیمی انجام کارها را سوگواری می‌کنند. به عنوان مثال، هنگامی که افراد به تیم‌های چند منظوره سازماندهی مجدد می‌شوند، دلتنگ هم‌تیمی‌های سابق خود می‌شوند. به طور مشابه، یک گروه مدل‌سازی داده که مدل داده جهانی را در اختیار دارد، از ایده داشتن هر <strong>service</strong> مدل داده خود تهدید می‌شود.</p>
<p><strong>Move fast without breaking things</strong></p>
<p>هدف تحویل/استقرار مداوم (و به طور کلی‌تر، <strong>DevOps</strong>) این است که <strong>software</strong> را سریع و در عین حال قابل اطمینان ارائه دهد. چهار متریک مفید برای ارزیابی توسعه <strong>software</strong> به شرح زیر است:</p>
<ul>
<li>
    فراوانی استقرار - چند وقت یکبار <strong>software</strong> در تولید مستقر می‌شود
   </li>
<li>زمان <strong>Lead</strong>—زمان از زمانی که یک <strong>developer</strong> یک تغییر را بررسی می‌کند تا آن تغییر مستقر شود</li>
<li>میانگین زمان بازیابی - زمان بازیابی از یک مشکل تولید</li>
<li>نرخ خرابی تغییر - درصد تغییراتی که منجر به یک مشکل تولید می‌شود</li>
</ul>
<p>در یک سازمان سنتی، فراوانی استقرار کم است و زمان <strong>lead</strong> زیاد است. <strong>developers</strong> و افراد عملیاتی تحت استرس معمولاً تا دیروقت بیدار می‌مانند و مشکلات لحظه آخری را در طول پنجره نگهداری برطرف می‌کنند. در مقابل، یک سازمان
   <strong>DevOps</strong> <strong>software</strong> را به طور مکرر، اغلب چندین بار در روز، با مشکلات تولید بسیار کمتری منتشر می‌کند. به عنوان مثال، <strong>Amazon</strong> در سال 2014 تغییراتی را هر 11.6 ثانیه در تولید مستقر کرد (www.youtube.com/watch?v=dxk8b9rSKOo)، و <strong>Netflix</strong> دارای زمان
   <strong>lead</strong> 16 دقیقه برای یک مؤلفه <strong>software</strong> بود (https://medium.com/netflix-techblog/how-we-build-code-at-netflix-c5d9bd727f15).
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0061_original/original_page.png" alt="Original Page 61">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>32</p>
<p>فصل 1</p>
<p><strong>فرار از جهنم Monolithic</strong></p>
<ul>
<li>منطقه خنثی - مرحله میانی بین روش‌های قدیمی و جدید انجام کارها، جایی که مردم اغلب گیج می‌شوند. آن‌ها اغلب در تلاشند تا روش جدید انجام کارها را بیاموزند.</li>
<li>آغاز جدید - مرحله نهایی که در آن مردم با اشتیاق روش جدید انجام کارها را پذیرفته‌اند و شروع به تجربه مزایای آن می‌کنند.</li>
</ul>
<p>این کتاب توضیح می‌دهد که چگونه در هر مرحله از <strong>transition</strong> بهترین مدیریت را داشته باشیم و احتمال پیاده‌سازی موفقیت‌آمیز تغییر را افزایش دهیم.
   <strong>FTGO</strong> مطمئناً از جهنم <strong>monolithic</strong> رنج می‌برد و باید به یک معماری <strong>microservice</strong> مهاجرت کند. همچنین باید سازمان و فرآیندهای توسعه خود را تغییر دهد. با این حال، برای اینکه <strong>FTGO</strong> با موفقیت این کار را انجام دهد، باید مدل <strong>transition</strong> را در نظر بگیرد و احساسات مردم را در نظر بگیرد.
  </p>
<p>در فصل بعد، در مورد هدف معماری <strong>software</strong> و نحوه تجزیه یک <strong>application</strong> به <strong>services</strong> یاد خواهید گرفت.</p>
<p><strong>Summary</strong></p>
<ul>
<li>الگوی معماری <strong>Monolithic</strong>، <strong>application</strong> را به عنوان یک واحد قابل استقرار واحد ساختار می‌دهد.</li>
<li>الگوی معماری <strong>Microservice</strong> یک سیستم را به مجموعه‌ای از <strong>services</strong> قابل استقرار مستقل، که هر کدام پایگاه داده خود را دارند، تجزیه می‌کند.</li>
<li>معماری <strong>monolithic</strong> یک انتخاب خوب برای <strong>applications</strong> ساده است، اما معماری <strong>microservice</strong> معمولاً انتخاب بهتری برای <strong>applications</strong> بزرگ و پیچیده است.</li>
<li>معماری <strong>microservice</strong> سرعت توسعه <strong>software</strong> را با فعال کردن تیم‌های کوچک و مستقل برای کار موازی تسریع می‌کند.</li>
<li>معماری <strong>microservice</strong> یک گلوله نقره‌ای نیست - معایب قابل توجهی از جمله پیچیدگی وجود دارد.</li>
<li>زبان <strong>pattern</strong> معماری <strong>Microservice</strong> مجموعه‌ای از الگوها است که به شما کمک می‌کند تا یک <strong>application</strong> را با استفاده از معماری <strong>microservice</strong> معماری کنید. این به شما کمک می‌کند تصمیم بگیرید که آیا از معماری
    <strong>microservice</strong> استفاده کنید یا خیر، و اگر معماری <strong>microservice</strong> را انتخاب کنید، زبان <strong>pattern</strong> به شما کمک می‌کند تا آن را به طور مؤثر اعمال کنید.
   </li>
<li>شما برای تسریع تحویل <strong>software</strong> به چیزی بیش از معماری <strong>microservice</strong> نیاز دارید. توسعه <strong>software</strong> موفق همچنین به <strong>DevOps</strong> و تیم‌های کوچک و مستقل نیاز دارد.</li>
<li>جنبه انسانی اتخاذ <strong>microservices</strong> را فراموش نکنید. شما باید احساسات کارکنان را برای انتقال موفقیت‌آمیز به معماری <strong>microservice</strong> در نظر بگیرید.</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0062_original/original_page.png" alt="Original Page 62">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>33</p>
<p><strong>Decomposition strategies</strong></p>
<p>گاهی اوقات باید مراقب باشید که چه آرزویی دارید. پس از یک تلاش لابی فشرده، ماری در نهایت کسب‌وکار را متقاعد کرد که مهاجرت به معماری <strong>microservice</strong> کار درستی است. ماری با احساس ترکیبی از هیجان و کمی ترس، یک جلسه صبحگاهی با معمارانش داشت تا در مورد اینکه از کجا شروع کنند، بحث کند. در طول بحث، مشخص شد که برخی از جنبه‌های زبان <strong>pattern</strong> معماری <strong>Microservice</strong>، مانند استقرار و کشف <strong>service</strong>، جدید و ناآشنا، اما سرراست بودند. چالش اصلی، که جوهر معماری <strong>microservice</strong> است، تجزیه عملکردی
   <strong>application</strong> به <strong>services</strong> است. اولین و مهم‌ترین جنبه معماری این است،
  </p>
<p>این فصل موارد زیر را پوشش می‌دهد</p>
<ul>
<li>درک معماری <strong>software</strong> و اینکه چرا مهم است</li>
<li>تجزیه یک <strong>application</strong> به <strong>services</strong> با اعمال الگوهای تجزیه، تجزیه بر اساس قابلیت کسب‌وکار و تجزیه بر اساس زیر دامنه</li>
<li>استفاده از مفهوم <strong>context</strong> محدود از طراحی مبتنی بر دامنه (<strong>DDD</strong>) برای باز کردن داده‌ها و آسان‌تر کردن تجزیه</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0063_original/original_page.png" alt="Original Page 63">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>34</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p>بنابراین، تعریف <strong>services</strong>. همانطور که در اطراف تخته وایت‌برد ایستاده بودند، تیم
   <strong>FTGO</strong> از خود می‌پرسیدند که دقیقاً چگونه این کار را انجام دهند!</p>
<p>در این فصل، یاد خواهید گرفت که چگونه یک معماری <strong>microservice</strong> را برای یک <strong>application</strong> تعریف کنید. من استراتژی‌هایی را برای تجزیه یک <strong>application</strong> به <strong>services</strong> توضیح می‌دهم. شما یاد خواهید گرفت که <strong>services</strong> حول نگرانی‌های تجاری سازماندهی شده‌اند نه نگرانی‌های فنی.
   همچنین نشان می‌دهم که چگونه از ایده‌های طراحی مبتنی بر دامنه (<strong>DDD</strong>) برای حذف کلاس‌های <strong>god</strong> استفاده کنید، که کلاس‌هایی هستند که در سراسر یک <strong>application</strong> استفاده می‌شوند و باعث وابستگی‌های درهم می‌شوند که از تجزیه جلوگیری می‌کنند.
  </p>
<p>من این فصل را با تعریف معماری <strong>microservice</strong> از نظر مفاهیم معماری <strong>software</strong> آغاز می‌کنم. پس از آن، فرآیندی را برای تعریف یک معماری <strong>microservice</strong> برای یک <strong>application</strong>، با شروع از الزامات آن، توضیح می‌دهم. من در مورد استراتژی‌هایی برای تجزیه یک <strong>application</strong> به مجموعه‌ای از <strong>services</strong>، موانع آن و نحوه غلبه بر آن‌ها بحث می‌کنم. بیایید با بررسی مفهوم معماری <strong>software</strong> شروع کنیم.</p>
<p>2.1</p>
<p><strong>What is the microservice architecture exactly?</strong></p>
<p>فصل 1 توضیح می‌دهد که چگونه ایده کلیدی معماری <strong>microservice</strong>، تجزیه عملکردی است. به جای توسعه یک <strong>application</strong> بزرگ، شما <strong>application</strong> را به عنوان مجموعه‌ای از <strong>services</strong> ساختار می‌دهید. از یک طرف، توصیف معماری <strong>microservice</strong> به عنوان نوعی تجزیه عملکردی مفید است. اما از سوی دیگر، چندین سؤال را بی‌پاسخ می‌گذارد، از جمله اینکه معماری <strong>microservice</strong> چگونه با مفاهیم گسترده‌تر معماری <strong>software</strong> مرتبط است؟ یک <strong>service</strong> چیست؟ و اندازه یک <strong>service</strong> چقدر مهم است؟</p>
<p>برای پاسخ به این سؤالات، باید یک قدم به عقب برداریم و نگاهی بیندازیم که منظور از معماری <strong>software</strong> چیست. معماری یک <strong>application software</strong>، ساختار سطح بالای آن است که از بخش‌های تشکیل‌دهنده و وابستگی‌های بین آن بخش‌ها تشکیل شده است. همانطور که در این بخش خواهید دید، معماری یک <strong>application</strong> چند بعدی است، بنابراین راه‌های متعددی برای توصیف آن وجود دارد. دلیل اهمیت معماری این است که ویژگی‌های کیفیت <strong>software application</strong> یا -<strong>ilities</strong> آن را تعیین می‌کند. به طور سنتی، هدف از معماری، مقیاس‌پذیری، قابلیت اطمینان و امنیت بوده است. اما امروزه مهم است که معماری همچنین توسعه سریع و ایمن <strong>software</strong> را فعال کند. شما یاد خواهید گرفت که معماری <strong>microservice</strong> یک سبک معماری است که به یک <strong>application</strong> قابلیت نگهداری، قابلیت تست و قابلیت استقرار بالایی می‌دهد.</p>
<p>من این بخش را با توصیف مفهوم معماری <strong>software</strong> و دلیل اهمیت آن آغاز می‌کنم. در مرحله بعد، در مورد ایده یک سبک معماری بحث می‌کنم. سپس معماری <strong>microservice</strong> را به عنوان یک سبک معماری خاص تعریف می‌کنم. بیایید با نگاهی به مفهوم معماری <strong>software</strong> شروع کنیم.</p>
<p>2.1.1</p>
<p><strong>What is software architecture and why does it matter?</strong></p>
<p>معماری قطعاً مهم است. حداقل دو کنفرانس به این موضوع اختصاص داده شده است: کنفرانس معماری <strong>software</strong>
<strong>O’Reilly</strong> (https://conferences.oreilly.com/software-architecture) و کنفرانس
   <strong>SATURN</strong> (https://resources.sei.cmu.edu/news-events/events/saturn/). بسیاری از <strong>developers</strong> این هدف را دارند که معمار شوند. اما معماری چیست و چرا مهم است؟</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0064_original/original_page.png" alt="Original Page 64">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>35</p>
<p><strong>What is the microservice architecture exactly?</strong></p>
<p>برای پاسخ به این سؤال، ابتدا تعریف می‌کنم که منظور از عبارت معماری <strong>software</strong> چیست. پس از آن، من در مورد چگونگی چند بعدی بودن معماری یک <strong>application</strong> و اینکه چگونه می‌توان آن را با استفاده از مجموعه‌ای از <strong>views</strong> یا طرح‌ها بهتر توصیف کرد، بحث می‌کنم. سپس شرح می‌دهم که چرا معماری <strong>software</strong> مهم است زیرا بر ویژگی‌های کیفیت <strong>software application</strong> تأثیر می‌گذارد.
  </p>
<p><strong>A DEFINITION OF SOFTWARE ARCHITECTURE</strong></p>
<p>تعاریف متعددی از معماری <strong>software</strong> وجود دارد. به عنوان مثال، برای خواندن برخی از آن‌ها به https://en.wikiquote.org/wiki/Software_architecture مراجعه کنید. تعریف مورد علاقه من از
   <strong>Len Bass</strong> و همکارانش در مؤسسه مهندسی <strong>Software (www.sei.cmu.edu)</strong> آمده است، که نقش کلیدی در تأسیس معماری <strong>software</strong> به عنوان یک رشته داشتند. آن‌ها معماری <strong>software</strong> را به شرح زیر تعریف می‌کنند:</p>
<p>معماری نرم‌افزار یک سیستم محاسباتی، مجموعه‌ای از ساختارها است که برای استدلال در مورد سیستم مورد نیاز است، که شامل عناصر نرم‌افزاری، روابط بین آن‌ها و خواص هر دو است.</p>
<p>مستندسازی معماری <strong>Software</strong> توسط
   <strong>Bass</strong> و همکاران</p>
<p>این تعریف بدیهی است که کاملاً انتزاعی است. اما جوهر آن این است که معماری یک <strong>application</strong>، تجزیه آن به اجزاء (عناصر) و روابط (روابط) بین آن اجزا است. تجزیه به چند دلیل مهم است:</p>
<ul>
<li>این تقسیم کار و دانش را تسهیل می‌کند. این امر <strong>developers</strong> متعدد (یا تیم‌های متعدد) را با دانش احتمالی تخصصی قادر می‌سازد تا به طور مؤثر در یک <strong>application</strong> با هم کار کنند.</li>
<li>نحوه تعامل عناصر <strong>software</strong> را تعریف می‌کند.</li>
</ul>
<p>این تجزیه به اجزا و روابط بین آن اجزا است که -<strong>ilities application</strong> را تعیین می‌کند.</p>
<p><strong>THE 4+1 VIEW MODEL OF SOFTWARE ARCHITECTURE</strong></p>
<p>به طور ملموس‌تر، معماری یک <strong>application</strong> را می‌توان از دیدگاه‌های متعددی مشاهده کرد، به همان روشی که معماری یک ساختمان را می‌توان از دیدگاه‌های ساختاری، لوله‌کشی، برق و سایر دیدگاه‌ها مشاهده کرد. <strong>Phillip Krutchen</strong> یک مقاله کلاسیک با عنوان
   <strong>“Architectural Blueprints—The ‘4+1’ View Model of Software Architecture” (www.cs.ubc.ca/~gregor/teaching/papers/4+1view-architecture.pdf)</strong>، که مدل 4+1 را توصیف می‌کند، نوشت. مدل 4+1، که در شکل 2.1 نشان داده شده است، چهار دیدگاه مختلف از یک معماری <strong>software</strong> را تعریف می‌کند. هر کدام جنبه خاصی از معماری را توصیف می‌کنند و از یک مجموعه خاص از عناصر <strong>software</strong> و روابط بین آن‌ها تشکیل شده‌اند.
  </p>
<p>هدف از هر <strong>view</strong> به شرح زیر است:</p>
<ul>
<li>
<strong>Logical view</strong>—عناصر <strong>software</strong> که توسط <strong>developers</strong> ایجاد شده‌اند. در زبان‌های شی گرا، این عناصر کلاس‌ها و بسته‌ها هستند. روابط بین آن‌ها، روابط بین کلاس‌ها و بسته‌ها، از جمله وراثت، انجمن‌ها و <strong>depends-on</strong> هستند.
   </li>
<li>
<strong>Implementation view</strong>—خروجی سیستم <strong>build</strong>. این <strong>view</strong> شامل ماژول‌ها است که نشان دهنده کد بسته‌بندی شده و مؤلفه‌ها هستند که قابل اجرا هستند
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0065_original/original_page.png" alt="Original Page 65">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>36</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p>یا واحدهای قابل استقرار که شامل یک یا چند ماژول هستند. در <strong>Java</strong>، یک ماژول یک فایل
   <strong>JAR</strong> است، و یک مؤلفه معمولاً یک فایل <strong>WAR</strong> یا یک فایل <strong>JAR</strong> قابل اجرا است. روابط بین آن‌ها شامل روابط وابستگی بین ماژول‌ها و روابط ترکیب بین مؤلفه‌ها و ماژول‌ها است.
  </p>
<ul>
<li>
<strong>Process view</strong>—مؤلفه‌ها در زمان اجرا. هر عنصر یک فرآیند است و روابط بین فرآیندها، ارتباط بین فرآیندی را نشان می‌دهد.
   </li>
<li>
<strong>Deployment</strong> - چگونگی نگاشت فرآیندها به ماشین‌ها. عناصر موجود در این <strong>view</strong> شامل ماشین‌ها (فیزیکی یا مجازی) و فرآیندها هستند. روابط بین ماشین‌ها نشان‌دهنده شبکه‌سازی است. این
    <strong>view</strong> همچنین رابطه بین فرآیندها و ماشین‌ها را توصیف می‌کند.
   </li>
</ul>
<p>علاوه بر این چهار <strong>view</strong>، سناریوها وجود دارند - +1 در مدل 4+1 - که <strong>views</strong> را متحرک می‌کنند. هر سناریو نحوه همکاری مؤلفه‌های معماری مختلف در یک
   <strong>view</strong> خاص را برای رسیدگی به یک درخواست توصیف می‌کند. به عنوان مثال، یک سناریو در <strong>logical view</strong>، نحوه همکاری کلاس‌ها را نشان می‌دهد. به طور مشابه، یک سناریو در <strong>process view</strong> نشان می‌دهد که چگونه فرآیندها با هم همکاری می‌کنند.
  </p>
<p>مدل 4+1 یک راه عالی برای توصیف معماری یک <strong>applications</strong> است. هر <strong>view</strong> جنبه مهمی از معماری را توصیف می‌کند و سناریوها</p>
<p><strong>Logical</strong></p>
<p><strong>view</strong></p>
<p><strong>Implementation</strong></p>
<p><strong>view</strong></p>
<p><strong>Process</strong></p>
<p><strong>view</strong></p>
<p>استقرار</p>
<p><strong>view</strong></p>
<p>سناریوها</p>
<p>آنچه <strong>developers</strong> ایجاد می‌کنند</p>
<p>عناصر: کلاس‌ها و بسته‌ها</p>
<p>روابط: روابط</p>
<p>بین آن‌ها</p>
<p>آنچه توسط سیستم <strong>build</strong> تولید می‌شود</p>
<p>عناصر: ماژول‌ها، (فایل‌های <strong>JAR</strong>) و</p>
<p>مؤلفه‌ها (فایل‌های <strong>WAR</strong></p>
<p>یا قابل اجرا)</p>
<p>روابط: وابستگی‌های آن‌ها</p>
<p>مؤلفه‌های در حال اجرا</p>
<p>عناصر: فرآیندها</p>
<p>روابط: بین فرآیندی</p>
<p>ارتباط</p>
<p>فرآیندهای در حال اجرا در "ماشین‌ها"</p>
<p>عناصر: ماشین‌ها و فرآیندها</p>
<p>روابط: شبکه‌سازی</p>
<p>انیمیشن <strong>views</strong>.</p>
<p>شکل 2.1</p>
<p>مدل 4+1، معماری یک <strong>application</strong> را با استفاده از چهار <strong>view</strong> و سناریوهایی که نشان می‌دهند چگونه عناصر موجود در هر <strong>view</strong> برای رسیدگی به درخواست‌ها همکاری می‌کنند، توصیف می‌کند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0066_original/original_page.png" alt="Original Page 66">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>37</p>
<p><strong>What is the microservice architecture exactly?</strong></p>
<p>نشان می‌دهند که چگونه عناصر یک <strong>view</strong> با هم همکاری می‌کنند. بیایید اکنون نگاهی بیندازیم که چرا معماری مهم است.</p>
<p><strong>WHY ARCHITECTURE MATTERS</strong></p>
<p>یک <strong>application</strong> دارای دو دسته از الزامات است. دسته اول شامل الزامات عملکردی است که تعریف می‌کنند <strong>application</strong> باید چه کاری انجام دهد. آن‌ها معمولاً به شکل موارد استفاده یا <strong>user stories</strong> هستند. معماری ارتباط بسیار کمی با الزامات عملکردی دارد. شما می‌توانید الزامات عملکردی را تقریباً با هر معماری، حتی یک توپ بزرگ گل، پیاده‌سازی کنید.</p>
<p>معماری مهم است زیرا <strong>application</strong> را قادر می‌سازد تا دسته دوم الزامات را برآورده کند: الزامات کیفیت <strong>service</strong> آن. اینها به عنوان ویژگی‌های کیفیت و به اصطلاح -<strong>ilities</strong> نیز شناخته می‌شوند. الزامات کیفیت <strong>service</strong>، کیفیت‌های زمان اجرا مانند مقیاس‌پذیری و قابلیت اطمینان را تعریف می‌کنند. آن‌ها همچنین کیفیت‌های زمان توسعه از جمله قابلیت نگهداری، قابلیت تست و قابلیت استقرار را تعریف می‌کنند. معماری که برای <strong>application</strong> خود انتخاب می‌کنید، تعیین می‌کند که چقدر این الزامات کیفیتی را برآورده می‌کند.</p>
<p>2.1.2</p>
<p><strong>Overview of architectural styles</strong></p>
<p>در دنیای فیزیکی، معماری یک ساختمان اغلب از یک سبک خاص، مانند ویکتوریایی، <strong>American Craftsman</strong> یا <strong>Art Deco</strong> پیروی می‌کند. هر سبک بسته‌ای از تصمیمات طراحی است که ویژگی‌های ساختمان و مصالح ساختمانی را محدود می‌کند. مفهوم سبک معماری برای <strong>software</strong> نیز صدق می‌کند.
   <strong>David Garlan</strong> و <strong>Mary Shaw (An Introduction to Software Architecture, January 1994, https://www.cs.cmu.edu/afs/cs/project/able/ftp/intro_softarch/intro_softarch.pdf)</strong>، پیشگامان در رشته معماری <strong>software</strong>، یک سبک معماری را به شرح زیر تعریف می‌کنند:
  </p>
<p>بنابراین، یک سبک معماری، یک خانواده از این سیستم‌ها را از نظر الگوی سازماندهی ساختاری تعریف می‌کند. به‌طور خاص‌تر، یک سبک معماری، واژگان مؤلفه‌ها و اتصالات را که می‌توان در نمونه‌هایی از آن سبک استفاده کرد، به همراه مجموعه‌ای از محدودیت‌ها در مورد نحوه ترکیب آن‌ها تعیین می‌کند.</p>
<p>یک سبک معماری خاص، پالت محدودی از عناصر (مؤلفه‌ها) و روابط (اتصالات) را ارائه می‌دهد که می‌توانید <strong>view</strong> معماری <strong>application</strong> خود را از آن تعریف کنید. یک <strong>application</strong> معمولاً از ترکیبی از سبک‌های معماری استفاده می‌کند. به عنوان مثال، در ادامه این بخش نحوه عملکرد معماری <strong>monolithic</strong> را شرح می‌دهم که سبک معماری است که <strong>implementation view</strong> را به عنوان یک مؤلفه واحد (قابل اجرا/قابل استقرار) ساختار می‌دهد. معماری <strong>microservice</strong> یک <strong>application</strong> را به عنوان مجموعه‌ای از <strong>services</strong> <strong>loosely coupled</strong> ساختار می‌دهد.</p>
<p><strong>THE LAYERED ARCHITECTURAL STYLE</strong></p>
<p>نمونه کلاسیک یک سبک معماری، معماری لایه‌ای است. یک معماری لایه‌ای عناصر <strong>software</strong> را به لایه‌ها سازماندهی می‌کند. هر لایه مجموعه‌ای از مسئولیت‌های تعریف شده دارد. یک معماری لایه‌ای همچنین وابستگی‌ها را بین لایه‌ها محدود می‌کند. یک لایه فقط می‌تواند به لایه بلافاصله زیر آن (اگر لایه‌بندی سخت باشد) یا هر یک از لایه‌های زیر آن وابسته باشد.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0067_original/original_page.png" alt="Original Page 67">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>38</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p>شما می‌توانید معماری لایه‌ای را برای هر یک از چهار <strong>view</strong> که قبلاً مورد بحث قرار گرفتند، اعمال کنید. معماری سه‌لایه محبوب، معماری لایه‌ای است که برای <strong>logical view</strong> اعمال می‌شود. این کلاس‌های <strong>application</strong> را به لایه‌های زیر سازماندهی می‌کند:</p>
<ul>
<li>
    لایه <strong>Presentation</strong> - حاوی کدی است که <strong>user interface</strong> یا
    <strong>APIs</strong> خارجی را پیاده‌سازی می‌کند
   </li>
<li>لایه <strong>business logic</strong> - حاوی <strong>business logic</strong> است</li>
<li>لایه <strong>Persistence</strong>—منطق تعامل با پایگاه داده را پیاده‌سازی می‌کند</li>
</ul>
<p>معماری لایه‌ای یک مثال عالی از یک سبک معماری است، اما دارای معایب قابل توجهی است:</p>
<ul>
<li>لایه ارائه واحد - این واقعیت را نشان نمی‌دهد که یک <strong>application</strong> احتمالاً توسط بیش از یک سیستم فراخوانی می‌شود.</li>
<li>لایه <strong>persistence</strong> واحد - این واقعیت را نشان نمی‌دهد که یک <strong>application</strong> احتمالاً با بیش از یک پایگاه داده تعامل دارد.</li>
<li>لایه <strong>business logic</strong> را به عنوان وابسته به لایه <strong>persistence</strong> تعریف می‌کند - در تئوری، این وابستگی شما را از تست <strong>business logic</strong> بدون پایگاه داده باز می‌دارد.</li>
</ul>
<p>همچنین، معماری لایه‌ای وابستگی‌ها را در یک <strong>application</strong> خوش‌ساخت، اشتباه نشان می‌دهد. <strong>business logic</strong> معمولاً یک رابط یا یک مخزن از رابط‌ها را تعریف می‌کند که روش‌های دسترسی به داده را تعریف می‌کنند. لایه <strong>persistence</strong>، کلاس‌های
   <strong>DAO</strong> را تعریف می‌کند که رابط‌های مخزن را پیاده‌سازی می‌کنند. به عبارت دیگر، وابستگی‌ها معکوس چیزی هستند که توسط یک معماری لایه‌ای به تصویر کشیده شده است.
  </p>
<p>بیایید نگاهی به یک معماری جایگزین بیندازیم که بر این معایب غلبه می‌کند: معماری شش ضلعی.</p>
<p><strong>ABOUT THE HEXAGONAL ARCHITECTURE STYLE</strong></p>
<p>معماری شش ضلعی جایگزینی برای سبک معماری لایه‌ای است. همانطور که شکل 2.2 نشان می‌دهد، سبک معماری شش ضلعی، <strong>logical view</strong> را به گونه‌ای سازماندهی می‌کند که <strong>business logic</strong> را در مرکز قرار می‌دهد. <strong>application</strong> به جای لایه <strong>presentation</strong>، یک یا چند <strong>adapters</strong> <strong>inbound</strong> دارد که درخواست‌ها را از بیرون با فراخوانی <strong>business logic</strong> مدیریت می‌کنند. به طور مشابه، به جای یک لایه <strong>data persistence</strong>،
   <strong>application</strong> یک یا چند <strong>adapters</strong> <strong>outbound</strong> دارد که توسط <strong>business logic</strong> فراخوانی می‌شوند و <strong>applications</strong> خارجی را فراخوانی می‌کنند. یک ویژگی کلیدی و مزیت این معماری این است که
   <strong>business logic</strong> به آداپتورها وابسته نیست. در عوض، آن‌ها به آن وابسته هستند.
  </p>
<p><strong>business logic</strong> یک یا چند پورت دارد. یک پورت مجموعه‌ای از عملیات را تعریف می‌کند و این‌گونه <strong>business logic</strong> با آنچه در خارج از آن است تعامل دارد. به عنوان مثال، در
   <strong>Java</strong>، یک پورت اغلب یک رابط <strong>Java</strong> است. دو نوع پورت وجود دارد: پورت‌های <strong>inbound</strong> و
   <strong>outbound</strong>. یک پورت <strong>inbound</strong> یک <strong>API</strong> است که توسط <strong>business logic</strong> در معرض دید قرار گرفته است، که آن را قادر می‌سازد تا توسط <strong>applications</strong> خارجی فراخوانی شود. یک مثال از یک پورت <strong>inbound</strong>، یک رابط <strong>service</strong> است که متدهای عمومی یک <strong>service</strong> را تعریف می‌کند. یک پورت <strong>outbound</strong> نحوه فراخوانی سیستم‌های خارجی توسط <strong>business logic</strong> است. یک مثال از یک پورت خروجی، یک رابط مخزن است که مجموعه‌ای از عملیات دسترسی به داده‌ها را تعریف می‌کند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0068_original/original_page.png" alt="Original Page 68">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>39</p>
<p><strong>What is the microservice architecture exactly?</strong></p>
<p>اطراف <strong>business logic</strong>، آداپتورها قرار دارند. مانند <strong>ports</strong>، دو نوع آداپتور وجود دارد: <strong>inbound</strong> و
   <strong>outbound</strong>. یک آداپتور <strong>inbound</strong> درخواست‌ها را از دنیای بیرون با فراخوانی یک پورت <strong>inbound</strong> مدیریت می‌کند. یک مثال از یک آداپتور <strong>inbound</strong>، یک <strong>Spring MVC Controller</strong> است که یا مجموعه‌ای از
   <strong>REST endpoints</strong> یا مجموعه‌ای از صفحات وب را پیاده‌سازی می‌کند. مثال دیگر، یک <strong>client</strong> <strong>message broker</strong> است که در پیام‌ها مشترک می‌شود. چندین آداپتور <strong>inbound</strong> می‌توانند یک پورت <strong>inbound</strong> یکسان را فراخوانی کنند.
  </p>
<p>یک آداپتور <strong>outbound</strong>، یک پورت <strong>outbound</strong> را پیاده‌سازی می‌کند و درخواست‌ها را از
   <strong>business logic</strong> با فراخوانی یک <strong>application</strong> یا <strong>service</strong> خارجی مدیریت می‌کند. یک مثال از یک آداپتور <strong>outbound</strong>، یک کلاس <strong>data access object (DAO)</strong> است که عملیات دسترسی به یک پایگاه داده را پیاده‌سازی می‌کند. مثال دیگر می‌تواند یک کلاس پروکسی باشد که یک <strong>service</strong> از راه دور را فراخوانی می‌کند. آداپتورهای
   <strong>outbound</strong> می‌توانند رویدادها را نیز منتشر کنند.
  </p>
<p>یک مزیت مهم سبک معماری شش ضلعی این است که <strong>business logic</strong> را از منطق دسترسی به ارائه و داده‌ها در آداپتورها جدا می‌کند.
   <strong>business logic</strong> به منطق ارائه یا منطق دسترسی به داده وابسته نیست.
  </p>
<p><strong>Business logic</strong></p>
<p>مرورگر</p>
<p><strong>Message broker</strong></p>
<p>آداپتور <strong>Outbound</strong></p>
<p>پورت <strong>Outbound</strong></p>
<p>آداپتور <strong>Outbound</strong></p>
<p>پورت <strong>Inbound</strong></p>
<p>آداپتور <strong>Inbound</strong></p>
<p>آداپتور <strong>Inbound</strong></p>
<p>بعضی</p>
<p>کلاس <strong>controller</strong></p>
<p>پیام</p>
<p>مصرف‌کننده</p>
<p>رابط پیام‌رسانی</p>
<p><strong>Foo service</strong></p>
<p>رابط <strong>Repository</strong></p>
<p><strong>DAO</strong></p>
<p>پایگاه داده</p>
<p>تولیدکننده پیام</p>
<p>شکل 2.2</p>
<p>نمونه‌ای از یک معماری شش ضلعی، که از <strong>business logic</strong> و یک یا چند آداپتور که با سیستم‌های خارجی ارتباط برقرار می‌کنند، تشکیل شده است. <strong>business logic</strong> دارای یک یا چند پورت است. آداپتورهای <strong>inbound</strong>، که درخواست‌ها را از سیستم‌های خارجی مدیریت می‌کنند، یک پورت <strong>inbound</strong> را فراخوانی می‌کنند. یک آداپتور <strong>outbound</strong>، یک پورت <strong>outbound</strong> را پیاده‌سازی می‌کند و یک سیستم خارجی را فراخوانی می‌کند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0069_original/original_page.png" alt="Original Page 69">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>40</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p>به دلیل این تفکیک، تست <strong>business logic</strong> به صورت ایزوله بسیار آسان‌تر است. مزیت دیگر این است که معماری یک <strong>application</strong> مدرن را دقیق‌تر منعکس می‌کند. <strong>business logic</strong> را می‌توان از طریق آداپتورهای متعدد فراخوانی کرد، که هر کدام یک <strong>API</strong> یا <strong>UI</strong> خاص را پیاده‌سازی می‌کنند.
   <strong>business logic</strong> همچنین می‌تواند چندین آداپتور را فراخوانی کند، که هر کدام یک سیستم خارجی متفاوت را فراخوانی می‌کنند. معماری شش ضلعی یک راه عالی برای توصیف معماری هر <strong>service</strong> در یک معماری <strong>microservice</strong> است.
  </p>
<p>معماری لایه‌ای و شش ضلعی هر دو نمونه‌ای از سبک‌های معماری هستند. هر کدام بلوک‌های ساختمانی یک معماری را تعریف می‌کنند و محدودیت‌هایی را در روابط بین آن‌ها اعمال می‌کنند. معماری شش ضلعی و معماری لایه‌ای، به شکل یک معماری سه‌لایه، <strong>logical view</strong> را سازماندهی می‌کنند. بیایید اکنون معماری <strong>microservice</strong> را به عنوان یک سبک معماری تعریف کنیم که <strong>implementation view</strong> را سازماندهی می‌کند.</p>
<p>2.1.3</p>
<p><strong>The microservice architecture is an architectural style</strong></p>
<p>من در مورد مدل 4+1 و سبک‌های معماری بحث کرده‌ام، بنابراین اکنون می‌توانم معماری <strong>monolithic</strong> و <strong>microservice</strong> را تعریف کنم. هر دو سبک معماری هستند. معماری <strong>Monolithic</strong> یک سبک معماری است که <strong>implementation view</strong> را به عنوان یک مؤلفه واحد ساختار می‌دهد: یک فایل اجرایی یا
   <strong>WAR</strong> واحد. این تعریف چیزی در مورد <strong>views</strong> دیگر نمی‌گوید. به عنوان مثال، یک <strong>application monolithic</strong> می‌تواند یک <strong>logical view</strong> داشته باشد که بر اساس معماری شش ضلعی سازماندهی شده است.
  </p>
<p>معماری <strong>microservice</strong> نیز یک سبک معماری است. این <strong>implementation view</strong> را به عنوان مجموعه‌ای از مؤلفه‌های متعدد ساختار می‌دهد: فایل‌های اجرایی یا فایل‌های
   <strong>WAR</strong>. مؤلفه‌ها <strong>services</strong> هستند و کانکتورها، پروتکل‌های ارتباطی هستند که این <strong>services</strong> را قادر به همکاری می‌کنند. هر <strong>service</strong> معماری <strong>logical view</strong> خود را دارد، که معمولاً یک معماری شش ضلعی است. شکل 2.3 یک معماری <strong>microservice</strong> ممکن برای <strong>application</strong> <strong>FTGO</strong> را نشان می‌دهد. <strong>services</strong> در این معماری با قابلیت‌های تجاری، مانند مدیریت سفارش و مدیریت رستوران، مطابقت دارند.</p>
<p>در ادامه این فصل، منظور از قابلیت تجاری را شرح می‌دهم. کانکتورها بین <strong>services</strong> با استفاده از مکانیزم‌های ارتباط بین فرآیندی مانند <strong>REST APIs</strong> و پیام‌رسانی ناهمزمان پیاده‌سازی می‌شوند. فصل 3 در مورد ارتباط بین فرآیندی با جزئیات بیشتری بحث می‌کند.</p>
<p>الگو: معماری <strong>Monolithic</strong></p>
<p><strong>application</strong> را به عنوان یک مؤلفه قابل اجرا/قابل استقرار واحد ساختار دهید. به
   <a href="http://microservices.io/patterns/monolithic.html">http://microservices.io/patterns/ monolithic.html</a> مراجعه کنید.</p>
<p>الگو: معماری <strong>Microservice</strong></p>
<p><strong>application</strong> را به عنوان مجموعه‌ای از <strong>services loosely coupled</strong> و قابل استقرار به طور مستقل ساختار دهید. به
   <a href="http://microservices.io/patterns/microservices.html">http://microservices.io/patterns/microservices.html</a> مراجعه کنید.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0070_original/original_page.png" alt="Original Page 70">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>41</p>
<p><strong>What is the microservice architecture exactly?</strong></p>
<p>یک محدودیت کلیدی که توسط معماری <strong>microservice</strong> تحمیل می‌شود این است که <strong>services</strong>
<strong>loosely coupled</strong> هستند. در نتیجه، محدودیت‌هایی در مورد نحوه همکاری <strong>services</strong> وجود دارد.
  </p>
<p>برای توضیح این محدودیت‌ها، سعی می‌کنم اصطلاح <strong>service</strong> را تعریف کنم، توضیح دهم که <strong>loosely coupled</strong> بودن به چه معناست و به شما بگویم که چرا این موضوع مهم است.</p>
<p><strong>WHAT IS A SERVICE?</strong></p>
<p>یک <strong>service</strong> یک مؤلفه <strong>software</strong> مستقل و قابل استقرار است که عملکرد مفیدی را پیاده‌سازی می‌کند. شکل 2.4 نمای خارجی یک <strong>service</strong> را نشان می‌دهد، که در این مثال،
   <strong>Order Service</strong> است. یک <strong>service</strong> دارای یک <strong>API</strong> است که دسترسی <strong>clients</strong> خود را به عملکرد آن ارائه می‌دهد. دو نوع عملیات وجود دارد: دستورات و <strong>queries</strong>.
   <strong>API</strong> شامل دستورات، <strong>queries</strong> و رویدادها است. یک دستور، مانند
   <strong>createOrder()</strong>، اقدامات را انجام می‌دهد و داده‌ها را به‌روزرسانی می‌کند. یک <strong>query</strong>، مانند
   <strong>findOrderById()</strong>، داده‌ها را بازیابی می‌کند. یک <strong>service</strong> همچنین رویدادهایی مانند
   <strong>OrderCreated</strong> را منتشر می‌کند که توسط <strong>clients</strong> آن مصرف می‌شود.
  </p>
<p><strong>API</strong> یک <strong>service</strong>، پیاده‌سازی داخلی آن را کپسوله می‌کند. برخلاف یک <strong>monolith</strong>، یک <strong>developer</strong> نمی‌تواند کدی بنویسد که <strong>API</strong> آن را دور بزند. در نتیجه، معماری
   <strong>microservice</strong>، ماژولار بودن <strong>application</strong> را اعمال می‌کند.
  </p>
<p>هر <strong>service</strong> در معماری <strong>microservice</strong>، معماری و به‌طور بالقوه، <strong>technology stack</strong> خود را دارد. اما یک <strong>service</strong> معمولی دارای یک معماری شش ضلعی است.
   <strong>API</strong> آن توسط آداپتورهایی پیاده‌سازی می‌شود که با <strong>business logic service</strong> تعامل دارند. عملیات</p>
<p><strong>Amazon</strong></p>
<p><strong>SES</strong></p>
<p>آداپتور</p>
<p><strong>Twilio</strong></p>
<p>آداپتور</p>
<p><strong>Stripe</strong></p>
<p>آداپتور</p>
<p><strong>API Gateway</strong> درخواست‌ها را مسیریابی می‌کند</p>
<p>از <strong>applications mobile</strong> به <strong>services</strong>.</p>
<p><strong>Services</strong> دارای <strong>APIs</strong> هستند.</p>
<p>داده‌های یک <strong>service</strong> خصوصی است.</p>
<p><strong>Services</strong> مربوط به قابلیت‌های تجاری/</p>
<p>زیر دامنه‌های <strong>DDD</strong></p>
<p><strong>API</strong></p>
<p><strong>Gateway</strong></p>
<p>رستوران</p>
<p>وب <strong>UI</strong></p>
<p><strong>Order</strong></p>
<p><strong>Service</strong></p>
<p>پیک</p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p>مصرف‌کننده</p>
<p>رستوران</p>
<p>رستوران</p>
<p><strong>Service</strong></p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p><strong>Accounting</strong></p>
<p><strong>Service</strong></p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p>اطلاع‌رسانی</p>
<p><strong>Service</strong></p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p>آشپزخانه</p>
<p><strong>Service</strong></p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p>تحویل</p>
<p><strong>Service</strong></p>
<p><strong>REST</strong></p>
<p><strong>API</strong></p>
<p>شکل 2.3</p>
<p>یک معماری <strong>microservice</strong> ممکن برای <strong>application</strong> <strong>FTGO</strong>. شامل <strong>services</strong> متعددی است.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0071_original/original_page.png" alt="Original Page 71">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>42</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p>آداپتور، <strong>business logic</strong> را فراخوانی می‌کند، و آداپتورهای رویداد، رویدادهای منتشر شده توسط <strong>business logic</strong> را منتشر می‌کنند.
  </p>
<p>در فصل 12، زمانی که در مورد فناوری‌های استقرار بحث می‌کنم، خواهید دید که <strong>implementation view</strong> یک <strong>service</strong> می‌تواند اشکال متعددی داشته باشد. مؤلفه ممکن است یک فرآیند مستقل، یک <strong>web application</strong> یا یک بسته <strong>OSGI</strong> باشد که در یک <strong>container</strong> یا یک تابع ابری <strong>serverless</strong> اجرا می‌شود. با این حال، یک الزام اساسی این است که یک <strong>service</strong> دارای یک
   <strong>API</strong> است و به طور مستقل قابل استقرار است.
  </p>
<p><strong>WHAT IS LOOSE COUPLING?</strong></p>
<p>یک ویژگی مهم معماری <strong>microservice</strong> این است که <strong>services loosely coupled</strong> هستند (https://en.wikipedia.org/wiki/Loose_coupling). تمام تعامل با یک <strong>service</strong> از طریق
   <strong>API</strong> آن انجام می‌شود، که جزئیات پیاده‌سازی آن را کپسوله می‌کند. این امر <strong>implementation</strong> <strong>service</strong> را قادر می‌سازد تا بدون تأثیر بر <strong>clients</strong> آن، تغییر کند. <strong>Services loosely coupled</strong> برای بهبود ویژگی‌های زمان توسعه یک <strong>application</strong>، از جمله قابلیت نگهداری و قابلیت تست آن، کلیدی هستند. درک، تغییر و تست آن‌ها بسیار آسان‌تر است.
  </p>
<p>الزامی برای اینکه <strong>services</strong> <strong>loosely coupled</strong> باشند و فقط از طریق <strong>APIs</strong> با هم همکاری کنند، <strong>services</strong> را از برقراری ارتباط از طریق یک پایگاه داده منع می‌کند. شما باید با داده‌های پایدار یک <strong>service</strong> مانند فیلدهای یک کلاس رفتار کنید و آن‌ها را خصوصی نگه دارید. خصوصی نگه داشتن داده‌ها <strong>developer</strong> را قادر می‌سازد تا طرحواره پایگاه داده <strong>service</strong> خود را بدون نیاز به</p>
<p><strong>Order Service</strong></p>
<p>فراخوانی می‌کند</p>
<p>در رویدادها مشترک می‌شود</p>
<p><strong>Order service</strong></p>
<p><strong>client</strong></p>
<p>عملیات را تعریف می‌کند</p>
<p>هنگامی که داده‌ها تغییر می‌کنند، رویدادها را منتشر می‌کند</p>
<p>فرمان‌ها:</p>
<p><strong>createOrder()</strong></p>
<p>...</p>
<p><strong>Queries</strong>:</p>
<p><strong>findOrderbyId()</strong></p>
<p>...</p>
<p><strong>Order</strong></p>
<p>ناشر رویداد</p>
<p><strong>Service API</strong></p>
<p>سفارش ایجاد شد</p>
<p>سفارش لغو شد</p>
<p>شکل 2.4</p>
<p>یک <strong>service</strong> دارای یک <strong>API</strong> است که <strong>implementation</strong> را کپسوله می‌کند. <strong>API</strong> عملیات را تعریف می‌کند که توسط <strong>clients</strong> فراخوانی می‌شوند. دو نوع عملیات وجود دارد: دستورات داده‌ها را به‌روزرسانی می‌کنند، و <strong>queries</strong> داده‌ها را بازیابی می‌کنند. هنگامی که داده‌های آن تغییر می‌کند، یک <strong>service</strong> رویدادهایی را منتشر می‌کند که <strong>clients</strong> می‌توانند در آن‌ها مشترک شوند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0072_original/original_page.png" alt="Original Page 72">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>43</p>
<p><strong>What is the microservice architecture exactly?</strong></p>
<p>به دلیل این <strong>decoupling</strong>، تست <strong>business logic</strong> به صورت ایزوله بسیار آسان‌تر است. مزیت دیگر این است که معماری یک <strong>application</strong> مدرن را دقیق‌تر منعکس می‌کند.
   <strong>business logic</strong> را می‌توان از طریق آداپتورهای متعدد فراخوانی کرد، که هر کدام یک <strong>API</strong> یا <strong>UI</strong> خاص را پیاده‌سازی می‌کنند.</p>
<p><strong>WHAT IS LOOSE COUPLING?</strong></p>
<p>به اشتراک نگذاشتن جداول پایگاه داده نیز باعث بهبود جداسازی در زمان اجرا می‌شود. به عنوان مثال، این امر تضمین می‌کند که یک <strong>service</strong> نمی‌تواند قفل‌های پایگاه داده را نگه دارد که <strong>service</strong> دیگری را مسدود می‌کند. اما در ادامه، خواهید آموخت که یکی از معایب عدم اشتراک پایگاه‌های داده این است که حفظ سازگاری داده‌ها و <strong>querying</strong> در <strong>services</strong> پیچیده‌تر است.</p>
<p><strong>THE ROLE OF SHARED LIBRARIES</strong></p>
<p><strong>developers</strong> اغلب عملکرد را در یک کتابخانه (ماژول) بسته‌بندی می‌کنند تا بتواند توسط <strong>applications</strong> متعدد بدون تکرار کد استفاده شود. به هر حال، امروزه بدون مخازن <strong>Maven</strong> یا
   <strong>npm</strong> کجا خواهیم بود؟ ممکن است وسوسه شوید که از کتابخانه‌های مشترک در معماری <strong>microservice</strong> نیز استفاده کنید. در ظاهر، به نظر می‌رسد که یک راه خوب برای کاهش تکرار کد در <strong>services</strong> شما است. اما شما باید اطمینان حاصل کنید که به‌طور تصادفی وابستگی‌هایی بین <strong>services</strong> خود ایجاد نکنید.</p>
<p>به عنوان مثال، تصور کنید که <strong>services</strong> متعدد نیاز به به‌روزرسانی <strong>Order business object</strong> دارند. یک رویکرد این است که آن عملکرد را به عنوان یک کتابخانه بسته‌بندی کنید که توسط <strong>services</strong> متعدد استفاده می‌شود. از یک طرف، استفاده از یک کتابخانه، تکرار کد را حذف می‌کند. از سوی دیگر، در نظر بگیرید که چه اتفاقی می‌افتد وقتی الزامات به گونه‌ای تغییر می‌کنند که بر <strong>Order business object</strong> تأثیر می‌گذارد. شما باید همزمان آن
   <strong>services</strong> را دوباره بسازید و مستقر کنید. یک رویکرد بسیار بهتر این است که عملکردی را که احتمالاً تغییر می‌کند، مانند مدیریت سفارش، به عنوان یک <strong>service</strong> پیاده‌سازی کنید.
  </p>
<p>شما باید تلاش کنید تا از کتابخانه‌ها برای عملکردی استفاده کنید که بعید است تغییر کند. به عنوان مثال، در یک <strong>application</strong> معمولی، این منطقی نیست که هر <strong>service</strong> یک کلاس <strong>Money</strong> عمومی را پیاده‌سازی کند. در عوض، شما باید یک کتابخانه ایجاد کنید که توسط <strong>services</strong> استفاده می‌شود.</p>
<p><strong>THE SIZE OF A SERVICE IS MOSTLY UNIMPORTANT</strong></p>
<p>یک مشکل با اصطلاح <strong>microservice</strong> این است که اولین چیزی که می‌شنوید <strong>micro</strong> است. این نشان می‌دهد که یک <strong>service</strong> باید بسیار کوچک باشد. این در مورد سایر اصطلاحات مبتنی بر اندازه مانند <strong>miniservice</strong> یا
   <strong>nanoservice</strong> نیز صدق می‌کند. در واقعیت، اندازه یک متریک مفید نیست.</p>
<p>یک هدف بسیار بهتر این است که یک <strong>service</strong> خوش‌ساخت را به عنوان یک <strong>service</strong> تعریف کنید که توسط یک تیم کوچک با حداقل زمان <strong>lead</strong> و با حداقل همکاری با سایر تیم‌ها قابل توسعه باشد. از نظر تئوری، یک تیم ممکن است فقط مسئول یک <strong>service</strong> واحد باشد، بنابراین آن <strong>service</strong> به هیچ وجه <strong>micro</strong> نیست. برعکس، اگر یک <strong>service</strong> به یک تیم بزرگ نیاز دارد یا زمان زیادی برای تست می‌برد، احتمالاً منطقی است که تیم و <strong>service</strong> را تقسیم کنید. یا اگر به طور مداوم نیاز به تغییر یک <strong>service</strong> دارید، به دلیل تغییرات در سایر <strong>services</strong> یا اگر تغییراتی را در <strong>services</strong> دیگر ایجاد می‌کنید، این نشانه‌ای است که <strong>loosely coupled</strong> نیست. شما حتی ممکن است یک <strong>monolith</strong> توزیع شده بسازید.
  </p>
<p>معماری <strong>microservice</strong> یک <strong>application</strong> را به صورت مجموعه‌ای از <strong>services loosely coupled</strong> ساختار می‌دهد. در نتیجه، ویژگی‌های زمان توسعه را بهبود می‌بخشد - قابلیت نگهداری، قابلیت تست، قابلیت استقرار و غیره - و سازمان را قادر می‌سازد تا <strong>software</strong> بهتری را سریع‌تر توسعه دهد. همچنین مقیاس‌پذیری یک <strong>application</strong> را بهبود می‌بخشد، اگرچه این هدف اصلی نیست. برای توسعه یک معماری <strong>microservice</strong> برای <strong>application</strong> خود، باید <strong>services</strong> را شناسایی کرده و تعیین کنید که چگونه با هم همکاری می‌کنند. بیایید نگاهی بیندازیم که چگونه این کار را انجام دهیم.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0073_original/original_page.png" alt="Original Page 73">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>44</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p>برای پاسخ به این سؤال، ابتدا تعریف می‌کنم که منظور از عبارت معماری <strong>software</strong> چیست. پس از آن، من در مورد چگونگی چند بعدی بودن معماری یک <strong>application</strong> و اینکه چگونه می‌توان آن را با استفاده از مجموعه‌ای از <strong>views</strong> یا طرح‌ها بهتر توصیف کرد، بحث می‌کنم. سپس شرح می‌دهم که چرا معماری <strong>software</strong> مهم است زیرا بر ویژگی‌های کیفیت <strong>software application</strong> تأثیر می‌گذارد.</p>
<p>2.2</p>
<p><strong>Defining an application’s microservice architecture</strong></p>
<p>چگونه باید یک معماری <strong>microservice</strong> را تعریف کنیم؟ مانند هر تلاش توسعه <strong>software</strong>، نقاط شروع، الزامات مکتوب، به امید خدا، متخصصان <strong>domain</strong>، و احتمالاً یک <strong>application</strong> موجود است. مانند بسیاری از توسعه <strong>software</strong>، تعریف یک معماری بیشتر یک هنر است تا علم. این بخش یک فرآیند سه مرحله‌ای ساده را شرح می‌دهد، که در شکل 2.5 نشان داده شده است، برای تعریف معماری یک <strong>application</strong>. با این حال، مهم است به یاد داشته باشید که این فرآیندی نیست که بتوانید به‌طور مکانیکی دنبال کنید. احتمالاً تکراری خواهد بود و شامل خلاقیت زیادی می‌شود.</p>
<p>یک <strong>application</strong> برای رسیدگی به درخواست‌ها وجود دارد، بنابراین اولین قدم در تعریف معماری آن، تقطیر الزامات <strong>application</strong> به درخواست‌های کلیدی است. اما به جای توصیف درخواست‌ها از نظر فناوری‌های <strong>IPC</strong> خاصی مانند <strong>REST</strong> یا پیام‌رسانی، من از</p>
<p><strong>Order</strong></p>
<p><strong>Service</strong></p>
<p><strong>FTGO</strong></p>
<p><strong>FTGO</strong></p>
<p>رستوران</p>
<p><strong>Service</strong></p>
<p>آشپزخانه</p>
<p><strong>Service</strong></p>
<p>...</p>
<p><strong>Order</strong></p>
<p><strong>Service</strong></p>
<p>تکرار کنید</p>
<p><strong>verifyOrder()</strong></p>
<p>رستوران</p>
<p><strong>Service</strong></p>
<p>آشپزخانه</p>
<p><strong>Service</strong></p>
<p>الزامات عملکردی</p>
<p><strong>createOrder()</strong></p>
<p><strong>createTicket()</strong></p>
<p><strong>acceptOrder()</strong></p>
<p><strong>createOrder()</strong></p>
<p><strong>acceptOrder()</strong></p>
<p><strong>FTGO</strong></p>
<p>به عنوان یک مصرف‌کننده</p>
<p>من می‌خواهم یک سفارش ثبت کنم</p>
<p>بنابراین من می‌توانم ...</p>
<p><strong>createOrder()</strong></p>
<p><strong>acceptOrder()</strong></p>
<p>به عنوان یک رستوران</p>
<p>من می‌خواهم یک سفارش را بپذیرم</p>
<p>بنابراین من می‌توانم ...</p>
<p>مرحله 1: شناسایی عملیات سیستم</p>
<p>مرحله 2: شناسایی <strong>services</strong></p>
<p>مرحله 3: تعریف <strong>APIs service</strong> و همکاری‌ها</p>
<p>نقطه شروع الزامات است،</p>
<p>مانند داستان‌های کاربر.</p>
<p>یک عملیات سیستم نشان می‌دهد</p>
<p>یک درخواست خارجی.</p>
<p>شکل 2.5</p>
<p>یک فرآیند سه‌مرحله‌ای برای تعریف معماری <strong>microservice</strong> یک <strong>application</strong></p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0074_original/original_page.png" alt="Original Page 74">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>45</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p>تا حد انتزاعی‌تر عملیات سیستم. یک عملیات سیستم، انتزاعی از یک درخواست است که <strong>application</strong> باید آن را مدیریت کند. این یا یک دستور است که داده‌ها را به‌روزرسانی می‌کند، یا یک <strong>query</strong> که داده‌ها را بازیابی می‌کند. رفتار هر دستور بر اساس یک مدل <strong>domain</strong> انتزاعی تعریف می‌شود، که از الزامات نیز مشتق شده است. عملیات سیستم به سناریوهای معماری تبدیل می‌شوند که نحوه همکاری <strong>services</strong> را نشان می‌دهند.</p>
<p>قدم دوم در این فرآیند، تعیین تجزیه به <strong>services</strong> است. استراتژی‌های متعددی برای انتخاب وجود دارد. یک استراتژی، که منشأ آن در رشته معماری کسب‌وکار است، تعریف <strong>services</strong> متناظر با قابلیت‌های کسب‌وکار است. استراتژی دیگر این است که <strong>services</strong> را حول زیر دامنه‌های طراحی مبتنی بر <strong>domain</strong> (<strong>DDD</strong>) سازماندهی کنید. نتیجه نهایی <strong>services</strong> است که حول مفاهیم کسب‌وکار سازماندهی شده‌اند نه مفاهیم فنی.</p>
<p>قدم سوم در تعریف معماری <strong>application</strong>، تعیین <strong>API</strong> هر <strong>service</strong> است. برای انجام این کار، شما هر عملیات سیستمی را که در مرحله اول شناسایی شده است، به یک <strong>service</strong> اختصاص می‌دهید. یک <strong>service</strong> ممکن است یک عملیات را به طور کامل خود پیاده‌سازی کند. از طرف دیگر، ممکن است نیاز به همکاری با <strong>services</strong> دیگر داشته باشد. در این صورت، شما تعیین می‌کنید که چگونه <strong>services</strong> با هم همکاری می‌کنند، که معمولاً نیاز به پشتیبانی <strong>services</strong> از عملیات اضافی دارد.
   همچنین باید تصمیم بگیرید که از کدام یک از مکانیسم‌های <strong>IPC</strong> که در فصل 3 توضیح می‌دهم، برای پیاده‌سازی <strong>API</strong> هر <strong>service</strong> استفاده کنید.
  </p>
<p>چندین مانع برای تجزیه وجود دارد. اولین مورد، تأخیر شبکه است. ممکن است متوجه شوید که یک تجزیه خاص به دلیل رفت و برگشت‌های زیاد بین <strong>services</strong>، غیرعملی است. مانع دیگر برای تجزیه این است که ارتباط همزمان بین <strong>services</strong>، در دسترس بودن را کاهش می‌دهد. ممکن است لازم باشد از مفهوم <strong>services</strong> خود-محصور، که در فصل 3 توضیح داده شده است، استفاده کنید. مانع سوم، نیاز به حفظ سازگاری داده‌ها در <strong>services</strong> است. شما معمولاً باید از <strong>sagas</strong>، که در فصل 4 مورد بحث قرار می‌گیرند، استفاده کنید. مانع چهارم و نهایی برای تجزیه، کلاس‌های به اصطلاح <strong>god</strong> هستند، که در سراسر یک <strong>application</strong> استفاده می‌شوند. خوشبختانه، شما می‌توانید از مفاهیم طراحی مبتنی بر دامنه برای حذف کلاس‌های
   <strong>god</strong> استفاده کنید.
  </p>
<p>این بخش ابتدا نحوه شناسایی عملیات یک <strong>application</strong> را توضیح می‌دهد. پس از آن، ما به استراتژی‌ها و دستورالعمل‌هایی برای تجزیه یک <strong>application</strong> به <strong>services</strong> و موانع تجزیه و نحوه رسیدگی به آن‌ها نگاهی خواهیم انداخت. در نهایت، نحوه تعریف <strong>API</strong> هر <strong>service</strong> را توضیح خواهم داد.</p>
<p>2.2.1</p>
<p><strong>Identifying the system operations</strong></p>
<p>اولین قدم در تعریف معماری یک <strong>application</strong>، تعریف عملیات سیستم است. نقطه شروع، الزامات <strong>application</strong>، از جمله داستان‌های کاربر و سناریوهای کاربری مرتبط با آن‌ها (توجه داشته باشید که این‌ها با سناریوهای معماری متفاوت هستند) است. عملیات سیستم با استفاده از فرآیند دو مرحله‌ای نشان داده شده در شکل 2.6 شناسایی و تعریف می‌شوند. این فرآیند از فرآیند طراحی شی گرا در کتاب
   <strong>Applying UML and Patterns (Prentice Hall, 2004)</strong> اثر <strong>Craig Larman</strong> الهام گرفته شده است (به www.craiglarman.com/wiki/index.php?title=Book_Applying_UML_and_Patterns برای جزئیات مراجعه کنید). اولین گام، مدل <strong>domain</strong> سطح بالا را ایجاد می‌کند که شامل کلاس‌های کلیدی است
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0075_original/original_page.png" alt="Original Page 75">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>46</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p>عملیات سیستم را مشخص می‌کند. <strong>API</strong>، این عملیات را فراهم می‌کند. و یا مثال هایی را در خصوص ایجاد <strong>API</strong> می زند</p>
<p>به منظور نشان دادن آنچه این بخش در بر دارد، ابتدا نشان می‌دهد که چگونه یک <strong>application</strong> <strong>operations</strong> را شناسایی کنید. پس از آن، ما به استراتژی‌ها و دستورالعمل‌هایی برای تجزیه یک <strong>application</strong> به <strong>services</strong> و موانع تجزیه و چگونگی رسیدگی به آن‌ها نگاهی خواهیم انداخت. در نهایت، نحوه تعریف <strong>API</strong> هر <strong>service</strong> را توضیح خواهم داد.</p>
<p>2.2.1</p>
<p><strong>Identifying the system operations</strong></p>
<p>اولین قدم در تعریف معماری یک <strong>application</strong>، تعریف عملیات سیستم است. نقطه شروع، الزامات <strong>application</strong>، از جمله داستان‌های کاربر و سناریوهای کاربری مرتبط با آن‌ها است (توجه داشته باشید که این‌ها با سناریوهای معماری متفاوت هستند). عملیات سیستم با استفاده از فرآیند دو مرحله‌ای نشان داده شده در شکل 2.6 شناسایی و تعریف می‌شوند. این فرآیند از فرآیند طراحی شی گرا در کتاب
   <strong>Applying UML and Patterns (Prentice Hall, 2004)</strong> اثر
   <strong>Craig Larman</strong> الهام گرفته شده است (برای جزئیات به
   <a href="www.craiglarman.com/wiki/index.php?title=Book_Applying_UML_and_Patterns">www.craiglarman.com/wiki/index.php?title=Book_Applying_UML_and_Patterns</a> مراجعه کنید). اولین گام، مدل <strong>domain</strong> سطح بالا را ایجاد می‌کند.
  </p>
<p>این مدل <strong>domain</strong>، عمدتاً از اسم‌های داستان‌های کاربر مشتق می‌شود، و عملیات سیستم عمدتاً از فعل‌ها مشتق می‌شود. شما همچنین می‌توانید مدل <strong>domain</strong> را با استفاده از تکنیکی به نام <strong>Event Storming</strong> تعریف کنید، که در فصل 5 در مورد آن صحبت خواهم کرد.</p>
<p>رفتار هر عملیات سیستم بر اساس تأثیر آن بر یک یا چند <strong>domain objects</strong> و روابط بین آن‌ها توصیف می‌شود. یک عملیات سیستم می‌تواند
   <strong>domain objects</strong> را ایجاد، به‌روزرسانی یا حذف کند، و همچنین روابط بین آن‌ها را ایجاد یا از بین ببرد.
  </p>
<p>بیایید نگاهی بیندازیم که چگونه یک مدل <strong>domain</strong> سطح بالا را تعریف کنیم. پس از آن، عملیات سیستم را بر اساس مدل <strong>domain</strong> تعریف خواهم کرد.</p>
<p><strong>CREATING A HIGH-LEVEL DOMAIN MODEL</strong></p>
<p>اولین قدم در فرآیند تعریف عملیات سیستم، ترسیم یک مدل <strong>domain</strong> سطح بالا برای <strong>application</strong> است. توجه داشته باشید که این مدل <strong>domain</strong> بسیار ساده‌تر از چیزی است که در نهایت پیاده‌سازی خواهد شد. <strong>application</strong> حتی یک مدل <strong>domain</strong> واحد نخواهد داشت زیرا، همانطور که به زودی خواهید آموخت، هر <strong>service</strong> مدل <strong>domain</strong> خود را دارد. علیرغم اینکه یک ساده‌سازی شدید است، یک مدل <strong>domain</strong> سطح بالا در این مرحله مفید است زیرا واژگان را برای توصیف رفتار عملیات سیستم تعریف می‌کند.
  </p>
<p>یک مدل <strong>domain</strong> با استفاده از تکنیک‌های استاندارد مانند تجزیه و تحلیل اسم‌ها در داستان‌ها و سناریوها و صحبت با متخصصان <strong>domain</strong> ایجاد می‌شود. به عنوان مثال،</p>
<p>الزامات عملکردی</p>
<p><strong>FTGO</strong></p>
<p>به عنوان یک مصرف‌کننده</p>
<p>من می‌خواهم یک سفارش ثبت کنم</p>
<p>بنابراین من می‌توانم ...</p>
<p><strong>createOrder()</strong></p>
<p><strong>acceptOrder()</strong></p>
<p>به عنوان یک رستوران</p>
<p>من می‌خواهم یک سفارش را بپذیرم</p>
<p>بنابراین من می‌توانم ...</p>
<p>مرحله 2</p>
<p>مدل <strong>domain</strong> سطح بالا</p>
<p>مرحله 1</p>
<p>سفارش</p>
<p>نقشه به</p>
<p>عملیات سیستم بر اساس مدل <strong>domain</strong> تعریف می‌شوند.</p>
<p>مدل <strong>domain</strong> مشتق شده از</p>
<p>الزامات</p>
<p>رستوران</p>
<p>تحویل</p>
<p>شکل 2.6</p>
<p>عملیات سیستم از الزامات <strong>application</strong> با استفاده از یک فرآیند دو مرحله‌ای مشتق شده‌اند. اولین قدم ایجاد یک مدل <strong>domain</strong> سطح بالا است. قدم دوم تعریف عملیات سیستم است که بر اساس مدل <strong>domain</strong> تعریف شده‌اند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0076_original/original_page.png" alt="Original Page 76">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>47</p>
<p><strong>Defining an application’s microservice architecture</strong></p>
<p><strong>the Place Order story</strong>. ما می‌توانیم آن داستان را به سناریوهای کاربری متعددی از جمله این یکی گسترش دهیم:</p>
<p>با توجه به یک مصرف‌کننده</p>
<p>و یک رستوران</p>
<p>و یک آدرس/زمان تحویل که توسط آن رستوران قابل سرویس باشد</p>
<p>و یک سفارش کل که حداقل سفارش رستوران را برآورده کند</p>
<p>هنگامی که مصرف‌کننده سفارشی را برای رستوران ثبت می‌کند</p>
<p>سپس کارت اعتباری مصرف‌کننده مجاز است</p>
<p>و یک سفارش در حالت <strong>PENDING_ACCEPTANCE</strong> ایجاد می‌شود</p>
<p>و سفارش با مصرف‌کننده مرتبط است</p>
<p>و سفارش با رستوران مرتبط است</p>
<p>اسم‌ها در این سناریوی کاربر به وجود کلاس‌های مختلفی از جمله</p>
<p>مصرف‌کننده، سفارش، رستوران و <strong>CreditCard</strong> اشاره می‌کنند.</p>
<p>به طور مشابه، داستان
   <strong>Accept Order</strong> را می‌توان به یک سناریو مانند این گسترش داد:</p>
<p>با توجه به یک سفارش که در حالت <strong>PENDING_ACCEPTANCE</strong> است</p>
<p>و یک پیک که برای تحویل سفارش در دسترس است</p>
<p>هنگامی که یک رستوران سفارشی را با وعده آماده‌سازی تا یک زمان خاص می‌پذیرد</p>
<p>سپس وضعیت سفارش به <strong>ACCEPTED</strong> تغییر می‌کند</p>
<p>و <strong>promiseByTime</strong> سفارش به زمان وعده داده شده به‌روزرسانی می‌شود</p>
<p>و پیک برای تحویل سفارش منصوب می‌شود</p>
<p>این سناریو وجود کلاس‌های پیک و تحویل را پیشنهاد می‌کند. نتیجه نهایی پس از چند تکرار از تجزیه و تحلیل، یک مدل <strong>domain</strong> خواهد بود که، طبق انتظار، از آن کلاس‌ها و سایر موارد، مانند
   <strong>MenuItem</strong> و
   <strong>Address</strong>، تشکیل شده است. شکل 2.7 یک نمودار کلاس است که کلاس‌های کلیدی را نشان می‌دهد.</p>
<p>مصرف‌کننده</p>
<p>سفارش</p>
<p>حالت</p>
<p>...</p>
<p><strong>creditcardId</strong></p>
<p>...</p>
<p><strong>deliveryTime</strong></p>
<p>مقدار</p>
<p>نام</p>
<p>قیمت</p>
<p>خیابان 1</p>
<p>خیابان 2</p>
<p>شهر</p>
<p>ایالت</p>
<p>کد پستی</p>
<p>نام</p>
<p>...</p>
<p>در دسترس است</p>
<p>...</p>
<p>عرض جغرافیایی</p>
<p>طول جغرافیایی</p>
<p>رستوران</p>
<p>پیک</p>
<p>موقعیت مکانی</p>
<p>اطلاعات پرداخت</p>
<p>اطلاعات تحویل</p>
<p><strong>OrderLineItem</strong></p>
<p><strong>MenuItem</strong></p>
<p>آدرس</p>
<p>ثبت شده توسط</p>
<p>برای</p>
<p>منتسب به</p>
<p>با استفاده از پرداخت می‌شود</p>
<p>با استفاده از پرداخت می‌کند</p>
<p>شکل 2.7</p>
<p>کلاس‌های کلیدی در مدل <strong>domain</strong> <strong>FTGO</strong></p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0077_original/original_page.png" alt="Original Page 77">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>48</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p>مسئولیت‌های هر کلاس به شرح زیر است:</p>
<ul>
<li>مصرف‌کننده - مصرف‌کننده‌ای که سفارش می‌دهد.</li>
<li>سفارش - سفارشی که توسط یک مصرف‌کننده ثبت می‌شود. سفارش را توصیف و وضعیت آن را پیگیری می‌کند.</li>
<li><strong>OrderLineItem</strong>—یک آیتم خط از یک سفارش.</li>
<li><strong>DeliveryInfo</strong>—زمان و مکان تحویل یک سفارش.</li>
<li>رستوران - رستورانی که سفارش‌ها را برای تحویل به مصرف‌کنندگان آماده می‌کند.</li>
<li><strong>MenuItem</strong>—یک آیتم در منوی رستوران.</li>
<li>پیک - پیکی که سفارش‌ها را به مصرف‌کنندگان تحویل می‌دهد. این پیک، در دسترس بودن پیک و موقعیت مکانی فعلی آن‌ها را پیگیری می‌کند.</li>
<li>آدرس - آدرس یک مصرف‌کننده یا یک رستوران.</li>
<li>مکان - عرض جغرافیایی و طول جغرافیایی یک پیک.</li>
</ul>
<p>یک نمودار کلاس مانند نمودار موجود در شکل 2.7، یک جنبه از معماری یک <strong>application</strong> را نشان می‌دهد. اما این چیزی بیش از یک تصویر زیبا بدون سناریوها برای متحرک کردن آن نیست. مرحله بعدی تعریف عملیات سیستم است که با سناریوهای معماری مطابقت دارد.</p>
<p><strong>DEFINING SYSTEM OPERATIONS</strong></p>
<p>هنگامی که شما یک مدل <strong>domain</strong> سطح بالا را تعریف کردید، گام بعدی شناسایی درخواست‌هایی است که <strong>application</strong> باید مدیریت کند. جزئیات <strong>UI</strong> فراتر از محدوده این کتاب است، اما می‌توانید تصور کنید که در هر سناریوی کاربر، <strong>UI</strong> درخواست‌هایی را به <strong>business logic backend</strong> برای بازیابی و به‌روزرسانی داده‌ها ارسال می‌کند.
   <strong>FTGO</strong> در درجه اول یک <strong>application web</strong> است، به این معنی که اکثر درخواست‌ها مبتنی بر
   <strong>HTTP</strong> هستند، اما ممکن است برخی از <strong>clients</strong> از پیام‌رسانی استفاده کنند. بنابراین، به جای تعهد به یک پروتکل خاص، منطقی است که از مفهوم انتزاعی‌تر یک عملیات سیستم برای نشان دادن درخواست‌ها استفاده کنید.
  </p>
<p>دو نوع عملیات سیستم وجود دارد:</p>
<ul>
<li>دستورات - عملیات سیستمی که داده‌ها را ایجاد، به‌روزرسانی و حذف می‌کنند</li>
<li>پرسش‌ها - عملیات سیستمی که داده‌ها را می‌خوانند (پرس و جو)</li>
</ul>
<p>در نهایت، این عملیات سیستم با <strong>REST</strong>، <strong>RPC</strong> یا <strong>messaging endpoints</strong> مطابقت خواهند داشت، اما در حال حاضر انتزاعی فکر کردن در مورد آن‌ها مفید است. بیایید ابتدا برخی از دستورات را شناسایی کنیم.
  </p>
<p>یک نقطه شروع خوب برای شناسایی دستورات سیستم، تجزیه و تحلیل فعل‌ها در داستان‌ها و سناریوهای کاربر است. به عنوان مثال، داستان
   <strong>Place Order</strong> را در نظر بگیرید. این به وضوح نشان می‌دهد که سیستم باید یک عملیات
   <strong>Create Order</strong> ارائه دهد. بسیاری از داستان‌های دیگر به‌طور جداگانه به دستورات سیستم نگاشت می‌شوند. جدول 2.1 برخی از دستورات سیستم کلیدی را فهرست می‌کند.</p>
<p>جدول 2.1</p>
<p>دستورات سیستم کلیدی برای <strong>application</strong> <strong>FTGO</strong></p>
<p>بازیگر</p>
<p>داستان</p>
<p>دستور</p>
<p>شرح</p>
<p>مصرف‌کننده</p>
<p>ثبت سفارش</p>
<p><strong>createOrder()</strong></p>
<p>یک سفارش ایجاد می‌کند</p>
<p>رستوران</p>
<p>پذیرش سفارش</p>
<p><strong>acceptOrder()</strong></p>
<p>نشان می‌دهد که رستوران سفارش را پذیرفته است و متعهد به آماده‌سازی آن تا زمان مشخص‌شده است</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0078_original/original_page.png" alt="Original Page 78">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>49</p>
<p><strong>Defining an application’s microservice architecture</strong></p>
<p>مشخصاتی دارد که پارامترها، مقدار بازگشتی و رفتار آن را از نظر کلاس‌های مدل <strong>domain</strong> تعریف می‌کند. مشخصات رفتار شامل پیش‌شرط‌هایی است که باید هنگام فراخوانی عملیات درست باشند و شرایط پس از فراخوانی عملیات درست هستند. در اینجا، به عنوان مثال، مشخصات عملیات سیستم
   <strong>createOrder()</strong> آمده است:</p>
<p>پیش‌شرط‌ها، موارد داده شده را در سناریوی <strong>user</strong> <strong>Place Order</strong> که قبلاً توضیح داده شد، منعکس می‌کنند. پس از شرایط، <strong>thens</strong> از سناریو منعکس می‌شود. هنگامی که یک عملیات سیستم فراخوانی می‌شود، پیش‌شرط‌ها را تأیید می‌کند و اقدامات لازم برای درست کردن شرایط پس از آن را انجام می‌دهد.</p>
<p>در اینجا مشخصات عملیات سیستم
   <strong>acceptOrder()</strong> آمده است:</p>
<p>رستوران</p>
<p>سفارش آماده است</p>
<p>برای تحویل گرفتن</p>
<p><strong>noteOrderReadyForPickup()</strong></p>
<p>نشان می‌دهد که سفارش آماده</p>
<p>تحویل گرفتن است</p>
<p>پیک</p>
<p>به‌روزرسانی</p>
<p>موقعیت مکانی</p>
<p><strong>noteUpdatedLocation()</strong></p>
<p>موقعیت مکانی فعلی را به‌روز می‌کند</p>
<p>پیک</p>
<p>تحویل</p>
<p>تحویل گرفته شد</p>
<p><strong>noteDeliveryPickedUp()</strong></p>
<p>نشان می‌دهد که پیک</p>
<p>سفارش را تحویل گرفته است</p>
<p>پیک</p>
<p>تحویل</p>
<p>تحویل داده شد</p>
<p><strong>noteDeliveryDelivered()</strong></p>
<p>نشان می‌دهد که پیک</p>
<p>سفارش را تحویل داده است</p>
<p>عملیات</p>
<p><strong>createOrder (consumer id, payment method, delivery address, delivery time, restaurant id, order line items)</strong></p>
<p>بازگشت‌ها</p>
<p><strong>orderId</strong>، ...</p>
<p>پیش‌شرط‌ها</p>
<p>مصرف‌کننده وجود دارد و می‌تواند سفارش دهد.</p>
<p>آیتم‌های خط با آیتم‌های منوی رستوران مطابقت دارند.</p>
<p>آدرس و زمان تحویل می‌توانند توسط رستوران سرویس داده شوند.</p>
<p>شرایط پس از آن</p>
<p>کارت اعتباری مصرف‌کننده برای کل سفارش تأیید شد.</p>
<p>یک سفارش در حالت <strong>PENDING_ACCEPTANCE</strong> ایجاد شد.</p>
<p>عملیات</p>
<p><strong>acceptOrder(restaurantId, orderId, readyByTime)</strong></p>
<p>بازگشت‌ها</p>
<p>—</p>
<p>پیش‌شرط‌ها</p>
<p>وضعیت <strong>order.status</strong>، <strong>PENDING_ACCEPTANCE</strong> است.</p>
<p>یک پیک برای تحویل سفارش در دسترس است.</p>
<p>شرایط پس از آن</p>
<p>وضعیت <strong>order.status</strong> به <strong>ACCEPTED</strong> تغییر یافت.</p>
<p><strong>order.readyByTime</strong> به <strong>readyByTime</strong> تغییر یافت.</p>
<p>پیک برای تحویل سفارش منصوب شد.</p>
<p>جدول 2.1</p>
<p>دستورات سیستم کلیدی برای <strong>application</strong> <strong>FTGO</strong> (ادامه)</p>
<p>بازیگر</p>
<p>داستان</p>
<p>دستور</p>
<p>شرح</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0079_original/original_page.png" alt="Original Page 79">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>50</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p>پیش‌شرط‌ها و شرایط پس از آن، سناریوی کاربر را از قبل منعکس می‌کنند.</p>
<p>اکثر عملیات سیستم مرتبط با معماری، دستورات هستند. با این حال، گاهی اوقات، <strong>queries</strong>، که داده‌ها را بازیابی می‌کنند، نیز مهم هستند.</p>
<p>علاوه بر پیاده‌سازی دستورات، یک <strong>application</strong> باید <strong>queries</strong> را نیز پیاده‌سازی کند. <strong>queries</strong> اطلاعاتی را که کاربر برای تصمیم‌گیری به آن نیاز دارد، به <strong>UI</strong> ارائه می‌دهند. در این مرحله، ما یک طراحی
   <strong>UI</strong> خاص را برای <strong>application</strong> <strong>FTGO</strong> در نظر نداریم، اما به عنوان مثال، جریان زمانی که یک مصرف‌کننده یک سفارش را ثبت می‌کند، در نظر بگیرید:</p>
<p>1 کاربر آدرس و زمان تحویل را وارد می‌کند.</p>
<p>2 سیستم رستوران‌های موجود را نمایش می‌دهد.</p>
<p>3 کاربر رستوران را انتخاب می‌کند.</p>
<p>4 سیستم منو را نمایش می‌دهد.</p>
<p>5 کاربر مورد را انتخاب می‌کند و پرداخت می‌کند.</p>
<p>6 سیستم سفارش ایجاد می‌کند.</p>
<p>این سناریوی کاربر، <strong>queries</strong> زیر را پیشنهاد می‌کند:</p>
<ul>
<li>
<strong>findAvailableRestaurants(deliveryAddress, deliveryTime)</strong>—رستوران‌هایی را بازیابی می‌کند که می‌توانند به آدرس تحویل مشخص شده در زمان مشخص شده تحویل دهند
   </li>
<li>
<strong>findRestaurantMenu(id)</strong>—اطلاعاتی در مورد یک رستوران از جمله اقلام منو بازیابی می‌کند
   </li>
</ul>
<p>از بین دو <strong>queries</strong>،
   <strong>findAvailableRestaurants()</strong> احتمالاً از نظر معماری مهم‌ترین است. این یک <strong>query</strong> پیچیده است که شامل <strong>geosearch</strong> است. مؤلفه
   <strong>geosearch</strong> <strong>query</strong> شامل یافتن تمام نقاط - رستوران‌ها - است که در نزدیکی یک مکان - آدرس تحویل - قرار دارند. همچنین رستوران‌هایی را که زمانی که سفارش باید آماده و تحویل گرفته شود، فیلتر می‌کند. علاوه بر این، عملکرد بسیار مهم است، زیرا این
   <strong>query</strong> هر زمان که یک مصرف‌کننده بخواهد سفارشی را ثبت کند، اجرا می‌شود.
  </p>
<p>مدل <strong>domain</strong> سطح بالا و عملیات سیستم، آنچه را که <strong>application</strong> انجام می‌دهد، ثبت می‌کنند. آن‌ها به تعریف معماری <strong>application</strong> کمک می‌کنند. رفتار هر عملیات سیستم بر اساس مدل <strong>domain</strong> توصیف می‌شود. هر عملیات سیستم مهم، یک سناریوی مهم معماری را نشان می‌دهد که بخشی از توصیف معماری است.
  </p>
<p>پس از تعریف عملیات سیستم، گام بعدی شناسایی <strong>services</strong> <strong>application</strong> است. همانطور که قبلاً ذکر شد، یک فرآیند مکانیکی برای دنبال کردن وجود ندارد. با این حال، استراتژی‌های تجزیه مختلفی وجود دارد که می‌توانید از آن‌ها استفاده کنید. هر کدام از یک دیدگاه متفاوت به این مشکل حمله می‌کنند و از اصطلاحات خاص خود استفاده می‌کنند. اما با تمام استراتژی‌ها، نتیجه نهایی یکسان است: معماری متشکل از <strong>services</strong> که در درجه اول حول مفاهیم کسب‌وکار سازماندهی شده‌اند تا مفاهیم فنی.
  </p>
<p>بیایید به اولین استراتژی نگاهی بیندازیم که <strong>services</strong> را متناظر با قابلیت‌های کسب‌وکار تعریف می‌کند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0080_original/original_page.png" alt="Original Page 80">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>51</p>
<p><strong>Defining an application’s microservice architecture</strong></p>
<p>2.2.2</p>
<p><strong>Defining services by applying the Decompose by business capability pattern</strong></p>
<p>یک استراتژی برای ایجاد یک معماری <strong>microservice</strong>، تجزیه بر اساس قابلیت کسب‌وکار است. قابلیت کسب‌وکار، مفهومی از مدل‌سازی معماری کسب‌وکار است، چیزی است که یک کسب‌وکار برای ایجاد ارزش انجام می‌دهد. مجموعه قابلیت‌های یک کسب‌وکار معین به نوع کسب‌وکار بستگی دارد. به عنوان مثال، قابلیت‌های یک شرکت بیمه معمولاً شامل
   <strong>Underwriting</strong>، مدیریت ادعاها، صورتحساب، انطباق و غیره است. قابلیت‌های یک فروشگاه آنلاین شامل مدیریت سفارش، مدیریت موجودی، حمل و نقل و غیره است.
  </p>
<p><strong>BUSINESS CAPABILITIES DEFINE WHAT AN ORGANIZATION DOES</strong></p>
<p>قابلیت‌های کسب‌وکار یک سازمان، نشان‌دهنده کسب‌وکار یک سازمان است. آن‌ها به‌طور کلی ثابت هستند، برخلاف نحوه انجام کسب‌وکار یک سازمان، که در طول زمان تغییر می‌کند، گاهی اوقات به‌طور چشمگیر. این به‌ویژه امروزه، با استفاده سریع در حال رشد از فناوری برای خودکارسازی بسیاری از فرآیندهای تجاری، صادق است. به عنوان مثال، مدت زیادی نیست که شما چک‌ها را در بانک خود با تحویل آن‌ها به متصدی واریز می‌کردید. سپس امکان واریز چک با استفاده از دستگاه خودپرداز فراهم شد. امروزه شما می‌توانید به‌راحتی اکثر چک‌ها را با استفاده از تلفن هوشمند خود واریز کنید. همانطور که می‌بینید، قابلیت کسب‌وکار
   <strong>Deposit check</strong> ثابت باقی مانده است، اما روش انجام آن به‌طور چشمگیری تغییر کرده است.
  </p>
<p><strong>IDENTIFYING BUSINESS CAPABILITIES</strong></p>
<p>قابلیت‌های کسب‌وکار یک سازمان با تجزیه و تحلیل هدف، ساختار و فرآیندهای تجاری سازمان شناسایی می‌شوند. هر قابلیت کسب‌وکار را می‌توان به عنوان یک <strong>service</strong> در نظر گرفت، با این تفاوت که تجاری محور است تا فنی. مشخصات آن شامل مؤلفه‌های مختلفی از جمله ورودی‌ها، خروجی‌ها و توافق‌نامه‌های سطح <strong>service</strong> است.
   به عنوان مثال، ورودی یک قابلیت <strong>Underwriting Insurance</strong>، <strong>application</strong> مصرف‌کننده است و خروجی‌ها شامل تأیید و قیمت است.
  </p>
<p>یک قابلیت کسب‌وکار اغلب بر روی یک شی کسب‌وکار خاص متمرکز است. به عنوان مثال، شی کسب‌وکار
   <strong>Claim</strong>، کانون قابلیت مدیریت <strong>Claim</strong> است. یک قابلیت اغلب می‌تواند به زیر قابلیت‌ها تجزیه شود. به عنوان مثال، قابلیت مدیریت
   <strong>Claim</strong> دارای چندین زیر قابلیت است، از جمله مدیریت اطلاعات <strong>Claim</strong>، بررسی <strong>Claim</strong> و مدیریت پرداخت <strong>Claim</strong>.
  </p>
<p>تصور اینکه قابلیت‌های کسب‌وکار برای <strong>FTGO</strong> شامل موارد زیر است، دشوار نیست:</p>
<ul>
<li>مدیریت تأمین‌کننده</li>
<ul>
<li>مدیریت پیک - مدیریت اطلاعات پیک</li>
<li>مدیریت اطلاعات رستوران - مدیریت منوهای رستوران و سایر اطلاعات، از جمله مکان و ساعات کار</li>
</ul>
</ul>
<p>الگو: تجزیه بر اساس قابلیت کسب‌وکار</p>
<p>تعریف <strong>services</strong> متناظر با قابلیت‌های کسب‌وکار. به
   <a href="http://microservices.io/patterns/decomposition/decompose-by-business-capability.html">http://microservices.io/patterns/decomposition/decompose-by-business-capability.html</a> مراجعه کنید.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0081_original/original_page.png" alt="Original Page 81">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>52</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<ul>
<li>مدیریت مصرف‌کننده - مدیریت اطلاعات در مورد مصرف‌کنندگان</li>
<li>ثبت و تکمیل سفارش</li>
<ul>
<li>مدیریت سفارش - فعال کردن مصرف‌کنندگان برای ایجاد و مدیریت سفارشات</li>
<li>مدیریت سفارش رستوران - مدیریت آماده‌سازی سفارشات در رستوران</li>
</ul>
<li>لجستیک</li>
<ul>
<li>مدیریت در دسترس بودن پیک - مدیریت در دسترس بودن بی‌درنگ پیک‌ها برای تحویل سفارشات</li>
<li>مدیریت تحویل - تحویل سفارشات به مصرف‌کنندگان</li>
</ul>
<li>حسابداری</li>
<ul>
<li>حسابداری مصرف‌کننده - مدیریت صورتحساب مصرف‌کنندگان</li>
<li>حسابداری رستوران - مدیریت پرداخت‌ها به رستوران‌ها</li>
<li>حسابداری پیک - مدیریت پرداخت‌ها به پیک‌ها</li>
</ul>
<li>...</li>
</ul>
<p>قابلیت‌های سطح بالا شامل مدیریت تأمین‌کننده، مدیریت مصرف‌کننده، ثبت و تکمیل سفارش و حسابداری است. احتمالاً قابلیت‌های سطح بالای دیگری از جمله قابلیت‌های مرتبط با بازاریابی وجود خواهد داشت. اکثر قابلیت‌های سطح بالا به زیر قابلیت‌ها تجزیه می‌شوند. به عنوان مثال، ثبت و تکمیل سفارش به پنج زیر قابلیت تجزیه می‌شود.</p>
<p>یک جنبه جالب از این سلسله‌مراتب قابلیت این است که سه قابلیت مرتبط با رستوران وجود دارد: مدیریت اطلاعات رستوران، مدیریت سفارش رستوران و حسابداری رستوران. این به این دلیل است که آن‌ها سه جنبه بسیار متفاوت از عملیات رستوران را نشان می‌دهند.</p>
<p>بعداً به نحوه استفاده از قابلیت‌های کسب‌وکار برای تعریف <strong>services</strong> خواهیم پرداخت.</p>
<p><strong>FROM BUSINESS CAPABILITIES TO SERVICES</strong></p>
<p>هنگامی که قابلیت‌های کسب‌وکار را شناسایی کردید، سپس یک <strong>service</strong> برای هر قابلیت یا گروهی از قابلیت‌های مرتبط تعریف می‌کنید. شکل 2.8 نگاشت از قابلیت‌ها به <strong>services</strong> را برای <strong>application</strong> <strong>FTGO</strong> نشان می‌دهد. برخی از قابلیت‌های سطح بالا، مانند قابلیت حسابداری، به <strong>services</strong> نگاشت می‌شوند. در موارد دیگر، زیر قابلیت‌ها به <strong>services</strong> نگاشت می‌شوند.</p>
<p>تصمیم‌گیری در مورد اینکه کدام سطح از سلسله‌مراتب قابلیت را به <strong>services</strong> نگاشت کنید، تا حدودی ذهنی است. توجیه من برای این نگاشت خاص به شرح زیر است:</p>
<ul>
<li>من زیر قابلیت‌های مدیریت تأمین‌کننده را به دو <strong>services</strong> نگاشت کردم، زیرا رستوران‌ها و پیک‌ها انواع بسیار متفاوتی از تأمین‌کنندگان هستند.</li>
<li>من قابلیت ثبت و تکمیل سفارش را به سه <strong>services</strong> نگاشت کردم که هر کدام مسئول مراحل مختلف این فرآیند هستند. من قابلیت‌های مدیریت در دسترس بودن پیک و مدیریت تحویل را ترکیب کردم و آن‌ها را به یک <strong>service</strong> واحد نگاشت کردم زیرا عمیقاً در هم تنیده شده‌اند.</li>
<li>من قابلیت حسابداری را به <strong>service</strong> خود نگاشت کردم، زیرا انواع مختلف حسابداری مشابه به نظر می‌رسند.</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0082_original/original_page.png" alt="Original Page 82">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>53</p>
<p><strong>Defining an application’s microservice architecture</strong></p>
<p>بعداً، ممکن است جداسازی پرداخت‌ها (رستوران‌ها و پیک‌ها) و صورتحساب (مصرف‌کنندگان) منطقی باشد.
  </p>
<p>یک مزیت کلیدی سازماندهی <strong>services</strong> حول قابلیت‌ها این است که به دلیل ثابت بودن آن‌ها، معماری حاصل نیز نسبتاً پایدار خواهد بود. مؤلفه‌های فردی معماری ممکن است با تغییر جنبه نحوه کسب‌وکار، تکامل یابند، اما معماری بدون تغییر باقی می‌ماند.</p>
<p>با این حال، مهم است به یاد داشته باشید که <strong>services</strong> نشان داده شده در شکل 2.8، صرفاً اولین تلاش برای تعریف معماری هستند. آن‌ها ممکن است در طول زمان با یادگیری بیشتر در مورد <strong>domain</strong> <strong>application</strong>، تکامل یابند. به طور خاص، یک گام مهم در فرآیند تعریف معماری، بررسی نحوه همکاری <strong>services</strong> در هر یک از <strong>services</strong> معماری کلیدی است. به عنوان مثال، ممکن است کشف کنید که یک تجزیه خاص به دلیل ارتباط بین فرآیندی بیش از حد ناکارآمد است و شما باید <strong>services</strong> را ترکیب کنید. برعکس، یک <strong>service</strong> ممکن است در پیچیدگی برای
   <strong>Courier Service</strong></p>
<p>مدیریت پیک</p>
<p>مدیریت مصرف‌کننده</p>
<p>مدیریت تأمین‌کننده</p>
<p>سلسله‌مراتب قابلیت</p>
<p><strong>Services</strong></p>
<p>پیک‌ها و رستوران‌ها</p>
<p>انواع بسیار متفاوتی هستند</p>
<p>از تأمین‌کنندگان</p>
<p>=&gt; <strong>services</strong> متفاوت.</p>
<p>سه <strong>services</strong> مختلف</p>
<p>مدیریت مراحل مختلف</p>
<p>از گرفتن سفارش و تکمیل</p>
<p>پرداخت‌ها و حسابداری را فعلاً یکسان در نظر بگیرید.</p>
<p>رستوران</p>
<p><strong>Service</strong></p>
<p>مدیریت اطلاعات رستوران</p>
<p>سفارش</p>
<p><strong>Service</strong></p>
<p>مدیریت سفارش</p>
<p>ثبت و تکمیل سفارش</p>
<p>حسابداری</p>
<p>آشپزخانه</p>
<p><strong>Service</strong></p>
<p>مدیریت فیش سفارش رستوران</p>
<p>مصرف‌کننده</p>
<p><strong>Service</strong></p>
<p>خدمات تحویل</p>
<p>حسابداری مصرف‌کننده</p>
<p>حسابداری رستوران</p>
<p>حسابداری پیک</p>
<p><strong>Accounting Service</strong></p>
<p>لجستیک</p>
<p>مدیریت تحویل</p>
<p>مدیریت در دسترس بودن پیک</p>
<p>شکل 2.8</p>
<p>نگاشت قابلیت‌های کسب‌وکار <strong>FTGO</strong> به <strong>services</strong>. قابلیت‌ها در سطوح مختلف سلسله‌مراتب قابلیت‌ها به <strong>services</strong> نگاشت می‌شوند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0083_original/original_page.png" alt="Original Page 83">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>54</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p>نقطه‌ای که تقسیم آن به چندین <strong>services</strong> ارزشمند می‌شود. علاوه بر این، در بخش 2.2.5، من چندین مانع برای تجزیه را توصیف می‌کنم که ممکن است باعث شود شما تصمیم خود را دوباره بررسی کنید.</p>
<p>بیایید به راه دیگری برای تجزیه یک <strong>application</strong> که بر اساس طراحی مبتنی بر <strong>domain</strong> است، نگاهی بیندازیم.</p>
<p>2.2.3</p>
<p><strong>Defining services by applying the Decompose by subdomain pattern</strong></p>
<p><strong>DDD</strong>، همانطور که در کتاب عالی <strong>Domain-driven design</strong> اثر
   <strong>Eric Evans (Addison-Wesley Professional, 2003)</strong> توضیح داده شده است، یک رویکرد برای ساخت <strong>applications software</strong> پیچیده است که بر توسعه یک مدل <strong>domain</strong> شی‌گرا متمرکز است. یک مدل <strong>domain</strong>، دانش در مورد یک <strong>domain</strong> را در قالبی که می‌تواند برای حل مشکلات در آن <strong>domain</strong> استفاده شود، ثبت می‌کند. این واژگانی را که توسط تیم استفاده می‌شود، تعریف می‌کند، آنچه <strong>DDD</strong> آن را زبان همه‌جا می‌نامد. مدل <strong>domain</strong> به‌طور تنگاتنگی در طراحی و پیاده‌سازی <strong>application</strong> منعکس می‌شود. <strong>DDD</strong> دارای دو مفهوم است که هنگام اعمال معماری <strong>microservice</strong>، فوق‌العاده مفید هستند: زیر <strong>domains</strong> و
   <strong>bounded contexts</strong>.
  </p>
<p><strong>DDD</strong> کاملاً با رویکرد سنتی مدل‌سازی سازمانی که یک مدل واحد برای کل سازمان ایجاد می‌کند، متفاوت است. به عنوان مثال، در چنین مدلی، یک تعریف واحد از هر نهاد تجاری، مانند مشتری، سفارش و غیره وجود خواهد داشت. مشکل این نوع مدل‌سازی این است که وادار کردن بخش‌های مختلف یک سازمان به توافق بر سر یک مدل واحد، یک کار بزرگ است. همچنین، این بدان معناست که از دیدگاه یک بخش معین از سازمان، مدل برای نیازهای آن‌ها بیش از حد پیچیده است. علاوه بر این، مدل <strong>domain</strong> می‌تواند گیج‌کننده باشد زیرا بخش‌های مختلف سازمان ممکن است از یک اصطلاح برای مفاهیم مختلف یا اصطلاحات مختلف برای یک مفهوم یکسان استفاده کنند. <strong>DDD</strong> از این مشکلات با تعریف چندین مدل <strong>domain</strong>، که هر کدام دارای یک دامنه صریح هستند، اجتناب می‌کند.</p>
<p><strong>DDD</strong> یک مدل <strong>domain</strong> جداگانه برای هر زیر <strong>domain</strong> تعریف می‌کند. یک زیر <strong>domain</strong> بخشی از <strong>domain</strong> است، اصطلاح <strong>DDD</strong> برای فضای مشکل <strong>application</strong>. زیر <strong>domains</strong> با استفاده از همان رویکردی که برای شناسایی قابلیت‌های کسب‌وکار استفاده می‌شود، شناسایی می‌شوند: کسب‌وکار را تجزیه و تحلیل کنید و حوزه‌های مختلف تخصص را شناسایی کنید. نتیجه نهایی به احتمال زیاد زیر <strong>domains</strong>ی خواهد بود که شبیه قابلیت‌های کسب‌وکار هستند. نمونه‌هایی از زیر <strong>domains</strong> در <strong>FTGO</strong> شامل ثبت سفارش، مدیریت سفارش، مدیریت آشپزخانه، تحویل و امور مالی است. همانطور که می‌بینید، این زیر <strong>domains</strong> بسیار شبیه به قابلیت‌های کسب‌وکار هستند که قبلاً توضیح داده شد.
  </p>
<p>الگو: تجزیه بر اساس زیر <strong>domain</strong></p>
<p><strong>Define services</strong> متناظر با زیر <strong>domains DDD</strong>. به
   <a href="http://microservices.io/patterns/decomposition/decompose-by-subdomain.html">http://microservices.io/patterns/decomposition/decompose-by-subdomain.html</a> مراجعه کنید.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0084_original/original_page.png" alt="Original Page 84">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>55</p>
<p><strong>Defining an application’s microservice architecture</strong></p>
<p><strong>DDD</strong>، محدوده یک مدل <strong>domain</strong> را یک <strong>bounded context</strong> می‌نامد. یک <strong>bounded context</strong> شامل مصنوعات کدی است که مدل را پیاده‌سازی می‌کنند. هنگام استفاده از معماری <strong>microservice</strong>، هر <strong>bounded context</strong> یک <strong>service</strong> یا احتمالاً مجموعه‌ای از <strong>services</strong> است. ما می‌توانیم با اعمال <strong>DDD</strong> و تعریف یک <strong>service</strong> برای هر زیر <strong>domain</strong>، یک معماری <strong>microservice</strong> ایجاد کنیم. شکل 2.9 نشان می‌دهد که چگونه زیر <strong>domains</strong> به <strong>services</strong> نگاشت می‌شوند، که هر کدام مدل <strong>domain</strong> خود را دارند.</p>
<p><strong>DDD</strong> و معماری <strong>microservice</strong> تقریباً در یک راستا هستند. مفهوم
   <strong>DDD</strong> از زیر <strong>domains</strong> و <strong>bounded contexts</strong> به‌خوبی به <strong>services</strong> درون یک معماری <strong>microservice</strong> نگاشت می‌شود. همچنین، مفهوم تیم‌های مستقل <strong>microservice</strong> که <strong>services</strong> را در اختیار دارند، کاملاً با مفهوم
   <strong>DDD</strong> از اینکه هر مدل <strong>domain</strong> توسط یک تیم واحد مالکیت و توسعه داده می‌شود، همسو است. حتی بهتر از آن، همانطور که در ادامه این بخش توضیح می‌دهم، مفهوم یک زیر <strong>domain</strong> با مدل <strong>domain</strong> خود یک راه عالی برای حذف کلاس‌های <strong>god</strong> و در نتیجه آسان‌تر کردن تجزیه است.
  </p>
<p>تجزیه بر اساس زیر <strong>domain</strong> و تجزیه بر اساس قابلیت کسب‌وکار، دو الگوی اصلی برای تعریف معماری <strong>microservice application</strong> هستند. با این حال، برخی از دستورالعمل‌های مفید برای تجزیه وجود دارد که ریشه در طراحی شی گرا دارند. بیایید به آن‌ها نگاهی بیندازیم.</p>
<p><strong>Accounting Service</strong></p>
<p>حسابداری</p>
<p>مدل <strong>domain</strong></p>
<p><strong>Kitchen Service</strong></p>
<p>سرویس ....</p>
<p>زیر <strong>domain</strong> ثبت سفارش</p>
<p>نقشه به</p>
<p>نقشه به</p>
<p>نقشه به</p>
<p>نقشه به</p>
<p>نقشه به</p>
<p>مدیریت آشپزخانه</p>
<p>زیر <strong>domain</strong></p>
<p>حسابداری</p>
<p>زیر <strong>domain</strong></p>
<p>مدیریت تحویل</p>
<p>زیر <strong>domain</strong></p>
<p>....</p>
<p>زیر <strong>domain</strong></p>
<p>مدل <strong>domain</strong> آشپزخانه</p>
<p><strong>Delivery Service</strong></p>
<p>مدیریت تحویل</p>
<p>مدل <strong>domain</strong> تحویل</p>
<p><strong>Order Service</strong></p>
<p><strong>FTGO domain</strong></p>
<p>سفارش</p>
<p>مدل <strong>domain</strong></p>
<p>شکل 2.9</p>
<p>از زیر <strong>domains</strong> تا <strong>services</strong>: هر زیر <strong>domain</strong> از <strong>domain</strong> <strong>application</strong> <strong>FTGO</strong> به یک <strong>service</strong> نگاشت می‌شود، که مدل <strong>domain</strong> خود را دارد.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0085_original/original_page.png" alt="Original Page 85">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>56</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p>2.2.4</p>
<p><strong>Decomposition guidelines</strong></p>
<p>تاکنون در این فصل، ما به راه‌های اصلی تعریف معماری <strong>microservice</strong> نگاه کرده‌ایم. ما همچنین می‌توانیم از چند اصل از طراحی شی گرا هنگام اعمال الگوی معماری <strong>microservice</strong> استفاده کنیم و آن‌ها را تطبیق دهیم. این اصول توسط
   <strong>Robert C. Martin</strong> ایجاد شده و در کتاب کلاسیک او <strong>Designing Object Oriented C++ Applications Using The Booch Method (Prentice Hall, 1995)</strong> توضیح داده شده است. اولین اصل، اصل مسئولیت واحد (<strong>SRP</strong>) برای تعریف مسئولیت‌های یک کلاس است. اصل دوم، اصل بسته شدن مشترک (<strong>CCP</strong>) برای سازماندهی کلاس‌ها در بسته‌ها است. بیایید نگاهی به این اصول بیندازیم و ببینیم چگونه می‌توان آن‌ها را برای معماری <strong>microservice</strong> اعمال کرد.</p>
<p><strong>SINGLE RESPONSIBILITY PRINCIPLE</strong></p>
<p>یکی از اهداف اصلی معماری و طراحی <strong>software</strong>، تعیین مسئولیت‌های هر عنصر <strong>software</strong> است. اصل مسئولیت واحد به شرح زیر است:</p>
<p>یک کلاس باید فقط یک دلیل برای تغییر داشته باشد.</p>
<p><strong>Robert C. Martin</strong></p>
<p>هر مسئولیتی که یک کلاس دارد، یک دلیل بالقوه برای تغییر آن کلاس است. اگر یک کلاس دارای مسئولیت‌های متعددی باشد که به‌طور مستقل تغییر می‌کنند، کلاس پایدار نخواهد بود.
   با پیروی از <strong>SRP</strong>، شما کلاس‌هایی را تعریف می‌کنید که هر کدام یک مسئولیت واحد و از این رو یک دلیل واحد برای تغییر دارند.</p>
<p>ما می‌توانیم <strong>SRP</strong> را هنگام تعریف معماری <strong>microservice</strong> اعمال کنیم و <strong>services</strong> کوچک و منسجمی ایجاد کنیم که هر کدام یک مسئولیت واحد دارند. این امر اندازه <strong>services</strong> را کاهش می‌دهد و ثبات آن‌ها را افزایش می‌دهد. معماری جدید
   <strong>FTGO</strong> نمونه‌ای از <strong>SRP</strong> در عمل است. هر جنبه‌ای از رساندن غذا به یک مصرف‌کننده - ثبت سفارش، آماده‌سازی سفارش و تحویل - مسئولیت یک <strong>service</strong> جداگانه است.</p>
<p><strong>COMMON CLOSURE PRINCIPLE</strong></p>
<p>اصل مفید دیگر، اصل بسته شدن مشترک است:</p>
<p>کلاس‌های موجود در یک بسته باید در برابر انواع تغییرات یکسان بسته شوند. تغییری که بر یک بسته تأثیر می‌گذارد، بر تمام کلاس‌های موجود در آن بسته تأثیر می‌گذارد.</p>
<p><strong>Robert C. Martin</strong></p>
<p>ایده این است که اگر دو کلاس به دلیل یک دلیل اساسی یکسان، گام به گام تغییر کنند، آنگاه به یک بسته تعلق دارند. به عنوان مثال، شاید آن کلاس‌ها جنبه متفاوتی از یک قانون تجاری خاص را پیاده‌سازی کنند. هدف این است که وقتی آن قانون تجاری تغییر می‌کند، <strong>developers</strong> فقط باید کد را در تعداد کمی از بسته‌ها (در حالت ایده‌آل فقط یک) تغییر دهند. پایبندی به <strong>CCP</strong>، قابلیت نگهداری یک <strong>application</strong> را به میزان قابل توجهی بهبود می‌بخشد.</p>
<p>ما می‌توانیم <strong>CCP</strong> را هنگام ایجاد یک معماری <strong>microservice</strong> و بسته‌بندی مؤلفه‌هایی که به همین دلیل تغییر می‌کنند، در همان <strong>service</strong> اعمال کنیم. انجام این کار،</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0086_original/original_page.png" alt="Original Page 86">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>57</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p>تعداد <strong>services</strong> را که هنگام تغییر برخی از الزامات، باید تغییر داده و استقرار یابند، به حداقل می‌رساند. در حالت ایده‌آل، یک تغییر فقط بر یک تیم واحد و یک <strong>service</strong> واحد تأثیر می‌گذارد.
   <strong>CCP</strong> پادزهر الگوی ضد <strong>monolith</strong> توزیع شده است.</p>
<p><strong>SRP</strong> و
   <strong>CCP</strong> دو مورد از 11 اصلی هستند که توسط <strong>Bob Martin</strong> توسعه یافته‌اند. آن‌ها به‌ویژه هنگام توسعه یک معماری <strong>microservice</strong> مفید هستند. 9 اصل باقی‌مانده هنگام طراحی کلاس‌ها و بسته‌ها استفاده می‌شوند. برای اطلاعات بیشتر در مورد <strong>SRP</strong>،
   <strong>CCP</strong>، و سایر اصول <strong>OOD</strong>، مقاله "اصول طراحی شی‌گرا" را در وب‌سایت
   <strong>Bob Martin (http://butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod)</strong> ببینید.
  </p>
<p>تجزیه بر اساس قابلیت کسب‌وکار و بر اساس زیر <strong>domain</strong> همراه با <strong>SRP</strong> و <strong>CCP</strong> تکنیک‌های خوبی برای تجزیه یک <strong>application</strong> به <strong>services</strong> هستند. با این حال، برای اعمال آن‌ها و توسعه موفقیت‌آمیز یک معماری <strong>microservice</strong>، باید تعدادی از مسائل مدیریت تراکنش و ارتباط بین فرآیندی را حل کنید.</p>
<p>2.2.5</p>
<p><strong>Obstacles to decomposing an application into services</strong></p>
<p>در ظاهر، استراتژی ایجاد یک معماری <strong>microservice</strong> با تعریف <strong>services</strong> متناظر با قابلیت‌های کسب‌وکار یا زیر <strong>domains</strong>، سرراست به نظر می‌رسد. با این حال، ممکن است با موانع متعددی روبرو شوید:</p>
<ul>
<li>تأخیر شبکه</li>
<li>کاهش در دسترس بودن به دلیل ارتباط همزمان</li>
<li>حفظ سازگاری داده‌ها در <strong>services</strong></li>
<li>به دست آوردن یک <strong>view</strong> سازگار از داده‌ها</li>
<li>کلاس‌های <strong>god</strong> که از تجزیه جلوگیری می‌کنند</li>
</ul>
<p>بیایید به هر مانع نگاهی بیندازیم، با تأخیر شبکه شروع می‌کنیم.</p>
<p><strong>NETWORK LATENCY</strong></p>
<p>تأخیر شبکه یک نگرانی همیشگی در یک سیستم توزیع شده است. ممکن است کشف کنید که یک تجزیه خاص به <strong>services</strong> منجر به تعداد زیادی رفت و برگشت بین دو <strong>services</strong> می‌شود. گاهی اوقات، شما می‌توانید تأخیر را با پیاده‌سازی یک
   <strong>API</strong> <strong>batch</strong> برای واکشی چندین <strong>object</strong> در یک رفت و برگشت واحد، به مقدار قابل قبولی کاهش دهید. اما در موقعیت‌های دیگر، راه‌حل این است که <strong>services</strong> را ترکیب کنید، جایگزینی
   <strong>IPC</strong> گران‌قیمت با فراخوانی متد یا عملکرد در سطح زبان.
  </p>
<p><strong>SYNCHRONOUS INTERPROCESS COMMUNICATION REDUCES AVAILABILITY</strong></p>
<p>مشکل دیگر نحوه پیاده‌سازی ارتباط بین سرویس‌ها به گونه‌ای است که در دسترس بودن را کاهش نمی‌دهد. به عنوان مثال، سرراست‌ترین راه برای پیاده‌سازی عملیات
   <strong>createOrder()</strong> این است که <strong>Order Service</strong> به طور همزمان
   <strong>services</strong> دیگر را با استفاده از <strong>REST</strong> فراخوانی کند. اشکال استفاده از پروتکلی مانند
   <strong>REST</strong> این است که در دسترس بودن
   <strong>Order Service</strong> را کاهش می‌دهد. اگر هیچ یک از آن <strong>services</strong> دیگر در دسترس نباشند، نمی‌تواند یک سفارش ایجاد کند. گاهی اوقات این یک مصالحه ارزشمند است، اما در فصل 3 یاد خواهید گرفت که استفاده از پیام‌رسانی ناهمزمان، که اتصال تنگاتنگ را حذف می‌کند و در دسترس بودن را بهبود می‌بخشد، اغلب یک انتخاب بهتر است.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0087_original/original_page.png" alt="Original Page 87">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>58</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p><strong>MAINTAINING DATA CONSISTENCY ACROSS SERVICES</strong></p>
<p>چالش دیگر، حفظ سازگاری داده‌ها در <strong>services</strong> است. برخی از عملیات سیستم نیاز به به‌روزرسانی داده‌ها در چندین <strong>service</strong> دارند. به عنوان مثال، هنگامی که یک رستوران سفارشی را می‌پذیرد، به‌روزرسانی‌ها باید هم در
   <strong>Kitchen Service</strong> و هم در <strong>Delivery Service</strong> انجام شود.
   <strong>Kitchen Service</strong> وضعیت بلیط را تغییر می‌دهد.
   <strong>Delivery Service</strong> تحویل سفارش را برنامه‌ریزی می‌کند. هر دوی این به‌روزرسانی‌ها باید به‌طور اتمی انجام شوند.
  </p>
<p>راه‌حل سنتی استفاده از یک مکانیزم مدیریت تراکنش توزیع شده، مبتنی بر تعهد دو فاز (<strong>2PC</strong>) است. اما همانطور که در فصل 4 خواهید دید، این یک انتخاب خوب برای <strong>applications</strong> مدرن نیست، و شما باید از یک رویکرد بسیار متفاوت برای مدیریت تراکنش، یک <strong>saga</strong>، استفاده کنید. یک
   <strong>saga</strong> دنباله‌ای از <strong>transactions</strong> محلی است که با استفاده از پیام‌رسانی هماهنگ شده‌اند. <strong>Sagas</strong> پیچیده‌تر از <strong>transactions</strong> سنتی
   <strong>ACID</strong> هستند، اما در بسیاری از موقعیت‌ها خوب عمل می‌کنند. یک محدودیت <strong>sagas</strong> این است که آن‌ها در نهایت سازگار هستند. اگر نیاز به به‌روزرسانی داده‌ها به‌صورت اتمی دارید، باید در یک <strong>service</strong> واحد قرار گیرد که می‌تواند مانعی برای تجزیه باشد.
  </p>
<p><strong>OBTAINING A CONSISTENT VIEW OF THE DATA</strong></p>
<p>مانع دیگر برای تجزیه، عدم توانایی در به‌دست آوردن یک <strong>view</strong> واقعاً سازگار از داده‌ها در چندین پایگاه داده است. در یک <strong>application monolithic</strong>، ویژگی‌های <strong>transactions ACID</strong> تضمین می‌کنند که یک <strong>query</strong> یک <strong>view</strong> سازگار از پایگاه داده را برمی‌گرداند. در مقابل، در یک معماری <strong>microservice</strong>، حتی اگر پایگاه داده هر <strong>service</strong> سازگار باشد، شما نمی‌توانید یک <strong>view</strong> جهانی سازگار از داده‌ها به دست آورید. اگر به یک <strong>view</strong> سازگار از برخی از داده‌ها نیاز دارید، باید در یک <strong>service</strong> واحد قرار گیرد که می‌تواند از تجزیه جلوگیری کند. خوشبختانه، در عمل این به ندرت یک مشکل است.
  </p>
<p><strong>GOD CLASSES PREVENT DECOMPOSITION</strong></p>
<p>مانع دیگر برای تجزیه، وجود کلاس‌های به اصطلاح <strong>god</strong> است. کلاس‌های <strong>God</strong> کلاس‌های متورمی هستند که در سراسر یک <strong>application</strong> استفاده می‌شوند (http://wiki.c2.com/?GodClass). یک کلاس
   <strong>god</strong> معمولاً <strong>business logic</strong> را برای بسیاری از جنبه‌های مختلف <strong>application</strong> پیاده‌سازی می‌کند. معمولاً دارای تعداد زیادی فیلد است که به یک جدول پایگاه داده با ستون‌های زیادی نگاشت شده‌اند. اکثر <strong>applications</strong> حداقل یک کلاس از این کلاس‌ها را دارند که هر کدام نشان‌دهنده یک مفهوم هستند که برای <strong>domain</strong> مرکزی است: حساب‌ها در بانکداری، سفارشات در تجارت الکترونیک، سیاست‌ها در بیمه و غیره. از آنجایی که یک کلاس <strong>god</strong> حالت و رفتار را برای بسیاری از جنبه‌های مختلف یک <strong>application</strong> در کنار هم قرار می‌دهد، یک مانع غیرقابل عبور برای تقسیم هر <strong>business logic</strong> که از آن استفاده می‌کند به <strong>services</strong> است.</p>
<p>کلاس
   <strong>Order</strong> یک مثال عالی از یک کلاس <strong>god</strong> در <strong>application</strong> <strong>FTGO</strong> است. این تعجب‌آور نیست - به هر حال، هدف <strong>FTGO</strong> تحویل سفارشات غذا به مشتریان است. اکثر بخش‌های سیستم شامل سفارشات می‌شوند. اگر <strong>application</strong> <strong>FTGO</strong> یک مدل <strong>domain</strong> واحد داشت، کلاس
   <strong>Order</strong> یک کلاس بسیار بزرگ خواهد بود. دارای حالت و رفتاری خواهد بود که با بسیاری از بخش‌های مختلف <strong>application</strong> مطابقت دارد. شکل 2.10 ساختار این کلاس را نشان می‌دهد که با استفاده از تکنیک‌های مدل‌سازی سنتی ایجاد می‌شود.
  </p>
<p>همانطور که می‌بینید، کلاس <strong>Order</strong> دارای فیلدها و متدهایی است که با پردازش سفارش، مدیریت سفارش رستوران، تحویل و پرداخت‌ها مطابقت دارند. این کلاس همچنین به دلیل این واقعیت که یک مدل باید انتقالات حالت را توصیف کند، یک مدل حالت پیچیده دارد</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0088_original/original_page.png" alt="Original Page 88">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>59</p>
<p><strong>Defining an application’s microservice architecture</strong></p>
<p>از بخش‌های نامرتبط <strong>application</strong>. در شکل فعلی، این کلاس، تقسیم کد را به <strong>services</strong> بسیار دشوار می‌کند.</p>
<p>یک راه‌حل این است که کلاس <strong>Order</strong> را در یک کتابخانه بسته‌بندی کرده و یک پایگاه داده سفارش مرکزی ایجاد کنید. همه <strong>services</strong> که سفارشات را پردازش می‌کنند از این کتابخانه استفاده می‌کنند و به پایگاه داده دسترسی پیدا می‌کنند. مشکل این رویکرد این است که یکی از اصول کلیدی معماری <strong>microservice</strong> را نقض می‌کند و منجر به <strong>coupling</strong> نامطلوب و تنگاتنگ می‌شود. به عنوان مثال، هر تغییری در <strong>Order schema</strong>، مستلزم آن است که تیم‌ها کد خود را گام به گام به‌روزرسانی کنند.</p>
<p>راه‌حل دیگر این است که پایگاه داده <strong>Order</strong> را در یک <strong>Order Service</strong> محصور کنید، که توسط سایر <strong>services</strong> برای بازیابی و به‌روزرسانی سفارشات فراخوانی می‌شود. مشکل این طراحی این است که <strong>Order Service</strong> یک سرویس داده خواهد بود که دارای یک مدل <strong>domain</strong> ضعیف است که حاوی <strong>business logic</strong> کمی یا بدون <strong>business logic</strong> است. هیچ یک از این گزینه‌ها جذاب نیستند، اما خوشبختانه، <strong>DDD</strong> راه‌حلی ارائه می‌دهد.</p>
<p>یک رویکرد بسیار بهتر این است که <strong>DDD</strong> را اعمال کنید و با هر <strong>service</strong> به عنوان یک زیر <strong>domain</strong> جداگانه با مدل <strong>domain</strong> خود رفتار کنید. این بدان معنی است که هر یک از <strong>services</strong> در <strong>application</strong> <strong>FTGO</strong> که با سفارشات مرتبط است، مدل <strong>domain</strong> خود را با نسخه خود از کلاس <strong>Order</strong> دارد. یک مثال عالی از مزیت مدل‌های <strong>domain</strong> متعدد، <strong>Delivery Service</strong> است. <strong>view</strong> آن از یک سفارش، که در شکل 2.11 نشان داده شده است، بسیار ساده است: آدرس تحویل، زمان تحویل، آدرس تحویل و زمان تحویل. علاوه بر این، <strong>Delivery Service</strong> به جای اینکه آن را سفارش بنامد، از نام مناسب‌تری به نام تحویل استفاده می‌کند.
  </p>
<p>سفارش</p>
<p><strong>OrderLineItem</strong></p>
<p>آدرس</p>
<p>پیک</p>
<p>مصرف‌کننده</p>
<p>رستوران</p>
<p>اطلاعات پرداخت</p>
<p><strong>OrderTotal</strong></p>
<p><strong>deliveryTime</strong></p>
<p>وضعیت</p>
<p>&lt;&lt;تحویل&gt;&gt;</p>
<p><strong>pickupTime</strong></p>
<p>&lt;&lt;صورتحساب&gt;&gt;</p>
<p><strong>transactionid</strong></p>
<p>&lt;&lt;ثبت سفارش&gt;&gt;</p>
<p>ایجاد()</p>
<p>لغو()</p>
<p>&lt;&lt;رستوران&gt;&gt;</p>
<p>پذیرش()</p>
<p>رد()</p>
<p><strong>noteReadyForPickup()</strong></p>
<p>شکل 2.10</p>
<p>کلاس <strong>Order god</strong> با مسئولیت‌های متعددی متورم شده است.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0089_original/original_page.png" alt="Original Page 89">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>60</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p><strong>The Delivery Service</strong> به هیچ یک از ویژگی‌های دیگر یک سفارش علاقه‌ای ندارد.</p>
<p><strong>The Kitchen Service</strong> همچنین <strong>view</strong> بسیار ساده‌تری از یک سفارش دارد. نسخه آن از یک
   <strong>Order</strong>، یک <strong>Ticket</strong> نامیده می‌شود. همانطور که شکل 2.12 نشان می‌دهد، یک
   <strong>Ticket</strong> به سادگی شامل یک وضعیت، <strong>requestedDeliveryTime</strong>، یک <strong>prepareByTime</strong> و لیستی از آیتم‌های خطی است که به رستوران می‌گوید چه چیزی را آماده کند. به مصرف‌کننده، پرداخت، تحویل و غیره بی‌توجه است.</p>
<p><strong>Order service</strong> پیچیده‌ترین <strong>view</strong> از یک سفارش را دارد که در شکل 2.13 نشان داده شده است. حتی اگر تعداد کمی فیلد و متد داشته باشد، هنوز هم بسیار ساده‌تر از نسخه اصلی است.</p>
<p>کلاس
   <strong>Order</strong> در هر مدل <strong>domain</strong>، جنبه‌های مختلفی از یک موجودیت تجاری یکسان <strong>Order</strong> را نشان می‌دهد. <strong>application</strong> <strong>FTGO</strong> باید سازگاری را بین این <strong>objects</strong> مختلف در <strong>services</strong> مختلف حفظ کند. به عنوان مثال، هنگامی که <strong>Order Service</strong> تأیید کرده است</p>
<p>تحویل</p>
<p>آدرس تحویل</p>
<p>مکان تحویل</p>
<p>اختصاص داده شده به</p>
<p>پیک</p>
<p>وضعیت</p>
<p><strong>scheduledPickupTime</strong></p>
<p><strong>ScheduledDeliveryTime</strong></p>
<p>شکل 2.11</p>
<p>مدل <strong>domain</strong> <strong>Delivery Service</strong></p>
<p>بلیط</p>
<p>وضعیت</p>
<p><strong>requestedDeliveryTime</strong></p>
<p><strong>preparedByTime</strong></p>
<p><strong>TicketLineItem</strong></p>
<p>مقدار</p>
<p>مورد</p>
<p>شکل 2.12</p>
<p>مدل <strong>domain</strong> <strong>Kitchen Service</strong></p>
<p>سفارش</p>
<p><strong>OrderLineItem</strong></p>
<p>آدرس</p>
<p>مصرف‌کننده</p>
<p>رستوران</p>
<p>اطلاعات پرداخت</p>
<p><strong>status</strong></p>
<p><strong>orderTotal</strong></p>
<p><strong>deliveryTime</strong></p>
<p>...</p>
<p>شکل 2.13</p>
<p>مدل <strong>domain</strong> <strong>Order Service</strong></p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0090_original/original_page.png" alt="Original Page 90">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>61</p>
<p><strong>Defining an application’s microservice architecture</strong></p>
<p>کارت اعتباری مصرف‌کننده، باید ایجاد <strong>Ticket</strong> را در <strong>Kitchen Service</strong> فعال کند. به طور مشابه، اگر رستوران سفارش را از طریق <strong>Kitchen Service</strong> رد کند، باید در <strong>service Order Service</strong> لغو شود، و مشتری در <strong>service billing</strong> اعتبار دریافت کند. در فصل 4، شما یاد خواهید گرفت که چگونه سازگاری بین <strong>services</strong> را با استفاده از مکانیسم
   <strong>event-driven</strong> قبلاً ذکر شده، <strong>sagas</strong>، حفظ کنید.
  </p>
<p>علاوه بر ایجاد چالش‌های فنی، داشتن مدل‌های <strong>domain</strong> متعدد، بر پیاده‌سازی تجربه کاربر نیز تأثیر می‌گذارد. یک <strong>application</strong> باید بین تجربه کاربر، که مدل <strong>domain</strong> خود است، و مدل‌های <strong>domain</strong> هر یک از <strong>services</strong>، ترجمه کند. به عنوان مثال، در <strong>application</strong> <strong>FTGO</strong>، وضعیت سفارش نشان داده شده به یک مصرف‌کننده، از اطلاعات سفارش ذخیره شده در <strong>services</strong> متعدد مشتق شده است. این ترجمه اغلب توسط
   <strong>API gateway</strong> انجام می‌شود که در فصل 8 مورد بحث قرار می‌گیرد. علیرغم این چالش‌ها، ضروری است که کلاس‌های <strong>god</strong> را شناسایی و حذف کنید.
  </p>
<p>اکنون به نحوه تعریف
   <strong>APIs service</strong> نگاهی می‌اندازیم.
  </p>
<p>2.2.6</p>
<p><strong>Defining service APIs</strong></p>
<p>تاکنون، ما یک لیست از عملیات سیستم و لیستی از <strong>services</strong> بالقوه داریم. گام بعدی، تعریف <strong>API</strong> هر <strong>service</strong> است: عملیات و رویدادهای آن. یک عملیات <strong>API service</strong> به یکی از دو دلیل وجود دارد: برخی از عملیات‌ها با عملیات سیستم مطابقت دارند. آن‌ها توسط <strong>clients</strong> خارجی و احتمالاً توسط سایر <strong>services</strong> فراخوانی می‌شوند. عملیات‌های دیگر برای پشتیبانی از همکاری بین <strong>services</strong> وجود دارند. این عملیات‌ها فقط توسط سایر
   <strong>services</strong> فراخوانی می‌شوند.
  </p>
<p>یک <strong>service</strong> رویدادهایی را منتشر می‌کند که در درجه اول برای فعال کردن آن برای همکاری با سایر
   <strong>services</strong> استفاده می‌شود. فصل 4 توضیح می‌دهد که چگونه می‌توان از رویدادها برای پیاده‌سازی <strong>sagas</strong> استفاده کرد که سازگاری داده‌ها را در <strong>services</strong> حفظ می‌کنند. و فصل 7 در مورد چگونگی استفاده از رویدادها برای به‌روزرسانی <strong>CQRS views</strong>، که از <strong>querying</strong> کارآمد پشتیبانی می‌کنند، بحث می‌کند. یک <strong>application</strong> همچنین می‌تواند از رویدادها برای اطلاع‌رسانی به <strong>clients</strong> خارجی استفاده کند. به عنوان مثال، می‌توانست از <strong>WebSockets</strong> برای ارائه رویدادها به یک مرورگر استفاده کند.
  </p>
<p>نقطه شروع برای تعریف <strong>APIs service</strong>، نگاشت هر عملیات سیستم به یک <strong>service</strong> است. پس از آن، ما تصمیم می‌گیریم که آیا یک <strong>service</strong> برای پیاده‌سازی یک عملیات سیستم نیاز به همکاری با دیگران دارد یا خیر. اگر همکاری لازم باشد، ما سپس تعیین می‌کنیم که آن <strong>services</strong> دیگر برای پشتیبانی از همکاری، چه <strong>APIs</strong> باید ارائه دهند. بیایید با نگاهی به نحوه اختصاص عملیات سیستم به <strong>services</strong> شروع کنیم.</p>
<p><strong>ASSIGNING SYSTEM OPERATIONS TO SERVICES</strong></p>
<p>اولین قدم این است که تصمیم بگیرید کدام <strong>service</strong> نقطه ورود اولیه برای یک درخواست است. بسیاری از عملیات سیستم به‌طور مرتب به یک <strong>service</strong> نگاشت می‌شوند، اما گاهی اوقات نگاشت کمتر واضح است. به عنوان مثال، عملیات
   <strong>noteUpdatedLocation()</strong> را در نظر بگیرید، که موقعیت پیک را به‌روزرسانی می‌کند. از یک طرف، به دلیل ارتباط آن با پیک‌ها، این عملیات باید به <strong>service</strong> <strong>Courier</strong> اختصاص داده شود. از سوی دیگر، <strong>Delivery Service</strong> است که به موقعیت مکانی پیک نیاز دارد. در این مورد، اختصاص یک عملیات به یک <strong>service</strong> که به اطلاعات ارائه شده توسط عملیات نیاز دارد، انتخاب بهتری است. در موقعیت‌های دیگر،</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0091_original/original_page.png" alt="Original Page 91">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>62</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p>در موقعیت‌هایی که باید، ممکن است منطقی باشد که یک عملیات را به <strong>service</strong> اختصاص دهید که اطلاعات لازم برای رسیدگی به آن را دارد.
  </p>
<p>جدول 2.2 نشان می‌دهد که کدام <strong>services</strong> در <strong>application</strong> <strong>FTGO</strong> مسئول کدام عملیات هستند.</p>
<p>پس از اختصاص عملیات به <strong>services</strong>، گام بعدی این است که تصمیم بگیرید چگونه <strong>services</strong> برای مدیریت هر عملیات سیستم همکاری می‌کنند.</p>
<p><strong>DETERMINING THE APIS REQUIRED TO SUPPORT COLLABORATION BETWEEN SERVICES</strong></p>
<p>برخی از عملیات‌های سیستم به‌طور کامل توسط یک <strong>service</strong> واحد انجام می‌شوند. به عنوان مثال، در <strong>application</strong> <strong>FTGO</strong>، <strong>Consumer Service</strong> به‌طور کامل عملیات
   <strong>createConsumer()</strong> را انجام می‌دهد. اما سایر عملیات‌های سیستم، <strong>services</strong> متعدد را در بر می‌گیرند. به عنوان مثال، داده‌های مورد نیاز برای رسیدگی به یکی از این درخواست‌ها ممکن است در چندین <strong>service</strong> پراکنده باشد. به عنوان مثال، برای پیاده‌سازی عملیات
   <strong>createOrder()</strong>، <strong>Order Service</strong> باید <strong>services</strong> زیر را فراخوانی کند تا پیش‌شرط‌های آن را تأیید کرده و شرایط پس از آن را درست کند:</p>
<ul>
<li>
<strong>Consumer Service</strong>—تأیید کنید که مصرف‌کننده می‌تواند سفارش ثبت کند و اطلاعات پرداخت خود را دریافت کند.
   </li>
<li>
<strong>Restaurant Service</strong>—آیتم‌های خط سفارش را تأیید کنید، تأیید کنید که آدرس/زمان تحویل در محدوده سرویس رستوران قرار دارد، تأیید کنید که حداقل سفارش رعایت شده است و قیمت اقلام خط سفارش را دریافت کنید.
   </li>
<li><strong>Kitchen Service</strong>—ایجاد <strong>Ticket</strong>.</li>
<li><strong>Accounting Service</strong>—کارت اعتباری مصرف‌کننده را تأیید کنید.</li>
</ul>
<p>به طور مشابه، برای پیاده‌سازی عملیات سیستم
   <strong>acceptOrder()</strong>، <strong>Kitchen Service</strong> باید
   <strong>Delivery Service</strong> را فراخوانی کند تا یک پیک را برای تحویل سفارش برنامه‌ریزی کند.
  </p>
<p>جدول 2.3 <strong>services</strong>،
   <strong>APIs</strong> تجدیدنظر شده آن‌ها و همکارانشان را نشان می‌دهد. به منظور تعریف کامل <strong>APIs service</strong>، شما باید هر عملیات سیستم را تجزیه و تحلیل کنید و تعیین کنید که چه همکاری لازم است.</p>
<p>جدول 2.2</p>
<p>نگاشت عملیات سیستم به <strong>services</strong> در <strong>application</strong> <strong>FTGO</strong></p>
<p><strong>Service</strong></p>
<p>عملیات</p>
<p><strong>Consumer Service</strong></p>
<p><strong>createConsumer()</strong></p>
<p><strong>Order Service</strong></p>
<p><strong>createOrder()</strong></p>
<p>رستوران</p>
<p><strong>Service</strong></p>
<p><strong>findAvailableRestaurants()</strong></p>
<p>آشپزخانه</p>
<p><strong>Service</strong></p>
<p><strong>acceptOrder()</strong></p>
<p><strong>noteOrderReadyForPickup()</strong></p>
<p><strong>Delivery Service</strong></p>
<p><strong>noteUpdatedLocation()</strong></p>
<p><strong>noteDeliveryPickedUp()</strong></p>
<p><strong>noteDeliveryDelivered()</strong></p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0092_original/original_page.png" alt="Original Page 92">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>63</p>
<p><strong>Defining an application’s microservice architecture</strong></p>
<p>تاکنون، ما <strong>services</strong> و عملیاتی را که هر <strong>service</strong> پیاده‌سازی می‌کند، شناسایی کرده‌ایم. اما مهم است به یاد داشته باشید که معماری‌ای که ما ترسیم کرده‌ایم بسیار انتزاعی است. ما هیچ فناوری
   <strong>IPC</strong> خاصی را انتخاب نکرده‌ایم. علاوه بر این، حتی اگر اصطلاح عملیات نشان‌دهنده نوعی مکانیسم <strong>IPC</strong> مبتنی بر درخواست/پاسخ همزمان باشد، خواهید دید که پیام‌رسانی ناهمزمان نقش مهمی را ایفا می‌کند. در سراسر این کتاب، من مفاهیم معماری و طراحی را توصیف می‌کنم که بر نحوه همکاری این <strong>services</strong> تأثیر می‌گذارند.
  </p>
<p>فصل 3 فناوری‌های <strong>IPC</strong> خاصی را شامل می‌شود، از جمله مکانیزم‌های ارتباط همزمان مانند <strong>REST</strong>، و پیام‌رسانی ناهمزمان با استفاده از یک
   <strong>message broker</strong>. من در مورد چگونگی تأثیر ارتباط همزمان بر در دسترس بودن بحث می‌کنم و مفهوم یک <strong>service</strong> خود-محصور را معرفی می‌کنم، که سایر <strong>services</strong> را به صورت همزمان فراخوانی نمی‌کند. یک راه برای پیاده‌سازی یک
   <strong>service</strong> خود-محصور، استفاده از الگوی <strong>CQRS</strong> است که در فصل 7 پوشش داده شده است. به عنوان مثال، <strong>Order Service</strong> می‌تواند یک نسخه کپی از داده‌های متعلق به <strong>Restaurant Service</strong> را حفظ کند تا نیاز به فراخوانی همزمان
   <strong>Restaurant Service</strong> برای تأیید یک سفارش را از بین ببرد. این نسخه کپی را با اشتراک در رویدادهایی که توسط <strong>Restaurant Service</strong> منتشر می‌شوند، هر زمان که داده‌های خود را به‌روزرسانی می‌کند، به‌روز نگه می‌دارد.
  </p>
<p>فصل 4 مفهوم <strong>saga</strong> و نحوه استفاده از پیام‌رسانی ناهمزمان برای هماهنگی <strong>services</strong> را که در <strong>saga</strong> شرکت می‌کنند، معرفی می‌کند. و همچنین به‌طور قابل‌اطمینان به‌روزرسانی</p>
<p>جدول 2.3</p>
<p><strong>The services, their revised APIs, and their collaborators</strong></p>
<p><strong>Service</strong></p>
<p>عملیات</p>
<p>همکاران</p>
<p><strong>Consumer Service</strong></p>
<p><strong>verifyConsumerDetails()</strong></p>
<p>—</p>
<p><strong>Order Service</strong></p>
<p><strong>createOrder()</strong></p>
<p><strong>Consumer Service</strong></p>
<p><strong>verifyConsumerDetails()</strong></p>
<p>رستوران</p>
<p><strong>Service</strong></p>
<p><strong>verifyOrderDetails()</strong></p>
<p>آشپزخانه</p>
<p><strong>Service</strong></p>
<p><strong>createTicket()</strong></p>
<p><strong>Accounting Service</strong></p>
<p><strong>authorizeCard()</strong></p>
<p>رستوران</p>
<p><strong>Service</strong></p>
<p><strong>findAvailableRestaurants()</strong></p>
<p>—</p>
<p>آشپزخانه</p>
<p><strong>Service</strong></p>
<p><strong>acceptOrder()</strong></p>
<p><strong>noteOrderReadyForPickup()</strong></p>
<p>پیک</p>
<p><strong>Service</strong></p>
<p><strong>scheduleDelivery()</strong></p>
<p>پیک</p>
<p><strong>Service</strong></p>
<p><strong>scheduleDelivery()</strong></p>
<p><strong>noteUpdatedLocation()</strong></p>
<p><strong>noteDeliveryPickedUp()</strong></p>
<p><strong>noteDeliveryDelivered()</strong></p>
<p>—</p>
<p>حسابداری</p>
<p><strong>Service</strong></p>
<p><strong>authorizeCard()</strong></p>
<p>—</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0093_original/original_page.png" alt="Original Page 93">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>64</p>
<p>فصل 2</p>
<p><strong>Decomposition strategies</strong></p>
<p>داده‌ها در <strong>services</strong> متعدد، یک <strong>saga</strong> نیز راهی برای پیاده‌سازی یک <strong>service</strong> خود-محصور است. به عنوان مثال، من شرح می‌دهم که چگونه عملیات
   <strong>createOrder()</strong> با استفاده از یک <strong>saga</strong> پیاده‌سازی می‌شود، که <strong>services</strong>ی مانند
   <strong>Consumer Service</strong>،
   <strong>Kitchen Service</strong> و
   <strong>Accounting Service</strong> را با استفاده از پیام‌رسانی ناهمزمان فراخوانی می‌کند.
  </p>
<p>فصل 8 مفهوم یک <strong>API gateway</strong> را شرح می‌دهد که یک <strong>API</strong> را در معرض دید <strong>clients</strong> خارجی قرار می‌دهد. یک <strong>API gateway</strong> ممکن است یک عملیات <strong>query</strong> را با استفاده از الگوی ترکیب <strong>API</strong>، که در فصل 7 توضیح داده شد، پیاده‌سازی کند، نه اینکه صرفاً آن را به <strong>service</strong> هدایت کند. منطق موجود در <strong>API gateway</strong>، داده‌های مورد نیاز توسط <strong>query</strong> را با فراخوانی <strong>services</strong> متعدد و ترکیب نتایج جمع‌آوری می‌کند. در این موقعیت، عملیات سیستم به <strong>API gateway</strong> اختصاص داده می‌شود نه به یک <strong>service</strong>. <strong>Services</strong> باید عملیات <strong>query</strong> مورد نیاز توسط
   <strong>API gateway</strong> را پیاده‌سازی کنند.</p>
<p><strong>Summary</strong></p>
<ul>
<li>معماری، -<strong>ilities application</strong> شما، از جمله قابلیت نگهداری، قابلیت تست، و قابلیت استقرار را تعیین می‌کند که مستقیماً بر سرعت توسعه تأثیر می‌گذارد.</li>
<li>معماری <strong>microservice</strong> یک سبک معماری است که به یک <strong>application</strong> قابلیت نگهداری، قابلیت تست و قابلیت استقرار بالایی می‌دهد.</li>
<li><strong>Services</strong> در یک معماری <strong>microservice</strong> حول نگرانی‌های کسب‌وکار - قابلیت‌های کسب‌وکار یا زیر <strong>domains</strong> - و نه نگرانی‌های فنی سازماندهی می‌شوند.</li>
<li>دو الگو برای تجزیه وجود دارد:</li>
<ul>
<li>- تجزیه بر اساس قابلیت کسب‌وکار، که ریشه در معماری کسب‌وکار دارد</li>
<li>- تجزیه بر اساس زیر <strong>domain</strong>، بر اساس مفاهیم طراحی مبتنی بر <strong>domain</strong></li>
</ul>
<li>شما می‌توانید کلاس‌های <strong>god</strong> را حذف کنید، که باعث وابستگی‌های درهم می‌شوند که از تجزیه جلوگیری می‌کنند، با اعمال <strong>DDD</strong> و تعریف یک مدل <strong>domain</strong> جداگانه برای هر <strong>service</strong>.</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0094_original/original_page.png" alt="Original Page 94">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Interprocess communication</strong> در یک معماری microservice</h3>
<p>
   Mary و تیمش، مانند اکثر توسعه‌دهندگان دیگر، تجربه‌ای در مورد مکانیسم‌های <strong>inter-process communication</strong> (IPC) داشتند. اپلیکیشن FTGO دارای یک <strong>REST API</strong> است که توسط اپلیکیشن‌های موبایل و <strong>JavaScript</strong> سمت مرورگر استفاده می‌شود. همچنین از موارد مختلفی استفاده می‌کند.
  </p>
<p>
   این فصل موارد زیر را پوشش می‌دهد:
  </p>
<ul>
<li>
    اعمال الگوهای <strong>communication</strong>: <strong>Remote procedure invocation</strong>، <strong>Circuit breaker</strong>، <strong>Client-side discovery</strong>، <strong>Self registration</strong>، <strong>Server-side discovery</strong>، <strong>Third party registration</strong>، <strong>Asynchronous messaging</strong>، <strong>Transactional outbox</strong>، <strong>Transaction log tailing</strong>، <strong>Polling publisher</strong>
</li>
<li>
    اهمیت <strong>interprocess communication</strong> در یک معماری <strong>microservice</strong>
</li>
<li>
    تعریف و تکامل <strong>APIs</strong>
</li>
<li>
    گزینه‌های مختلف <strong>interprocess communication</strong> و مقایسه آن‌ها
   </li>
<li>
    مزایای سرویس‌هایی که با استفاده از <strong>asynchronous messaging</strong> ارتباط برقرار می‌کنند
   </li>
<li>
    ارسال قابل اطمینان پیام‌ها به عنوان بخشی از یک <strong>database transaction</strong>
</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0095_original/original_page.png" alt="Original Page 95">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
   cloud services، مانند سرویس پیام‌رسانی <strong>Twilio</strong> و سرویس پرداخت <strong>Stripe</strong>.
   اما در داخل یک اپلیکیشن <strong>monolithic</strong> مانند FTGO، ماژول‌ها از طریق
   متدهای سطح زبان یا فراخوانی‌های تابع، یکدیگر را فراخوانی می‌کنند. توسعه‌دهندگان FTGO عموماً نیازی ندارند که
   درباره <strong>IPC</strong> فکر کنند، مگر اینکه روی <strong>REST API</strong> یا ماژول‌هایی که با سرویس‌های cloud ادغام می‌شوند، کار می‌کنند.
  </p>
<p>
   در مقابل، همانطور که در فصل 2 دیدید، معماری <strong>microservice</strong> یک
   اپلیکیشن را به عنوان مجموعه‌ای از سرویس‌ها ساختار می‌دهد. آن سرویس‌ها اغلب باید برای
   رسیدگی به یک <strong>request</strong> با هم همکاری کنند. از آنجایی که نمونه‌های سرویس معمولاً فرآیندهایی هستند که روی چندین
   ماشین اجرا می‌شوند، آنها باید با استفاده از <strong>IPC</strong> تعامل داشته باشند. این نقش بسیار مهم‌تری را در یک
   معماری <strong>microservice</strong> نسبت به یک اپلیکیشن <strong>monolithic</strong> ایفا می‌کند. در نتیجه، به عنوان
   آنها اپلیکیشن خود را به <strong>microservices</strong> منتقل می‌کنند، Mary و بقیه توسعه‌دهندگان FTGO نیاز خواهند داشت تا زمان بیشتری را صرف کنند و درباره <strong>IPC</strong> فکر کنند.
  </p>
<p>
   هیچ کمبودی از مکانیسم‌های <strong>IPC</strong> برای انتخاب وجود ندارد. امروزه، انتخاب مرسوم
   <strong>REST</strong> (با <strong>JSON</strong>) است. با این حال، مهم است که به یاد داشته باشید که هیچ
   گلوله نقره‌ای وجود ندارد. شما باید گزینه‌ها را با دقت در نظر بگیرید. این فصل، گزینه‌های مختلف <strong>IPC</strong> را بررسی می‌کند، از جمله <strong>REST</strong> و پیام‌رسانی، و مقایسه آنها را مورد بحث قرار می‌دهد.
  </p>
<p>
   انتخاب مکانیسم <strong>IPC</strong> یک تصمیم معماری مهم است. این می‌تواند بر
   در دسترس بودن اپلیکیشن تأثیر بگذارد. علاوه بر این، همانطور که در این فصل و فصل بعدی توضیح می‌دهم، <strong>IPC</strong>
   حتی با مدیریت <strong>transaction</strong> تلاقی دارد. من معماری را ترجیح می‌دهم که شامل
   سرویس‌های <strong>loosely coupled</strong> است که با یکدیگر با استفاده از پیام‌رسانی <strong>asynchronous</strong> ارتباط برقرار می‌کنند. پروتکل‌های <strong>synchronous</strong> مانند <strong>REST</strong> بیشتر برای برقراری ارتباط با
   سایر اپلیکیشن‌ها استفاده می‌شوند.
  </p>
<p>
   من این فصل را با مروری بر <strong>interprocess communication</strong> در معماری <strong>microservice</strong> شروع می‌کنم. در مرحله بعد، من <strong>IPC</strong> مبتنی بر <strong>remote procedure invocation</strong> را توضیح می‌دهم، که
   <strong>REST</strong> محبوب‌ترین مثال آن است. من موضوعات مهمی از جمله <strong>service discovery</strong> و نحوه رسیدگی به <strong>partial failure</strong> را پوشش می‌دهم. پس از آن، من <strong>IPC</strong> مبتنی بر پیام‌رسانی <strong>asynchronous</strong> را توضیح می‌دهم. من همچنین در مورد مقیاس‌بندی <strong>consumers</strong> در حالی که ترتیب پیام‌ها را حفظ می‌کنم، رسیدگی صحیح به پیام‌های تکراری و پیام‌رسانی <strong>transactional</strong> صحبت می‌کنم. در نهایت، من
   مفهوم سرویس‌های <strong>self-contained</strong> را بررسی می‌کنم که <strong>requests synchronous</strong> را بدون ارتباط با سرویس‌های دیگر برای بهبود <strong>availability</strong>، مدیریت می‌کنند.
  </p>
<h4>3.1 Overview of interprocess communication in a microservice architecture</h4>
<p>
   گزینه‌های زیادی از فناوری‌های <strong>IPC</strong> برای انتخاب وجود دارد. سرویس‌ها می‌توانند از
   مکانیسم‌های ارتباطی مبتنی بر <strong>request/response synchronous</strong>، مانند <strong>HTTP-based REST</strong> یا <strong>gRPC</strong> استفاده کنند. متناوباً، آنها می‌توانند از مکانیسم‌های ارتباطی مبتنی بر پیام <strong>asynchronous</strong> مانند <strong>AMQP</strong> یا <strong>STOMP</strong> استفاده کنند. همچنین انواع مختلفی از فرمت‌های پیام وجود دارد. سرویس‌ها می‌توانند از فرمت‌های متنی، قابل خواندن برای انسان مانند <strong>JSON</strong>
   یا <strong>XML</strong> استفاده کنند. متناوباً، آنها می‌توانند از یک فرمت باینری کارآمدتر مانند <strong>Avro</strong> یا
   <strong>Protocol Buffers</strong> استفاده کنند.
  </p>
<p>
   قبل از پرداختن به جزئیات فناوری‌های خاص، می‌خواهم چندین
   مسئله طراحی را مطرح کنم که باید در نظر بگیرید. من این بخش را با بحثی در مورد تعامل شروع می‌کنم
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0096_original/original_page.png" alt="Original Page 96">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Overview of interprocess communication in a microservice architecture</h3>
<p>
   styles، که یک روش مستقل از فناوری برای توصیف نحوه تعامل کلاینت‌ها و سرویس‌ها
   هستند. در مرحله بعد، من در مورد اهمیت تعریف دقیق <strong>APIs</strong> در یک معماری <strong>microservice</strong> بحث می‌کنم، از جمله مفهوم طراحی <strong>API-first</strong>. پس از آن، من در مورد
   موضوع مهم تکامل <strong>API</strong> بحث می‌کنم. در نهایت، من گزینه‌های مختلفی را برای فرمت‌های پیام و نحوه تعیین سهولت تکامل <strong>API</strong> توسط آنها، مورد بحث قرار می‌دهم. بیایید با نگاهی به
   سبک‌های تعامل شروع کنیم.
  </p>
<h4>3.1.1 Interaction styles</h4>
<p>
   مفید است که ابتدا در مورد سبک تعامل بین یک سرویس و کلاینت‌هایش فکر کنید
   قبل از انتخاب یک مکانیسم <strong>IPC</strong> برای <strong>API</strong> یک سرویس. ابتدا فکر کردن در مورد
   سبک تعامل به شما کمک می‌کند تا روی الزامات تمرکز کنید و از گرفتار شدن در
   جزئیات یک فناوری <strong>IPC</strong> خاص اجتناب کنید. همچنین، همانطور که در بخش 3.4 توضیح داده شد، انتخاب
   سبک تعامل بر <strong>availability</strong> اپلیکیشن شما تأثیر می‌گذارد. علاوه بر این، همانطور که خواهید دید
   در فصل‌های 9 و 10، به شما کمک می‌کند تا استراتژی تست یکپارچه‌سازی مناسب را انتخاب کنید.
  </p>
<p>
   انواع مختلفی از سبک‌های تعامل <strong>client-service</strong> وجود دارد. همانطور که جدول 3.1 نشان می‌دهد، آنها می‌توانند
   در دو بعد طبقه‌بندی شوند. بعد اول این است که آیا تعامل
   یک به یک است یا یک به چند:
  </p>
<ul>
<li>
    یک به یک—هر <strong>client request</strong> دقیقاً توسط یک سرویس پردازش می‌شود.
   </li>
<li>
    یک به چند—هر <strong>request</strong> توسط چندین سرویس پردازش می‌شود.
   </li>
</ul>
<p>
   بعد دوم این است که آیا تعامل <strong>synchronous</strong> است یا <strong>asynchronous</strong>:
  </p>
<ul>
<li>
<strong>Synchronous</strong>—کلاینت انتظار یک پاسخ به موقع از سرویس را دارد و ممکن است
    حتی در حالی که منتظر است <strong>block</strong> شود.
   </li>
<li>
<strong>Asynchronous</strong>—کلاینت <strong>block</strong> نمی‌شود، و پاسخ، در صورت وجود، لزوماً ضروری نیست-
    بلافاصله ارسال می‌شود.
   </li>
</ul>
<p>
   موارد زیر انواع مختلفی از تعاملات یک به یک هستند:
  </p>
<ul>
<li>
<strong>Request/response</strong>—یک <strong>client service</strong> درخواستی را به یک سرویس ارسال می‌کند و منتظر است
    پاسخ. کلاینت انتظار دارد که پاسخ به موقع برسد. ممکن است
    حتی در حین انتظار <strong>block</strong> شود. این یک سبک تعامل است که عموماً منجر به
    سرویس‌هایی می‌شود که <strong>tightly coupled</strong> هستند.
   </li>
<li>
<strong>Asynchronous request/response</strong>—یک <strong>client service</strong> درخواستی را به یک سرویس ارسال می‌کند، که
    به صورت <strong>asynchronously</strong> پاسخ می‌دهد. کلاینت در حالی که منتظر است <strong>block</strong> نمی‌شود، زیرا سرویس
    ممکن است پاسخ را برای مدت طولانی ارسال نکند.
   </li>
</ul>
<p>
   جدول 3.1
  </p>
<p>
   انواع مختلف سبک‌های تعامل را می‌توان در دو بعد مشخص کرد: یک به یک در مقابل یک به
   چند و <strong>synchronous</strong> در مقابل <strong>asynchronous</strong>.
  </p>
<table>
<thead>
<tr>
<th>یک به یک</th>
<th>یک به چند</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Synchronous</strong></td>
<td><strong>Request/response</strong></td>
<td>—</td>
</tr>
<tr>
<td><strong>Asynchronous</strong></td>
<td><strong>Asynchronous request/response</strong></td>
<td><strong>One-way notifications</strong><br/><strong>Publish/subscribe</strong><br/><strong>Publish/async responses</strong></td>
</tr>
</tbody>
</table>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0097_original/original_page.png" alt="Original Page 97">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<ul>
<li>
<strong>One-way notifications</strong>—یک <strong>client service</strong> درخواستی را به یک سرویس ارسال می‌کند، اما هیچ پاسخی
    انتظار نمی‌رود یا ارسال نمی‌شود.
   </li>
</ul>
<p>
   مهم است که به یاد داشته باشید که سبک تعامل <strong>request/response synchronous</strong>
   بیشتر متعامد با فناوری‌های <strong>IPC</strong> است. به عنوان مثال، یک سرویس می‌تواند تعامل داشته باشد
   با سرویس دیگری با استفاده از تعامل سبک <strong>request/response</strong> با <strong>REST</strong> یا پیام‌رسانی.
   حتی اگر دو سرویس با استفاده از یک <strong>message broker</strong> ارتباط برقرار می‌کنند، سرویس کلاینت
   ممکن است منتظر پاسخ <strong>block</strong> شود. لزوماً به این معنی نیست که آنها
   <strong>loosely coupled</strong> هستند. این چیزی است که من بعداً در این فصل هنگام بحث در مورد تأثیر
   ارتباطات بین سرویس‌ها بر <strong>availability</strong>، دوباره به آن می‌پردازم.
  </p>
<p>
   موارد زیر انواع مختلفی از تعاملات یک به چند هستند:
  </p>
<ul>
<li>
<strong>Publish/subscribe</strong>—یک کلاینت یک پیام <strong>notification</strong> را منتشر می‌کند، که توسط
    صفر یا بیشتر سرویس‌های مورد علاقه، مصرف می‌شود.
   </li>
<li>
<strong>Publish/async responses</strong>—یک کلاینت یک پیام <strong>request</strong> را منتشر می‌کند و سپس منتظر می‌ماند
    به مدت معینی برای پاسخ از سرویس‌های مورد علاقه.
   </li>
</ul>
<p>
   هر سرویس معمولاً از ترکیبی از این سبک‌های تعامل استفاده می‌کند. بسیاری از
   سرویس‌ها در اپلیکیشن FTGO دارای <strong>APIs</strong> هم <strong>synchronous</strong> و هم <strong>asynchronous</strong> برای
   عملیات هستند، و بسیاری نیز رویدادها را منتشر می‌کنند.
  </p>
<p>
   بیایید نگاهی بیندازیم به نحوه تعریف <strong>API</strong> یک سرویس.
  </p>
<h4>3.1.2 Defining APIs in a microservice architecture</h4>
<p>
<strong>APIs</strong> یا <strong>interfaces</strong> برای توسعه نرم‌افزار ضروری هستند. یک اپلیکیشن شامل
   ماژول‌ها است. هر ماژول دارای یک <strong>interface</strong> است که مجموعه‌ای از عملیات را تعریف می‌کند که
   کلاینت‌های ماژول می‌توانند فراخوانی کنند. یک <strong>interface</strong> که به خوبی طراحی شده است، عملکرد مفیدی را در حالی که
   پیاده‌سازی را پنهان می‌کند، در معرض دید قرار می‌دهد. این به پیاده‌سازی این امکان را می‌دهد که بدون تأثیر
   بر کلاینت‌ها تغییر کند.
  </p>
<p>
   در یک اپلیکیشن <strong>monolithic</strong>، یک <strong>interface</strong> معمولاً با استفاده از یک برنامه
   ساختار زبان نویسی مانند یک <strong>Java interface</strong> مشخص می‌شود. یک <strong>Java interface</strong> مجموعه‌ای از
   متدها را مشخص می‌کند که یک کلاینت می‌تواند فراخوانی کند. کلاس پیاده‌سازی از کلاینت پنهان است.
   علاوه بر این، از آنجایی که جاوا یک زبان <strong>statically typed</strong> است، اگر <strong>interface</strong> به
   ناسازگار با کلاینت شود، اپلیکیشن کامپایل نخواهد شد.
  </p>
<p>
<strong>APIs</strong> و <strong>interfaces</strong> به همان اندازه در یک معماری <strong>microservice</strong> مهم هستند. یک
   <strong>API</strong> سرویس، یک قرارداد بین سرویس و کلاینت‌های آن است. همانطور که در فصل 2 توضیح داده شد،
   یک <strong>API</strong> سرویس شامل عملیات است، که کلاینت‌ها می‌توانند فراخوانی کنند، و رویدادها، که
   توسط سرویس منتشر می‌شوند. یک عملیات دارای نام، پارامترها و یک نوع بازگشتی است. یک
   رویداد دارای یک نوع و مجموعه‌ای از فیلدها است و، همانطور که در بخش 3.3 توضیح داده شد، به یک
   کانال پیام منتشر می‌شود.
  </p>
<p>
   چالش این است که یک <strong>API</strong> سرویس با استفاده از یک سازه زبان برنامه‌نویسی ساده تعریف نمی‌شود.
   طبق تعریف، یک سرویس و کلاینت‌های آن با هم کامپایل نمی‌شوند. اگر یک
   نسخه جدیدی از یک سرویس با یک <strong>API</strong> ناسازگار، مستقر شود، خطای کامپایل وجود ندارد.
   در عوض، شکست‌های زمان اجرا وجود خواهد داشت.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0098_original/original_page.png" alt="Original Page 98">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
   صرف نظر از اینکه کدام مکانیسم <strong>IPC</strong> را انتخاب می‌کنید، مهم است که <strong>API</strong> یک سرویس را با استفاده از نوعی <strong>interface definition language</strong> (<strong>IDL</strong>) دقیقاً تعریف کنید. علاوه بر این،
   دلایل خوبی برای استفاده از رویکرد <strong>API-first</strong> برای تعریف سرویس‌ها وجود دارد (به www
   .programmableweb.com/news/how-to-design-great-apis-api-first-design-and-raml/how-to/
   2015/07/10 مراجعه کنید). ابتدا تعریف <strong>interface</strong> را می‌نویسید. سپس تعریف <strong>interface</strong> را با توسعه‌دهندگان کلاینت بررسی می‌کنید. تنها پس از تکرار در تعریف <strong>API</strong>،
   سپس سرویس را پیاده‌سازی می‌کنید. انجام این طراحی پیش‌دستانه، شانس شما را برای ساختن سرویسی که نیازهای کلاینت‌هایش را برآورده می‌کند، افزایش می‌دهد.
  </p>
<p>
   ماهیت تعریف <strong>API</strong> بستگی به این دارد که از کدام مکانیسم <strong>IPC</strong> استفاده می‌کنید. برای
   به عنوان مثال، اگر از پیام‌رسانی استفاده می‌کنید، <strong>API</strong> شامل کانال‌های پیام، انواع پیام و فرمت‌های پیام است. اگر از <strong>HTTP</strong> استفاده می‌کنید، <strong>API</strong> شامل
   <strong>URLs</strong>، <strong>HTTP verbs</strong> و فرمت‌های <strong>request</strong> و <strong>response</strong> است. در ادامه این فصل،
   من نحوه تعریف <strong>APIs</strong> را توضیح می‌دهم.
  </p>
<p>
<strong>API</strong> یک سرویس به ندرت ثابت است. احتمالاً با گذشت زمان تکامل می‌یابد. بیایید نگاهی بیندازیم به
   چگونه این کار را انجام دهیم و مسائل پیش رو را در نظر بگیریم.
  </p>
<h4>3.1.3 Evolving APIs</h4>
<p>
<strong>APIs</strong> به ناچار با گذشت زمان تغییر می‌کنند زیرا ویژگی‌های جدید اضافه می‌شوند، ویژگی‌های موجود
   تغییر می‌کنند و (شاید) ویژگی‌های قدیمی حذف می‌شوند. در یک اپلیکیشن <strong>monolithic</strong>، این کار نسبتاً آسان است
   برای تغییر یک <strong>API</strong> و به‌روزرسانی همه <strong>callers</strong>. اگر از یک
   زبان <strong>statically typed</strong> استفاده می‌کنید، کامپایلر با ارائه لیستی از خطاهای کامپایل، کمک می‌کند.
   تنها چالش ممکن است دامنه تغییر باشد. ممکن است زمان زیادی طول بکشد تا یک
   <strong>API</strong> که به طور گسترده استفاده می‌شود، تغییر کند.
  </p>
<p>
   در یک اپلیکیشن مبتنی بر <strong>microservices</strong>، تغییر <strong>API</strong> یک سرویس بسیار بیشتر است
   دشوار است. کلاینت‌های یک سرویس، سرویس‌های دیگری هستند که اغلب توسط تیم‌های دیگر توسعه داده می‌شوند.
   کلاینت‌ها ممکن است حتی اپلیکیشن‌های دیگری در خارج از سازمان باشند. معمولاً
   نمی‌توانید همه کلاینت‌ها را مجبور کنید تا با سرویس <strong>lockstep</strong> ارتقا یابند. همچنین، به دلیل مدرن
   اپلیکیشن‌ها معمولاً هرگز برای نگهداری از کار نمی‌افتند، معمولاً یک <strong>rolling</strong>
<strong>upgrade</strong> از سرویس خود انجام خواهید داد، بنابراین نسخه‌های قدیمی و جدید یک سرویس اجرا خواهند شد
   همزمان.
  </p>
<p>
   داشتن یک استراتژی برای مقابله با این چالش‌ها مهم است. نحوه رسیدگی به
   تغییر <strong>API</strong> به ماهیت تغییر بستگی دارد.
  </p>
<p>
   طراحی <strong>API-first</strong> ضروری است
  </p>
<p>
   حتی در پروژه‌های کوچک، من دیده‌ام که مشکلات به دلیل عدم توافق اجزا بر سر
   یک <strong>API</strong> رخ می‌دهد. به عنوان مثال، در یک پروژه، توسعه‌دهنده <strong>backend</strong> جاوا و توسعه‌دهنده <strong>frontend</strong>
<strong>AngularJS</strong> هر دو گفتند که توسعه را تکمیل کرده‌اند. اپلیکیشن، چگونه-
   با این حال، کار نکرد. <strong>REST</strong> و <strong>WebSocket API</strong> که توسط اپلیکیشن <strong>frontend</strong> برای
   برقراری ارتباط با <strong>backend</strong>، به خوبی تعریف نشده بود. در نتیجه، دو اپلیکیشن
   نمی‌توانستند ارتباط برقرار کنند!
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0099_original/original_page.png" alt="Original Page 99">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
<strong>USE SEMANTIC VERSIONING</strong>
</p>
<p>
   مشخصات <strong>Semantic Versioning</strong> (http://semver.org) یک راهنمای مفید برای
   <strong>versioning APIs</strong> است. این مجموعه‌ای از قوانینی است که نحوه استفاده و افزایش اعداد نسخه را مشخص می‌کند.
   <strong>Semantic versioning</strong> در اصل برای <strong>versioning</strong> بسته‌های نرم‌افزاری در نظر گرفته شده بود، اما شما می‌توانید از آن برای
   <strong>versioning APIs</strong> در یک سیستم توزیع شده استفاده کنید.
  </p>
<p>
   مشخصات <strong>Semantic Versioning</strong> (<strong>Semvers</strong>) مستلزم این است که یک شماره نسخه از سه بخش تشکیل شود:
   <strong>MAJOR.MINOR.PATCH</strong>. شما باید هر بخش از شماره نسخه را به شرح زیر افزایش دهید:
  </p>
<ul>
<li>
<strong>MAJOR</strong>—هنگامی که یک تغییر <strong>incompatible</strong> در <strong>API</strong> ایجاد می‌کنید
   </li>
<li>
<strong>MINOR</strong>—هنگامی که پیشرفت‌های <strong>backward-compatible</strong> را در <strong>API</strong> ایجاد می‌کنید
   </li>
<li>
<strong>PATCH</strong>—هنگامی که یک رفع اشکال <strong>backward-compatible</strong> انجام می‌دهید
   </li>
</ul>
<p>
   چندین مکان وجود دارد که می‌توانید از شماره نسخه در یک <strong>API</strong> استفاده کنید. اگر شما
   در حال پیاده‌سازی یک <strong>REST API</strong> هستید، می‌توانید، همانطور که در زیر ذکر شد، از نسخه اصلی به عنوان
   اولین عنصر مسیر <strong>URL</strong> استفاده کنید. متناوباً، اگر شما در حال پیاده‌سازی یک سرویس هستید
   که از پیام‌رسانی استفاده می‌کند، می‌توانید شماره نسخه را در پیام‌هایی که ارسال می‌کند، قرار دهید.
   هدف این است که <strong>APIs</strong> را به درستی <strong>version</strong> کنید و آنها را به شیوه‌ای کنترل‌شده تکامل دهید. بیایید نگاهی بیندازیم به نحوه رسیدگی به تغییرات جزئی و اصلی.
  </p>
<p>
<strong>MAKING MINOR, BACKWARD-COMPATIBLE CHANGES</strong>
</p>
<p>
   در حالت ایده‌آل، شما باید تلاش کنید فقط تغییرات <strong>backward-compatible</strong> ایجاد کنید. <strong>Backward-</strong>
   تغییرات <strong>compatible</strong>، تغییرات افزایشی به یک <strong>API</strong> هستند:
  </p>
<ul>
<li>
    افزودن ویژگی‌های اختیاری به <strong>request</strong>
</li>
<li>
    افزودن ویژگی‌ها به یک <strong>response</strong>
</li>
<li>
    افزودن عملیات جدید
   </li>
</ul>
<p>
   اگر شما فقط این نوع تغییرات را ایجاد کنید، کلاینت‌های قدیمی‌تر با سرویس‌های جدیدتر کار خواهند کرد،
   به شرطی که آنها به اصل <strong>Robustness</strong> (https://en.wikipedia.org/wiki/
   <strong>Robustness_principle</strong>) عمل کنند، که بیان می‌کند: "در آنچه انجام می‌دهید محافظه‌کار باشید، در
   آنچه از دیگران می‌پذیرید لیبرال باشید." سرویس‌ها باید مقادیر پیش‌فرض را برای موارد از دست رفته ارائه دهند
   ویژگی‌های <strong>request</strong>. به طور مشابه، کلاینت‌ها باید هر ویژگی <strong>response</strong> اضافی را نادیده بگیرند. در
   به منظور اینکه این کار بدون دردسر انجام شود، کلاینت‌ها و سرویس‌ها باید از یک <strong>request</strong> و <strong>response</strong> استفاده کنند.
   فرمت <strong>format</strong> که از اصل <strong>Robustness</strong> پشتیبانی می‌کند. در ادامه این بخش، من توضیح می‌دهم که چگونه متن-
   فرمت‌های مبتنی بر <strong>JSON</strong> و <strong>XML</strong> به طور کلی تکامل <strong>APIs</strong> را آسان‌تر می‌کنند.
  </p>
<p>
<strong>MAKING MAJOR, BREAKING CHANGES</strong>
</p>
<p>
   گاهی اوقات شما باید تغییرات اصلی و <strong>incompatible</strong> در <strong>API</strong> ایجاد کنید. از آنجایی که شما نمی‌توانید
   کلاینت‌ها را مجبور کنید تا فوراً ارتقا پیدا کنند، یک سرویس باید همزمان از نسخه‌های قدیمی و
   نسخه‌های جدید یک <strong>API</strong> برای مدتی پشتیبانی کند. اگر شما از یک <strong>IPC</strong> مبتنی بر <strong>HTTP</strong> استفاده می‌کنید
   مکانیسم، مانند <strong>REST</strong>، یک رویکرد این است که شماره نسخه اصلی را در
   <strong>URL</strong> قرار دهید. به عنوان مثال، مسیرهای نسخه 1 با '/v1/…' و مسیرهای نسخه 2
   با '/v2/…' پیشوند می‌شوند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0100_original/original_page.png" alt="Original Page 100">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
   یک گزینه دیگر استفاده از مکانیسم مذاکره محتوای <strong>HTTP</strong> و شامل کردن
   شماره نسخه در نوع <strong>MIME</strong> است. به عنوان مثال، یک کلاینت نسخه 1.x را درخواست می‌کند
   از یک <strong>Order</strong> با استفاده از یک <strong>request</strong> مانند این:
  </p>
<pre>
   <code>
    GET /orders/xyz HTTP/1.1
    Accept: application/vnd.example.resource+json; version=1
    ...
   </code>
  </pre>
<p>
   این <strong>request</strong> به <strong>Order Service</strong> می‌گوید که کلاینت انتظار دارد یک <strong>response</strong> از نسخه 1.x دریافت کند.
  </p>
<p>
   به منظور پشتیبانی از چندین نسخه از یک <strong>API</strong>، <strong>adapters</strong> سرویس که
   <strong>APIs</strong> را پیاده‌سازی می‌کنند، شامل منطقی خواهند بود که بین نسخه‌های قدیمی و جدید ترجمه می‌کند.
   همچنین، همانطور که در فصل 8 توضیح داده شد، <strong>API gateway</strong> تقریباً مطمئناً از <strong>APIs</strong> نسخه‌بندی شده استفاده خواهد کرد.
   حتی ممکن است مجبور شود از چندین نسخه قدیمی‌تر یک <strong>API</strong> پشتیبانی کند.
  </p>
<p>
   اکنون به مسئله فرمت‌های پیام نگاه می‌کنیم، که انتخاب آنها می‌تواند بر چگونگی تأثیر بگذارد
   تکامل یک <strong>API</strong> آسان خواهد بود.
  </p>
<h4>3.1.4 Message formats</h4>
<p>
   اساس <strong>IPC</strong>، تبادل پیام‌ها است. پیام‌ها معمولاً حاوی داده هستند، بنابراین
   یک تصمیم طراحی مهم، قالب آن داده‌ها است. انتخاب فرمت پیام
   می‌تواند بر کارایی <strong>IPC</strong>، قابلیت استفاده <strong>API</strong> و تکامل‌پذیری آن تأثیر بگذارد. اگر شما
   از یک سیستم پیام‌رسانی یا پروتکل‌هایی مانند <strong>HTTP</strong> استفاده می‌کنید، باید فرمت پیام خود را انتخاب کنید. بعضی از
   مکانیسم‌های <strong>IPC</strong> - مانند <strong>gRPC</strong>، که به زودی درباره آن یاد خواهید گرفت - ممکن است
   فرمت پیام را دیکته کنید. در هر دو صورت، استفاده از یک <strong>cross-language</strong>، ضروری است.
   فرمت پیام. حتی اگر شما <strong>microservices</strong> خود را در یک زبان واحد امروزه می‌نویسید،
   احتمالاً در آینده از زبان‌های دیگر استفاده خواهید کرد. شما نباید، به عنوان مثال، استفاده کنید
   سریال‌سازی <strong>Java</strong>.
  </p>
<p>
   دو دسته اصلی از فرمت‌های پیام وجود دارد: متن و باینری. بیایید نگاهی بیندازیم به
   هر کدام.
  </p>
<p>
<strong>TEXT-BASED MESSAGE FORMATS</strong>
</p>
<p>
   اولین دسته، فرمت‌های متنی مانند <strong>JSON</strong> و <strong>XML</strong> است. یک مزیت از این
   فرمت‌ها این است که نه تنها برای انسان قابل خواندن هستند، بلکه خود توصیف‌گر نیز هستند. یک پیام <strong>JSON</strong>
   مجموعه‌ای از ویژگی‌های نام‌گذاری شده است. به طور مشابه، یک پیام <strong>XML</strong> در واقع یک
   مجموعه‌ای از عناصر و مقادیر نام‌گذاری شده است. این فرمت به مصرف‌کننده یک پیام این امکان را می‌دهد
   برای انتخاب مقادیر مورد علاقه و نادیده گرفتن بقیه. در نتیجه، بسیاری از تغییرات
   به <strong>schema</strong> پیام می‌تواند به راحتی <strong>backward-compatible</strong> باشد.
  </p>
<p>
   ساختار اسناد <strong>XML</strong> توسط یک <strong>XML schema</strong> (www.w3.org/
   <strong>XML/Schema</strong>) مشخص شده است. با گذشت زمان، جامعه توسعه‌دهندگان متوجه شده‌اند که <strong>JSON</strong> نیز
   به یک مکانیسم مشابه نیاز دارد. یک گزینه محبوب استفاده از استاندارد <strong>JSON Schema</strong> است
   (http://json-schema.org). یک <strong>JSON schema</strong> نام‌ها و انواع <strong>properties</strong> یک پیام را تعریف می‌کند و اینکه آیا
   آنها اختیاری هستند یا مورد نیاز. علاوه بر مفید بودن <strong>documentaion</strong>، یک <strong>JSON schema</strong> می‌تواند توسط یک اپلیکیشن برای اعتبارسنجی پیام‌های ورودی استفاده شود.
  </p>
<p>
   یک نکته منفی استفاده از فرمت‌های پیام مبتنی بر متن این است که پیام‌ها تمایل به
   مفصل بودن دارند، به خصوص <strong>XML</strong>. هر پیام سربار داشتن نام‌ها را دارد
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0101_original/original_page.png" alt="Original Page 101">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
   ویژگی‌های <strong>attributes</strong> علاوه بر مقادیرشان. نقطه ضعف دیگر سربار تجزیه
   متن، به خصوص زمانی که پیام‌ها بزرگ هستند، است. در نتیجه، اگر کارایی و عملکرد
   مهم هستند، ممکن است بخواهید از یک فرمت باینری استفاده کنید.
  </p>
<p>
<strong>BINARY MESSAGE FORMATS</strong>
</p>
<p>
   چندین فرمت باینری مختلف برای انتخاب وجود دارد. فرمت‌های محبوب شامل
   <strong>Protocol Buffers</strong> (https://developers.google.com/protocol-buffers/docs/overview)
   و <strong>Avro</strong> (https://avro.apache.org) هستند. هر دو فرمت یک <strong>typed IDL</strong> برای تعریف ارائه می‌دهند
   ساختار پیام‌های شما. سپس یک کامپایلر کدی را تولید می‌کند که پیام‌ها را سریال‌سازی و
   <strong>deserialize</strong> می‌کند. شما مجبور هستید که یک رویکرد <strong>API-first</strong> را در طراحی سرویس در نظر بگیرید! علاوه بر این، اگر
   شما کلاینت خود را در یک زبان <strong>statically typed</strong> بنویسید، کامپایلر بررسی می‌کند که
   به درستی از <strong>API</strong> استفاده می‌کند.
  </p>
<p>
   یک تفاوت بین این دو فرمت باینری این است که <strong>Protocol Buffers</strong> از
   <strong>tagged fields</strong> استفاده می‌کند، در حالی که یک مصرف‌کننده <strong>Avro</strong> برای <strong>inter</strong>-
   پیام‌ها را تفسیر می‌کند. در نتیجه، رسیدگی به تکامل <strong>API</strong> با <strong>Protocol Buffers</strong> آسان‌تر است
   تا با <strong>Avro</strong>. این پست وبلاگ (http://martin.kleppmann.com/2012/12/05/schema-
   <strong>evolution-in-avro-protocol-buffers-thrift.html</strong>) یک مقایسه عالی از <strong>Thrift</strong>،
   <strong>Protocol Buffers</strong> و <strong>Avro</strong> است.
  </p>
<p>
   اکنون که به فرمت‌های پیام نگاه کردیم، بیایید به مکانیسم‌های <strong>IPC</strong> خاص نگاهی بیندازیم
   که پیام‌ها را منتقل می‌کنند، با الگوی <strong>Remote procedure invocation</strong> (<strong>RPI</strong>) شروع می‌کنیم.
  </p>
<h4>3.2 Communicating using the synchronous Remote procedure invocation pattern</h4>
<p>
   هنگام استفاده از یک مکانیسم <strong>IPC</strong> مبتنی بر <strong>remote procedure invocation</strong>، یک کلاینت یک
   <strong>request</strong> را به یک سرویس ارسال می‌کند، و سرویس <strong>request</strong> را پردازش می‌کند و یک <strong>response</strong> را برمی‌گرداند.
   برخی از کلاینت‌ها ممکن است منتظر <strong>response block</strong> شوند، و دیگران ممکن است یک <strong>reactive, non-</strong>
   معماری <strong>blocking</strong> داشته باشند. اما برخلاف زمانی که از پیام‌رسانی استفاده می‌کنید، کلاینت فرض می‌کند که
   <strong>response</strong> به موقع خواهد رسید.
  </p>
<p>
   شکل 3.1 نحوه عملکرد <strong>RPI</strong> را نشان می‌دهد. منطق کسب‌وکار در کلاینت یک
   <strong>proxy interface</strong> را فراخوانی می‌کند، که توسط یک کلاس <strong>RPI proxy adapter</strong> پیاده‌سازی شده است. <strong>RPI proxy</strong> یک <strong>request</strong> را به
   سرویس ارسال می‌کند. <strong>request</strong> توسط یک کلاس <strong>RPI server adapter</strong> که منطق کسب‌وکار سرویس را از طریق یک <strong>interface</strong> فراخوانی می‌کند،
   مدیریت می‌شود. سپس یک <strong>reply</strong> به <strong>RPI proxy</strong> بازمی‌گرداند، که نتیجه را به منطق کسب‌وکار کلاینت برمی‌گرداند.
  </p>
<p>
<strong>proxy interface</strong> معمولاً پروتکل ارتباطی اساسی را کپسوله می‌کند.
   پروتکل‌های متعددی برای انتخاب وجود دارد. در این بخش، من <strong>REST</strong> را توصیف می‌کنم و
   الگو: <strong>Remote procedure invocation</strong>
</p>
<p>
   یک کلاینت با استفاده از یک پروتکل مبتنی بر <strong>synchronous, remote procedure invocation</strong>، مانند <strong>REST</strong> (http://microservices.io/patterns/communication-style/
   پیام‌رسانی.html) یک سرویس را فراخوانی می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0102_original/original_page.png" alt="Original Page 102">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Communicating using the synchronous Remote procedure invocation pattern</h3>
<p>
<strong>gRPC</strong>. من نحوه بهبود <strong>availability</strong> سرویس‌های شما با رسیدگی صحیح به
   <strong>partial failure</strong> را پوشش می‌دهم و توضیح می‌دهم که چرا یک اپلیکیشن مبتنی بر <strong>microservices</strong> که از <strong>RPI</strong> استفاده می‌کند، باید از یک مکانیسم <strong>service discovery</strong> استفاده کند.
  </p>
<p>
   بیایید ابتدا به <strong>REST</strong> نگاهی بیندازیم.
  </p>
<h4>3.2.1 Using REST</h4>
<p>
   امروزه، توسعه <strong>APIs</strong> به سبک <strong>RESTful</strong> مرسوم است (https://en.wikipedia
   .org/wiki/Representational_state_transfer). <strong>REST</strong> یک مکانیسم <strong>IPC</strong> است که (تقریباً
   همیشه) از <strong>HTTP</strong> استفاده می‌کند. Roy Fielding، سازنده <strong>REST</strong>، <strong>REST</strong> را به این صورت تعریف می‌کند:
  </p>
<p>
<strong>REST</strong> مجموعه‌ای از محدودیت‌های معماری را ارائه می‌دهد که، هنگامی که به طور کلی اعمال شوند،
   بر مقیاس‌پذیری تعاملات اجزا، کلیت رابط‌ها، استقرار مستقل
   اجزا، و اجزای واسطه برای کاهش تأخیر تعامل، اعمال امنیت و
   سیستم‌های قدیمی را محصور می‌کنند.
   www.ics.uci.edu/~fielding/pubs/dissertation/top.htm
  </p>
<p>
   یک مفهوم کلیدی در <strong>REST</strong>، یک <strong>resource</strong> است که معمولاً یک <strong>business</strong>
<strong>object</strong> واحد را نشان می‌دهد، مانند یک <strong>Customer</strong> یا <strong>Product</strong>، یا مجموعه‌ای از <strong>business objects</strong>. <strong>REST</strong>
   از <strong>HTTP verbs</strong> برای دستکاری <strong>resources</strong> استفاده می‌کند، که با استفاده از یک
   <strong>URL</strong> به آنها ارجاع داده می‌شود. به عنوان مثال، یک درخواست <strong>GET</strong>، نمایش یک <strong>resource</strong> را برمی‌گرداند، که
   اغلب در قالب یک سند <strong>XML</strong> یا <strong>JSON object</strong> است، اگرچه فرمت‌های دیگر
   مانند باینری می‌توانند استفاده شوند. یک <strong>POST request</strong> یک <strong>resource</strong> جدید ایجاد می‌کند و یک <strong>PUT</strong>
<strong>request</strong> یک <strong>resource</strong> را به‌روزرسانی می‌کند. به عنوان مثال، <strong>Order Service</strong> دارای یک <strong>POST /orders</strong>
<strong>endpoint</strong> برای ایجاد یک <strong>Order</strong> و یک <strong>GET /orders/{orderId} endpoint</strong> برای بازیابی
   یک <strong>Order</strong> است.
  </p>
<p>
   منطق کسب‌وکار
   فراخوانی می‌کند
   منطق کسب‌وکار
   <strong>Proxy interface</strong>
<strong>Service interface</strong>
   کلاینت
   سرویس
   <strong>RPI</strong>
<strong>proxy</strong>
<strong>Request</strong>
<strong>Reply</strong>
<strong>RPI</strong>
<strong>server</strong>
</p>
<p>
   شکل 3.1
  </p>
<p>
   منطق کسب‌وکار کلاینت یک <strong>interface</strong> را فراخوانی می‌کند که توسط یک کلاس <strong>RPI proxy</strong>
   پیاده‌سازی شده است. کلاس <strong>RPI proxy</strong> یک <strong>request</strong> را به سرویس ارسال می‌کند. کلاس <strong>RPI server adapter</strong>
<strong>request</strong> را با فراخوانی منطق کسب‌وکار سرویس مدیریت می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0103_original/original_page.png" alt="Original Page 103">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
   بسیاری از توسعه‌دهندگان ادعا می‌کنند که <strong>APIs</strong> مبتنی بر <strong>HTTP</strong> آنها، <strong>RESTful</strong> هستند. اما همانطور که Roy Fielding
   در یک پست وبلاگ توضیح می‌دهد، همه آنها واقعاً اینگونه نیستند (http://roy.gbiv.com/untangled/
   2008/rest-apis-must-be-hypertext-driven). برای درک دلیل آن، بیایید به مدل بلوغ <strong>REST</strong> نگاهی بیندازیم.
  </p>
<h4>THE REST MATURITY MODEL</h4>
<p>
   Leonard Richardson (هیچ ارتباطی با نویسنده شما ندارد) یک مدل بلوغ بسیار مفید را تعریف می‌کند
   برای <strong>REST</strong> (http://martinfowler.com/articles/richardsonMaturityModel.html) که شامل
   سطوح زیر است:
  </p>
<ul>
<li>
    سطح 0—کلاینت‌های یک سرویس سطح 0، سرویس را با ایجاد <strong>HTTP POST</strong> فراخوانی می‌کنند
    <strong>requests</strong> به <strong>URL endpoint</strong> آن. هر <strong>request</strong>، عمل را مشخص می‌کند.
    هدف عمل (به عنوان مثال، <strong>business object</strong>) و هر پارامتر.
   </li>
<li>
    سطح 1—یک سرویس سطح 1 از ایده <strong>resources</strong> پشتیبانی می‌کند. برای انجام یک عمل
    بر روی یک <strong>resource</strong>، یک کلاینت یک <strong>POST request</strong> ایجاد می‌کند که عمل را مشخص می‌کند
    انجام دهید و هر پارامتر.
   </li>
<li>
    سطح 2—یک سرویس سطح 2 از <strong>HTTP verbs</strong> برای انجام عملیات استفاده می‌کند: <strong>GET</strong> برای بازیابی،
    <strong>POST</strong> برای ایجاد، و <strong>PUT</strong> برای به‌روزرسانی. پارامترهای <strong>request query</strong> و <strong>body</strong>، اگر
    هر کدام، پارامترهای عملیات را مشخص می‌کنند. این به سرویس‌ها این امکان را می‌دهد که از زیرساخت‌های وب
    مانند <strong>caching</strong> برای <strong>GET requests</strong> استفاده کنند.
   </li>
<li>
    سطح 3—طراحی یک سرویس سطح 3 بر اساس <strong>HATEOAS</strong> (<strong>Hypertext As The Engine Of Application State</strong>) است.
    اصل اساسی این است که نمایش یک <strong>resource</strong> که توسط یک <strong>GET request</strong> برگردانده می‌شود
    شامل لینک‌هایی برای انجام عملیات بر روی آن <strong>resource</strong> است. به عنوان مثال، یک کلاینت
    می‌تواند یک <strong>order</strong> را با استفاده از یک لینک در نمایش بازگردانده شده توسط <strong>GET</strong>
<strong>request</strong> که <strong>order</strong> را بازیابی کرده است، لغو کند. مزایای <strong>HATEOAS</strong> شامل عدم نیاز به
    سخت‌افزاری کردن <strong>URLs</strong> در کد کلاینت (www.infoq.com/news/2009/04/
    <strong>hateoas-restful-api-advantages</strong>).
   </li>
</ul>
<p>
   من شما را تشویق می‌کنم تا <strong>REST APIs</strong> را در سازمان خود بررسی کنید تا ببینید به کدام سطح تعلق دارند.
  </p>
<h4>SPECIFYING REST APIS</h4>
<p>
   همانطور که قبلاً در بخش 3.1 ذکر شد، شما باید <strong>APIs</strong> خود را با استفاده از یک <strong>interface defi-</strong>
<strong>nition language</strong> (<strong>IDL</strong>) تعریف کنید. برخلاف پروتکل‌های ارتباطی قدیمی‌تر مانند <strong>CORBA</strong> و
   <strong>SOAP</strong>، <strong>REST</strong> در اصل یک <strong>IDL</strong> نداشت. خوشبختانه، جامعه توسعه‌دهندگان
   ارزش یک <strong>IDL</strong> را برای <strong>RESTful APIs</strong> دوباره کشف کرده است. محبوب‌ترین <strong>REST IDL</strong>،
   <strong>Open API Specification</strong> (www.openapis.org) است که از <strong>Swagger</strong>
<strong>open source project</strong> تکامل یافته است. پروژه <strong>Swagger</strong> مجموعه‌ای از ابزارها برای توسعه و <strong>docu-</strong>
<strong>menting REST APIs</strong> است. این شامل ابزارهایی است که از تعریف <strong>interface</strong>،
   <strong>stubs</strong> کلاینت و اسکلت‌های سرور را ایجاد می‌کنند.
  </p>
<h4>THE CHALLENGE OF FETCHING MULTIPLE RESOURCES IN A SINGLE REQUEST</h4>
<p>
<strong>REST resources</strong> معمولاً حول <strong>business objects</strong>، مانند <strong>Consumer</strong> و
   <strong>Order</strong> جهت‌دهی می‌شوند. در نتیجه، یک مشکل رایج هنگام طراحی یک <strong>REST API</strong>، نحوه
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0104_original/original_page.png" alt="Original Page 104">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Communicating using the synchronous Remote procedure invocation pattern</h3>
<p>
   enable the client to retrieve multiple related objects in a single <strong>request</strong>. به عنوان مثال،
   تصور کنید که یک کلاینت <strong>REST</strong> می‌خواهد یک <strong>Order</strong> و <strong>Consumer</strong> آن <strong>Order</strong> را بازیابی کند. یک
   <strong>API REST</strong> خالص، کلاینت را ملزم می‌کند تا حداقل دو <strong>request</strong> انجام دهد، یکی برای
   <strong>Order</strong> و دیگری برای <strong>Consumer</strong> آن. یک سناریوی پیچیده‌تر به <strong>round-trips</strong> و
   رنج بردن از <strong>latency</strong> بیش از حد نیاز دارد.
  </p>
<p>
   یک راه‌حل برای این مشکل این است که یک <strong>API</strong> به کلاینت اجازه دهد تا
   <strong>resources</strong> مرتبط را هنگام دریافت یک <strong>resource</strong> بازیابی کند. به عنوان مثال، یک کلاینت می‌تواند یک <strong>Order</strong> و
   <strong>Consumer</strong> آن را با استفاده از <strong>GET /orders/order-id-1345?expand=consumer</strong> بازیابی کند. <strong>query parame-</strong>
   تر، <strong>resources</strong> مرتبط را برای بازگشت با <strong>Order</strong> مشخص می‌کند. این رویکرد در بسیاری از سناریوها خوب عمل می‌کند، اما اغلب
   برای سناریوهای پیچیده‌تر کافی نیست. پیاده‌سازی آن نیز بالقوه زمان‌بر است. این امر منجر به افزایش محبوبیت
   فناوری‌های <strong>API</strong> جایگزین مانند <strong>GraphQL</strong> (http://graphql.org) و <strong>Netflix Falcor</strong>
   (http://netflix.github.io/falcor/) شده است که برای پشتیبانی از <strong>data fetching</strong> کارآمد طراحی شده‌اند.
  </p>
<h4>THE CHALLENGE OF MAPPING OPERATIONS TO HTTP VERBS</h4>
<p>
   یکی دیگر از مشکلات طراحی <strong>REST API</strong> نحوه نگاشت عملیاتی است که می‌خواهید
   بر روی یک <strong>business object</strong> انجام دهید به یک <strong>HTTP verb</strong>. یک <strong>REST API</strong> باید از <strong>PUT</strong> برای
   <strong>updates</strong> استفاده کند، اما ممکن است راه‌های متعددی برای به‌روزرسانی یک <strong>order</strong> وجود داشته باشد، از جمله لغو آن،
   بازبینی <strong>order</strong> و غیره. همچنین، یک <strong>update</strong> ممکن است <strong>idempotent</strong> نباشد، که یک
   الزامی برای استفاده از <strong>PUT</strong> است. یک راه‌حل این است که یک <strong>sub-resource</strong> برای به‌روزرسانی یک
   جنبه خاص از یک <strong>resource</strong> تعریف کنید. به عنوان مثال، <strong>Order Service</strong> دارای یک <strong>POST /orders/</strong>
<strong>{orderId}/cancel endpoint</strong> برای لغو سفارش‌ها، و یک <strong>POST /orders/{orderId}/</strong>
<strong>revise endpoint</strong> برای بازبینی سفارش‌ها است. راه‌حل دیگر این است که یک <strong>verb</strong> را به عنوان یک <strong>URL</strong>
<strong>query parameter</strong> مشخص کنید. متأسفانه، هیچ راه‌حلی <strong>RESTful</strong> نیست.
  </p>
<p>
   این مشکل با نگاشت عملیات به <strong>HTTP verbs</strong> منجر به افزایش محبوبیت
   جایگزین‌هایی برای <strong>REST</strong> شده است، مانند <strong>gPRC</strong>، که به زودی در بخش 3.2.2 مورد بحث قرار می‌گیرد. اما
   ابتدا بیایید به مزایا و معایب <strong>REST</strong> نگاهی بیندازیم.
  </p>
<h4>BENEFITS AND DRAWBACKS OF REST</h4>
<p>
   مزایای متعددی برای استفاده از <strong>REST</strong> وجود دارد:
  </p>
<ul>
<li>
    ساده و آشنا است.
   </li>
<li>
    شما می‌توانید یک <strong>HTTP API</strong> را از داخل یک مرورگر با استفاده از، به عنوان مثال، <strong>Post-</strong>
<strong>man plugin</strong>، یا از خط فرمان با استفاده از <strong>curl</strong> آزمایش کنید (با فرض اینکه از <strong>JSON</strong> یا برخی
    فرمت متن دیگر استفاده شود).
   </li>
<li>
    به طور مستقیم از ارتباط سبک <strong>request/response</strong> پشتیبانی می‌کند.
   </li>
<li>
    مطمئناً <strong>HTTP</strong> <strong>firewall friendly</strong> است.
   </li>
<li>
    به یک <strong>broker</strong> واسطه نیاز ندارد، که معماری سیستم را ساده می‌کند.
   </li>
</ul>
<p>
   چندین اشکال برای استفاده از <strong>REST</strong> وجود دارد:
  </p>
<ul>
<li>
    فقط از سبک ارتباط <strong>request/response</strong> پشتیبانی می‌کند.
   </li>
<li>
    کاهش <strong>availability</strong>. از آنجایی که کلاینت و سرویس مستقیماً با
    بدون یک واسطه برای بافر کردن پیام‌ها، آنها باید برای
    مدت زمان تبادل اجرا شوند.
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0105_original/original_page.png" alt="Original Page 105">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<ul>
<li>
    کلاینت‌ها باید مکان (<strong>URLs</strong>) نمونه‌های سرویس را بدانند. همانطور که توضیح داده شد
    در بخش 3.2.4، این یک مشکل غیر بدیهی در یک اپلیکیشن مدرن است. کلاینت‌ها باید
    از آنچه به عنوان یک مکانیسم <strong>service discovery</strong> شناخته می‌شود، برای یافتن نمونه‌های سرویس استفاده کنند.
   </li>
<li>
    بازیابی چندین <strong>resource</strong> در یک <strong>request</strong> واحد، چالش‌برانگیز است.
   </li>
<li>
    گاهی اوقات نگاشت چندین عملیات <strong>update</strong> به <strong>HTTP verbs</strong> دشوار است.
   </li>
</ul>
<p>
   علیرغم این معایب، <strong>REST</strong> به نظر می‌رسد که استاندارد <strong>de facto</strong> برای <strong>APIs</strong> است، اگرچه
   چندین جایگزین جالب وجود دارد. به عنوان مثال، <strong>GraphQL</strong>، <strong>data fetching</strong> کارآمد و انعطاف‌پذیر را پیاده‌سازی می‌کند. فصل 8 به <strong>GraphQL</strong> می‌پردازد و الگو <strong>API gateway</strong> را پوشش می‌دهد.
  </p>
<p>
<strong>gRPC</strong> یکی دیگر از جایگزین‌های <strong>REST</strong> است. بیایید نگاهی بیندازیم به نحوه عملکرد آن.
  </p>
<h4>3.2.2 Using gRPC</h4>
<p>
   همانطور که در بخش قبل ذکر شد، یک چالش با استفاده از <strong>REST</strong> این است که
   از آنجایی که <strong>HTTP</strong> فقط تعداد محدودی از <strong>verbs</strong> را ارائه می‌دهد، طراحی یک <strong>REST API</strong> که از چندین عملیات <strong>update</strong> پشتیبانی می‌کند، همیشه ساده نیست. یک فناوری <strong>IPC</strong>
   که از این مشکل اجتناب می‌کند، <strong>gRPC</strong> (www.grpc.io) است، یک فریم‌ورک برای نوشتن
   کلاینت‌ها و سرورهای <strong>cross-language</strong> (به https://en.wikipedia.org/wiki/Remote_procedure_call مراجعه کنید
   برای اطلاعات بیشتر). <strong>gRPC</strong> یک پروتکل مبتنی بر پیام باینری است، و این به این معنی است - همانطور که قبلاً در بحث در مورد فرمت‌های پیام باینری ذکر شد - شما مجبور هستید یک رویکرد <strong>API-first</strong> را در طراحی سرویس در نظر بگیرید. شما <strong>APIs gRPC</strong> خود را با استفاده از یک <strong>Protocol Buffers-based</strong>
<strong>IDL</strong> تعریف می‌کنید، که مکانیسم خنثی Google برای سریال‌سازی <strong>structured data</strong> است.
   شما از کامپایلر <strong>Protocol Buffer</strong> برای تولید <strong>stubs</strong> سمت کلاینت و <strong>skel-</strong>
<strong>etons</strong> سمت سرور استفاده می‌کنید. کامپایلر می‌تواند کدی را برای انواع زبان‌ها، از جمله <strong>Java</strong>، <strong>C#</strong>،
   <strong>NodeJS</strong> و <strong>GoLang</strong> تولید کند. کلاینت‌ها و سرورها پیام‌های باینری را در <strong>Protocol</strong> تبادل می‌کنند
   فرمت <strong>Buffers</strong> با استفاده از <strong>HTTP/2</strong>.
  </p>
<p>
   یک <strong>gRPC API</strong> از یک یا چند سرویس و تعاریف پیام <strong>request/response</strong> تشکیل شده است. یک
   تعریف سرویس مشابه یک <strong>Java interface</strong> است و مجموعه‌ای از متدهای <strong>strongly</strong>
<strong>typed</strong> است. همچنین پشتیبانی از <strong>RPC request/response</strong> ساده، <strong>gRPC</strong> از
   <strong>streaming RPC</strong> پشتیبانی می‌کند. یک سرور می‌تواند با یک جریان از پیام‌ها به کلاینت پاسخ دهد. متناوباً،
   یک کلاینت می‌تواند یک جریان از پیام‌ها را به سرور ارسال کند.
  </p>
<p>
<strong>gRPC</strong> از <strong>Protocol Buffers</strong> به عنوان فرمت پیام استفاده می‌کند. <strong>Protocol Buffers</strong>، همانطور که
   قبلاً ذکر شد، یک فرمت باینری کارآمد و فشرده است. این یک فرمت <strong>tagged</strong> است. هر <strong>field</strong> از
   یک پیام <strong>Protocol Buffers</strong> شماره‌گذاری شده و دارای یک <strong>type code</strong> است. یک گیرنده پیام می‌تواند
   فیلدهایی را که نیاز دارد استخراج کند و از فیلدهایی که آن را نمی‌شناسد، صرفنظر کند. به عنوان یک
   نتیجه، <strong>gRPC</strong> <strong>APIs</strong> را قادر می‌سازد تا تکامل یابند در حالی که <strong>backward-compatible</strong> باقی می‌مانند.
  </p>
<p>
   فهرست 3.1 بخشی از <strong>gRPC API</strong> را برای <strong>Order Service</strong> نشان می‌دهد. این سرویس چندین متد، از جمله
   <strong>createOrder()</strong> را تعریف می‌کند. این متد یک <strong>CreateOrderRequest</strong> را به عنوان
   یک پارامتر دریافت می‌کند و یک <strong>CreateOrderReply</strong> را برمی‌گرداند.
  </p>
<pre>
   <code>
    service OrderService {
     rpc createOrder(CreateOrderRequest) returns (CreateOrderReply) {}
    </code>
  </pre>
<p>
   فهرست 3.1
   بخشی از <strong>gRPC API</strong> برای <strong>Order Service</strong>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0106_original/original_page.png" alt="Original Page 106">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Communicating using the synchronous Remote procedure invocation pattern</h3>
<pre>
   <code>
    rpc cancelOrder(CancelOrderRequest) returns (CancelOrderReply) {}
    rpc reviseOrder(ReviseOrderRequest) returns (ReviseOrderReply) {}
    ...
    }
    message CreateOrderRequest {
     int64 restaurantId = 1;
     int64 consumerId = 2;
     repeated LineItem lineItems = 3;
     ...
    }
    message LineItem {
     string menuItemId = 1;
     int32 quantity = 2;
    }
    message CreateOrderReply {
     int64 orderId = 1;
    }
    ...
   </code>
  </pre>
<p>
<strong>CreateOrderRequest</strong> و <strong>CreateOrderReply</strong> پیام‌های <strong>typed</strong> هستند. به عنوان مثال، <strong>Create-</strong>
   پیام <strong>OrderRequest</strong> دارای یک فیلد <strong>restaurantId</strong> از نوع <strong>int64</strong> است. مقدار برچسب فیلد 1 است.
  </p>
<p>
<strong>gRPC</strong> چندین مزیت دارد:
  </p>
<ul>
<li>
    طراحی یک <strong>API</strong> که دارای مجموعه‌ای غنی از عملیات <strong>update</strong> است، ساده است.
   </li>
<li>
    این یک مکانیسم <strong>IPC</strong> کارآمد و فشرده دارد، به خصوص هنگام تبادل
    پیام‌های بزرگ.
   </li>
<li>
    جریان دو طرفه، هر دو سبک <strong>RPI</strong> و پیام‌رسانی ارتباط را فعال می‌کند.
   </li>
<li>
    این قابلیت همکاری بین کلاینت‌ها و سرویس‌های نوشته شده در طیف وسیعی را فعال می‌کند
    از زبان‌ها.
   </li>
</ul>
<p>
<strong>gRPC</strong> همچنین چندین اشکال دارد:
  </p>
<ul>
<li>
    برای کلاینت‌های <strong>JavaScript</strong> مصرف <strong>API</strong> مبتنی بر <strong>gRPC</strong> بیشتر از
    <strong>APIs</strong> مبتنی بر <strong>REST/JSON</strong> زمان می‌برد.
   </li>
<li>
<strong>firewall</strong>های قدیمی‌تر ممکن است از <strong>HTTP/2</strong> پشتیبانی نکنند.
   </li>
</ul>
<p>
<strong>gRPC</strong> یک جایگزین قانع‌کننده برای <strong>REST</strong> است، اما مانند <strong>REST</strong>، این یک ارتباط <strong>synchronous</strong> است
   مکانیسم، بنابراین از مشکل <strong>partial failure</strong> نیز رنج می‌برد. بیایید نگاهی بیندازیم به
   این چیست و چگونه آن را مدیریت کنیم.
  </p>
<h4>3.2.3 Handling partial failure using the Circuit breaker pattern</h4>
<p>
   در یک سیستم توزیع شده، هر زمان که یک سرویس یک <strong>request synchronous</strong> را به سرویس دیگری
   انجام می‌دهد، یک خطر همیشگی از <strong>partial failure</strong> وجود دارد. از آنجایی که کلاینت و سرویس
   فرآیندهای جداگانه هستند، یک سرویس ممکن است نتواند به موقع به یک سرویس پاسخ دهد
   درخواست کلاینت. سرویس می‌تواند به دلیل یک <strong>failure</strong> یا برای نگهداری از کار افتاده باشد.
   یا ممکن است سرویس بیش از حد بارگذاری شده باشد و به شدت به <strong>requests</strong> پاسخ دهد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0107_original/original_page.png" alt="Original Page 107">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
   از آنجایی که کلاینت منتظر پاسخ <strong>block</strong> شده است، خطر این است که <strong>failure</strong>
   می‌تواند به کلاینت‌های کلاینت‌ها و غیره <strong>cascade</strong> شود و باعث <strong>outage</strong> شود.
  </p>
<p>
   به عنوان مثال، سناریوی نشان داده شده در شکل 3.2 را در نظر بگیرید، جایی که <strong>Order Service</strong>
   پاسخگو نیست. یک کلاینت موبایل یک <strong>REST request</strong> را به یک <strong>API gateway</strong> انجام می‌دهد که،
   همانطور که در فصل 8 مورد بحث قرار گرفت، نقطه ورود به اپلیکیشن برای کلاینت‌های <strong>API</strong> است. <strong>API</strong>
<strong>gateway</strong>، <strong>request</strong> را به <strong>Order Service</strong> غیر پاسخگو <strong>proxies</strong> می‌کند.
  </p>
<p>
   یک پیاده‌سازی ساده از <strong>OrderServiceProxy</strong>، برای همیشه منتظر پاسخ خواهد بود و <strong>block</strong> می‌شود. نه تنها این منجر به یک تجربه کاربری ضعیف می‌شود، بلکه در بسیاری از
   اپلیکیشن‌ها یک منبع ارزشمند، مانند یک <strong>thread</strong> را مصرف می‌کند. در نهایت
   <strong>API gateway</strong> از منابع خارج می‌شود و قادر به رسیدگی به <strong>requests</strong> نمی‌شود. این
   کل <strong>API</strong> در دسترس نخواهد بود.
  </p>
<p>
   ضروری است که شما سرویس‌های خود را طوری طراحی کنید که از <strong>partial failures</strong> جلوگیری کنید
   از <strong>cascading</strong> در سراسر اپلیکیشن. دو بخش برای راه‌حل وجود دارد:
  </p>
<ul>
<li>
    شما باید از <strong>RPI proxies</strong> طراحی، مانند <strong>OrderServiceProxy</strong>، برای رسیدگی به
    سرویس‌های <strong>remote</strong> غیر پاسخگو.
   </li>
<li>
    شما باید تصمیم بگیرید که چگونه از یک سرویس <strong>remote</strong> ناموفق بازیابی کنید.
   </li>
</ul>
<p>
   ابتدا به نحوه نوشتن <strong>RPI proxies</strong> قوی نگاه خواهیم کرد.
  </p>
<p>
   الگو: <strong>Circuit breaker</strong>
</p>
<p>
   یک <strong>RPI proxy</strong> که بلافاصله پس از اینکه تعداد <strong>failures</strong> متوالی از یک
   آستانه مشخص شده فراتر رفت، <strong>invocations</strong> را برای یک دوره <strong>timeout</strong> رد می‌کند. به http://microservices
   .io/patterns/reliability/circuit-breaker.html مراجعه کنید.
  </p>
<p>
<strong>API</strong>
<strong>gateway</strong>
   سرویس <strong>remote</strong> غیر پاسخگو
   موبایل
   <strong>app</strong>
<strong>Order</strong>
<strong>Service</strong>
<strong>Order</strong>
<strong>Service</strong>
<strong>proxy</strong>
   ایجاد
   <strong>order</strong>
<strong>endpoint</strong>
<strong>POST/orders</strong>
<strong>POST/orders</strong>
</p>
<p>
   شکل 3.2
   یک <strong>API gateway</strong> باید از خود در برابر سرویس‌های غیر پاسخگو، مانند <strong>Order</strong>
<strong>Service</strong> محافظت کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0108_original/original_page.png" alt="Original Page 108">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Communicating using the synchronous Remote procedure invocation pattern</h3>
<p>
<strong>DEVELOPING ROBUST RPI PROXIES</strong>
</p>
<p>
   هر زمان که یک سرویس، سرویس دیگری را به صورت <strong>synchronously</strong> فراخوانی می‌کند، باید از خود محافظت کند
   با استفاده از رویکردی که توسط <strong>Netflix</strong> توضیح داده شده است (http://techblog.netflix.com/2012/02/fault-
   <strong>tolerance-in-high-volume.html</strong>). این رویکرد شامل ترکیبی از <strong>fol-</strong>
   مکانیسم‌های زیر:
  </p>
<ul>
<li>
<strong>Network timeouts</strong>—هرگز برای مدت نامحدود <strong>block</strong> نکنید و همیشه از <strong>timeouts</strong> استفاده کنید.
    هنگام انتظار برای پاسخ. استفاده از <strong>timeouts</strong> تضمین می‌کند که منابع هرگز گره نمی‌خورند
    برای مدت نامحدود.
   </li>
<li>
    محدود کردن تعداد <strong>outstanding requests</strong> از یک کلاینت به یک سرویس—یک <strong>upper</strong> را تحمیل کنید
    حد در تعداد <strong>outstanding requests</strong> که یک کلاینت می‌تواند به یک <strong>par-</strong>
<strong>ticular service</strong> انجام دهد. اگر به حد رسیده‌اید، احتمالاً بی‌فایده است که
    <strong>requests</strong> اضافی انجام دهید، و آن تلاش‌ها باید فوراً شکست بخورند.
   </li>
<li>
    الگوی <strong>Circuit breaker</strong>—تعداد <strong>successful</strong> و <strong>failed requests</strong> را پیگیری کنید،
    و اگر <strong>error rate</strong> از یک آستانه معین فراتر رفت، <strong>circuit breaker</strong> را فعال کنید تا
    تلاش‌های بیشتر فوراً شکست بخورند. تعداد زیادی <strong>requests</strong> که شکست می‌خورند
    نشان می‌دهد که سرویس در دسترس نیست و ارسال <strong>requests</strong> بیشتر بی‌فایده است.
    پس از یک دوره <strong>timeout</strong>، کلاینت باید دوباره تلاش کند و در صورت موفقیت،
    <strong>circuit breaker</strong> را ببندد.
   </li>
</ul>
<p>
<strong>Netflix Hystrix</strong> (https://github.com/Netflix/Hystrix) یک کتابخانه <strong>open source</strong> است که
   این الگوها و الگوهای دیگر را پیاده‌سازی می‌کند. اگر از <strong>JVM</strong> استفاده می‌کنید، قطعاً باید
   هنگام پیاده‌سازی <strong>RPI proxies</strong> استفاده از <strong>Hystrix</strong> را در نظر بگیرید. و اگر در یک
   محیط غیر <strong>JVM</strong>، شما باید از یک کتابخانه معادل استفاده کنید. به عنوان مثال، کتابخانه <strong>Polly</strong>
   در جامعه <strong>.NET</strong> محبوب است (https://github.com/App-vNext/Polly).
  </p>
<p>
<strong>RECOVERING FROM AN UNAVAILABLE SERVICE</strong>
</p>
<p>
   استفاده از یک کتابخانه مانند <strong>Hystrix</strong> تنها بخشی از راه‌حل است. شما همچنین باید تصمیم بگیرید
   به صورت موردی که سرویس‌های شما چگونه باید از یک سرویس <strong>remote</strong> غیرپاسخگو بازیابی شوند. یک
   گزینه این است که یک سرویس به سادگی یک خطا را به کلاینت خود برگرداند. به عنوان مثال،
   این رویکرد برای سناریوی نشان داده شده در شکل 3.2 منطقی است، جایی که <strong>request</strong> برای
   ایجاد یک <strong>Order</strong> شکست می‌خورد. تنها گزینه این است که <strong>API gateway</strong> یک خطا را به
   کلاینت موبایل بازگرداند.
  </p>
<p>
   در سناریوهای دیگر، بازگرداندن یک مقدار <strong>fallback</strong>، مانند یک مقدار پیش‌فرض یا یک
   <strong>response cached</strong>، ممکن است منطقی باشد. به عنوان مثال، فصل 7 نحوه عملکرد <strong>API gate-</strong>
<strong>way</strong> را توضیح می‌دهد که می‌تواند عملیات <strong>query</strong> <strong>findOrder()</strong> را با استفاده از الگوی ترکیب <strong>API</strong> پیاده‌سازی کند.
   همانطور که شکل 3.3 نشان می‌دهد، پیاده‌سازی <strong>GET /orders/{orderId} end-</strong>
<strong>point</strong>، چندین سرویس، از جمله <strong>Order Service</strong>، <strong>Kitchen Service</strong> و
   <strong>Delivery Service</strong> را فراخوانی می‌کند و نتایج را ترکیب می‌کند.
  </p>
<p>
   احتمالاً داده‌های هر سرویس برای کلاینت به یک اندازه مهم نیستند. داده‌ها
   از <strong>Order Service</strong> ضروری است. اگر این سرویس در دسترس نباشد، <strong>API gateway</strong>
   باید یا یک نسخه <strong>cached</strong> از داده‌های خود یا یک خطا را برگرداند. داده‌ها از دیگر
   سرویس‌ها کمتر بحرانی هستند. به عنوان مثال، یک کلاینت می‌تواند اطلاعات مفیدی را به کاربر
   نمایش دهد، حتی اگر وضعیت تحویل در دسترس نباشد. اگر <strong>Delivery Service</strong> در دسترس نباشد،
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0109_original/original_page.png" alt="Original Page 109">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
<strong>API gateway</strong> باید یا یک نسخه <strong>cached</strong> از <strong>data</strong> آن را برگرداند یا آن را از
   پاسخ حذف کند.
  </p>
<p>
   ضروری است که شما سرویس‌های خود را طوری طراحی کنید که <strong>partial failure</strong> را مدیریت کنند، اما اینطور نیست
   تنها مشکلی است که هنگام استفاده از <strong>RPI</strong> باید حل کنید. مشکل دیگر این است که به منظور
   برای اینکه یک سرویس، سرویس دیگری را با استفاده از <strong>RPI</strong> فراخوانی کند، باید شبکه را بداند
   موقعیت مکانی یک نمونه سرویس. در ظاهر این ساده به نظر می‌رسد، اما در عمل اینطور است
   یک مشکل چالش برانگیز. شما باید از یک مکانیسم <strong>service discovery</strong> استفاده کنید. بیایید نگاهی بیندازیم به
   چگونه کار می‌کند.
  </p>
<h4>3.2.4 Using service discovery</h4>
<p>
   فرض کنید شما در حال نوشتن کدی هستید که یک سرویس را فراخوانی می‌کند که یک <strong>REST API</strong> دارد. به منظور
   برای ایجاد یک <strong>request</strong>، کد شما باید موقعیت مکانی شبکه (آدرس <strong>IP</strong> و پورت) را بداند
   یک نمونه سرویس. در یک اپلیکیشن سنتی که روی سخت‌افزار فیزیکی اجرا می‌شود،
   موقعیت‌های شبکه نمونه‌های سرویس معمولاً ثابت هستند. به عنوان مثال، کد شما می‌تواند
   موقعیت‌های شبکه را از یک فایل <strong>configuration</strong> که گه‌گاه به‌روزرسانی می‌شود، بخواند. اما
   در یک اپلیکیشن <strong>microservices</strong> مدرن مبتنی بر <strong>cloud</strong>، معمولاً اینطور ساده نیست. همانطور که هست
   در شکل 3.4 نشان داده شده است، یک اپلیکیشن مدرن بسیار پویا است.
  </p>
<p>
   نمونه‌های سرویس دارای موقعیت‌های شبکه هستند که به صورت پویا اختصاص داده شده‌اند. علاوه بر این، مجموعه
   نمونه‌های سرویس به دلیل <strong>autoscaling</strong>، <strong>failures</strong> و <strong>upgrades</strong> به طور پویا تغییر می‌کند.
   در نتیجه، کد کلاینت شما باید از یک <strong>service discovery</strong> استفاده کند.
  </p>
<p>
<strong>API</strong>
<strong>gateway</strong>
   چگونه هر کدام را مدیریت کنیم
   سرویس غیر پاسخگو؟
   غیر پاسخگو
   سرویس
   موبایل
   <strong>app</strong>
   گرفتن
   <strong>order</strong>
<strong>endpoint</strong>
<strong>Get/orders/xyz</strong>
<strong>Order</strong>
<strong>Service</strong>
<strong>Order</strong>
<strong>Service</strong>
<strong>proxy</strong>
<strong>GET/orders/xyz</strong>
<strong>Kitchen</strong>
<strong>Service</strong>
<strong>Kitchen</strong>
<strong>Service</strong>
<strong>proxy</strong>
<strong>GET/tickets?orderId=xyz</strong>
   تحویل
   <strong>Service</strong>
   تحویل
   <strong>Service</strong>
<strong>proxy</strong>
<strong>GET/deliveries?orderId-xyz</strong>
   ...
   سرویس
   ...
   سرویس
   <strong>proxy</strong>
</p>
<p>
   شکل 3.3
   <strong>API gateway</strong>، <strong>endpoint GET /orders/{orderId}</strong> را با استفاده از <strong>API</strong> پیاده‌سازی می‌کند
   ترکیب. چندین سرویس را فراخوانی می‌کند، پاسخ‌های آنها را تجمیع می‌کند و یک پاسخ را به
   <strong>mobile app</strong> ارسال می‌کند. کدی که <strong>endpoint</strong> را پیاده‌سازی می‌کند باید یک استراتژی برای رسیدگی به
   <strong>failure</strong> هر سرویسی که فراخوانی می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0110_original/original_page.png" alt="Original Page 110">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Communicating using the synchronous Remote procedure invocation pattern</h3>
<p>
<strong>OVERVIEW OF SERVICE DISCOVERY</strong>
</p>
<p>
   همانطور که اخیراً دیدید، شما نمی‌توانید یک کلاینت را با آدرس‌های <strong>IP</strong> سرویس‌ها به صورت <strong>statically</strong>
<strong>configure</strong> کنید. در عوض، یک اپلیکیشن باید از یک مکانیسم <strong>service discovery</strong>
   پویا استفاده کند. <strong>Ser-</strong>
<strong>vice discovery</strong> از نظر مفهومی بسیار ساده است: جزء اصلی آن، یک <strong>service registry</strong> است،
   که یک <strong>database</strong> از موقعیت‌های شبکه نمونه‌های سرویس یک اپلیکیشن است.
  </p>
<p>
   مکانیسم <strong>service discovery</strong>، <strong>service registry</strong> را هنگام شروع و توقف نمونه‌های سرویس به‌روزرسانی می‌کند. هنگامی که یک کلاینت یک سرویس را فراخوانی می‌کند، مکانیسم <strong>service discovery</strong>
<strong>queries</strong> را به <strong>service registry</strong> انجام می‌دهد تا فهرستی از نمونه‌های سرویس در دسترس را به دست آورد و
   <strong>request</strong> را به یکی از آنها هدایت می‌کند.
  </p>
<p>
   دو راه اصلی برای پیاده‌سازی <strong>service discovery</strong> وجود دارد:
  </p>
<ul>
<li>
    سرویس‌ها و کلاینت‌های آنها مستقیماً با <strong>service registry</strong> تعامل دارند.
   </li>
<li>
    زیرساخت استقرار، <strong>service discovery</strong> را مدیریت می‌کند. (در فصل 12 بیشتر در این مورد صحبت می‌کنم.)
   </li>
</ul>
<p>
   بیایید به هر گزینه نگاهی بیندازیم.
  </p>
<h4>APPLYING THE APPLICATION-LEVEL SERVICE DISCOVERY PATTERNS</h4>
<p>
   یک راه برای پیاده‌سازی <strong>service discovery</strong> این است که سرویس‌ها و کلاینت‌های اپلیکیشن با
   <strong>service registry</strong> تعامل داشته باشند. شکل 3.5 نحوه عملکرد این را نشان می‌دهد. یک سرویس
   نمونه موقعیت شبکه خود را در <strong>service registry</strong> ثبت می‌کند. یک کلاینت سرویس،
   سرویسی را با <strong>querying</strong> ابتدا <strong>service registry</strong> برای دریافت لیستی از نمونه‌های سرویس فراخوانی می‌کند. این
   سپس یک <strong>request</strong> را به یکی از آن نمونه‌ها ارسال می‌کند.
  </p>
<p>
   سرویس
   نمونه 1
   سرویس سفارش
   10.232.23.1
   10.232.23.2
   10.232.23.3
   سرویس
   نمونه 2
   کلاینت سرویس
   سرویس
   نمونه 3
   ؟
   اختصاص داده شده به صورت پویا
   <strong>IP</strong>
   ایجاد و نابود شده به صورت پویا
  </p>
<p>
   شکل 3.4
   نمونه‌های سرویس دارای آدرس‌های <strong>IP</strong> هستند که به صورت پویا اختصاص داده شده‌اند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0111_original/original_page.png" alt="Original Page 111">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
   این رویکرد به <strong>service discovery</strong> ترکیبی از دو <strong>pattern</strong> است. اولین <strong>pat-</strong>
<strong>tern</strong>، الگوی <strong>Self registration</strong> است. یک نمونه سرویس، <strong>API</strong> ثبت <strong>service registry</strong> را فراخوانی می‌کند
   برای ثبت موقعیت شبکه خود. همچنین ممکن است یک <strong>health check</strong> ارائه دهد
   <strong>URL</strong>، که در فصل 11 با جزئیات بیشتری توضیح داده شده است. <strong>URL health check</strong> یک <strong>API end-</strong>
<strong>point</strong> است که <strong>service registry</strong> به صورت دوره‌ای برای تأیید اینکه نمونه سرویس،
   سالم است و برای رسیدگی به <strong>requests</strong> در دسترس است. یک <strong>service registry</strong> ممکن است به یک سرویس نیاز داشته باشد
   نمونه برای فراخوانی دوره‌ای یک <strong>API “heartbeat”</strong> به منظور جلوگیری از ثبت نام آن
   منقضی شدن.
  </p>
<p>
   الگوی دوم، الگوی <strong>Client-side discovery</strong> است. هنگامی که یک کلاینت سرویس می‌خواهد
   یک سرویس را فراخوانی کند، <strong>service registry</strong> را <strong>query</strong> می‌کند تا لیستی از نمونه‌های سرویس را دریافت کند.
   برای بهبود عملکرد، یک کلاینت ممکن است نمونه‌های سرویس را <strong>cache</strong> کند. کلاینت سرویس
  </p>
<p>
   الگو: <strong>Self registration</strong>
</p>
<p>
   یک نمونه سرویس خود را با <strong>service registry</strong> ثبت می‌کند. به http://microser
   <strong>vices.io/patterns/self-registration.html</strong> مراجعه کنید.
  </p>
<p>
   سرویس
   نمونه 1
   سرویس سفارش
   10.232.23.1
   درخواست تعادل بار
   10.232.23.1
   10.232.23.2
   10.232.23.3
   10.232.23.2
   ثبت("سرویس-سفارش"، "10.232.23.1")
   پرس و جو("سرویس-سفارش")
   <strong>Query API</strong>
<strong>Registration API</strong>
   10.232.23.3
   سرویس
   نمونه 2
   سرویس
   نمونه 3
   کتابخانه <strong>service discovery</strong>
   سرویس
   کلاینت
   سرویس
   سرویس-سفارش
   سرویس-سفارش
   سرویس-سفارش
   ...
   <strong>Service registry</strong>
   آدرس <strong>IP</strong>
   10.232.23.1
   10.232.23.2
   10.232.23.3
   ...
   <strong>RPC/rest</strong>
   کلاینت
   کتابخانه <strong>service discovery</strong>
   کتابخانه <strong>service discovery</strong>
   کتابخانه <strong>service discovery</strong>
<strong>Client-side discovery</strong>
   الگوی <strong>Self registration</strong>
</p>
<p>
   شکل 3.5
   <strong>service registry</strong>، نمونه‌های سرویس را پیگیری می‌کند. کلاینت‌ها،
   <strong>service registry</strong> را <strong>query</strong> می‌کنند تا موقعیت‌های شبکه نمونه‌های سرویس موجود را پیدا کنند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0112_original/original_page.png" alt="Original Page 112">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Communicating using the synchronous Remote procedure invocation pattern</h3>
<p>
   سپس از یک الگوریتم <strong>load-balancing</strong>، مانند <strong>round-robin</strong> یا تصادفی، برای انتخاب یک
   نمونه سرویس استفاده می‌کند. سپس یک <strong>request</strong> را به یک نمونه سرویس منتخب ارسال می‌کند.
  </p>
<p>
<strong>service discovery</strong> در سطح اپلیکیشن توسط <strong>Netflix</strong> و <strong>Pivotal</strong> محبوب شده است. <strong>Netflix</strong>
   چندین مؤلفه را توسعه داده و <strong>open source</strong> کرده است: <strong>Eureka</strong>، یک <strong>service</strong> با <strong>high available</strong>
<strong>registry</strong>، کلاینت <strong>Eureka Java</strong>، و <strong>Ribbon</strong>، یک کلاینت <strong>HTTP</strong> پیچیده که پشتیبانی می‌کند
   کلاینت <strong>Eureka</strong>. <strong>Pivotal</strong>، <strong>Spring Cloud</strong> را توسعه داد، یک فریم‌ورک مبتنی بر <strong>Spring</strong> که
   استفاده از اجزای <strong>Netflix</strong> را بسیار آسان می‌کند. سرویس‌های مبتنی بر <strong>Spring Cloud</strong>
   به طور خودکار با <strong>Eureka</strong> ثبت می‌شوند، و کلاینت‌های مبتنی بر <strong>Spring Cloud</strong> به طور خودکار
   از <strong>Eureka</strong> برای <strong>service discovery</strong> استفاده می‌کنند.
  </p>
<p>
   یکی از مزایای <strong>service discovery</strong> در سطح اپلیکیشن این است که سناریو را مدیریت می‌کند
   هنگامی که سرویس‌ها بر روی چندین پلتفرم استقرار مستقر می‌شوند. به عنوان مثال، تصور کنید
   شما فقط برخی از سرویس‌ها را بر روی <strong>Kubernetes</strong> مستقر کرده‌اید، که در فصل 12 مورد بحث قرار گرفت، و
   بقیه در یک محیط قدیمی اجرا می‌شوند. <strong>service discovery</strong> در سطح اپلیکیشن با استفاده از
   به عنوان مثال، <strong>Eureka</strong>، در هر دو محیط کار می‌کند، در حالی که <strong>Kubernetes-based ser-</strong>
<strong>vice discovery</strong> فقط در <strong>Kubernetes</strong> کار می‌کند.
  </p>
<p>
   یک نقطه ضعف <strong>service discovery</strong> در سطح اپلیکیشن این است که شما به یک سرویس نیاز دارید
   کتابخانه <strong>discovery</strong> برای هر زبان - و احتمالاً فریم‌ورک - که استفاده می‌کنید. <strong>Spring</strong>
<strong>Cloud</strong> فقط به توسعه‌دهندگان <strong>Spring</strong> کمک می‌کند. اگر شما از فریم‌ورک <strong>Java</strong> دیگری یا یک
   زبان غیر <strong>JVM</strong> مانند <strong>NodeJS</strong> یا <strong>GoLang</strong> استفاده می‌کنید، باید یک سرویس دیگر را پیدا کنید
   فریم‌ورک <strong>discovery</strong>. یکی دیگر از معایب <strong>service discovery</strong> در سطح اپلیکیشن این است که
   شما مسئول راه‌اندازی و مدیریت <strong>service registry</strong> هستید، که یک حواس‌پرتی است. به عنوان یک
   نتیجه، معمولاً بهتر است از یک مکانیسم <strong>service discovery</strong> استفاده کنید
   ارائه شده توسط زیرساخت استقرار.
  </p>
<h4>APPLYING THE PLATFORM-PROVIDED SERVICE DISCOVERY PATTERNS</h4>
<p>
   در ادامه در فصل 12 خواهید آموخت که بسیاری از پلتفرم‌های استقرار مدرن مانند
   <strong>Docker</strong> و <strong>Kubernetes</strong> دارای یک <strong>service registry</strong> داخلی و یک مکانیسم <strong>service discovery</strong> هستند.
   پلتفرم استقرار به هر سرویس یک نام <strong>DNS</strong>، یک آدرس <strong>IP</strong> مجازی (<strong>VIP</strong>) می‌دهد، و یک
   نام <strong>DNS</strong> که به آدرس <strong>VIP</strong> <strong>resolve</strong> می‌شود. یک کلاینت سرویس، یک
   <strong>request</strong> را به نام <strong>DNS/VIP</strong>، انجام می‌دهد و پلتفرم استقرار به‌طور خودکار <strong>request</strong> را مسیریابی می‌کند
   به یکی از نمونه‌های سرویس موجود. در نتیجه، ثبت سرویس،
   <strong>service discovery</strong> و مسیریابی <strong>request</strong>، کاملاً توسط پلتفرم استقرار مدیریت می‌شود.
   شکل 3.6 نحوه عملکرد این را نشان می‌دهد.
  </p>
<p>
   پلتفرم استقرار شامل یک <strong>service registry</strong> است که آدرس‌های <strong>IP</strong> را ردیابی می‌کند
   سرویس‌های مستقر شده. در این مثال، یک کلاینت با استفاده از
   الگو: <strong>Client-side discovery</strong>
</p>
<p>
   یک کلاینت سرویس، فهرست نمونه‌های سرویس موجود را از <strong>service reg-</strong>
<strong>istry</strong> بازیابی می‌کند و آنها را <strong>load balance</strong> می‌کند. به <strong>http://microservices.io/patterns/client-</strong>
<strong>side-discovery.html</strong> مراجعه کنید.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0113_original/original_page.png" alt="Original Page 113">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
<strong>DNS name order-service</strong>، که به آدرس <strong>IP</strong> مجازی 10.1.3.4 <strong>resolves</strong> می‌شود.
   پلتفرم استقرار، <strong>requests</strong> را به طور خودکار در بین سه نمونه از <strong>Order Service</strong>، <strong>load balance</strong> می‌کند.
  </p>
<p>
   این رویکرد ترکیبی از دو <strong>pattern</strong> است:
  </p>
<ul>
<li>
<strong>3rd party registration pattern</strong>—به جای اینکه یک سرویس خود را با <strong>service reg-</strong>
<strong>istry</strong> ثبت کند، یک شخص ثالث به نام <strong>registrar</strong>، که معمولاً بخشی از
    پلتفرم استقرار است، ثبت نام را مدیریت می‌کند.
   </li>
<li>
    الگوی <strong>Server-side discovery</strong>—به جای اینکه یک کلاینت <strong>service registry</strong> را <strong>query</strong> کند، این کار را انجام می‌دهد
    یک <strong>request</strong> به یک نام <strong>DNS</strong> می‌دهد که به یک <strong>request router</strong> <strong>resolves</strong> می‌شود
    <strong>service registry</strong> را <strong>query</strong> می‌کند و <strong>requests load balance</strong> می‌کند.
   </li>
</ul>
<p>
   سرویس
   سرویس-سفارش
   سرویس-سفارش
   سرویس-سفارش
   ...
   <strong>Service registry</strong>
   آدرس <strong>IP</strong>
   10.232.23.1
   10.232.23.2
   10.232.23.3
   ...
   سرویس
   کلاینت
   <strong>GET http://order-service/...</strong>
   پلتفرم استقرار
   <strong>RPC/rest</strong>
   کلاینت
   سرویس
   نمونه 1
   سرویس سفارش
   مشاهده می‌کند
   10.232.23.1
   10.232.24.99
   سرویس
   نمونه 2
   سرویس
   نمونه 3
   روتر پلتفرم
   <strong>Queries</strong>
<strong>Updates</strong>
   10.232.23.2
   10.232.23.3
   <strong>Registrar</strong>
   ثبت نام شخص ثالث
   <strong>Server-side discovery</strong>
   نام <strong>DNS</strong> سرویس
   به <strong>VIP</strong> سرویس <strong>resolves</strong> می‌شود
   آدرس <strong>IP</strong> مجازی سرویس (<strong>VIP</strong>)
  </p>
<p>
   شکل 3.6
   پلتفرم مسئول ثبت نام سرویس، <strong>discovery</strong> و مسیریابی <strong>request</strong> است.
   نمونه‌های سرویس توسط <strong>registrar</strong> در <strong>service registry</strong> ثبت می‌شوند. هر سرویس دارای یک موقعیت شبکه است،
   یک نام <strong>DNS/virtual IP address</strong>. یک کلاینت یک <strong>request</strong> را به موقعیت شبکه سرویس ارسال می‌کند. روتر
   <strong>service registry</strong> را <strong>query</strong> می‌کند و <strong>requests load balance</strong> می‌کند
   در بین نمونه‌های سرویس موجود.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0114_original/original_page.png" alt="Original Page 114">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Communicating using the synchronous Remote procedure invocation pattern</h3>
<p>
   مزیت اصلی <strong>service discovery</strong> ارائه شده توسط پلتفرم این است که تمام جنبه‌های <strong>service dis-</strong>
<strong>covery</strong> کاملاً توسط پلتفرم استقرار مدیریت می‌شود. نه سرویس‌ها و نه
   کلاینت‌ها حاوی هیچ کد <strong>service discovery</strong> نیستند. در نتیجه، مکانیسم <strong>service dis-</strong>
<strong>covery</strong> به راحتی برای همه سرویس‌ها و کلاینت‌ها، صرف نظر از اینکه کدام زبان یا
   فریم‌ورک با آن نوشته شده‌اند، در دسترس است.
  </p>
<p>
   یک نقطه ضعف <strong>service discovery</strong> ارائه شده توسط پلتفرم این است که فقط از
   <strong>discovery</strong> سرویس‌هایی که با استفاده از پلتفرم مستقر شده‌اند، پشتیبانی می‌کند. به عنوان مثال، به عنوان
   قبلاً هنگام توصیف <strong>discovery</strong> در سطح اپلیکیشن ذکر شد، <strong>Kubernetes-based dis-</strong>
<strong>covery</strong> فقط برای سرویس‌هایی که در <strong>Kubernetes</strong> اجرا می‌شوند، کار می‌کند. علیرغم این محدودیت، من
   توصیه می‌کنم در صورت امکان از <strong>service discovery</strong> ارائه شده توسط پلتفرم استفاده کنید.
  </p>
<p>
   اکنون که به <strong>IPC synchronous</strong> با استفاده از <strong>REST</strong> یا <strong>gRPC</strong> نگاه کردیم، بیایید نگاهی بیندازیم به
   جایگزین: ارتباط مبتنی بر پیام <strong>asynchronous</strong>.
  </p>
<h4>3.3 Communicating using the Asynchronous messaging pattern</h4>
<p>
   هنگام استفاده از پیام‌رسانی، سرویس‌ها با تبادل <strong>asynchronously</strong> پیام‌ها ارتباط برقرار می‌کنند. یک
   اپلیکیشن مبتنی بر پیام‌رسانی معمولاً از یک <strong>message broker</strong> استفاده می‌کند، که به عنوان یک
   واسطه بین سرویس‌ها عمل می‌کند، اگرچه یک گزینه دیگر استفاده از یک <strong>brokerless</strong> است
   معماری، که در آن سرویس‌ها مستقیماً با یکدیگر ارتباط برقرار می‌کنند. یک کلاینت سرویس
   یک <strong>request</strong> را به یک سرویس با ارسال یک پیام به آن انجام می‌دهد. اگر انتظار می‌رود نمونه سرویس
   پاسخ دهد، با ارسال یک پیام جداگانه به کلاینت این کار را انجام می‌دهد. زیرا
   ارتباط <strong>asynchronous</strong> است، کلاینت منتظر پاسخ <strong>block</strong> نمی‌شود. در عوض،
   کلاینت با این فرض نوشته شده است که پاسخ فوراً دریافت نخواهد شد.
  </p>
<p>
   من این بخش را با مروری بر پیام‌رسانی شروع می‌کنم. من نشان می‌دهم که چگونه یک پیام‌رسانی را توصیف کنم
   معماری مستقل از فناوری پیام‌رسانی. در مرحله بعد، من مقایسه و تضاد می‌کنم
  </p>
<p>
   الگو: <strong>3rd party registration</strong>
</p>
<p>
   نمونه‌های سرویس به طور خودکار با <strong>service registry</strong> توسط شخص ثالث ثبت می‌شوند.
   به <strong>http://microservices.io/patterns/3rd-party-registration.html</strong> مراجعه کنید.
  </p>
<p>
   الگو: <strong>Server-side discovery</strong>
</p>
<p>
   یک کلاینت یک <strong>request</strong> را به یک روتر ارسال می‌کند که مسئول <strong>service discovery</strong> است. دیدن
   به <strong>http://microservices.io/patterns/server-side-discovery.html</strong> مراجعه کنید.
  </p>
<p>
   الگو: <strong>Messaging</strong>
</p>
<p>
   یک کلاینت یک سرویس را با استفاده از پیام‌رسانی <strong>asynchronous</strong> فراخوانی می‌کند. به <strong>http://microservices</strong> مراجعه کنید
   .io/patterns/communication-style/messaging.html.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0115_original/original_page.png" alt="Original Page 115">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
<strong>brokerless</strong> و معماری‌های مبتنی بر <strong>broker</strong> و معیارهای انتخاب یک
   <strong>message broker</strong> را توضیح می‌دهم. سپس در مورد چندین موضوع مهم از جمله مقیاس‌بندی مصرف‌کننده بحث می‌کنم
   در حالی که ترتیب پیام‌ها را حفظ می‌کنید، تشخیص و دور انداختن پیام‌های تکراری،
   و ارسال و دریافت پیام‌ها به عنوان بخشی از یک <strong>database transaction</strong>. بیایید با
   نگاهی به نحوه عملکرد پیام‌رسانی شروع کنیم.
  </p>
<h4>3.3.1 Overview of messaging</h4>
<p>
   یک مدل مفید از پیام‌رسانی در کتاب <strong>Enterprise Integration Patterns</strong> تعریف شده است
   (<strong>Addison-Wesley Professional, 2003</strong>) توسط <strong>Gregor Hohpe</strong> و <strong>Bobby Woolf</strong>. در این
   مدل، پیام‌ها از طریق کانال‌های پیام رد و بدل می‌شوند. یک <strong>sender</strong> (یک اپلیکیشن یا
   سرویس) یک پیام را به یک کانال می‌نویسد، و یک <strong>receiver</strong> (یک اپلیکیشن یا سرویس)
   پیام‌ها را از یک کانال می‌خواند. بیایید به پیام‌ها نگاهی بیندازیم و سپس به کانال‌ها نگاهی بیندازیم.
  </p>
<p>
<strong>ABOUT MESSAGES</strong>
</p>
<p>
   یک پیام از یک <strong>header</strong> و یک <strong>message body</strong> تشکیل شده است (www.enterpriseintegrationpatterns
   .com/Message.html). <strong>header</strong> مجموعه‌ای از جفت‌های نام-مقدار، <strong>metadata</strong> است
   که داده‌های در حال ارسال را توصیف می‌کند. علاوه بر جفت‌های نام-مقدار ارائه شده توسط
   <strong>sender</strong> پیام، <strong>header</strong> پیام شامل جفت‌های نام-مقدار، مانند یک پیام منحصربه‌فرد است
   <strong>id</strong> توسط <strong>sender</strong> یا زیرساخت پیام‌رسانی تولید شده و یک
   آدرس بازگشت اختیاری، که کانال پیام را مشخص می‌کند که یک <strong>reply</strong> باید به آن نوشته شود.
  </p>
<p>
<strong>message body</strong> داده‌های در حال ارسال است، یا در قالب متن یا باینری.
  </p>
<p>
   انواع مختلفی از پیام‌ها وجود دارد:
  </p>
<ul>
<li>
<strong>Document</strong>—یک پیام عمومی که فقط شامل داده است. <strong>receiver</strong> تصمیم می‌گیرد که چگونه
    آن را تفسیر کند. <strong>reply</strong> به یک <strong>command</strong> نمونه‌ای از یک پیام <strong>document</strong> است.
   </li>
<li>
<strong>Command</strong>—پیامی که معادل یک <strong>RPC request</strong> است. عملیات را مشخص می‌کند
    برای فراخوانی و پارامترهای آن.
   </li>
<li>
<strong>Event</strong>—پیامی که نشان می‌دهد چیزی قابل توجه در <strong>sender</strong> رخ داده است.
    یک <strong>event</strong> اغلب یک <strong>domain event</strong> است، که نشان‌دهنده تغییر وضعیت یک <strong>domain</strong> است
    <strong>object</strong> مانند یک <strong>Order</strong>، یا یک <strong>Customer</strong>.
   </li>
</ul>
<p>
   رویکرد به معماری <strong>microservice</strong> که در این کتاب توضیح داده شده است از <strong>commands</strong> استفاده می‌کند
   و رویدادها به طور گسترده.
  </p>
<p>
   اکنون بیایید به کانال‌ها، مکانیسمی که سرویس‌ها از طریق آن ارتباط برقرار می‌کنند، نگاهی بیندازیم.
  </p>
<p>
<strong>ABOUT MESSAGE CHANNELS</strong>
</p>
<p>
   همانطور که شکل 3.7 نشان می‌دهد، پیام‌ها از طریق کانال‌ها رد و بدل می‌شوند (www.enterpriseintegra-
   <strong>tionpatterns.com/MessageChannel.html</strong>). منطق کسب‌وکار در <strong>sender</strong> یک
   رابط <strong>sending port</strong> را فراخوانی می‌کند، که مکانیسم ارتباطی اساسی را کپسوله می‌کند.
   <strong>sending port</strong> توسط یک کلاس <strong>message sender adapter</strong> پیاده‌سازی شده است، که یک <strong>mes-</strong>
<strong>sage</strong> را از طریق یک کانال پیام به یک <strong>receiver</strong> ارسال می‌کند. یک کانال پیام یک <strong>abstraction</strong> از
   زیرساخت پیام‌رسانی است. یک کلاس <strong>message handler adapter</strong> در <strong>receiver</strong> فراخوانی می‌شود به
   پیام را مدیریت کند. این یک رابط <strong>receiving port</strong> را فراخوانی می‌کند که توسط <strong>consumer</strong>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0116_original/original_page.png" alt="Original Page 116">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Communicating using the Asynchronous messaging pattern</h3>
<p>
   منطق کسب‌وکار. هر تعدادی از <strong>senders</strong> می‌توانند پیام‌ها را به یک کانال ارسال کنند. به طور مشابه، هر
   تعداد از <strong>receivers</strong> می‌توانند پیام‌ها را از یک کانال دریافت کنند.
  </p>
<p>
   دو نوع کانال وجود دارد: نقطه به نقطه (<strong>www.enterpriseintegrationpatterns</strong>
   .com/PointToPointChannel.html) و انتشار-اشتراک (<strong>www.enterpriseintegration-</strong>
<strong>patterns.com/PublishSubscribeChannel.html</strong>):
  </p>
<ul>
<li>
    یک کانال نقطه به نقطه یک پیام را دقیقاً به یکی از مصرف‌کنندگانی تحویل می‌دهد که
    از کانال می‌خواند. سرویس‌ها از کانال‌های نقطه به نقطه برای سبک‌های تعامل یک به
    یک که قبلاً توضیح داده شد، استفاده می‌کنند. به عنوان مثال، یک پیام <strong>command</strong> است
    اغلب از طریق یک کانال نقطه به نقطه ارسال می‌شود.
   </li>
<li>
    یک کانال انتشار-اشتراک، هر پیام را به همه <strong>consumers</strong> متصل شده تحویل می‌دهد.
    سرویس‌ها از کانال‌های انتشار-اشتراک برای سبک‌های تعامل یک به چند
    که قبلاً توضیح داده شد، استفاده می‌کنند. به عنوان مثال، یک پیام <strong>event</strong> معمولاً از طریق یک
    کانال انتشار-اشتراک ارسال می‌شود.
   </li>
</ul>
<h4>3.3.2 Implementing the interaction styles using messaging</h4>
<p>
   یکی از ویژگی‌های ارزشمند پیام‌رسانی این است که به اندازه‌ای انعطاف‌پذیر است که از همه
   سبک‌های تعامل توضیح داده شده در بخش 3.1.1 پشتیبانی کند. برخی از سبک‌های تعامل مستقیماً پیاده‌سازی می‌شوند.
   توسط پیام‌رسانی. دیگران باید بر اساس پیام‌رسانی پیاده‌سازی شوند.
  </p>
<p>
   بیایید نگاهی بیندازیم به نحوه پیاده‌سازی هر سبک تعامل، با شروع از <strong>request/response</strong>
   و <strong>asynchronous request/response</strong>.
  </p>
<p>
<strong>IMPLEMENTING REQUEST/RESPONSE AND ASYNCHRONOUS REQUEST/RESPONSE</strong>
</p>
<p>
   هنگامی که یک کلاینت و سرویس با استفاده از <strong>request/response</strong> یا <strong>asynchronous</strong> تعامل دارند
   <strong>request/response</strong>، کلاینت یک <strong>request</strong> ارسال می‌کند و سرویس یک <strong>reply</strong> را برمی‌گرداند.
  </p>
<p>
   کسب‌وکار
   منطق
   فراخوانی می‌کند
   فراخوانی می‌کند
   منطق کسب‌وکار
   <strong>Sending port</strong>
<strong>Receiving port</strong>
<strong>Sender</strong>
<strong>Receiver</strong>
   پیام
   <strong>sender</strong>
   پیام
   پیام
   کانال
   دریافت می‌کند
   ارسال می‌کند
   <strong>Header</strong>
<strong>Body</strong>
   پیام‌رسانی
   زیرساخت
   <strong>Message</strong>
<strong>handler</strong>
   سرویس
  </p>
<p>
   شکل 3.7
   منطق کسب‌وکار در <strong>sender</strong> یک <strong>sending port interface</strong> را فراخوانی می‌کند که توسط یک <strong>message</strong>
<strong>sender adapter</strong> پیاده‌سازی شده است. <strong>message sender</strong>، یک پیام را به یک <strong>receiver</strong> از طریق یک کانال پیام ارسال می‌کند. <strong>message channel</strong>، یک انتزاع از زیرساخت پیام‌رسانی است. یک <strong>message handler adapter</strong> در <strong>receiver</strong> فراخوانی می‌شود تا پیام را مدیریت کند. این <strong>receiving port interface</strong> را فراخوانی می‌کند که توسط منطق کسب‌وکار <strong>receiver</strong> پیاده‌سازی شده است.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0117_original/original_page.png" alt="Original Page 117">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
   تفاوت بین این دو سبک تعامل این است که با <strong>request/response</strong>، کلاینت
   انتظار دارد که سرویس فوراً پاسخ دهد، در حالی که با <strong>request/response asynchronous</strong>
   هیچ انتظاری وجود ندارد. پیام‌رسانی ذاتاً <strong>asynchronous</strong> است، بنابراین فقط
   <strong>request/response asynchronous</strong> را ارائه می‌دهد. اما یک کلاینت می‌تواند <strong>block</strong> شود تا زمانی که یک <strong>reply</strong>
   دریافت شود.
  </p>
<p>
   کلاینت و سرویس، تعامل سبک <strong>asynchronous request/response</strong> را با تبادل یک جفت پیام پیاده‌سازی می‌کنند.
   همانطور که شکل 3.8 نشان می‌دهد، کلاینت یک پیام <strong>com-</strong>
<strong>mand</strong>، که عملیات را مشخص می‌کند، و پارامترها، را به یک نقطه
   کانال پیام‌رسانی به نقطه متعلق به یک سرویس. سرویس، <strong>requests</strong> را پردازش می‌کند
   و یک پیام <strong>reply</strong> ارسال می‌کند، که شامل نتیجه است، به یک کانال نقطه به نقطه
   متعلق به کلاینت.
  </p>
<p>
   کلاینت باید به سرویس بگوید که <strong>reply message</strong> را به کجا ارسال کند و باید
   <strong>reply messages</strong> را با <strong>requests</strong> مطابقت دهد. خوشبختانه، حل این دو مشکل
   چندان دشوار نیست. کلاینت یک پیام <strong>command</strong> ارسال می‌کند که دارای یک
   <strong>reply channel header</strong> است. سرور، پیام <strong>reply</strong> را می‌نویسد، که شامل یک <strong>correlation id</strong> است که
   همان مقدار شناسگر پیام را دارد، به کانال <strong>reply</strong>. کلاینت از <strong>correlation id</strong> استفاده می‌کند
   تا <strong>reply message</strong> را با <strong>request</strong> مطابقت دهد.
  </p>
<p>
   از آنجایی که کلاینت و سرویس با استفاده از پیام‌رسانی ارتباط برقرار می‌کنند، تعامل
   ذاتاً <strong>asynchronous</strong> است. از نظر تئوری، یک کلاینت پیام‌رسانی می‌تواند <strong>block</strong> شود تا زمانی که یک
   <strong>reply</strong> دریافت کند، اما در عمل کلاینت <strong>replies</strong> را به صورت <strong>asynchronously</strong> پردازش می‌کند. چه چیزی بیشتر،
   <strong>replies</strong> معمولاً توسط هر یک از نمونه‌های کلاینت پردازش می‌شوند.
  </p>
<p>
<strong>Request</strong>
   ارسال می‌کند
   می‌خواند
   می‌خواند
   ارسال می‌کند
   <strong>MessageId: msgId</strong>
<strong>ReturnAddress: ReplyChannel</strong>
<strong>Body</strong>
<strong>CorrelationId:msgId</strong>
<strong>Body</strong>
   کانال <strong>Request</strong>
   کانال <strong>Reply</strong>
<strong>Reply</strong>
   مشخص می‌کند
   کلاینت
   سرویس
   کلاینت پیام حاوی
   <strong>msgId</strong> و یک کانال <strong>reply</strong> را ارسال می‌کند.
   سرویس <strong>reply</strong> را به کانال <strong>reply</strong> مشخص شده ارسال می‌کند. <strong>Reply</strong> شامل یک
   <strong>correlationId</strong> است که <strong>msgId</strong> <strong>request</strong> است.
  </p>
<p>
   شکل 3.8
   پیاده‌سازی <strong>request/response asynchronous</strong> با شامل کردن یک کانال <strong>reply</strong> و پیام
   شناسه در پیام <strong>request</strong>. <strong>receiver</strong>، پیام را پردازش کرده و <strong>reply</strong> را به
   کانال <strong>reply</strong> مشخص شده.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0118_original/original_page.png" alt="Original Page 118">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Communicating using the Asynchronous messaging pattern</h3>
<p>
<strong>IMPLEMENTING ONE-WAY NOTIFICATIONS</strong>
</p>
<p>
   پیاده‌سازی <strong>one-way notifications</strong> با استفاده از پیام‌رسانی <strong>asynchronous</strong> ساده است.
   کلاینت یک پیام، معمولاً یک پیام <strong>command</strong>، را به یک کانال نقطه به نقطه ارسال می‌کند
   متعلق به سرویس. سرویس در کانال مشترک می‌شود و <strong>mes-</strong>
   پیام را پردازش می‌کند. آن یک <strong>reply</strong> را برنمی‌گرداند.
  </p>
<p>
<strong>IMPLEMENTING PUBLISH/SUBSCRIBE</strong>
</p>
<p>
   پیام‌رسانی از تعامل سبک انتشار/اشتراک پشتیبانی داخلی دارد. یک کلاینت
   یک پیام را به یک کانال انتشار-اشتراک که توسط چندین مصرف‌کننده خوانده می‌شود، منتشر می‌کند.
   همانطور که در فصل‌های 4 و 5 توضیح داده شد، سرویس‌ها از انتشار/اشتراک برای انتشار استفاده می‌کنند
   <strong>domain events</strong>، که نشان‌دهنده تغییراتی در <strong>domain objects</strong> است. سرویسی که منتشر می‌کند
   <strong>domain events</strong> دارای یک کانال انتشار-اشتراک است که نام آن از
   کلاس <strong>domain</strong>. به عنوان مثال، <strong>Order Service</strong>، رویدادهای <strong>Order</strong> را به یک <strong>Order</strong> منتشر می‌کند
   کانال، و <strong>Delivery Service</strong>، رویدادهای <strong>Delivery</strong> را به یک <strong>Delivery chan-</strong>
<strong>nel</strong> منتشر می‌کند. سرویسی که به رویدادهای یک <strong>domain object</strong> خاص علاقه‌مند است، فقط باید
   در کانال مناسب مشترک شوید.
  </p>
<p>
<strong>IMPLEMENTING PUBLISH/ASYNC RESPONSES</strong>
</p>
<p>
   سبک تعامل <strong>publish/async responses</strong> یک سبک تعامل سطح بالاتری است که
   با ترکیب عناصر انتشار/اشتراک و <strong>request/response</strong> پیاده‌سازی شده است. یک <strong>cli-</strong>
   یک کلاینت پیامی را منتشر می‌کند که یک هدر کانال <strong>reply</strong> را به یک انتشار-اشتراک مشخص می‌کند
   کانال. یک مصرف‌کننده، یک پیام <strong>reply</strong> حاوی یک <strong>correlation id</strong> را به <strong>reply</strong> می‌نویسد
   کانال. کلاینت، پاسخ‌ها را با استفاده از <strong>correlation id</strong> برای مطابقت با <strong>reply</strong> جمع‌آوری می‌کند
   پیام‌ها با <strong>request</strong>.
  </p>
<p>
   هر سرویس در اپلیکیشن شما که دارای یک <strong>API asynchronous</strong> است از یکی یا
   بیشتر از این تکنیک‌های پیاده‌سازی استفاده می‌کند. سرویسی که دارای یک <strong>API asynchronous</strong> برای
   فراخوانی عملیات، یک کانال پیام برای <strong>requests</strong> خواهد داشت. به طور مشابه، یک سرویس که
   رویدادها را منتشر می‌کند، آنها را به یک کانال پیام <strong>event</strong> منتشر می‌کند.
  </p>
<p>
   همانطور که در بخش 3.1.2 توضیح داده شد، نوشتن یک مشخصات <strong>API</strong> برای یک <strong>ser-</strong>
<strong>vice</strong>، مهم است. بیایید نگاهی بیندازیم به نحوه انجام این کار برای یک <strong>API asynchronous</strong>.
  </p>
<h4>3.3.3 Creating an API specification for a messaging-based service API</h4>
<p>
   مشخصات <strong>API asynchronous</strong> یک سرویس، همانطور که شکل 3.9 نشان می‌دهد، باید مشخص کند
   نام‌های کانال‌های پیام، انواع پیام‌هایی که از طریق هر کدام رد و بدل می‌شوند
   کانال و فرمت‌های آنها. شما همچنین باید فرمت پیام‌ها را با استفاده از
   یک استاندارد مانند <strong>JSON</strong>، <strong>XML</strong> یا <strong>Protobuf</strong>. اما برخلاف <strong>REST</strong> و <strong>Open API</strong>،
   هیچ استاندارد گسترده‌ای برای مستندسازی کانال‌ها و انواع پیام‌ها وجود ندارد.
   در عوض، شما باید یک سند غیررسمی بنویسید.
  </p>
<p>
<strong>API asynchronous</strong> یک سرویس شامل عملیات، که توسط کلاینت‌ها فراخوانی می‌شود و رویدادها،
   منتشر شده توسط سرویس‌ها. آنها به روش‌های مختلف مستند شده‌اند. بیایید نگاهی بیندازیم به
   هر کدام، با شروع از عملیات.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0119_original/original_page.png" alt="Original Page 119">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
<strong>DOCUMENTING ASYNCHRONOUS OPERATIONS</strong>
</p>
<p>
   عملیات یک سرویس را می‌توان با استفاده از یکی از دو سبک تعامل مختلف فراخوانی کرد:
  </p>
<ul>
<li>
<strong>Request/async response-style API</strong>—این شامل کانال پیام <strong>command</strong> سرویس، انواع و فرمت‌های
    انواع پیام <strong>command</strong> است که سرویس می‌پذیرد، و انواع و فرمت‌های پیام‌های <strong>reply</strong>
    ارسال شده توسط سرویس.
   </li>
<li>
<strong>One-way notification-style API</strong>—این شامل کانال پیام <strong>command</strong> سرویس و
    انواع و فرمت انواع پیام <strong>command</strong> است که سرویس می‌پذیرد.
   </li>
</ul>
<p>
   یک سرویس ممکن است از یک کانال <strong>request</strong> یکسان برای هر دو <strong>request/response asynchronous</strong>
   و <strong>one-way notification</strong> استفاده کند.
  </p>
<p>
<strong>DOCUMENTING PUBLISHED EVENTS</strong>
</p>
<p>
   یک سرویس همچنین می‌تواند با استفاده از سبک تعامل <strong>publish/subscribe</strong> رویدادها را منتشر کند. مشخصات
   این سبک از <strong>API</strong> شامل کانال <strong>event</strong> و انواع و فرمت‌های
   پیام‌های <strong>event</strong> که توسط سرویس به کانال منتشر می‌شوند.
  </p>
<p>
   مدل پیام‌ها و کانال‌ها، یک انتزاع عالی و یک راه خوب است
   برای طراحی <strong>API asynchronous</strong> یک سرویس. اما برای پیاده‌سازی یک سرویس، شما
   باید یک فناوری پیام‌رسانی را انتخاب کنید و نحوه پیاده‌سازی طراحی خود را تعیین کنید
   با استفاده از قابلیت‌های آن. بیایید نگاهی به آنچه درگیر است بیندازیم.
  </p>
<h4>3.3.4 Using a message broker</h4>
<p>
   یک اپلیکیشن مبتنی بر پیام‌رسانی معمولاً از یک <strong>message broker</strong> استفاده می‌کند، یک سرویس زیرساختی
   که سرویس از طریق آن ارتباط برقرار می‌کند. اما یک معماری مبتنی بر <strong>broker</strong>، اینطور نیست
   تنها معماری پیام‌رسانی. شما همچنین می‌توانید از یک معماری پیام‌رسانی مبتنی بر <strong>brokerless</strong>
   استفاده کنید، که در آن سرویس‌ها مستقیماً با یکدیگر ارتباط برقرار می‌کنند. دو رویکرد،
   نشان داده شده در شکل 3.10، مقایسه متفاوتی دارند، اما معمولاً یک معماری مبتنی بر <strong>broker</strong>
   یک رویکرد بهتر است.
  </p>
<p>
   سرویس
   <strong>Command</strong>
<strong>query</strong>
<strong>API</strong>
<strong>Service API</strong>
   پاسخ‌ها
   <strong>R</strong>
<strong>R</strong>
   رویدادها
   <strong>R</strong>
   انتشار دهنده <strong>Event</strong>
   «کانال <strong>Command</strong>»
   «کانال <strong>Event</strong>»
   «کانال <strong>Reply</strong>»
   <strong>Commands</strong>
<strong>C</strong>
<strong>C</strong>
<strong>C</strong>
</p>
<p>
   شکل 3.9
   <strong>API asynchronous</strong> یک سرویس شامل کانال‌های پیام و <strong>command</strong>، <strong>reply</strong> و است
   انواع پیام <strong>event</strong>.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0120_original/original_page.png" alt="Original Page 120">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Communicating using the Asynchronous messaging pattern</h3>
<p>
   این کتاب بر معماری مبتنی بر <strong>broker</strong> متمرکز است، اما ارزش این را دارد که نگاهی سریع
   به معماری <strong>brokerless</strong> بیندازیم، زیرا ممکن است سناریوهایی وجود داشته باشد که در آن مفید
   می‌یابید.
  </p>
<p>
<strong>BROKERLESS MESSAGING</strong>
</p>
<p>
   در یک معماری <strong>brokerless</strong>، سرویس‌ها می‌توانند پیام‌ها را مستقیماً تبادل کنند. <strong>ZeroMQ</strong> (http://
   zeromq.org) یک فناوری پیام‌رسانی <strong>brokerless</strong> محبوب است. این یک مشخصه است
   و مجموعه‌ای از کتابخانه‌ها برای زبان‌های مختلف. این از انواع حمل و نقل پشتیبانی می‌کند، از جمله
   <strong>TCP</strong>، <strong>UNIX-style domain sockets</strong>، و <strong>multicast</strong>.
  </p>
<p>
   معماری <strong>brokerless</strong> دارای مزایایی است:
  </p>
<ul>
<li>
    به ترافیک شبکه سبک‌تر و <strong>latency</strong> بهتر اجازه می‌دهد، زیرا پیام‌ها مستقیماً می‌روند
    از <strong>sender</strong> به <strong>receiver</strong>، به جای اینکه مجبور شوند از <strong>sender</strong> به
    <strong>message broker</strong> و از آنجا به <strong>receiver</strong>
</li>
<li>
    امکان اینکه <strong>message broker</strong>، یک گلوگاه عملکردی یا یک نقطه واحد از <strong>failure</strong> باشد را از بین می‌برد.
   </li>
<li>
    ویژگی‌های پیچیدگی عملیاتی کمتر، زیرا هیچ <strong>message broker</strong> برای تنظیم وجود ندارد
    و نگهداری
   </li>
</ul>
<p>
   به جذابیت این مزایا، پیام‌رسانی <strong>brokerless</strong> دارای معایب قابل توجهی است:
  </p>
<ul>
<li>
    سرویس‌ها باید از موقعیت یکدیگر آگاه باشند و بنابراین باید از یکی استفاده کنند
    از مکانیسم‌های <strong>discovery</strong> که قبلاً در بخش 3.2.4 توضیح داده شد.
   </li>
<li>
<strong>availability</strong> کاهش یافته را ارائه می‌دهد، زیرا هم <strong>sender</strong> و هم <strong>receiver</strong> یک پیام
    باید در حین تبادل پیام در دسترس باشند.
   </li>
<li>
    پیاده‌سازی مکانیسم‌ها، مانند تحویل تضمینی، چالش‌برانگیزتر است.
   </li>
</ul>
<p>
   سرویس
   سرویس
   سرویس
   سرویس
   سرویس
   سرویس
   <strong>Message broker</strong>
   در مقابل
   معماری <strong>Brokerless</strong>
   معماری مبتنی بر <strong>Broker</strong>
</p>
<p>
   شکل 3.10
   سرویس‌ها در معماری <strong>brokerless</strong> مستقیماً ارتباط برقرار می‌کنند، در حالی که سرویس‌ها
   در یک معماری مبتنی بر <strong>broker</strong> از طریق یک <strong>message broker</strong> ارتباط برقرار می‌کنند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0121_original/original_page.png" alt="Original Page 121">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
   در واقع، برخی از این معایب، مانند <strong>availability</strong> کاهش یافته و نیاز به <strong>service</strong>
<strong>discovery</strong>، همانند استفاده از <strong>synchronous, response/response</strong> هستند.
  </p>
<p>
   به دلیل این محدودیت‌ها، اکثر اپلیکیشن‌های سازمانی از معماری مبتنی بر <strong>message broker</strong> استفاده می‌کنند.
   بیایید نگاهی بیندازیم به نحوه عملکرد این.
  </p>
<h4>OVERVIEW OF BROKER-BASED MESSAGING</h4>
<p>
   یک <strong>message broker</strong> یک واسطه است که از طریق آن تمام پیام‌ها جریان می‌یابند. یک <strong>sender</strong> می‌نویسد
   پیام را به <strong>message broker</strong>، و <strong>message broker</strong> آن را به <strong>receiver</strong> تحویل می‌دهد.
  </p>
<p>
   یک مزیت مهم استفاده از یک <strong>message broker</strong> این است که <strong>sender</strong> نیازی ندارد
   موقعیت شبکه <strong>consumer</strong> را بداند. مزیت دیگر این است که یک <strong>message broker</strong>
   پیام‌ها را بافر می‌کند تا زمانی که <strong>consumer</strong> قادر به پردازش آنها باشد.
  </p>
<p>
   بسیاری از <strong>message broker</strong>ها برای انتخاب وجود دارند. نمونه‌هایی از <strong>open source</strong> محبوب
   <strong>message brokers</strong> شامل موارد زیر است:
  </p>
<ul>
<li>
<strong>ActiveMQ</strong> (http://activemq.apache.org)
   </li>
<li>
<strong>RabbitMQ</strong> (https://www.rabbitmq.com)
   </li>
<li>
<strong>Apache Kafka</strong> (http://kafka.apache.org)
   </li>
</ul>
<p>
   همچنین سرویس‌های پیام‌رسانی مبتنی بر <strong>cloud</strong>، مانند <strong>AWS Kinesis</strong> (https://aws.amazon
   .com/kinesis/) و <strong>AWS SQS</strong> (https://aws.amazon.com/sqs/) وجود دارد.
  </p>
<p>
   هنگام انتخاب یک <strong>message broker</strong>، شما عوامل مختلفی را باید در نظر بگیرید، از جمله
   موارد زیر:
  </p>
<ul>
<li>
    زبان‌های برنامه‌نویسی پشتیبانی شده—شما احتمالاً باید یکی را انتخاب کنید که پشتیبانی کند
    انواع زبان‌های برنامه‌نویسی.
   </li>
<li>
    استانداردهای پیام‌رسانی پشتیبانی شده—آیا <strong>message broker</strong> از هر استانداردی پشتیبانی می‌کند؟
    مانند <strong>AMQP</strong> و <strong>STOMP</strong>، یا اختصاصی است؟
   </li>
<li>
    ترتیب پیام‌رسانی—آیا <strong>message broker</strong> ترتیب پیام‌ها را حفظ می‌کند؟
   </li>
<li>
    تضمین‌های تحویل—<strong>broker</strong> چه نوع تضمین‌های تحویلی را ارائه می‌دهد؟
   </li>
<li>
<strong>Persistence</strong>—آیا پیام‌ها در دیسک ماندگار هستند و می‌توانند از <strong>broker crashes</strong> جان سالم به در ببرند؟
   </li>
<li>
<strong>Durability</strong>—اگر یک <strong>consumer</strong> دوباره به <strong>message broker</strong> متصل شود، آیا این کار را خواهد کرد؟
    پیام‌هایی را که در زمان قطع شدن ارسال شده‌اند، دریافت کنید؟
   </li>
<li>
    مقیاس‌پذیری—<strong>message broker</strong> چقدر مقیاس‌پذیر است؟
   </li>
<li>
<strong>Latency</strong>—<strong>Latency</strong> <strong>end-to-end</strong> چقدر است؟
   </li>
<li>
    رقابت <strong>consumers</strong>—آیا <strong>message broker</strong> از <strong>competing consumers</strong> پشتیبانی می‌کند؟
   </li>
</ul>
<p>
   هر <strong>broker</strong> مقایسه‌های مختلفی را انجام می‌دهد. به عنوان مثال، یک <strong>broker</strong> با <strong>low-latency</strong> بسیار
   ممکن است ترتیب را حفظ نکند، هیچ تضمینی برای تحویل پیام‌ها نداشته باشد و فقط ذخیره کند
   پیام‌ها در حافظه. یک <strong>messaging broker</strong> که تحویل را تضمین می‌کند و به طور قابل اطمینانی ذخیره می‌کند
   پیام‌ها در دیسک احتمالاً <strong>latency</strong> بالاتری خواهند داشت. اینکه کدام نوع از <strong>message broker</strong> است
   بهترین تناسب بستگی به الزامات اپلیکیشن شما دارد. حتی ممکن است که متفاوت باشد
   بخش‌هایی از اپلیکیشن شما الزامات پیام‌رسانی متفاوتی خواهند داشت.
  </p>
<p>
   با این حال، احتمالاً ترتیب پیام‌رسانی و مقیاس‌پذیری ضروری هستند. بیایید اکنون
   نگاهی بیندازیم به نحوه پیاده‌سازی کانال‌های پیام با استفاده از یک <strong>message broker</strong>.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0122_original/original_page.png" alt="Original Page 122">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Communicating using the Asynchronous messaging pattern</h3>
<p>
<strong>IMPLEMENTING MESSAGE CHANNELS USING A MESSAGE BROKER</strong>
</p>
<p>
   هر <strong>message broker</strong>، مفهوم کانال پیام را به روشی متفاوت پیاده‌سازی می‌کند. به عنوان
   جدول 3.2 نشان می‌دهد، <strong>JMS message brokers</strong> مانند <strong>ActiveMQ</strong> دارای صف و <strong>topic</strong> هستند.
   <strong>AMQP-based message brokers</strong> مانند <strong>RabbitMQ</strong> دارای <strong>exchanges</strong> و صف هستند. <strong>Apache</strong>
<strong>Kafka</strong> دارای <strong>topic</strong>، <strong>AWS Kinesis</strong> دارای <strong>streams</strong>، و <strong>AWS SQS</strong> دارای صف است. چه چیزی بیشتر،
   برخی از <strong>message brokers</strong> پیام‌رسانی انعطاف‌پذیرتری را نسبت به پیام و کانال ارائه می‌دهند
   انتزاع توضیح داده شده در این فصل.
  </p>
<p>
   تقریباً همه <strong>message brokers</strong> که در اینجا توضیح داده شد از کانال‌های نقطه به نقطه و انتشار-اشتراک پشتیبانی می‌کنند.
   تنها استثنا، <strong>AWS SQS</strong> است، که فقط از کانال‌های نقطه به نقطه پشتیبانی می‌کند.
  </p>
<p>
   اکنون بیایید به مزایا و معایب پیام‌رسانی مبتنی بر <strong>broker</strong> نگاهی بیندازیم.
  </p>
<h4>BENEFITS AND DRAWBACKS OF BROKER-BASED MESSAGING</h4>
<p>
   مزایای زیادی برای استفاده از پیام‌رسانی مبتنی بر <strong>broker</strong> وجود دارد:
  </p>
<ul>
<li>
<strong>Loose coupling</strong>—یک کلاینت با ارسال یک پیام به
    کانال مناسب سرویس به سادگی یک <strong>request</strong> انجام می‌دهد. کلاینت کاملاً از نمونه‌های سرویس بی‌اطلاع است.
    نیازی به استفاده از یک مکانیسم <strong>discovery</strong> برای تعیین موقعیت یک <strong>ser-</strong>
<strong>vice instance</strong> ندارد.
   </li>
<li>
<strong>Message buffering</strong>—<strong>message broker</strong>، پیام‌ها را بافر می‌کند تا زمانی که بتوانند <strong>pro-</strong>
<strong>cessed</strong> شوند. با یک پروتکل <strong>request/response synchronous</strong> مانند <strong>HTTP</strong>، هر دو
    کلاینت و سرویس باید برای مدت زمان تبادل در دسترس باشند. با <strong>mes-</strong>
<strong>saging</strong>، اگرچه پیام‌ها در صف قرار می‌گیرند تا زمانی که بتوانند توسط <strong>con-</strong>
<strong>sumer</strong> پردازش شوند. این بدان معناست، به عنوان مثال، که یک فروشگاه آنلاین می‌تواند سفارش‌ها را از
    مشتریان بپذیرد، حتی زمانی که سیستم انجام سفارش، کند یا در دسترس نیست. این
    پیام‌ها به سادگی در صف قرار می‌گیرند تا زمانی که بتوانند پردازش شوند.
   </li>
<li>
    ارتباط انعطاف‌پذیر—پیام‌رسانی از همه سبک‌های تعامل پشتیبانی می‌کند
    قبلاً توضیح داده شد.
   </li>
<li>
    ارتباط <strong>interprocess</strong> صریح—مکانیسم مبتنی بر <strong>RPC</strong> تلاش می‌کند تا
    فراخوانی یک سرویس <strong>remote</strong> را مشابه فراخوانی یک سرویس محلی نشان می‌دهد. اما با توجه به قوانین
    فیزیک و احتمال <strong>partial failure</strong>، در واقع کاملاً متفاوت هستند.
   </li>
</ul>
<p>
   جدول 3.2
  </p>
<p>
   هر <strong>message broker</strong>، مفهوم کانال پیام را به روشی متفاوت پیاده‌سازی می‌کند.
  </p>
<table>
<thead>
<tr>
<th><strong>Message broker</strong></th>
<th>کانال نقطه به نقطه</th>
<th>کانال انتشار-اشتراک</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>JMS</strong></td>
<td>صف</td>
<td><strong>Topic</strong></td>
</tr>
<tr>
<td><strong>Apache Kafka</strong></td>
<td><strong>Topic</strong></td>
<td><strong>Topic</strong></td>
</tr>
<tr>
<td><strong>AMQP-based brokers</strong>، مانند
     <strong>RabbitMQ</strong></td>
<td><strong>Exchange + Queue</strong></td>
<td><strong>Fanout exchange</strong> و یک صف در هر
      <strong>consumer</strong></td>
</tr>
<tr>
<td><strong>AWS Kinesis</strong></td>
<td><strong>Stream</strong></td>
<td><strong>Stream</strong></td>
</tr>
<tr>
<td><strong>AWS SQS</strong></td>
<td>صف</td>
<td>—</td>
</tr>
</tbody>
</table>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0123_original/original_page.png" alt="Original Page 123">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
   پیام‌رسانی این تفاوت‌ها را بسیار صریح می‌کند، بنابراین توسعه‌دهندگان فریب نمی‌خورند
   یک حس کاذب از امنیت.
  </p>
<p>
   چندین اشکال برای استفاده از پیام‌رسانی وجود دارد:
  </p>
<ul>
<li>
<strong>Potential performance bottleneck</strong>—خطر این وجود دارد که <strong>message broker</strong> می‌تواند
    یک گلوگاه عملکردی باشد. خوشبختانه، بسیاری از <strong>message brokers</strong> مدرن هستند
    برای <strong>highly scalable</strong> طراحی شده‌اند.
   </li>
<li>
<strong>Potential single point of failure</strong>—ضروری است که <strong>message broker</strong> بسیار
    در دسترس باشد—در غیر این صورت، قابلیت اطمینان سیستم تحت تأثیر قرار می‌گیرد. خوشبختانه، اکثر
    <strong>brokers</strong> مدرن برای <strong>highly available</strong> طراحی شده‌اند.
   </li>
<li>
    پیچیدگی عملیاتی اضافی—سیستم پیام‌رسانی، یک سیستم دیگر است
    عنصر کامپوننت که باید نصب، پیکربندی و راه‌اندازی شود.
   </li>
</ul>
<p>
   بیایید به برخی از مسائل طراحی که ممکن است با آن مواجه شوید، نگاهی بیندازیم.
  </p>
<h4>3.3.5 Competing receivers and message ordering</h4>
<p>
   یک چالش این است که چگونه <strong>receivers</strong> پیام را مقیاس‌بندی کنیم در حالی که ترتیب پیام را حفظ می‌کنیم.
   یک نیاز رایج داشتن چندین نمونه از یک سرویس به منظور
   پیام‌ها را همزمان پردازش کنید. علاوه بر این، حتی یک نمونه سرویس واحد احتمالاً استفاده خواهد کرد
   <strong>threads</strong> برای پردازش همزمان چندین پیام. استفاده از چندین <strong>thread</strong> و سرویس
   نمونه‌ها برای پردازش همزمان پیام‌ها، توان عملیاتی اپلیکیشن را افزایش می‌دهد.
   اما چالش در پردازش پیام‌ها به طور همزمان اطمینان از این است که هر
   پیام یک بار و به ترتیب پردازش می‌شود.
  </p>
<p>
   به عنوان مثال، تصور کنید که سه نمونه از یک سرویس وجود دارد که از
   یک کانال نقطه به نقطه یکسان و اینکه یک <strong>sender</strong>، <strong>Order Created</strong>، <strong>Order Updated</strong>،
   و <strong>Order Cancelled event messages</strong> به ترتیب. یک پیاده‌سازی پیام‌رسانی ساده‌لوحانه
   می‌تواند همزمان هر پیام را به یک <strong>receiver</strong> متفاوت تحویل دهد. به دلیل تاخیرها
   به دلیل مشکلات شبکه یا <strong>garbage collections</strong>، پیام‌ها ممکن است خارج از ترتیب پردازش شوند،
   که منجر به رفتار عجیبی می‌شود. از نظر تئوری، یک نمونه سرویس ممکن است
   پیام <strong>Order Cancelled</strong> را قبل از اینکه سرویس دیگری پیام <strong>Order Created</strong> را پردازش کند!
  </p>
<p>
   یک راه‌حل رایج، که توسط <strong>message brokers</strong> مدرن مانند <strong>Apache Kafka</strong> و <strong>AWS</strong> استفاده می‌شود
   <strong>Kinesis</strong>، استفاده از کانال‌های <strong>sharded (partitioned)</strong> است. شکل 3.11 نحوه عملکرد این را نشان می‌دهد.
  </p>
<p>
   سه بخش برای راه‌حل وجود دارد:
  </p>
<ol>
<li>
    یک کانال <strong>sharded</strong> از دو یا چند <strong>shards</strong> تشکیل شده است که هر کدام مانند
    یک کانال رفتار می‌کند.
   </li>
<li>
<strong>sender</strong>، یک کلید <strong>shard</strong> را در <strong>header</strong> پیام مشخص می‌کند، که معمولاً یک است
    رشته دلخواه یا دنباله‌ای از بایت‌ها. <strong>message broker</strong> از یک کلید <strong>shard</strong> استفاده می‌کند تا
    پیام را به یک <strong>shard/partition</strong> خاص اختصاص دهید. به عنوان مثال، ممکن است
    <strong>shard</strong> را با محاسبه <strong>hash</strong> کلید <strong>shard</strong> <strong>modulo</strong> تعداد <strong>shards</strong> انتخاب کنید.
   </li>
<li>
<strong>messaging broker</strong>، چندین نمونه از یک <strong>receiver</strong> را با هم گروه‌بندی می‌کند و
    با آنها به عنوان همان <strong>receiver</strong> منطقی رفتار می‌کند. به عنوان مثال، <strong>Apache Kafka</strong> از
    اصطلاح <strong>consumer group</strong> استفاده می‌کند. <strong>message broker</strong>، هر <strong>shard</strong> را به یک <strong>receiver</strong> واحد اختصاص می‌دهد.
    وقتی <strong>receivers</strong> راه‌اندازی و خاموش می‌شوند، <strong>shards</strong> را دوباره اختصاص می‌دهد.
   </li>
</ol>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0124_original/original_page.png" alt="Original Page 124">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Communicating using the Asynchronous messaging pattern</h3>
<p>
   در این مثال، هر پیام <strong>Order event</strong> دارای <strong>orderId</strong> به عنوان کلید <strong>shard</strong> است. هر <strong>event</strong>
   برای یک <strong>order</strong> خاص به همان <strong>shard</strong> منتشر می‌شود، که توسط یک نمونه <strong>consumer</strong> واحد خوانده می‌شود.
   در نتیجه، تضمین می‌شود که این پیام‌ها به ترتیب پردازش شوند.
  </p>
<h4>3.3.6 Handling duplicate messages</h4>
<p>
   چالش دیگری که هنگام استفاده از پیام‌رسانی باید با آن مقابله کنید، رسیدگی به پیام‌های تکراری است.
   یک <strong>message broker</strong> در حالت ایده‌آل باید هر پیام را فقط یک بار تحویل دهد، اما <strong>guar-</strong>
<strong>anteeing exactly-once messaging</strong> معمولاً بیش از حد هزینه بر است. در عوض، اکثر <strong>message brokers</strong>
   قول می‌دهند که یک پیام را حداقل یک بار تحویل دهند.
  </p>
<p>
   وقتی سیستم به طور معمول کار می‌کند، یک <strong>message broker</strong> که تحویل <strong>at-least-</strong>
   یک بار را تضمین می‌کند، هر پیام را فقط یک بار تحویل می‌دهد. اما خرابی یک کلاینت، شبکه یا
   <strong>message broker</strong> می‌تواند منجر به این شود که یک پیام چندین بار تحویل داده شود. فرض کنید یک کلاینت
   پس از پردازش یک پیام و به‌روزرسانی <strong>database</strong> خود - اما قبل از تأیید
   پیام. <strong>message broker</strong> دوباره پیام تأیید نشده را تحویل می‌دهد،
   یا به آن کلاینت زمانی که دوباره راه‌اندازی می‌شود یا به یک <strong>replica</strong> دیگر از کلاینت.
  </p>
<p>
   در حالت ایده‌آل، شما باید از یک <strong>message broker</strong> استفاده کنید که ترتیب را هنگام تحویل مجدد
   پیام‌ها حفظ می‌کند. تصور کنید که کلاینت یک رویداد <strong>Order Created</strong> را دنبال می‌کند
   یک رویداد <strong>Order Cancelled</strong> برای همان <strong>Order</strong>، و به نوعی <strong>Order Created</strong>
<strong>event</strong> تأیید نشده بود. <strong>message broker</strong> باید رویدادهای <strong>Order Cre-</strong>
<strong>ated</strong> و <strong>Order Cancelled</strong> را دوباره تحویل دهد. اگر فقط <strong>Order Created</strong> را دوباره تحویل دهد، کلاینت
   ممکن است لغو <strong>Order</strong> را لغو کند.
  </p>
<p>
   چندین راه مختلف برای رسیدگی به پیام‌های تکراری وجود دارد:
  </p>
<ul>
<li>
    نوشتن <strong>idempotent message handlers</strong>.
   </li>
<li>
    پیام‌ها را ردیابی کنید و موارد تکراری را دور بریزید.
   </li>
</ul>
<p>
   بیایید به هر گزینه نگاهی بیندازیم.
  </p>
<p>
   مسیرها بر اساس یک
   <strong>hash</strong> از <strong>shard-key</strong>
   دریافت کننده <strong>A</strong>
   نمونه 1
   دریافت کننده <strong>A</strong>
   نمونه 2
   دریافت کننده
   اختصاص <strong>Shard</strong>
   دریافت کننده
   ...
   روتر
   <strong>Shard 0</strong>
   کانال
   دریافت‌کننده منطقی <strong>A</strong>
<strong>Shard 1</strong>
<strong>Shard ...</strong>
   ایجاد <strong>order</strong>
<strong>request</strong>
<strong>Shard-key:orderId</strong>
   فرستنده
  </p>
<p>
   شکل 3.11
   مقیاس‌بندی مصرف‌کنندگان در حالی که ترتیب پیام‌ها را با استفاده از یک کانال پیام <strong>sharded (partitioned)</strong> حفظ می‌کنید.
   <strong>sender</strong> شامل کلید <strong>shard</strong> در پیام است. <strong>message broker</strong>، پیام را به یک <strong>shard</strong> می‌نویسد
   که توسط کلید <strong>shard</strong> تعیین می‌شود. <strong>message broker</strong>، هر پارتیشن را به یک نمونه از <strong>receiver</strong> تکراری اختصاص می‌دهد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0125_original/original_page.png" alt="Original Page 125">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
<strong>WRITING IDEMPOTENT MESSAGE HANDLERS</strong>
</p>
<p>
   اگر منطق اپلیکیشنی که پیام‌ها را پردازش می‌کند، <strong>idempotent</strong> باشد، پیام‌های تکراری
   بی‌ضرر هستند. منطق اپلیکیشن <strong>idempotent</strong> است اگر فراخوانی آن چندین بار با
   مقادیر ورودی یکسان هیچ اثر اضافی ندارد. به عنوان مثال، لغو یک <strong>order</strong> از قبل لغو شده است
   یک عملیات <strong>idempotent</strong> است. همچنین ایجاد یک <strong>order</strong> با یک <strong>ID</strong> ارائه شده توسط کلاینت.
  </p>
<p>
   یک <strong>idempotent message handler</strong> را می‌توان با خیال راحت چندین بار اجرا کرد، به شرطی که
   <strong>message broker</strong>، ترتیب را هنگام تحویل مجدد پیام‌ها حفظ کند.
  </p>
<p>
   متأسفانه، منطق اپلیکیشن اغلب <strong>idempotent</strong> نیست. یا ممکن است از یک
   <strong>message broker</strong> استفاده کنید که ترتیب را هنگام تحویل مجدد پیام‌ها حفظ نمی‌کند. تکراری
   یا پیام‌های خارج از ترتیب می‌توانند باعث <strong>bugs</strong> شوند. در این شرایط، شما باید پیام
   <strong>handlers</strong> بنویسید که پیام‌ها را ردیابی کنند و پیام‌های تکراری را دور بریزند.
  </p>
<p>
<strong>TRACKING MESSAGES AND DISCARDING DUPLICATES</strong>
</p>
<p>
   به عنوان مثال، یک <strong>message handler</strong> را در نظر بگیرید که کارت اعتباری یک <strong>consumer</strong> را تأیید می‌کند. این
   باید کارت را دقیقاً یک بار برای هر <strong>order</strong> تأیید کند. این مثال از منطق اپلیکیشن
   هر بار که فراخوانی می‌شود، یک اثر متفاوت دارد. اگر پیام‌های تکراری باعث شد که
   <strong>message handler</strong>، این منطق را چندین بار اجرا کند، اپلیکیشن رفتار نادرستی خواهد داشت.
  </p>
<p>
<strong>message handler</strong> که این نوع منطق اپلیکیشن را اجرا می‌کند، باید <strong>idem-</strong> شود
   <strong>potent</strong> با تشخیص و دور ریختن پیام‌های تکراری.
  </p>
<p>
   یک راه‌حل ساده این است که یک <strong>message consumer</strong> پیام‌هایی را که انجام داده است، ردیابی کند.
   پردازش شده با استفاده از <strong>message id</strong> و دور ریختن هر گونه تکراری. به عنوان مثال، می‌تواند ذخیره کند
   <strong>message id</strong> هر پیام را که در یک جدول <strong>database</strong> مصرف کرده است. شکل 3.12
   نشان می‌دهد که چگونه این کار را با استفاده از یک جدول اختصاصی انجام دهید.
  </p>
<p>
   هنگامی که یک <strong>consumer</strong> یک پیام را مدیریت می‌کند، <strong>message id</strong> را در جدول <strong>database</strong> ثبت می‌کند.
   به عنوان بخشی از <strong>transaction</strong> که موجودیت‌های <strong>business</strong> را ایجاد و به‌روزرسانی می‌کند. در این مثال،
   <strong>consumer</strong>، ردیفی را شامل <strong>message id</strong> در یک جدول <strong>PROCESSED_MESSAGES</strong> وارد می‌کند. اگر یک
   پیام تکراری است، <strong>INSERT</strong> شکست می‌خورد و <strong>consumer</strong> می‌تواند پیام را دور بریزد.
  </p>
<p>
<strong>MSG_ID</strong>
   جدول <strong>PROCESSED_MESSAGE</strong>
<strong>INSERT</strong>
<strong>INSERT</strong> برای
   پیام‌های تکراری شکست می‌خورد.
   <strong>UPDATE</strong>
   ...
   ...
   جدول اپلیکیشن
   <strong>xyz</strong>
<strong>Transaction</strong>
   پیام
   <strong>id: xyz</strong>
<strong>Consumer</strong>
</p>
<p>
   شکل 3.12
   یک <strong>consumer</strong>، پیام‌های تکراری را با ثبت <strong>IDs</strong> از
   پیام‌های پردازش شده در یک جدول <strong>database</strong>. اگر پیامی قبلاً پردازش شده باشد، <strong>INSERT</strong>
   به جدول <strong>PROCESSED_MESSAGES</strong> شکست می‌خورد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0126_original/original_page.png" alt="Original Page 126">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Communicating using the Asynchronous messaging pattern</h3>
<p>
   یک گزینه دیگر این است که یک <strong>message handler</strong> <strong>message ids</strong> را در یک اپلیکیشن ثبت کند
   جدول به جای یک جدول اختصاصی. این رویکرد به ویژه هنگام استفاده از یک
   <strong>NoSQL database</strong> که دارای یک مدل <strong>transaction</strong> محدود است، مفید است، بنابراین از <strong>updat-</strong>
   دو جدول به عنوان بخشی از یک <strong>database transaction</strong> پشتیبانی نمی‌کند. فصل 7 مثالی از این را نشان می‌دهد
   رویکرد.
  </p>
<h4>3.3.7 Transactional messaging</h4>
<p>
   یک سرویس اغلب نیاز دارد که پیام‌ها را به عنوان بخشی از یک <strong>transaction</strong> منتشر کند که
   <strong>database</strong> را به‌روزرسانی می‌کند. به عنوان مثال، در سراسر این کتاب، نمونه‌هایی از سرویس‌ها را می‌بینید که
   <strong>domain events</strong> را هر زمان که موجودیت‌های <strong>business</strong> را ایجاد یا به‌روزرسانی می‌کنند، منتشر می‌کنند. هر دو <strong>database</strong>
<strong>update</strong> و ارسال پیام باید در یک <strong>transaction</strong> اتفاق بیفتد. در غیر این صورت،
   به عنوان مثال، یک سرویس ممکن است <strong>database</strong> را به‌روزرسانی کند و سپس خراب شود
   پیام را ارسال کنید. اگر سرویس این دو عملیات را به صورت اتمی انجام ندهد، یک <strong>failure</strong>
   می‌تواند سیستم را در یک حالت ناسازگار رها کند.
  </p>
<p>
   راه‌حل سنتی استفاده از یک <strong>transaction</strong> توزیع شده است که <strong>database</strong> را در بر می‌گیرد
   و <strong>message broker</strong>. اما همانطور که در فصل 4 خواهید آموخت، <strong>transactions</strong> توزیع شده
   انتخاب خوبی برای اپلیکیشن‌های مدرن نیستند. علاوه بر این، بسیاری از <strong>brokers</strong> مدرن مانند
   <strong>Apache Kafka</strong> از <strong>transactions</strong> توزیع شده پشتیبانی نمی‌کنند.
  </p>
<p>
   در نتیجه، یک اپلیکیشن باید از یک مکانیسم متفاوت برای انتشار قابل اطمینان استفاده کند
   پیام‌ها بیایید نگاهی بیندازیم به نحوه عملکرد این.
  </p>
<h4>USING A DATABASE TABLE AS A MESSAGE QUEUE</h4>
<p>
   بیایید تصور کنیم که اپلیکیشن شما از یک <strong>relational database</strong> استفاده می‌کند. یک سر راست
   راه برای انتشار مطمئن پیام‌ها، اعمال الگوی <strong>Transactional outbox</strong> است. این
   الگو از یک جدول <strong>database</strong> به عنوان یک صف پیام موقت استفاده می‌کند. همانطور که شکل 3.13 نشان می‌دهد، یک
   سرویسی که پیام ارسال می‌کند دارای یک جدول <strong>OUTBOX database</strong> است. به عنوان بخشی از <strong>database</strong>
</p>
<p>
   سرویس سفارش
   خواندن
   جدول <strong>OUTBOX</strong>
   منتشر می‌کند
   ...
   ...
   جدول <strong>ORDER</strong>
<strong>INSERT,</strong>
<strong>UPDATE,DELETE</strong>
<strong>INSERT</strong>
<strong>Database</strong>
   پیام
   رله
   <strong>Transaction</strong>
   جدول <strong>OUTBOX</strong>
   پیام
   <strong>broker</strong>
</p>
<p>
   شکل 3.13
   یک سرویس، یک پیام را با قرار دادن آن در یک جدول <strong>OUTBOX</strong> به عنوان بخشی از
   <strong>transaction</strong> که <strong>database</strong> را به‌روزرسانی می‌کند، با اطمینان منتشر می‌کند. <strong>Message Relay</strong>، <strong>OUTBOX</strong> را می‌خواند
   جدول و پیام‌ها را به یک <strong>message broker</strong> منتشر می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0127_original/original_page.png" alt="Original Page 127">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
<strong>transaction</strong> که <strong>business objects</strong> را ایجاد، به‌روزرسانی و حذف می‌کند، سرویس <strong>mes-</strong>
   پیام‌ها را با درج آنها در جدول <strong>OUTBOX</strong> ارسال می‌کند. اتمیسیته تضمین شده است زیرا این یک
   <strong>transaction ACID</strong> محلی است.
  </p>
<p>
   جدول <strong>OUTBOX</strong> به عنوان یک صف پیام موقت عمل می‌کند. <strong>MessageRelay</strong> یک <strong>compo-</strong>
   نت است که جدول <strong>OUTBOX</strong> را می‌خواند و پیام‌ها را به یک <strong>message broker</strong> منتشر می‌کند.
  </p>
<p>
   شما می‌توانید از یک رویکرد مشابه با برخی از <strong>NoSQL databases</strong> استفاده کنید. هر موجودیت <strong>business</strong>
   ذخیره شده به عنوان یک رکورد در <strong>database</strong> دارای یک <strong>attribute</strong> است که لیستی از پیام‌ها است که نیاز دارند
   منتشر شوند. هنگامی که یک سرویس یک موجودیت را در <strong>database</strong> به‌روزرسانی می‌کند، یک <strong>mes-</strong>
<strong>sage</strong> را به آن لیست اضافه می‌کند. این <strong>atomic</strong> است زیرا با یک عمل <strong>database</strong> واحد انجام می‌شود. این
   با این حال، چالش این است که به طور کارآمد آن موجودیت‌های <strong>business</strong> را که دارای رویدادها هستند، پیدا کنیم و
   آنها را منتشر کنید.
  </p>
<p>
   چند راه مختلف برای انتقال پیام‌ها از <strong>database</strong> به
   <strong>message broker</strong> وجود دارد. ما به هر کدام نگاهی خواهیم داشت.
  </p>
<h4>PUBLISHING EVENTS BY USING THE POLLING PUBLISHER PATTERN</h4>
<p>
   اگر اپلیکیشن از یک <strong>relational database</strong> استفاده می‌کند، یک راه بسیار ساده برای انتشار پیام‌ها
   در جدول <strong>OUTBOX</strong> درج شده این است که <strong>MessageRelay</strong>، جدول را برای <strong>unpub-</strong> <strong>lished</strong>
   پیام‌ها <strong>poll</strong> کند. این جدول را به صورت دوره‌ای <strong>queries</strong> می‌کند:
  </p>
<pre>
   <code>
    SELECT * FROM OUTBOX ORDERED BY ... ASC
   </code>
  </pre>
<p>
   در مرحله بعد، <strong>MessageRelay</strong> آن پیام‌ها را به <strong>message broker</strong> منتشر می‌کند و یکی را ارسال می‌کند
   به کانال پیام مقصد آن. در نهایت، آن پیام‌ها را از جدول <strong>OUTBOX</strong> حذف می‌کند:
  </p>
<pre>
   <code>
    BEGIN
    DELETE FROM OUTBOX WHERE ID in (....)
    COMMIT
   </code>
  </pre>
<p>
<strong>Polling</strong> <strong>database</strong> یک رویکرد ساده است که در مقیاس کم به خوبی کار می‌کند.
   نقطه ضعف این است که <strong>polling</strong> مکرر <strong>database</strong> می‌تواند پرهزینه باشد. همچنین، اینکه آیا
   می‌توانید از این رویکرد با یک <strong>NoSQL database</strong> استفاده کنید، به قابلیت‌های <strong>querying</strong> آن بستگی دارد.
   این به این دلیل است که به جای <strong>querying</strong> یک جدول <strong>OUTBOX</strong>، اپلیکیشن باید <strong>query</strong> کند
  </p>
<p>
   الگو: <strong>Transactional outbox</strong>
</p>
<p>
   یک <strong>event</strong> یا پیام را به عنوان بخشی از یک <strong>database transaction</strong> با ذخیره آن در یک <strong>OUT-</strong>
<strong>BOX</strong> در <strong>database</strong> منتشر کنید. به <strong>http://microservices.io/patterns/data/transactional-out-</strong>
<strong>box.html</strong> مراجعه کنید.
  </p>
<p>
   الگو: <strong>Polling publisher</strong>
</p>
<p>
   پیام‌ها را با <strong>polling outbox</strong> در <strong>database</strong> منتشر کنید. به <strong>http://microser-</strong>
<strong>vices.io/patterns/data/polling-publisher.html</strong> مراجعه کنید.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0128_original/original_page.png" alt="Original Page 128">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Communicating using the Asynchronous messaging pattern</h3>
<p>
   کیان <strong>business entities</strong>، و این ممکن است به طور کارآمد انجام شود یا نشود. به دلیل
   این معایب و محدودیت‌ها، اغلب بهتر است - و در برخی موارد، ضروری است -
   از رویکرد پیچیده‌تر و با عملکرد بهتر <strong>tailing</strong> <strong>database transaction log</strong> استفاده کنید.
  </p>
<h4>PUBLISHING EVENTS BY APPLYING THE TRANSACTION LOG TAILING PATTERN</h4>
<p>
   یک راه‌حل پیچیده این است که <strong>MessageRelay</strong>، <strong>database transaction log</strong> را <strong>tail</strong> کند (همچنین
   به نام <strong>commit log</strong> نیز شناخته می‌شود). هر به‌روزرسانی تأیید شده توسط یک اپلیکیشن نشان‌دهنده است
   به عنوان یک ورودی در <strong>transaction log</strong> <strong>database</strong>. یک <strong>transaction log miner</strong> می‌تواند بخواند
   <strong>transaction log</strong> و هر تغییر را به عنوان یک پیام به <strong>message broker</strong> منتشر می‌کند. شکل 3.14
   نشان می‌دهد که چگونه این رویکرد کار می‌کند.
  </p>
<p>
<strong>Transaction Log Miner</strong>، ورودی‌های <strong>transaction log</strong> را می‌خواند. این تبدیل می‌کند
   هر ورودی <strong>log</strong> مربوط به یک پیام درج شده به یک پیام و آن را منتشر می‌کند
   پیام را به <strong>message broker</strong>. این رویکرد می‌تواند برای انتشار پیام‌های نوشته شده به
   یک جدول <strong>OUTBOX</strong> در یک <strong>RDBMS</strong> یا پیام‌های ضمیمه شده به رکوردها در یک <strong>NoSQL database</strong>.
  </p>
<p>
   الگو: <strong>Transaction log tailing</strong>
</p>
<p>
   تغییرات ایجاد شده در <strong>database</strong> را با <strong>tailing transaction log</strong> منتشر کنید. به <strong>http://micro-</strong>
<strong>services.io/patterns/data/transaction-log-tailing.html</strong> مراجعه کنید.
  </p>
<p>
<strong>Database</strong>
   جدول <strong>OUTBOX</strong>
<strong>Transaction log</strong>
<strong>Transaction log</strong>
<strong>miner</strong>
<strong>INSERT INTO OUTBOX ...</strong>
   پیام
   <strong>broker</strong>
   تغییرات
   منتشر می‌کند
   سرویس سفارش
   درج‌های <strong>Committed</strong> به
   جدول <strong>OUTBOX</strong> هستند
   در <strong>database</strong> ضبط شده است
   <strong>transaction log</strong>.
   <strong>Reads the transaction log</strong>
</p>
<p>
   شکل 3.14
   یک سرویس پیام‌های درج شده در جدول <strong>OUTBOX</strong> را با <strong>mining</strong> منتشر می‌کند
   <strong>transaction log database</strong>.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0129_original/original_page.png" alt="Original Page 129">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
   چندین نمونه از این رویکرد در حال استفاده وجود دارد:
  </p>
<ul>
<li>
<strong>Debezium</strong> (http://debezium.io)—یک پروژه <strong>open source</strong> که داده‌های <strong>data-</strong>
<strong>base</strong> را به <strong>Apache Kafka message broker</strong> منتشر می‌کند.
   </li>
<li>
<strong>LinkedIn Databus</strong> (https://github.com/linkedin/databus)—یک پروژه <strong>open source</strong> که <strong>transaction log</strong> اوراکل را <strong>mines</strong> می‌کند و تغییرات را به عنوان <strong>events</strong> منتشر می‌کند.
    <strong>LinkedIn</strong> از <strong>Databus</strong> برای همگام‌سازی فروشگاه‌های داده مشتق شده مختلف با <strong>sys-</strong>
<strong>tem of record</strong> استفاده می‌کند.
   </li>
<li>
<strong>DynamoDB streams</strong> (http://docs.aws.amazon.com/amazondynamodb/latest/
    <strong>developerguide/Streams.html</strong>)—جریان‌های <strong>DynamoDB</strong> شامل توالی تغییرات مرتب شده بر اساس زمان (ایجاد، به‌روزرسانی و حذف) است که در موارد در یک
    جدول <strong>DynamoDB</strong> در 24 ساعت گذشته انجام شده است. یک اپلیکیشن می‌تواند آن تغییرات را
    از جریان بخواند و، به عنوان مثال، آنها را به عنوان <strong>events</strong> منتشر کند.
   </li>
<li>
<strong>Eventuate Tram</strong> (https://github.com/eventuate-tram/eventuate-tram-core)—کتابخانه پیام‌رسانی <strong>transaction</strong> متن باز خود شما که از <strong>MySQL</strong>
<strong>binlog protocol</strong>، <strong>Postgres WAL</strong> یا <strong>polling</strong> برای خواندن تغییرات ایجاد شده استفاده می‌کند
    به یک جدول <strong>OUTBOX</strong> و انتشار آنها به <strong>Apache Kafka</strong>.
   </li>
</ul>
<p>
   اگرچه این رویکرد نامشخص است، اما به طرز چشمگیری خوب عمل می‌کند. چالش این است که
   پیاده‌سازی آن نیاز به مقداری تلاش توسعه دارد. به عنوان مثال، می‌توانید کد سطح پایین را بنویسید
   که <strong>APIs</strong> خاص <strong>database</strong> را فراخوانی می‌کند. از طرف دیگر، می‌توانید از یک <strong>open source</strong> استفاده کنید
   فریم‌ورک مانند <strong>Debezium</strong> که تغییرات ایجاد شده توسط یک اپلیکیشن را به <strong>MySQL</strong>، منتشر می‌کند.
   <strong>Postgres</strong> یا <strong>MongoDB</strong> به <strong>Apache Kafka</strong>. اشکال استفاده از <strong>Debezium</strong> این است که
   تمرکز آن بر گرفتن تغییرات در سطح <strong>database</strong> است و <strong>APIs</strong> برای ارسال و دریافت
   پیام‌ها خارج از محدوده آن هستند. به همین دلیل من فریم‌ورک <strong>Eventuate Tram</strong> را ایجاد کردم،
   که <strong>APIs</strong> پیام‌رسانی و همچنین <strong>transaction tailing</strong> و <strong>polling</strong> را ارائه می‌دهد.
  </p>
<h4>3.3.8 Libraries and frameworks for messaging</h4>
<p>
   یک سرویس نیاز دارد که از یک کتابخانه برای ارسال و دریافت پیام استفاده کند. یک رویکرد این است که از
   کتابخانه کلاینت <strong>message broker</strong> استفاده کنید، اگرچه چندین مشکل با استفاده از
   چنین کتابخانه‌ای مستقیماً وجود دارد:
  </p>
<ul>
<li>
    کتابخانه کلاینت، منطق کسب‌وکاری را که پیام‌ها را به <strong>message</strong> منتشر می‌کند، <strong>couples</strong>
<strong>broker APIs</strong>.
   </li>
<li>
    کتابخانه کلاینت یک <strong>message broker</strong>، معمولاً سطح پایین است و به خطوط زیادی نیاز دارد
    کد برای ارسال یا دریافت یک پیام. به عنوان یک توسعه‌دهنده، شما نمی‌خواهید بارها و بارها
    کد <strong>boilerplate</strong> بنویسید. همچنین، به عنوان نویسنده این کتاب، من نمی‌خواهم کد مثال باشد
    با <strong>boilerplate</strong> سطح پایین <strong>cluttered</strong> شده است.
   </li>
<li>
    کتابخانه کلاینت معمولاً فقط مکانیسم اصلی را برای ارسال و ارائه می‌دهد
    دریافت پیام‌ها و از سبک‌های تعامل سطح بالاتر پشتیبانی نمی‌کند.
   </li>
</ul>
<p>
   یک رویکرد بهتر استفاده از یک کتابخانه یا فریم‌ورک سطح بالاتر است که <strong>details</strong> سطح پایین را پنهان می‌کند
   و مستقیماً از سبک‌های تعامل سطح بالاتر پشتیبانی می‌کند. برای سادگی،
   مثال‌ها در این کتاب از فریم‌ورک <strong>Eventuate Tram</strong> من استفاده می‌کنند. این یک ساده، آسان است
   برای درک <strong>API</strong> که پیچیدگی استفاده از <strong>message broker</strong> را پنهان می‌کند. علاوه بر یک <strong>API</strong>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0130_original/original_page.png" alt="Original Page 130">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Communicating using the Asynchronous messaging pattern</h3>
<p>
   برای ارسال و دریافت پیام‌ها، <strong>Eventuate Tram</strong> همچنین از <strong>inter-</strong> سبک‌های <strong>action</strong>
   سطح بالاتری مانند <strong>request/response asynchronous</strong> و انتشار <strong>domain event</strong> پشتیبانی می‌کند.
  </p>
<p>
<strong>Eventuate Tram</strong> همچنین دو مکانیسم مهم را پیاده‌سازی می‌کند:
  </p>
<ul>
<li>
    پیام‌رسانی <strong>Transactional</strong>—پیام‌ها را به عنوان بخشی از یک <strong>database transaction</strong> منتشر می‌کند.
   </li>
<li>
    تشخیص پیام تکراری—<strong>consumer</strong> پیام <strong>Eventuate Tram</strong>، پیام‌های تکراری را تشخیص می‌دهد و
    آنها را دور می‌اندازد، که برای اطمینان از اینکه یک <strong>consumer</strong>
    پیام‌ها را دقیقاً یک بار پردازش می‌کند، همانطور که در بخش 3.3.6 مورد بحث قرار گرفت، ضروری است.
   </li>
</ul>
<p>
   بیایید به <strong>APIs Eventuate Tram</strong> نگاهی بیندازیم.
  </p>
<h4>BASIC MESSAGING</h4>
<p>
<strong>API</strong> پیام‌رسانی اصلی از دو <strong>Java interface</strong> تشکیل شده است: <strong>MessageProducer</strong> و <strong>Message-</strong>
<strong>Consumer</strong>. یک سرویس <strong>producer</strong> از رابط <strong>MessageProducer</strong> برای انتشار پیام‌ها استفاده می‌کند
   به کانال‌های پیام. در اینجا مثالی از استفاده از این <strong>interface</strong> آمده است:
  </p>
<pre>
   <code>
    MessageProducer messageProducer = ...;
    String channel = ...;
    String payload = ...;
    messageProducer.send(destination, MessageBuilder.withPayload(payload).build())
   </code>
  </pre>
<p>
   یک سرویس <strong>consumer</strong> از <strong>MessageConsumer interface</strong> برای اشتراک در پیام‌ها استفاده می‌کند:
  </p>
<pre>
   <code>
    MessageConsumer messageConsumer;
    messageConsumer.subscribe(subscriberId, Collections.singleton(destination), 
    message -&gt; { ... })
   </code>
  </pre>
<p>
<strong>MessageProducer</strong> و <strong>MessageConsumer</strong>، اساس <strong>APIs</strong> سطح بالاتر هستند
   برای <strong>request/response asynchronous</strong> و انتشار <strong>domain event</strong>.
  </p>
<p>
   بیایید در مورد نحوه انتشار و اشتراک در رویدادها صحبت کنیم.
  </p>
<p>
   چه چیزی!؟ چرا فریم‌ورک‌های <strong>Eventuate</strong>؟
  </p>
<p>
   نمونه‌های کد در این کتاب از فریم‌ورک‌های <strong>open source Eventuate</strong> که من توسعه داده‌ام استفاده می‌کنند
   برای پیام‌رسانی <strong>transactional</strong>، <strong>event sourcing</strong>، و <strong>sagas</strong>. من استفاده از خودم را انتخاب کردم
   فریم‌ورک‌ها زیرا، بر خلاف، به عنوان مثال، تزریق وابستگی و فریم‌ورک <strong>Spring</strong>، وجود ندارد
   فریم‌ورک‌های گسترده‌ای برای بسیاری از ویژگی‌های معماری <strong>microser-</strong> وجود دارد.
   معماری سرویس نیاز دارد. بدون فریم‌ورک <strong>Eventuate Tram</strong>، بسیاری از نمونه‌ها
   باید از <strong>APIs</strong> پیام‌رسانی سطح پایین مستقیماً استفاده می‌کردند، که آنها را بسیار پیچیده‌تر می‌کند
   و مفاهیم مهم را پنهان می‌کند. یا آنها از فریم‌ورکی استفاده می‌کنند که
   به طور گسترده پذیرفته نشده است، که همچنین باعث انتقاد می‌شود.
  </p>
<p>
   در عوض، مثال‌ها از فریم‌ورک‌های <strong>Eventuate Tram</strong> استفاده می‌کنند، که یک ساده دارند،
   <strong>API</strong> با درک آسان که جزئیات پیاده‌سازی را پنهان می‌کند. شما می‌توانید از اینها استفاده کنید
   فریم‌ورک‌ها در اپلیکیشن‌های خود. از طرف دیگر، می‌توانید <strong>Eventuate Tram</strong> را مطالعه کنید
   فریم‌ورک‌ها و خودتان مفاهیم را دوباره پیاده‌سازی کنید.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0131_original/original_page.png" alt="Original Page 131">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3</strong></h3>
<h3><strong>Interprocess communication</strong> در یک معماری <strong>microservice</strong></h3>
<p>
<strong>DOMAIN EVENT PUBLISHING</strong>
</p>
<p>
<strong>Eventuate Tram</strong> دارای <strong>APIs</strong> برای انتشار و مصرف <strong>domain events</strong> است. فصل 5
   توضیح می‌دهد که <strong>domain events</strong>، <strong>events</strong> هستند که توسط یک <strong>aggregate</strong> (<strong>business</strong>
<strong>object</strong>) هنگام ایجاد، به‌روزرسانی یا حذف آن منتشر می‌شود. یک سرویس یک <strong>domain event</strong> را منتشر می‌کند
   با استفاده از رابط <strong>DomainEventPublisher</strong>. در اینجا مثالی وجود دارد:
  </p>
<pre>
   <code>
    DomainEventPublisher domainEventPublisher;
    String accountId = ...;
    DomainEvent domainEvent = new AccountDebited(...);
    domainEventPublisher.publish("Account", accountId, Collections.singletonList(
    domainEvent));
   </code>
  </pre>
<p>
   یک سرویس، <strong>domain events</strong> را با استفاده از <strong>DomainEventDispatcher</strong> مصرف می‌کند. یک مثال
   در ادامه آمده است:
  </p>
<pre>
   <code>
    DomainEventHandlers domainEventHandlers = DomainEventHandlersBuilder
    .forAggregateType("Order")
    .onEvent(AccountDebited.class, domainEvent -&gt; { ... })
    .build();
    new DomainEventDispatcher("eventDispatcherId",
    domainEventHandlers,
    messageConsumer);
   </code>
  </pre>
<p>
<strong>Events</strong> تنها الگوی پیام‌رسانی سطح بالایی که توسط <strong>Eventuate Tram</strong> پشتیبانی می‌شود، نیستند. آن
   همچنین از پیام‌رسانی مبتنی بر <strong>command/reply</strong> پشتیبانی می‌کند.
  </p>
<p>
<strong>COMMAND/REPLY-BASED MESSAGING</strong>
</p>
<p>
   یک کلاینت می‌تواند یک پیام <strong>command</strong> را با استفاده از رابط <strong>CommandProducer</strong> به یک سرویس ارسال کند.
   به عنوان مثال
  </p>
<pre>
   <code>
    CommandProducer commandProducer = ...;
    Map&lt;String, String&gt; extraMessageHeaders = Collections.emptyMap();
    String commandId = commandProducer.send("CustomerCommandChannel",
    new DoSomethingCommand(),
    "ReplyToChannel",
    extraMessageHeaders);
   </code>
  </pre>
<p>
   یک سرویس، پیام‌های <strong>command</strong> را با استفاده از کلاس <strong>CommandDispatcher</strong> مصرف می‌کند. <strong>Command-</strong>
<strong>Dispatcher</strong> از رابط <strong>MessageConsumer</strong> برای اشتراک در رویدادهای مشخص شده استفاده می‌کند. این <strong>dis-</strong>
   هر پیام <strong>command</strong> را به متد <strong>handler</strong> مناسب ارسال می‌کند. در اینجا مثالی وجود دارد:
  </p>
<pre>
   <code>
    CommandHandlers commandHandlers =CommandHandlersBuilder
    .fromChannel(commandChannel)
    .onMessage(DoSomethingCommand.class, (command) -
    &gt; { ... ; return withSuccess(); })
    .build();
   </code>
  </pre>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0132_original/original_page.png" alt="Original Page 132">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>استفاده از پیام‌رسانی ناهمگام برای بهبود در دسترس بودن</strong></h3>
<p>
<code>CommandDispatcher</code> (متمرکز کننده دستور) dispatcher = new <code>CommandDispatcher</code>("subscribeId",
        commandHandlers, messageConsumer, messageProducer);
    </p>
<p>
        در سراسر این کتاب، نمونه‌های کدی را خواهید دید که از این APIها (رابط‌های برنامه‌نویسی) برای ارسال و دریافت پیام‌ها استفاده می‌کنند.
    </p>
<p>
        همانطور که دیده‌اید، فریمورک <abbr title="چارچوب">Eventuate Tram</abbr>، پیام‌رسانی تراکنشی را برای برنامه‌های جاوا پیاده‌سازی می‌کند. این فریمورک یک API سطح پایین برای ارسال و دریافت پیام‌ها به صورت تراکنشی فراهم می‌کند. همچنین APIهای سطح بالاتری را برای انتشار و مصرف رویدادهای دامنه و برای ارسال و پردازش دستورات ارائه می‌دهد.
    </p>
<p>
        بیایید اکنون به یک رویکرد طراحی سرویس نگاهی بیندازیم که از پیام‌رسانی ناهمگام برای بهبود در دسترس بودن استفاده می‌کند.
    </p>
<h4><strong>3.4 استفاده از پیام‌رسانی ناهمگام برای بهبود در دسترس بودن</strong></h4>
<p>
        همانطور که دیده‌اید، انواع مختلفی از مکانیسم‌های <abbr title="ارتباط بین فرآیندی">IPC</abbr> (ارتباط بین فرآیندی) دارای ملاحظات متفاوتی هستند. یک نکته‌ی خاص این است که انتخاب شما از مکانیسم IPC چگونه بر در دسترس بودن تأثیر می‌گذارد. در این بخش، یاد خواهید گرفت که ارتباط همزمان با سرویس‌های دیگر به عنوان بخشی از رسیدگی به درخواست، در دسترس بودن برنامه را کاهش می‌دهد. در نتیجه، باید سرویس‌های خود را طوری طراحی کنید که در صورت امکان از پیام‌رسانی ناهمگام استفاده کنند.
    </p>
<p>
        بیایید ابتدا به مشکل ارتباط همزمان و چگونگی تأثیر آن بر در دسترس بودن نگاهی بیندازیم.
    </p>
<h5><strong>3.4.1 ارتباط همزمان در دسترس بودن را کاهش می‌دهد</strong></h5>
<p>
<abbr title="انتقال حالت بازنمودی">REST</abbr> (انتقال حالت بازنمودی) یک مکانیسم بسیار محبوب <abbr title="ارتباط بین فرآیندی">IPC</abbr> است. ممکن است وسوسه شوید که از آن برای ارتباط بین سرویس‌ها استفاده کنید. اما مشکل <abbr title="انتقال حالت بازنمودی">REST</abbr> این است که یک پروتکل همزمان است: یک کلاینت HTTP (مشتری) باید منتظر بماند تا سرویس، پاسخی را ارسال کند. هر زمان که سرویس‌ها با استفاده از یک پروتکل همزمان ارتباط برقرار می‌کنند، در دسترس بودن برنامه کاهش می‌یابد.
    </p>
<p>
        برای اینکه متوجه شوید چرا اینطور است، سناریوی نشان داده شده در شکل 3.15 را در نظر بگیرید. سرویس Order (سفارش) یک <abbr title="رابط برنامه‌نویسی نرم‌افزار">REST API</abbr> برای ایجاد یک Order (سفارش) دارد. این سرویس، Consumer Service (سرویس مصرف کننده) و Restaurant Service (سرویس رستوران) را برای اعتبارسنجی Order (سفارش) فراخوانی می‌کند. هر دوی این سرویس‌ها نیز <abbr title="رابط برنامه‌نویسی نرم‌افزار">REST APIs</abbr> دارند.
    </p>
<p>
        Client (مشتری)
        <br/>
        Order (سفارش) Service (سرویس)
        <br/>
        Consumer (مصرف کننده) Service (سرویس)
        <br/>
        Restaurant (رستوران) Service (سرویس)
        <br/>
        POST/orders
        <br/>
        GET/consumers/id
        <br/>
        GET/restaurant/id
        <br/>
        Figure 3.15
    </p>
<p>
        سرویس Order (سفارش) با استفاده از <abbr title="انتقال حالت بازنمودی">REST</abbr> سرویس‌های دیگر را فراخوانی می‌کند. این روش ساده است، اما نیازمند این است که همه سرویس‌ها به طور همزمان در دسترس باشند، که این امر در دسترس بودن <abbr title="رابط برنامه‌نویسی نرم‌افزار">API</abbr> را کاهش می‌دهد.
    </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0133_original/original_page.png" alt="Original Page 133">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>فصل 3</strong></h3>
<h4><strong>ارتباط بین فرآیندی در معماری <abbr title="ریز سرویس">microservice</abbr></strong></h4>
<p>
        ترتیب مراحل برای ایجاد یک سفارش به شرح زیر است:
    </p>
<ol>
<li>
            کلاینت یک درخواست HTTP POST /orders را به Order Service (سرویس سفارش) ارسال می‌کند.
        </li>
<li>
            Order Service (سرویس سفارش)، اطلاعات مصرف‌کننده را با ارسال یک درخواست HTTP GET /consumers/id به Consumer Service (سرویس مصرف‌کننده) بازیابی می‌کند.
        </li>
<li>
            Order Service (سرویس سفارش)، اطلاعات رستوران را با ارسال یک درخواست HTTP GET /restaurant/id به Restaurant Service (سرویس رستوران) بازیابی می‌کند.
        </li>
<li>
            Order Taking (دریافت سفارش) درخواست را با استفاده از اطلاعات مصرف‌کننده و رستوران اعتبارسنجی می‌کند.
        </li>
<li>
            Order Taking (دریافت سفارش) یک Order (سفارش) ایجاد می‌کند.
        </li>
<li>
            Order Taking (دریافت سفارش) یک پاسخ HTTP را به کلاینت ارسال می‌کند.
        </li>
</ol>
<p>
        از آنجا که این سرویس‌ها از HTTP استفاده می‌کنند، همه آنها باید به طور همزمان در دسترس باشند تا برنامه FTGO بتواند درخواست CreateOrder (ایجاد سفارش) را پردازش کند. برنامه FTGO نمی‌تواند سفارش‌ها را ایجاد کند اگر هر یک از این سه سرویس از کار افتاده باشد. از نظر ریاضی، در دسترس بودن یک عملیات سیستم، حاصل‌ضرب در دسترس بودن سرویس‌هایی است که توسط آن عملیات فراخوانی می‌شوند. اگر Order Service (سرویس سفارش) و دو سرویسی که فراخوانی می‌کند 99.5٪ در دسترس باشند، در دسترس بودن کلی 99.5٪<sup>3</sup> = 98.5٪ است که به طور قابل توجهی کمتر است. هر سرویس اضافی که در رسیدگی به یک درخواست شرکت می‌کند، در دسترس بودن را بیشتر کاهش می‌دهد.
    </p>
<p>
        این مشکل مختص ارتباط مبتنی بر <abbr title="انتقال حالت بازنمودی">REST</abbr> نیست. در دسترس بودن زمانی کاهش می‌یابد که یک سرویس فقط پس از دریافت پاسخ از سرویس دیگر بتواند به کلاینت خود پاسخ دهد. این مشکل حتی اگر سرویس‌ها با استفاده از تعامل سبک درخواست/پاسخ از طریق پیام‌رسانی ناهمگام ارتباط برقرار کنند، وجود دارد. به عنوان مثال، در دسترس بودن Order Service (سرویس سفارش) کاهش می‌یابد اگر یک پیام را به Consumer Service (سرویس مصرف‌کننده) از طریق یک message broker (کارگزار پیام) ارسال کند و سپس منتظر پاسخ بماند.
    </p>
<p>
        اگر می‌خواهید در دسترس بودن را به حداکثر برسانید، باید میزان ارتباط همزمان را به حداقل برسانید. بیایید نگاهی بیندازیم که چگونه این کار را انجام دهیم.
    </p>
<h5><strong>3.4.2 حذف تعامل همزمان</strong></h5>
<p>
        چند راه مختلف برای کاهش میزان ارتباط همزمان با سرویس‌های دیگر در هنگام رسیدگی به درخواست‌های همزمان وجود دارد. یک راه‌حل این است که با تعریف سرویس‌هایی که فقط <abbr title="رابط برنامه‌نویسی نرم‌افزار">APIs</abbr> ناهمگام دارند، از این مشکل به طور کامل اجتناب کنید. با این حال، این همیشه امکان‌پذیر نیست. به عنوان مثال، <abbr title="رابط برنامه‌نویسی نرم‌افزار">APIs</abbr> عمومی معمولاً <abbr title="انتقال حالت بازنمودی">RESTful</abbr> هستند. بنابراین، سرویس‌ها گاهی اوقات ملزم به داشتن <abbr title="رابط برنامه‌نویسی نرم‌افزار">APIs</abbr> همزمان هستند.
    </p>
<p>
        خوشبختانه، راه‌هایی برای رسیدگی به درخواست‌های همزمان بدون ایجاد درخواست‌های همزمان وجود دارد. بیایید در مورد گزینه‌ها صحبت کنیم.
    </p>
<p>
<strong>استفاده از سبک‌های تعامل ناهمگام</strong>
</p>
<p>
        در حالت ایده‌آل، تمام تعاملات باید با استفاده از سبک‌های تعامل ناهمگام که در اوایل این فصل توضیح داده شد، انجام شوند. به عنوان مثال، فرض کنید یک کلاینت برنامه FTGO از سبک تعامل درخواست/پاسخ ناهمگام برای ایجاد سفارش‌ها استفاده می‌کند. یک کلاینت با ارسال یک پیام درخواست به Order Service (سرویس سفارش)، یک سفارش ایجاد می‌کند.
    </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0134_original/original_page.png" alt="Original Page 134">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>استفاده از پیام‌رسانی asynchronous (ناهمزمان) برای بهبود دسترسی‌پذیری</strong></h3>
<p>این service سپس به صورت asynchronous، پیام‌ها را با سایر services تبادل می‌کند و در نهایت یک پیام reply (پاسخ) را به client (مشتری) ارسال می‌کند. Figure (شکل) 3.16 این طراحی را نشان می‌دهد.</p>
<p>Client و services به صورت asynchronous از طریق ارسال پیام‌ها از طریق کانال‌های messaging (پیام‌رسانی) ارتباط برقرار می‌کنند. هیچ شرکت‌کننده‌ای در این تعامل هرگز منتظر پاسخ blocked (مسدود) نمی‌شود.</p>
<p>چنین معماری بسیار انعطاف‌پذیر خواهد بود، زیرا message broker (واسطه پیام) پیام‌ها را بافر (ذخیره) می‌کند تا زمانی که بتوانند مصرف شوند. با این حال، مشکل این است که services (سرویس‌ها) اغلب دارای یک API (رابط برنامه‌نویسی) خارجی هستند که از یک protocol (پروتکل) synchronous (همزمان) مانند REST استفاده می‌کند، بنابراین باید فوراً به درخواست‌ها پاسخ دهند.</p>
<p>اگر یک service دارای یک API synchronous باشد، یک راه برای بهبود دسترسی‌پذیری، replicate (تکثیر) data (داده‌ها) است. بیایید ببینیم که چگونه کار می‌کند.</p>
<h4><strong>REPLICATE DATA (تکثیر داده‌ها)</strong></h4>
<p>یک راه برای به حداقل رساندن synchronous requests (درخواست‌های همزمان) در طول پردازش request (درخواست)، replicate data (تکثیر داده‌ها) است. یک service یک replica (نسخه تکراری) از داده‌هایی را که در هنگام پردازش requests به آن‌ها نیاز دارد، نگهداری می‌کند. این replica (نسخه تکراری) را با subscribing (اشتراک) به events (رویدادهایی) که توسط services (سرویس‌ها) که مالک data (داده‌ها) هستند، منتشر شده‌اند، به‌روز نگه می‌دارد. به عنوان مثال، Order Service (سرویس سفارش) می‌تواند یک replica (نسخه تکراری) از داده‌های متعلق به Consumer Service (سرویس مصرف‌کننده) و Restaurant Service (سرویس رستوران) را نگهداری کند. این امر Order Service را قادر می‌سازد تا یک request (درخواست) برای ایجاد یک order (سفارش) را بدون نیاز به تعامل با آن services (سرویس‌ها)، مدیریت کند.</p>
<p>Figure (شکل) 3.17 این طراحی را نشان می‌دهد.</p>
<p>Consumer Service و Restaurant Service هر زمان که data (داده‌های) آن‌ها تغییر کند، events (رویدادهایی) را منتشر می‌کنند. Order Service به آن events (رویدادها) subscribe (اشتراک) می‌کند و replica (نسخه تکراری) خود را به‌روزرسانی می‌کند.</p>
<p>در برخی از موقعیت‌ها، replicate (تکثیر) data (داده‌ها) یک رویکرد مفید است. به عنوان مثال، فصل 5 نحوه replicate (تکثیر) داده‌ها توسط Order Service از Restaurant Service را شرح می‌دهد تا بتواند آیتم‌های منو را validate (اعتبارسنجی) و قیمت‌گذاری کند. یکی از معایب replication (تکثیر)، این است که گاهی اوقات می‌تواند نیاز به replication (تکثیر) مقدار زیادی data (داده‌ها) داشته باشد، که ناکارآمد است. به عنوان مثال، ممکن است برای Order Service عملی نباشد که یک replica (نسخه تکراری) از data (داده‌ها) متعلق به Consumer Service را، به دلیل تعداد زیاد consumers (مصرف‌کنندگان)، نگهداری کند. یکی دیگر از معایب replication (تکثیر)...</p>
<br/>
<img alt="Figure 3.16" src="figure_3_16.png"/>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0135_original/original_page.png" alt="Original Page 135">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3 (فصل 3)</strong></h3>
<h4><strong>Interprocess communication (ارتباط بین فرآیندی) در یک microservice (ریز سرویس) architecture (معماری)</strong></h4>
<p>یکی از مشکلات replication (تکثیر) این است که مشکل نحوه به‌روزرسانی داده‌ها توسط یک service (سرویس) که متعلق به سایر services (سرویس‌ها) است را حل نمی‌کند.</p>
<p>یک راه برای حل این مشکل این است که یک service، تعامل با سایر services (سرویس‌ها) را تا بعد از پاسخ به client (مشتری) خود به تاخیر بیندازد. در ادامه، به چگونگی عملکرد آن نگاهی خواهیم انداخت.</p>
<h4><strong>FINISH PROCESSING AFTER RETURNING A RESPONSE (اتمام پردازش پس از بازگشت پاسخ)</strong></h4>
<p>یک راه دیگر برای حذف ارتباط synchronous (همزمان) در طول پردازش request (درخواست) این است که یک service درخواست را به صورت زیر مدیریت کند:</p>
<ol>
<li>Validate (اعتبارسنجی) request (درخواست) با استفاده از داده‌های موجود محلی.</li>
<li>دیتابیس (پایگاه داده) خود را به‌روزرسانی کنید، از جمله درج messages (پیام‌ها) در جدول OUTBOX.</li>
<li>یک response (پاسخ) را به client (مشتری) خود بازگردانید.</li>
</ol>
<p>در حین handling (مدیریت) یک request (درخواست)، service به طور synchronous (همزمان) با هیچ service (سرویس) دیگری تعامل ندارد. در عوض، آن به صورت asynchronous (ناهمزمان) messages (پیام‌ها) را به سایر services (سرویس‌ها) ارسال می‌کند. این رویکرد تضمین می‌کند که services (سرویس‌ها) به طور loosely coupled (شل و غیر متصل) هستند. همانطور که در فصل بعد خواهید آموخت، این اغلب با استفاده از یک saga (حماسه) پیاده‌سازی می‌شود.</p>
<p>به عنوان مثال، اگر Order Service (سرویس سفارش) از این رویکرد استفاده کند، یک order (سفارش) را در یک حالت PENDING (در انتظار) ایجاد می‌کند و سپس order (سفارش) را به صورت asynchronous (ناهمزمان) با تبادل messages (پیام‌ها) با سایر services (سرویس‌ها) validate (اعتبارسنجی) می‌کند. Figure (شکل) 3.18 آنچه را که هنگام فراخوانی operation (عملیات) createOrder() اتفاق می‌افتد، نشان می‌دهد. توالی events (رویدادها) به شرح زیر است:</p>
<ol>
<li>Order Service یک Order را در حالت PENDING (در انتظار) ایجاد می‌کند.</li>
<li>Order Service یک response (پاسخ) را به client (مشتری) خود بازمی‌گرداند که شامل order ID (شناسه سفارش) است.</li>
<li>Order Service یک پیام ValidateConsumerInfo را به Consumer Service (سرویس مصرف‌کننده) ارسال می‌کند.</li>
</ol>
<p>Services (سرویس‌ها) events (رویدادها) را publish (منتشر) می‌کنند</p>
<p>when (هنگامی) که data (داده‌های) آنها تغییر می‌کند.</p>
<p>Replicated data (داده‌های تکثیر شده) Order Service (سرویس سفارش) را قادر می‌سازد تا</p>
<p>request (درخواست) createOrder() را بدون</p>
<p>synchronously (همزمان) فراخوانی services (سرویس‌ها) انجام دهد.</p>
<br/>
<img alt="Figure 3.17" src="figure_3_17.png"/>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0136_original/original_page.png" alt="Original Page 136">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Using asynchronous messaging (پیام‌رسانی ناهمزمان) to improve availability (بهبود دسترسی‌پذیری)</strong></h3>
<ol>
<li>Order Service (سرویس سفارش) یک پیام ValidateOrderDetails را به Restaurant Service (سرویس رستوران) ارسال می‌کند.</li>
<li>Consumer Service (سرویس مصرف‌کننده) یک پیام ValidateConsumerInfo دریافت می‌کند، بررسی می‌کند که آیا consumer (مصرف‌کننده) می‌تواند یک order (سفارش) ثبت کند، و یک پیام ConsumerValidated را به Order Service (سرویس سفارش) ارسال می‌کند.</li>
<li>Restaurant Service (سرویس رستوران) یک پیام ValidateOrderDetails دریافت می‌کند، بررسی می‌کند که آیا item (آیتم) منو valid (معتبر) است و رستوران می‌تواند به آدرس تحویل order (سفارش) تحویل دهد، و یک پیام OrderDetailsValidated را به Order Service (سرویس سفارش) ارسال می‌کند.</li>
<li>Order Service (سرویس سفارش) ConsumerValidated و OrderDetailsValidated را دریافت می‌کند و state (وضعیت) order (سفارش) را به VALIDATED (تایید شده) تغییر می‌دهد.</li>
<li>…</li>
</ol>
<p>Order Service (سرویس سفارش) می‌تواند messages (پیام‌های) ConsumerValidated و OrderDetailsValidated را به هر ترتیبی دریافت کند. این سرویس با تغییر state (وضعیت) order (سفارش)، پیگیری می‌کند که کدام message (پیام) را ابتدا دریافت کرده است. اگر ابتدا ConsumerValidated را دریافت کند، state (وضعیت) order (سفارش) را به CONSUMER_VALIDATED تغییر می‌دهد، در حالی که اگر ابتدا پیام OrderDetailsValidated را دریافت کند، state (وضعیت) آن را به ORDER_DETAILS_VALIDATED تغییر می‌دهد. Order Service (سرویس سفارش) state (وضعیت) Order را به VALIDATED (تایید شده) تغییر می‌دهد هنگامی که پیام دیگر را دریافت می‌کند.</p>
<p>Synchronous (همزمان)</p>
<p>Key (کلید)</p>
<p>Asynchronous (ناهمزمان)</p>
<br/>
<p>Order Service (سرویس سفارش)</p>
<p>Client (مشتری)</p>
<p>Consumer Service (سرویس مصرف‌کننده)</p>
<p>Restaurant Service (سرویس رستوران)</p>
<br/>
<p>... (و...)</p>
<p>createOrder (ایجاد سفارش)</p>
<p>Asynchronous (ناهمزمان)</p>
<p>Synchronous (همزمان)</p>
<p>create order (ایجاد سفارش)</p>
<p>update order (به روز رسانی سفارش)</p>
<p>update order (به روز رسانی سفارش)</p>
<p>createOrder (ایجاد سفارش)</p>
<p>ValidateConsumerInfo (اعتبارسنجی اطلاعات مصرف کننده)</p>
<p>ValidateOrderDetails (اعتبارسنجی جزئیات سفارش)</p>
<p>ConsumerValidated (مصرف کننده تایید شد)</p>
<p>OrderDetailsValidated (جزئیات سفارش تایید شد)</p>
<br/>
<p>... (و...)</p>
<br/>
<img alt="Figure 3.18" src="figure_3_18.png"/>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0137_original/original_page.png" alt="Original Page 137">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 3 (فصل 3)</strong></h3>
<h4><strong>Interprocess communication (ارتباط بین فرآیندی) در یک microservice (ریز سرویس) architecture (معماری)</strong></h4>
<p>پس از اینکه Order (سفارش) validate (اعتبارسنجی) شد، Order Service (سرویس سفارش) بقیه process (فرآیند) order-creation (ایجاد سفارش) را تکمیل می‌کند، که در فصل بعد مورد بحث قرار می‌گیرد. نکته خوب در مورد این رویکرد این است که حتی اگر Consumer Service (سرویس مصرف‌کننده) down (از کار افتاده) باشد، به عنوان مثال، Order Service (سرویس سفارش) همچنان orders (سفارش‌ها) را ایجاد می‌کند و به clients (مشتریان) خود پاسخ می‌دهد. در نهایت، Consumer Service (سرویس مصرف‌کننده) دوباره بالا می‌آید و هر پیام queued (صف) شده را پردازش می‌کند و orders (سفارش‌ها) validate (اعتبارسنجی) می‌شوند.</p>
<p>یک drawback (نقص) از یک service (سرویس) که قبل از پردازش کامل یک request (درخواست) پاسخ می‌دهد این است که client (مشتری) را پیچیده‌تر می‌کند. به عنوان مثال، Order Service (سرویس سفارش) حداقل guarantees (تضمین‌هایی) را در مورد state (وضعیت) یک order (سفارش) newly created (تازه ایجاد شده) هنگامی که یک response (پاسخ) را بازمی‌گرداند، ارائه می‌دهد. این order (سفارش) را ایجاد می‌کند و بلافاصله قبل از validating (اعتبارسنجی) order (سفارش) و authorizing (مجوز دادن) credit card (کارت اعتباری) مصرف‌کننده، بازمی‌گردد. در نتیجه، برای اینکه client (مشتری) بداند آیا order (سفارش) با موفقیت ایجاد شده است، باید به صورت دوره‌ای poll (نظرسنجی) کند یا Order Service (سرویس سفارش) باید یک notification message (پیام اطلاع‌رسانی) برای آن ارسال کند. به اندازه پیچیدگی که به نظر می‌رسد، در بسیاری از موقعیت‌ها این رویکرد ترجیح داده می‌شود - به ویژه به این دلیل که به مسائل مدیریت transaction (تراکنش) توزیع شده‌ای که در فصل بعد مورد بحث قرار می‌دهم، نیز می‌پردازد. به عنوان مثال، در فصل‌های 4 و 5، من توضیح می‌دهم که چگونه Order Service (سرویس سفارش) از این رویکرد استفاده می‌کند.</p>
<p><strong>Summary (خلاصه)</strong></p>
<ul>
<li>microservice (ریز سرویس) architecture (معماری) یک architecture (معماری) توزیع شده است، بنابراین interprocess communication (ارتباط بین فرآیندی) نقش کلیدی دارد.</li>
<li>مدیریت دقیق evolution (تکامل) API (رابط برنامه‌نویسی) یک service (سرویس) ضروری است. تغییرات backward-compatible (سازگار با گذشته) ساده‌ترین هستند، زیرا بر clients (مشتریان) تأثیری ندارند. اگر تغییری breaking (شکستن) در API (رابط برنامه‌نویسی) یک service (سرویس) ایجاد کنید، معمولاً باید از هر دو version (نسخه) قدیمی و جدید پشتیبانی کنید تا زمانی که clients (مشتریان) آن ارتقا یافته باشند.</li>
<li>فناوری‌های IPC (ارتباط بین فرآیندی) متعددی وجود دارد که هر کدام trade-offs (موازنه) متفاوتی دارند. یکی از تصمیمات طراحی کلیدی این است که الگوهای synchronous (همزمان) remote procedure invocation (فراخوانی رویه‌ای از راه دور) یا الگوی asynchronous (ناهمزمان) Messaging (پیام‌رسانی) را انتخاب کنید. پروتکل‌های مبتنی بر synchronous (همزمان) remote procedure invocation (فراخوانی رویه‌ای از راه دور)، مانند REST، ساده‌ترین استفاده هستند. اما services (سرویس‌ها) در حالت ایده‌آل باید با استفاده از asynchronous messaging (پیام‌رسانی ناهمزمان) ارتباط برقرار کنند تا availability (دسترسی‌پذیری) را افزایش دهند.</li>
<li>به منظور جلوگیری از cascade (آبشاری) failures (شکست‌ها) از طریق یک system (سیستم)، یک service client (مشتری سرویس) که از یک protocol (پروتکل) synchronous (همزمان) استفاده می‌کند، باید برای handling (مدیریت) partial failures (شکست‌های جزئی)، که زمانی است که service (سرویس) فراخوانی شده یا down (از کار افتاده) است یا latency (تاخیر) بالایی را نشان می‌دهد، طراحی شود. به طور خاص، باید از timeouts (زمان‌بندی) هنگام making requests (درخواست‌ها)، محدود کردن تعداد outstanding requests (درخواست‌های معلق)، و استفاده از الگوی Circuit breaker (شکننده مدار) برای جلوگیری از برقراری تماس با یک failing service (سرویس در حال شکست) استفاده کند.</li>
<li>یک architecture (معماری) که از پروتکل‌های synchronous (همزمان) استفاده می‌کند، باید شامل یک مکانیزم service discovery (کشف سرویس) باشد تا clients (مشتریان) بتوانند location (موقعیت) network (شبکه) یک instance (نمونه) service (سرویس) را تعیین کنند. ساده‌ترین رویکرد استفاده از مکانیزم service discovery (کشف سرویس) است که توسط platform (پلتفرم) استقرار پیاده‌سازی شده است: الگوهای Server-side discovery (کشف سمت سرور) و 3rd party registration (ثبت شخص ثالث). اما یک رویکرد جایگزین، پیاده‌سازی service discovery (کشف سرویس) در سطح application (برنامه) است: Client-side discovery (کشف سمت مشتری) و Self registration (ثبت نام خودکار)</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0138_original/original_page.png" alt="Original Page 138">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Summary (خلاصه)</strong></h3>
<p>patterns (الگوها). این کار بیشتر است، اما سناریویی را مدیریت می‌کند که services (سرویس‌ها) روی چندین platform (پلتفرم) استقرار اجرا می‌شوند.</p>
<p>یک راه خوب برای طراحی یک architecture (معماری) مبتنی بر messaging (پیام‌رسانی) استفاده از model (مدل) messages (پیام‌ها) و channels (کانال‌ها) است، که جزئیات system (سیستم) messaging (پیام‌رسانی) زیربنایی را انتزاع می‌کند. سپس می‌توانید آن طراحی را به یک زیرساخت messaging (پیام‌رسانی) خاص، که معمولاً مبتنی بر message broker (واسطه پیام) است، نگاشت کنید.</p>
<p>یکی از چالش‌های کلیدی هنگام استفاده از messaging (پیام‌رسانی)، به‌روزرسانی اتمی database (پایگاه داده) و publish (انتشار) یک message (پیام) است. یک راه‌حل خوب، استفاده از الگوی Transactional outbox (صندوق پستی تراکنشی) است و ابتدا message (پیام) را به عنوان بخشی از transaction (تراکنش) database (پایگاه داده) در database (پایگاه داده) بنویسید. سپس یک process (فرآیند) جداگانه، message (پیام) را از database (پایگاه داده) با استفاده از الگوی Polling publisher (ناشر نظرسنجی) یا الگوی Transaction log tailing (دنباله‌روی log تراکنش) بازیابی می‌کند و آن را به message broker (واسطه پیام) منتشر می‌کند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0139_original/original_page.png" alt="Original Page 139">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Managing transactions (مدیریت تراکنش‌ها) با sagas (حماسه‌ها)</strong></h3>
<p>وقتی Mary (مری) شروع به تحقیق در مورد microservice (ریز سرویس) architecture (معماری) کرد، یکی از بزرگ‌ترین نگرانی‌هایش این بود که چگونه transactions (تراکنش‌هایی) را پیاده‌سازی کند که چندین service (سرویس) را شامل شوند. Transactions (تراکنش‌ها) یک عنصر اساسی از هر application (برنامه) سازمانی هستند. بدون transactions (تراکنش‌ها)، حفظ consistency (سازگاری) داده‌ها غیرممکن خواهد بود.</p>
<p>ACID (Atomicity (اتمی)، Consistency (سازگاری)، Isolation (انزوا)، Durability (پایداری)) transactions (تراکنش‌ها) کار developer (توسعه‌دهنده) را با ارائه این تصور که هر transaction (تراکنش) دسترسی انحصاری به data (داده‌ها) دارد، بسیار ساده می‌کنند. در یک microservice (ریز سرویس) architecture (معماری)، transactions (تراکنش‌هایی) که در یک service (سرویس) واحد قرار دارند، همچنان می‌توانند از ACID transactions (تراکنش‌های اتمی) استفاده کنند. با این حال، چالش در پیاده‌سازی transactions (تراکنش‌ها) برای operations (عملیاتی) است که data (داده‌های) متعلق به چندین service (سرویس) را به‌روزرسانی می‌کنند.</p>
<p>این فصل شامل موارد زیر است:</p>
<ul>
<li>چرا distributed transactions (تراکنش‌های توزیع شده) برای applications (برنامه‌های) مدرن مناسب نیستند</li>
<li>استفاده از الگوی Saga (حماسه) برای حفظ data consistency (سازگاری داده‌ها) در یک microservice (ریز سرویس) architecture (معماری)</li>
<li>هماهنگ‌سازی sagas (حماسه‌ها) با استفاده از choreography (طراحی رقص) و orchestration (ارکستراسیون)</li>
<li>استفاده از countermeasures (اقدامات متقابل) برای مقابله با کمبود isolation (انزوا)</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0140_original/original_page.png" alt="Original Page 140">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Transaction management (مدیریت تراکنش) در یک microservice (ریز سرویس) architecture (معماری)</strong></h3>
<p>به عنوان مثال، همانطور که در فصل 2 توضیح داده شد، operation (عملیات) createOrder() (ایجاد سفارش) چندین service (سرویس)، از جمله Order Service (سرویس سفارش)، Kitchen Service (سرویس آشپزخانه) و Accounting Service (سرویس حسابداری) را در بر می‌گیرد. عملیاتی مانند اینها به یک مکانیزم transaction management (مدیریت تراکنش) نیاز دارند که در سراسر services (سرویس‌ها) کار کند.</p>
<p>Mary (مری) متوجه شد که، همانطور که در فصل 2 ذکر شد، رویکرد سنتی برای distributed transaction management (مدیریت تراکنش توزیع شده) انتخاب خوبی برای applications (برنامه‌های) مدرن نیست.</p>
<p>به جای یک ACID transaction (تراکنش اتمی)، یک operation (عملیات) که services (سرویس‌ها) را در بر می‌گیرد، باید از چیزی که به عنوان saga (حماسه) شناخته می‌شود، یک sequence (توالی) message-driven (مبتنی بر پیام) از local transactions (تراکنش‌های محلی)، برای حفظ data consistency (سازگاری داده‌ها) استفاده کند. یکی از چالش‌ها با sagas (حماسه‌ها) این است که آنها ACD (Atomicity (اتمی)، Consistency (سازگاری)، Durability (پایداری)) هستند. آنها فاقد ویژگی isolation (انزوا) transactions (تراکنش‌های) ACID سنتی هستند. در نتیجه، یک application (برنامه) باید از چیزی که به عنوان countermeasures (اقدامات متقابل) شناخته می‌شود، techniques (تکنیک‌های) طراحی که از impact (تاثیر) anomalies (ناهنجاری‌ها) concurrency (همزمانی) ناشی از فقدان isolation (انزوا) جلوگیری یا کاهش می‌دهد، استفاده کند.</p>
<p>از بسیاری جهات، بزرگترین مانعی که Mary (مری) و توسعه‌دهندگان FTGO هنگام اتخاذ microservices (ریز سرویس‌ها) با آن مواجه خواهند شد، حرکت از یک database (پایگاه داده) واحد با ACID transactions (تراکنش‌های اتمی) به یک architecture (معماری) multi-database (چند پایگاه داده) با ACD sagas (حماسه‌ها) است. آنها به سادگی model (مدل) ACID transaction (تراکنش اتمی) عادت کرده‌اند. اما در واقعیت، حتی monolithic applications (برنامه‌های یکپارچه) مانند FTGO application (برنامه FTGO) معمولاً از ACID transactions (تراکنش‌های اتمی) کتاب درسی استفاده نمی‌کنند. به عنوان مثال، بسیاری از applications (برنامه‌ها) از یک سطح isolation (انزوا) transaction (تراکنش) پایین‌تر برای بهبود performance (عملکرد) استفاده می‌کنند. همچنین، بسیاری از processes (فرآیندهای) business (تجاری) مهم، مانند انتقال پول بین حساب‌ها در بانک‌های مختلف، در نهایت consistent (سازگار) هستند. حتی Starbucks (استارباکس) از two-phase commit (تعهد دو مرحله‌ای) استفاده نمی‌کند (www.enterpriseintegrationpatterns.com/ramblings/18_starbucks.html).</p>
<p>من این فصل را با نگاهی به چالش‌های transaction management (مدیریت تراکنش) در microservice (ریز سرویس) architecture (معماری) شروع می‌کنم و توضیح می‌دهم که چرا رویکرد سنتی برای distributed transaction management (مدیریت تراکنش توزیع شده) یک option (گزینه) نیست. در ادامه، توضیح می‌دهم که چگونه data consistency (سازگاری داده‌ها) را با استفاده از sagas (حماسه‌ها) حفظ کنیم. پس از آن، به دو روش مختلف هماهنگ‌سازی sagas (حماسه‌ها) نگاه می‌کنم: choreography (طراحی رقص)، جایی که participants (شرکت‌کنندگان) events (رویدادها) را بدون یک point (نقطه) متمرکز control (کنترل) تبادل می‌کنند، و orchestration (ارکستراسیون)، جایی که یک controller (کنترلر) متمرکز به participants (شرکت‌کنندگان) saga (حماسه) می‌گوید چه operation (عملیاتی) را انجام دهند. من در مورد چگونگی استفاده از countermeasures (اقدامات متقابل) برای جلوگیری یا کاهش impact (تاثیر) anomalies (ناهنجاری‌ها) concurrency (همزمانی) ناشی از کمبود isolation (انزوا) بین sagas (حماسه‌ها) بحث می‌کنم. در نهایت، من پیاده‌سازی یک example saga (حماسه مثال) را شرح می‌دهم.</p>
<p>بیایید با نگاهی به چالش مدیریت transactions (تراکنش‌ها) در یک microservice (ریز سرویس) architecture (معماری) شروع کنیم.</p>
<h4><strong>4.1 Transaction management (مدیریت تراکنش) در یک microservice (ریز سرویس) architecture (معماری)</strong></h4>
<p>تقریباً هر request (درخواستی) که توسط یک enterprise application (برنامه سازمانی) مدیریت می‌شود، در یک transaction (تراکنش) database (پایگاه داده) اجرا می‌شود. توسعه‌دهندگان enterprise application (برنامه سازمانی) از frameworks (چارچوب‌ها) و libraries (کتابخانه‌ها) استفاده می‌کنند که transaction management (مدیریت تراکنش) را ساده می‌کند. برخی از frameworks (چارچوب‌ها) و libraries (کتابخانه‌ها) یک programmatic API (رابط برنامه‌نویسی) برای شروع، commit (تعهد) و rollback (بازگشت) transactions (تراکنش‌ها) به صراحت ارائه می‌دهند. سایر frameworks (چارچوب‌ها)، مانند Spring framework (فریم‌ورک Spring)، یک مکانیزم declarative (اعلامی) ارائه می‌دهند. Spring (Spring) یک annotation (حاشیه‌نویسی) @Transactional ارائه می‌دهد که برای فراخوانی method (متد) ترتیب می‌دهد تا ...</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0141_original/original_page.png" alt="Original Page 141">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<p>به طور خودکار در یک transaction (تراکنش) اجرا می‌شوند. در نتیجه، نوشتن business logic (منطق تجاری) تراکنشی ساده است.</p>
<p>یا، به طور دقیق‌تر، transaction management (مدیریت تراکنش) در یک monolithic application (برنامه یکپارچه) که به یک database (پایگاه داده) واحد دسترسی دارد، ساده است. transaction management (مدیریت تراکنش) در یک monolithic application (برنامه یکپارچه) پیچیده که از چندین database (پایگاه داده) و message broker (واسطه پیام) استفاده می‌کند، چالش برانگیزتر است. و در یک microservice (ریز سرویس) architecture (معماری)، transactions (تراکنش‌ها) چندین service (سرویس) را در بر می‌گیرند که هر کدام database (پایگاه داده) خود را دارند. در این شرایط، application (برنامه) باید از یک مکانیزم دقیق‌تر برای مدیریت transactions (تراکنش‌ها) استفاده کند. همانطور که خواهید آموخت، رویکرد سنتی استفاده از distributed transactions (تراکنش‌های توزیع شده) یک option (گزینه) مناسب برای applications (برنامه‌های) مدرن نیست. در عوض، یک application (برنامه) مبتنی بر microservices (ریز سرویس‌ها) باید از sagas (حماسه‌ها) استفاده کند.</p>
<p>قبل از اینکه sagas (حماسه‌ها) را توضیح دهم، ابتدا به این موضوع می‌پردازیم که چرا transaction management (مدیریت تراکنش) در یک microservice (ریز سرویس) architecture (معماری) چالش برانگیز است.</p>
<h4><strong>4.1.1 The need for distributed transactions (نیاز به تراکنش‌های توزیع شده) در یک microservice (ریز سرویس) architecture (معماری)</strong></h4>
<p>تصور کنید که شما developer (توسعه‌دهنده) FTGO هستید که مسئول پیاده‌سازی operation (عملیات) createOrder() (ایجاد سفارش) هستید. همانطور که در فصل 2 توضیح داده شد، این operation (عملیات) باید تأیید کند که consumer (مصرف‌کننده) می‌تواند یک order (سفارش) ثبت کند، جزئیات order (سفارش) را تأیید کند، credit card (کارت اعتباری) مصرف‌کننده را authorize (مجوز) کند و یک Order (سفارش) را در database (پایگاه داده) ایجاد کند. پیاده‌سازی این operation (عملیات) در monolithic FTGO application (برنامه یکپارچه FTGO) نسبتاً ساده است. تمام data (داده‌های) مورد نیاز برای validate (اعتبارسنجی) order (سفارش) به راحتی در دسترس است. علاوه بر این، شما می‌توانید از یک ACID transaction (تراکنش اتمی) برای اطمینان از data consistency (سازگاری داده‌ها) استفاده کنید. ممکن است از annotation (حاشیه‌نویسی) Spring's @Transactional روی method (متد) service (سرویس) createOrder() استفاده کنید.</p>
<p>در مقابل، پیاده‌سازی همان operation (عملیات) در یک microservice (ریز سرویس) architecture (معماری) بسیار پیچیده‌تر است. همانطور که شکل 4.1 نشان می‌دهد، data (داده‌های) مورد نیاز در چندین service (سرویس) پراکنده شده است. operation (عملیات) createOrder() (ایجاد سفارش) به data (داده‌ها) در numerous services (سرویس‌های متعدد) دسترسی دارد. این data (داده‌ها) را از Consumer Service (سرویس مصرف‌کننده) می‌خواند و data (داده‌ها) را در Order Service (سرویس سفارش)، Kitchen Service (سرویس آشپزخانه) و Accounting Service (سرویس حسابداری) به‌روزرسانی می‌کند.</p>
<p>از آنجایی که هر service (سرویس) database (پایگاه داده) خود را دارد، شما باید از یک مکانیزم برای حفظ data consistency (سازگاری داده‌ها) در سراسر این databases (پایگاه‌های داده) استفاده کنید.</p>
<h4><strong>4.1.2 The trouble with distributed transactions (مشکل با تراکنش‌های توزیع شده)</strong></h4>
<p>رویکرد سنتی برای حفظ data consistency (سازگاری داده‌ها) در سراسر چندین service (سرویس)، databases (پایگاه‌های داده) یا message brokers (واسطه‌های پیام) استفاده از distributed transactions (تراکنش‌های توزیع شده) است. استاندارد de facto (عملی) برای distributed transaction management (مدیریت تراکنش توزیع شده) مدل X/Open Distributed Transaction Processing (DTP) (پردازش تراکنش توزیع شده) (X/Open XA – به https://en.wikipedia.org/wiki/X/Open_XA مراجعه کنید) است. XA از two-phase commit (2PC) (تعهد دو مرحله‌ای) استفاده می‌کند تا اطمینان حاصل شود که همه participants (شرکت‌کنندگان) در یک transaction (تراکنش) commit (تعهد) یا rollback (بازگشت) می‌کنند. یک stack (پشته) فناوری منطبق با XA شامل databases (پایگاه‌های داده) و message brokers (واسطه‌های پیام) منطبق با XA، database drivers (درایورهای پایگاه داده) و messaging APIs (رابط‌های برنامه‌نویسی پیام‌رسانی) و یک مکانیزم interprocess communication (ارتباط بین فرآیندی) است که XA global transaction ID (شناسه تراکنش سراسری XA) را منتشر می‌کند. اکثر SQL databases (پایگاه‌های داده SQL) با XA سازگار هستند، همانطور که برخی از message brokers (واسطه‌های پیام) نیز هستند. به عنوان مثال، applications (برنامه‌های) Java EE می‌توانند از JTA برای انجام distributed transactions (تراکنش‌های توزیع شده) استفاده کنند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0142_original/original_page.png" alt="Original Page 142">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Transaction management (مدیریت تراکنش) در یک microservice (ریز سرویس) architecture (معماری)</strong></h3>
<p>به اندازه سادگی که به نظر می‌رسد، مشکلات متعددی با distributed transactions (تراکنش‌های توزیع شده) وجود دارد. یک مشکل این است که بسیاری از technologies (فناوری‌های) مدرن، از جمله NoSQL databases (پایگاه‌های داده NoSQL) مانند MongoDB و Cassandra، از آنها پشتیبانی نمی‌کنند. همچنین، distributed transactions (تراکنش‌های توزیع شده) توسط message brokers (واسطه‌های پیام) مدرن مانند RabbitMQ و Apache Kafka پشتیبانی نمی‌شوند.</p>
<p>در نتیجه، اگر اصرار دارید که از distributed transactions (تراکنش‌های توزیع شده) استفاده کنید، نمی‌توانید از بسیاری از technologies (فناوری‌های) مدرن استفاده کنید.</p>
<p>مشکل دیگر با distributed transactions (تراکنش‌های توزیع شده) این است که آنها نوعی synchronous (همزمان) IPC (ارتباط بین فرآیندی) هستند که availability (دسترسی‌پذیری) را کاهش می‌دهد. برای اینکه یک distributed transaction (تراکنش توزیع شده) commit (تعهد) شود، همه services (سرویس‌های) شرکت‌کننده باید available (در دسترس) باشند. همانطور که در فصل 3 توضیح داده شد، availability (دسترسی‌پذیری) حاصل ضرب availability (دسترسی‌پذیری) تمام participants (شرکت‌کنندگان) در transaction (تراکنش) است. اگر یک distributed transaction (تراکنش توزیع شده) شامل دو service (سرویس) باشد که 99.5% available (در دسترس) هستند، در این صورت availability (دسترسی‌پذیری) کلی 99% است که به طور قابل توجهی کمتر است. هر service (سرویس) اضافی که در یک distributed transaction (تراکنش توزیع شده) دخیل باشد، availability (دسترسی‌پذیری) را بیشتر کاهش می‌دهد. حتی theorem (قضیه) CAP (ارائه شده توسط اریک بروئر) وجود دارد، که بیان می‌کند یک system (سیستم) می‌تواند تنها دو مورد از سه ویژگی زیر را داشته باشد:</p>
<br/>
<p>Account (حساب)</p>
<p>Ticket (بلیط)</p>
<p>Consumer (مصرف‌کننده)</p>
<p>Data consistency (سازگاری داده‌ها) مورد نیاز است</p>
<p>Writes (نوشتن)</p>
<p>Writes (نوشتن)</p>
<p>createOrder() (ایجاد سفارش)</p>
<p>Reads (خواندن)</p>
<p>Accounting Service (سرویس حسابداری)</p>
<p>Kitchen Service (سرویس آشپزخانه)</p>
<p>Order (سفارش)</p>
<p>Order Service (سرویس سفارش)</p>
<p>Consumer Service (سرویس مصرف‌کننده)</p>
<p>The createOrder() (عملیات ایجاد سفارش) از</p>
<p>Consumer Service (سرویس مصرف‌کننده) می‌خواند و داده‌ها را</p>
<p>در Order Service (سرویس سفارش)، Kitchen Service (سرویس آشپزخانه)،</p>
<p>و Accounting Service (سرویس حسابداری) به‌روزرسانی می‌کند.</p>
<p>Order (سفارش)</p>
<p>controller (کنترل‌کننده)</p>
<br/>
<img alt="Figure 4.1" src="figure_4_1.png"/>
<p>The createOrder() (عملیات ایجاد سفارش) داده‌ها را در چندین service (سرویس) به‌روزرسانی می‌کند. این باید از یک</p>
<p>مکانیزم برای حفظ data consistency (سازگاری داده‌ها) در سراسر آن services (سرویس‌ها) استفاده کند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0143_original/original_page.png" alt="Original Page 143">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<p>consistency (سازگاری)، availability (دسترسی‌پذیری) و partition tolerance (تحمل تقسیم) (https://en.wikipedia.org/wiki/CAP _theorem). امروزه، معماران ترجیح می‌دهند سیستمی داشته باشند که available (در دسترس) باشد تا سیستمی که consistent (سازگار) است.</p>
<p>در ظاهر، distributed transactions (تراکنش‌های توزیع شده) جذاب هستند. از دیدگاه developer (توسعه‌دهنده)، آنها همان model (مدل) برنامه‌نویسی را به عنوان local transactions (تراکنش‌های محلی) دارند. اما به دلیل مشکلاتی که تاکنون ذکر شد، distributed transactions (تراکنش‌های توزیع شده) یک technology (فناوری) مناسب برای applications (برنامه‌های) مدرن نیستند. فصل 3 نحوه ارسال messages (پیام‌ها) را به عنوان بخشی از یک transaction (تراکنش) database (پایگاه داده) بدون استفاده از distributed transactions (تراکنش‌های توزیع شده) شرح داد. برای حل مشکل پیچیده‌تر حفظ data consistency (سازگاری داده‌ها) در یک microservice (ریز سرویس) architecture (معماری)، یک application (برنامه) باید از یک مکانیزم متفاوت استفاده کند که بر اساس مفهوم services (سرویس‌های) loosely coupled (شل و غیر متصل) و asynchronous (ناهمزمان) ساخته شده است. اینجاست که sagas (حماسه‌ها) وارد می‌شوند.</p>
<h4><strong>4.1.3 Using the Saga pattern (استفاده از الگوی Saga) برای حفظ data consistency (سازگاری داده‌ها)</strong></h4>
<p>Sagas (حماسه‌ها) مکانیزم‌هایی برای حفظ data consistency (سازگاری داده‌ها) در یک microservice (ریز سرویس) architecture (معماری) بدون نیاز به استفاده از distributed transactions (تراکنش‌های توزیع شده) هستند. شما یک saga (حماسه) را برای هر system command (دستور سیستم) که نیاز به به‌روزرسانی data (داده‌ها) در چندین service (سرویس) دارد، تعریف می‌کنید. یک saga (حماسه) یک sequence (توالی) از local transactions (تراکنش‌های محلی) است. هر local transaction (تراکنش محلی) data (داده‌ها) را در یک service (سرویس) واحد با استفاده از frameworks (چارچوب‌ها) و libraries (کتابخانه‌های) ACID transaction (تراکنش اتمی) آشنا که قبلاً ذکر شد، به‌روزرسانی می‌کند.</p>
<p>operation (عملیات) system (سیستم) گام اول saga (حماسه) را آغاز می‌کند. تکمیل یک local transaction (تراکنش محلی) باعث اجرای local transaction (تراکنش محلی) بعدی می‌شود. بعداً، در بخش 4.2، خواهید دید که چگونه هماهنگی مراحل با استفاده از asynchronous messaging (پیام‌رسانی ناهمزمان) پیاده‌سازی می‌شود. یک مزیت مهم asynchronous messaging (پیام‌رسانی ناهمزمان) این است که تضمین می‌کند که تمام مراحل یک saga (حماسه) اجرا می‌شوند، حتی اگر یک یا چند participant (شرکت‌کننده) saga (حماسه) به طور موقت unavailable (غیرقابل دسترس) باشند.</p>
<p>Sagas (حماسه‌ها) از ACID transactions (تراکنش‌های اتمی) در چند مورد مهم متفاوت هستند. همانطور که در بخش 4.3 به تفصیل شرح می‌دهم، آنها فاقد ویژگی isolation (انزوا) ACID transactions (تراکنش‌های اتمی) هستند. همچنین، از آنجایی که هر local transaction (تراکنش محلی) تغییرات خود را commit (تعهد) می‌کند، یک saga (حماسه) باید با استفاده از compensating transactions (تراکنش‌های جبرانی) بازگردانده شود. بعداً در این بخش بیشتر در مورد compensating transactions (تراکنش‌های جبرانی) صحبت خواهم کرد. بیایید نگاهی به یک example saga (حماسه مثال) بیندازیم.</p>
<h4><strong>AN EXAMPLE SAGA: THE CREATE ORDER SAGA (یک مثال از حماسه: حماسه ایجاد سفارش)</strong></h4>
<p>example saga (حماسه مثال) که در این فصل استفاده می‌شود، Create Order Saga (حماسه ایجاد سفارش) است که در شکل 4.2 نشان داده شده است. Order Service (سرویس سفارش) operation (عملیات) createOrder() (ایجاد سفارش) را با استفاده از این saga (حماسه) پیاده‌سازی می‌کند. اولین local transaction (تراکنش محلی) saga (حماسه) توسط request (درخواست) خارجی برای ایجاد یک order (سفارش) آغاز می‌شود. پنج local transactions (تراکنش محلی) دیگر هر کدام با تکمیل transaction (تراکنش) قبلی، trigger (راه‌اندازی) می‌شوند.</p>
<p>Pattern (الگو): Saga (حماسه)</p>
<p>Maintain data consistency (حفظ سازگاری داده‌ها) در سراسر services (سرویس‌ها) با استفاده از یک sequence (توالی) از local transactions (تراکنش‌های محلی)</p>
<p>که با استفاده از asynchronous messaging (پیام‌رسانی ناهمزمان) هماهنگ شده‌اند. See (به) http://microservices.io/patterns/data/saga.html مراجعه کنید.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0144_original/original_page.png" alt="Original Page 144">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Transaction management (مدیریت تراکنش) در یک microservice (ریز سرویس) architecture (معماری)</strong></h3>
<p>این saga (حماسه) شامل local transactions (تراکنش‌های محلی) زیر است:</p>
<ol>
<li>Order Service (سرویس سفارش) - ایجاد یک Order (سفارش) در یک state (وضعیت) APPROVAL_PENDING (در انتظار تایید).</li>
<li>Consumer Service (سرویس مصرف‌کننده) - تأیید اینکه consumer (مصرف‌کننده) می‌تواند یک order (سفارش) ثبت کند.</li>
<li>Kitchen Service (سرویس آشپزخانه) - validate (اعتبارسنجی) جزئیات order (سفارش) و ایجاد یک Ticket (بلیت) در CREATE_PENDING (در انتظار ایجاد).</li>
<li>Accounting Service (سرویس حسابداری) - authorize (مجوز) credit card (کارت اعتباری) مصرف‌کننده.</li>
<li>Kitchen Service (سرویس آشپزخانه) - تغییر state (وضعیت) Ticket (بلیت) به AWAITING_ACCEPTANCE (منتظر پذیرش).</li>
<li>Order Service (سرویس سفارش) - تغییر state (وضعیت) Order (سفارش) به APPROVED (تأیید شده).</li>
</ol>
<p>بعداً، در بخش 4.2، من توضیح می‌دهم که چگونه services (سرویس‌هایی) که در یک saga (حماسه) شرکت می‌کنند، با استفاده از asynchronous messaging (پیام‌رسانی ناهمزمان) ارتباط برقرار می‌کنند. یک service (سرویس) یک message (پیام) را زمانی منتشر می‌کند که یک local transaction (تراکنش محلی) تکمیل شود. سپس این message (پیام) گام بعدی در saga (حماسه) را trigger (راه‌اندازی) می‌کند. نه تنها استفاده از messaging (پیام‌رسانی) تضمین می‌کند که participants (شرکت‌کنندگان) saga (حماسه) به طور loosely coupled (شل و غیر متصل) هستند، بلکه تضمین می‌کند که یک saga (حماسه) تکمیل می‌شود. به این دلیل که اگر گیرنده یک message (پیام) به طور موقت unavailable (غیرقابل دسترس) باشد، message broker (واسطه پیام) message (پیام) را بافر (ذخیره) می‌کند تا زمانی که بتوان آن را تحویل داد.</p>
<p>در ظاهر، sagas (حماسه‌ها) ساده به نظر می‌رسند، اما چالش‌های کمی برای استفاده از آنها وجود دارد. یک چالش، کمبود isolation (انزوا) بین sagas (حماسه‌ها) است. بخش 4.3 نحوه رسیدگی به این مشکل را شرح می‌دهد. چالش دیگر، بازگرداندن تغییرات زمانی است که یک error (خطا) رخ می‌دهد. بیایید نگاهی به چگونگی انجام این کار بیندازیم.</p>
<h4><strong>SAGAS (حماسه‌ها) از COMPENSATING TRANSACTIONS (تراکنش‌های جبرانی) برای ROLL BACK (بازگرداندن) CHANGES (تغییرات) استفاده می‌کنند</strong></h4>
<p>یک ویژگی عالی از ACID transactions (تراکنش‌های اتمی) سنتی این است که business logic (منطق تجاری) می‌تواند به راحتی یک transaction (تراکنش) را در صورت تشخیص violation (نقض) یک business rule (قاعده تجاری) بازگرداند. این یک دستور ROLLBACK (بازگشت) را اجرا می‌کند، و database (پایگاه داده) تمام تغییرات ایجاد شده تا کنون را undo (واگردانی) می‌کند. متأسفانه، sagas (حماسه‌ها) را نمی‌توان به طور خودکار بازگرداند، زیرا هر گام تغییرات خود را در local database (پایگاه داده محلی) commit (تعهد) می‌کند. این بدان معناست، به عنوان مثال، اگر authorization (مجوز) کارت اعتباری در گام چهارم Create Order Saga (حماسه ایجاد سفارش) شکست بخورد، application (برنامه) FTGO باید به طور صریح...</p>
<br/>
<img alt="Figure 4.2" src="figure_4_2.png"/>
<p>ایجاد یک Order (سفارش) با استفاده از یک saga (حماسه). operation (عملیات) createOrder() (ایجاد سفارش) توسط یک</p>
<p>saga (حماسه) که شامل local transactions (تراکنش‌های محلی) در چندین service (سرویس) است، پیاده‌سازی می‌شود.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0145_original/original_page.png" alt="Original Page 145">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<p>undo (واگردانی) تغییرات ایجاد شده توسط سه مرحله اول. شما باید چیزی را بنویسید که به عنوان compensating transactions (تراکنش‌های جبرانی) شناخته می‌شود.</p>
<p>فرض کنید که (n + 1)th transaction (تراکنش) یک saga (حماسه) شکست می‌خورد. اثرات n transactions (تراکنش‌های) قبلی باید undo (واگردانی) شوند. از نظر مفهومی، هر یک از آن مراحل، Ti، یک compensating transaction (تراکنش جبرانی) متناظر، Ci، دارد که اثرات Ti را undo (واگردانی) می‌کند. برای undo (واگردانی) اثرات آن n گام اول، saga (حماسه) باید هر Ci را به ترتیب معکوس اجرا کند. sequence (توالی) مراحل T1 … Tn، Cn … C1 است، همانطور که در شکل 4.3 نشان داده شده است. در این مثال، Tn+1 شکست می‌خورد، که مستلزم undo (واگردانی) مراحل T1 … Tn است.</p>
<p>saga (حماسه) تراکنش‌های جبرانی را به ترتیب معکوس تراکنش‌های forward (به جلو) اجرا می‌کند: Cn … C1. مکانیک sequence (توالی) دادن Cis هیچ تفاوتی با sequence (توالی) دادن Tis ندارد. تکمیل Ci باید باعث اجرای Ci-1 شود.</p>
<p>به عنوان مثال، Create Order Saga (حماسه ایجاد سفارش) را در نظر بگیرید. این saga (حماسه) می‌تواند به دلایل مختلفی شکست بخورد:</p>
<ul>
<li>اطلاعات مصرف‌کننده invalid (نامعتبر) است یا به مصرف‌کننده اجازه ایجاد orders (سفارش‌ها) داده نمی‌شود.</li>
<li>اطلاعات رستوران invalid (نامعتبر) است یا رستوران قادر به پذیرش orders (سفارش‌ها) نیست.</li>
<li>authorization (مجوز) credit card (کارت اعتباری) مصرف‌کننده شکست می‌خورد.</li>
</ul>
<p>اگر یک local transaction (تراکنش محلی) شکست بخورد، مکانیزم coordination (هماهنگی) saga (حماسه) باید compensating transactions (تراکنش‌های جبرانی) را اجرا کند که Order (سفارش) و احتمالاً Ticket (بلیت) را رد می‌کند. جدول 4.1 compensating transactions (تراکنش‌های جبرانی) را برای هر مرحله از Create Order Saga (حماسه ایجاد سفارش) نشان می‌دهد. توجه به این نکته مهم است که همه مراحل به compensating transactions (تراکنش‌های جبرانی) نیاز ندارند. مراحل read-only (فقط خواندنی)، مانند verify-ConsumerDetails()، به compensating transactions (تراکنش‌های جبرانی) نیاز ندارند. همچنین مراحلی مانند authorizeCreditCard() که با مراحلی دنبال می‌شوند که همیشه موفق می‌شوند، نیازی به compensating transactions (تراکنش‌های جبرانی) ندارند.</p>
<p>بخش 4.3 توضیح می‌دهد که چگونه سه مرحله اول Create Order Saga (حماسه ایجاد سفارش) به عنوان compensatable transactions (تراکنش‌های قابل جبران) نامیده می‌شوند زیرا با مراحلی دنبال می‌شوند که می‌توانند شکست بخورند، چگونه مرحله چهارم به عنوان pivot transaction (تراکنش محوری) saga (حماسه) نامیده می‌شود زیرا با مراحلی دنبال می‌شود که ...</p>
<br/>
<img alt="Figure 4.3" src="figure_4_3.png"/>
<p>هنگامی که یک مرحله از یک saga (حماسه) به دلیل violation (نقض) یک business rule (قاعده تجاری) شکست می‌خورد، saga (حماسه) باید صریحاً</p>
<p>تغییرات ایجاد شده توسط مراحل قبلی را با اجرای compensating transactions (تراکنش‌های جبرانی) undo (واگردانی) کند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0146_original/original_page.png" alt="Original Page 146">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Coordinating sagas (هماهنگ‌سازی حماسه‌ها)</strong></h3>
<p>هرگز شکست نمی‌خورند، و چگونه دو مرحله آخر به عنوان retriable transactions (تراکنش‌های قابل تلاش مجدد) نامیده می‌شوند زیرا آنها همیشه موفق می‌شوند.</p>
<p>برای دیدن چگونگی استفاده از compensating transactions (تراکنش‌های جبرانی)، یک سناریو را تصور کنید که در آن authorization (مجوز) credit card (کارت اعتباری) مصرف‌کننده شکست می‌خورد. در این سناریو، saga (حماسه) local transactions (تراکنش‌های محلی) زیر را اجرا می‌کند:</p>
<ol>
<li>Order Service (سرویس سفارش) - ایجاد یک Order (سفارش) در یک state (وضعیت) APPROVAL_PENDING (در انتظار تایید).</li>
<li>Consumer Service (سرویس مصرف‌کننده) - تأیید اینکه consumer (مصرف‌کننده) می‌تواند یک order (سفارش) ثبت کند.</li>
<li>Kitchen Service (سرویس آشپزخانه) - validate (اعتبارسنجی) جزئیات order (سفارش) و ایجاد یک Ticket (بلیت) در state (وضعیت) CREATE_PENDING (در انتظار ایجاد).</li>
<li>Accounting Service (سرویس حسابداری) - authorize (مجوز) credit card (کارت اعتباری) مصرف‌کننده، که شکست می‌خورد.</li>
<li>Kitchen Service (سرویس آشپزخانه) - تغییر state (وضعیت) Ticket (بلیت) به CREATE_REJECTED (ایجاد رد شده).</li>
<li>Order Service (سرویس سفارش) - تغییر state (وضعیت) Order (سفارش) به REJECTED (رد شده).</li>
</ol>
<p>مراحل پنجم و ششم compensating transactions (تراکنش‌های جبرانی) هستند که به ترتیب به‌روزرسانی‌های انجام شده توسط Kitchen Service (سرویس آشپزخانه) و Order Service (سرویس سفارش) را undo (واگردانی) می‌کنند. logic (منطق) coordination (هماهنگی) یک saga (حماسه) مسئول sequence (توالی) دادن اجرای forward (به جلو) و compensating transactions (تراکنش‌های جبرانی) است. بیایید نگاهی به نحوه عملکرد آن بیندازیم.</p>
<h4><strong>4.2 Coordinating sagas (هماهنگ‌سازی حماسه‌ها)</strong></h4>
<p>پیاده‌سازی یک saga (حماسه) از منطقی تشکیل شده است که مراحل saga (حماسه) را هماهنگ می‌کند. هنگامی که یک saga (حماسه) توسط system command (دستور سیستم) آغاز می‌شود، logic (منطق) coordination (هماهنگی) باید اولین participant (شرکت‌کننده) saga (حماسه) را انتخاب کرده و به آن بگوید که یک local transaction (تراکنش محلی) را اجرا کند. پس از تکمیل آن transaction (تراکنش)، coordination (هماهنگی) sequence (توالی) saga (حماسه) participant (شرکت‌کننده) saga (حماسه) بعدی را انتخاب و فراخوانی می‌کند. این process (فرآیند) تا زمانی ادامه می‌یابد که saga (حماسه) تمام مراحل را اجرا کرده باشد. اگر هر local transaction (تراکنش محلی) شکست بخورد، saga (حماسه) باید compensating transactions (تراکنش‌های جبرانی) را به ترتیب معکوس اجرا کند. چند راه مختلف برای ساختار logic (منطق) coordination (هماهنگی) یک saga (حماسه) وجود دارد:</p>
<ul>
<li>Choreography (طراحی رقص) - تصمیم‌گیری و sequence (توالی) را در میان participants (شرکت‌کنندگان) saga (حماسه) توزیع کنید. آنها در درجه اول با تبادل events (رویدادها) ارتباط برقرار می‌کنند.</li>
</ul>
<br/>
<p>Table (جدول) 4.1</p>
<p>The compensating transactions (تراکنش‌های جبرانی) برای Create Order Saga (حماسه ایجاد سفارش)</p>
<br/>
<table>
<tr>
<td>Step (مرحله)</td>
<td>Service (سرویس)</td>
<td>Transaction (تراکنش)</td>
<td>Compensating transaction (تراکنش جبرانی)</td>
</tr>
<tr>
<td>1</td>
<td>Order Service (سرویس سفارش)</td>
<td>createOrder() (ایجاد سفارش)</td>
<td>rejectOrder() (رد سفارش)</td>
</tr>
<tr>
<td>2</td>
<td>Consumer Service (سرویس مصرف‌کننده)</td>
<td>verifyConsumerDetails() (تایید جزئیات مصرف کننده)</td>
<td>—</td>
</tr>
<tr>
<td>3</td>
<td>Kitchen Service (سرویس آشپزخانه)</td>
<td>createTicket() (ایجاد بلیط)</td>
<td>rejectTicket() (رد بلیط)</td>
</tr>
<tr>
<td>4</td>
<td>Accounting Service (سرویس حسابداری)</td>
<td>authorizeCreditCard() (مجوز کارت اعتباری)</td>
<td>—</td>
</tr>
<tr>
<td>5</td>
<td>Kitchen Service (سرویس آشپزخانه)</td>
<td>approveTicket() (تایید بلیط)</td>
<td>—</td>
</tr>
<tr>
<td>6</td>
<td>Order Service (سرویس سفارش)</td>
<td>approveOrder() (تایید سفارش)</td>
<td>—</td>
</tr>
</table>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0147_original/original_page.png" alt="Original Page 147">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<ul>
<li>Orchestration (ارکستراسیون) - منطق coordination (هماهنگی) یک saga (حماسه) را در یک کلاس saga orchestrator (ارکستراتور حماسه) متمرکز کنید. یک saga orchestrator (ارکستراتور حماسه) پیام‌های command (دستور) را به participants (شرکت‌کنندگان) saga (حماسه) ارسال می‌کند و به آنها می‌گوید چه operations (عملیاتی) را انجام دهند.</li>
</ul>
<p>بیایید به هر option (گزینه) نگاهی بیندازیم، با choreography (طراحی رقص) شروع می‌کنیم.</p>
<h4><strong>4.2.1 Choreography-based sagas (حماسه‌های مبتنی بر طراحی رقص)</strong></h4>
<p>یک راه برای پیاده‌سازی یک saga (حماسه) استفاده از choreography (طراحی رقص) است. هنگام استفاده از choreography (طراحی رقص)، هیچ هماهنگ‌کننده مرکزی وجود ندارد که به participants (شرکت‌کنندگان) saga (حماسه) بگوید چه کاری انجام دهند. در عوض، participants (شرکت‌کنندگان) saga (حماسه) به events (رویدادهای) یکدیگر subscribe (اشتراک) می‌کنند و بر این اساس پاسخ می‌دهند. برای نشان دادن نحوه عملکرد sagas (حماسه‌های) مبتنی بر choreography (طراحی رقص)، ابتدا یک مثال را شرح می‌دهم. پس از آن، به چند مورد از مسائل طراحی که باید به آنها رسیدگی کنید، می‌پردازم. سپس در مورد مزایا و معایب استفاده از choreography (طراحی رقص) بحث خواهم کرد.</p>
<p>IMPLEMENTING THE CREATE ORDER SAGA USING CHOREOGRAPHY (پیاده‌سازی Create Order Saga (حماسه ایجاد سفارش) با استفاده از CHOREOGRAPHY (طراحی رقص))</p>
<p>شکل 4.4 طراحی نسخه مبتنی بر choreography (طراحی رقص) Create Order Saga (حماسه ایجاد سفارش) را نشان می‌دهد. participants (شرکت‌کنندگان) با تبادل events (رویدادها) ارتباط برقرار می‌کنند. هر participant (شرکت‌کننده)، با Order Service (سرویس سفارش) شروع می‌شود، database (پایگاه داده) خود را به‌روزرسانی می‌کند و یک event (رویداد) را منتشر می‌کند که participant (شرکت‌کننده) بعدی را trigger (راه‌اندازی) می‌کند.</p>
<br/>
<p>Accounting Service (سرویس حسابداری)</p>
<p>4. createPendingAuthorization() (ایجاد مجوز در انتظار)</p>
<p>6. authorizeCard() (مجوز کارت)</p>
<p>Kitchen Service (سرویس آشپزخانه)</p>
<p>3. createTicket() (ایجاد بلیت)</p>
<p>6. approveTicket() (تایید بلیت)</p>
<p>Order (سفارش)</p>
<p>Service (سرویس)</p>
<p>1. createOrder() (ایجاد سفارش)</p>
<p>7. approveOrder() (تایید سفارش)</p>
<p>Consumer (مصرف‌کننده)</p>
<p>Service (سرویس)</p>
<p>2. verifyConsumerDetails() (تایید جزئیات مصرف‌کننده)</p>
<br/>
<p>Order (سفارش) events (رویدادها)</p>
<p>Message broker (واسطه پیام)</p>
<p>Consumer (مصرف‌کننده) veriﬁed (تایید شده)</p>
<p>Publish (انتشار)</p>
<p>Key (کلید)</p>
<p>Subscribe (اشتراک)</p>
<p>Consumer (مصرف‌کننده) events (رویدادها)</p>
<p>Ticket (بلیت) events (رویدادها)</p>
<p>Credit card (کارت اعتباری) events (رویدادها)</p>
<p>2</p>
<p>Order (سفارش) created (ایجاد شده)</p>
<p>1</p>
<p>Ticket (بلیت) created (ایجاد شده)</p>
<p>3</p>
<p>Credit card (کارت اعتباری) authorized (مجوز داده شده)</p>
<p>5</p>
<p>6</p>
<p>4</p>
<p>5a</p>
<p>7</p>
<p>5b</p>
<br/>
<img alt="Figure 4.4" src="figure_4_4.png"/>
<p>Implementing the Create Order Saga using choreography (پیاده‌سازی Create Order Saga (حماسه ایجاد سفارش) با استفاده از choreography (طراحی رقص)). participants (شرکت‌کنندگان) saga (حماسه) با</p>
<p>تبادل events (رویدادها) ارتباط برقرار می‌کنند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0148_original/original_page.png" alt="Original Page 148">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Coordinating sagas (هماهنگ‌سازی حماسه‌ها)</strong></h3>
<p>مسیر happy (خوشحال) از طریق این saga (حماسه) به شرح زیر است:</p>
<ol>
<li>Order Service (سرویس سفارش) یک Order (سفارش) را در state (وضعیت) APPROVAL_PENDING (در انتظار تایید) ایجاد می‌کند و یک event (رویداد) OrderCreated را منتشر می‌کند.</li>
<li>Consumer Service (سرویس مصرف‌کننده) event (رویداد) OrderCreated را مصرف می‌کند، تأیید می‌کند که consumer (مصرف‌کننده) می‌تواند order (سفارش) را ثبت کند، و یک event (رویداد) ConsumerVerified را منتشر می‌کند.</li>
<li>Kitchen Service (سرویس آشپزخانه) event (رویداد) OrderCreated را مصرف می‌کند، Order (سفارش) را validate (اعتبارسنجی) می‌کند، یک Ticket (بلیت) را در یک state (وضعیت) CREATE_PENDING (در انتظار ایجاد) ایجاد می‌کند، و event (رویداد) TicketCreated را منتشر می‌کند.</li>
<li>Accounting Service (سرویس حسابداری) event (رویداد) OrderCreated را مصرف می‌کند و یک Credit-CardAuthorization (مجوز کارت اعتباری) را در یک state (وضعیت) PENDING (در انتظار) ایجاد می‌کند.</li>
<li>Accounting Service (سرویس حسابداری) events (رویدادهای) TicketCreated و ConsumerVerified را مصرف می‌کند، credit card (کارت اعتباری) مصرف‌کننده را شارژ می‌کند، و event (رویداد) CreditCardAuthorized را منتشر می‌کند.</li>
<li>Kitchen Service (سرویس آشپزخانه) event (رویداد) CreditCardAuthorized را مصرف می‌کند و state (وضعیت) Ticket (بلیت) را به AWAITING_ACCEPTANCE (منتظر پذیرش) تغییر می‌دهد.</li>
<li>Order Service (سرویس سفارش) events (رویدادهای) CreditCardAuthorized را دریافت می‌کند، state (وضعیت) Order (سفارش) را به APPROVED (تایید شده) تغییر می‌دهد، و یک event (رویداد) OrderApproved را منتشر می‌کند.</li>
</ol>
<p>Create Order Saga (حماسه ایجاد سفارش) همچنین باید سناریویی را مدیریت کند که در آن یک participant (شرکت‌کننده) saga (حماسه) Order (سفارش) را رد می‌کند و نوعی event (رویداد) failure (شکست) را منتشر می‌کند. به عنوان مثال، authorization (مجوز) credit card (کارت اعتباری) مصرف‌کننده ممکن است شکست بخورد. saga (حماسه) باید compensating transactions (تراکنش‌های جبرانی) را اجرا کند تا آنچه را که قبلاً انجام شده است، undo (واگردانی) کند. شکل 4.5 جریان events (رویدادها) را زمانی نشان می‌دهد که AccountingService (سرویس حسابداری) نتواند credit card (کارت اعتباری) مصرف‌کننده را authorize (مجوز) کند.</p>
<p>توالی events (رویدادها) به شرح زیر است:</p>
<ol>
<li>Order Service (سرویس سفارش) یک Order (سفارش) را در state (وضعیت) APPROVAL_PENDING (در انتظار تایید) ایجاد می‌کند و یک event (رویداد) OrderCreated را منتشر می‌کند.</li>
<li>Consumer Service (سرویس مصرف‌کننده) event (رویداد) OrderCreated را مصرف می‌کند، تأیید می‌کند که consumer (مصرف‌کننده) می‌تواند order (سفارش) را ثبت کند، و یک event (رویداد) ConsumerVerified را منتشر می‌کند.</li>
<li>Kitchen Service (سرویس آشپزخانه) event (رویداد) OrderCreated را مصرف می‌کند، Order (سفارش) را validate (اعتبارسنجی) می‌کند، یک Ticket (بلیت) را در یک state (وضعیت) CREATE_PENDING (در انتظار ایجاد) ایجاد می‌کند، و event (رویداد) TicketCreated را منتشر می‌کند.</li>
<li>Accounting Service (سرویس حسابداری) event (رویداد) OrderCreated را مصرف می‌کند و یک Credit-CardAuthorization (مجوز کارت اعتباری) را در یک state (وضعیت) PENDING (در انتظار) ایجاد می‌کند.</li>
<li>Accounting Service (سرویس حسابداری) events (رویدادهای) TicketCreated و ConsumerVerified را مصرف می‌کند، credit card (کارت اعتباری) مصرف‌کننده را شارژ می‌کند، و یک event (رویداد) Credit Card Authorization Failed (مجوز کارت اعتباری ناموفق) را منتشر می‌کند.</li>
<li>Kitchen Service (سرویس آشپزخانه) event (رویداد) Credit Card Authorization Failed (مجوز کارت اعتباری ناموفق) را مصرف می‌کند و state (وضعیت) Ticket (بلیت) را به REJECTED (رد شده) تغییر می‌دهد.</li>
<li>Order Service (سرویس سفارش) event (رویداد) Credit Card Authorization Failed (مجوز کارت اعتباری ناموفق) را مصرف می‌کند و state (وضعیت) Order (سفارش) را به REJECTED (رد شده) تغییر می‌دهد.</li>
</ol>
<p>همانطور که مشاهده می‌کنید، participants (شرکت‌کنندگان) sagas (حماسه‌های) مبتنی بر choreography (طراحی رقص) با استفاده از publish/subscribe (انتشار/اشتراک) تعامل دارند. بیایید نگاهی دقیق‌تر به برخی از مسائل بیندازیم که هنگام پیاده‌سازی ارتباط مبتنی بر publish/subscribe (انتشار/اشتراک) برای sagas (حماسه‌های) خود باید در نظر بگیرید.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0149_original/original_page.png" alt="Original Page 149">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<p>RELIABLE EVENT-BASED COMMUNICATION (ارتباط مبتنی بر رویداد قابل اعتماد)</p>
<p>چندین مسئله مربوط به ارتباط بین service (سرویس) وجود دارد که هنگام پیاده‌سازی sagas (حماسه‌ها) مبتنی بر choreography (طراحی رقص) باید در نظر بگیرید. اولین مسئله، اطمینان از این است که یک participant (شرکت‌کننده) saga (حماسه)، database (پایگاه داده) خود را به‌روزرسانی می‌کند و یک event (رویداد) را به عنوان بخشی از یک transaction (تراکنش) database (پایگاه داده) منتشر می‌کند. هر مرحله از یک saga (حماسه) مبتنی بر choreography (طراحی رقص)، database (پایگاه داده) را به‌روزرسانی می‌کند و یک event (رویداد) را منتشر می‌کند. به عنوان مثال، در Create Order Saga (حماسه ایجاد سفارش)، Kitchen Service (سرویس آشپزخانه) یک event (رویداد) Consumer Verified (مصرف‌کننده تأیید شده) را دریافت می‌کند، یک Ticket (بلیت) ایجاد می‌کند و event (رویداد) Ticket Created (بلیت ایجاد شده) را منتشر می‌کند.</p>
<p>ضروری است که به‌روزرسانی database (پایگاه داده) و انتشار event (رویداد) به صورت atomically (اتمی) انجام شود. در نتیجه، برای برقراری ارتباط قابل اطمینان، participants (شرکت‌کنندگان) saga (حماسه) باید از transactional messaging (پیام‌رسانی تراکنشی)، که در فصل 3 توضیح داده شد، استفاده کنند.</p>
<p>دومین مسئله‌ای که باید در نظر بگیرید، اطمینان از این است که یک participant (شرکت‌کننده) saga (حماسه) باید قادر به map (نگاشت) هر event (رویدادی) باشد که دریافت می‌کند به داده‌های خود. به عنوان مثال، هنگامی که Order Service (سرویس سفارش) یک event (رویداد) Credit Card Authorized (کارت اعتباری تایید شده) را دریافت می‌کند، باید بتواند Order (سفارش) مربوطه را جستجو کند. راه‌حل این است که یک participant (شرکت‌کننده) saga (حماسه) events (رویدادهایی) را منتشر کند که شامل یک correlation id (شناسه همبستگی) باشد، که داده‌هایی هستند که به سایر participants (شرکت‌کنندگان) امکان می‌دهند mapping (نگاشت) را انجام دهند.</p>
<br/>
<p>Accounting Service (سرویس حسابداری)</p>
<p>4. createPendingAuthorization() (ایجاد مجوز در انتظار)</p>
<p>6. authorizeCard() (مجوز کارت)</p>
<p>Kitchen Service (سرویس آشپزخانه)</p>
<p>3. createTicket() (ایجاد بلیت)</p>
<p>6. rejectTicket() (رد بلیت)</p>
<p>Order (سفارش)</p>
<p>Service (سرویس)</p>
<p>1. createOrder() (ایجاد سفارش)</p>
<p>7. rejectOrder() (رد سفارش)</p>
<p>Consumer (مصرف‌کننده)</p>
<p>Service (سرویس)</p>
<p>2. verifyConsumerDetails() (تایید جزئیات مصرف‌کننده)</p>
<br/>
<p>Order (سفارش) events (رویدادها)</p>
<p>Message broker (واسطه پیام)</p>
<p>Consumer (مصرف‌کننده) veriﬁed (تأیید شده)</p>
<p>Publish (انتشار)</p>
<p>Key (کلید)</p>
<p>Subscribe (اشتراک)</p>
<p>Consumer (مصرف‌کننده) events (رویدادها)</p>
<p>Ticket (بلیت) events (رویدادها)</p>
<p>Credit card (کارت اعتباری) events (رویدادها)</p>
<p>2</p>
<p>Order (سفارش) created (ایجاد شده)</p>
<p>1</p>
<p>Ticket (بلیت) created (ایجاد شده)</p>
<p>3</p>
<p>Credit card authorization failed (مجوز کارت اعتباری ناموفق)</p>
<p>5</p>
<p>6</p>
<p>4</p>
<p>5a</p>
<p>7</p>
<p>5b</p>
<br/>
<img alt="Figure 4.5" src="figure_4_5.png"/>
<p>The sequence of events (توالی رویدادها) در Create Order Saga (حماسه ایجاد سفارش) زمانی که authorization (مجوز) credit card (کارت اعتباری) مصرف‌کننده شکست می‌خورد. Accounting Service (سرویس حسابداری) event (رویداد) Credit Card Authorization Failed (مجوز کارت اعتباری ناموفق) را منتشر می‌کند، که باعث می‌شود Kitchen Service (سرویس آشپزخانه) Ticket (بلیت) را رد کند، و Order Service (سرویس سفارش) Order (سفارش) را رد کند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0150_original/original_page.png" alt="Original Page 150">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Coordinating sagas (هماهنگ‌سازی حماسه‌ها)</strong></h3>
<p>به عنوان مثال، participants (شرکت‌کنندگان) Create Order Saga (حماسه ایجاد سفارش) می‌توانند از orderId (شناسه سفارش) به عنوان یک correlation ID (شناسه همبستگی) استفاده کنند که از یک participant (شرکت‌کننده) به participant (شرکت‌کننده) بعدی منتقل می‌شود. Accounting Service (سرویس حسابداری) یک event (رویداد) Credit Card Authorized (کارت اعتباری تایید شده) را منتشر می‌کند که شامل orderId (شناسه سفارش) از event (رویداد) TicketCreated (بلیت ایجاد شده) است. هنگامی که Order Service (سرویس سفارش) یک event (رویداد) Credit Card Authorized (کارت اعتباری تایید شده) را دریافت می‌کند، از orderId (شناسه سفارش) برای بازیابی Order (سفارش) مربوطه استفاده می‌کند. به طور مشابه، Kitchen Service (سرویس آشپزخانه) از orderId (شناسه سفارش) از آن event (رویداد) برای بازیابی Ticket (بلیت) مربوطه استفاده می‌کند.</p>
<p>BENEFITS AND DRAWBACKS OF CHOREOGRAPHY-BASED SAGAS (مزایا و معایب حماسه‌های مبتنی بر طراحی رقص)</p>
<p>حماسه‌های مبتنی بر Choreography (طراحی رقص) چندین مزیت دارند:</p>
<ul>
<li>Simplicity (سادگی) - Services (سرویس‌ها) هنگام ایجاد، به‌روزرسانی یا حذف business (تجاری) objects (اشیاء) ، events (رویدادها) را منتشر می‌کنند.</li>
<li>Loose coupling (اتصال شل) - The participants (شرکت‌کنندگان) به events (رویدادها) subscribe (اشتراک) می‌کنند و دانش مستقیمی از یکدیگر ندارند.</li>
</ul>
<p>و برخی از معایب وجود دارد:</p>
<ul>
<li>More difficult to understand (درک دشوارتر) - برخلاف orchestration (ارکستراسیون)، یک مکان واحد در کد وجود ندارد که saga (حماسه) را تعریف کند. در عوض، choreography (طراحی رقص) پیاده‌سازی saga (حماسه) را در میان services (سرویس‌ها) توزیع می‌کند. در نتیجه، درک نحوه عملکرد یک saga (حماسه) معین برای یک developer (توسعه‌دهنده) دشوار است.</li>
<li>Cyclic dependencies (وابستگی‌های چرخه‌ای) بین services (سرویس‌ها) - The saga participants (شرکت‌کنندگان حماسه) به events (رویدادهای) یکدیگر subscribe (اشتراک) می‌کنند، که اغلب وابستگی‌های چرخه‌ای ایجاد می‌کند. به عنوان مثال، اگر شکل 4.4 را با دقت بررسی کنید، وابستگی‌های چرخه‌ای را خواهید دید، مانند Order Service (سرویس سفارش)  Accounting Service (سرویس حسابداری)  Order Service (سرویس سفارش). اگرچه این لزوماً یک مشکل نیست، اما وابستگی‌های چرخه‌ای به عنوان یک design smell (بوی طراحی) در نظر گرفته می‌شوند.</li>
<li>Risk of tight coupling (خطر اتصال محکم) - هر participant (شرکت‌کننده) saga (حماسه) باید به همه events (رویدادهایی) که بر آنها تأثیر می‌گذارند، subscribe (اشتراک) کند. به عنوان مثال، Accounting Service (سرویس حسابداری) باید به تمام events (رویدادهایی) که باعث می‌شود credit card (کارت اعتباری) مصرف‌کننده شارژ یا بازپرداخت شود، subscribe (اشتراک) کند. در نتیجه، خطر این وجود دارد که باید در lockstep (همگام) با چرخه عمر order (سفارش) که توسط Order Service (سرویس سفارش) پیاده‌سازی شده است، به‌روزرسانی شود.</li>
</ul>
<p>Choreography (طراحی رقص) می‌تواند برای sagas (حماسه‌های) ساده به خوبی کار کند، اما به دلیل این معایب، اغلب بهتر است برای sagas (حماسه‌های) پیچیده‌تر از orchestration (ارکستراسیون) استفاده شود. بیایید نگاهی به نحوه عملکرد orchestration (ارکستراسیون) بیندازیم.</p>
<h4><strong>4.2.2 Orchestration-based sagas (حماسه‌های مبتنی بر ارکستراسیون)</strong></h4>
<p>Orchestration (ارکستراسیون) راه دیگری برای پیاده‌سازی sagas (حماسه‌ها) است. هنگام استفاده از orchestration (ارکستراسیون)، شما یک کلاس orchestrator (ارکستراتور) را تعریف می‌کنید که تنها مسئولیت آن این است که به participants (شرکت‌کنندگان) saga (حماسه) بگوید چه کاری انجام دهند. The saga orchestrator (ارکستراتور حماسه) با participants (شرکت‌کنندگان) با استفاده از تعامل command/async reply-style (دستور/پاسخ ناهمزمان) ارتباط برقرار می‌کند. برای اجرای یک مرحله saga (حماسه)، یک message (پیام) command (دستور) به یک participant (شرکت‌کننده) ارسال می‌کند که به آن می‌گوید چه operation (عملیاتی) را انجام دهد. پس از اینکه participant (شرکت‌کننده) saga (حماسه) operation (عملیات) را انجام داد، یک message (پیام) reply (پاسخ) را به orchestrator (ارکستراتور) ارسال می‌کند. سپس orchestrator (ارکستراتور) message (پیام) را پردازش می‌کند و تعیین می‌کند که کدام گام saga (حماسه) را باید انجام دهد.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0151_original/original_page.png" alt="Original Page 151">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<p>برای نشان دادن نحوه عملکرد sagas (حماسه‌های) مبتنی بر orchestration (ارکستراسیون)، ابتدا یک مثال را شرح می‌دهم. سپس نحوه model (مدل‌سازی) sagas (حماسه‌های) مبتنی بر orchestration (ارکستراسیون) را به عنوان state machines (ماشین‌های حالت) توضیح می‌دهم. من در مورد چگونگی استفاده از transactional messaging (پیام‌رسانی تراکنشی) برای اطمینان از ارتباط قابل اعتماد بین saga orchestrator (ارکستراتور حماسه) و participants (شرکت‌کنندگان) saga (حماسه) بحث خواهم کرد. سپس مزایا و معایب استفاده از sagas (حماسه‌های) مبتنی بر orchestration (ارکستراسیون) را شرح خواهم داد.</p>
<p>IMPLEMENTING THE CREATE ORDER SAGA USING ORCHESTRATION (پیاده‌سازی Create Order Saga (حماسه ایجاد سفارش) با استفاده از ORCHESTRATION (ارکستراسیون))</p>
<p>شکل 4.6 طراحی نسخه مبتنی بر orchestration (ارکستراسیون) Create Order Saga (حماسه ایجاد سفارش) را نشان می‌دهد. saga (حماسه) توسط کلاس CreateOrderSaga، که participants (شرکت‌کنندگان) saga (حماسه) را با استفاده از request/response (درخواست/پاسخ) asynchronous (ناهمزمان) فراخوانی می‌کند، orchestrated (ارکستر) می‌شود. این کلاس فرآیند را پیگیری می‌کند و پیام‌های command (دستور) را به participants (شرکت‌کنندگان) saga (حماسه)، مانند Kitchen Service (سرویس آشپزخانه) و Consumer Service (سرویس مصرف‌کننده) ارسال می‌کند. کلاس CreateOrderSaga پیام‌های reply (پاسخ) را از کانال reply (پاسخ) خود می‌خواند و سپس گام بعدی، در صورت وجود، را در saga (حماسه) تعیین می‌کند.</p>
<br/>
<p>Accounting (حسابداری)</p>
<p>Service (سرویس)</p>
<p>Kitchen (آشپزخانه)</p>
<p>Service (سرویس)</p>
<p>Consumer (مصرف‌کننده)</p>
<p>Service (سرویس)</p>
<p>Consumer Service (سرویس مصرف‌کننده)</p>
<p>request channel (کانال درخواست)</p>
<p>Consumer (مصرف‌کننده) veriﬁed (تایید شده)</p>
<p>2</p>
<p>4</p>
<p>6</p>
<p>Verify consumer (تایید مصرف کننده)</p>
<p>1</p>
<p>Approve (تایید) restaurant (رستوران)</p>
<p>order (سفارش)</p>
<p>7</p>
<p>Approve (تایید)</p>
<p>order (سفارش)</p>
<p>8</p>
<p>Create (ایجاد)</p>
<p>ticket (بلیت)</p>
<p>3</p>
<p>Authorize (مجوز)</p>
<p>card (کارت)</p>
<p>5</p>
<p>Card (کارت)</p>
<p>authorized (مجاز)</p>
<br/>
<p>Message broker (واسطه پیام)</p>
<p>Order (سفارش)</p>
<p>Service (سرویس)</p>
<p>Command message (پیام دستور)</p>
<p>Key (کلید)</p>
<p>Reply message (پیام پاسخ)</p>
<p>Create (ایجاد)</p>
<p>order saga (سفارش حماسه)</p>
<p>reply channel (کانال پاسخ)</p>
<p>Kitchen (آشپزخانه)</p>
<p>Service (سرویس)</p>
<p>request channel (کانال درخواست)</p>
<p>Accounting (حسابداری)</p>
<p>Service (سرویس)</p>
<p>request channel (کانال درخواست)</p>
<p>Order (سفارش)</p>
<p>Service (سرویس)</p>
<p>request channel (کانال درخواست)</p>
<p>Create (ایجاد)</p>
<p>order saga (سفارش حماسه)</p>
<p>orchestrator (ارکستراتور)</p>
<p>Ticket (بلیت) created (ایجاد شده)</p>
<br/>
<img alt="Figure 4.6" src="figure_4_6.png"/>
<p>Implementing the Create Order Saga using orchestration (پیاده‌سازی Create Order Saga (حماسه ایجاد سفارش) با استفاده از orchestration (ارکستراسیون)). Order Service (سرویس سفارش)</p>
<p>یک saga orchestrator (ارکستراتور حماسه) را پیاده‌سازی می‌کند، که participants (شرکت‌کنندگان) saga (حماسه) را با استفاده از request/response (درخواست/پاسخ) asynchronous (ناهمزمان) فراخوانی می‌کند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0152_original/original_page.png" alt="Original Page 152">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Coordinating sagas (هماهنگ‌سازی حماسه‌ها)</strong></h3>
<p>Order Service (سرویس سفارش) ابتدا یک Order (سفارش) و یک Create Order Saga orchestrator (ارکستراتور حماسه ایجاد سفارش) ایجاد می‌کند. پس از آن، جریان برای مسیر happy (خوشحال) به شرح زیر است:</p>
<ol>
<li>The saga orchestrator (ارکستراتور حماسه) یک command (دستور) Verify Consumer (تایید مصرف‌کننده) را به Consumer Service (سرویس مصرف‌کننده) ارسال می‌کند.</li>
<li>Consumer Service (سرویس مصرف‌کننده) با یک message (پیام) Consumer Verified (مصرف‌کننده تایید شد) پاسخ می‌دهد.</li>
<li>The saga orchestrator (ارکستراتور حماسه) یک command (دستور) Create Ticket (ایجاد بلیت) را به Kitchen Service (سرویس آشپزخانه) ارسال می‌کند.</li>
<li>Kitchen Service (سرویس آشپزخانه) با یک message (پیام) Ticket Created (بلیت ایجاد شد) پاسخ می‌دهد.</li>
<li>The saga orchestrator (ارکستراتور حماسه) یک message (پیام) Authorize Card (مجوز کارت) را به Accounting Service (سرویس حسابداری) ارسال می‌کند.</li>
<li>Accounting Service (سرویس حسابداری) با یک message (پیام) Card Authorized (کارت تایید شد) پاسخ می‌دهد.</li>
<li>The saga orchestrator (ارکستراتور حماسه) یک command (دستور) Approve Ticket (تایید بلیت) را به Kitchen Service (سرویس آشپزخانه) ارسال می‌کند.</li>
<li>The saga orchestrator (ارکستراتور حماسه) یک command (دستور) Approve Order (تایید سفارش) را به Order Service (سرویس سفارش) ارسال می‌کند.</li>
</ol>
<p>توجه داشته باشید که در گام آخر، the saga orchestrator (ارکستراتور حماسه) یک command message (پیام دستور) را به Order Service (سرویس سفارش) ارسال می‌کند، حتی اگر این یک component (مولفه) از Order Service (سرویس سفارش) باشد. در اصل، Create Order Saga (حماسه ایجاد سفارش) می‌تواند Order (سفارش) را با به‌روزرسانی مستقیم آن تأیید کند. اما برای consistent (سازگار) بودن، saga (حماسه) با Order Service (سرویس سفارش) مانند یک participant (شرکت‌کننده) دیگر رفتار می‌کند.</p>
<p>Diagrams (نمودارهایی) مانند شکل 4.6 هر کدام یک سناریو برای یک saga (حماسه) را نشان می‌دهند، اما یک saga (حماسه) احتمالاً سناریوهای متعددی دارد. به عنوان مثال، Create Order Saga (حماسه ایجاد سفارش) دارای چهار سناریو است. علاوه بر مسیر happy (خوشحال)، saga (حماسه) می‌تواند به دلیل failure (شکست) در Consumer Service (سرویس مصرف‌کننده)، Kitchen Service (سرویس آشپزخانه) یا Accounting Service (سرویس حسابداری) شکست بخورد. بنابراین، model (مدل‌سازی) یک saga (حماسه) به عنوان یک state machine (ماشین حالت) مفید است، زیرا تمام سناریوهای ممکن را توصیف می‌کند.</p>
<h4><strong>MODELING SAGA ORCHESTRATORS AS STATE MACHINES (مدل‌سازی ORCHESTRATORS (ارکستراتورها) SAGA (حماسه) به عنوان STATE MACHINES (ماشین‌های حالت))</strong></h4>
<p>یک راه خوب برای model (مدل‌سازی) یک saga orchestrator (ارکستراتور حماسه) به عنوان یک state machine (ماشین حالت) است. یک state machine (ماشین حالت) از یک مجموعه از states (حالت‌ها) و یک مجموعه از transitions (تغییرات) بین states (حالت‌ها) تشکیل شده است که توسط events (رویدادها) trigger (راه‌اندازی) می‌شوند. هر transition (تغییر) می‌تواند یک action (عمل) داشته باشد، که برای یک saga (حماسه) فراخوانی یک participant (شرکت‌کننده) saga (حماسه) است. transitions (تغییرات) بین states (حالت‌ها) با تکمیل یک local transaction (تراکنش محلی) که توسط یک participant (شرکت‌کننده) saga (حماسه) انجام می‌شود، trigger (راه‌اندازی) می‌شوند. current state (حالت فعلی) و specific outcome (نتیجه خاص) local transaction (تراکنش محلی) transition (تغییر) state (حالت) و چه action (عملی)، در صورت وجود، را تعیین می‌کند. همچنین استراتژی‌های testing (آزمایش) موثری برای state machines (ماشین‌های حالت) وجود دارد. در نتیجه، استفاده از یک model (مدل) state machine (ماشین حالت)، طراحی، پیاده‌سازی و testing (آزمایش) sagas (حماسه‌ها) را آسان‌تر می‌کند.</p>
<p>شکل 4.7 model (مدل) state machine (ماشین حالت) را برای Create Order Saga (حماسه ایجاد سفارش) نشان می‌دهد. این state machine (ماشین حالت) از numerous states (حالت‌های متعدد) تشکیل شده است، از جمله موارد زیر:</p>
<ul>
<li>Verifying Consumer (تایید مصرف‌کننده) - the initial state (حالت اولیه). هنگامی که در این state (حالت) قرار دارد، saga (حماسه) منتظر است تا Consumer Service (سرویس مصرف‌کننده) تأیید کند که مصرف‌کننده می‌تواند order (سفارش) را ثبت کند.</li>
<li>Creating Ticket (ایجاد بلیت) - saga (حماسه) منتظر یک reply (پاسخ) به command (دستور) Create Ticket (ایجاد بلیت) است.</li>
<li>Authorizing Card (مجوز کارت) - منتظر Accounting Service (سرویس حسابداری) برای authorize (مجوز) credit card (کارت اعتباری) مصرف‌کننده.</li>
<li>Order Approved (سفارش تایید شده) - یک final state (حالت نهایی) نشان می‌دهد که saga (حماسه) با موفقیت تکمیل شده است.</li>
<li>Order Rejected (سفارش رد شده) - یک final state (حالت نهایی) نشان می‌دهد که Order (سفارش) توسط یکی از participants (شرکت‌کنندگان) رد شده است.</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0153_original/original_page.png" alt="Original Page 153">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<p>The state machine (ماشین حالت) همچنین transitions (تغییرات) state (حالت) متعددی را تعریف می‌کند. به عنوان مثال، state machine (ماشین حالت) از حالت Creating Ticket (ایجاد بلیت) به حالت Authorizing Card (مجوز کارت) یا حالت Rejected Order (رد سفارش) transition (تغییر) می‌کند. این به حالت Authorizing Card (مجوز کارت) transition (تغییر) می‌کند وقتی یک reply (پاسخ) موفقیت‌آمیز به command (دستور) Create Ticket (ایجاد بلیت) دریافت می‌کند. از طرف دیگر، اگر Kitchen Service (سرویس آشپزخانه) نتوانست Ticket (بلیت) را ایجاد کند، state machine (ماشین حالت) به state (حالت) Rejected Order (رد سفارش) transition (تغییر) می‌کند.</p>
<p>اقدام اولیه state machine (ماشین حالت)، ارسال command (دستور) VerifyConsumer (تایید مصرف‌کننده) به Consumer Service (سرویس مصرف‌کننده) است. response (پاسخ) از Consumer Service (سرویس مصرف‌کننده) باعث ایجاد transition (تغییر) state (حالت) بعدی می‌شود. اگر مصرف‌کننده با موفقیت تأیید شد، saga (حماسه) Ticket (بلیت) را ایجاد می‌کند و به state (حالت) Creating Ticket (ایجاد بلیت) transition (تغییر) می‌کند. اما اگر تأیید مصرف‌کننده ناموفق بود، saga (حماسه) Order (سفارش) را رد می‌کند و به حالت Rejecting Order (رد سفارش) transition (تغییر) می‌کند. state machine (ماشین حالت) transition (تغییرات) state (حالت) متعددی دیگری را طی می‌کند که توسط responses (پاسخ‌ها) از participants (شرکت‌کنندگان) saga (حماسه) هدایت می‌شود، تا زمانی که به یک final state (حالت نهایی) Order Approved (سفارش تایید شده) یا Order Rejected (سفارش رد شده) برسد.</p>
<br/>
<p>Veriﬁng (تایید)</p>
<p>consumer (مصرف‌کننده)</p>
<p>Rejecting (رد)</p>
<p>order (سفارش)</p>
<p>Creating (ایجاد)</p>
<p>ticket (بلیت)</p>
<p>Authorizing (مجوز)</p>
<p>card (کارت)</p>
<p>Rejecting (رد)</p>
<p>ticket (بلیت)</p>
<p>Approving (تایید)</p>
<p>ticket (بلیت)</p>
<p>Approving (تایید)</p>
<p>order (سفارش)</p>
<p>Order (سفارش)</p>
<p>approved (تایید شده)</p>
<p>Order (سفارش)</p>
<p>rejected (رد شده)</p>
<p>/Send (ارسال) VerifyConsumer (تایید مصرف‌کننده)</p>
<p>ConsumerVeriﬁcationFailed/ (تأیید مصرف‌کننده ناموفق)/</p>
<p>send RejectOrder (ارسال رد سفارش)</p>
<p>Ticket creation failed/ (ایجاد بلیت ناموفق)/</p>
<p>send RejectOrder (ارسال رد سفارش)</p>
<p>ConsumerVeriﬁed/ (مصرف‌کننده تأیید شده)/</p>
<p>send CreateRestaurantOrder (ارسال ایجاد سفارش رستوران)</p>
<p>Ticket created/ (بلیت ایجاد شد)/</p>
<p>send AuthorizeCard (ارسال مجوز کارت)</p>
<p>Card authorized/ (کارت تایید شد)/</p>
<p>send ApproveTicket (ارسال تایید بلیت)</p>
<p>Ticket approved/ (بلیت تایید شد)/</p>
<p>send ApproveOrder (ارسال تایید سفارش)</p>
<p>Order approved (سفارش تایید شده)</p>
<p>Card authorization failed/ (مجوز کارت ناموفق)/</p>
<p>send RejectTicket (ارسال رد بلیت)</p>
<br/>
<img alt="Figure 4.7" src="figure_4_7.png"/>
<p>The state machine model (مدل ماشین حالت) برای Create Order Saga (حماسه ایجاد سفارش)</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0154_original/original_page.png" alt="Original Page 154">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Coordinating sagas (هماهنگ‌سازی حماسه‌ها)</strong></h3>
<p>SAGA ORCHESTRATION AND TRANSACTIONAL MESSAGING (ارکستراسیون حماسه و پیام‌رسانی تراکنشی)</p>
<p>هر مرحله از یک saga (حماسه) مبتنی بر orchestration (ارکستراسیون) شامل یک service (سرویس) است که یک database (پایگاه داده) را به‌روزرسانی می‌کند و یک message (پیام) را منتشر می‌کند. به عنوان مثال، Order Service (سرویس سفارش) یک Order (سفارش) و یک Create Order Saga orchestrator (ارکستراتور حماسه ایجاد سفارش) را ذخیره می‌کند و یک message (پیام) را به اولین participant (شرکت‌کننده) saga (حماسه) ارسال می‌کند. یک participant (شرکت‌کننده) saga (حماسه)، مانند Kitchen Service (سرویس آشپزخانه)، یک command message (پیام دستور) را با به‌روزرسانی database (پایگاه داده) خود و ارسال یک message (پیام) reply (پاسخ) مدیریت می‌کند. Order Service (سرویس سفارش) پیام reply (پاسخ) participant (شرکت‌کننده) را با به‌روزرسانی state (وضعیت) of the saga orchestrator (ارکستراتور حماسه) و ارسال یک command message (پیام دستور) به participant (شرکت‌کننده) saga (حماسه) بعدی پردازش می‌کند. همانطور که در فصل 3 توضیح داده شد، یک service (سرویس) باید از transactional messaging (پیام‌رسانی تراکنشی) استفاده کند تا database (پایگاه داده) را به صورت atomically (اتمی) به‌روزرسانی کند و messages (پیام‌ها) را منتشر کند. بعداً در بخش 4.4، من پیاده‌سازی saga (حماسه) Create Order Saga orchestrator (ارکستراتور ایجاد سفارش حماسه) را با جزئیات بیشتری شرح می‌دهم، از جمله نحوه استفاده از transactional messaging (پیام‌رسانی تراکنشی) در آن.</p>
<p>بیایید نگاهی به مزایا و معایب استفاده از saga orchestration (ارکستراسیون حماسه) بیندازیم.</p>
<p>BENEFITS AND DRAWBACKS OF ORCHESTRATION-BASED SAGAS (مزایا و معایب حماسه‌های مبتنی بر ارکستراسیون)</p>
<p>حماسه‌های مبتنی بر Orchestration (ارکستراسیون) چندین مزیت دارند:</p>
<ul>
<li>Simpler dependencies (وابستگی‌های ساده‌تر) - یک مزیت orchestration (ارکستراسیون) این است که وابستگی‌های چرخه‌ای را معرفی نمی‌کند. the saga orchestrator (ارکستراتور حماسه) participants (شرکت‌کنندگان) saga (حماسه) را فراخوانی می‌کند، اما participants (شرکت‌کنندگان) orchestrator (ارکستراتور) را فراخوانی نمی‌کنند. در نتیجه، orchestrator (ارکستراتور) به participants (شرکت‌کنندگان) وابسته است، اما برعکس نه، بنابراین هیچ وابستگی چرخه‌ای وجود ندارد.</li>
<li>Less coupling (کاهش اتصال) - هر service (سرویس) یک API (رابط برنامه‌نویسی) را پیاده‌سازی می‌کند که توسط orchestrator (ارکستراتور) فراخوانی می‌شود، بنابراین نیازی به دانستن events (رویدادهای) منتشر شده توسط participants (شرکت‌کنندگان) saga (حماسه) ندارد.</li>
<li>Improves separation of concerns (بهبود جداسازی نگرانی‌ها) و simplifies (ساده‌سازی) business logic (منطق تجاری) - منطق coordination (هماهنگی) saga (حماسه) در saga orchestrator (ارکستراتور حماسه) محلی‌سازی شده است. domain objects (اشیاء دامنه) ساده‌تر هستند و هیچ اطلاعی از sagas (حماسه‌هایی) که در آنها شرکت می‌کنند، ندارند. به عنوان مثال، هنگام استفاده از orchestration (ارکستراسیون)، کلاس Order (سفارش) هیچ اطلاعی از هیچ یک از sagas (حماسه‌ها) ندارد، بنابراین یک model (مدل) state machine (ماشین حالت) ساده‌تری دارد. در طول اجرای Create Order Saga (حماسه ایجاد سفارش)، مستقیماً از state (وضعیت) APPROVAL_PENDING (در انتظار تایید) به state (وضعیت) APPROVED (تایید شده) transition (تغییر) می‌کند. کلاس Order (سفارش) هیچ state (حالت) intermediate (واسطه‌ای) مربوط به مراحل saga (حماسه) ندارد. در نتیجه، business (تجارت) بسیار ساده‌تر است.</li>
</ul>
<p>Orchestration (ارکستراسیون) همچنین یک drawback (نقص) دارد: خطر متمرکز کردن بیش از حد business logic (منطق تجاری) در orchestrator (ارکستراتور). این منجر به طراحی می‌شود که در آن orchestrator (ارکستراتور) هوشمند به services (سرویس‌های) احمق می‌گوید چه operations (عملیاتی) را انجام دهند. خوشبختانه، می‌توانید با طراحی orchestrators (ارکستراتورهایی) که منحصراً مسئول sequence (توالی) هستند و حاوی هیچ business logic (منطق تجاری) دیگری نیستند، از این مشکل جلوگیری کنید.</p>
<p>من استفاده از orchestration (ارکستراسیون) را برای همه sagas (حماسه‌ها) به جز ساده‌ترین sagas (حماسه‌ها) توصیه می‌کنم. پیاده‌سازی logic (منطق) coordination (هماهنگی) برای sagas (حماسه‌های) شما تنها یکی از مشکلات طراحی است که باید حل کنید. مشکل دیگری، که شاید بزرگترین چالشی باشد که هنگام استفاده از sagas (حماسه‌ها) با آن روبرو خواهید شد، handling (مدیریت) کمبود isolation (انزوا) است. بیایید نگاهی به آن مشکل و نحوه حل آن بیندازیم.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0155_original/original_page.png" alt="Original Page 155">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<h4><strong>4.3 Handling the lack of isolation (مدیریت فقدان انزوا)</strong></h4>
<p>I در ACID (اتمی، سازگاری، انزوا، پایداری) مخفف isolation (انزوا) است. ویژگی isolation (انزوا) از ACID transactions (تراکنش‌های اتمی) تضمین می‌کند که نتیجه اجرای چندین transactions (تراکنش‌ها) به طور همزمان همانند اجرای آنها به ترتیب سریال است. database (پایگاه داده) این تصور را ایجاد می‌کند که هر ACID transaction (تراکنش اتمی) دسترسی انحصاری به data (داده‌ها) دارد. Isolation (انزوا) نوشتن business logic (منطق تجاری) را که به طور همزمان اجرا می‌شود بسیار آسان‌تر می‌کند.</p>
<p>چالش استفاده از sagas (حماسه‌ها) این است که آنها فاقد ویژگی isolation (انزوا) ACID transactions (تراکنش‌های اتمی) هستند. به این دلیل که به‌روزرسانی‌های انجام شده توسط هر یک از local transactions (تراکنش‌های محلی) یک saga (حماسه) بلافاصله پس از اینکه آن transaction (تراکنش) commit (تعهد) می‌شود، برای سایر sagas (حماسه‌ها) قابل مشاهده است. این رفتار می‌تواند باعث دو مشکل شود. اولاً، سایر sagas (حماسه‌ها) می‌توانند data (داده‌های) دسترسی‌یافته توسط saga (حماسه) را در حین اجرا تغییر دهند. و سایر sagas (حماسه‌ها) می‌توانند data (داده‌های) آن را قبل از اینکه saga (حماسه) به‌روزرسانی‌های خود را کامل کند، بخوانند و در نتیجه در معرض داده‌های inconsistent (ناهمخوان) قرار گیرند. در واقع، می‌توانید یک saga (حماسه) را ACD در نظر بگیرید:</p>
<ul>
<li>Atomicity (اتمی) - پیاده‌سازی saga (حماسه) تضمین می‌کند که تمام تراکنش‌ها اجرا می‌شوند یا تمام تغییرات undo (واگردانی) می‌شوند.</li>
<li>Consistency (سازگاری) - یکپارچگی referential (ارجاعی) در یک service (سرویس) توسط local databases (پایگاه‌های داده محلی) مدیریت می‌شود. یکپارچگی referential (ارجاعی) در سراسر services (سرویس‌ها) توسط services (سرویس‌ها) مدیریت می‌شود.</li>
<li>Durability (پایداری) - توسط local databases (پایگاه‌های داده محلی) مدیریت می‌شود.</li>
</ul>
<p>این فقدان isolation (انزوا) به طور بالقوه باعث چیزی می‌شود که ادبیات database (پایگاه داده) آن را anomalies (ناهنجاری‌ها) می‌نامد. یک anomaly (ناهنجاری) زمانی است که یک transaction (تراکنش) data (داده‌ها) را به روشی می‌خواند یا می‌نویسد که اگر transactions (تراکنش‌ها) یکی در یک زمان اجرا می‌شد، اینطور نبود. هنگامی که یک anomaly (ناهنجاری) رخ می‌دهد، نتیجه اجرای sagas (حماسه‌ها) به طور همزمان متفاوت از اجرای آنها به صورت سریال است.</p>
<p>در ظاهر، فقدان isolation (انزوا) غیرقابل اجرا به نظر می‌رسد. اما در عمل، این یک امر رایج است که توسعه‌دهندگان برای عملکرد بالاتر، isolation (انزوای) کاهش یافته را بپذیرند. یک RDBMS (سیستم مدیریت پایگاه داده رابطه‌ای) به شما اجازه می‌دهد سطح isolation (انزوا) را برای هر transaction (تراکنش) مشخص کنید (https://dev.mysql .com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html). سطح isolation (انزوا) پیش‌فرض معمولاً یک سطح isolation (انزوا) است که ضعیف‌تر از full isolation (انزوای کامل) است، که همچنین به عنوان serializable transactions (تراکنش‌های سریال‌شدنی) شناخته می‌شود. تراکنش‌های database (پایگاه داده) در دنیای واقعی اغلب با تعاریف کتاب درسی ACID transactions (تراکنش‌های اتمی) متفاوت هستند.</p>
<p>بخش بعدی در مورد مجموعه‌ای از استراتژی‌های طراحی saga (حماسه) بحث می‌کند که با فقدان isolation (انزوا) سروکار دارند. این استراتژی‌ها به عنوان countermeasures (اقدامات متقابل) شناخته می‌شوند. برخی از countermeasures (اقدامات متقابل) isolation (انزوا) را در سطح application (برنامه) پیاده‌سازی می‌کنند. سایر countermeasures (اقدامات متقابل) ریسک business (تجاری) را از فقدان isolation (انزوا) کاهش می‌دهند. با استفاده از countermeasures (اقدامات متقابل)، می‌توانید business logic (منطق تجاری) مبتنی بر saga (حماسه) را بنویسید که به درستی کار می‌کند.</p>
<p>من بخش را با توصیف anomalies (ناهنجاری‌هایی) که ناشی از فقدان isolation (انزوا) هستند، شروع می‌کنم. پس از آن، در مورد countermeasures (اقدامات متقابلی) صحبت خواهم کرد که یا آن anomalies (ناهنجاری‌ها) را حذف می‌کنند یا ریسک business (تجاری) آنها را کاهش می‌دهند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0156_original/original_page.png" alt="Original Page 156">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Handling the lack of isolation (مدیریت فقدان انزوا)</strong></h3>
<h4><strong>4.3.1 Overview of anomalies (مروری بر ناهنجاری‌ها)</strong></h4>
<p>فقدان isolation (انزوا) می‌تواند باعث سه anomalies (ناهنجاری‌ها) زیر شود:</p>
<ul>
<li>Lost updates (به‌روزرسانی‌های از دست رفته) - یک saga (حماسه) بدون خواندن تغییرات ایجاد شده توسط یک saga (حماسه) دیگر، داده‌ها را بازنویسی می‌کند.</li>
<li>Dirty reads (خواندن‌های کثیف) - یک transaction (تراکنش) یا یک saga (حماسه) به‌روزرسانی‌های انجام شده توسط یک saga (حماسه) را که هنوز آن به‌روزرسانی‌ها را تکمیل نکرده است، می‌خواند.</li>
<li>Fuzzy/nonrepeatable reads (خواندن‌های فازی/غیر تکراری) - دو مرحله مختلف از یک saga (حماسه) داده‌های یکسانی را می‌خوانند و نتایج متفاوتی دریافت می‌کنند، زیرا یک saga (حماسه) دیگر به‌روزرسانی‌هایی انجام داده است.</li>
</ul>
<p>هر سه anomaly (ناهنجاری‌ها) می‌توانند رخ دهند، اما دو مورد اول رایج‌ترین و چالش‌برانگیزترین هستند. بیایید نگاهی به این دو نوع anomaly (ناهنجاری) بیندازیم، با lost updates (به‌روزرسانی‌های از دست رفته) شروع می‌کنیم.</p>
<p>LOST UPDATES (به‌روزرسانی‌های از دست رفته)</p>
<p>یک lost update anomaly (ناهنجاری به‌روزرسانی از دست رفته) زمانی رخ می‌دهد که یک saga (حماسه) یک به‌روزرسانی ایجاد شده توسط یک saga (حماسه) دیگر را بازنویسی می‌کند. به عنوان مثال، سناریوی زیر را در نظر بگیرید:</p>
<ol>
<li>گام اول Create Order Saga (حماسه ایجاد سفارش) یک Order (سفارش) ایجاد می‌کند.</li>
<li>در حالی که آن saga (حماسه) در حال اجرا است، Cancel Order Saga (حماسه لغو سفارش) Order (سفارش) را لغو می‌کند.</li>
<li>گام نهایی Create Order Saga (حماسه ایجاد سفارش) Order (سفارش) را تأیید می‌کند.</li>
</ol>
<p>در این سناریو، Create Order Saga (حماسه ایجاد سفارش) به‌روزرسانی انجام شده توسط Cancel Order Saga (حماسه لغو سفارش) را نادیده می‌گیرد و آن را بازنویسی می‌کند. در نتیجه، application (برنامه) FTGO یک سفارش را ارسال می‌کند که مشتری آن را لغو کرده بود. بعداً در این بخش، نحوه جلوگیری از lost updates (به‌روزرسانی‌های از دست رفته) را نشان خواهم داد.</p>
<p>DIRTY READS (خواندن‌های کثیف)</p>
<p>یک dirty read (خواندن کثیف) زمانی رخ می‌دهد که یک saga (حماسه) داده‌هایی را می‌خواند که در میانه به‌روزرسانی توسط یک saga (حماسه) دیگر است. به عنوان مثال، یک نسخه از فروشگاه application (برنامه) FTGO را در نظر بگیرید که در آن مصرف‌کنندگان دارای credit limit (محدودیت اعتباری) هستند. در این application (برنامه)، یک saga (حماسه) که یک order (سفارش) را لغو می‌کند، از تراکنش‌های زیر تشکیل شده است:</p>
<ul>
<li>Consumer Service (سرویس مصرف‌کننده) - افزایش available credit (اعتبار موجود).</li>
<li>Order Service (سرویس سفارش) - تغییر state (وضعیت) Order (سفارش) به cancelled (لغو شده).</li>
<li>Delivery Service (سرویس تحویل) - لغو تحویل.</li>
</ul>
<p>بیایید یک سناریو را تصور کنیم که اجرای Cancel Order (لغو سفارش) و Create Order (ایجاد سفارش) Sagas (حماسه‌ها) را با هم تداخل می‌کند، و Cancel Order Saga (حماسه لغو سفارش) لغو می‌شود زیرا برای لغو تحویل دیر شده است. این امکان وجود دارد که توالی transactions (تراکنش‌هایی) که Consumer Service (سرویس مصرف‌کننده) را فراخوانی می‌کنند، به شرح زیر باشد:</p>
<ol>
<li>Cancel Order Saga (حماسه لغو سفارش) - افزایش available credit (اعتبار موجود).</li>
<li>Create Order Saga (حماسه ایجاد سفارش) - کاهش available credit (اعتبار موجود).</li>
<li>Cancel Order Saga (حماسه لغو سفارش) - یک compensating transaction (تراکنش جبرانی) که available credit (اعتبار موجود) را کاهش می‌دهد.</li>
</ol>
<p>در این سناریو، Create Order Saga (حماسه ایجاد سفارش) یک dirty read (خواندن کثیف) از available credit (اعتبار موجود) انجام می‌دهد که مصرف‌کننده را قادر می‌سازد تا یک order (سفارش) را ثبت کند که از credit limit (محدودیت اعتباری) آنها فراتر می‌رود. احتمالاً این یک ریسک غیرقابل قبول برای business (تجارت) است.</p>
<p>بیایید نگاهی بیندازیم که چگونه می‌توان از تأثیر این و سایر انواع anomalies (ناهنجاری‌ها) بر یک application (برنامه) جلوگیری کرد.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0157_original/original_page.png" alt="Original Page 157">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<h4><strong>4.3.2 Countermeasures for handling the lack of isolation (اقدامات متقابل برای مدیریت فقدان انزوا)</strong></h4>
<p>model (مدل) تراکنش saga (حماسه) ACD است، و فقدان isolation (انزوا) آن می‌تواند منجر به anomalies (ناهنجاری‌ها) شود که باعث می‌شود applications (برنامه‌ها) بد عمل کنند. این مسئولیت developer (توسعه‌دهنده) است که sagas (حماسه‌ها) را به گونه‌ای بنویسد که یا از anomalies (ناهنجاری‌ها) جلوگیری کند یا تأثیر آنها را بر business (تجارت) به حداقل برساند. این ممکن است یک کار دلهره‌آور به نظر برسد، اما شما قبلاً یک example (نمونه) از یک strategy (استراتژی) را دیده‌اید که از anomalies (ناهنجاری‌ها) جلوگیری می‌کند. استفاده Order (سفارش) از states (حالت‌های) *_PENDING، مانند APPROVAL _PENDING، نمونه‌ای از یک چنین strategy (استراتژی) است. Sagas (حماسه‌ها) که Orders (سفارش‌ها) را به‌روزرسانی می‌کنند، مانند Create Order Saga (حماسه ایجاد سفارش)، با تنظیم state (وضعیت) یک Order (سفارش) به *_PENDING شروع می‌شوند. state (وضعیت) *_PENDING به سایر transactions (تراکنش‌ها) می‌گوید که Order (سفارش) توسط یک saga (حماسه) در حال به‌روزرسانی است و بر این اساس عمل کنند.</p>
<p>استفاده Order (سفارش) از states (حالت‌های) *_PENDING نمونه‌ای از چیزی است که مقاله 1998 «Seman-tic ACID properties (ویژگی‌های اتمی، سازگاری، انزوا، پایداری معنایی) در multidatabases (چند پایگاه داده) با استفاده از remote procedure calls (فراخوانی رویه‌ای از راه دور) و update prop-agations (انتشار به‌روزرسانی‌ها)» توسط Lars Frank (لارس فرانک) و Torben U. Zahle (توربن یو. زاله) آن را یک semantic lock countermeasure (اقدام متقابل قفل معنایی) می‌نامد (https://dl.acm.org/citation.cfm?id=284472.284478). این مقاله نحوه برخورد با فقدان isolation (انزوا) transaction (تراکنش) در architectures (معماری‌های) multi-database (چند پایگاه داده) را که از distributed transactions (تراکنش‌های توزیع شده) استفاده نمی‌کنند، شرح می‌دهد. بسیاری از ایده‌های آن هنگام طراحی sagas (حماسه‌ها) مفید هستند. این مقاله مجموعه‌ای از countermeasures (اقدامات متقابل) را برای رسیدگی به anomalies (ناهنجاری‌ها) ناشی از فقدان isolation (انزوا) توضیح می‌دهد که یا از یک یا چند anomaly (ناهنجاری) جلوگیری می‌کنند یا تأثیر آنها را بر business (تجارت) به حداقل می‌رسانند. countermeasures (اقدامات متقابل) شرح داده شده در این مقاله به شرح زیر است:</p>
<ul>
<li>Semantic lock (قفل معنایی) - یک lock (قفل) در سطح application (برنامه).</li>
<li>Commutative updates (به‌روزرسانی‌های جابجایی) - طراحی operations (عملیات‌های) به‌روزرسانی برای اجرا به هر ترتیبی.</li>
<li>Pessimistic view (دیدگاه بدبینانه) - reorder (تغییر ترتیب) مراحل یک saga (حماسه) برای به حداقل رساندن ریسک business (تجاری).</li>
<li>Reread value (مقدار دوباره خوانده شده) - جلوگیری از dirty writes (نوشتن‌های کثیف) با rereading (دوباره خواندن) داده‌ها برای تأیید اینکه قبل از بازنویسی، بدون تغییر باقی مانده است.</li>
<li>Version file (فایل نسخه) - به‌روزرسانی‌ها را در یک record (رکورد) ثبت کنید تا بتوانند reorder (تغییر ترتیب) شوند.</li>
<li>By value (با مقدار) - از ریسک business (تجاری) هر request (درخواست) برای انتخاب پویا mechanism (مکانیسم) concurrency (همزمانی) استفاده کنید.</li>
</ul>
<p>در ادامه این بخش، من هر یک از این countermeasures (اقدامات متقابل) را شرح می‌دهم، اما ابتدا می‌خواهم اصطلاحاتی را برای توصیف ساختار یک saga (حماسه) معرفی کنم که هنگام بحث در مورد countermeasures (اقدامات متقابل) مفید است.</p>
<p>THE STRUCTURE OF A SAGA (ساختار یک حماسه)</p>
<p>مقاله countermeasures (اقدامات متقابل) که در بخش آخر ذکر شد، یک model (مدل) مفید برای ساختار یک saga (حماسه) تعریف می‌کند. در این model (مدل)، که در شکل 4.8 نشان داده شده است، یک saga (حماسه) از سه نوع transactions (تراکنش‌ها) تشکیل شده است:</p>
<ul>
<li>Compensatable transactions (تراکنش‌های قابل جبران) - تراکنش‌هایی که به طور بالقوه می‌توانند با استفاده از یک compensating transaction (تراکنش جبرانی) بازگردانده شوند.</li>
<li>Pivot transaction (تراکنش محوری) - نقطه go/no-go (برو/نرو) در یک saga (حماسه). اگر pivot transaction (تراکنش محوری) commit (تعهد) شود، saga (حماسه) تا تکمیل اجرا می‌شود. یک pivot transaction (تراکنش محوری) می‌تواند یک transaction (تراکنشی) باشد که نه قابل جبران است و نه قابل بازیابی. از طرف دیگر، می‌تواند آخرین transaction (تراکنش) قابل جبران یا اولین transaction (تراکنش) retriable (قابل تلاش مجدد) باشد.</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0158_original/original_page.png" alt="Original Page 158">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Handling the lack of isolation (مدیریت فقدان انزوا)</strong></h3>
<ul>
<li>Retriable transactions (تراکنش‌های قابل تلاش مجدد) - تراکنش‌هایی که از pivot transaction (تراکنش محوری) پیروی می‌کنند و موفقیت آنها تضمین شده است.</li>
</ul>
<p>در Create Order Saga (حماسه ایجاد سفارش)، مراحل createOrder() (ایجاد سفارش)، verifyConsumerDetails() (تایید جزئیات مصرف‌کننده) و createTicket() (ایجاد بلیت) compensatable transactions (تراکنش‌های قابل جبران) هستند. تراکنش‌های createOrder() (ایجاد سفارش) و createTicket() (ایجاد بلیت) تراکنش‌های جبرانی دارند که به‌روزرسانی‌های آنها را undo (واگردانی) می‌کنند. transaction (تراکنش) verifyConsumerDetails() (تایید جزئیات مصرف‌کننده) فقط خواندنی است، بنابراین نیازی به یک compensating transaction (تراکنش جبرانی) ندارد. transaction (تراکنش) authorizeCreditCard() (مجوز کارت اعتباری) این saga (حماسه) pivot transaction (تراکنش محوری) است. اگر credit card (کارت اعتباری) مصرف‌کننده بتواند authorized (مجوز) شود، این saga (حماسه) تکمیل می‌شود. مراحل approveTicket() (تایید بلیت) و approveOrder() (تایید سفارش) retriable transactions (تراکنش‌های قابل تلاش مجدد) هستند که از pivot transaction (تراکنش محوری) پیروی می‌کنند.</p>
<p>تمایز بین compensatable transactions (تراکنش‌های قابل جبران) و retriable transactions (تراکنش‌های قابل تلاش مجدد) به ویژه مهم است. همانطور که خواهید دید، هر نوع transaction (تراکنش) نقش متفاوتی در countermeasures (اقدامات متقابل) ایفا می‌کند. فصل 13 بیان می‌کند که هنگام مهاجرت به microservices (ریز سرویس‌ها)، monolith (یکپارچه) گاهی اوقات باید در sagas (حماسه‌ها) شرکت کند و اگر monolith (یکپارچه) فقط نیاز به اجرای retriable transactions (تراکنش‌های قابل تلاش مجدد) داشته باشد، بسیار ساده‌تر است.</p>
<p>اکنون بیایید به هر countermeasure (اقدام متقابل) نگاهی بیندازیم، با semantic lock countermeasure (اقدام متقابل قفل معنایی) شروع می‌کنیم.</p>
<p>COUNTERMEASURE: SEMANTIC LOCK (اقدام متقابل: قفل معنایی)</p>
<p>هنگام استفاده از semantic lock countermeasure (اقدام متقابل قفل معنایی)، compensatable transaction (تراکنش قابل جبران) یک flag (پرچم) را در هر record (رکورد) که ایجاد یا به‌روزرسانی می‌کند، تنظیم می‌کند. این flag (پرچم) نشان می‌دهد که record (رکورد)...</p>
<br/>
<table>
<tr>
<td>Step (مرحله)</td>
<td>Service (سرویس)</td>
<td>Transaction (تراکنش)</td>
<td>Compensation Transaction (تراکنش جبرانی)</td>
</tr>
<tr>
<td>1</td>
<td>Order Service (سرویس سفارش)</td>
<td>createOrder() (ایجاد سفارش)</td>
<td>rejectOrder() (رد سفارش)</td>
</tr>
<tr>
<td>2</td>
<td>Consumer Service (سرویس مصرف‌کننده)</td>
<td>verifyConsumerDetails() (تایید جزئیات مصرف‌کننده)</td>
<td>-</td>
</tr>
<tr>
<td>3</td>
<td>Kitchen Service (سرویس آشپزخانه)</td>
<td>createTicket() (ایجاد بلیت)</td>
<td>rejectTicket() (رد بلیت)</td>
</tr>
<tr>
<td>4</td>
<td>Accounting Service (سرویس حسابداری)</td>
<td>authorizeCreditCard() (مجوز کارت اعتباری)</td>
<td>-</td>
</tr>
<tr>
<td>5</td>
<td>Restaurant Order Service (سرویس سفارش رستوران)</td>
<td>approveRestaurantOrder() (تایید سفارش رستوران)</td>
<td>-</td>
</tr>
<tr>
<td>6</td>
<td>Order Service (سرویس سفارش)</td>
<td>approveOrder() (تایید سفارش)</td>
<td>-</td>
</tr>
</table>
<br/>
<p>Compensatable transactions (تراکنش‌های قابل جبران):</p>
<p>Must support roll back (باید از بازگشت پشتیبانی کند)</p>
<p>Pivot transactions (تراکنش‌های محوری):</p>
<p>The saga’s go/no-go transaction (تراکنش go/no-go حماسه).</p>
<p>If it succeeds, then the saga runs (اگر موفق شود، saga (حماسه) اجرا می‌شود)</p>
<p>to completion (تا تکمیل).</p>
<p>Retriable transactions (تراکنش‌های قابل تلاش مجدد):</p>
<p>Guaranteed to complete (تضمین شده برای تکمیل)</p>
<br/>
<img alt="Figure 4.8" src="figure_4_8.png"/>
<p>A saga consists of three different types of transactions (یک حماسه از سه نوع مختلف تراکنش تشکیل شده است): compensatable transactions (تراکنش‌های قابل جبران)،</p>
<p>which can be rolled back (که می‌تواند بازگردانده شود)، so have a compensating transaction (بنابراین یک تراکنش جبرانی دارد)، a pivot transaction (یک تراکنش محوری)، which is the (که نقطه go/no-go حماسه است)، and retriable transactions (تراکنش‌های قابل تلاش مجدد)، which are transactions that don’t need to be (که تراکنش‌هایی هستند که نیازی به بازگرداندن ندارند) </p>
<p>rolled back and are guaranteed to complete (و تکمیل آنها تضمین شده است).</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0159_original/original_page.png" alt="Original Page 159">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<p>isn’t (نیست) committed (تعهد) شده و به طور بالقوه می‌تواند تغییر کند. flag (پرچم) می‌تواند یا یک lock (قفل) باشد که از دسترسی سایر transactions (تراکنش‌ها) به record (رکورد) جلوگیری می‌کند یا یک warning (هشدار) که نشان می‌دهد سایر transactions (تراکنش‌ها) باید با سوء ظن با آن record (رکورد) رفتار کنند. این توسط یک retriable transaction (تراکنش قابل تلاش مجدد) - saga (حماسه) با موفقیت در حال تکمیل است - یا توسط یک compensating transaction (تراکنش جبرانی) پاک می‌شود: saga (حماسه) در حال بازگشت است.</p>
<p>فیلد Order.state یک مثال عالی از یک semantic lock (قفل معنایی) است. states (حالت‌های) *_PENDING، مانند APPROVAL_PENDING (در انتظار تایید) و REVISION_PENDING (در انتظار تجدید نظر)، یک semantic lock (قفل معنایی) را پیاده‌سازی می‌کنند. آنها به سایر sagas (حماسه‌ها) که به یک Order (سفارش) دسترسی دارند، می‌گویند که یک saga (حماسه) در حال به‌روزرسانی Order (سفارش) است. به عنوان مثال، اولین گام از Create Order Saga (حماسه ایجاد سفارش)، که یک compensatable transaction (تراکنش قابل جبران) است، یک Order (سفارش) را در یک state (وضعیت) APPROVAL_PENDING (در انتظار تایید) ایجاد می‌کند. گام نهایی Create Order Saga (حماسه ایجاد سفارش)، که یک retriable transaction (تراکنش قابل تلاش مجدد) است، فیلد را به APPROVED (تایید شده) تغییر می‌دهد. یک compensating transaction (تراکنش جبرانی) فیلد را به REJECTED (رد شده) تغییر می‌دهد.</p>
<p>مدیریت lock (قفل) تنها نیمی از مشکل است. شما همچنین باید در مورد اینکه چگونه یک saga (حماسه) باید با یک record (رکورد) که locked (قفل) شده است، بر اساس هر مورد تصمیم بگیرید. به عنوان مثال، system command (دستور سیستم) cancelOrder() (لغو سفارش) را در نظر بگیرید. یک client (مشتری) ممکن است این operation (عملیات) را برای لغو یک Order (سفارش) که در state (وضعیت) APPROVAL_PENDING (در انتظار تایید) است، فراخوانی کند.</p>
<p>چندین راه مختلف برای handling (مدیریت) این سناریو وجود دارد. یک گزینه این است که system command (دستور سیستم) cancelOrder() (لغو سفارش) شکست بخورد و به client (مشتری) بگوید که بعداً دوباره امتحان کند. مزیت اصلی این رویکرد این است که پیاده‌سازی آن ساده است. با این حال، drawback (نقص) این است که client (مشتری) را پیچیده‌تر می‌کند زیرا باید منطق retry (تلاش مجدد) را پیاده‌سازی کند.</p>
<p>یک گزینه دیگر این است که cancelOrder() (لغو سفارش) تا زمان آزاد شدن lock (قفل) block (مسدود) شود. یک مزیت استفاده از semantic locks (قفل‌های معنایی) این است که آنها اساساً isolation (انزوا) ارائه شده توسط ACID transactions (تراکنش‌های اتمی) را بازآفرینی می‌کنند. Sagas (حماسه‌هایی) که همان record (رکورد) را به‌روزرسانی می‌کنند، serialized (سریالی) هستند، که تلاش برنامه‌نویسی را به میزان قابل توجهی کاهش می‌دهد. مزیت دیگر این است که آنها بار retry (تلاش مجدد) را از client (مشتری) حذف می‌کنند. drawback (نقص) این است که application (برنامه) باید locks (قفل‌ها) را مدیریت کند. همچنین باید یک الگوریتم تشخیص deadlock (بن‌بست) را پیاده‌سازی کند که rollback (بازگشت) یک saga (حماسه) را برای شکستن یک deadlock (بن‌بست) و اجرای مجدد آن انجام می‌دهد.</p>
<p>COUNTERMEASURE: COMMUTATIVE UPDATES (اقدام متقابل: به‌روزرسانی‌های جابجایی)</p>
<p>یکی از countermeasures (اقدامات متقابل) ساده، طراحی operations (عملیات‌های) به‌روزرسانی برای commutative (جابجایی) بودن است. operations (عملیات‌ها) در صورت اجرا به هر ترتیبی commutative (جابجایی) هستند. عملیات debit() (بدهی) و credit() (اعتبار) یک Account (حساب) commutative (جابجایی) هستند (اگر از overdraft (اضافه‌برداشت) چشم‌پوشی کنید). این countermeasure (اقدام متقابل) مفید است زیرا lost updates (به‌روزرسانی‌های از دست رفته) را حذف می‌کند.</p>
<p>به عنوان مثال، سناریویی را در نظر بگیرید که در آن یک saga (حماسه) نیاز به بازگشت بعد از اینکه یک compensatable transaction (تراکنش قابل جبران) یک حساب را debited (بدهکار) (یا credited (بستانکار)) کرده است. compensating transaction (تراکنش جبرانی) می‌تواند به سادگی حساب را credit (بستانکار) (یا debit (بدهکار)) کند تا به‌روزرسانی را undo (واگردانی) کند. هیچ امکانی برای overwriting (بازنویسی) به‌روزرسانی‌های انجام شده توسط سایر sagas (حماسه‌ها) وجود ندارد.</p>
<p>COUNTERMEASURE: PESSIMISTIC VIEW (اقدام متقابل: دیدگاه بدبینانه)</p>
<p>راه دیگری برای handling (مدیریت) فقدان isolation (انزوا) countermeasure (اقدام متقابل) pessimistic view (دیدگاه بدبینانه) است. این steps (مراحل) یک saga (حماسه) را reorders (تغییر ترتیب) می‌دهد تا ریسک business (تجاری) را به دلیل یک dirty read (خواندن کثیف) به حداقل برساند. به عنوان مثال، سناریویی را در نظر بگیرید که قبلاً برای توصیف anomaly (ناهنجاری) dirty read (خواندن کثیف) استفاده شد. در آن سناریو، Create Order Saga (حماسه ایجاد سفارش) یک dirty read (خواندن کثیف) از اعتبار موجود انجام داد و یک</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0160_original/original_page.png" alt="Original Page 160">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Handling the lack of isolation (مدیریت فقدان انزوا)</strong></h3>
<p>order (سفارشی) که از credit limit (محدودیت اعتباری) مصرف‌کننده فراتر رفت. برای کاهش ریسک وقوع این اتفاق، این countermeasure (اقدام متقابل) Cancel Order Saga (حماسه لغو سفارش) را reorder (تغییر ترتیب) می‌دهد:</p>
<ol>
<li>Order Service (سرویس سفارش) - تغییر state (وضعیت) Order (سفارش) به cancelled (لغو شده).</li>
<li>Delivery Service (سرویس تحویل) - لغو تحویل.</li>
<li>Customer Service (سرویس مشتری) - افزایش available credit (اعتبار موجود).</li>
</ol>
<p>در این نسخه reordered (تغییر ترتیب داده شده) از saga (حماسه)، available credit (اعتبار موجود) در یک retriable transaction (تراکنش قابل تلاش مجدد) افزایش می‌یابد، که احتمال dirty read (خواندن کثیف) را از بین می‌برد.</p>
<p>COUNTERMEASURE: REREAD VALUE (اقدام متقابل: مقدار دوباره خوانده شده)</p>
<p>The reread value countermeasure (اقدام متقابل مقدار دوباره خوانده شده) از lost updates (به‌روزرسانی‌های از دست رفته) جلوگیری می‌کند. یک saga (حماسه) که از این countermeasure (اقدام متقابل) استفاده می‌کند، یک record (رکورد) را قبل از به‌روزرسانی، دوباره می‌خواند، تأیید می‌کند که بدون تغییر است، و سپس record (رکورد) را به‌روزرسانی می‌کند. اگر record (رکورد) تغییر کرده باشد، saga (حماسه) aborts (متوقف می‌شود) و احتمالاً restart (راه‌اندازی مجدد) می‌شود. این countermeasure (اقدام متقابل) شکلی از pattern (الگوی) Optimistic Offline Lock (قفل آفلاین خوشبینانه) است (https://martinfowler .com/eaaCatalog/optimisticOfflineLock.html).</p>
<p>Create Order Saga (حماسه ایجاد سفارش) می‌تواند از این countermeasure (اقدام متقابل) برای handling (مدیریت) سناریویی استفاده کند که در آن Order (سفارش) در حین approved (تایید) شدن لغو می‌شود. transaction (تراکنشی) که Order (سفارش) را تأیید می‌کند، تأیید می‌کند که Order (سفارش) از زمانی که در اوایل saga (حماسه) ایجاد شده، بدون تغییر باقی مانده است. اگر بدون تغییر باقی مانده باشد، transaction (تراکنش) Order (سفارش) را تأیید می‌کند. اما اگر Order (سفارش) لغو شده باشد، transaction (تراکنش) saga (حماسه) را aborts (متوقف) می‌کند، که باعث می‌شود compensating transactions (تراکنش‌های جبرانی) آن اجرا شوند.</p>
<p>COUNTERMEASURE: VERSION FILE (اقدام متقابل: فایل نسخه)</p>
<p>The version file countermeasure (اقدام متقابل فایل نسخه) به این نام نامگذاری شده است زیرا عملیاتی را که بر روی یک record (رکورد) انجام می‌شود، ثبت می‌کند تا بتواند آنها را reorder (تغییر ترتیب) دهد. این یک راه برای تبدیل عملیات non-commutative (غیر جابجایی) به عملیات commutative (جابجایی) است. برای دیدن نحوه عملکرد این countermeasure (اقدام متقابل)، سناریویی را در نظر بگیرید که در آن Create Order Saga (حماسه ایجاد سفارش) به طور همزمان با یک Cancel Order Saga (حماسه لغو سفارش) اجرا می‌شود. اگر sagas (حماسه‌ها) از semantic lock countermeasure (اقدام متقابل قفل معنایی) استفاده نکنند، این امکان وجود دارد که Cancel Order Saga (حماسه لغو سفارش) authorization (مجوز) credit card (کارت اعتباری) مصرف‌کننده را قبل از اینکه Create Order Saga (حماسه ایجاد سفارش) کارت را authorize (مجوز) کند، لغو کند.</p>
<p>یک راه برای Accounting Service (سرویس حسابداری) برای handling (مدیریت) این requests (درخواست‌های) out-of-order (خارج از ترتیب) این است که operations (عملیات‌ها) را به محض رسیدن ثبت کند و سپس آنها را به ترتیب صحیح اجرا کند. در این سناریو، ابتدا request (درخواست) Cancel Authorization (لغو مجوز) را ثبت می‌کند. سپس، هنگامی که Accounting Service (سرویس حسابداری) request (درخواست) Authorize Card (مجوز کارت) را دریافت می‌کند، متوجه می‌شود که قبلاً request (درخواست) Cancel Authorization (لغو مجوز) را دریافت کرده است و از authorization (مجوز) credit card (کارت اعتباری) صرف نظر می‌کند.</p>
<p>COUNTERMEASURE: BY VALUE (اقدام متقابل: با مقدار)</p>
<p>countermeasure (اقدام متقابل) نهایی، by value countermeasure (اقدام متقابل با مقدار) است. این یک strategy (استراتژی) برای انتخاب مکانیسم‌های concurrency (همزمانی) بر اساس ریسک business (تجاری) است. یک application (برنامه) که از این countermeasure (اقدام متقابل) استفاده می‌کند، از ویژگی‌های هر request (درخواست) برای تصمیم‌گیری بین استفاده از sagas (حماسه‌ها) و distributed transactions (تراکنش‌های توزیع شده) استفاده می‌کند. درخواست‌های کم‌خطر را با استفاده از sagas (حماسه‌ها) اجرا می‌کند، شاید با اعمال countermeasures (اقدامات متقابل) شرح داده شده در بخش قبل. اما درخواست‌های پرخطر، که به عنوان مثال، شامل مقادیر زیادی پول می‌شود، با استفاده از distributed transactions (تراکنش‌های توزیع شده) اجرا می‌شود.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0161_original/original_page.png" alt="Original Page 161">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<p>این strategy (استراتژی) یک application (برنامه) را قادر می‌سازد تا به طور پویا در مورد ریسک business (تجاری)، availability (دسترسی‌پذیری) و scalability (مقیاس‌پذیری) trade-offs (تبادل) انجام دهد.</p>
<p>احتمالاً هنگام پیاده‌سازی sagas (حماسه‌ها) در application (برنامه) خود، به استفاده از یک یا چند مورد از این countermeasures (اقدامات متقابل) نیاز خواهید داشت. بیایید نگاهی به طراحی و پیاده‌سازی با جزئیات Create Order Saga (حماسه ایجاد سفارش) بیندازیم که از semantic lock countermeasure (اقدام متقابل قفل معنایی) استفاده می‌کند.</p>
<h4><strong>4.4 The design of the Order Service (طراحی Order Service) و the Create Order Saga (حماسه ایجاد سفارش)</strong></h4>
<p>اکنون که به مسائل مختلف طراحی و پیاده‌سازی saga (حماسه) نگاهی انداختیم، بیایید یک مثال را ببینیم. شکل 4.9 طراحی Order Service (سرویس سفارش) را نشان می‌دهد. business logic (منطق تجاری) service (سرویس) شامل کلاس‌های business logic (منطق تجاری) سنتی است، مانند Order Service (سرویس سفارش) و Order (سفارش)</p>
<br/>
<p>Deﬁnes (تعریف می‌کند) the Restaurant Order (سفارش رستوران)</p>
<p>Service’s (سرویس) messaging API (رابط برنامه‌نویسی پیام‌رسانی)</p>
<p>Sends commands (ارسال دستورات) to (به)</p>
<p>saga participants (شرکت‌کنندگان حماسه)</p>
<p>Orchestrator (ارکستراتور) for the (برای) the</p>
<p>Create Order Saga (حماسه ایجاد سفارش)</p>
<p>Processes replies (پردازش پاسخ‌ها) from (از)</p>
<p>saga participants (شرکت‌کنندگان حماسه)</p>
<p>Handles commands (مدیریت دستورات) sent by the the (ارسال شده توسط)</p>
<p>Create Order Saga (حماسه ایجاد سفارش) to the (به) Order Service (سرویس سفارش)</p>
<p>OrderServiceRequests (درخواست‌های سرویس سفارش)</p>
<p>AccountingServiceRequests (درخواست‌های سرویس حسابداری)</p>
<p>ConsumerServiceRequests (درخواست‌های سرویس مصرف‌کننده)</p>
<p>KitchenServiceRequests (درخواست‌های سرویس آشپزخانه)</p>
<p>createOrder() (ایجاد سفارش)</p>
<p>cancelOrder() (لغو سفارش)</p>
<p>... (و...)</p>
<p>Order Service (سرویس سفارش)</p>
<p>controller (کنترل‌کننده)</p>
<p>Order (سفارش)</p>
<p>command (دستور)</p>
<p>handlers (هندلرها)</p>
<p>Command (دستور)</p>
<p>message (پیام)</p>
<p>publisher (ناشر)</p>
<p>CreateOrderSagaReplies (پاسخ‌های حماسه ایجاد سفارش)</p>
<p>Reply (پاسخ)</p>
<p>consumer (مصرف‌کننده)</p>
<p>OrderService (سرویس سفارش)</p>
<p>CreateOrder (ایجاد سفارش)</p>
<p>Saga (حماسه)</p>
<p>OrderService (سرویس سفارش)</p>
<p>Proxy (پراکسی)</p>
<p>KitchenService (سرویس آشپزخانه)</p>
<p>Proxy (پراکسی)</p>
<p>Order (سفارش)</p>
<p>createOrder() (ایجاد سفارش)</p>
<p>cancelOrder() (لغو سفارش)</p>
<p>approveOrder() (تایید سفارش)</p>
<p>rejectOrder() (رد سفارش)</p>
<p>... (و...)</p>
<p>OrderRepository (مخزن سفارش)</p>
<p>save() (ذخیره)</p>
<p>ﬁndById() (پیدا کردن با شناسه)</p>
<br/>
<p>... (و...)</p>
<br/>
<img alt="Figure 4.9" src="figure_4_9.png"/>
<p>The design of the Order Service (طراحی Order Service (سرویس سفارش)) و its (و حماسه‌های آن) sagas (حماسه‌ها)</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0162_original/original_page.png" alt="Original Page 162">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>The design of the Order Service (طراحی Order Service) و the Create Order Saga (حماسه ایجاد سفارش)</strong></h3>
<p>entity (موجودیت). همچنین کلاس‌های saga orchestrator (ارکستراتور حماسه) وجود دارد، از جمله کلاس CreateOrderSaga، که Create Order Saga (حماسه ایجاد سفارش) را orchestrates (ارکستر) می‌کند. همچنین، از آنجایی که Order Service (سرویس سفارش) در sagas (حماسه‌های) خود شرکت می‌کند، یک کلاس آداپتور OrderCommandHandlers دارد که command messages (پیام‌های دستور) را با فراخوانی OrderService (سرویس سفارش) مدیریت می‌کند.</p>
<p>برخی از قسمت‌های Order Service (سرویس سفارش) باید آشنا به نظر برسند. همانطور که در یک application (برنامه) سنتی، هسته business logic (منطق تجاری) توسط کلاس‌های OrderService (سرویس سفارش)، Order (سفارش) و Order-Repository (مخزن سفارش) پیاده‌سازی می‌شود. در این فصل، من به طور خلاصه این کلاس‌ها را شرح می‌دهم. من آنها را با جزئیات بیشتر در فصل 5 شرح می‌دهم.</p>
<p>آنچه در مورد Order Service (سرویس سفارش) کمتر آشنا است، کلاس‌های مرتبط با saga (حماسه) است. این service (سرویس) هم یک saga orchestrator (ارکستراتور حماسه) و هم یک participant (شرکت‌کننده) saga (حماسه) است. Order Service (سرویس سفارش) دارای چندین saga orchestrators (ارکستراتور حماسه) است، مانند CreateOrderSaga (حماسه ایجاد سفارش). the saga orchestrators (ارکستراتورهای حماسه) command messages (پیام‌های دستور) را به یک participant (شرکت‌کننده) saga (حماسه) با استفاده از یک کلاس proxy (پراکسی) participant (شرکت‌کننده) saga (حماسه)، مانند KitchenServiceProxy (پراکسی سرویس آشپزخانه) و OrderServiceProxy (پراکسی سرویس سفارش)، ارسال می‌کنند. یک proxy (پراکسی) participant (شرکت‌کننده) saga (حماسه) API (رابط برنامه‌نویسی) messaging (پیام‌رسانی) یک participant (شرکت‌کننده) saga (حماسه) را تعریف می‌کند. Order Service (سرویس سفارش) همچنین یک کلاس OrderCommandHandlers دارد، که command messages (پیام‌های دستور) ارسال شده توسط sagas (حماسه‌ها) به Order Service (سرویس سفارش) را مدیریت می‌کند.</p>
<p>بیایید با جزئیات بیشتر به طراحی، با کلاس OrderService شروع کنیم.</p>
<h4><strong>4.4.1 The OrderService class (کلاس OrderService)</strong></h4>
<p>کلاس OrderService یک service (سرویس) domain (دامنه) است که توسط لایه API (رابط برنامه‌نویسی) service (سرویس) فراخوانی می‌شود. این مسئولیت ایجاد و مدیریت orders (سفارش‌ها) را بر عهده دارد. شکل 4.10 OrderService (سرویس سفارش) و برخی از collaborators (همکاران) آن را نشان می‌دهد. OrderService (سرویس سفارش) Orders (سفارش‌ها) را ایجاد و به‌روزرسانی می‌کند، OrderRepository (مخزن سفارش) را برای persist (پایدار) کردن Orders (سفارش‌ها) فراخوانی می‌کند، و sagas (حماسه‌ها) را ایجاد می‌کند، مانند CreateOrderSaga (حماسه ایجاد سفارش)، با استفاده از SagaManager (مدیر حماسه). کلاس SagaManager (مدیر حماسه) یکی از کلاس‌های ارائه شده توسط Eventuate Tram Saga framework (فریم‌ورک حماسه Eventuate Tram) است، که یک فریم‌ورک برای نوشتن saga orchestrators (ارکستراتورهای حماسه) و participants (شرکت‌کنندگان) است، و کمی بعدتر در این بخش مورد بحث قرار می‌گیرد.</p>
<br/>
<p>createOrder() (ایجاد سفارش)</p>
<p>... (و...)</p>
<p>OrderService (سرویس سفارش)</p>
<p>save() (ذخیره)</p>
<p>ﬁndOne() (پیدا کردن یکی)</p>
<p>... (و...)</p>
<p>OrderRepository (مخزن سفارش)</p>
<p>create(..) (ایجاد)</p>
<p>SagaManager (مدیر حماسه)</p>
<p>Order (سفارش)</p>
<p>CreateOrder (ایجاد سفارش)</p>
<p>Saga (حماسه)</p>
<br/>
<img alt="Figure 4.10" src="figure_4_10.png"/>
<p>OrderService (سرویس سفارش) Orders (سفارش‌ها) را ایجاد و به‌روزرسانی می‌کند، OrderRepository (مخزن سفارش) را برای persist (پایدار) کردن Orders (سفارش‌ها) فراخوانی می‌کند، و sagas (حماسه‌ها) را ایجاد می‌کند، از جمله CreateOrderSaga (حماسه ایجاد سفارش).</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0163_original/original_page.png" alt="Original Page 163">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<p>من در مورد این کلاس با جزئیات بیشتر در فصل 5 بحث خواهم کرد. در حال حاضر، بیایید روی متد createOrder() تمرکز کنیم. فهرست زیر، متد createOrder() از OrderService را نشان می‌دهد. این متد ابتدا یک Order (سفارش) ایجاد می‌کند و سپس یک CreateOrderSaga (حماسه ایجاد سفارش) برای validate (اعتبارسنجی) order (سفارش) ایجاد می‌کند.</p>
<pre><code class="language-java">@Transactional
 public class OrderService {
  @Autowired
  private SagaManager&lt;CreateOrderSagaState&gt; createOrderSagaManager;
  @Autowired
  private OrderRepository orderRepository;
  @Autowired
  private DomainEventPublisher eventPublisher;
  public Order createOrder(OrderDetails orderDetails) {
  ...
  ResultWithEvents&lt;Order&gt; orderAndEvents = Order.createOrder(...);
  Order order = orderAndEvents.result;
  orderRepository.save(order);
  eventPublisher.publish(Order.class,
  Long.toString(order.getId()),
  orderAndEvents.events);
  CreateOrderSagaState data =
  new CreateOrderSagaState(order.getId(), orderDetails);
  
  createOrderSagaManager.create(data, Order.class, order.getId());
  return order;
  }
  ...
 }
</code></pre>
<p>متد createOrder() (ایجاد سفارش) یک Order (سفارش) را با فراخوانی متد factory (کارخانه) Order.createOrder() ایجاد می‌کند. سپس Order (سفارش) را با استفاده از OrderRepository (مخزن سفارش) که یک repository (مخزن) مبتنی بر JPA است، persist (پایدار) می‌کند. این CreateOrderSaga (حماسه ایجاد سفارش) را با فراخوانی SagaManager.create() (مدیر حماسه.ایجاد) ایجاد می‌کند، که یک CreateOrderSagaState (حالت حماسه ایجاد سفارش) حاوی ID (شناسه) Order (سفارش) تازه ذخیره شده و OrderDetails (جزئیات سفارش) را منتقل می‌کند. SagaManager (مدیر حماسه)، saga orchestrator (ارکستراتور حماسه) را نمونه‌سازی می‌کند، که باعث می‌شود یک command message (پیام دستور) به اولین participant (شرکت‌کننده) saga (حماسه) ارسال کند، و the saga orchestra-tor (ارکستراتور حماسه) را در database (پایگاه داده) persist (پایدار) می‌کند.</p>
<p>بیایید با جزئیات بیشتر به CreateOrderSaga (حماسه ایجاد سفارش) و کلاس‌های مرتبط با آن نگاهی بیندازیم.</p>
<p>Listing (فهرست) 4.1</p>
<p>The OrderService (کلاس OrderService) و متد createOrder() (ایجاد سفارش) آن</p>
<br/>
<p>Ensure (اطمینان حاصل کنید) that (که) service (سرویس)</p>
<p>methods (متدها) are transactional (تراکنشی) هستند.</p>
<p>Create (ایجاد) the (the)</p>
<p>Order (سفارش).</p>
<p>Persist (پایدار کنید) the (the)</p>
<p>Order (سفارش) in the (در) database (پایگاه داده).</p>
<p>Publish (انتشار) domain (دامنه)</p>
<p>events (رویدادها).</p>
<p>Create (ایجاد) a (یک)</p>
<p>CreateOrderSaga (حماسه ایجاد سفارش).</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0164_original/original_page.png" alt="Original Page 164">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>The design of the Order Service (طراحی Order Service) و the Create Order Saga (حماسه ایجاد سفارش)</strong></h3>
<h4><strong>4.4.2 The implementation of the Create Order Saga (پیاده‌سازی Create Order Saga (حماسه ایجاد سفارش))</strong></h4>
<p>شکل 4.11 کلاس‌هایی را نشان می‌دهد که Create Order Saga (حماسه ایجاد سفارش) را پیاده‌سازی می‌کنند. مسئولیت‌های هر کلاس به شرح زیر است:</p>
<ul>
<li>CreateOrderSaga (حماسه ایجاد سفارش) - یک کلاس singleton (تک‌نمونه) که state machine (ماشین حالت) saga (حماسه) را تعریف می‌کند. این CreateOrderSagaState (حالت حماسه ایجاد سفارش) را برای ایجاد command messages (پیام‌های دستور) فراخوانی می‌کند و آنها را با استفاده از کانال‌های message (پیام‌رسانی) که توسط کلاس‌های proxy (پراکسی) participant (شرکت‌کننده) saga (حماسه)، مانند KitchenServiceProxy (پراکسی سرویس آشپزخانه) مشخص شده‌اند، به participants (شرکت‌کنندگان) ارسال می‌کند.</li>
</ul>
<br/>
<p>Eventuate tram sagas (حماسه‌های ترام Eventuate)</p>
<p>create() (ایجاد)</p>
<p>... (و...)</p>
<p>SagaManager (مدیر حماسه)</p>
<p>«interface (رابط)»</p>
<p>SimpleSaga (حماسه ساده)</p>
<p>SagaDeﬁnition (تعریف حماسه)</p>
<p>CommandEndpoint (endpoint دستور)</p>
<p>SagaDeﬁnition (تعریف حماسه)</p>
<p>getSagaDeﬁnition() (دریافت تعریف حماسه)</p>
<p>«table (جدول)»</p>
<p>SAGA_INSTANCE (نمونه حماسه)</p>
<p>Eventuate tram (ترام Eventuate)</p>
<p>Uses (استفاده می‌کند)</p>
<p>Implements (پیاده‌سازی می‌کند)</p>
<p>Creates (ایجاد می‌کند)</p>
<p>Manages (مدیریت می‌کند)</p>
<p>Invokes (فراخوانی می‌کند)</p>
<p>Order (سفارش) database (پایگاه داده)</p>
<p>CreateOrderSaga (حماسه ایجاد سفارش)</p>
<p>replies (پاسخ‌ها)</p>
<p>OrderService (سرویس سفارش)</p>
<p>requests (درخواست‌ها)</p>
<p>Stores (ذخیره می‌کند) the (the) state (حالت)</p>
<p>of saga instances (نمونه‌های حماسه)</p>
<p>The state of a saga (حالت یک حماسه)</p>
<p>Describes a (توضیح می‌دهد)</p>
<p>message channel (کانال پیام‌رسانی)</p>
<p>Describes the (توضیح می‌دهد) the</p>
<p>steps (مراحل) of a saga (حماسه)</p>
<p>Abstract superclass (کلاس والد انتزاعی)</p>
<p>for saga (برای حماسه)</p>
<p>orchestrators (ارکستراتورها)</p>
<p>orderId (شناسه سفارش)</p>
<p>orderDetails (جزئیات سفارش)</p>
<p>... (و...)</p>
<p>CreateOrder (ایجاد سفارش)</p>
<p>SagaState (حالت حماسه)</p>
<p>CreateOrder (ایجاد سفارش)</p>
<p>Saga (حماسه)</p>
<p>Kitchen (آشپزخانه)</p>
<p>ServiceProxy (پراکسی سرویس)</p>
<p>this.sagaDeﬁnition= (این.تعریف حماسه =)</p>
<p>step() (مرحله)</p>
<p>.withCompensation(...) (.باجبران(...))</p>
<p>.step() (مرحله)</p>
<p>.invokeParticipant(...) (.فراخوانی شرکت کننده(...))</p>
<p>.step() (مرحله)</p>
<p>.invokeParticipant(...) (.فراخوانی شرکت کننده(...))</p>
<p>.onReply(...) (.در پاسخ(...))</p>
<p>.withCompensation(...) (.باجبران(...))</p>
<p>OrderService (سرویس سفارش)</p>
<p>Proxy (پراکسی)</p>
<p>OrderService (سرویس سفارش)</p>
<p>The SagaManager (مدیر حماسه) handles (مدیریت می‌کند) persisting (پایدار کردن) a saga (حماسه), (,) (,) (,) sending (ارسال) the command messages (پیام‌های دستور) that (که) it (آن) generates (ایجاد می‌کند)، subscribing (اشتراک) to reply messages (پیام‌های پاسخ)، (,) (,) (,) and (و) invoking (فراخوانی) the saga (حماسه) to handle (مدیریت کردن) replies (پاسخ‌ها).</p>
<br/>
<img alt="Figure 4.11" src="figure_4_11.png"/>
<p>The OrderService's sagas (حماسه‌های سرویس سفارش)، such as Create Order Saga (مانند حماسه ایجاد سفارش)، are implemented (پیاده‌سازی شده) using (با استفاده از)</p>
<p>the Eventuate Tram Saga framework (فریم‌ورک حماسه Eventuate Tram).</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0165_original/original_page.png" alt="Original Page 165">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<ul>
<li>CreateOrderSagaState (حالت حماسه ایجاد سفارش) - state (حالت) پایدار یک saga (حماسه)، که command messages (پیام‌های دستور) را ایجاد می‌کند.</li>
<li>Saga participant proxy classes (کلاس‌های پراکسی شرکت‌کننده saga)، مانند KitchenServiceProxy (پراکسی سرویس آشپزخانه) - هر کلاس proxy (پراکسی) API (رابط برنامه‌نویسی) messaging (پیام‌رسانی) یک participant (شرکت‌کننده) saga (حماسه) را تعریف می‌کند، که شامل command channel (کانال دستور)، انواع command message (پیام دستور) و انواع reply (پاسخ) است.</li>
</ul>
<p>این کلاس‌ها با استفاده از Eventuate Tram Saga framework (فریم‌ورک حماسه Eventuate Tram) نوشته شده‌اند.</p>
<p>The Eventuate Tram Saga framework (فریم‌ورک حماسه Eventuate Tram) یک domain-specific language (DSL) (زبان مخصوص دامنه) برای تعریف state machine (ماشین حالت) یک saga (حماسه) ارائه می‌دهد. این state machine (ماشین حالت) saga (حماسه) را اجرا می‌کند و با استفاده از Eventuate Tram framework (فریم‌ورک Eventuate Tram) با saga participants (شرکت‌کنندگان حماسه) پیام‌ها را تبادل می‌کند. این فریم‌ورک همچنین state (حالت) saga (حماسه) را در database (پایگاه داده) ذخیره می‌کند.</p>
<p>بیایید نگاهی دقیق‌تر به پیاده‌سازی Create Order Saga (حماسه ایجاد سفارش) بیندازیم، با کلاس CreateOrderSaga شروع می‌کنیم.</p>
<p>THE CREATEORDERSAGA ORCHESTRATOR (ارکستراتور CREATEORDERSAGA)</p>
<p>کلاس CreateOrderSaga state machine (ماشین حالت) را که قبلاً در شکل 4.7 نشان داده شد، پیاده‌سازی می‌کند. این کلاس SimpleSaga را پیاده‌سازی می‌کند، که یک base interface (رابط پایه) برای sagas (حماسه‌ها) است. قلب کلاس CreateOrderSaga تعریف saga (حماسه) است که در فهرست زیر نشان داده شده است. این از DSL (زبان مخصوص دامنه) ارائه شده توسط Eventuate Tram Saga framework (فریم‌ورک حماسه Eventuate Tram) برای تعریف مراحل Create Order Saga (حماسه ایجاد سفارش) استفاده می‌کند.</p>
<pre><code class="language-java">public class CreateOrderSaga implements SimpleSaga&lt;CreateOrderSagaState&gt; {
 private SagaDefinition&lt;CreateOrderSagaState&gt; sagaDefinition;
 public CreateOrderSaga(OrderServiceProxy orderService,
 ConsumerServiceProxy consumerService,
 KitchenServiceProxy kitchenService,
 AccountingServiceProxy accountingService) {
  this.sagaDefinition =
  step()
  .withCompensation(orderService.reject,
  CreateOrderSagaState::makeRejectOrderCommand)
  .step()
  .invokeParticipant(consumerService.validateOrder,
  CreateOrderSagaState::makeValidateOrderByConsumerCommand)
  .step()
  .invokeParticipant(kitchenService.create,
  CreateOrderSagaState::makeCreateTicketCommand)
  .onReply(CreateTicketReply.class,
  CreateOrderSagaState::handleCreateTicketReply)
  .withCompensation(kitchenService.cancel,
  CreateOrderSagaState::makeCancelCreateTicketCommand)
  .step()
  .invokeParticipant(accountingService.authorize,
  CreateOrderSagaState::makeAuthorizeCommand)
  .step()
  .invokeParticipant(kitchenService.confirmCreate,
  CreateOrderSagaState::makeConfirmCreateTicketCommand)
 </code></pre>
<p>Listing (فهرست) 4.2</p>
<p>The definition (تعریف) of the CreateOrderSaga (حماسه ایجاد سفارش)</p>
<br/>
<p>Ensure (اطمینان حاصل کنید) that (که) service (سرویس)</p>
<p>methods (متدها) are transactional (تراکنشی) هستند.</p>
<p>Create (ایجاد) the (the)</p>
<p>Order (سفارش).</p>
<p>Persist (پایدار کنید) the (the)</p>
<p>Order (سفارش) in the (در) database (پایگاه داده).</p>
<p>Publish (انتشار) domain (دامنه)</p>
<p>events (رویدادها).</p>
<p>Create (ایجاد) a (یک)</p>
<p>CreateOrderSaga (حماسه ایجاد سفارش).</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0166_original/original_page.png" alt="Original Page 166">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>The design of the Order Service (طراحی Order Service) و the Create Order Saga (حماسه ایجاد سفارش)</strong></h3>
<p>.step() (مرحله)</p>
<p>.invokeParticipant(orderService.approve, (فراخوانی شرکت‌کننده orderService.approve)،</p>
<p>CreateOrderSagaState::makeApproveOrderCommand) (CreateOrderSagaState::makeApproveOrderCommand) (ایجاد دستور تایید سفارش)</p>
<p>.build(); (ساخت)</p>
<p>}</p>
<p>@Override</p>
<p>public SagaDefinition&lt;CreateOrderSagaState&gt; getSagaDefinition() { (دریافت تعریف saga (حماسه))</p>
<p>return sagaDefinition; (بازگشت تعریف saga (حماسه))</p>
<p>}</p>
<p>The CreateOrderSaga’s (سازنده CreateOrderSaga) constructor (سازنده) the saga definition (تعریف saga (حماسه)) را ایجاد می‌کند و آن را در فیلد sagaDefinition (تعریف حماسه) ذخیره می‌کند. متد getSagaDefinition() (دریافت تعریف حماسه) تعریف saga (حماسه) را بازمی‌گرداند.</p>
<p>برای دیدن نحوه عملکرد CreateOrderSaga (حماسه ایجاد سفارش)، بیایید به تعریف گام سوم saga (حماسه) نگاهی بیندازیم که در فهرست زیر نشان داده شده است. این گام از saga (حماسه)، Kitchen Service (سرویس آشپزخانه) را برای ایجاد یک Ticket (بلیت) فراخوانی می‌کند. compensating transaction (تراکنش جبرانی) آن، Ticket (بلیت) را لغو می‌کند. متدهای step() (مرحله)، invokeParticipant() (فراخوانی شرکت‌کننده)، onReply() (در پاسخ) و withCompensation() (.باجبران) بخشی از DSL (زبان مخصوص دامنه) ارائه شده توسط Eventuate Tram Saga (فریم‌ورک حماسه Eventuate Tram) هستند.</p>
<pre><code class="language-java">public class CreateOrderSaga ...
 public CreateOrderSaga(..., KitchenServiceProxy kitchenService,
 ...) {
  ...
  .step()
  .invokeParticipant(kitchenService.create,
  CreateOrderSagaState::makeCreateTicketCommand)
  .onReply(CreateTicketReply.class,
  CreateOrderSagaState::handleCreateTicketReply)
  .withCompensation(kitchenService.cancel,
  
  CreateOrderSagaState::makeCancelCreateTicketCommand)
  ...
 ;
</code></pre>
<p>The call to invokeParticipant() (فراخوانی شرکت‌کننده) forward transaction (تراکنش به جلو) را تعریف می‌کند. این با فراخوانی CreateOrderSagaState.makeCreateTicket- Command() (ایجاد دستور CreateTicket) پیام command (دستور) Create-Ticket را ایجاد می‌کند و آن را به کانال مشخص شده توسط kitchenService.create (kitchenService.create) ارسال می‌کند. فراخوانی onReply() (در پاسخ) مشخص می‌کند که CreateOrderSagaState.handleCreateTicketReply() (CreateOrderSagaState.handleCreateTicketReply) باید هنگامی که یک reply (پاسخ) موفقیت‌آمیز از Kitchen Service (سرویس آشپزخانه) دریافت شد، فراخوانی شود. این متد ticketId (شناسه بلیت) بازگردانده شده را در CreateOrderSagaState (حالت حماسه) ذخیره می‌کند. فراخوانی withCompensation() (.باجبران) compensating transaction (تراکنش جبرانی) را تعریف می‌کند. این یک message (پیام) command (دستور) RejectTicket-Command (رد بلیت) را با فراخوانی CreateOrderSagaState.makeCancelCreate-Ticket() (ایجاد دستور لغو بلیت) ایجاد می‌کند و آن را به کانال مشخص شده توسط kitchenService.create (kitchenService.create) ارسال می‌کند.</p>
<p>The other steps (سایر مراحل) of the saga (حماسه) are defined (تعریف شده‌اند) in a similar fashion (به روشی مشابه). The CreateOrder-SagaState (حالت حماسه ایجاد سفارش) creates (ایجاد می‌کند) each message (هر پیام)، which is sent by the saga (حماسه) to the messaging endpoint (به endpoint پیام‌رسانی)</p>
<p>Listing (فهرست) 4.3</p>
<p>The definition (تعریف) of the third step (مرحله سوم) of the saga (حماسه)</p>
<br/>
<p>Define (تعریف) the forward (به جلو)</p>
<p>transaction (تراکنش).</p>
<p>Call (فراخوانی) handleCreateTicketReply() (handleCreateTicketReply) when (هنگامی که)</p>
<p>a successful reply (یک پاسخ موفقیت‌آمیز) is received (دریافت شد).</p>
<p>Define (تعریف) the compensating (جبرانی)</p>
<p>transaction (تراکنش).</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0167_original/original_page.png" alt="Original Page 167">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<p>defined (تعریف شده) by a KitchenServiceProxy (توسط پراکسی سرویس آشپزخانه). بیایید نگاهی به هر یک از آن کلاس‌ها، با CreateOrderSagaState (حالت حماسه ایجاد سفارش) شروع کنیم.</p>
<p>THE CREATEORDERSAGASTATE CLASS (کلاس CREATEORDERSAGASTATE)</p>
<p>کلاس CreateOrderSagaState، که در فهرست زیر نشان داده شده است، state (حالت) یک نمونه saga (حماسه) را نشان می‌دهد. یک نمونه از این کلاس توسط OrderService (سرویس سفارش) ایجاد می‌شود و در database (پایگاه داده) توسط Eventuate Tram Saga framework (فریم‌ورک حماسه Eventuate Tram) ذخیره می‌شود. مسئولیت اصلی آن ایجاد messages (پیام‌هایی) است که به saga participants (شرکت‌کنندگان حماسه) ارسال می‌شود.</p>
<pre><code class="language-java">public class CreateOrderSagaState {
 private Long orderId;
 private OrderDetails orderDetails;
 private long ticketId;
 public Long getOrderId() {
  return orderId;
 }
 private CreateOrderSagaState() {
 }
 public CreateOrderSagaState(Long orderId, OrderDetails orderDetails) {
  this.orderId = orderId;
  this.orderDetails = orderDetails;
 }
 CreateTicket makeCreateTicketCommand() {
  return new CreateTicket(getOrderDetails().getRestaurantId(),
  getOrderId(), makeTicketDetails(getOrderDetails()));
 }
 void handleCreateTicketReply(CreateTicketReply reply) {
  logger.debug("getTicketId {}", reply.getTicketId());
  setTicketId(reply.getTicketId());
 }
 CancelCreateTicket makeCancelCreateTicketCommand() {
  
  return new CancelCreateTicket(getOrderId());
 }
 ...
</code></pre>
<p>CreateOrderSaga (حماسه ایجاد سفارش) CreateOrderSagaState (حالت حماسه) را برای ایجاد command messages (پیام‌های دستور) فراخوانی می‌کند. این messages (پیام‌های) command (دستور) را به endpoints (نقاط پایانی) تعریف شده توسط کلاس‌های Saga-ParticipantProxy (پراکسی شرکت‌کننده حماسه) ارسال می‌کند. بیایید نگاهی به یکی از این کلاس‌ها بیندازیم: KitchenService-Proxy (پراکسی سرویس آشپزخانه).</p>
<p>Listing (فهرست) 4.4</p>
<p>CreateOrderSagaState (حالت حماسه ایجاد سفارش) state (حالت) یک نمونه saga (حماسه) را ذخیره می‌کند</p>
<br/>
<p>Invoked by (فراخوانی شده توسط) the (the)</p>
<p>OrderService (سرویس سفارش) to (به)</p>
<p>instantiate (نمونه‌سازی) a (یک)</p>
<p>CreateOrderSagaState (حالت حماسه ایجاد سفارش)</p>
<p>Creates (ایجاد می‌کند) a (یک) CreateTicket (دستور ایجاد بلیت)</p>
<p>command message (پیام دستور)</p>
<p>Saves (ذخیره می‌کند) the (the) ID (شناسه)</p>
<p>of the (از) newly (تازه)</p>
<p>created (ایجاد شده) Ticket (بلیت)</p>
<p>Creates (ایجاد می‌کند)</p>
<p>CancelCreateTicket (لغو ایجاد بلیت)</p>
<p>command message (پیام دستور)</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0168_original/original_page.png" alt="Original Page 168">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>The design of the Order Service (طراحی Order Service) و the Create Order Saga (حماسه ایجاد سفارش)</strong></h3>
<p>THE KITCHENSERVICEPROXY CLASS (کلاس KITCHENSERVICEPROXY)</p>
<p>کلاس KitchenServiceProxy، که در listing (فهرست) 4.5 نشان داده شده است، command message (پیام دستور) endpoints (نقاط پایانی) را برای Kitchen Service (سرویس آشپزخانه) تعریف می‌کند. سه endpoint (نقطه پایانی) وجود دارد:</p>
<ul>
<li>create (ایجاد) - یک Ticket (بلیت) ایجاد می‌کند</li>
<li>confirmCreate (تایید ایجاد) - ایجاد را تأیید می‌کند</li>
<li>cancel (لغو) - یک Ticket (بلیت) را لغو می‌کند</li>
</ul>
<p>هر CommandEndpoint (endpoint دستور) نوع command (دستور)، destination channel (کانال مقصد) پیام command (دستور)، و انواع reply (پاسخ) مورد انتظار را مشخص می‌کند.</p>
<pre><code class="language-java">public class KitchenServiceProxy {
 public final CommandEndpoint&lt;CreateTicket&gt; create =
 CommandEndpointBuilder
 .forCommand(CreateTicket.class)
 .withChannel(
  KitchenServiceChannels.kitchenServiceChannel)
  .withReply(CreateTicketReply.class)
  .build();
 public final CommandEndpoint&lt;ConfirmCreateTicket&gt; confirmCreate =
  CommandEndpointBuilder
  .forCommand(ConfirmCreateTicket.class)
  .withChannel(
  KitchenServiceChannels.kitchenServiceChannel)
  .withReply(Success.class)
  .build();
 public final CommandEndpoint&lt;CancelCreateTicket&gt; cancel =
  CommandEndpointBuilder
  .forCommand(CancelCreateTicket.class)
  .withChannel(
  KitchenServiceChannels.kitchenServiceChannel)
  .withReply(Success.class)
  .build();
}
</code></pre>
<p>Proxy classes (کلاس‌های پراکسی)، مانند KitchenServiceProxy (پراکسی سرویس آشپزخانه)، دقیقاً ضروری نیستند. یک saga (حماسه) می‌تواند به سادگی command messages (پیام‌های دستور) را مستقیماً به participants (شرکت‌کنندگان) ارسال کند. اما proxy classes (کلاس‌های پراکسی) دو مزیت مهم دارند. اول، یک کلاس proxy (پراکسی) static typed endpoints (نقاط پایانی تایپ شده استاتیک) را تعریف می‌کند، که شانس ارسال message (پیام) اشتباه توسط saga (حماسه) به یک service (سرویس) را کاهش می‌دهد. دوم، یک کلاس proxy (پراکسی) یک API (رابط برنامه‌نویسی) well-defined (به خوبی تعریف شده) برای فراخوانی یک service (سرویس) است که کد را آسان‌تر می‌کند و برای تست (آزمایش) نیز راحت‌تر است. به عنوان مثال، فصل 10 نحوه نوشتن tests (تست‌ها) برای KitchenServiceProxy (پراکسی سرویس آشپزخانه) را شرح می‌دهد که تأیید می‌کند Order Service (سرویس سفارش) Kitchen Service (سرویس آشپزخانه) را به درستی فراخوانی می‌کند. بدون KitchenServiceProxy (پراکسی سرویس آشپزخانه)، نوشتن چنین تست (آزمایش) با scope (دامنه) محدود غیرممکن خواهد بود.</p>
<p>Listing (فهرست) 4.5</p>
<p>KitchenServiceProxy (پراکسی سرویس آشپزخانه) command message (پیام دستور) endpoints (نقاط پایانی) را برای Kitchen Service (سرویس آشپزخانه) تعریف می‌کند</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0169_original/original_page.png" alt="Original Page 169">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<p>THE EVENTUATE TRAM SAGA FRAMEWORK (فریم‌ورک حماسه Eventuate Tram)</p>
<p>The Eventuate Tram Saga (حماسه Eventuate Tram)، که در شکل 4.12 نشان داده شده است، یک فریم‌ورک برای نوشتن هم saga orchestrators (ارکستراتورهای حماسه) و هم saga participants (شرکت‌کنندگان حماسه) است. این از قابلیت‌های transactional messaging (پیام‌رسانی تراکنشی) Eventuate Tram، که در فصل 3 مورد بحث قرار گرفت، استفاده می‌کند.</p>
<p>بسته saga orchestration (ارکستراسیون حماسه) پیچیده‌ترین بخش فریم‌ورک است. این SimpleSaga، یک base interface (رابط پایه) برای sagas (حماسه‌ها)، و یک کلاس SagaManager (مدیر حماسه) را ارائه می‌دهد، که نمونه‌های saga (حماسه) را ایجاد و مدیریت می‌کند. The SagaManager (مدیر حماسه) مدیریت ذخیره یک saga (حماسه)، ارسال command messages (پیام‌های دستور) که تولید می‌کند، subscribe (اشتراک) به reply messages (پیام‌های پاسخ)، و فراخوانی saga (حماسه) برای مدیریت پاسخ‌ها را بر عهده دارد. شکل 4.13 توالی events (رویدادها) را زمانی نشان می‌دهد که OrderService (سرویس سفارش) یک saga (حماسه) ایجاد می‌کند. توالی events (رویدادها) به شرح زیر است:</p>
<ol>
<li>OrderService (سرویس سفارش) CreateOrderSagaState (حالت حماسه ایجاد سفارش) را ایجاد می‌کند.</li>
<li>این یک نمونه از یک saga (حماسه) را با فراخوانی SagaManager (مدیر حماسه) ایجاد می‌کند.</li>
<li>The SagaManager (مدیر حماسه) اولین گام از تعریف saga (حماسه) را اجرا می‌کند.</li>
<li>The CreateOrderSagaState (حالت حماسه ایجاد سفارش) برای تولید یک command message (پیام دستور) فراخوانی می‌شود.</li>
</ol>
<br/>
<p>Participant (شرکت‌کننده)</p>
<p>Orchestration (ارکستراسیون)</p>
<p>create(sagaState) (ایجاد(حالت حماسه))</p>
<p>... (و...)</p>
<p>SagaManager (مدیر حماسه)</p>
<p>SimpleSaga (حماسه ساده)</p>
<p>SagaDeﬁnition (تعریف حماسه)</p>
<p>CommandEndpoint (endpoint دستور)</p>
<p>SagaCommand (دستور حماسه)</p>
<p>Dispatcher (توزیع کننده)</p>
<p>SagaCommand (دستور حماسه)</p>
<p>HandlersBuilder (سازنده هندلرها)</p>
<p>SagaDeﬁnition (تعریف حماسه)</p>
<p>getSagaDeﬁnition() (دریافت تعریف حماسه)</p>
<p>«table (جدول)»</p>
<p>SAGA_INSTANCE (نمونه حماسه)</p>
<p>Eventuate tram (ترام Eventuate)</p>
<p>Eventuate tram saga framework (فریم‌ورک حماسه Eventuate Tram)</p>
<p>Uses (استفاده می‌کند)</p>
<p>Sends (ارسال می‌کند)</p>
<p>and receives (و دریافت می‌کند)</p>
<p>Order (سفارش) database (پایگاه داده)</p>
<p>Channels (کانال‌ها)</p>
<p>The SagaManager (مدیر حماسه) handles (مدیریت می‌کند) persisting (پایدار کردن) a (یک) saga (حماسه)، sending (ارسال) the command messages (پیام‌های دستور) that (که) it (آن) generates (ایجاد می‌کند)، subscribing (اشتراک) to reply messages (پیام‌های پاسخ)، (,) (,) (,) and (و) invoking (فراخوانی) the saga (حماسه) to handle (مدیریت) replies (پاسخ‌ها).</p>
<p>Abstract superclass (کلاس والد انتزاعی)</p>
<p>for saga orchestrators (برای ارکستراتورهای حماسه)</p>
<p>Describes a (توضیح می‌دهد) the (the)</p>
<p>message channel (کانال پیام‌رسانی)</p>
<p>Routes command (مسیرهای دستور)</p>
<p>messages (پیام‌ها) to (به)</p>
<p>message handlers (هندلرهای پیام)</p>
<p>Describes the (توضیح می‌دهد) the</p>
<p>steps (مراحل) of a saga (حماسه)</p>
<p>Stores (ذخیره می‌کند) the (the) state (حالت)</p>
<p>of saga instances (نمونه‌های حماسه)</p>
<br/>
<img alt="Figure 4.12" src="figure_4_12.png"/>
<p>Eventuate Tram Saga (حماسه Eventuate Tram) یک فریم‌ورک برای نوشتن هم saga orchestrators (ارکستراتورهای حماسه) و هم saga participants (شرکت‌کنندگان حماسه) است.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0170_original/original_page.png" alt="Original Page 170">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>The design of the Order Service (طراحی Order Service) و the Create Order Saga (حماسه ایجاد سفارش)</strong></h3>
<ol>
<li>The SagaManager (مدیر حماسه) command message (پیام دستور) را به participant (شرکت‌کننده) saga (حماسه) (Consumer Service (سرویس مصرف‌کننده)) ارسال می‌کند.</li>
<li>The SagaManager (مدیر حماسه) نمونه saga (حماسه) را در database (پایگاه داده) ذخیره می‌کند.</li>
</ol>
<p>شکل 4.14 توالی events (رویدادها) را زمانی نشان می‌دهد که SagaManager (مدیر حماسه) یک reply (پاسخ) را از Consumer Service (سرویس مصرف‌کننده) دریافت می‌کند.</p>
<p>توالی events (رویدادها) به شرح زیر است:</p>
<ol>
<li>Eventuate Tram (ترام Eventuate) SagaManager (مدیر حماسه) را با reply (پاسخ) از Consumer Service (سرویس مصرف‌کننده) فراخوانی می‌کند.</li>
<li>SagaManager (مدیر حماسه) نمونه saga (حماسه) را از database (پایگاه داده) بازیابی می‌کند.</li>
<li>SagaManager (مدیر حماسه) گام بعدی تعریف saga (حماسه) را اجرا می‌کند.</li>
</ol>
<br/>
<img alt="Figure 4.13" src="figure_4_13.png"/>
<p>The sequence of events (توالی رویدادها) when (هنگامی که) OrderService (سرویس سفارش) creates (ایجاد می‌کند) an instance (یک نمونه) of Create Order Saga (حماسه ایجاد سفارش)</p>
<br/>
<img alt="Figure 4.14" src="figure_4_14.png"/>
<p>The sequence of events (توالی رویدادها) when (هنگامی که) the (the) SagaManager (مدیر حماسه) receives (دریافت می‌کند) a reply message (یک پیام پاسخ) from (از) a saga participant (یک شرکت‌کننده حماسه)</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0171_original/original_page.png" alt="Original Page 171">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<ol>
<li>CreateOrderSagaState (حالت حماسه ایجاد سفارش) برای تولید یک command message (پیام دستور) فراخوانی می‌شود.</li>
<li>SagaManager (مدیر حماسه) command message (پیام دستور) را به participant (شرکت‌کننده) saga (حماسه) (Kitchen Service (سرویس آشپزخانه)) ارسال می‌کند.</li>
<li>SagaManager (مدیر حماسه) نمونه saga (حماسه) به‌روزرسانی شده را در database (پایگاه داده) ذخیره می‌کند.</li>
</ol>
<p>اگر یک participant (شرکت‌کننده) saga (حماسه) شکست بخورد، SagaManager (مدیر حماسه) compensating transactions (تراکنش‌های جبرانی) را به ترتیب معکوس اجرا می‌کند.</p>
<p>بخش دیگر از Eventuate Tram Saga framework (فریم‌ورک حماسه Eventuate Tram) بسته participant (شرکت‌کننده) saga (حماسه) است. این کلاس‌های SagaCommandHandlersBuilder (سازنده هندلرهای حماسه) و SagaCommandDispatcher (توزیع کننده دستورات حماسه) را برای نوشتن saga participants (شرکت‌کنندگان حماسه) ارائه می‌دهد. این کلاس‌ها command messages (پیام‌های دستور) را به متدهای handler (هندلر) هدایت می‌کنند، که business logic (منطق تجاری) saga participants (شرکت‌کنندگان حماسه) را فراخوانی می‌کنند و reply messages (پیام‌های پاسخ) را تولید می‌کنند. بیایید نگاهی به نحوه استفاده از این کلاس‌ها توسط Order Service (سرویس سفارش) بیندازیم.</p>
<h4><strong>4.4.3 The OrderCommandHandlers class (کلاس OrderCommandHandlers)</strong></h4>
<p>Order Service (سرویس سفارش) در sagas (حماسه‌های) خود شرکت می‌کند. به عنوان مثال، CreateOrderSaga (حماسه ایجاد سفارش) Order Service (سرویس سفارش) را فراخوانی می‌کند تا یک Order (سفارش) را تأیید یا رد کند. کلاس OrderCommandHandlers، که در شکل 4.15 نشان داده شده است، متدهای handler (هندلر) را برای command messages (پیام‌های دستور) ارسال شده توسط این sagas (حماسه‌ها) تعریف می‌کند.</p>
<p>هر متد handler (هندلر) OrderService (سرویس سفارش) را برای به‌روزرسانی یک Order (سفارش) فراخوانی می‌کند و یک message (پیام) reply (پاسخ) ایجاد می‌کند. کلاس SagaCommandDispatcher (توزیع‌کننده دستورات حماسه) command messages (پیام‌های دستور) را به متد handler (هندلر) مناسب هدایت می‌کند و reply (پاسخ) را ارسال می‌کند.</p>
<br/>
<p>approveOrder() (تایید سفارش)</p>
<p>rejectOrder() (رد سفارش)</p>
<p>... (و...)</p>
<p>OrderCommandHandlers (هندلرهای دستورات سفارش)</p>
<br/>
<p>Eventuate</p>
<p>Tram Sagas (حماسه‌های ترام Eventuate)</p>
<br/>
<p>approveOrder() (تایید سفارش)</p>
<p>rejectOrder() (رد سفارش)</p>
<p>... (و...)</p>
<p>OrderService (سرویس سفارش)</p>
<p>Invokes (فراخوانی می‌کند)</p>
<p>Invokes (فراخوانی می‌کند)</p>
<p>Uses (استفاده می‌کند)</p>
<p>Reads (می‌خواند)</p>
<p>Sends (ارسال می‌کند)</p>
<p>SagaCommand (دستور حماسه)</p>
<p>Dispatcher (توزیع‌کننده)</p>
<p>Eventuate tram (ترام Eventuate)</p>
<p>OrderService (سرویس سفارش)</p>
<p>requests (درخواست‌ها)</p>
<p>CreateOrderSaga (حماسه ایجاد سفارش)</p>
<p>replies (پاسخ‌ها)</p>
<p>Routes (مسیردهی) command messages (پیام‌های دستور) to (به)</p>
<p>handlers (هندلرها) and (و) sends (ارسال می‌کند) replies (پاسخ‌ها)</p>
<br/>
<img alt="Figure 4.15" src="figure_4_15.png"/>
<p>OrderCommandHandlers (هندلرهای دستورات سفارش) command handlers (هندلرهای دستور) را برای دستوراتی که توسط sagas (حماسه‌های) مختلف Order Service (سرویس سفارش) ارسال می‌شوند، پیاده‌سازی می‌کند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0172_original/original_page.png" alt="Original Page 172">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>The design of the Order Service (طراحی Order Service) و the Create Order Saga (حماسه ایجاد سفارش)</strong></h3>
<p>فهرست زیر کلاس OrderCommandHandlers را نشان می‌دهد. متد commandHandlers() آن، انواع command message (پیام دستور) را به متدهای handler (هندلر) map (نگاشت) می‌کند. هر متد handler (هندلر) یک command message (پیام دستور) را به عنوان یک پارامتر می‌گیرد، OrderService (سرویس سفارش) را فراخوانی می‌کند و یک message (پیام) reply (پاسخ) را بازمی‌گرداند.</p>
<pre><code class="language-java">public class OrderCommandHandlers {
 @Autowired
 private OrderService orderService;
 public CommandHandlers commandHandlers() {
  
  return SagaCommandHandlersBuilder
  .fromChannel("orderService")
  .onMessage(ApproveOrderCommand.class, this::approveOrder)
  .onMessage(RejectOrderCommand.class, this::rejectOrder)
  ...
  .build();
 }
 public Message approveOrder(CommandMessage&lt;ApproveOrderCommand&gt; cm) {
  long orderId = cm.getCommand().getOrderId();
  orderService.approveOrder(orderId);
  return withSuccess();
 }
 public Message rejectOrder(CommandMessage&lt;RejectOrderCommand&gt; cm) {
  long orderId = cm.getCommand().getOrderId();
  orderService.rejectOrder(orderId);
  return withSuccess();
 }
</code></pre>
<p>متدهای approveOrder() (تایید سفارش) و rejectOrder() (رد سفارش) Order (سفارش) مشخص شده را با فراخوانی OrderService (سرویس سفارش) به‌روزرسانی می‌کنند. سایر services (سرویس‌هایی) که در sagas (حماسه‌ها) شرکت می‌کنند، کلاس‌های handler (هندلر) command (دستور) مشابهی دارند که domain objects (اشیاء دامنه) خود را به‌روزرسانی می‌کنند.</p>
<h4><strong>4.4.4 The OrderServiceConfiguration class (کلاس OrderServiceConfiguration)</strong></h4>
<p>Order Service (سرویس سفارش) از فریم‌ورک Spring (اسپرینگ) استفاده می‌کند. فهرست زیر گزیده‌ای از کلاس OrderServiceConfiguration است، که یک کلاس @Configuration (پیکربندی) است که Spring @Beans (بخش‌های اسپرینگ) را نمونه‌سازی و به هم متصل می‌کند.</p>
<pre><code class="language-java">@Configuration
 public class OrderServiceConfiguration {
  @Bean
  public OrderService orderService(RestaurantRepository restaurantRepository,
 </code></pre>
<p>Listing (فهرست) 4.6</p>
<p>The command handlers (هندلرهای دستور) for Order Service (برای سرویس سفارش)</p>
<br/>
<p>Listing (فهرست) 4.7</p>
<p>The OrderServiceConfiguration (پیکربندی سرویس سفارش) is a Spring @Configuration (کلاس پیکربندی اسپرینگ) (کلاس) that defines (که تعریف می‌کند) the Spring @Beans (بخش‌های اسپرینگ) for the (برای) Order Service (سرویس سفارش).</p>
<p>Route (مسیردهی) each command (هر دستور)</p>
<p>message (پیام) to (به) the appropriate (مناسب)</p>
<p>handler method (متد هندلر).</p>
<p>Change (تغییر) the (the) state (وضعیت)</p>
<p>of the (از) Order (سفارش) to (به)</p>
<p>authorized (مجوز داده شده).</p>
<p>Return (بازگشت) a generic (عمومی)</p>
<p>success message (پیام موفقیت).</p>
<p>Change (تغییر) the (the) state (وضعیت) of (از)</p>
<p>the Order (سفارش) to (به) rejected (رد شده).</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0173_original/original_page.png" alt="Original Page 173">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 4 (فصل 4)</strong></h3>
<h4><strong>Managing transactions (مدیریت تراکنش) با sagas (حماسه‌ها)</strong></h4>
<pre><code class="language-java">...
 SagaManager&lt;CreateOrderSagaState&gt;
 createOrderSagaManager,
 ...) {
  return new OrderService(restaurantRepository,
  ...
  createOrderSagaManager
  ...);
 }
 @Bean
 public SagaManager&lt;CreateOrderSagaState&gt; createOrderSagaManager(CreateOrderSaga saga) {
  return new SagaManagerImpl&lt;&gt;(saga);
 }
 @Bean
 public CreateOrderSaga createOrderSaga(OrderServiceProxy orderService,
  ConsumerServiceProxy consumerService,
  ...) {
  return new CreateOrderSaga(orderService, consumerService, ...);
 }
 @Bean
 public OrderCommandHandlers orderCommandHandlers() {
  return new OrderCommandHandlers();
 }
 @Bean
 public SagaCommandDispatcher
 orderCommandHandlersDispatcher(OrderCommandHandlers orderCommandHandlers) {
  return new SagaCommandDispatcher("orderService", orderCommandHandlers.comma
  ndHandlers());
 }
 @Bean
 public KitchenServiceProxy kitchenServiceProxy() {
  return new KitchenServiceProxy();
 }
 @Bean
 public OrderServiceProxy orderServiceProxy() {
  return new OrderServiceProxy();
 }
 ...
</code></pre>
<p>این کلاس چندین Spring @Beans (بخش‌های اسپرینگ) از جمله orderService (سرویس سفارش)، createOrderSagaManager (مدیر حماسه ایجاد سفارش)، createOrderSaga (ایجاد حماسه ایجاد سفارش)، orderCommandHandlers (هندلرهای دستور سفارش)، و orderCommandHandlersDispatcher (توزیع کننده هندلرهای دستور سفارش) را تعریف می‌کند. همچنین Spring @Beans (بخش‌های اسپرینگ) را برای کلاس‌های proxy (پراکسی) مختلف، از جمله kitchenServiceProxy (پراکسی سرویس آشپزخانه) و orderServiceProxy (پراکسی سرویس سفارش) تعریف می‌کند.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0174_original/original_page.png" alt="Original Page 174">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Summary (خلاصه)</strong></h3>
<p>CreateOrderSaga (حماسه ایجاد سفارش) تنها یکی از sagas (حماسه‌ها) متعدد Order Service (سرویس سفارش) است. بسیاری از سایر operations (عملیات‌های) system (سیستم) آن نیز از sagas (حماسه‌ها) استفاده می‌کنند. به عنوان مثال، operation (عملیات) cancelOrder() (لغو سفارش) از یک Cancel Order Saga (حماسه لغو سفارش) استفاده می‌کند، و operation (عملیات) reviseOrder() (بازبینی سفارش) از یک Revise Order Saga (حماسه بازبینی سفارش) استفاده می‌کند. در نتیجه، حتی اگر بسیاری از services (سرویس‌ها) دارای یک API (رابط برنامه‌نویسی) خارجی هستند که از یک protocol (پروتکل) synchronous (همزمان) مانند REST یا gRPC استفاده می‌کنند، مقدار زیادی از interservice communication (ارتباط بین سرویس‌ها) از asynchronous messaging (پیام‌رسانی ناهمزمان) استفاده می‌کند.</p>
<p>همانطور که می‌بینید، transaction management (مدیریت تراکنش) و برخی از جنبه‌های طراحی business logic (منطق تجاری) در یک microservice (ریز سرویس) architecture (معماری) کاملاً متفاوت است. خوشبختانه، saga orchestrators (ارکستراتورهای حماسه) معمولاً state machines (ماشین‌های حالت) بسیار ساده‌ای هستند، و شما می‌توانید از یک فریم‌ورک saga (حماسه) برای ساده‌سازی کد خود استفاده کنید. با این وجود، transaction management (مدیریت تراکنش) مطمئناً پیچیده‌تر از یک monolithic architecture (معماری یکپارچه) است. اما این معمولاً بهای کمی برای پرداخت برای مزایای عظیم microservices (ریز سرویس‌ها) است.</p>
<p>Summary (خلاصه)</p>
<ul>
<li>برخی از operations (عملیات‌های) system (سیستم) نیاز به به‌روزرسانی داده‌های پراکنده در چندین service (سرویس) دارند. تراکنش‌های سنتی، مبتنی بر XA/2PC (دو فاز کامیت) توزیع شده، برای applications (برنامه‌های) مدرن مناسب نیستند. یک رویکرد بهتر استفاده از الگوی Saga (حماسه) است. یک saga (حماسه) sequence (توالی) local transactions (تراکنش‌های محلی) است که با استفاده از messaging (پیام‌رسانی) هماهنگ می‌شوند. هر local transaction (تراکنش محلی) داده‌ها را در یک service (سرویس) واحد به‌روزرسانی می‌کند. از آنجایی که هر local transaction (تراکنش محلی) تغییرات خود را commit (تعهد) می‌کند، اگر یک saga (حماسه) به دلیل violation (نقض) یک business rule (قاعده تجاری) باید بازگردانده شود، باید compensating transactions (تراکنش‌های جبرانی) را برای undo (واگردانی) صریح تغییرات اجرا کند.</li>
<li>شما می‌توانید از choreography (طراحی رقص) یا orchestration (ارکستراسیون) برای هماهنگ‌سازی مراحل یک saga (حماسه) استفاده کنید. در یک saga (حماسه) مبتنی بر choreography (طراحی رقص)، یک local transaction (تراکنش محلی) events (رویدادهایی) را منتشر می‌کند که سایر participants (شرکت‌کنندگان) را برای اجرای local transactions (تراکنش‌های محلی) trigger (راه‌اندازی) می‌کند. در یک saga (حماسه) مبتنی بر orchestration (ارکستراسیون)، یک saga orchestrator (ارکستراتور حماسه) متمرکز command messages (پیام‌های دستور) را به participants (شرکت‌کنندگان) ارسال می‌کند و به آنها می‌گوید که local transactions (تراکنش‌های محلی) را اجرا کنند. شما می‌توانید توسعه و تست (آزمایش) را با model (مدل‌سازی) saga orchestrators (ارکستراتورهای حماسه) به عنوان state machines (ماشین‌های حالت) ساده کنید. sagas (حماسه‌های) ساده می‌توانند از choreography (طراحی رقص) استفاده کنند، اما orchestration (ارکستراسیون) معمولاً یک رویکرد بهتر برای sagas (حماسه‌های) پیچیده است.</li>
<li>طراحی business logic (منطق تجاری) مبتنی بر saga (حماسه) می‌تواند چالش‌برانگیز باشد زیرا، بر خلاف ACID transactions (تراکنش‌های اتمی)، sagas (حماسه‌ها) از یکدیگر مجزا نیستند. شما اغلب باید از countermeasures (اقدامات متقابل) استفاده کنید، که استراتژی‌های طراحی هستند که از anomalies (ناهنجاری‌های) concurrency (همزمانی) ناشی از model (مدل) ACD transaction (تراکنش اتمی، سازگاری، پایداری) جلوگیری می‌کنند. یک application (برنامه) ممکن است حتی نیاز به استفاده از locking (قفل کردن) داشته باشد تا business logic (منطق تجاری) را ساده کند، حتی اگر این کار خطر deadlocks (بن‌بست‌ها) را داشته باشد.</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0175_original/original_page.png" alt="Original Page 175">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Designing (طراحی)</strong></h3>
<h3><strong>business logic (منطق تجاری) in (در) a microservice architecture (معماری ریز سرویس)</strong></h3>
<p>قلب یک enterprise application (برنامه سازمانی) business logic (منطق تجاری) است، که business rules (قوانین تجاری) را پیاده‌سازی می‌کند. توسعه business logic (منطق تجاری) پیچیده همیشه چالش‌برانگیز است. business logic (منطق تجاری) application (برنامه) FTGO برخی از business logic (منطق تجاری) بسیار پیچیده را پیاده‌سازی می‌کند، به‌ویژه برای مدیریت سفارش و مدیریت تحویل. Mary (مری) تیم خود را تشویق کرده بود تا اصول طراحی object-oriented (شی‌گرا) را اعمال کنند، زیرا از نظر او این بهترین راه برای پیاده‌سازی business logic (منطق تجاری) پیچیده بود. برخی از business logic (منطق تجاری) از الگوی procedural Transcription script (اسکریپت رونویسی رویه‌ای) استفاده می‌کرد. اما اکثریت business logic (منطق تجاری) application (برنامه) FTGO در یک model (مدل) domain (دامنه) object-oriented (شی‌گرا) پیاده‌سازی شده است که با استفاده از JPA به database (پایگاه داده) نگاشت شده است.</p>
<p>توسعه business logic (منطق تجاری) پیچیده، حتی در یک microservice (ریز سرویس) architecture (معماری) که در آن business logic (منطق تجاری) در چندین service (سرویس) پخش شده است، چالش‌برانگیزتر است. شما نیاز دارید به</p>
<p>This chapter (این فصل) covers (شامل می‌شود)</p>
<ul>
<li>Applying (اعمال) the (the) business logic organization patterns (الگوهای سازماندهی منطق تجاری): Transaction script pattern (الگوی اسکریپت تراکنش) و Domain model pattern (الگوی مدل دامنه)</li>
<li>Designing (طراحی) business logic (منطق تجاری) with (با) the Domain-driven design (DDD) aggregate pattern (الگوی تجمیع طراحی مبتنی بر دامنه (DDD))</li>
<li>Applying (اعمال) the Domain event pattern (الگوی رویداد دامنه) in (در) a microservice architecture (معماری ریز سرویس)</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0176_original/original_page.png" alt="Original Page 176">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Business logic organization patterns (الگوهای سازماندهی منطق تجاری)</strong></h3>
<p>دو چالش کلیدی را برطرف می‌کند. اول، یک model (مدل) domain (دامنه) معمولی یک تار درهم از کلاس‌های به هم پیوسته است. اگرچه این در یک monolithic application (برنامه یکپارچه) مشکلی ندارد، اما در یک microservice architecture (معماری ریز سرویس)، که در آن کلاس‌ها در سراسر services (سرویس‌ها) مختلف پراکنده شده‌اند، شما باید ارجاعات object (شی) را که در غیر این صورت مرزهای service (سرویس) را در بر می‌گرفت، حذف کنید. چالش دوم، طراحی business logic (منطق تجاری) است که در محدودیت‌های transaction management (مدیریت تراکنش) یک microservice architecture (معماری ریز سرویس) کار می‌کند. business logic (منطق تجاری) شما می‌تواند از ACID transactions (تراکنش‌های اتمی) در داخل services (سرویس‌ها) استفاده کند، اما همانطور که در فصل 4 توضیح داده شد، باید از الگوی Saga (حماسه) برای حفظ data consistency (سازگاری داده‌ها) در سراسر services (سرویس‌ها) استفاده کند.</p>
<p>خوشبختانه، ما می‌توانیم این مسائل را با استفاده از الگوی Aggregate (تجمیع) از DDD (طراحی مبتنی بر دامنه) برطرف کنیم. الگوی Aggregate (تجمیع)، business logic (منطق تجاری) یک service (سرویس) را به عنوان مجموعه‌ای از aggregates (تجمیع‌ها) ساختار می‌دهد. یک aggregate (تجمیع) یک cluster (خوشه) از objects (اشیاء) است که می‌تواند به عنوان یک واحد در نظر گرفته شود. دو دلیل وجود دارد که چرا aggregates (تجمیع‌ها) هنگام توسعه business logic (منطق تجاری) در یک microservice (ریز سرویس) architecture (معماری) مفید هستند:</p>
<ul>
<li>Aggregates (تجمیع‌ها) از هرگونه امکان ارجاع object (شی) که مرزهای service (سرویس) را در بر می‌گیرد، اجتناب می‌کنند، زیرا یک reference (ارجاع) بین aggregate (تجمیع) یک مقدار primary key (کلید اصلی) است تا یک object reference (ارجاع شی).</li>
<li>از آنجایی که یک transaction (تراکنش) می‌تواند فقط یک aggregate (تجمیع) را ایجاد یا به‌روزرسانی کند، aggregates (تجمیع‌ها) با محدودیت‌های model (مدل) تراکنش microservices (ریز سرویس‌ها) مطابقت دارند.</li>
</ul>
<p>در نتیجه، یک ACID transaction (تراکنش اتمی) تضمین شده است که در یک service (سرویس) واحد قرار دارد.</p>
<p>من این فصل را با توصیف راه‌های مختلف سازماندهی business logic (منطق تجاری) شروع می‌کنم: الگوی Transcription script (اسکریپت رونویسی) و الگوی Domain model (مدل دامنه). در مرحله بعد، مفهوم یک DDD aggregate (تجمیع DDD) را معرفی می‌کنم و توضیح می‌دهم که چرا یک building block (بلوک ساختمانی) خوب برای business logic (منطق تجاری) یک service (سرویس) است. پس از آن، الگوی Domain event (رویداد دامنه) و events (رویدادها) را شرح می‌دهم و توضیح می‌دهم که چرا انتشار events (رویدادها) برای یک service (سرویس) مفید است. من این فصل را با چند نمونه از business logic (منطق تجاری) از Kitchen Service (سرویس آشپزخانه) و Order Service (سرویس سفارش) به پایان می‌رسانم.</p>
<p>بیایید اکنون به الگوهای سازماندهی business logic (منطق تجاری) نگاهی بیندازیم.</p>
<h4><strong>5.1 Business logic organization patterns (الگوهای سازماندهی منطق تجاری)</strong></h4>
<p>شکل 5.1 architecture (معماری) یک service (سرویس) معمولی را نشان می‌دهد. همانطور که در فصل 2 توضیح داده شد، business logic (منطق تجاری) هسته یک hexagonal architecture (معماری شش ضلعی) است. اطراف business logic (منطق تجاری)، inbound (ورودی) و outbound adapters (آداپتورهای خروجی) قرار دارند. یک inbound adapter (آداپتور ورودی)، request (درخواست‌ها) را از clients (مشتریان) مدیریت می‌کند و business logic (منطق تجاری) را فراخوانی می‌کند. یک outbound adapter (آداپتور خروجی)، که توسط business logic (منطق تجاری) فراخوانی می‌شود، سایر services (سرویس‌ها) و applications (برنامه‌ها) را فراخوانی می‌کند.</p>
<p>این service (سرویس) شامل business logic (منطق تجاری) و adapters (آداپتورهای) زیر است:</p>
<ul>
<li>REST API adapter (آداپتور REST API) - یک inbound adapter (آداپتور ورودی) که یک REST API (رابط برنامه‌نویسی) را پیاده‌سازی می‌کند که business logic (منطق تجاری) را فراخوانی می‌کند</li>
<li>OrderCommandHandlers (هندلرهای دستور سفارش) - یک inbound adapter (آداپتور ورودی) که command messages (پیام‌های دستور) را از یک کانال message (پیام‌رسانی) مصرف می‌کند و business logic (منطق تجاری) را فراخوانی می‌کند</li>
<li>Database Adapter (آداپتور پایگاه داده) - یک outbound adapter (آداپتور خروجی) که توسط business logic (منطق تجاری) برای دسترسی به database (پایگاه داده) فراخوانی می‌شود</li>
<li>Domain Event Publishing Adapter (آداپتور انتشار رویداد دامنه) - یک outbound adapter (آداپتور خروجی) که events (رویدادها) را به یک message broker (واسطه پیام) منتشر می‌کند</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0177_original/original_page.png" alt="Original Page 177">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 5 (فصل 5)</strong></h3>
<h3><strong>Designing (طراحی) business logic (منطق تجاری) in (در) a microservice architecture (معماری ریز سرویس)</strong></h3>
<p>business logic (منطق تجاری) معمولاً پیچیده‌ترین بخش service (سرویس) است. هنگام توسعه business logic (منطق تجاری)، شما باید آگاهانه business logic (منطق تجاری) خود را به روشی سازماندهی کنید که برای application (برنامه) شما مناسب‌ترین باشد. به هر حال، من مطمئن هستم که شما ناامیدی ناشی از نگهداری کد بد ساختار یافته شخص دیگری را تجربه کرده‌اید. اکثر enterprise applications (برنامه‌های سازمانی) در یک زبان object-oriented (شی‌گرا) مانند Java (جاوا) نوشته شده‌اند، بنابراین آنها شامل کلاس‌ها و متدها هستند. اما استفاده از یک زبان object-oriented (شی‌گرا) تضمین نمی‌کند که business logic (منطق تجاری) یک design (طراحی) object-oriented (شی‌گرا) داشته باشد. تصمیم کلیدی که شما باید هنگام توسعه business logic (منطق تجاری) بگیرید این است که آیا از رویکرد object-oriented (شی‌گرا) استفاده کنید یا از رویکرد procedural (رویه‌ای). دو الگوی اصلی برای سازماندهی وجود دارد</p>
<br/>
<p>Outbound adapters (آداپتورهای خروجی)</p>
<p>Inbound adapters (آداپتورهای ورودی)</p>
<p>Order (سفارش)</p>
<p>Service (سرویس) requests (درخواست‌ها)</p>
<p>POST/orders (ارسال/سفارش‌ها)</p>
<p>GET/order/Id (دریافت/شناسه سفارش)</p>
<p>REST API (رابط برنامه‌نویسی REST)</p>
<p>Order (سفارش) database (پایگاه داده)</p>
<p>Order (سفارش)</p>
<p>Service (سرویس)</p>
<p>business logic (منطق تجاری)</p>
<p>Order (سفارش)</p>
<p>command (دستور)</p>
<p>handlers (هندلرها)</p>
<p>Order (سفارش) events (رویدادها)</p>
<p>Domain event (رویداد دامنه)</p>
<p>publisher adapter (آداپتور ناشر)</p>
<p>Database (پایگاه داده)</p>
<br/>
<img alt="Figure 5.1" src="figure_5_1.png"/>
<p>The Order Service (سرویس سفارش) has a hexagonal architecture (معماری شش‌ضلعی). It (آن) consists of (شامل می‌شود) the (the) business logic (منطق تجاری)</p>
<p>and (و) one or more adapters (یک یا چند آداپتور) that (که) interface (رابط) with (با) external applications (برنامه‌های خارجی) and (و) other services (سایر سرویس‌ها).</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0178_original/original_page.png" alt="Original Page 178">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Business logic organization patterns (الگوهای سازماندهی منطق تجاری)</strong></h3>
<p>business logic: الگوی procedural Transaction script (اسکریپت تراکنش رویه‌ای) و الگوی object-oriented (شی‌گرا) Domain model (مدل دامنه).</p>
<h4><strong>5.1.1 Designing business logic (طراحی منطق تجاری) using the Transaction script pattern (با استفاده از الگوی اسکریپت تراکنش)</strong></h4>
<p>اگرچه من یک طرفدار سرسخت رویکرد object-oriented (شی‌گرا) هستم، اما در برخی از موقعیت‌ها که business logic (منطق تجاری) ساده‌ای را توسعه می‌دهید، این کار زیاده‌روی است. در چنین شرایطی، یک رویکرد بهتر این است که کد procedural (رویه‌ای) بنویسید و از چیزی استفاده کنید که کتاب Patterns of Enterprise Application Architecture (الگوهای معماری application (برنامه) سازمانی) نوشته Martin Fowler (مارتین فاولر) (Addison-Wesley Professional, 2002) الگوی Transaction script (اسکریپت تراکنش) را می‌نامد. به جای انجام هر گونه طراحی object-oriented (شی‌گرا)، شما یک متد به نام transaction script (اسکریپت تراکنش) می‌نویسید تا هر request (درخواست) از presentation tier (لایه ارائه) را مدیریت کند. همانطور که شکل 5.2 نشان می‌دهد، یک ویژگی مهم این رویکرد این است که کلاس‌هایی که رفتار را پیاده‌سازی می‌کنند از کلاس‌هایی که state (حالت) را ذخیره می‌کنند، جدا هستند.</p>
<p>هنگام استفاده از الگوی Transaction script (اسکریپت تراکنش)، scripts (اسکریپت‌ها) معمولاً در کلاس‌های service (سرویس) قرار دارند، که در این مثال کلاس OrderService است. یک کلاس service (سرویس) دارای یک متد برای هر request (درخواست) / system operation (عملیات سیستم) است. این متد business logic (منطق تجاری) را برای آن request (درخواست) پیاده‌سازی می‌کند. این به database (پایگاه داده) با استفاده از data access objects (DAOs) (اشیاء دسترسی به داده)، مانند OrderDao (OrderDao) دسترسی دارد. data objects (اشیاء داده)، که در این مثال کلاس Order (سفارش) است، داده‌های خالص با رفتار کم یا بدون رفتار هستند.</p>
<p>این سبک از design (طراحی) بسیار procedural (رویه‌ای) است و به قابلیت‌های کمی از زبان‌های object-oriented programming (OOP) (برنامه‌نویسی شی‌گرا) متکی است. این چیزی است که اگر application (برنامه) را در C یا یک زبان غیر OOP (غیر شی‌گرا) دیگر می‌نوشتید، ایجاد می‌کردید. با این وجود، شما نباید</p>
<p>Pattern (الگو): Transaction script (اسکریپت تراکنش)</p>
<p>Organize (سازماندهی) the business logic (منطق تجاری) as a collection of procedural transaction scripts (به عنوان مجموعه‌ای از اسکریپت‌های تراکنش رویه‌ای)، one (یکی) for (برای) each type of request (هر نوع درخواست).</p>
<br/>
<p>createOrder() (ایجاد سفارش)</p>
<p>reviseOrder() (بازبینی سفارش)</p>
<p>cancelOrder() (لغو سفارش)</p>
<p>... (و...)</p>
<p>OrderService (سرویس سفارش)</p>
<p>Classes with (کلاس‌ها با)</p>
<p>behavior (رفتار)</p>
<p>Classes (کلاس‌ها)</p>
<p>with state (با حالت)</p>
<p>save(Order) (ذخیره (سفارش))</p>
<p>ﬁndOrderById() (پیدا کردن سفارش با شناسه)</p>
<p>... (و...)</p>
<p>OrderDao (OrderDao)</p>
<p>orderId (شناسه سفارش)</p>
<p>orderLineItems (آیتم‌های خط سفارش)</p>
<p>... (و...)</p>
<p>Order (سفارش)</p>
<br/>
<img alt="Figure 5.2" src="figure_5_2.png"/>
<p>Organizing business logic (سازماندهی business logic (منطق تجاری)) as (به عنوان) transaction scripts (اسکریپت‌های تراکنش). In (در) a typical (یک معمولی) transaction script (اسکریپت تراکنش)-based design (طراحی مبتنی بر)، one (یک)</p>
<p>set of classes (مجموعه‌ای از کلاس‌ها) implements (پیاده‌سازی می‌کند) behavior (رفتار) and (و) another set (مجموعه دیگری) stores (ذخیره می‌کند) state (حالت). The (the) transaction scripts (اسکریپت‌های تراکنش) are organized into (در) classes (کلاس‌ها) that (که) typically (معمولاً) have no state (هیچ حالتی ندارند). The (the) scripts (اسکریپت‌ها) use data classes (کلاس‌های داده)، which (که) typically (معمولاً) have no behavior (هیچ رفتاری ندارند).</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0179_original/original_page.png" alt="Original Page 179">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 5 (فصل 5)</strong></h3>
<h3><strong>Designing (طراحی) business logic (منطق تجاری) in (در) a microservice architecture (معماری ریز سرویس)</strong></h3>
<p>از استفاده از یک design (طراحی) procedural (رویه‌ای) زمانی که مناسب است، شرمنده نباشید. این رویکرد برای business logic (منطق تجاری) ساده به خوبی کار می‌کند. با این حال، drawback (نقص) این است که این روش تمایل ندارد که یک راه خوب برای پیاده‌سازی business logic (منطق تجاری) پیچیده باشد.</p>
<h4><strong>5.1.2 Designing business logic (طراحی منطق تجاری) using the Domain model pattern (با استفاده از الگوی Domain model)</strong></h4>
<p>سادگی رویکرد procedural (رویه‌ای) می‌تواند بسیار اغواکننده باشد. شما می‌توانید کد را بدون نیاز به در نظر گرفتن دقیق چگونگی سازماندهی کلاس‌ها، بنویسید. مشکل این است که اگر business logic (منطق تجاری) شما پیچیده شود، ممکن است به کدی برسید که نگهداری آن یک کابوس باشد. در واقع، به همان روشی که یک monolithic application (برنامه یکپارچه) عادت دارد که دائماً رشد کند، transaction scripts (اسکریپت‌های تراکنش) نیز همین مشکل را دارند. در نتیجه، مگر اینکه یک application (برنامه) بسیار ساده می‌نویسید، باید در برابر وسوسه نوشتن کد procedural (رویه‌ای) مقاومت کنید و در عوض الگوی Domain model (مدل دامنه) را اعمال کنید و یک design (طراحی) object-oriented (شی‌گرا) را توسعه دهید.</p>
<p>در یک design (طراحی) object-oriented (شی‌گرا)، business logic (منطق تجاری) از یک object model (مدل شی)، یک شبکه از کلاس‌های نسبتاً کوچک تشکیل شده است. این کلاس‌ها معمولاً مستقیماً با مفاهیم domain (دامنه) مشکل مطابقت دارند. در چنین design (طراحی)، برخی از کلاس‌ها فقط state (حالت) یا رفتار دارند، اما بسیاری از آنها هر دو را دارند، که نشانه یک کلاس با design (طراحی) خوب است. شکل 5.3 یک example (نمونه) از الگوی Domain model (مدل دامنه) را نشان می‌دهد.</p>
<p>Pattern (الگو): Domain model (مدل دامنه)</p>
<p>Organize (سازماندهی) the business logic (منطق تجاری) as an object model (به عنوان یک مدل شی) consisting of (شامل) classes (کلاس‌هایی) that (که) have state (حالت) and (و) behavior (رفتار).</p>
<br/>
<p>createOrder() (ایجاد سفارش)</p>
<p>reviseOrder() (بازبینی سفارش)</p>
<p>cancelOrder() (لغو سفارش)</p>
<p>... (و...)</p>
<p>OrderService (سرویس سفارش)</p>
<p>deliveryTime (زمان تحویل)</p>
<p>deliveryAddress (آدرس تحویل)</p>
<p>DeliveryInformation (اطلاعات تحویل)</p>
<p>ﬁndOrderById() (پیدا کردن سفارش با شناسه)</p>
<p>... (و...)</p>
<p>OrderRepository (مخزن سفارش)</p>
<p>Some classes (برخی از کلاس‌ها) have only state (فقط حالت دارند).</p>
<p>Many classes (بسیاری از کلاس‌ها) have (دارند)</p>
<p>state (حالت) and (و) behavior (رفتار).</p>
<p>Uses (استفاده می‌کند)</p>
<p>Some classes (برخی از کلاس‌ها) have only behavior (فقط رفتار دارند).</p>
<p>«private» (خصوصی)</p>
<p>orderId (شناسه سفارش)</p>
<p>orderLineItems (آیتم‌های خط سفارش)</p>
<p>... (و...)</p>
<p>revise() (بازبینی)</p>
<p>cancel() (لغو)</p>
<p>«static» (ایستا)</p>
<p>create() (ایجاد)</p>
<p>Order (سفارش)</p>
<br/>
<img alt="Figure 5.3" src="figure_5_3.png"/>
<p>Organizing business logic (سازماندهی business logic (منطق تجاری)) as (به عنوان) a domain model (یک مدل دامنه). The (the) majority (اکثریت) of (از)</p>
<p>the business logic (منطق تجاری) consists of (شامل می‌شود) classes (کلاس‌هایی) that (که) have (دارند) state (حالت) and (و) behavior (رفتار).</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0180_original/original_page.png" alt="Original Page 180">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Business logic organization patterns (الگوهای سازماندهی منطق تجاری)</strong></h3>
<p>همانند الگوی Transaction script (اسکریپت تراکنش)، یک کلاس OrderService (سرویس سفارش) دارای یک متد برای هر request (درخواست) / system operation (عملیات سیستم) است. اما هنگام استفاده از الگوی Domain model (مدل دامنه)، متدهای service (سرویس) معمولاً ساده هستند. به این دلیل که یک متد service (سرویس) تقریباً همیشه به persistent domain objects (اشیاء دامنه پایدار) واگذار می‌شود، که بخش عمده business logic (منطق تجاری) را در خود دارند. یک متد service (سرویس) ممکن است، به عنوان مثال، یک object (شی) domain (دامنه) را از database (پایگاه داده) بارگیری کند و یکی از متدهای آن را فراخوانی کند. در این مثال، کلاس Order (سفارش) هم state (حالت) و هم رفتار را دارد. علاوه بر این، state (حالت) آن خصوصی است و فقط می‌تواند به طور غیرمستقیم از طریق متدهای آن دسترسی داشته باشد.</p>
<p>استفاده از یک design (طراحی) object-oriented (شی‌گرا) دارای تعدادی مزیت است. اول، design (طراحی) آسان است برای درک و نگهداری. به جای تشکیل یک کلاس بزرگ که همه کارها را انجام می‌دهد، از تعدادی کلاس کوچک تشکیل شده است که هر کدام تعداد کمی مسئولیت دارند. علاوه بر این، کلاس‌هایی مانند Account (حساب)، BankingTransaction (تراکنش بانکی)، و OverdraftPolicy (سیاست اضافه‌برداشت) از دنیای واقعی تقلید می‌کنند، که نقش آنها را در design (طراحی) آسان‌تر می‌کند. دوم، design (طراحی) object-oriented (شی‌گرا) ما آسان‌تر است برای تست (آزمایش): هر کلاس می‌تواند و باید به طور مستقل آزمایش شود. در نهایت، یک design (طراحی) object-oriented (شی‌گرا) آسان‌تر است برای گسترش زیرا می‌تواند از الگوهای طراحی شناخته شده، مانند الگوی Strategy (استراتژی) و الگوی Template method (متد الگو) استفاده کند، که راه‌هایی را برای گسترش یک component (کامپوننت) بدون تغییر کد، تعریف می‌کنند.</p>
<p>الگوی Domain model (مدل دامنه) به خوبی کار می‌کند، اما مشکلاتی با این رویکرد وجود دارد، به ویژه در یک microservice (ریز سرویس) architecture (معماری ریز سرویس). برای رسیدگی به این مشکلات، شما باید از یک refinement (اصلاحیه) از OOD (طراحی شی‌گرا) که به عنوان DDD (طراحی مبتنی بر دامنه) شناخته می‌شود، استفاده کنید.</p>
<h4><strong>5.1.3 About Domain-driven design (درباره طراحی مبتنی بر دامنه)</strong></h4>
<p>DDD، که در کتاب Domain-Driven Design (طراحی مبتنی بر دامنه) توسط Eric Evans (اریک ایوانز) (Addison-Wesley Professional, 2003) شرح داده شده است، یک refinement (اصلاحیه) از OOD (طراحی شی‌گرا) است و یک رویکرد برای توسعه business logic (منطق تجاری) پیچیده است. من DDD را در فصل 2 هنگام بحث در مورد مفید بودن subdomains (زیر دامنه‌ها) DDD هنگام تجزیه یک application (برنامه) به services (سرویس‌ها) معرفی کردم. هنگام استفاده از DDD، هر service (سرویس) model (مدل) domain (دامنه) خود را دارد، که از مشکلات یک model (مدل) domain (دامنه) واحد در سطح application (برنامه) جلوگیری می‌کند. Subdomains (زیر دامنه‌ها) و مفهوم مرتبط Bounded Context (متن محدود) دو مورد از الگوهای استراتژیک DDD (طراحی مبتنی بر دامنه) هستند.</p>
<p>DDD همچنین دارای برخی الگوهای تاکتیکی است که building blocks (بلوک‌های سازنده) برای domain models (مدل‌های دامنه) هستند. هر الگو یک role (نقش) است که یک کلاس در یک model (مدل) domain (دامنه) ایفا می‌کند و ویژگی‌های کلاس را تعریف می‌کند. building blocks (بلوک‌های سازنده) که به طور گسترده توسط توسعه‌دهندگان اتخاذ شده‌اند عبارتند از:</p>
<ul>
<li>Entity (موجودیت) - یک object (شی) که دارای یک persistent identity (هویت پایدار) است. دو entity (موجودیت) که ویژگی‌های آنها مقادیر یکسانی دارند، همچنان objects (اشیاء) متفاوتی هستند. در یک application (برنامه) Java EE، کلاس‌هایی که با استفاده از JPA @Entity (JPA موجودیت) ذخیره می‌شوند، معمولاً entities (موجودیت‌های) DDD هستند.</li>
<li>Value object (شیء ارزشی) - یک object (شی) که مجموعه‌ای از مقادیر است. دو value objects (شیءهای ارزشی) که ویژگی‌های آنها مقادیر یکسانی دارند، می‌توانند به جای یکدیگر استفاده شوند. یک example (نمونه) از یک value object (شیء ارزشی) یک کلاس Money (پول) است، که شامل یک currency (ارز) و یک amount (مقدار) است.</li>
<li>Factory (کارخانه) - یک object (شی) یا متدی که منطق ایجاد object (شی) را پیاده‌سازی می‌کند که برای انجام مستقیم توسط یک constructor (سازنده) بسیار پیچیده است. همچنین می‌تواند concrete (محسوس) را پنهان کند</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0181_original/original_page.png" alt="Original Page 181">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 5 (فصل 5)</strong></h3>
<h3><strong>Designing (طراحی) business logic (منطق تجاری) in (در) a microservice architecture (معماری ریز سرویس)</strong></h3>
<p>classes (کلاس‌هایی) که نمونه‌سازی می‌شوند. یک factory (کارخانه) ممکن است به عنوان یک متد static (ایستا) از یک کلاس پیاده‌سازی شود.</p>
<ul>
<li>Repository (مخزن) - یک object (شی) که دسترسی به persistent entities (موجودیت‌های پایدار) را فراهم می‌کند و مکانیسم دسترسی به database (پایگاه داده) را محصور می‌کند.</li>
<li>Service (سرویس) - یک object (شی) که business logic (منطق تجاری) را پیاده‌سازی می‌کند که به یک entity (موجودیت) یا یک value object (شیء ارزشی) تعلق ندارد.</li>
</ul>
<p>این building blocks (بلوک‌های سازنده) توسط بسیاری از توسعه‌دهندگان استفاده می‌شوند. برخی از آنها توسط frameworks (فریم‌ورک‌ها) مانند JPA و فریم‌ورک Spring (اسپرینگ) پشتیبانی می‌شوند. یک building block (بلوک سازنده) دیگر وجود دارد که به طور کلی نادیده گرفته شده است (از جمله خودم!) به جز متخصصان DDD (طراحی مبتنی بر دامنه): aggregates (تجمیع‌ها). همانطور که معلوم می‌شود، aggregates (تجمیع‌ها) یک مفهوم بسیار مفید هنگام توسعه microservices (ریز سرویس‌ها) هستند. ابتدا به برخی از مشکلات ظریف با OOD (طراحی شی‌گرا) کلاسیک نگاهی می‌اندازیم که با استفاده از aggregates (تجمیع‌ها) حل می‌شوند.</p>
<h4><strong>5.2 Designing a domain model (طراحی یک مدل دامنه) using the (با استفاده از) DDD aggregate pattern (الگوی تجمیع DDD)</strong></h4>
<p>در design (طراحی) object-oriented (شی‌گرا) سنتی، یک model (مدل) domain (دامنه) مجموعه‌ای از کلاس‌ها و روابط بین کلاس‌ها است. کلاس‌ها معمولاً در بسته‌ها سازماندهی می‌شوند. به عنوان مثال، شکل 5.4 بخشی از یک model (مدل) domain (دامنه) را برای application (برنامه) FTGO نشان می‌دهد. این یک model (مدل) domain (دامنه) معمولی است که از یک web (وب) از کلاس‌های به هم پیوسته تشکیل شده است.</p>
<p>این example (نمونه) دارای چندین کلاس مربوط به business objects (اشیاء تجاری) است: Consumer (مصرف‌کننده)، Order (سفارش)، Restaurant (رستوران)، و Courier (پیک). اما جالب اینجاست که مرزهای صریح هر business object (شیء تجاری) از این نوع model (مدل) domain (دامنه) سنتی حذف شده‌اند. این مشخص نمی‌کند، برای</p>
<br/>
<p>Consumer (مصرف‌کننده)</p>
<p>Order (سفارش)</p>
<p>state (وضعیت)</p>
<p>... (و...)</p>
<p>creditcardId (شناسه کارت اعتباری)</p>
<p>... (و...)</p>
<p>deliveryTime (زمان تحویل)</p>
<p>quantity (تعداد)</p>
<p>name (نام)</p>
<p>price (قیمت)</p>
<p>street1 (خیابان 1)</p>
<p>street2 (خیابان 2)</p>
<p>city (شهر)</p>
<p>state (استان)</p>
<p>zip (کد پستی)</p>
<p>name (نام)</p>
<p>... (و...)</p>
<p>available (موجود)</p>
<p>... (و...)</p>
<p>lat (عرض جغرافیایی)</p>
<p>lon (طول جغرافیایی)</p>
<p>Restaurant (رستوران)</p>
<p>Courier (پیک)</p>
<p>Location (موقعیت)</p>
<p>PaymentInfo (اطلاعات پرداخت)</p>
<p>DeliveryInfo (اطلاعات تحویل)</p>
<p>OrderLineItem (آیتم خط سفارش)</p>
<p>MenuItem (آیتم منو)</p>
<p>Address (آدرس)</p>
<p>Placed by (توسط)</p>
<p>For (برای)</p>
<p>Assigned to (اختصاص داده شده به)</p>
<p>Paid using (پرداخت شده با استفاده از)</p>
<p>Pays using (پرداخت با استفاده از)</p>
<br/>
<img alt="Figure 5.4" src="figure_5_4.png"/>
<p>A traditional domain model (یک مدل دامنه سنتی) is a web (یک وب) of interconnected classes (کلاس‌های به هم پیوسته). It (آن) doesn’t explicitly specify (مشخص نمی‌کند) the (the) boundaries (مرزها) of business objects (اشیاء تجاری)، such as (مانند) Consumer (مصرف‌کننده) and (و) Order (سفارش).</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0182_original/original_page.png" alt="Original Page 182">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Designing a domain model (طراحی یک مدل دامنه) using the (با استفاده از) the DDD aggregate pattern (الگوی تجمیع DDD)</strong></h3>
<p>example (مثال)، کدام کلاس‌ها بخشی از business object (شیء تجاری) Order (سفارش) هستند. این فقدان مرزها گاهی اوقات می‌تواند مشکل‌ساز شود، به‌ویژه در microservice architecture (معماری ریز سرویس).</p>
<p>من این بخش را با یک مشکل example (مثال) ناشی از فقدان مرزهای صریح شروع می‌کنم. در مرحله بعد، مفهوم یک aggregate (تجمیع) و اینکه چگونه مرزهای صریح دارد را شرح می‌دهم. پس از آن، قوانین را شرح می‌دهم که aggregates (تجمیع‌ها) باید از آنها اطاعت کنند و چگونه آنها را برای microservice architecture (معماری ریز سرویس) مناسب می‌سازند. سپس، من چگونگی انتخاب دقیق مرزهای aggregates (تجمیع‌ها) و دلیل اهمیت آن را شرح می‌دهم. در نهایت، من در مورد چگونگی طراحی business logic (منطق تجاری) با استفاده از aggregates (تجمیع‌ها) بحث می‌کنم. ابتدا بیایید نگاهی به مشکلات ناشی از مرزهای fuzzy (فازی) بیندازیم.</p>
<h4><strong>5.2.1 The problem with fuzzy boundaries (مشکل با مرزهای فازی)</strong></h4>
<p>به عنوان مثال، تصور کنید که می‌خواهید یک operation (عملیات) را انجام دهید، مانند load (بارگذاری) یا delete (حذف)، روی یک business object (شیء تجاری) Order (سفارش). این دقیقاً به چه معناست؟ دامنه یک operation (عملیات) چیست؟ شما مطمئناً object (شیء) Order (سفارش) را بارگذاری یا حذف می‌کنید. اما در واقعیت، چیزی بیش از صرفاً object (شیء) Order (سفارش) وجود دارد. همچنین آیتم‌های خط سفارش، اطلاعات پرداخت و غیره وجود دارد. شکل 5.4 مرزهای یک domain object (شیء دامنه) را به شهود developer (توسعه‌دهنده) واگذار می‌کند.</p>
<p>علاوه بر یک conceptual fuzziness (ابهام مفهومی)، فقدان مرزهای صریح باعث ایجاد مشکلاتی هنگام به‌روزرسانی یک business object (شیء تجاری) می‌شود. یک business object (شیء تجاری) معمولی دارای invariants (نامتغیرها) است، business rules (قوانین تجاری) که باید همیشه اعمال شوند. به عنوان مثال، یک Order (سفارش) دارای حداقل مقدار سفارش است. application (برنامه) FTGO باید اطمینان حاصل کند که هر تلاشی برای به‌روزرسانی یک order (سفارش) یک invariant (نامتغیر) مانند حداقل مقدار سفارش را نقض نمی‌کند. چالش این است که برای اعمال invariants (نامتغیرها)، شما باید business logic (منطق تجاری) خود را با دقت طراحی کنید.</p>
<p>به عنوان مثال، بیایید نگاهی بیندازیم که چگونه از رعایت حداقل سفارش اطمینان حاصل کنیم وقتی چندین consumers (مصرف‌کننده) با هم برای ایجاد یک order (سفارش) کار می‌کنند. دو consumers (مصرف‌کننده) - Sam (سم) و Mary (مری) - با هم روی یک order (سفارش) کار می‌کنند و همزمان تصمیم می‌گیرند که order (سفارش) از بودجه آنها فراتر رفته است. Sam (سم) مقدار samosas (سمبوسه) را کاهش می‌دهد، و Mary (مری) مقدار naan bread (نان) را کاهش می‌دهد. از دیدگاه application (برنامه)، هر دو consumers (مصرف‌کننده) order (سفارش) و آیتم‌های خط آن را از database (پایگاه داده) بازیابی می‌کنند. سپس هر دو consumers (مصرف‌کننده) یک آیتم خط را برای کاهش هزینه order (سفارش) به‌روزرسانی می‌کنند. از دیدگاه هر consumer (مصرف‌کننده)، حداقل order (سفارش) حفظ می‌شود.</p>
<p>در اینجا توالی database transactions (تراکنش‌های پایگاه داده) آمده است.</p>
<br/>
<p>Consumer - Mary (مصرف‌کننده - مری)</p>
<p>Consumer - Sam (مصرف‌کننده - سم)</p>
<br/>
<p>BEGIN TXN (شروع تراکنش)</p>
<p>SELECT ORDER_TOTAL FROM ORDER (انتخاب مجموع سفارش از سفارش)</p>
<p>WHERE ORDER ID = X (جایی که شناسه سفارش = X)</p>
<p>SELECT * FROM ORDER_LINE_ITEM (انتخاب * از آیتم خط سفارش)</p>
<p>WHERE ORDER_ID = X (جایی که شناسه سفارش = X)</p>
<p>... (و...)</p>
<p>END TXN (پایان تراکنش)</p>
<p>BEGIN TXN (شروع تراکنش)</p>
<p>SELECT ORDER_TOTAL FROM ORDER (انتخاب مجموع سفارش از سفارش)</p>
<p>WHERE ORDER ID = X (جایی که شناسه سفارش = X)</p>
<p>SELECT * FROM ORDER_LINE_ITEM (انتخاب * از آیتم خط سفارش)</p>
<p>WHERE ORDER_ID = X (جایی که شناسه سفارش = X)</p>
<p>... (و...)</p>
<p>END TXN (پایان تراکنش)</p>
<p>Verify minimum is met (تایید حداقل رعایت شده است)</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0183_original/original_page.png" alt="Original Page 183">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 5 (فصل 5)</strong></h3>
<h3><strong>Designing (طراحی) business logic (منطق تجاری) in (در) a microservice architecture (معماری ریز سرویس)</strong></h3>
<p>هر مصرف‌کننده یک آیتم خط را با استفاده از یک sequence (توالی) از دو transaction (تراکنش) تغییر می‌دهد. اولین transaction (تراکنش) order (سفارش) و آیتم‌های خط آن را بارگذاری می‌کند. UI (رابط کاربری) تأیید می‌کند که order minimum (حداقل سفارش) رعایت شده است قبل از اجرای transaction (تراکنش) دوم. transaction (تراکنش) دوم، مقدار آیتم خط را با استفاده از یک check (بررسی) optimistic offline locking (قفل آفلاین خوشبینانه) به‌روزرسانی می‌کند که تأیید می‌کند خط order (سفارش) از زمانی که توسط اولین transaction (تراکنش) بارگذاری شده است، بدون تغییر باقی مانده است.</p>
<p>در این سناریو، Sam (سم) کل order (سفارش) را به میزان $X (ایکس) و Mary (مری) آن را به میزان $Y (ایگرگ) کاهش می‌دهد. در نتیجه، Order (سفارش) دیگر valid (معتبر) نیست، حتی اگر application (برنامه) تأیید کند که order (سفارش) هنوز order minimum (حداقل سفارش) را پس از به‌روزرسانی‌های هر consumer (مصرف‌کننده) برآورده کرده است. همانطور که می‌بینید، به‌روزرسانی مستقیم بخشی از یک business object (شیء تجاری) می‌تواند منجر به نقض business rules (قوانین تجاری) شود. DDD aggregates (تجمیع‌های DDD) برای حل این مشکل در نظر گرفته شده‌اند.</p>
<h4><strong>5.2.2 Aggregates have explicit boundaries (Aggregates (تجمیع‌ها) دارای مرزهای صریح هستند)</strong></h4>
<p>یک aggregate (تجمیع) یک cluster (خوشه) از domain objects (اشیاء دامنه) در یک boundary (مرز) است که می‌تواند به عنوان یک واحد در نظر گرفته شود. این شامل یک root entity (موجودیت ریشه) و احتمالاً یک یا چند entities (موجودیت‌های) دیگر و value objects (اشیاء ارزشی) است. بسیاری از business objects (اشیاء تجاری) به عنوان aggregates (تجمیع‌ها) مدل‌سازی می‌شوند. به عنوان مثال، در فصل 2 ما با تجزیه و تحلیل اسم‌های استفاده شده در requirements (نیازمندی‌ها) و توسط domain experts (متخصصان دامنه)، یک model (مدل) domain (دامنه) تقریبی ایجاد کردیم. بسیاری از این اسم‌ها، مانند Order (سفارش)، Consumer (مصرف‌کننده) و Restaurant (رستوران)، aggregates (تجمیع‌ها) هستند.</p>
<p>شکل 5.5 aggregate (تجمیع) Order (سفارش) و boundary (مرز) آن را نشان می‌دهد. یک aggregate (تجمیع) Order (سفارش) شامل یک entity (موجودیت) Order (سفارش)، یک یا چند value objects (شیءهای ارزشی) OrderLineItem (آیتم خط سفارش)، و سایر value objects (شیءهای ارزشی) مانند Address (آدرس) و PaymentInformation (اطلاعات پرداخت) است.</p>
<br/>
<p>BEGIN TXN (شروع تراکنش)</p>
<p>UPDATE ORDER_LINE_ITEM (به‌روزرسانی آیتم خط سفارش)</p>
<p>SET VERSION=..., QUANTITY=... (تنظیم نسخه = ...، مقدار =...)</p>
<p>WHERE VERSION = &lt;loaded version&gt; (جایی که نسخه = نسخه بارگذاری شده)</p>
<p>AND ID = ... (و شناسه = ...)</p>
<p>END TXN (پایان تراکنش)</p>
<br/>
<p>Verify minimum is met (تایید حداقل رعایت شده است)</p>
<br/>
<p>BEGIN TXN (شروع تراکنش)</p>
<p>UPDATE ORDER_LINE_ITEM (به‌روزرسانی آیتم خط سفارش)</p>
<p>SET VERSION=..., QUANTITY=... (تنظیم نسخه = ...، مقدار =...)</p>
<p>WHERE VERSION = &lt;loaded version&gt; (جایی که نسخه = نسخه بارگذاری شده)</p>
<p>AND ID = ... (و شناسه = ...)</p>
<p>END TXN (پایان تراکنش)</p>
<br/>
<p>Pattern (الگو): Aggregate (تجمیع)</p>
<p>Organize (سازماندهی) a domain model (یک مدل دامنه) as (به عنوان) a collection of aggregates (مجموعه‌ای از تجمیع‌ها)، each of which (که هر کدام) is a graph (یک نمودار) of</p>
<p>objects (اشیاء) that (که) can be treated as a unit (می‌تواند به عنوان یک واحد در نظر گرفته شود).</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0184_original/original_page.png" alt="Original Page 184">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Designing a domain model (طراحی یک مدل دامنه) using the (با استفاده از) the DDD aggregate pattern (الگوی تجمیع DDD)</strong></h3>
<p>Aggregates (تجمیع‌ها) یک model (مدل) domain (دامنه) را به قطعاتی تجزیه می‌کنند که به‌طور جداگانه درک آنها آسان‌تر است. آنها همچنین scope (دامنه) operations (عملیات‌هایی) مانند load (بارگذاری)، update (به‌روزرسانی) و delete (حذف) را روشن می‌کنند. این operations (عملیات‌ها) بر روی کل aggregate (تجمیع) عمل می‌کنند نه بر روی بخش‌هایی از آن. یک aggregate (تجمیع) اغلب به طور کامل از database (پایگاه داده) بارگذاری می‌شود، در نتیجه از هر گونه پیچیدگی lazy loading (بارگذاری تنبل) جلوگیری می‌شود. حذف یک aggregate (تجمیع) تمام objects (اشیاء) آن را از یک database (پایگاه داده) حذف می‌کند.</p>
<p>AGGREGATES ARE CONSISTENCY BOUNDARIES (Aggregates (تجمیع‌ها) مرزهای سازگاری هستند)</p>
<p>به‌روزرسانی یک aggregate (تجمیع) کامل به‌جای بخش‌های آن، مسائل مربوط به consistency (سازگاری) را حل می‌کند، مانند example (مثال) شرح داده شده قبلی. عملیات به‌روزرسانی بر روی aggregate root (ریشه تجمیع) فراخوانی می‌شوند، که invariants (نامتغیرها) را اعمال می‌کند. همچنین، concurrency (همزمانی) با locking (قفل کردن) aggregate root (ریشه تجمیع) با استفاده از، به عنوان مثال، یک شماره version (نسخه) یا یک database (پایگاه داده) سطح قفل، مدیریت می‌شود. به عنوان مثال، به جای به‌روزرسانی مستقیم مقادیر آیتم‌های خط، یک client (مشتری) باید یک متد را روی ریشه aggregate (تجمیع) Order (سفارش) فراخوانی کند، که invariants (نامتغیرها) مانند حداقل مقدار سفارش را اعمال می‌کند. با این حال، توجه داشته باشید که این رویکرد نیازی به به‌روزرسانی کل aggregate (تجمیع) در database (پایگاه داده) ندارد. به عنوان مثال، یک application (برنامه) ممکن است فقط سطرهای مربوط به object (شیء) Order (سفارش) و OrderLineItem (آیتم خط سفارش) به‌روزرسانی شده را به‌روزرسانی کند.</p>
<p>IDENTIFYING AGGREGATES IS KEY (شناسایی aggregates (تجمیع‌ها) کلیدی است)</p>
<p>در DDD (طراحی مبتنی بر دامنه)، یک بخش کلیدی از طراحی یک model (مدل) domain (دامنه)، شناسایی aggregates (تجمیع‌ها)، مرزهای آنها و ریشه‌های آنها است. جزئیات ساختار داخلی aggregates (تجمیع‌ها) ثانویه است. با این حال، مزیت aggregates (تجمیع‌ها) فراتر از ماژول‌بندی یک model (مدل) domain (دامنه) است. به این دلیل که aggregates (تجمیع‌ها) باید از قوانین خاصی پیروی کنند.</p>
<h4><strong>5.2.3 Aggregate rules (قوانین تجمیع)</strong></h4>
<p>DDD (طراحی مبتنی بر دامنه) مستلزم آن است که aggregates (تجمیع‌ها) از مجموعه‌ای از قوانین پیروی کنند. این قوانین تضمین می‌کنند که یک aggregate (تجمیع) یک واحد self-contained (خود مختار) است که می‌تواند invariants (نامتغیرهای) خود را اعمال کند. بیایید به هر یک از قوانین نگاهی بیندازیم.</p>
<br/>
<p>«»</p>
<p>aggregate root (ریشه تجمیع)</p>
<p>Order (سفارش)</p>
<p>quantity (تعداد)</p>
<p>«»</p>
<p>aggregate root (ریشه تجمیع)</p>
<p>Consumer (مصرف‌کننده)</p>
<p>Order (تجمیع سفارش) aggregate (تجمیع)</p>
<p>Consumer (تجمیع مصرف‌کننده) aggregate (تجمیع)</p>
<p>... (و...)</p>
<p>«»</p>
<p>aggregate root (ریشه تجمیع)</p>
<p>Restaurant (رستوران)</p>
<p>«»</p>
<p>value object (شیء ارزشی)</p>
<p>OrderLineItem (آیتم خط سفارش)</p>
<p>Restaurant (تجمیع رستوران) aggregate (تجمیع)</p>
<p>«»</p>
<p>value object (شیء ارزشی)</p>
<p>DeliveryInfo (اطلاعات تحویل)</p>
<p>«»</p>
<p>value object (شیء ارزشی)</p>
<p>PaymentInfo (اطلاعات پرداخت)</p>
<br/>
<img alt="Figure 5.5" src="figure_5_5.png"/>
<p>Structuring a domain model (ساختار یک مدل دامنه) as a set of aggregates (به عنوان مجموعه‌ای از تجمیع‌ها) makes the (مرزها را صریح می‌کند) boundaries explicit.</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0185_original/original_page.png" alt="Original Page 185">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>CHAPTER 5 (فصل 5)</strong></h3>
<h3><strong>Designing (طراحی) business logic (منطق تجاری) in (در) a microservice architecture (معماری ریز سرویس)</strong></h3>
<p>RULE #1: REFERENCE ONLY THE AGGREGATE ROOT (قاعده شماره 1: فقط به ریشه تجمیع ارجاع دهید)</p>
<p>example (مثال) قبلی، خطرات به‌روزرسانی مستقیم OrderLineItems (آیتم‌های خط سفارش) را نشان داد. هدف از اولین قاعده aggregate (تجمیع) این است که این مشکل را از بین ببرد. این مستلزم آن است که root entity (موجودیت ریشه) تنها بخشی از یک aggregate (تجمیع) باشد که می‌تواند توسط کلاس‌هایی در خارج از aggregate (تجمیع) به آن ارجاع شود. یک client (مشتری) فقط می‌تواند یک aggregate (تجمیع) را با فراخوانی یک متد در aggregate root (ریشه تجمیع) به‌روزرسانی کند.</p>
<p>به عنوان مثال، یک service (سرویس)، از یک repository (مخزن) برای بارگذاری یک aggregate (تجمیع) از database (پایگاه داده) و دریافت یک reference (ارجاع) به aggregate root (ریشه تجمیع) استفاده می‌کند. این یک aggregate (تجمیع) را با فراخوانی یک متد در aggregate root (ریشه تجمیع) به‌روزرسانی می‌کند. این قانون تضمین می‌کند که aggregate (تجمیع) می‌تواند invariant (نامتغیر) خود را اعمال کند.</p>
<p>RULE #2: INTER-AGGREGATE REFERENCES (قاعده 2: ارجاعات بین تجمیعی) MUST USE PRIMARY KEYS (باید از کلیدهای اصلی استفاده کنند)</p>
<p>قانون دیگر این است که aggregates (تجمیع‌ها) به یکدیگر بر اساس identity (هویت) (به عنوان مثال، کلید اصلی) به جای object references (ارجاعات شی) ارجاع می‌دهند. به عنوان مثال، همانطور که شکل 5.6 نشان می‌دهد، یک Order (سفارش) با استفاده از یک consumerId (شناسه مصرف‌کننده) به Consumer (مصرف‌کننده) خود ارجاع می‌دهد، نه یک reference (ارجاع) به object (شیء) Consumer (مصرف‌کننده). به طور مشابه، یک Order (سفارش) با استفاده از یک restaurantId (شناسه رستوران) به یک Restaurant (رستوران) ارجاع می‌دهد.</p>
<p>این رویکرد کاملاً با object modeling (مدل‌سازی شی) سنتی متفاوت است، که کلیدهای خارجی در model (مدل) domain (دامنه) را یک design smell (بوی طراحی) در نظر می‌گیرد. این مزایای متعددی دارد. استفاده از identity (هویت) به جای object references (ارجاعات شی) به این معنی است که aggregates (تجمیع‌ها) به صورت loosely coupled (شل و غیر متصل) هستند. این تضمین می‌کند که مرزهای aggregate (تجمیع) بین aggregates (تجمیع‌ها) به خوبی تعریف شده‌اند و از به‌روزرسانی تصادفی یک aggregate (تجمیع) دیگر جلوگیری می‌کند. همچنین، اگر یک aggregate (تجمیع) بخشی از یک service (سرویس) دیگر باشد، مشکلی در مورد object references (ارجاعات شی) که خدمات را در بر می‌گیرد، وجود ندارد.</p>
<p>این رویکرد همچنین persistence (پایداری) را ساده می‌کند زیرا aggregate (تجمیع) واحد ذخیره‌سازی است. این ذخیره aggregates (تجمیع‌ها) را در یک database (پایگاه داده) NoSQL مانند MongoDB آسان‌تر می‌کند. همچنین</p>
<br/>
<p>consumerId (شناسه مصرف‌کننده)</p>
<p>restaurantId (شناسه رستوران)</p>
<p>... (و...)</p>
<p>«»</p>
<p>aggregate root (ریشه تجمیع)</p>
<p>Order (سفارش)</p>
<p>quantity (تعداد)</p>
<p>OrderLineItem (آیتم خط سفارش)</p>
<p>DeliveryInfo (اطلاعات تحویل)</p>
<p>... (و...)</p>
<p>«»</p>
<p>aggregate root (ریشه تجمیع)</p>
<p>Consumer (مصرف‌کننده)</p>
<p>Order (تجمیع سفارش) aggregate (تجمیع)</p>
<p>Consumer (تجمیع مصرف‌کننده) aggregate (تجمیع)</p>
<p>... (و...)</p>
<p>«»</p>
<p>aggregate root (ریشه تجمیع)</p>
<p>Restaurant (رستوران)</p>
<p>Restaurant (تجمیع رستوران) aggregate (تجمیع)</p>
<p>PaymentInfo (اطلاعات پرداخت)</p>
<p>DeliveryInfo (اطلاعات تحویل)</p>
<p>PaymentInfo (اطلاعات پرداخت)</p>
<br/>
<img alt="Figure 5.6" src="figure_5_6.png"/>
<p>References between aggregates (ارجاعات بین تجمیع‌ها) are (هستند) by (با) primary key (کلید اصلی) rather than (تا) by (با) object reference (ارجاع شی). The (the) Order (سفارش) aggregate (تجمیع) has (دارد) the IDs (شناسه‌های) of the (از) Consumer (مصرف‌کننده) and (و) Restaurant (رستوران) aggregates (تجمیع‌ها). Within (درون) an aggregate (یک تجمیع)، (,) objects (اشیاء) have (دارند) references (ارجاعات) to (به) one another (یکدیگر).</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0186_original/original_page.png" alt="Original Page 186">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Designing a domain model (طراحی یک مدل دامنه) using the (با استفاده از) the DDD aggregate pattern (الگوی تجمیع DDD)</strong></h3>
<p>lazy loading (بارگذاری تنبل) و مشکلات مرتبط با آن را از بین می‌برد. مقیاس‌بندی database (پایگاه داده) با sharding (تکه تکه کردن) aggregates (تجمیع‌ها) نسبتاً ساده است.</p>
<p>RULE #3: ONE TRANSACTION CREATES OR UPDATES ONE AGGREGATE (قاعده شماره 3: یک transaction (تراکنش) فقط یک AGGREGATE (تجمیع) را ایجاد یا به‌روزرسانی می‌کند)</p>
<p>قانون دیگری که aggregates (تجمیع‌ها) باید از آن اطاعت کنند این است که یک transaction (تراکنش) فقط می‌تواند یک aggregate (تجمیع) را ایجاد یا به‌روزرسانی کند. وقتی سال‌ها پیش برای اولین بار در مورد آن خواندم، این قانون هیچ منطقی نداشت! در آن زمان، من در حال توسعه traditional monolithic applications (برنامه‌های یکپارچه سنتی) بودم که از یک RDBMS (سیستم مدیریت پایگاه داده رابطه‌ای) استفاده می‌کردند، بنابراین transactions (تراکنش‌ها) می‌توانستند چندین aggregates (تجمیع‌ها) را به‌روزرسانی کنند. امروزه، این محدودیت برای microservice architecture (معماری ریز سرویس) عالی است. این تضمین می‌کند که یک transaction (تراکنش) در یک service (سرویس) گنجانده شده است.</p>
<p>این محدودیت همچنین با model (مدل) تراکنش محدود اکثر NoSQL databases (پایگاه‌های داده NoSQL) مطابقت دارد. این قانون، پیاده‌سازی operations (عملیاتی) را که نیاز به ایجاد یا به‌روزرسانی چندین aggregates (تجمیع‌ها) دارند، پیچیده‌تر می‌کند. اما این دقیقاً همان مشکلی است که sagas (حماسه‌ها) (شرح داده شده در فصل 4) برای حل آن طراحی شده‌اند. هر گام از saga (حماسه) دقیقاً یک aggregate (تجمیع) را ایجاد یا به‌روزرسانی می‌کند. شکل 5.7 نحوه عملکرد این را نشان می‌دهد.</p>
<p>در این مثال، saga (حماسه) از سه transaction (تراکنش) تشکیل شده است. اولین transaction (تراکنش) aggregate X (تجمیع X) را در service A (سرویس A) به‌روزرسانی می‌کند. دو transaction (تراکنش) دیگر هر دو در service B (سرویس B) هستند. یک transaction (تراکنش) aggregate X (تجمیع X) را به‌روزرسانی می‌کند، و دیگری aggregate Y (تجمیع Y) را به‌روزرسانی می‌کند.</p>
<p>یک رویکرد جایگزین برای حفظ consistency (سازگاری) در چندین aggregates (تجمیع‌ها) در یک service (سرویس) واحد این است که تقلب کنید و چندین aggregates (تجمیع‌ها) را در یک transaction (تراکنش) به‌روزرسانی کنید. به عنوان مثال، service B (سرویس B) می‌تواند aggregates Y (تجمیع Y) و Z (تجمیع Z) را در یک transaction (تراکنش) واحد به‌روزرسانی کند. این تنها زمانی امکان‌پذیر است که از یک database (پایگاه داده)، مانند یک RDBMS (سیستم مدیریت پایگاه داده رابطه‌ای) که از یک model (مدل) تراکنش غنی پشتیبانی می‌کند، استفاده کنید. اگر از یک database (پایگاه داده) NoSQL استفاده می‌کنید که فقط تراکنش‌های ساده دارد، هیچ گزینه دیگری جز استفاده از sagas (حماسه‌ها) وجود ندارد.</p>
<p>یا آیا وجود دارد؟ معلوم می‌شود که aggregate boundaries (مرزهای تجمیع) در سنگ نوشته نشده‌اند. هنگام توسعه یک model (مدل) domain (دامنه)، شما می‌توانید انتخاب کنید که مرزها کجا قرار دارند. اما مانند یک قدرت استعماری قرن بیستم که مرزهای ملی را ترسیم می‌کند، شما باید مراقب باشید.</p>
<br/>
<p>Service A (سرویس A)</p>
<p>Saga (حماسه)</p>
<p>Local transaction 1 (تراکنش محلی 1)</p>
<p>Create/update (ایجاد/به‌روزرسانی)</p>
<p>Aggregate X (تجمیع X)</p>
<p>Service B (سرویس B)</p>
<p>Local transaction 2 (تراکنش محلی 2)</p>
<p>Aggregate Y (تجمیع Y)</p>
<p>Local transaction 3 (تراکنش محلی 3)</p>
<p>Aggregate Z (تجمیع Z)</p>
<p>Create/update (ایجاد/به‌روزرسانی)</p>
<p>Create/update (ایجاد/به‌روزرسانی)</p>
<br/>
<img alt="Figure 5.7" src="figure_5_7.png"/>
<p>A transaction (یک تراکنش) can (می‌تواند) only (فقط) create or update (ایجاد یا به‌روزرسانی کند) a single aggregate (یک تجمیع واحد)، so (بنابراین) an application (یک برنامه) uses (استفاده می‌کند) a saga (یک حماسه)</p>
<p>to update (برای به‌روزرسانی) multiple aggregates (تجمیع‌های متعدد). Each step (هر گام) of the saga (حماسه) creates or updates (ایجاد یا به‌روزرسانی می‌کند) one (یک) aggregate (تجمیع).</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0187_original/original_page.png" alt="Original Page 187">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 5: طراحی منطق کسب‌وکار در معماری microservice</strong></h3>
<h4><strong style="color:darkblue">5.2.4: Granularity Aggregate</strong></h4>
<p>
   هنگام توسعه یک domain model، یک تصمیم کلیدی که باید بگیرید این است که هر aggregate را چقدر بزرگ کنید. از یک طرف، aggregates در حالت ایده‌آل باید کوچک باشند. زیرا updates به هر aggregate serialized می‌شوند، aggregates با granularity بیشتر، تعداد درخواست‌های همزمان را که application می‌تواند handle کند افزایش می‌دهند و مقیاس‌پذیری را بهبود می‌بخشند. همچنین user experience را بهبود می‌بخشد، زیرا شانس دو کاربر برای تلاش برای conflicting updates از همان aggregate را کاهش می‌دهد. از طرف دیگر، از آنجایی که یک aggregate، scope از transaction است، ممکن است لازم باشد یک aggregate بزرگتر تعریف کنید تا یک update خاص atomic شود.
  </p>
<p>
   برای مثال، قبلاً اشاره کردم که چگونه در domain model از application FTGO، Order و Consumer aggregates جداگانه هستند. یک طراحی جایگزین این است که Order را بخشی از Consumer aggregate قرار دهیم. شکل 5.8 این طراحی جایگزین را نشان می‌دهد.
  </p>
<p>
   یک مزیت این Consumer aggregate بزرگتر این است که application می‌تواند به صورت atomic، یک Consumer و یک یا چند Order از آن را update کند. یک نقطه ضعف این رویکرد این است که مقیاس‌پذیری را کاهش می‌دهد. transactions که ordersهای مختلف را برای همان customer update می‌کنند، serialized خواهند شد. به طور مشابه، اگر دو user تلاش کنند تا ordersهای مختلف را برای همان customer ویرایش کنند، با هم conflict خواهند داشت.
  </p>
<p>
   یکی دیگر از معایب این رویکرد در یک معماری microservice این است که مانعی برای decomposition است. منطق کسب‌وکار برای Orders و Consumers، برای مثال، باید در همان service collocated شود، که باعث می‌شود service بزرگتر شود. به دلیل این مسائل، بهترین کار این است که aggregates را تا حد امکان fine-grained کنید.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMvOjj+3sH39fT3+j6v2f/sP29/sE/c/3//e0D3gJ99wH/f45+0/7/oO8/3/z38v0f/39/3wfy8/e9f+v/37b/d/+2/tP/7n/0//89+n8f2X/n//u//9/0/z1/8v9/8z//H/2e/y/7+1/9n/3/8/4r+/8/f/w96f//57z9h79/9/z5/89/+1/9n/z//8v/8v/7/v/t/3+P+d/8/95/8//u//9f9f4/3/0/+v//v/8/9f/7/f/3/2//8/8/9/89//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7/9//8/9f/7/9//v/9//7
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0188_original/original_page.png" alt="Original Page 188">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">طراحی یک domain model با استفاده از الگو aggregate از نوع DDD</strong></h3>
<h4><strong style="color:darkblue">5.2.5: طراحی منطق کسب‌وکار با aggregates</strong></h4>
<p>
   در یک (micro)service معمولی، بخش عمده‌ای از business logic از aggregates تشکیل شده است. بقیه business logic در domain services و sagas قرار دارد. sagas، sequences از local transactions را برای اعمال data consistency هماهنگ می‌کنند. services نقاط ورودی به business logic هستند و توسط inbound adapters فراخوانی می‌شوند. یک service از یک repository برای بازیابی aggregates از database یا ذخیره aggregates در database استفاده می‌کند. هر repository توسط یک outbound adapter که به database دسترسی دارد، پیاده‌سازی می‌شود. شکل 5.9 طراحی مبتنی بر aggregate از business logic را برای Order Service نشان می‌دهد.
  </p>
<p>
   business logic شامل Order aggregate، کلاس service به نام OrderService، OrderRepository و یک یا چند saga است. OrderService، OrderRepository را برای ذخیره و بارگذاری Orders فراخوانی می‌کند. برای simple requests که local به service هستند،
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMz و
  &lt;/p&gt;
 &lt;/div&gt;
 
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0189_original/original_page.png" alt="Original Page 189">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 5: طراحی منطق کسب‌وکار در معماری microservice</strong></h3>
<p>
   service، یک Order aggregate را update می‌کند. اگر یک update request شامل چندین service باشد، OrderService همچنین یک saga ایجاد می‌کند، همانطور که در فصل 4 توضیح داده شد.
  </p>
<p>
   ما به کد نگاهی می‌اندازیم—اما ابتدا، بیایید به مفهومی که ارتباط نزدیکی با aggregates دارد، یعنی domain events، بپردازیم.
  </p>
<h4><strong style="color:darkblue">5.3: انتشار domain events</strong></h4>
<p>
   Merriam-Webster (https://www.merriam-webster.com/dictionary/event) چندین تعریف از کلمه event را فهرست می‌کند، از جمله این موارد:
  </p>
<ol>
<li>Something that happens</li>
<li>A noteworthy happening</li>
<li>A social occasion or activity</li>
<li>An adverse or damaging medical occurrence, a heart attack or other cardiac event</li>
</ol>
<p>
   در context از DDD، یک domain event چیزی است که برای یک aggregate اتفاق افتاده است. این توسط یک class در domain model نشان داده می‌شود. یک event معمولاً یک state change را نشان می‌دهد. به عنوان مثال، یک Order aggregate در application FTGO را در نظر بگیرید. events تغییر دهنده state آن شامل Order Created، Order Cancelled، Order Shipped و غیره است. یک Order aggregate ممکن است، در صورت وجود interested consumers، یک event را هر بار که یک state transition را طی می‌کند، منتشر کند.
  </p>
<h4><strong style="color:darkblue">5.3.1: چرا باید change events را منتشر کرد؟</strong></h4>
<p>
   Domain events مفید هستند زیرا parties دیگر—users، applicationsهای دیگر، یا componentsهای دیگر در همان application—اغلب علاقه‌مند به دانستن در مورد state changes از یک aggregate هستند. در اینجا چند سناریوی مثال آورده شده است:
  </p>
<ul>
<li>حفظ data consistency در سراسر services با استفاده از choreography-based sagas، که در فصل 4 توضیح داده شد.</li>
<li>اعلام به یک service که یک replica را نگه می‌دارد که data source تغییر کرده است. این رویکرد به عنوان Command Query Responsibility Segregation (CQRS) شناخته می‌شود و در فصل 7 توضیح داده شده است.</li>
<li>اعلام به یک application متفاوت از طریق یک webhook ثبت شده یا از طریق یک message broker به منظور trigger کردن گام بعدی در یک business process.</li>
<li>اعلام به یک component متفاوت از همان application به منظور، به عنوان مثال، ارسال یک WebSocket message به مرورگر کاربر یا update کردن یک text database مانند ElasticSearch.</li>
<li>ارسال notifications—text messages یا emails—به users که به آنها اطلاع می‌دهد که order آنها ارسال شده است، نسخه Rx آنها برای دریافت آماده است، یا پرواز آنها به تأخیر افتاده است.</li>
</ul>
<p>
   Pattern: Domain event
   <br/>
   یک aggregate، domain event را زمانی منتشر می‌کند که ایجاد می‌شود یا تغییر قابل توجه دیگری را تجربه می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0190_original/original_page.png" alt="Original Page 190">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">انتشار domain events</strong></h3>
<ul>
<li>monitoring domain events برای تأیید اینکه application به درستی رفتار می‌کند.</li>
<li>Analyzing events برای مدل‌سازی رفتار user.</li>
</ul>
<p>
   The trigger برای notification در همه این سناریوها، state change از یک aggregate در database از یک application است.
  </p>
<h4><strong style="color:darkblue">5.3.2: یک domain event چیست؟</strong></h4>
<p>
   یک domain event یک class با یک name است که با استفاده از یک فعل past-participle شکل گرفته است. این properties دارد که به طور معنی‌داری event را منتقل می‌کند. هر property یا یک primitive value یا یک value object است. به عنوان مثال، یک class به نام OrderCreated event دارای یک property به نام orderId است.
  </p>
<p>
   یک domain event معمولاً metadata نیز دارد، مانند event ID و یک timestamp. همچنین ممکن است identity از user را داشته باشد که این تغییر را ایجاد کرده است، زیرا این برای auditing مفید است. metadata می‌تواند بخشی از event object باشد، شاید در یک superclass تعریف شده باشد. از طرف دیگر، event metadata می‌تواند در یک envelope object باشد که event object را wrap می‌کند. ID از aggregate که event را emit کرده است نیز ممکن است بخشی از envelope باشد، نه یک event property صریح.
  </p>
<p>
   The OrderCreated event، نمونه‌ای از یک domain event است. هیچ fieldی ندارد، زیرا ID از Order بخشی از event envelope است. listing زیر، class از نوع OrderCreated event و class از نوع DomainEventEnvelope را نشان می‌دهد.
  </p>
<pre><code class="language-java">interface DomainEvent {}
interface OrderDomainEvent extends DomainEvent {}
class OrderCreated implements OrderDomainEvent {}
class DomainEventEnvelope<t domainevent="" extends=""> {
private String aggregateType;
private Object aggregateId;
private T event;
...
}
</t></code></pre>
<p>
   The DomainEvent interface یک marker interface است که یک class را به عنوان یک domain event شناسایی می‌کند. OrderDomainEvent یک marker interface برای events است، مانند OrderCreated، که توسط Order aggregate منتشر می‌شوند. The DomainEventEnvelope یک class است که حاوی event metadata و event object است. این یک generic class است که توسط domain event type پارامتریزه شده است.
  </p>
<h4><strong style="color:darkblue">5.3.3: Event enrichment</strong></h4>
<p>
   به عنوان مثال، بیایید تصور کنیم که شما در حال نوشتن یک event consumer هستید که events از نوع Order را process می‌کند. The OrderCreated event class که قبلاً نشان داده شد، جوهر آنچه اتفاق افتاده است را به تصویر می‌کشد. اما event consumer شما ممکن است هنگام process کردن یک
  </p>
<p>
   Listing 5.1
   <br/>
   The OrderCreated event و کلاس DomainEventEnvelope
   <br/>
   The event’s
   <br/>
   metadata
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0191_original/original_page.png" alt="Original Page 191">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 5: طراحی منطق کسب‌وکار در معماری microservice</strong></h3>
<p>
   OrderCreated event. یک گزینه این است که آن اطلاعات را از OrderService بازیابی کند. نقطه ضعف event consumer که service را برای aggregate query می‌کند این است که overhead از یک service request را متحمل می‌شود.
  </p>
<p>
   یک رویکرد جایگزین که به عنوان event enrichment شناخته می‌شود این است که events شامل اطلاعاتی باشند که consumers نیاز دارند. این کار event consumers را ساده می‌کند زیرا آنها دیگر نیازی ندارند که آن data را از service که event را منتشر کرده است، request کنند. در OrderCreated event، Order aggregate می‌تواند event را با گنجاندن جزئیات order، enrich کند. listing زیر، event enrich شده را نشان می‌دهد.
  </p>
<pre><code class="language-java">class OrderCreated implements OrderEvent {
private List&lt;OrderLineItem&gt; lineItems;
private DeliveryInformation deliveryInformation;
private PaymentInformation paymentInformation;
private long restaurantId;
private String restaurantName;
...
}
</code></pre>
<p>
   از آنجایی که این نسخه از OrderCreated event شامل جزئیات order است، یک event consumer، مانند Order History Service (که در فصل 7 مورد بحث قرار گرفت) دیگر نیازی ندارد که آن data را هنگام process کردن یک OrderCreated event fetch کند.
  </p>
<p>
   اگرچه event enrichment، consumers را ساده می‌کند، نقطه ضعف این است که خطر کمتری را برای stable کردن classهای event دارد. یک event class به طور بالقوه نیاز دارد که هر زمان که requirements از consumers آن تغییر می‌کند، تغییر کند. این می‌تواند maintainability را کاهش دهد زیرا این نوع از change می‌تواند بر چندین قسمت از application تأثیر بگذارد. برآورده کردن نیازهای هر consumer نیز می‌تواند یک تلاش بی‌فایده باشد. خوشبختانه، در بسیاری از موقعیت‌ها، مشخص است که کدام properties را در یک event قرار دهیم.
  </p>
<p>
   اکنون که ما basics از domain events را پوشش دادیم، بیایید نگاهی بیندازیم به چگونگی کشف آنها.
  </p>
<h4><strong style="color:darkblue">5.3.4: شناسایی domain events</strong></h4>
<p>
   چندین strategy متفاوت برای شناسایی domain events وجود دارد. اغلب، requirements سناریوهایی را توصیف می‌کنند که در آن notifications مورد نیاز است. requirements ممکن است شامل زبانی مانند "When X happens do Y" باشد. به عنوان مثال، یک requirement در application FTGO این است: "When an Order is placed send the consumer an email." یک requirement برای notification، وجود یک domain event را نشان می‌دهد.
  </p>
<p>
   یک رویکرد دیگر، که در حال افزایش محبوبیت است، استفاده از event storming است. Event storming یک format کارگاهی event-centric برای درک یک domain complex است. این شامل جمع‌آوری domain experts در یک اتاق، تعداد زیادی sticky notes و یک surface بسیار بزرگ—یک whiteboard یا paper roll—برای چسباندن notesها است. نتیجه event storming یک domain model event-centric است که شامل aggregates و events است.
  </p>
<p>
   Listing 5.2
   <br/>
   The enriched OrderCreated event
   <br/>
   Data that its
   <br/>
   consumers
   <br/>
   typically need
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0192_original/original_page.png" alt="Original Page 192">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">انتشار domain events</strong></h3>
<p>
   Event storming شامل سه مرحله اصلی است:
  </p>
<ol>
<li>
    Brainstorm events—از domain experts بخواهید تا domain events را brainstorm کنند. domain events توسط sticky notes نارنجی نشان داده می‌شوند که در یک timeline تقریبی روی surface modeling قرار می‌گیرند.
   </li>
<li>
    Identify event triggers—از domain experts بخواهید تا trigger هر event را شناسایی کنند، که یکی از موارد زیر است:
    <ul>
<li>User actions، که به عنوان یک command با استفاده از یک sticky note آبی نشان داده می‌شود</li>
<li>External system، که با یک sticky note بنفش نشان داده می‌شود</li>
<li>Another domain event</li>
<li>Passing of time</li>
</ul>
</li>
<li>
    Identify aggregates—از domain experts بخواهید تا aggregate را شناسایی کنند که هر command را consume می‌کند و event مربوطه را emit می‌کند. Aggregates با sticky notes زرد نشان داده می‌شوند.
   </li>
</ol>
<p>
   شکل 5.10 نتیجه یک workshop از event-storming را نشان می‌دهد. شرکت‌کنندگان تنها در عرض چند ساعت، numerous domain events، commands و aggregates را شناسایی کردند. این یک گام خوب در فرآیند ایجاد یک domain model بود.
  </p>
<p>
   Event storming یک تکنیک مفید برای ایجاد سریع یک domain model است.
  </p>
<p>
   اکنون که ما basics از domain events را پوشش داده‌ایم، بیایید به mechanics از تولید و انتشار آنها بپردازیم.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMz
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
<div class="page-image"><img alt="Image from page 193" src="page_0193/image_1.png"/></div>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0193_original/original_page.png" alt="Original Page 193">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 5: طراحی منطق کسب‌وکار در معماری microservice</strong></h3>
<h4><strong style="color:darkblue">5.3.5: تولید و انتشار domain events</strong></h4>
<p>
   Communicating با استفاده از domain events یک فرم از asynchronous messaging است که در فصل 3 مورد بحث قرار گرفت. اما قبل از اینکه business logic بتواند آنها را به یک message broker منتشر کند، ابتدا باید آنها را ایجاد کند. بیایید نگاهی به نحوه انجام این کار بیندازیم.
  </p>
<p>
   GENERATING DOMAIN EVENTS
   <br/>
   از نظر مفهومی، domain events توسط aggregates منتشر می‌شوند. یک aggregate می‌داند چه زمانی state آن تغییر می‌کند و از این رو چه eventای را منتشر کند. یک aggregate می‌تواند مستقیماً یک messaging API را فراخوانی کند. نقطه ضعف این رویکرد این است که از آنجایی که aggregates نمی‌توانند از dependency injection استفاده کنند، messaging API باید به عنوان یک method argument منتقل شود. این امر concerns زیرساخت و business logic را در هم می‌آمیزد، که بسیار نامطلوب است.
  </p>
<p>
   یک رویکرد بهتر این است که مسئولیت را بین aggregate و service (یا class معادل آن) که آن را فراخوانی می‌کند، تقسیم کنیم. Services می‌توانند از dependency injection برای به دست آوردن یک reference به messaging API استفاده کنند و به راحتی events را منتشر کنند. aggregate events را هر زمان که state آن تغییر می‌کند تولید می‌کند و آنها را به service برمی‌گرداند. چندین راه مختلف وجود دارد که یک aggregate می‌تواند events را به service برگرداند. یک گزینه این است که return value از یک aggregate method شامل یک list از events باشد. به عنوان مثال، listing زیر نشان می‌دهد که چگونه method به نام accept() از یک Ticket aggregate می‌تواند یک TicketAcceptedEvent را به caller آن برگرداند.
  </p>
<pre><code class="language-java">public class Ticket {
public List&lt;DomainEvent&gt; accept(ZonedDateTime readyBy) {
...
this.acceptTime = ZonedDateTime.now();

this.readyBy = readyBy;
return singletonList(new TicketAcceptedEvent(readyBy));
}
}
</code></pre>
<p>
   The service، method از aggregate root را فراخوانی می‌کند و سپس events را منتشر می‌کند. به عنوان مثال، listing زیر نشان می‌دهد که چگونه KitchenService، Ticket.accept() را فراخوانی می‌کند و events را منتشر می‌کند.
  </p>
<pre><code class="language-java">public class KitchenService {
@Autowired
private TicketRepository ticketRepository;
@Autowired
private DomainEventPublisher domainEventPublisher;
</code></pre>
<p>
   Listing 5.3
   <br/>
   The Ticket aggregate’s accept() method
  </p>
<p>
   Listing 5.4
   <br/>
   KitchenService calls Ticket.accept()
   <br/>
   Updates
   <br/>
   the Ticket
   <br/>
   Returns
   <br/>
   an event
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0194_original/original_page.png" alt="Original Page 194">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">انتشار domain events</strong></h3>
<pre><code class="language-java">public void accept(long ticketId, ZonedDateTime readyBy) {
Ticket ticket =
ticketRepository.findById(ticketId)
.orElseThrow(() -&gt;
new TicketNotFoundException(ticketId));
List&lt;DomainEvent&gt; events = ticket.accept(readyBy);
domainEventPublisher.publish(Ticket.class, orderId, events);
}
</code></pre>
<p>
   The accept() method ابتدا TicketRepository را فراخوانی می‌کند تا Ticket را از database بارگذاری کند. سپس Ticket را با فراخوانی accept() update می‌کند. KitchenService سپس events را که توسط Ticket برگردانده شده‌اند با فراخوانی DomainEventPublisher.publish()، که به زودی توضیح داده می‌شود، منتشر می‌کند.
  </p>
<p>
   این رویکرد بسیار ساده است. methods که در غیر این صورت return type از نوع void خواهند داشت، اکنون List&lt;Event&gt; را برمی‌گردانند. تنها نقطه ضعف بالقوه این است که return type از non-void methods اکنون پیچیده‌تر است. آنها باید یک object حاوی return value اصلی و List&lt;Event&gt; را برگردانند. شما به زودی یک مثال از این method را خواهید دید.
  </p>
<p>
   یک گزینه دیگر این است که aggregate root events را در یک field جمع‌آوری کند. سپس service events را بازیابی کرده و آنها را منتشر می‌کند. به عنوان مثال، listing زیر یک variant از class Ticket را نشان می‌دهد که به این روش کار می‌کند.
  </p>
<pre><code class="language-java">public class Ticket extends AbstractAggregateRoot {
public void accept(ZonedDateTime readyBy) {
...
this.acceptTime = ZonedDateTime.now();
this.readyBy = readyBy;
registerDomainEvent(new TicketAcceptedEvent(readyBy));
}
}
</code></pre>
<p>
   Ticket extends AbstractAggregateRoot، که یک method به نام registerDomainEvent() را تعریف می‌کند که event را ثبت می‌کند. یک service، AbstractAggregateRoot.getDomainEvents() را فراخوانی می‌کند تا آن events را بازیابی کند.
  </p>
<p>
   ترجیح من برای اولین گزینه است: method که events را به service برمی‌گرداند. اما جمع‌آوری events در aggregate root نیز یک گزینه مناسب است. در واقع، Spring Data Ingalls release train (https://spring.io/blog/2017/01/30/what-s-new-in-spring-data-release-ingalls) یک mechanism را پیاده‌سازی می‌کند که به طور خودکار events را به Spring ApplicationContext منتشر می‌کند. نقطه ضعف اصلی این است که برای کاهش کد تکراری، aggregate roots باید یک superclass مانند AbstractAggregateRoot را گسترش دهند، که ممکن است با requirement برای گسترش برخی از superclassهای دیگر تداخل داشته باشد. یک مسئله دیگر این است که اگرچه برای methods از aggregate root آسان است که registerDomainEvent() را فراخوانی کنند، methods در classهای دیگر در aggregate آن را چالش برانگیز می‌یابند. آنها به احتمال زیاد نیاز دارند که به نحوی events را به aggregate root منتقل کنند.
  </p>
<p>
   Listing 5.5
   <br/>
   The Ticket extends a superclass, which records domain events
  </p>
<p>
   Publishes
   <br/>
   domain
   <br/>
   events
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0195_original/original_page.png" alt="Original Page 195">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 5: طراحی منطق کسب‌وکار در معماری microservice</strong></h3>
<h4><strong style="color:darkblue">HOW TO RELIABLY PUBLISH DOMAIN EVENTS?</strong></h4>
<p>
   فصل 3 در مورد چگونگی ارسال reliable messages به عنوان بخشی از یک local database transaction صحبت می‌کند. domain events هیچ تفاوتی ندارند. یک service باید از transactional messaging برای publish کردن events استفاده کند تا اطمینان حاصل شود که آنها به عنوان بخشی از transaction که aggregate را در database update می‌کند، منتشر می‌شوند. فریم‌ورک Eventuate Tram، که در فصل 3 توضیح داده شد، چنین mechanism را پیاده‌سازی می‌کند. این events را به عنوان بخشی از ACID transaction که database را update می‌کند، به یک جدول به نام OUTBOX insert می‌کند. پس از commit شدن transaction، events که به جدول OUTBOX insert شده‌اند، سپس به message broker منتشر می‌شوند.
  </p>
<p>
   فریم‌ورک Tram یک DomainEventPublisher interface را فراهم می‌کند که در listing زیر نشان داده شده است. این چندین method publish() overloade را تعریف می‌کند که aggregate type و ID را به عنوان پارامتر، به همراه یک list از domain events، می‌پذیرد.
  </p>
<pre><code class="language-java">public interface DomainEventPublisher {
void publish(String aggregateType, Object aggregateId,
List&lt;DomainEvent&gt; domainEvents);
</code></pre>
<p>
   این از Eventuate Tram framework’s MessageProducer interface برای publish کردن آن events transactionally استفاده می‌کند.
  </p>
<p>
   یک service می‌تواند DomainEventPublisher publisher را مستقیماً فراخوانی کند. اما یکی از معایب انجام این کار این است که تضمین نمی‌کند که یک service فقط events معتبر را منتشر می‌کند. به عنوان مثال، KitchenService، باید فقط events را منتشر کند که TicketDomainEvent را پیاده‌سازی می‌کنند، که marker interface برای events از Ticket aggregate است. یک گزینه بهتر این است که services یک subclass از AbstractAggregateDomainEventPublisher را پیاده‌سازی کنند، که در listing 5.7 نشان داده شده است. AbstractAggregateDomainEventPublisher یک class انتزاعی است که یک interface type-safe برای publish کردن domain events فراهم می‌کند. این یک generic class است که دارای دو type parameter، A، the aggregate type و E، the marker interface type برای domain events است. یک service events را با فراخوانی method publish()، که دارای دو پارامتر است، منتشر می‌کند: یک aggregate از نوع A و یک list از events از نوع E.
  </p>
<pre><code class="language-java">public abstract class AbstractAggregateDomainEventPublisher&lt;A, E extends Doma
inEvent&gt; {
private Function&lt;A, Object&gt; idSupplier;
private DomainEventPublisher eventPublisher;
private Class&lt;A&gt; aggregateType;
protected AbstractAggregateDomainEventPublisher(
DomainEventPublisher eventPublisher,
Class&lt;A&gt; aggregateType,
Function&lt;A, Object&gt; idSupplier) {
this.eventPublisher = eventPublisher;
this.aggregateType = aggregateType;
</code></pre>
<p>
   Listing 5.6
   <br/>
   The Eventuate Tram framework’s DomainEventPublisher interface
  </p>
<p>
   Listing 5.7
   <br/>
   The abstract superclass of type-safe domain event publishers
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0196_original/original_page.png" alt="Original Page 196">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">انتشار domain events</strong></h3>
<pre><code class="language-java">this.idSupplier = idSupplier;
}
public void publish(A aggregate, List&lt;E&gt; events) {
eventPublisher.publish(aggregateType, idSupplier.apply(aggregate),
(List&lt;DomainEvent&gt;) events);
}
</code></pre>
<p>
   method publish()، ID از aggregate را بازیابی می‌کند و DomainEventPublisher.publish() را فراخوانی می‌کند. listing زیر، TicketDomainEventPublisher را نشان می‌دهد، که domain events را برای Ticket aggregate منتشر می‌کند.
  </p>
<pre><code class="language-java">public class TicketDomainEventPublisher extends
AbstractAggregateDomainEventPublisher&lt;Ticket, TicketDomainEvent&gt; {
public TicketDomainEventPublisher(DomainEventPublisher eventPublisher) {
super(eventPublisher, Ticket.class, Ticket::getId);
}
}
</code></pre>
<p>
   این class فقط events را منتشر می‌کند که یک subclass از TicketDomainEvent هستند.
  </p>
<p>
   اکنون که ما نحوه publish کردن domain events را بررسی کردیم، بیایید ببینیم چگونه آنها را consume کنیم.
  </p>
<h4><strong style="color:darkblue">5.3.6: Consuming domain events</strong></h4>
<p>
   Domain events در نهایت به عنوان messages به یک message broker، مانند Apache Kafka، منتشر می‌شوند. یک consumer می‌تواند مستقیماً از broker’s client API استفاده کند. اما استفاده از یک API سطح بالاتر مانند Eventuate Tram framework’s DomainEventDispatcher، که در فصل 3 توضیح داده شد، راحت‌تر است. A DomainEventDispatcher domain events را به method handler مناسب dispatch می‌کند. Listing 5.9 یک مثال از class event handler را نشان می‌دهد. KitchenServiceEventConsumer به events منتشر شده توسط Restaurant Service هر زمان که منوی یک رستوران update می‌شود، مشترک می‌شود. این مسئول به روز نگه داشتن replica از داده‌ها در Kitchen Service است.
  </p>
<pre><code class="language-java">public class KitchenServiceEventConsumer {
@Autowired
private RestaurantService restaurantService;
public DomainEventHandlers domainEventHandlers() {
return DomainEventHandlersBuilder
.forAggregateType("net.chrisrichardson.ftgo.restaurantservice.Restaurant")
.onEvent(RestaurantMenuRevised.class, this::reviseMenu)
</code></pre>
<p>
   Listing 5.8
   <br/>
   A type-safe interface for publishing Ticket aggregates' domain events
  </p>
<p>
   Listing 5.9
   <br/>
   Dispatching events to event handler methods
  </p>
<p>
   Maps events to
   <br/>
   event handlers
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0197_original/original_page.png" alt="Original Page 197">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 5: طراحی منطق کسب‌وکار در معماری microservice</strong></h3>
<pre><code class="language-java">.build();
}
public void reviseMenu(DomainEventEnvelope&lt;RestaurantMenuRevised&gt; de) {
long id = Long.parseLong(de.getAggregateId());
RestaurantMenu revisedMenu = de.getEvent().getRevisedMenu();
restaurantService.reviseMenu(id, revisedMenu);
}
</code></pre>
<p>
   method به نام reviseMenu()، events به نام RestaurantMenuRevised را handle می‌کند. این restaurantService.reviseMenu() را فراخوانی می‌کند، که menu رستوران را update می‌کند. آن method یک list از domain events را برمی‌گرداند که توسط event handler منتشر می‌شوند.
  </p>
<p>
   اکنون که ما به aggregates و domain events نگاهی انداختیم، زمان آن رسیده است که به برخی از business logicهای مثال که با استفاده از aggregates پیاده‌سازی شده‌اند، بپردازیم.
  </p>
<h4><strong style="color:darkblue">5.4: منطق کسب‌وکار Kitchen Service</strong></h4>
<p>
   اولین مثال، Kitchen Service است که به یک رستوران این امکان را می‌دهد تا orders خود را مدیریت کند. دو aggregate اصلی در این service، aggregates به نام Restaurant و Ticket هستند. Restaurant aggregate، menu و ساعات کاری رستوران را می‌داند و می‌تواند orders را اعتبار سنجی کند. یک Ticket نشان‌دهنده یک order است که یک رستوران باید آن را برای تحویل توسط پیک آماده کند. شکل 5.11 این aggregates و سایر بخش‌های کلیدی از business logic از service و همچنین adapters از service را نشان می‌دهد.
  </p>
<p>
   علاوه بر aggregates، سایر بخش‌های اصلی از business logic در Kitchen Service عبارتند از KitchenService، TicketRepository و RestaurantRepository. KitchenService، ورودی business logic است. این methods را برای ایجاد و update کردن aggregates به نام Restaurant و Ticket تعریف می‌کند. TicketRepository و RestaurantRepository methods را برای persist کردن Tickets و Restaurants به ترتیب تعریف می‌کنند.
  </p>
<p>
   The Kitchen Service service دارای سه inbound adapter است:
  </p>
<ul>
<li>
    REST API—The REST API که توسط user interface استفاده شده توسط کارگران در رستوران فراخوانی می‌شود. این KitchenService را برای ایجاد و update کردن Tickets فراخوانی می‌کند.
   </li>
<li>
    KitchenServiceCommandHandler—The asynchronous request/response-based API که توسط sagas فراخوانی می‌شود. این KitchenService را برای ایجاد و update کردن Tickets فراخوانی می‌کند.
   </li>
<li>
    KitchenServiceEventConsumer—به events منتشر شده توسط Restaurant Service مشترک می‌شود. این KitchenService را برای ایجاد و update کردن Restaurants فراخوانی می‌کند.
   </li>
</ul>
<p>
   The service همچنین دارای دو outbound adapter است:
  </p>
<ul>
<li>
    DB adapter—The TicketRepository و interfaces به نام RestaurantRepository را پیاده‌سازی می‌کند و به database دسترسی دارد.
   </li>
<li>
    DomainEventPublishingAdapter—The DomainEventPublisher interface را پیاده‌سازی می‌کند و domain events از نوع Ticket را منتشر می‌کند.
   </li>
</ul>
<p>
   An event handler for the
   <br/>
   RestaurantMenuRevised
   <br/>
   event
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0198_original/original_page.png" alt="Original Page 198">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Kitchen Service business logic</strong></h3>
<p>
   بیایید نگاهی دقیق‌تر به طراحی KitchenService، با شروع از Ticket aggregate، بیندازیم.
  </p>
<h4><strong style="color:darkblue">5.4.1: The Ticket aggregate</strong></h4>
<p>
   Ticket یکی از aggregates از Kitchen Service است. همانطور که در فصل 2 توضیح داده شد، هنگام صحبت در مورد مفهوم Bounded Context، این aggregate، دیدگاه آشپزخانه رستوران از یک order را نشان می‌دهد. این شامل اطلاعاتی در مورد consumer، مانند identity، اطلاعات تحویل یا جزئیات پرداخت نیست. این بر روی فعال کردن آشپزخانه یک رستوران برای آماده‌سازی Order برای pickup متمرکز شده است. علاوه بر این، KitchenService یک ID منحصر به فرد برای این aggregate ایجاد نمی‌کند. در عوض، از ID ارائه شده توسط OrderService استفاده می‌کند.
  </p>
<p>
   بیایید ابتدا به ساختار این class نگاهی بیندازیم و سپس methods آن را بررسی می‌کنیم.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMz
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0199_original/original_page.png" alt="Original Page 199">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 5: طراحی منطق کسب‌وکار در معماری microservice</strong></h3>
<h4><strong style="color:darkblue">STRUCTURE OF THE TICKET CLASS</strong></h4>
<p>
   listing زیر، بخشی از کد را برای این class نشان می‌دهد. The Ticket class شبیه به یک domain class سنتی است. تفاوت اصلی این است که references به other aggregates بر اساس primary key است.
  </p>
<pre><code class="language-java">@Entity(table="tickets")
public class Ticket {
@Id
private Long id;
private TicketState state;
private Long restaurantId;
@ElementCollection
@CollectionTable(name="ticket_line_items")
private List&lt;TicketLineItem&gt; lineItems;
private ZonedDateTime readyBy;
private ZonedDateTime acceptTime;
private ZonedDateTime preparingTime;
private ZonedDateTime pickedUpTime;
private ZonedDateTime readyForPickupTime;
...
</code></pre>
<p>
   این class با JPA persist می‌شود و به جدول TICKETS mapped می‌شود. field به نام restaurantId، یک Long است، نه یک object reference به Restaurant. field به نام readyBy، تخمینی از زمان آماده شدن order برای pickup را ذخیره می‌کند. The Ticket class دارای چندین field است که تاریخچه order را ردیابی می‌کند، از جمله acceptTime، preparingTime و pickupTime. بیایید به methods از این class نگاهی بیندازیم.
  </p>
<h4><strong style="color:darkblue">BEHAVIOR OF THE TICKET AGGREGATE</strong></h4>
<p>
   The Ticket aggregate چندین methods را تعریف می‌کند. همانطور که قبلاً دیدید، دارای یک method static به نام create() است، که یک factory method است که یک Ticket را ایجاد می‌کند. همچنین برخی methods وجود دارد که زمانی که رستوران، state از order را update می‌کند، فراخوانی می‌شوند:
  </p>
<ul>
<li>
    accept()—رستوران order را پذیرفته است.
   </li>
<li>
    preparing()—رستوران آماده‌سازی order را شروع کرده است، به این معنی که order دیگر نمی‌تواند تغییر یا لغو شود.
   </li>
<li>
    readyForPickup()—اکنون می‌توان order را pickup کرد.
   </li>
</ul>
<p>
   listing زیر، برخی از methods آن را نشان می‌دهد.
  </p>
<p>
   Listing 5.10
   <br/>
   Part of the Ticket class, which is a JPA entity
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0200_original/original_page.png" alt="Original Page 200">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Kitchen Service business logic</strong></h3>
<pre><code class="language-java">public class Ticket {
public static ResultWithAggregateEvents&lt;Ticket, TicketDomainEvent&gt;
create(Long id, TicketDetails details) {
return new ResultWithAggregateEvents&lt;&gt;(new Ticket(id, details), new
TicketCreatedEvent(id, details));
}
public List&lt;TicketPreparationStartedEvent&gt; preparing() {
switch (state) {
case ACCEPTED:
this.state = TicketState.PREPARING;
this.preparingTime = ZonedDateTime.now();
return singletonList(new TicketPreparationStartedEvent());
default:
throw new UnsupportedStateTransitionException(state);
}
}
public List&lt;TicketDomainEvent&gt; cancel() {
switch (state) {
case CREATED:
case ACCEPTED:
this.state = TicketState.CANCELLED;
return singletonList(new TicketCancelled());
case READY_FOR_PICKUP:
throw new TicketCannotBeCancelledException();
default:
throw new UnsupportedStateTransitionException(state);
}
}
</code></pre>
<p>
   The create() method یک Ticket را ایجاد می‌کند. The preparing() method زمانی فراخوانی می‌شود که رستوران، آماده‌سازی order را شروع می‌کند. این، state از order را به PREPARING تغییر می‌دهد، زمان را ثبت می‌کند و یک event را منتشر می‌کند. The cancel() method زمانی فراخوانی می‌شود که یک user تلاش می‌کند یک order را لغو کند. اگر لغو مجاز باشد، این method، state از order را تغییر می‌دهد و یک event را برمی‌گرداند. در غیر این صورت، یک exception را throw می‌کند. این methods در پاسخ به REST API requests و همچنین events و command messages فراخوانی می‌شوند. بیایید به classهایی که method از aggregate را فراخوانی می‌کنند، نگاهی بیندازیم.
  </p>
<h4><strong style="color:darkblue">THE KITCHENSERVICE DOMAIN SERVICE</strong></h4>
<p>
   KitchenService توسط inbound adapters از service فراخوانی می‌شود. این methodsهای مختلفی را برای تغییر state از یک order تعریف می‌کند، از جمله accept()، reject()، preparing() و موارد دیگر. هر method aggregate مشخص شده را بارگذاری می‌کند، method مربوطه را در aggregate root فراخوانی می‌کند و هر domain events را منتشر می‌کند. listing زیر، method accept() آن را نشان می‌دهد.
  </p>
<p>
   Listing 5.11
   <br/>
   Some of the Ticket's methods
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0201_original/original_page.png" alt="Original Page 201">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 5: طراحی منطق کسب‌وکار در معماری microservice</strong></h3>
<pre><code class="language-java">public class KitchenService {
@Autowired
private TicketRepository ticketRepository;
@Autowired
private TicketDomainEventPublisher domainEventPublisher;
public void accept(long ticketId, ZonedDateTime readyBy) {
Ticket ticket =
ticketRepository.findById(ticketId)
.orElseThrow(() -&gt;
new TicketNotFoundException(ticketId));
List&lt;TicketDomainEvent&gt; events = ticket.accept(readyBy);
domainEventPublisher.publish(ticket, events);
}
</code></pre>
<p>
   method به نام accept() زمانی فراخوانی می‌شود که رستوران یک order جدید را می‌پذیرد. این دو پارامتر دارد:
  </p>
<ul>
<li>
    orderId—ID از order برای پذیرفتن
   </li>
<li>
    readyBy—زمان تخمینی که order برای pickup آماده خواهد شد
   </li>
</ul>
<p>
   این method، Ticket aggregate را بازیابی می‌کند و method به نام accept() از آن را فراخوانی می‌کند. این هر event تولید شده را منتشر می‌کند.
  </p>
<p>
   اکنون بیایید به class که commands asynchronous را handle می‌کند، نگاهی بیندازیم.
  </p>
<h4><strong style="color:darkblue">THE KITCHENSERVICECOMMANDHANDLER CLASS</strong></h4>
<p>
   The KitchenServiceCommandHandler class یک adapter است که مسئول handling command messages ارسال شده توسط sagasهای مختلف پیاده‌سازی شده توسط Order Service است. این class یک handler method را برای هر command تعریف می‌کند، که KitchenService را برای ایجاد یا update کردن یک Ticket فراخوانی می‌کند. listing زیر، بخشی از این class را نشان می‌دهد.
  </p>
<pre><code class="language-java">public class KitchenServiceCommandHandler {
@Autowired
private KitchenService kitchenService;
public CommandHandlers commandHandlers() {
return CommandHandlersBuilder
.fromChannel("orderService")
.onMessage(CreateTicket.class, this::createTicket)
.onMessage(ConfirmCreateTicket.class,
this::confirmCreateTicket)
</code></pre>
<p>
   Listing 5.12
   <br/>
   The service’s accept() method updates Ticket
  </p>
<p>
   Listing 5.13
   <br/>
   Handling command messages sent by sagas
  </p>
<p>
   Publish
   <br/>
   domain
   <br/>
   events
   <br/>
   Maps command messages
   <br/>
   to message handlers
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0202_original/original_page.png" alt="Original Page 202">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Order Service business logic</strong></h3>
<pre><code class="language-java">.onMessage(CancelCreateTicket.class,
this::cancelCreateTicket)
.build();
}
private Message createTicket(CommandMessage&lt;CreateTicket&gt;
cm) {
CreateTicket command = cm.getCommand();
long restaurantId = command.getRestaurantId();
Long ticketId = command.getOrderId();
TicketDetails ticketDetails =
command.getTicketDetails();
try {
Ticket ticket =
kitchenService.createTicket(restaurantId,
ticketId, ticketDetails);
CreateTicketReply reply =
new CreateTicketReply(ticket.getId());
return withSuccess(reply);
} catch (RestaurantDetailsVerificationException e) {
return withFailure();
}
}
private Message confirmCreateTicket
(CommandMessage&lt;ConfirmCreateTicket&gt; cm) {
Long ticketId = cm.getCommand().getTicketId();
kitchenService.confirmCreateTicket(ticketId);
return withSuccess();
}
...
</code></pre>
<p>
   All the command handler methods، KitchenService را فراخوانی می‌کنند و با یک success یا یک failure reply پاسخ می‌دهند.
  </p>
<p>
   اکنون که شما business logic را برای یک service نسبتاً ساده دیدید، ما به یک مثال پیچیده‌تر نگاهی می‌اندازیم: Order Service.
  </p>
<h4><strong style="color:darkblue">5.5: Order Service business logic</strong></h4>
<p>
   همانطور که در فصل‌های قبل ذکر شد، Order Service یک API را برای ایجاد، update کردن و لغو orders فراهم می‌کند. این API در درجه اول توسط consumer فراخوانی می‌شود. شکل 5.12 طراحی سطح بالای service را نشان می‌دهد. The Order aggregate، aggregate مرکزی از Order Service است. اما همچنین یک Restaurant aggregate وجود دارد که یک replica جزئی از داده‌های متعلق به Restaurant Service است. این Order Service را قادر می‌سازد تا line items از یک Order را اعتبارسنجی و قیمت‌گذاری کند.
  </p>
<p>
   علاوه بر aggregates به نام Order و Restaurant، business logic شامل OrderService، OrderRepository، RestaurantRepository و sagasهای مختلف مانند CreateOrderSaga است که در فصل 4 توضیح داده شد. OrderService نقطه ورودی اصلی به business logic است و methods را برای ایجاد و update کردن Orders تعریف می‌کند.
  </p>
<p>
   Invokes KitchenService
   <br/>
   to create the Ticket
   <br/>
   Sends back a
   <br/>
   successful reply
   <br/>
   Sends back a
   <br/>
   failure reply
   <br/>
   Confirms
   <br/>
   the order
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0203_original/original_page.png" alt="Original Page 203">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 5: طراحی منطق کسب‌وکار در معماری microservice</strong></h3>
<p>
   و Restaurants. OrderRepository methods را برای persist کردن Orders تعریف می‌کند و RestaurantRepository methods را برای persist کردن Restaurants دارد. Order Service چندین inbound adapter دارد:
  </p>
<ul>
<li>
    REST API—The REST API که توسط user interface که توسط consumers استفاده می‌شود، فراخوانی می‌شود. این OrderService را برای ایجاد و update کردن Orders فراخوانی می‌کند.
   </li>
</ul>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMz
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0204_original/original_page.png" alt="Original Page 204">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Order Service business logic</strong></h3>
<ul>
<li>
    OrderEventConsumer—به events منتشر شده توسط Restaurant Service مشترک می‌شود. این OrderService را برای ایجاد و update کردن replica از Restaurants فراخوانی می‌کند.
   </li>
<li>
    OrderCommandHandlers—The asynchronous request/response-based API که توسط sagas فراخوانی می‌شود. این OrderService را برای update کردن Orders فراخوانی می‌کند.
   </li>
<li>
    SagaReplyAdapter—به کانال‌های saga reply مشترک می‌شود و sagas را فراخوانی می‌کند.
   </li>
</ul>
<p>
   The service همچنین دارای برخی outbound adapters است:
  </p>
<ul>
<li>
    DB adapter—The OrderRepository interface را پیاده‌سازی می‌کند و به database از Order Service دسترسی دارد.
   </li>
<li>
    DomainEventPublishingAdapter—The DomainEventPublisher interface را پیاده‌سازی می‌کند و Order domain events را منتشر می‌کند
   </li>
<li>
    OutboundCommandMessageAdapter—The CommandPublisher interface را پیاده‌سازی می‌کند و command messages را به شرکت‌کنندگان saga ارسال می‌کند
   </li>
</ul>
<p>
   بیایید ابتدا نگاهی دقیق‌تر به Order aggregate بیندازیم و سپس OrderService را بررسی کنیم.
  </p>
<h4><strong style="color:darkblue">5.5.1: The Order Aggregate</strong></h4>
<p>
   The Order aggregate نشان‌دهنده یک order است که توسط یک consumer ثبت شده است. ما ابتدا به ساختار از Order aggregate نگاهی می‌اندازیم و سپس methods آن را بررسی می‌کنیم.
  </p>
<h4><strong style="color:darkblue">THE STRUCTURE OF THE ORDER AGGREGATE</strong></h4>
<p>
   شکل 5.13 ساختار از Order aggregate را نشان می‌دهد. The Order class، root از Order aggregate است. The Order aggregate همچنین از value objects مانند OrderLineItem، DeliveryInfo و PaymentInfo تشکیل شده است.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMm
 
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0205_original/original_page.png" alt="Original Page 205">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 5: طراحی منطق کسب‌وکار در معماری microservice</strong></h3>
<p>
   The Order class یک collection از OrderLineItems دارد. از آنجایی که Consumer و Restaurant از Order، دیگر aggregates هستند، آنها را با primary key value ارجاع می‌دهد. The Order class یک class به نام DeliveryInfo دارد، که آدرس تحویل و زمان تحویل مورد نظر را ذخیره می‌کند، و یک PaymentInfo، که اطلاعات پرداخت را ذخیره می‌کند. listing زیر کد را نشان می‌دهد.
  </p>
<pre><code class="language-java">@Entity
@Table(name="orders")
@Access(AccessType.FIELD)
public class Order {
@Id
@GeneratedValue
private Long id;
@Version
private Long version;
private OrderState state;
private Long consumerId;
private Long restaurantId;
@Embedded
private OrderLineItems orderLineItems;
@Embedded
private DeliveryInformation deliveryInformation;
@Embedded
private PaymentInformation paymentInformation;
@Embedded
private Money orderMinimum;
</code></pre>
<p>
   این class با JPA persist می‌شود و به جدول ORDERS mapped می‌شود. field به نام id، primary key است. field به نام version برای optimistic locking استفاده می‌شود. state از یک Order توسط enumeration به نام OrderState نشان داده می‌شود. fields به نام DeliveryInformation و PaymentInformation با استفاده از annotation به نام @Embedded mapped شده‌اند و به عنوان columns از جدول ORDERS ذخیره می‌شوند. field به نام orderLineItems یک object است که شامل order line items است. The Order aggregate فقط از fields تشکیل نشده است. همچنین business logic را پیاده‌سازی می‌کند که می‌تواند توسط یک state machine توصیف شود. بیایید نگاهی به state machine بیندازیم.
  </p>
<h4><strong style="color:darkblue">THE ORDER AGGREGATE STATE MACHINE</strong></h4>
<p>
   به منظور ایجاد یا update کردن یک order، Order Service باید با services دیگر با استفاده از sagas همکاری کند. یا OrderService یا اولین گام از saga یک method از Order را فراخوانی می‌کند که تأیید می‌کند که operation می‌تواند انجام شود و state از Order را به یک state pending تغییر می‌دهد. یک state pending، همانطور که در فصل 4 توضیح داده شد، نمونه‌ای از
  </p>
<p>
   Listing 5.14
   <br/>
   The Order class and its fields
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0206_original/original_page.png" alt="Original Page 206">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Order Service business logic</strong></h3>
<p>
   یک semantic lock countermeasure است، که به اطمینان از اینکه sagas از یکدیگر جدا شده‌اند، کمک می‌کند. در نهایت، هنگامی که saga، servicesهای شرکت‌کننده را فراخوانی کرد، سپس Order را update می‌کند تا نتیجه را منعکس کند. به عنوان مثال، همانطور که در فصل 4 توضیح داده شد، the Create Order Saga دارای چندین service شرکت‌کننده است، از جمله Consumer Service، Accounting Service و Kitchen Service. OrderService ابتدا یک Order را در یک state به نام APPROVAL_PENDING ایجاد می‌کند و سپس بعداً state آن را به APPROVED یا REJECTED تغییر می‌دهد. رفتار یک Order را می‌توان به عنوان state machine نشان داده شده در شکل 5.14 مدل‌سازی کرد.
  </p>
<p>
   به طور مشابه، عملیات‌های دیگر Order Service مانند revise() و cancel() ابتدا Order را به یک state pending تغییر می‌دهند و از یک saga برای تأیید اینکه operation می‌تواند انجام شود، استفاده می‌کنند. سپس، هنگامی که saga تأیید کرد که operation می‌تواند انجام شود، آن را به برخی دیگر از stateها که نتیجه موفقیت‌آمیز operation را منعکس می‌کند، تغییر می‌دهد. اگر verification از operation شکست خورد، Order به state قبلی برمی‌گردد. به عنوان مثال، operation به نام cancel() ابتدا Order را به state به نام CANCEL_PENDING انتقال می‌دهد. اگر order را می‌توان لغو کرد، the Cancel Order Saga، state از Order را به state به نام CANCELLED تغییر می‌دهد. در غیر این صورت، اگر یک operation به نام cancel() رد شود زیرا، به عنوان مثال، برای لغو order خیلی دیر شده است، سپس Order به state به نام APPROVED برمی‌گردد.
  </p>
<p>
   اجازه دهید اکنون به این نکته نگاهی بیندازیم که چگونه Order aggregate این state machine را پیاده‌سازی می‌کند.
  </p>
<h4><strong style="color:darkblue">THE ORDER AGGREGATE’S METHODS</strong></h4>
<p>
   The Order class دارای چندین گروه از methods است که هر کدام با یک saga مطابقت دارند. در هر گروه، یک method در ابتدای saga فراخوانی می‌شود و methodsهای دیگر در انتها فراخوانی می‌شوند. من ابتدا business logic را که یک Order ایجاد می‌کند، مورد بحث قرار می‌دهم. پس از آن ما به نحوه update شدن یک Order نگاهی خواهیم انداخت. listing زیر، methods از Order را نشان می‌دهد که در طول فرآیند ایجاد یک Order فراخوانی می‌شوند.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMm
 
 
 &lt;/div&gt;
 
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0207_original/original_page.png" alt="Original Page 207">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 5: طراحی منطق کسب‌وکار در معماری microservice</strong></h3>
<pre><code class="language-java">public class Order { ...
public static ResultWithDomainEvents&lt;Order, OrderDomainEvent&gt;
createOrder(long consumerId, Restaurant restaurant,
List&lt;OrderLineItem&gt; orderLineItems) {
Order order = new Order(consumerId, restaurant.getId(), orderLineItems);
List&lt;OrderDomainEvent&gt; events = singletonList(new OrderCreatedEvent(
new OrderDetails(consumerId, restaurant.getId(), orderLineItems,
order.getOrderTotal()),
restaurant.getName()));
return new ResultWithDomainEvents&lt;&gt;(order, events);
}
public Order(OrderDetails orderDetails) {
this.orderLineItems = new OrderLineItems(orderDetails.getLineItems());
this.orderMinimum = orderDetails.getOrderMinimum();
this.state = APPROVAL_PENDING;
}
...
public List&lt;DomainEvent&gt; noteApproved() {
switch (state) {
case APPROVAL_PENDING:
this.state = APPROVED;
return singletonList(new OrderAuthorized());
...
default:
throw new UnsupportedStateTransitionException(state);
}
}
public List&lt;DomainEvent&gt; noteRejected() {
switch (state) {
case APPROVAL_PENDING:
this.state = REJECTED;
return singletonList(new OrderRejected());
...
default:
throw new UnsupportedStateTransitionException(state);
}
}
</code></pre>
<p>
   The createOrder() method، یک static factory method است که یک Order را ایجاد می‌کند و یک OrderCreatedEvent را منتشر می‌کند. The OrderCreatedEvent با جزئیات از Order، از جمله line items، total amount، restaurant ID و restaurant name غنی شده است. فصل 7 در مورد چگونگی استفاده Order History Service از Order events، از جمله OrderCreatedEvent، برای حفظ یک replica از Orders که به راحتی query می‌شود، بحث می‌کند.
  </p>
<p>
   Listing 5.15
   <br/>
   The methods that are invoked during order creation
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0208_original/original_page.png" alt="Original Page 208">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Order Service business logic</strong></h3>
<p>
   The initial state از Order، APPROVAL_PENDING است. هنگامی که the CreateOrderSaga تکمیل شد، noteApproved() یا noteRejected() را فراخوانی می‌کند. method به نام noteApproved() زمانی فراخوانی می‌شود که کارت اعتباری consumer با موفقیت authorized شده باشد. method به نام noteRejected() زمانی فراخوانی می‌شود که یکی از services، order یا authorization را رد کند. همانطور که می‌بینید، state از Order aggregate رفتار از بیشتر methodsهای آن را تعیین می‌کند. مانند Ticket aggregate، همچنین events را emit می‌کند.
  </p>
<p>
   علاوه بر createOrder()، the Order class چندین methods update را تعریف می‌کند. به عنوان مثال، the Revise Order Saga یک order را با فراخوانی method به نام revise() و سپس، هنگامی که تأیید شد که revision می‌تواند انجام شود، با فراخوانی method به نام confirmRevised() revises می‌کند. listing زیر این methods را نشان می‌دهد.
  </p>
<pre><code class="language-java">class Order ...
public List&lt;OrderDomainEvent&gt; revise(OrderRevision orderRevision) {
switch (state) {
case APPROVED:
LineItemQuantityChange change =
orderLineItems.lineItemQuantityChange(orderRevision);
if (change.newOrderTotal.isGreaterThanOrEqual(orderMinimum)) {
throw new OrderMinimumNotMetException();
}
this.state = REVISION_PENDING;
return singletonList(new OrderRevisionProposed(orderRevision,
change.currentOrderTotal, change.newOrderTotal));
default:
throw new UnsupportedStateTransitionException(state);
}
}
public List&lt;OrderDomainEvent&gt; confirmRevision(OrderRevision orderRevision) {
switch (state) {
case REVISION_PENDING:
LineItemQuantityChange licd =
orderLineItems.lineItemQuantityChange(orderRevision);
orderRevision
.getDeliveryInformation()
.ifPresent(newDi -&gt; this.deliveryInformation = newDi);
if (!orderRevision.getRevisedLineItemQuantities().isEmpty()) {
orderLineItems.updateLineItems(orderRevision);
}
this.state = APPROVED;
return singletonList(new OrderRevised(orderRevision,
licd.currentOrderTotal, licd.newOrderTotal));
</code></pre>
<p>
   Listing 5.16
   <br/>
   The Order method for revising an Order
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0209_original/original_page.png" alt="Original Page 209">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 5: طراحی منطق کسب‌وکار در معماری microservice</strong></h3>
<pre><code class="language-java">default:
throw new UnsupportedStateTransitionException(state);
}
}
</code></pre>
<p>
   method به نام revise() برای شروع revision از یک order فراخوانی می‌شود. در میان چیزهای دیگر، تأیید می‌کند که order revised، minimum order را نقض نمی‌کند و state از order را به REVISION_PENDING تغییر می‌دهد. هنگامی که Revise Order Saga با موفقیت، Kitchen Service و Accounting Service را update کرد، سپس confirmRevision() را فراخوانی می‌کند تا revision را تکمیل کند.
  </p>
<p>
   این methods توسط OrderService فراخوانی می‌شوند. بیایید نگاهی به آن class بیندازیم.
  </p>
<h4><strong style="color:darkblue">5.5.2: The OrderService class</strong></h4>
<p>
   The OrderService class methods را برای ایجاد و update کردن Orders تعریف می‌کند. این main entry point به business logic است و توسط inbound adaptersهای مختلف، مانند REST API فراخوانی می‌شود. بیشتر methods آن یک saga را برای هماهنگ کردن ایجاد و update کردن Order aggregates ایجاد می‌کنند. در نتیجه، این service پیچیده‌تر از class به نام KitchenService است که قبلاً مورد بحث قرار گرفت. listing زیر، بخشی از این class را نشان می‌دهد. OrderService با وابستگی‌های مختلف، از جمله OrderRepository، OrderDomainEventPublisher و چندین saga managers تزریق می‌شود. این چندین methods را تعریف می‌کند، از جمله createOrder() و reviseOrder().
  </p>
<pre><code class="language-java">@Transactional
public class OrderService {
@Autowired
private OrderRepository orderRepository;
@Autowired
private SagaManager&lt;CreateOrderSagaState, CreateOrderSagaState&gt;
createOrderSagaManager;
@Autowired
private SagaManager&lt;ReviseOrderSagaState, ReviseOrderSagaData&gt;
reviseOrderSagaManagement;
@Autowired
private OrderDomainEventPublisher orderAggregateEventPublisher;
public Order createOrder(OrderDetails orderDetails) {
Restaurant restaurant = restaurantRepository.findById(restaurantId)
.orElseThrow(() -&gt;
new RestaurantNotFoundException(restaurantId));
</code></pre>
<p>
   Listing 5.17
   <br/>
   The OrderService class has methods for creating and managing orders
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0210_original/original_page.png" alt="Original Page 210">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Order Service business logic</strong></h3>
<pre><code class="language-java">List&lt;OrderLineItem&gt; orderLineItems =
makeOrderLineItems(lineItems, restaurant);
ResultWithDomainEvents&lt;Order, OrderDomainEvent&gt; orderAndEvents =
Order.createOrder(consumerId, restaurant, orderLineItems);
Order order = orderAndEvents.result;
orderRepository.save(order);
orderAggregateEventPublisher.publish(order, orderAndEvents.events);
OrderDetails orderDetails =
new OrderDetails(consumerId, restaurantId, orderLineItems,
order.getOrderTotal());
CreateOrderSagaState data = new CreateOrderSagaState(order.getId(),
orderDetails);
createOrderSagaManager.create(data, Order.class, order.getId());
return order;
}
public Order reviseOrder(Long orderId, Long expectedVersion,
OrderRevision orderRevision)
{
public Order reviseOrder(long orderId, OrderRevision orderRevision) {
Order order = orderRepository.findById(orderId)
.orElseThrow(() -&gt; new OrderNotFoundException(orderId));
ReviseOrderSagaData sagaData =
new ReviseOrderSagaData(order.getConsumerId(), orderId,
null, orderRevision);
reviseOrderSagaManager.create(sagaData);
return order;
}
}
</code></pre>
<p>
   method createOrder() ابتدا یک Order aggregate را ایجاد و persist می‌کند. سپس domain eventsهای منتشر شده توسط aggregate را منتشر می‌کند. در نهایت، یک CreateOrderSaga ایجاد می‌کند. The reviseOrder() Order را بازیابی می‌کند و سپس یک ReviseOrderSaga را ایجاد می‌کند.
  </p>
<p>
   از بسیاری جهات، business logic برای یک application مبتنی بر microservices، آنچنان متفاوت از business logic از یک monolithic application نیست. این شامل classهایی مانند services، JPA-backed entities و repositories است. با این حال، برخی از تفاوت‌ها وجود دارد. یک domain model به عنوان یک مجموعه از DDD aggregates سازماندهی شده است که محدودیت‌های طراحی مختلفی را تحمیل می‌کند. برخلاف یک object model سنتی، references بین classes در aggregates مختلف، بر حسب primary key value است تا object references. همچنین، یک transaction فقط می‌تواند یک aggregate را ایجاد یا update کند. همچنین برای aggregates مفید است که domain events را هنگام تغییر state خود منتشر کنند.
  </p>
<p>
   یکی دیگر از تفاوت‌های اصلی این است که services اغلب از sagas برای حفظ data consistency در سراسر چندین service استفاده می‌کنند. به عنوان مثال، Kitchen Service صرفاً در sagas مشارکت می‌کند، آن را آغاز نمی‌کند. در مقابل، Order Service به شدت به sagas متکی است، زمانی که
  </p>
<p>
   Creates the Order
   <br/>
   aggregate
   <br/>
   Persists the Order
   <br/>
   in the database
   <br/>
   Publishes
   <br/>
   domain
   <br/>
   events
   <br/>
   Creates the Create
   <br/>
   Order Saga
   <br/>
   Retrieves
   <br/>
   the Order
   <br/>
   Creates the
   <br/>
   Revise Order
   <br/>
   Saga
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0211_original/original_page.png" alt="Original Page 211">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 5: طراحی منطق کسب‌وکار در معماری microservice</strong></h3>
<p>
   ایجاد و update کردن orders است. این به این دلیل است که Orders باید به صورت transactional با data متعلق به services دیگر سازگار باشند. در نتیجه، اکثر methods از OrderService یک saga ایجاد می‌کنند، نه اینکه یک Order را مستقیماً update کنند.
  </p>
<p>
   این فصل نحوه پیاده‌سازی business logic با استفاده از یک رویکرد سنتی برای persistence را پوشش داده است. این امر شامل ادغام messaging و event publishing با مدیریت transaction از database می‌شود. کد event publishing با business logic در هم آمیخته است. فصل بعد به event sourcing نگاهی می‌اندازد، یک رویکرد event-centric برای نوشتن business logic که در آن event generation جدایی‌ناپذیر از business logic است، نه اینکه اضافه شود.
  </p>
<p>
   Summary
  </p>
<ul>
<li>الگوی procedural Transaction script اغلب یک راه خوب برای پیاده‌سازی business logic ساده است. اما هنگام پیاده‌سازی business logic پیچیده، باید استفاده از الگوی object-oriented Domain model را در نظر بگیرید.</li>
<li>یک راه خوب برای سازماندهی business logic از یک service به عنوان مجموعه‌ای از DDD aggregates است. DDD aggregates مفید هستند زیرا domain model را ماژولار می‌کنند، امکان object reference بین services را از بین می‌برند و اطمینان می‌دهند که هر ACID transaction در داخل یک service است.</li>
<li>یک aggregate باید domain events را هنگامی که ایجاد یا update می‌شود، منتشر کند. domain events کاربردهای گسترده‌ای دارند. فصل 4 در مورد چگونگی پیاده‌سازی choreography-based sagas بحث می‌کند. و، در فصل 7، من در مورد نحوه استفاده از domain events برای update کردن replicated data صحبت می‌کنم. مشترکین domain event همچنین می‌توانند users و applicationsهای دیگر را مطلع کنند و WebSocket messages را به مرورگر user منتشر کنند.</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0212_original/original_page.png" alt="Original Page 212">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Developing business logic with event sourcing</strong></h3>
<p>
   Mary از ایده، که در فصل 5 توضیح داده شد، ساختاربندی business logic را به عنوان مجموعه‌ای از DDD aggregates که domain events را منتشر می‌کنند، خوشش آمد. او می‌توانست استفاده از آن events را در یک معماری microservice بسیار مفید تصور کند. Mary قصد داشت از events برای پیاده‌سازی choreography-based sagas استفاده کند، که data consistency را در سراسر services حفظ می‌کنند و در فصل 4 توضیح داده شده‌اند. او همچنین انتظار داشت از CQRS views استفاده کند، replicas که از querying کارآمد پشتیبانی می‌کنند و در فصل 7 توضیح داده شده‌اند.
  </p>
<p>
   با این حال، او نگران بود که منطق event publishing ممکن است مستعد خطا باشد.
  </p>
<p>
   از یک طرف، منطق event publishing منطقاً ساده است. هر یک از methods از یک aggregate که state از aggregate را initialize یا تغییر می‌دهد، یک list از events را برمی‌گرداند. سپس domain service آن events را منتشر می‌کند. اما از طرف دیگر
  </p>
<p>
   این فصل پوشش می‌دهد
  </p>
<ul>
<li>Using the Event sourcing pattern to develop business logic</li>
<li>Implementing an event store</li>
<li>Integrating sagas and event sourcing-based business logic</li>
<li>Implementing saga orchestrators using event sourcing</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0213_original/original_page.png" alt="Original Page 213">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 6: Developing business logic with event sourcing</strong></h3>
<p>
   از طرف دیگر، منطق event publishing به business logic متصل شده است. business logic حتی زمانی که developer فراموش می‌کند یک event را منتشر کند، به کار خود ادامه می‌دهد. Mary نگران بود که این روش انتشار events ممکن است منبعی از bugs باشد.
  </p>
<p>
   سال‌ها پیش، Mary در مورد event sourcing، یک روش event-centric برای نوشتن business logic و persist کردن domain objects، یاد گرفته بود. در آن زمان او با مزایای متعدد آن، از جمله چگونگی حفظ تاریخچه کامل از تغییرات در یک aggregate، مجذوب شده بود، اما این فقط یک کنجکاوی بود. با توجه به اهمیت domain events در معماری microservice، او اکنون تعجب می‌کند که آیا استفاده از event sourcing در application FTGO ارزشمند خواهد بود یا خیر. از این گذشته، event sourcing یک منبع از خطاهای برنامه‌نویسی را با تضمین اینکه یک event، هر زمان که یک aggregate ایجاد یا update می‌شود، منتشر می‌شود، حذف می‌کند.
  </p>
<p>
   من این فصل را با توصیف نحوه عملکرد event sourcing و چگونگی استفاده از آن برای نوشتن business logic آغاز می‌کنم. من توضیح می‌دهم که چگونه event sourcing هر aggregate را به عنوان یک sequence از events در آنچه که به عنوان event store شناخته می‌شود، persist می‌کند. من در مورد مزایا و معایب event sourcing بحث می‌کنم و نحوه پیاده‌سازی یک event store را پوشش می‌دهم. من یک framework ساده را برای نوشتن business logic مبتنی بر event sourcing توضیح می‌دهم. پس از آن، من در مورد چگونگی event sourcing به عنوان یک پایه خوب برای پیاده‌سازی sagas بحث می‌کنم. بیایید با نگاهی به نحوه توسعه business logic با event sourcing شروع کنیم.
  </p>
<h4><strong style="color:darkblue">6.1: Developing business logic using event sourcing</strong></h4>
<p>
   Event sourcing یک روش متفاوت برای ساختاربندی business logic و persist کردن aggregates است. یک aggregate را به عنوان یک sequence از events persist می‌کند. هر event نشان‌دهنده یک state change از aggregate است. یک application، state فعلی از یک aggregate را با replaying the events بازسازی می‌کند.
  </p>
<p>
   Event sourcing چندین مزیت مهم دارد. به عنوان مثال، تاریخچه aggregates را حفظ می‌کند، که برای اهداف auditing و regulatory ارزشمند است. و به طور قابل‌اعتمادی domain events را منتشر می‌کند، که به ویژه در یک معماری microservice مفید است.
  </p>
<p>
   Event sourcing همچنین معایبی دارد. این شامل یک learning curve می‌شود، زیرا یک روش متفاوت برای نوشتن business logic شما است. همچنین، querying the event store اغلب دشوار است، که نیاز دارد شما از pattern به نام CQRS، که در فصل 7 توضیح داده شد، استفاده کنید.
  </p>
<p>
   من این بخش را با توصیف محدودیت‌های persistence سنتی شروع می‌کنم. سپس event sourcing را با جزئیات شرح می‌دهم و در مورد چگونگی غلبه بر آن محدودیت‌ها صحبت می‌کنم.
  </p>
<p>
   بعد از آن، من نشان می‌دهم که چگونه Order aggregate را با استفاده از event sourcing پیاده‌سازی کنم. در نهایت، من مزایا و معایب event sourcing را شرح می‌دهم.
  </p>
<p>
   بیایید ابتدا به محدودیت‌های رویکرد سنتی برای persistence نگاهی بیندازیم.
  </p>
<p>
   Pattern: Event sourcing
   <br/>
   Persist an aggregate as a sequence of domain events that represent state changes.
   <br/>
   See http://microservices.io/patterns/data/event-sourcing.html.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0214_original/original_page.png" alt="Original Page 214">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Developing business logic using event sourcing</strong></h3>
<h4><strong style="color:darkblue">6.1.1: The trouble with traditional persistence</strong></h4>
<p>
   رویکرد سنتی برای persistence، classes را به database tables، fields از آن classes را به table columns و instances از آن classes را به rows در آن tables map می‌کند. به عنوان مثال، شکل 6.1 نشان می‌دهد که چگونه Order aggregate، که در فصل 5 توضیح داده شد، به جدول ORDER map می‌شود. OrderLineItems آن به جدول ORDER_LINE_ITEM map شده است.
  </p>
<p>
   application یک order instance را به عنوان rows در جداول ORDER و ORDER_LINE_ITEM persist می‌کند. این ممکن است با استفاده از یک ORM framework مانند JPA یا یک framework سطح پایین‌تر مانند MyBATIS این کار را انجام دهد.
  </p>
<p>
   این رویکرد به وضوح خوب عمل می‌کند زیرا اکثر applications سازمانی داده‌ها را به این روش ذخیره می‌کنند. اما چندین نقطه ضعف و محدودیت دارد:
  </p>
<ul>
<li>Object-Relational impedance mismatch.</li>
<li>Lack of aggregate history.</li>
<li>Implementing audit logging is tedious and error prone.</li>
<li>Event publishing is bolted on to the business logic.</li>
</ul>
<p>
   بیایید به هر یک از این مشکلات نگاهی بیندازیم، با مشکل Object-Relational impedance mismatch شروع می‌کنیم.
  </p>
<h4><strong style="color:darkblue">OBJECT-RELATIONAL IMPEDANCE MISMATCH</strong></h4>
<p>
   یک مشکل قدیمی، مشکل به اصطلاح Object-Relational impedance mismatch است. یک conceptual mismatch اساسی بین schema relational جدولی و ساختار graph از یک domain model غنی با روابط پیچیده آن وجود دارد.
  </p>
<p>
   برخی از جنبه‌های این مشکل در بحث‌های قطبی شده در مورد مناسب بودن Object/Relational mapping (ORM) frameworks منعکس شده است. به عنوان مثال، Ted Neward گفته است که "Object-Relational mapping، ویتنام از Computer Science است" (http://blogs.tedneward.com/post/the-vietnam-of-computer-science/). برای منصفانه بودن، من از
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMz
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0215_original/original_page.png" alt="Original Page 215">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 6: Developing business logic with event sourcing</strong></h3>
<p>
   Hibernate با موفقیت برای توسعه applications که در آن database schema از object model مشتق شده است، به کار می‌رود. اما مشکلات عمیق‌تر از محدودیت‌های هر ORM framework خاص هستند.
  </p>
<h4><strong style="color:darkblue">LACK OF AGGREGATE HISTORY</strong></h4>
<p>
   یکی دیگر از محدودیت‌های persistence سنتی این است که تنها state فعلی از یک aggregate را ذخیره می‌کند. هنگامی که یک aggregate update شد، state قبلی آن از بین می‌رود. اگر یک application باید تاریخچه از یک aggregate را حفظ کند، شاید برای اهداف regulatory، سپس developers باید این mechanism را خودشان پیاده‌سازی کنند. پیاده‌سازی یک mechanism از aggregate history زمان‌بر است و شامل تکرار کد است که باید با business logic همگام‌سازی شود.
  </p>
<h4><strong style="color:darkblue">IMPLEMENTING AUDIT LOGGING IS TEDIOUS AND ERROR PRONE</strong></h4>
<p>
   یک مشکل دیگر audit logging است. بسیاری از applications باید یک audit log را حفظ کنند که ردیابی می‌کند که کدام users، یک aggregate را تغییر داده‌اند. برخی از applications، auditing را برای اهداف security یا regulatory نیاز دارند. در applicationsهای دیگر، تاریخچه از user actions یک ویژگی مهم است. به عنوان مثال، issue trackers و task-management applications مانند Asana و JIRA تاریخچه از تغییرات به tasks و issues را نشان می‌دهند. چالش پیاده‌سازی auditing این است که علاوه بر اینکه یک وظیفه زمان‌بر است، کد auditing logging و business logic می‌توانند واگرا شوند، که منجر به bugs می‌شود.
  </p>
<h4><strong style="color:darkblue">EVENT PUBLISHING IS BOLTED ON TO THE BUSINESS LOGIC</strong></h4>
<p>
   یکی دیگر از محدودیت‌های persistence سنتی این است که معمولاً از انتشار domain events پشتیبانی نمی‌کند. domain events، که در فصل 5 مورد بحث قرار گرفت، eventsهایی هستند که توسط یک aggregate هنگامی که state آن تغییر می‌کند، منتشر می‌شوند. آنها یک mechanism مفید برای همگام‌سازی data و ارسال notifications در معماری microservice هستند. برخی از ORM frameworks، مانند Hibernate، می‌توانند application-provided callbacks را هنگامی که data objects تغییر می‌کنند، فراخوانی کنند.
  </p>
<p>
   اما هیچ پشتیبانی برای انتشار خودکار messages به عنوان بخشی از transaction که data را update می‌کند، وجود ندارد. در نتیجه، همانند تاریخچه و auditing، developers باید منطق event-generation را متصل کنند، که خطر عدم همگام‌سازی با business logic را دارد. خوشبختانه، یک راه‌حل برای این مشکلات وجود دارد: event sourcing.
  </p>
<h4><strong style="color:darkblue">6.1.2: Overview of event sourcing</strong></h4>
<p>
   Event sourcing یک تکنیک event-centric برای پیاده‌سازی business logic و persist کردن aggregates است. یک aggregate در database به عنوان یک series از events ذخیره می‌شود. هر event نشان‌دهنده یک state change از aggregate است. business logic از یک aggregate حول requirement برای تولید و مصرف این events ساختار یافته است. بیایید ببینیم چگونه این کار می‌کند.
  </p>
<h4><strong style="color:darkblue">EVENT SOURCING PERSISTS AGGREGATES USING EVENTS</strong></h4>
<p>
   قبلاً، در بخش 6.1.1، من در مورد چگونگی map کردن aggregates به tables، fieldsهای آنها به columns و instances آنها به rows، در persistence سنتی بحث کردم. Event sourcing یک رویکرد بسیار متفاوت برای persist کردن aggregates است که بر اساس مفهوم domain events ساخته شده است. این، هر aggregate را به عنوان یک sequence از events در database، که به عنوان event store شناخته می‌شود، persist می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0216_original/original_page.png" alt="Original Page 216">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Developing business logic using event sourcing</strong></h3>
<p>
   به عنوان مثال، Order aggregate را در نظر بگیرید. همانطور که شکل 6.2 نشان می‌دهد، event sourcing، به جای ذخیره هر Order به عنوان یک row در یک جدول به نام ORDER، هر Order aggregate را به عنوان یک یا چند row در یک جدول به نام EVENTS persist می‌کند. هر row، یک domain event است، مانند Order Created، Order Approved، Order Shipped و غیره.
  </p>
<p>
   هنگامی که یک application یک aggregate را ایجاد یا update می‌کند، events منتشر شده توسط aggregate را به جدول EVENTS درج می‌کند. یک application یک aggregate را از event store با بازیابی events آن و replaying آنها بارگذاری می‌کند. به طور خاص، بارگذاری یک aggregate شامل سه مرحله زیر است:
  </p>
<ol>
<li>Load the events for the aggregate.</li>
<li>Create an aggregate instance by using its default constructor.</li>
<li>Iterate through the events, calling apply().</li>
</ol>
<p>
   به عنوان مثال، فریم‌ورک Eventuate Client، که بعداً در بخش 6.2.2 پوشش داده می‌شود، از کدی شبیه به موارد زیر برای بازسازی یک aggregate استفاده می‌کند:
  </p>
<pre><code class="language-java">Class aggregateClass = ...;
Aggregate aggregate = aggregateClass.newInstance();
for (Event event : events) {
aggregate = aggregate.applyEvent(event);
}
// use aggregate...
</code></pre>
<p>
   این یک instance از class ایجاد می‌کند و events را تکرار می‌کند، با فراخوانی method applyEvent() از aggregate. اگر شما با functional programming آشنا هستید، ممکن است این را به عنوان یک fold یا reduce operation بشناسید.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMz
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0217_original/original_page.png" alt="Original Page 217">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 6: Developing business logic with event sourcing</strong></h3>
<p>
   به عنوان مثال، Order aggregate را در نظر بگیرید. همانطور که شکل 6.2 نشان می‌دهد، به جای ذخیره هر Order به عنوان یک row در یک جدول به نام ORDER، event sourcing، هر Order aggregate را به عنوان یک یا چند row در یک جدول به نام EVENTS persist می‌کند. هر row، یک domain event است، مانند Order Created، Order Approved، Order Shipped و غیره.
  </p>
<p>
   هنگامی که یک application یک aggregate را ایجاد یا update می‌کند، events منتشر شده توسط aggregate را به جدول EVENTS درج می‌کند. یک application یک aggregate را از event store با بازیابی events آن و replaying آنها بارگذاری می‌کند. به طور خاص، بارگذاری یک aggregate شامل سه مرحله زیر است:
  </p>
<ol>
<li>Load the events for the aggregate.</li>
<li>Create an aggregate instance by using its default constructor.</li>
<li>Iterate through the events, calling apply().</li>
</ol>
<p>
   به عنوان مثال، فریم‌ورک Eventuate Client، که بعداً در بخش 6.2.2 پوشش داده می‌شود، از کدی شبیه به موارد زیر برای بازسازی یک aggregate استفاده می‌کند:
  </p>
<pre><code class="language-java">Class aggregateClass = ...;
Aggregate aggregate = aggregateClass.newInstance();
for (Event event : events) {
aggregate = aggregate.applyEvent(event);
}
// use aggregate...
</code></pre>
<p>
   این یک instance از class ایجاد می‌کند و events را تکرار می‌کند، با فراخوانی method applyEvent() از aggregate. اگر شما با functional programming آشنا هستید، ممکن است این را به عنوان یک fold یا reduce operation بشناسید.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMz
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0218_original/original_page.png" alt="Original Page 218">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Developing business logic using event sourcing</strong></h3>
<h4><strong style="color:darkblue">AGGREGATE METHODS ARE ALL ABOUT EVENTS</strong></h4>
<p>
   business logic یک request را برای update کردن یک aggregate با فراخوانی یک command method روی aggregate root handle می‌کند. در یک application سنتی، یک command method معمولاً آرگومان‌های خود را validate می‌کند و سپس یک یا چند field از aggregate را update می‌کند. Command methods در یک application مبتنی بر event sourcing کار می‌کنند زیرا آنها باید events را generate کنند. همانطور که شکل 6.4 نشان می‌دهد، نتیجه فراخوانی یک command method از یک aggregate، یک sequence از events است که state changes که باید انجام شوند را نشان می‌دهد. این events در database persist می‌شوند و برای update کردن state آن، به aggregate اعمال می‌شوند.
  </p>
<p>
   requirement برای generate کردن events و apply کردن آنها، یک restructuring – اگرچه mechanical - از business logic را ضروری می‌سازد. Event sourcing یک command method را به دو یا چند method refactor می‌کند. اولین method، یک پارامتر به نام command object را می‌گیرد که نشان‌دهنده request است و تعیین می‌کند که چه state changesهایی باید انجام شود. این آرگومان‌های خود را validate می‌کند و بدون تغییر state از aggregate، یک list از events را که نشان‌دهنده state changesها هستند، برمی‌گرداند. این method معمولاً یک exception را throw می‌کند اگر command نتواند انجام شود.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMz
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0219_original/original_page.png" alt="Original Page 219">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 6: Developing business logic with event sourcing</strong></h3>
<p>
   methodsهای دیگر، هر کدام یک event type خاص را به عنوان یک پارامتر می‌گیرند و aggregate را update می‌کنند. برای هر event، یک method از این نوع وجود دارد. مهم است که توجه داشته باشید که این methodsها نمی‌توانند fail شوند، زیرا یک event نشان‌دهنده یک state change است که اتفاق افتاده است. هر method، aggregate را بر اساس event update می‌کند.
  </p>
<p>
   فریم‌ورک Eventuate Client، یک فریم‌ورک event-sourcing که با جزئیات بیشتر در بخش 6.2.2 توضیح داده شده است، نام این methodsها را process() و apply() می‌گذارد. یک method به نام process()، یک command object را می‌گیرد، که حاوی arguments از update request است، به عنوان یک پارامتر و یک list از events را برمی‌گرداند. یک method به نام apply()، یک event را به عنوان یک پارامتر می‌گیرد و void برمی‌گرداند. یک aggregate، نسخه‌های overloaded متعددی از این methods را تعریف می‌کند: یک method به نام process() برای هر command class و یک method به نام apply() برای هر event type منتشر شده توسط aggregate. شکل 6.5 یک نمونه را نشان می‌دهد.
  </p>
<p>
   Returns events without updating the Order
   <br/>
   Applies events to update the Order
  </p>
<pre><code class="language-java">public class Order {
public List&lt;Event&gt; process(ReviseOrder command) {
OrderRevision orderRevision = command.getOrderRevision();
switch (state) {
case AUTHORIZED:
LineItemQuantityChange change =
orderLineItems.lineItemQuantityChange(orderRevision);
if (change.newOrderTotal.isGreaterThanOrEqual(orderMinimum)) {
throw new OrderMinimumNotMetException();
}
return singletonList(
new OrderRevisionProposed(
orderRevision, change.currentOrderTotal,
change.newOrderTotal));
default:
throw new UnsupportedStateTransitionException(state);
}
}
public class Order {
public void apply(OrderRevisionProposed event) {
this.state = REVISION_PENDING;
}
</code></pre>
<pre><code class="language-java">public class Order {
public List&lt;DomainEvent&gt; revise(OrderRevision orderRevision) {
switch (state) {
case AUTHORIZED:
LineItemQuantityChange change =
orderLineItems.lineItemQuantityChange(orderRevision);
if (change.newOrderTotal.isGreaterThanOrEqual(orderMinimum)) {
throw new OrderMinimumNotMetException();
}
this.state = REVISION_PENDING;
return …;
default:
throw new UnsupportedStateTransitionException(state);
}
}
</code></pre>
<p>
   Figure 6.5
   <br/>
   Event sourcing splits a method that updates an aggregate into a process() method, which takes a command and returns events, and one or more apply() methods, which take an event and update the aggregate.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0220_original/original_page.png" alt="Original Page 220">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Developing business logic using event sourcing</strong></h3>
<p>
   در این مثال، method به نام reviseOrder() با یک method به نام process() و یک method به نام apply() جایگزین می‌شود. method به نام process()، یک command به نام ReviseOrder را به عنوان یک پارامتر می‌گیرد. این class command با اعمال Introduce Parameter Object refactoring (https://refactoring.com/catalog/introduceParameterObject.html) به method به نام reviseOrder() تعریف می‌شود. method به نام process() یا یک event به نام OrderRevisionProposed را برمی‌گرداند، یا اگر برای revision از Order خیلی دیر شده باشد یا اگر revision پیشنهادی، minimum order را برآورده نکند، یک exception را throw می‌کند. method به نام apply() برای event به نام OrderRevisionProposed، state از Order را به REVISION_PENDING تغییر می‌دهد.
  </p>
<p>
   یک aggregate با استفاده از مراحل زیر ایجاد می‌شود:
  </p>
<ol>
<li>Instantiate aggregate root using its default constructor.</li>
<li>Invoke process() to generate the new events.</li>
<li>Update the aggregate by iterating through the new events, calling its apply().</li>
<li>Save the new events in the event store.</li>
</ol>
<p>
   یک aggregate با استفاده از مراحل زیر update می‌شود:
  </p>
<ol>
<li>Load aggregate’s events from the event store.</li>
<li>Instantiate the aggregate root using its default constructor.</li>
<li>Iterate through the loaded events, calling apply() on the aggregate root.</li>
<li>Invoke its process() method to generate new events.</li>
<li>Update the aggregate by iterating through the new events, calling apply().</li>
<li>Save the new events in the event store.</li>
</ol>
<p>
   برای دیدن این موارد در عمل، بیایید اکنون به نسخه event sourcing از Order aggregate نگاهی بیندازیم.
  </p>
<h4><strong style="color:darkblue">EVENT SOURCING-BASED ORDER AGGREGATE</strong></h4>
<p>
   Listing 6.1 fields از Order aggregate و methods آن را که مسئول ایجاد آن هستند، نشان می‌دهد. نسخه event sourcing از Order aggregate شباهت‌هایی به نسخه مبتنی بر JPA که در فصل 5 نشان داده شده است، دارد. fields آن تقریباً یکسان هستند و events مشابهی را منتشر می‌کند. آنچه متفاوت است این است که business logic آن بر حسب processing commands که events را emit می‌کنند و applying those events، که state آن را update می‌کند، پیاده‌سازی شده است.
  </p>
<p>
   هر method که aggregate مبتنی بر JPA را ایجاد یا update می‌کند، مانند createOrder() و reviseOrder()، در نسخه event sourcing توسط methods به نام process() و apply() جایگزین می‌شود.
  </p>
<pre><code class="language-java">public class Order {
private OrderState state;
private Long consumerId;
private Long restaurantId;
private OrderLineItems orderLineItems;
private DeliveryInformation deliveryInformation;
private PaymentInformation paymentInformation;
private Money orderMinimum;
</code></pre>
<p>
   Listing 6.1
   <br/>
   The Order aggregate’s fields and its methods that initialize an instance
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0221_original/original_page.png" alt="Original Page 221">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 6: Developing business logic with event sourcing</strong></h3>
<pre><code class="language-java">public Order() {
}
public List&lt;Event&gt; process(CreateOrderCommand command) {
... validate command ...
return events(new OrderCreatedEvent(command.getOrderDetails()));
}
public void apply(OrderCreatedEvent event) {
OrderDetails orderDetails = event.getOrderDetails();
this.orderLineItems = new OrderLineItems(orderDetails.getLineItems());
this.orderMinimum = orderDetails.getOrderMinimum();
this.state = APPROVAL_PENDING;
}
</code></pre>
<p>
   fieldsهای این class شبیه به fieldsهای Order مبتنی بر JPA هستند. تنها تفاوت این است که id از aggregate در aggregate ذخیره نمی‌شود. methods از Order کاملاً متفاوت هستند. the createOrder() factory method با methods به نام process() و apply() جایگزین شده است. method به نام process() یک command به نام CreateOrder را می‌گیرد و یک event به نام OrderCreated را emit می‌کند. method به نام apply()، OrderCreated را می‌گیرد و fields از Order را initialize می‌کند.
  </p>
<p>
   ما اکنون به business logic کمی پیچیده‌تر برای revising یک order نگاهی خواهیم انداخت. قبلاً این business logic از سه method تشکیل شده بود: reviseOrder()، confirmRevision() و rejectRevision(). نسخه event sourcing این سه method را با سه method به نام process() و برخی از methods به نام apply() جایگزین می‌کند. listing زیر، نسخه event sourcing از reviseOrder() و confirmRevision() را نشان می‌دهد.
  </p>
<pre><code class="language-java">public class Order {
public List&lt;Event&gt; process(ReviseOrder command) {
OrderRevision orderRevision = command.getOrderRevision();
switch (state) {
case APPROVED:
LineItemQuantityChange change =
orderLineItems.lineItemQuantityChange(orderRevision);
if (change.newOrderTotal.isGreaterThanOrEqual(orderMinimum)) {
throw new OrderMinimumNotMetException();
}
return singletonList(new OrderRevisionProposed(orderRevision,
change.currentOrderTotal, change.newOrderTotal));
default:
throw new UnsupportedStateTransitionException(state);
}
}
public void apply(OrderRevisionProposed event) {
this.state = REVISION_PENDING;
}
</code></pre>
<p>
   Listing 6.2
   <br/>
   The process() and apply() methods that revise an Order aggregate
  </p>
<p>
   Validates the command and
   <br/>
   returns an OrderCreatedEvent
   <br/>
   Apply the OrderCreatedEvent by
   <br/>
   initializing the fields of the Order.
  </p>
<p>
   Verify that the Order
   <br/>
   can be revised and
   <br/>
   that the revised
   <br/>
   order meets the
   <br/>
   order minimum.
   <br/>
   Change the state of the Order
   <br/>
   to REVISION_PENDING.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0222_original/original_page.png" alt="Original Page 222">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Developing business logic using event sourcing</strong></h3>
<pre><code class="language-java">public List&lt;Event&gt; process(ConfirmReviseOrder command) {
OrderRevision orderRevision = command.getOrderRevision();
switch (state) {
case REVISION_PENDING:
LineItemQuantityChange licd =
orderLineItems.lineItemQuantityChange(orderRevision);
return singletonList(new OrderRevised(orderRevision,
licd.currentOrderTotal, licd.newOrderTotal));
default:
throw new UnsupportedStateTransitionException(state);
}
}
public void apply(OrderRevised event) {
OrderRevision orderRevision = event.getOrderRevision();
if (!orderRevision.getRevisedLineItemQuantities().isEmpty()) {
orderLineItems.updateLineItems(orderRevision);
}
this.state = APPROVED;
}
</code></pre>
<p>
   همانطور که می‌بینید، هر method با یک method به نام process() و یک یا چند method به نام apply() جایگزین شده است. method به نام reviseOrder() با process (ReviseOrder) و apply(OrderRevisionProposed) جایگزین شده است. به طور مشابه، confirmRevision() با process(ConfirmReviseOrder) و apply(OrderRevised) جایگزین شده است.
  </p>
<h4><strong style="color:darkblue">6.1.3: Handling concurrent updates using optimistic locking</strong></h4>
<p>
   غیر معمول نیست که دو یا چند request به طور همزمان، همان aggregate را update کنند. یک application که از persistence سنتی استفاده می‌کند، اغلب از optimistic locking برای جلوگیری از بازنویسی تغییرات از یک transaction توسط transaction دیگر استفاده می‌کند. Optimistic locking معمولاً از یک version column برای تشخیص اینکه آیا یک aggregate از زمانی که خوانده شده است، تغییر کرده است یا خیر، استفاده می‌کند. application، aggregate root را به یک جدول که دارای یک VERSION column است، map می‌کند، که هر زمان که aggregate update می‌شود، increment می‌شود. application aggregate را با استفاده از یک عبارت UPDATE مانند این update می‌کند:
  </p>
<p>
   UPDATE AGGREGATE_ROOT_TABLE
   <br/>
   SET VERSION = VERSION + 1 ...
   <br/>
   WHERE VERSION = &lt;original version&gt;
  </p>
<p>
   این عبارت UPDATE فقط در صورتی موفق خواهد بود که version از زمانی که application، aggregate را خوانده است، تغییر نکرده باشد. اگر دو transactions، همان aggregate را بخوانند، اولین موردی که aggregate را update می‌کند، موفق خواهد بود. دومی fail خواهد شد زیرا شماره version تغییر کرده است، بنابراین به طور تصادفی تغییرات از اولین transaction را بازنویسی نمی‌کند.
  </p>
<p>
   یک event store همچنین می‌تواند از optimistic locking برای handling concurrent updates استفاده کند. هر aggregate instance دارای یک version است که همراه با events خوانده می‌شود. هنگامی که application events را درج می‌کند، event store تأیید می‌کند که version تغییر نکرده است. یک
  </p>
<p>
   Verify that the
   <br/>
   revision can be
   <br/>
   confirmed and
   <br/>
   return an Order-
   <br/>
   Revised event.
   <br/>
   Revise the
   <br/>
   Order.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0223_original/original_page.png" alt="Original Page 223">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 6: Developing business logic with event sourcing</strong></h3>
<p>
   در این مثال، روش استفاده از تعداد events به عنوان شماره version است. از طرف دیگر، همانطور که در زیر در بخش 6.2 خواهید دید، یک event store می‌تواند یک شماره version صریح را حفظ کند.
  </p>
<h4><strong style="color:darkblue">6.1.4: Event sourcing و انتشار events</strong></h4>
<p>
   از نظر دقیق، event sourcing، aggregates را به عنوان events persist می‌کند و state فعلی از یک aggregate را از آن events بازسازی می‌کند. شما همچنین می‌توانید از event sourcing به عنوان یک mechanism reliable event publishing استفاده کنید. ذخیره یک event در event store یک operation ذاتی atomic است. ما باید یک mechanism را برای تحویل تمام events persisted به consumersهای علاقه‌مند پیاده‌سازی کنیم.
  </p>
<p>
   فصل 3 در مورد چندین mechanism متفاوت—polling و transaction log tailing—برای publish کردن messages که به عنوان بخشی از یک transaction به database درج می‌شوند، توضیح می‌دهد. یک application مبتنی بر event sourcing می‌تواند events را با استفاده از یکی از این mechanisms منتشر کند. تفاوت اصلی این است که events را به طور دائم در یک جدول به نام EVENTS ذخیره می‌کند، نه اینکه به طور موقت events را در یک جدول به نام OUTBOX ذخیره کند و سپس آنها را حذف کند. بیایید به هر رویکرد نگاهی بیندازیم، با polling شروع می‌کنیم.
  </p>
<h4><strong style="color:darkblue">USING POLLING TO PUBLISH EVENTS</strong></h4>
<p>
   اگر events در جدول EVENTS که در شکل 6.6 نشان داده شده است، ذخیره شوند، یک event publisher می‌تواند table را برای events جدید با اجرای یک عبارت SELECT poll کند و events را به یک message broker منتشر کند. چالش این است که تعیین کنیم کدام events جدید هستند. به عنوان مثال، تصور کنید که eventIds به طور یکنواخت در حال افزایش هستند. رویکردی که به نظر جذاب می‌رسد این است که event publisher، آخرین eventId را که پردازش کرده است، ثبت کند. سپس events جدید را با استفاده از یک query مانند این بازیابی می‌کند: SELECT * FROM EVENTS where event_id &gt; ? ORDER BY event_id ASC.
  </p>
<p>
   مشکل این رویکرد این است که transactions می‌توانند به ترتیبی متفاوت از ترتیبی که در آن events را generate می‌کنند، commit شوند. در نتیجه، event publisher می‌تواند به طور تصادفی از روی یک event رد شود. شکل 6.6 چنین سناریویی را نشان می‌دهد.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzM2MzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMz
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0224_original/original_page.png" alt="Original Page 224">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Developing business logic using event sourcing</strong></h3>
<p>
   در این سناریو، Transaction A یک event با یک EVENT_ID به مقدار 1010 درج می‌کند. در مرحله بعد، transaction B یک event با یک EVENT_ID به مقدار 1020 درج می‌کند و سپس commit می‌شود. اگر event publisher اکنون table به نام EVENTS را query کند، event 1020 را پیدا می‌کند. بعداً، پس از اینکه transaction A commit شد و event 1010 قابل مشاهده شد، event publisher آن را ignore می‌کند.
  </p>
<p>
   یک راه‌حل برای این مشکل این است که یک column اضافی را به جدول EVENTS اضافه کنیم که ردیابی می‌کند که آیا یک event منتشر شده است یا خیر. event publisher سپس از فرآیند زیر استفاده می‌کند:
  </p>
<ol>
<li>Find unpublished events by executing this SELECT statement: SELECT * FROM EVENTS where PUBLISHED = 0 ORDER BY event_id ASC.</li>
<li>Publish events to the message broker.</li>
<li>Mark the events as having been published: UPDATE EVENTS SET PUBLISHED = 1 WHERE EVENT_ID in.</li>
</ol>
<p>
   این رویکرد از رد شدن events توسط event publisher جلوگیری می‌کند.
  </p>
<h4><strong style="color:darkblue">USING TRANSACTION LOG TAILING TO RELIABLY PUBLISH EVENTS</strong></h4>
<p>
   Event storesهای پیچیده‌تر از transaction log tailing استفاده می‌کنند، که، همانطور که فصل 3 توضیح می‌دهد، تضمین می‌کند که events منتشر می‌شوند و همچنین عملکرد و مقیاس‌پذیری بیشتری دارد.
  </p>
<p>
   به عنوان مثال، Eventuate Local، یک event store منبع باز، از این رویکرد استفاده می‌کند. این events را که به جدول EVENTS از database transaction log درج شده‌اند، می‌خواند و آنها را به message broker منتشر می‌کند. بخش 6.2 نحوه عملکرد Eventuate Local را با جزئیات بیشتر مورد بحث قرار می‌دهد.
  </p>
<h4><strong style="color:darkblue">6.1.5: Using snapshots to improve performance</strong></h4>
<p>
   یک Order aggregate دارای state transitions نسبتاً کمی است، بنابراین فقط تعداد کمی event دارد. query کردن event store برای آن events و بازسازی یک Order aggregate کارآمد است. با این حال، aggregates با عمر طولانی، می‌توانند تعداد زیادی event داشته باشند. به عنوان مثال، یک Account aggregate به طور بالقوه تعداد زیادی event دارد. با گذشت زمان، بارگذاری و fold کردن آن events به طور فزاینده‌ای ناکارآمد می‌شود.
  </p>
<p>
   یک راه‌حل رایج، persist کردن دوره‌ای یک snapshot از state از aggregate است. شکل 6.7 یک نمونه از استفاده از یک snapshot را نشان می‌دهد. application state را از
  </p>
<p>
   The application only needs
   <br/>
   to retrieve the snapshot and
   <br/>
   events that occur after it.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMozz&lt;/p&gt;
  &lt;p&gt;
   The Order aggregate, when in state S
  &lt;/p&gt;
  &lt;p&gt;
   Figure 6.3
   &lt;br&gt;
   Applying event E
   &lt;br&gt;
   when the Order is in state S
   &lt;br&gt;
   must change the Order state to
   &lt;br&gt;
   S'. The event must contain the
   &lt;br&gt;
   data necessary to perform the
   &lt;br&gt;
   state change.
  &lt;/p&gt;
  &lt;p&gt;
   Figure 6.4
   &lt;br&gt;
   Processing a command
   &lt;br&gt;
   generates events without changing
   &lt;br&gt;
   the state of the aggregate. An
   &lt;br&gt;
   aggregate is updated by applying
   &lt;br&gt;
   an event.
  &lt;/p&gt;
 &lt;/div&gt;
 
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0225_original/original_page.png" alt="Original Page 225">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 6: Developing business logic with event sourcing</strong></h3>
<p>
   یک aggregate با بارگذاری recent snapshot و فقط آن events که از زمان ایجاد snapshot رخ داده‌اند، بازسازی می‌کند.
  </p>
<p>
   در این مثال، snapshot version، N است. application فقط نیاز دارد که snapshot و دو events را که بعد از آن آمده‌اند، بارگذاری کند تا state از aggregate را بازیابی کند. N events قبلی از event store بارگذاری نمی‌شوند.
  </p>
<p>
   هنگام بازیابی state از یک aggregate از یک snapshot، یک application ابتدا یک instance از aggregate را از snapshot ایجاد می‌کند و سپس events را تکرار می‌کند و آنها را apply می‌کند. به عنوان مثال، فریم‌ورک Eventuate Client، که در بخش 6.2.2 توضیح داده شده است، از کدی شبیه به موارد زیر برای بازسازی یک aggregate استفاده می‌کند:
  </p>
<pre><code class="language-java">Class aggregateClass = ...;
Snapshot snapshot = ...;
Aggregate aggregate = recreateFromSnapshot(aggregateClass, snapshot);
for (Event event : events) {
aggregate = aggregate.applyEvent(event);
}
// use aggregate...
</code></pre>
<p>
   هنگام استفاده از snapshots، instance از aggregate از snapshot، به جای اینکه با استفاده از default constructor آن ایجاد شود، بازسازی می‌شود. اگر یک aggregate دارای یک ساختار ساده و به راحتی قابل serializable است، snapshot می‌تواند، به عنوان مثال، serialization از نوع JSON آن باشد. aggregatesهای پیچیده‌تر می‌توانند با استفاده از pattern به نام Memento (https://en.wikipedia.org/wiki/Memento_pattern) snapshotted شوند.
  </p>
<p>
   The Customer aggregate در مثال فروشگاه آنلاین دارای یک ساختار بسیار ساده است: اطلاعات customer، credit limit و credit reservations آنها. یک snapshot از Customer، serialization از نوع JSON از state آن است. شکل 6.8 نحوه بازسازی یک Customer از یک snapshot را که با state از یک Customer از event #103 مطابقت دارد، نشان می‌دهد. The Customer Service نیاز دارد که snapshot و events را که بعد از event #103 رخ داده‌اند، بارگذاری کند.
  </p>
<p>
   The Customer Service، Customer را با deserializing JSON از snapshot و سپس بارگذاری و apply کردن events #104 تا #106 بازسازی می‌کند.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMx/
   &lt;br&gt;
   The Customer Service recreates the Customer by deserializing the snapshot’s JSON and then
   loading and applying events #104 through #106.
  &lt;/p&gt;
  &lt;p&gt;
   event_id
   &lt;br&gt;
   ...
   &lt;br&gt;
   103
   &lt;br&gt;
   104
   &lt;br&gt;
   105
   &lt;br&gt;
   106
   &lt;br&gt;
   EVENTS
   &lt;br&gt;
   event_type
   &lt;br&gt;
   ...
   &lt;br&gt;
   ...
   &lt;br&gt;
   Credit
   &lt;br&gt;
   Reserved
   &lt;br&gt;
   Address
   &lt;br&gt;
   Changed
   &lt;br&gt;
   Credit
   &lt;br&gt;
   Reserved
   &lt;br&gt;
   entity_type
   &lt;br&gt;
   ...
   &lt;br&gt;
   Customer
   &lt;br&gt;
   Customer
   &lt;br&gt;
   Customer
   &lt;br&gt;
   Customer
   &lt;br&gt;
   entity_id
   &lt;br&gt;
   ...
   &lt;br&gt;
   101
   &lt;br&gt;
   101
   &lt;br&gt;
   101
   &lt;br&gt;
   101
   &lt;br&gt;
   event_data
   &lt;br&gt;
   ...
   &lt;br&gt;
   {...}
   &lt;br&gt;
   {...}
   &lt;br&gt;
   {...}
   &lt;br&gt;
   {...}
   &lt;br&gt;
   ...
   &lt;br&gt;
   Unique event ID
   &lt;br&gt;
   The type of the event
   &lt;br&gt;
   Identiﬁes the aggregate
   &lt;br&gt;
   The serialized event,
   &lt;br&gt;
   such as JSON
  &lt;/p&gt;
  &lt;p&gt;
   Figure 6.8
   &lt;br&gt;
   The Customer Service recreates the Customer by deserializing the snapshot’s JSON and then
   loading and applying events #104 through #106.
  &lt;/p&gt;
 &lt;/div&gt;
 
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0226_original/original_page.png" alt="Original Page 226">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Developing business logic with event sourcing</strong></h3>
<h4><strong style="color:darkblue">6.1.6: Idempotent message processing</strong></h4>
<p>
   Services اغلب messages را از applicationsهای دیگر یا servicesهای دیگر consume می‌کنند. یک service ممکن است، به عنوان مثال، domain events منتشر شده توسط aggregates یا command messages ارسال شده توسط یک saga orchestrator را consume کند. همانطور که در فصل 3 توضیح داده شد، یک issue مهم هنگام developing یک message consumer این است که اطمینان حاصل شود که idempotent است، زیرا یک message broker ممکن است همان message را چندین بار تحویل دهد.
  </p>
<p>
   یک message consumer idempotent است اگر بتواند با خیال راحت با همان message چندین بار فراخوانی شود. به عنوان مثال، فریم‌ورک Eventuate Tram، message handling idempotent را با تشخیص و دور انداختن messagesهای تکراری پیاده‌سازی می‌کند. این، ids از messagesهای پردازش شده را در یک جدول به نام PROCESSED_MESSAGES به عنوان بخشی از local ACID transaction که توسط business logic برای ایجاد یا update کردن aggregates استفاده می‌شود، ثبت می‌کند. اگر ID از یک message در جدول PROCESSED_MESSAGES باشد، این یک duplicate است و می‌تواند دور انداخته شود. business logic مبتنی بر event sourcing باید یک mechanism معادل را پیاده‌سازی کند. نحوه انجام این کار بستگی به این دارد که آیا event store از یک RDBMS یا یک NoSQL database استفاده می‌کند.
  </p>
<h4><strong style="color:darkblue">IDEMPOTENT MESSAGE PROCESSING WITH AN RDBMS-BASED EVENT STORE</strong></h4>
<p>
   اگر یک application از یک event store مبتنی بر RDBMS استفاده می‌کند، می‌تواند از یک رویکرد یکسان برای تشخیص و دور انداختن messagesهای تکراری استفاده کند. ID از message را به عنوان بخشی از transaction که events را به جدول EVENTS درج می‌کند، در جدول PROCESSED_MESSAGES درج می‌کند.
  </p>
<h4><strong style="color:darkblue">IDEMPOTENT MESSAGE PROCESSING WHEN USING A NOSQL-BASED EVENT STORE</strong></h4>
<p>
   یک event store مبتنی بر NoSQL، که دارای یک transaction model محدود است، باید از یک mechanism متفاوت برای پیاده‌سازی idempotent message handling استفاده کند. یک message consumer، باید به نوعی events را به صورت atomic persist کند و ID از message را ثبت کند. خوشبختانه، یک راه‌حل ساده وجود دارد. یک message consumer، ID از message را در events که در حین processing آن generate می‌شوند، ذخیره می‌کند. این duplicateها را با تأیید اینکه هیچ یک از events از یک aggregate، ID از message را شامل نمی‌شود، تشخیص می‌دهد.
  </p>
<p>
   یک چالش با استفاده از این رویکرد این است که processing یک message ممکن است هیچ eventای را generate نکند. کمبود events به این معنی است که هیچ رکوردی از یک message که پردازش شده است، وجود ندارد. یک redelivery بعدی و reprocessing از همان message ممکن است منجر به رفتار نادرست شود. به عنوان مثال، سناریوی زیر را در نظر بگیرید:
  </p>
<ol>
<li>Message A is processed but doesn’t update an aggregate.</li>
<li>Message B is processed, and the message consumer updates the aggregate.</li>
<li>Message A is redelivered, and because there’s no record of it having been processed, the message consumer updates the aggregate.</li>
<li>Message B is processed again….</li>
</ol>
<p>
   در این سناریو، redelivery از events منجر به یک نتیجه متفاوت و احتمالاً اشتباه می‌شود.
  </p>
<p>
   یک راه برای اجتناب از این مشکل این است که همیشه یک event را منتشر کنید. اگر یک aggregate یک event را emit نمی‌کند، یک application، یک pseudo event را منحصراً برای ثبت ID از message ذخیره می‌کند. Event consumers باید این pseudo eventsها را ignore کنند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0227_original/original_page.png" alt="Original Page 227">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 6: Developing business logic with event sourcing</strong></h3>
<h4><strong style="color:darkblue">6.1.7: Evolving domain events</strong></h4>
<p>
   Event sourcing، حداقل از نظر مفهومی، events را برای همیشه ذخیره می‌کند - که یک شمشیر دولبه است. از یک طرف، یک audit log از تغییرات را به application فراهم می‌کند که دقیق بودن آن تضمین شده است. همچنین application را قادر می‌سازد تا state تاریخی از یک aggregate را بازسازی کند. از طرف دیگر، یک چالش ایجاد می‌کند، زیرا ساختار از events اغلب در طول زمان تغییر می‌کند.
  </p>
<p>
   یک application به طور بالقوه باید با multiple versions از events مقابله کند. به عنوان مثال، یک service که یک Order aggregate را بارگذاری می‌کند، به طور بالقوه نیاز دارد که multiple versions از events را fold کند. به طور مشابه، یک event subscriber به طور بالقوه ممکن است multiple versions را ببیند.
  </p>
<p>
   بیایید ابتدا به روش‌های مختلفی که events می‌توانند تغییر کنند نگاهی بیندازیم و سپس یک رویکرد معمولاً مورد استفاده را برای handling changes شرح خواهم داد.
  </p>
<h4><strong style="color:darkblue">EVENT SCHEMA EVOLUTION</strong></h4>
<p>
   از نظر مفهومی، یک application event sourcing دارای یک schema است که به سه سطح سازماندهی شده است:
  </p>
<ul>
<li>Consists of one or more aggregates</li>
<li>Defines the events that each aggregate emits</li>
<li>Defines the structure of the events</li>
</ul>
<p>
   جدول 6.1 انواع مختلف تغییراتی را نشان می‌دهد که می‌تواند در هر سطح رخ دهد.
  </p>
<p>
   این تغییرات به طور طبیعی با گذشت زمان با تکامل domain model از یک service رخ می‌دهند—به عنوان مثال، هنگامی که requirements از یک service تغییر می‌کند یا زمانی که developers از آن، بینش عمیق‌تری نسبت به یک domain به دست می‌آورند و domain model را بهبود می‌بخشند. در سطح schema، developers، aggregate classes را اضافه، حذف و rename می‌کنند. در سطح aggregate، انواع events
  </p>
<p>
   Table 6.1
   <br/>
   The different ways that an application’s events can evolve
  </p>
<p>
   Level
   <br/>
   Change
   <br/>
   Backward compatible
  </p>
<p>
   Schema
   <br/>
   Define a new aggregate type
   <br/>
   Yes
   <br/>
   Remove aggregate
   <br/>
   Remove an existing aggregate
   <br/>
   No
   <br/>
   Rename aggregate
   <br/>
   Change the name of an aggregate type
   <br/>
   No
   <br/>
   Aggregate
   <br/>
   Add a new event type
   <br/>
   Yes
   <br/>
   Remove event
   <br/>
   Remove an event type
   <br/>
   No
   <br/>
   Rename event
   <br/>
   Change the name of an event type
   <br/>
   No
   <br/>
   Event
   <br/>
   Add a new field
   <br/>
   Yes
   <br/>
   Delete field
   <br/>
   Delete a field
   <br/>
   No
   <br/>
   Rename field
   <br/>
   Rename a field
   <br/>
   No
   <br/>
   Change type of field
   <br/>
   Change the type of a field
   <br/>
   No
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0228_original/original_page.png" alt="Original Page 228">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Developing business logic using event sourcing</strong></h3>
<p>
   در این مثال، method به نام reviseOrder() با یک process() method و یک apply() method جایگزین می‌شود.
  </p>
<p>
   که توسط یک aggregate خاص منتشر می‌شود، می‌تواند تغییر کند. Developers می‌توانند ساختار از یک event type را با اضافه کردن، حذف کردن و تغییر نام یا نوع از یک field تغییر دهند.
  </p>
<p>
   خوشبختانه، بسیاری از این نوع تغییرات، تغییرات backward-compatible هستند. به عنوان مثال، اضافه کردن یک field به یک event بعید است که بر consumers تأثیر بگذارد. یک consumer، fieldsهای ناشناخته را نادیده می‌گیرد. اما سایر تغییرات، backward compatible نیستند. به عنوان مثال، تغییر نام از یک event یا نام از یک field نیاز دارد که consumers از آن event type تغییر کنند.
  </p>
<h4><strong style="color:darkblue">MANAGING SCHEMA CHANGES THROUGH UPCASTING</strong></h4>
<p>
   در دنیای SQL database، تغییرات به یک database schema معمولاً با استفاده از schema migrations مدیریت می‌شوند. هر schema change توسط یک migration نشان داده می‌شود، یک اسکریپت SQL که schema را تغییر می‌دهد و داده‌ها را به یک schema جدید منتقل می‌کند. schema migrations در یک version control system ذخیره می‌شوند و با استفاده از یک ابزار مانند Flyway به یک database اعمال می‌شوند.
  </p>
<p>
   یک application event sourcing می‌تواند از یک رویکرد مشابه برای handling non-backward-compatible changes استفاده کند. اما به جای migration events به نسخه جدید schema در situ، frameworks از event sourcing events را هنگام بارگذاری آنها از event store transform می‌کنند. یک component که معمولاً upcaster نامیده می‌شود، eventsهای جداگانه را از یک نسخه قدیمی به یک نسخه جدیدتر update می‌کند. در نتیجه، کد application فقط با schema event فعلی سروکار دارد.
  </p>
<p>
   اکنون که ما به نحوه عملکرد event sourcing نگاهی انداختیم، بیایید مزایا و معایب آن را در نظر بگیریم.
  </p>
<h4><strong style="color:darkblue">6.1.8: Benefits of event sourcing</strong></h4>
<p>
   Event sourcing دارای مزایا و معایبی است. مزایا عبارتند از:
  </p>
<ul>
<li>Reliably publishes domain events</li>
<li>Preserves the history of aggregates</li>
<li>Mostly avoids the O/R impedance mismatch problem</li>
<li>Provides developers with a time machine</li>
</ul>
<p>
   بیایید هر مزیت را با جزئیات بیشتری بررسی کنیم.
  </p>
<h4><strong style="color:darkblue">RELIABLY PUBLISHES DOMAIN EVENTS</strong></h4>
<p>
   یک مزیت اصلی از event sourcing این است که به طور قابل‌اعتمادی events را هر زمان که state از یک aggregate تغییر می‌کند، منتشر می‌کند. این یک پایه خوب برای معماری microservice event-driven است. همچنین، از آنجایی که هر event می‌تواند identity از user را که تغییر را ایجاد کرده است، ذخیره کند، event sourcing یک audit log را فراهم می‌کند که دقیق بودن آن تضمین شده است. stream از events می‌تواند برای اهداف مختلف دیگری، از جمله اطلاع‌رسانی به users، application integration، analytics و monitoring استفاده شود.
  </p>
<h4><strong style="color:darkblue">PRESERVES THE HISTORY OF AGGREGATES</strong></h4>
<p>
   یکی دیگر از مزایای event sourcing این است که کل تاریخچه از هر aggregate را ذخیره می‌کند. شما به راحتی می‌توانید temporal queries را پیاده‌سازی کنید که state گذشته از یک aggregate را بازیابی می‌کند. برای تعیین state از یک aggregate در یک نقطه زمانی معین، شما eventsها را fold می‌کنید
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0229_original/original_page.png" alt="Original Page 229">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 6: Developing business logic with event sourcing</strong></h3>
<p>
   که تا آن زمان رخ داده است، folding می‌کنید. به عنوان مثال، محاسبه اعتبار موجود از یک customer در یک مقطع زمانی در گذشته، آسان است.
  </p>
<h4><strong style="color:darkblue">MOSTLY AVOIDS THE O/R IMPEDANCE MISMATCH PROBLEM</strong></h4>
<p>
   Event sourcing، events را persist می‌کند نه aggregation آنها. Eventsها معمولاً یک ساختار ساده و به راحتی serializable دارند. همانطور که قبلاً ذکر شد، یک service می‌تواند یک aggregate complex را با serializing یک memento از state آن snapshot کند، که یک سطح از indirection را بین یک aggregate و representation serialized آن اضافه می‌کند.
  </p>
<h4><strong style="color:darkblue">PROVIDES DEVELOPERS WITH A TIME MACHINE</strong></h4>
<p>
   Event sourcing تاریخچه کاملی از هر آنچه در طول عمر یک application رخ داده است را ذخیره می‌کند. تصور کنید که developers از FTGO نیاز به پیاده‌سازی یک requirement جدید برای مشتریانی دارند که یک آیتم را به shopping cart خود اضافه کرده‌اند و سپس آن را حذف کرده‌اند. یک application سنتی این اطلاعات را حفظ نمی‌کرد، بنابراین فقط می‌توانست برای مشتریانی که آیتم‌ها را پس از پیاده‌سازی این ویژگی اضافه و حذف می‌کنند، بازاریابی کند. در مقابل، یک application مبتنی بر event sourcing می‌تواند بلافاصله برای مشتریانی که این کار را در گذشته انجام داده‌اند، بازاریابی کند. انگار event sourcing، developers را با یک time machine برای سفر به گذشته و پیاده‌سازی requirementsهای پیش‌بینی نشده فراهم می‌کند.
  </p>
<h4><strong style="color:darkblue">6.1.9: Drawbacks of event sourcing</strong></h4>
<p>
   Event sourcing یک silver bullet نیست. این معایب زیر را دارد:
  </p>
<ul>
<li>It has a different programming model that has a learning curve.</li>
<li>It has the complexity of a messaging-based application.</li>
<li>Evolving events can be tricky.</li>
<li>Deleting data is tricky.</li>
<li>Querying the event store is challenging.</li>
</ul>
<p>
   بیایید به هر معایب نگاهی بیندازیم.
  </p>
<h4><strong style="color:darkblue">DIFFERENT PROGRAMMING MODEL THAT HAS A LEARNING CURVE</strong></h4>
<p>
   این یک programming model متفاوت و ناآشنا است و این به معنای یک learning curve است.
  </p>
<p>
   به منظور اینکه یک application موجود از event sourcing استفاده کند، شما باید business logic آن را دوباره بنویسید. خوشبختانه، این یک transformation نسبتاً mechanical است که می‌توانید هنگام migration application خود به microservices انجام دهید.
  </p>
<h4><strong style="color:darkblue">COMPLEXITY OF A MESSAGING-BASED APPLICATION</strong></h4>
<p>
   یکی دیگر از معایب event sourcing این است که message brokers معمولاً at-least-once delivery را تضمین می‌کنند. Event handlers که idempotent نیستند، باید eventsهای duplicate را تشخیص داده و دور بریزند. فریم‌ورک event sourcing می‌تواند با اختصاص یک ID به طور یکنواخت در حال افزایش به هر event کمک کند. سپس یک event handler می‌تواند eventsهای تکراری را با ردیابی بالاترین ID event دیده شده، تشخیص دهد. حتی این اتفاق به طور خودکار زمانی رخ می‌دهد که event handlers aggregates را update می‌کنند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0230_original/original_page.png" alt="Original Page 230">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Developing business logic with event sourcing</strong></h3>
<h4><strong style="color:darkblue">EVOLVING EVENTS CAN BE TRICKY</strong></h4>
<p>
   با event sourcing، schema از events (و snapshots!) در طول زمان تکامل می‌یابد. از آنجایی که eventsها برای همیشه ذخیره می‌شوند، aggregates به طور بالقوه نیاز دارند که eventsها را که با multiple schema versions مطابقت دارند، fold کنند. یک خطر واقعی وجود دارد که aggregates ممکن است با کد برای رسیدگی به همه نسخه‌های مختلف، bloated شوند. همانطور که در بخش 6.1.7 ذکر شد، یک راه‌حل خوب برای این مشکل، ارتقای events به آخرین نسخه هنگام بارگذاری آنها از event store است. این رویکرد، کدی را که eventsها را از aggregate ارتقا می‌دهد، جدا می‌کند، که aggregatesها را ساده می‌کند زیرا آنها فقط نیاز دارند که آخرین نسخه از eventsها را apply کنند.
  </p>
<h4><strong style="color:darkblue">DELETING DATA IS TRICKY</strong></h4>
<p>
   از آنجایی که یکی از اهداف event sourcing، حفظ تاریخچه از aggregates است، به طور عمدی داده‌ها را برای همیشه ذخیره می‌کند. روش سنتی برای حذف داده‌ها هنگام استفاده از event sourcing این است که یک soft delete انجام دهید. یک application یک aggregate را با تنظیم یک deleted flag حذف می‌کند. aggregate معمولاً یک event به نام Deleted را emit می‌کند، که به هر consumer علاقه‌مند اطلاع می‌دهد. هر کدی که به آن aggregate دسترسی دارد می‌تواند flag را بررسی کند و بر این اساس عمل کند.
  </p>
<p>
   استفاده از یک soft delete برای بسیاری از انواع data خوب عمل می‌کند. با این حال، یک چالش، رعایت General Data Protection Regulation (GDPR) است، یک regulation اروپایی برای محافظت از داده‌ها و حریم خصوصی که به افراد حق erasure (https://gdpr-info.eu/art-17-gdpr/) را اعطا می‌کند. یک application باید این توانایی را داشته باشد که اطلاعات شخصی یک user، مانند آدرس ایمیل آنها را فراموش کند. مسئله با یک application مبتنی بر event sourcing این است که آدرس ایمیل ممکن است در یک event به نام AccountCreated ذخیره شود یا به عنوان primary key از یک aggregate استفاده شود. application به نحوی باید user را بدون حذف events فراموش کند.
  </p>
<p>
   Encryption یک mechanism است که می‌توانید برای حل این مشکل از آن استفاده کنید. هر user، یک encryption key دارد که در یک جدول database جداگانه ذخیره می‌شود. application از آن encryption key برای encrypt کردن هر event حاوی اطلاعات شخصی user قبل از ذخیره آنها در یک event store استفاده می‌کند. هنگامی که یک user درخواست می‌کند که erased شود، application، رکورد encryption key را از جدول database حذف می‌کند. اطلاعات شخصی user به طور مؤثر حذف می‌شود، زیرا eventsها دیگر نمی‌توانند decrypted شوند.
  </p>
<p>
   Encrypting events، بیشتر مشکلات مربوط به پاک کردن اطلاعات شخصی user را حل می‌کند. اما اگر برخی از جنبه‌های اطلاعات شخصی user، مانند آدرس ایمیل، به عنوان یک aggregate ID استفاده شود، دور انداختن encryption key ممکن است کافی نباشد. به عنوان مثال، بخش 6.2 یک event store را توصیف می‌کند که دارای یک جدول به نام entities است که primary key آن، aggregate ID است. یک راه‌حل برای این مشکل استفاده از تکنیک pseudonymization است، جایگزینی آدرس ایمیل با یک token UUID و استفاده از آن به عنوان aggregate ID. application، ارتباط بین token UUID و آدرس ایمیل را در یک جدول database ذخیره می‌کند. هنگامی که یک user درخواست می‌کند که erased شود، application، row را برای آدرس ایمیل آنها از آن جدول حذف می‌کند. این از mapping از UUID به آدرس ایمیل توسط application جلوگیری می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0231_original/original_page.png" alt="Original Page 231">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 6: Developing business logic with event sourcing</strong></h3>
<h4><strong style="color:darkblue">QUERYING THE EVENT STORE IS CHALLENGING</strong></h4>
<p>
   تصور کنید که شما نیاز دارید تا customerهایی را پیدا کنید که credit limit آنها تمام شده است. از آنجایی که یک column حاوی credit وجود ندارد، شما نمی‌توانید بنویسید SELECT * FROM CUSTOMER WHERE CREDIT_LIMIT = 0. در عوض، شما باید از یک query پیچیده‌تر و بالقوه ناکارآمد استفاده کنید که دارای یک SELECT تودرتو برای محاسبه credit limit با folding eventsها که credit اولیه را تنظیم می‌کنند و آن را تنظیم می‌کنند، باشد. برای بدتر کردن اوضاع، یک event store مبتنی بر NoSQL معمولاً فقط از primary key-based lookup پشتیبانی می‌کند. در نتیجه، شما باید queriesها را با استفاده از رویکرد CQRS که در فصل 7 توضیح داده شد، پیاده‌سازی کنید.
  </p>
<h4><strong style="color:darkblue">6.2: Implementing an event store</strong></h4>
<p>
   یک application که از event sourcing استفاده می‌کند، eventsهای خود را در یک event store ذخیره می‌کند. یک event store یک hybrid از یک database و یک message broker است. این به عنوان یک database رفتار می‌کند زیرا یک API برای درج و بازیابی events از یک aggregate با primary key دارد. و به عنوان یک message broker رفتار می‌کند زیرا یک API برای subscribing به events دارد.
  </p>
<p>
   چندین راه مختلف برای پیاده‌سازی یک event store وجود دارد. یک گزینه این است که event store و event sourcing framework خودتان را پیاده‌سازی کنید. شما می‌توانید، به عنوان مثال، events را در یک RDBMS persist کنید. یک روش ساده، اگرچه با عملکرد پایین است، برای publish کردن events این است که subscribers table به نام EVENTS را برای events poll کنند. اما، همانطور که در بخش 6.1.4 ذکر شد، یک چالش این است که اطمینان حاصل شود که یک subscriber همه eventsها را به ترتیب پردازش می‌کند.
  </p>
<p>
   یک گزینه دیگر استفاده از یک event store با هدف خاص است، که معمولاً یک مجموعه غنی از ویژگی‌ها و عملکرد و مقیاس‌پذیری بهتری را ارائه می‌دهد. چندین مورد از این موارد وجود دارد که می‌توانید انتخاب کنید:
  </p>
<ul>
<li>Event Store—یک event store منبع باز مبتنی بر .NET که توسط Greg Young، یک پیشگام event sourcing توسعه داده شده است (https://eventstore.org).</li>
<li>Lagom—یک microservices framework که توسط Lightbend، شرکتی که قبلاً با نام Typesafe شناخته می‌شد، توسعه داده شده است (www.lightbend.com/lagom-framework).</li>
<li>Axon—یک فریم‌ورک منبع باز Java برای developing event-driven applications که از event sourcing و CQRS استفاده می‌کند (www.axonframework.org).</li>
<li>Eventuate—توسعه یافته توسط startup من، Eventuate (http://eventuate.io). دو نسخه از Eventuate وجود دارد: Eventuate SaaS، یک cloud service و Eventuate Local، یک پروژه منبع باز مبتنی بر Apache Kafka/RDBMS.</li>
</ul>
<p>
   اگرچه این frameworks در جزئیات متفاوت هستند، اما مفاهیم اصلی یکسان باقی می‌مانند. از آنجایی که Eventuate، فریم‌ورکی است که من بیشتر با آن آشنا هستم، این موردی است که من در اینجا پوشش می‌دهم. این دارای یک معماری ساده و آسان برای درک است که مفاهیم event sourcing را نشان می‌دهد. شما می‌توانید از آن در applicationsهای خود استفاده کنید، مفاهیم را خودتان دوباره پیاده‌سازی کنید، یا آنچه را که در اینجا یاد می‌گیرید برای ساخت applications با یکی از دیگر event sourcing frameworks اعمال کنید.
  </p>
<p>
   من بخش‌های زیر را با توصیف نحوه عملکرد event store به نام Eventuate Local شروع می‌کنم. سپس فریم‌ورک Eventuate Client را برای Java، یک فریم‌ورک آسان برای استفاده برای نوشتن business logic مبتنی بر event sourcing که از event store به نام Eventuate Local استفاده می‌کند، شرح می‌دهم.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0232_original/original_page.png" alt="Original Page 232">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Implementing an event store</strong></h3>
<h4><strong style="color:darkblue">6.2.1: How the Eventuate Local event store works</strong></h4>
<p>
   Eventuate Local یک event store منبع باز است. شکل 6.9 معماری را نشان می‌دهد.
  </p>
<p>
   Events در یک database، مانند MySQL، ذخیره می‌شوند. Applications، aggregate events را با primary key درج و بازیابی می‌کنند. Applications از یک message broker، مانند Apache Kafka، events را consume می‌کنند. یک transaction log tailing mechanism، eventsها را از database به message broker منتشر می‌کند.
  </p>
<p>
   بیایید به componentsهای مختلف Eventuate Local، با شروع از database schema نگاهی بیندازیم.
  </p>
<h4><strong style="color:darkblue">THE SCHEMA OF EVENTUATE LOCAL’S EVENT DATABASE</strong></h4>
<p>
   event database از سه جدول تشکیل شده است:
  </p>
<ul>
<li>events—Stores the events</li>
<li>entities—One row per entity</li>
<li>snapshots—Stores snapshots</li>
</ul>
<p>
   جدول مرکزی، جدول events است. ساختار این جدول بسیار شبیه به جدول نشان داده شده در شکل 6.2 است. در اینجا تعریف آن آمده است:
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMm
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0233_original/original_page.png" alt="Original Page 233">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 6: Developing business logic with event sourcing</strong></h3>
<h4><strong style="color:darkblue">6.2.1: How the Eventuate Local event store works</strong></h4>
<pre><code class="language-java">create table events (
event_id varchar(1000) PRIMARY KEY,
event_type varchar(1000),
event_data varchar(1000) NOT NULL,
entity_type VARCHAR(1000) NOT NULL,
entity_id VARCHAR(1000) NOT NULL,
triggering_event VARCHAR(1000)
);
</code></pre>
<p>
   ستون به نام triggering_event برای تشخیص events/messages تکراری استفاده می‌شود. این، ID از message/event را که processing از آن، این event را generate کرده است، ذخیره می‌کند.
  </p>
<p>
   جدول entities، version فعلی از هر entity را ذخیره می‌کند. این برای پیاده‌سازی optimistic locking استفاده می‌شود. در اینجا تعریف این جدول آمده است:
  </p>
<pre><code class="language-java">create table entities (
entity_type VARCHAR(1000),
entity_id VARCHAR(1000),
entity_version VARCHAR(1000) NOT NULL,
PRIMARY KEY(entity_type, entity_id)
);
</code></pre>
<p>
   هنگامی که یک entity ایجاد می‌شود، یک row به این جدول درج می‌شود. هر بار که یک entity update می‌شود، column به نام entity_version update می‌شود.
  </p>
<p>
   جدول snapshots، snapshots از هر entity را ذخیره می‌کند. در اینجا تعریف این جدول آمده است:
  </p>
<pre><code class="language-java">create table snapshots (
entity_type VARCHAR(1000),
entity_id VARCHAR(1000),
entity_version VARCHAR(1000),
snapshot_type VARCHAR(1000) NOT NULL,
snapshot_json VARCHAR(1000) NOT NULL,
triggering_events VARCHAR(1000),
PRIMARY KEY(entity_type, entity_id, entity_version)
)
</code></pre>
<p>
   ستون‌های به نام entity_type و entity_id، entity از snapshot را مشخص می‌کنند. column به نام snapshot_json، representation serialized از snapshot است و snapshot_type، type آن است. The entity_version، نسخه از entity را که این snapshot از آن است، مشخص می‌کند.
  </p>
<p>
   سه operation که توسط این schema پشتیبانی می‌شوند، find()، create() و update() هستند. operation به نام find() جدول snapshots را برای بازیابی آخرین snapshot، در صورت وجود، query می‌کند. اگر یک snapshot وجود داشته باشد، operation به نام find() جدول events را query می‌کند تا تمام eventsها را پیدا کند که event_id آنها بزرگتر از entity_version از snapshot است. در غیر این صورت، find() تمام eventsها را برای entity مشخص شده، بازیابی می‌کند. operation به نام find() همچنین جدول entity را query می‌کند تا version فعلی از entity را بازیابی کند.
  </p>
<p>
   The create() operation، یک row را به جدول entity و events را به جدول events درج می‌کند. The update() operation، events را به جدول events درج می‌کند. این
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0234_original/original_page.png" alt="Original Page 234">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Implementing an event store</strong></h3>
<p>
   همچنین یک check از optimistic locking با update کردن entity version در جدول entities با استفاده از عبارت UPDATE زیر انجام می‌دهد:
  </p>
<p>
   UPDATE entities SET entity_version = ?
   <br/>
   WHERE entity_type = ? and entity_id = ? and entity_version = ?
  </p>
<p>
   این عبارت تأیید می‌کند که version از زمانی که توسط operation به نام find() بازیابی شده است، تغییر نکرده است. همچنین entity_version را به version جدید update می‌کند. The update() operation این updatesها را در یک transaction انجام می‌دهد تا اتمی بودن را تضمین کند.
  </p>
<p>
   اکنون که ما به نحوه ذخیره events و snapshots از یک aggregate توسط Eventuate Local نگاهی انداختیم، بیایید ببینیم چگونه یک client به events با استفاده از event broker به نام Eventuate Local subscribe می‌کند.
  </p>
<h4><strong style="color:darkblue">CONSUMING EVENTS BY SUBSCRIBING TO EVENTUATE LOCAL’S EVENT BROKER</strong></h4>
<p>
   Services، events را با subscribing به event broker، که با استفاده از Apache Kafka پیاده‌سازی شده است، consume می‌کنند. event broker دارای یک topic برای هر aggregate type است. همانطور که در فصل 3 توضیح داده شد، یک topic یک partitioned message channel است. این، consumers را قادر می‌سازد تا به صورت افقی مقیاس‌بندی شوند و در عین حال order از messages را حفظ کنند. ID از aggregate به عنوان partition key استفاده می‌شود، که ترتیب events منتشر شده توسط یک aggregate داده شده را حفظ می‌کند. برای consume کردن events از یک aggregate، یک service به topic از aggregate subscribe می‌کند.
  </p>
<p>
   بیایید اکنون به event relay—glue بین event database و event broker—نگاهی بیندازیم.
  </p>
<h4><strong style="color:darkblue">THE EVENTUATE LOCAL EVENT RELAY PROPAGATES EVENTS FROM THE DATABASE TO THE MESSAGE BROKER</strong></h4>
<p>
   event relay، eventsهایی را که به event database درج شده‌اند، به event broker منتشر می‌کند. در صورت امکان از transaction log tailing و برای سایر databasesها از polling استفاده می‌کند.
  </p>
<p>
   به عنوان مثال، نسخه MySQL از event relay از پروتکل replication به نام MySQL master/slave استفاده می‌کند. event relay به سرور MySQL متصل می‌شود، گویی که یک slave است و MySQL binlog را می‌خواند، یک رکورد از updates ساخته شده به database. Insertsها به جدول EVENTS، که با eventsها مطابقت دارند، به topic مربوطه Apache Kafka منتشر می‌شوند. The event relay، هر نوع دیگری از تغییرات را نادیده می‌گیرد.
  </p>
<p>
   event relay به عنوان یک process مستقل مستقر می‌شود. به منظور راه‌اندازی مجدد صحیح، به طور دوره‌ای موقعیت فعلی را در binlog—نام فایل و offset—در یک topic ویژه از Apache Kafka ذخیره می‌کند. در راه‌اندازی، ابتدا آخرین موقعیت ثبت شده را از topic بازیابی می‌کند. سپس event relay شروع به خواندن MySQL binlog از آن موقعیت می‌کند.
  </p>
<p>
   event database، message broker و event relay، event store را تشکیل می‌دهند. بیایید اکنون به فریم‌ورکی که یک application از Java برای دسترسی به event store استفاده می‌کند، نگاهی بیندازیم.
  </p>
<h4><strong style="color:darkblue">6.2.2: The Eventuate client framework for Java</strong></h4>
<p>
   فریم‌ورک Eventuate client، developers را قادر می‌سازد تا applications مبتنی بر event sourcing را بنویسند که از event store به نام Eventuate Local استفاده می‌کنند. این فریم‌ورک، که در شکل 6.10 نشان داده شده است، پایه و اساس developing event sourcing-based aggregates، services و event handlers را فراهم می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0235_original/original_page.png" alt="Original Page 235">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 6: Developing business logic with event sourcing</strong></h3>
<p>
   این فریم‌ورک، classهای پایه را برای aggregates، commands و events فراهم می‌کند. همچنین یک class به نام AggregateRepository وجود دارد که قابلیت CRUD را فراهم می‌کند. و فریم‌ورک، یک API برای subscribing به events دارد.
  </p>
<p>
   بیایید به طور خلاصه به هر یک از typesها که در شکل 6.10 نشان داده شده است، نگاهی بیندازیم.
  </p>
<h4><strong style="color:darkblue">DEFINING AGGREGATES WITH THE REFLECTIVEMUTABLECOMMANDPROCESSINGAGGREGATE CLASS</strong></h4>
<p>
   ReflectiveMutableCommandProcessingAggregate، class پایه برای aggregates است. این یک generic class است که دارای دو type parameter است: اولی، class aggregate concrete است و دومی، superclass از command classes از aggregate است. همانطور که نام طولانی آن نشان می‌دهد، از reflection برای dispatch کردن command و events به method مناسب استفاده می‌کند. Commandsها به یک method به نام process() و eventsها به یک method به نام apply() dispatch می‌شوند.
  </p>
<p>
   class به نام Order که قبلاً دیدید، ReflectiveMutableCommandProcessingAggregate را گسترش می‌دهد. listing زیر، class به نام Order را نشان می‌دهد.
  </p>
<pre><code class="language-java">public class Order extends ReflectiveMutableCommandProcessingAggregate&lt;Order,
OrderCommand&gt; {
public List&lt;Event&gt; process(CreateOrderCommand command) { ... }
public void apply(OrderCreatedEvent event) { ... }
</code></pre>
<p>
   Listing 6.3
   <br/>
   The Eventuate version of the Order class
  </p>
<p>
   OrderService
   <br/>
   EventHandlers
   <br/>
   creditReserved()
   <br/>
   «interface»
   <br/>
   OrderEvent
   <br/>
   «interface»
   <br/>
   OrderCommand
   <br/>
   «event»
   <br/>
   OrderCreated
   <br/>
   «command»
   <br/>
   CreateOrder
   <br/>
   Order
   <br/>
   process()
   <br/>
   apply()
   <br/>
   Order
   <br/>
   Service
   <br/>
   createOrder()
   <br/>
   «annotation»
   <br/>
   Event
   <br/>
   Subscriber
   <br/>
   «interface»
   <br/>
   Event
   <br/>
   «interface»
   <br/>
   Command
   <br/>
   «abstract»
   <br/>
   ReﬂectiveMutableCommand
   <br/>
   ProcessingAggregate
   <br/>
   Aggregate
   <br/>
   Repository
   <br/>
   Eventuate client framework
   <br/>
   Order Service
   <br/>
   save()
   <br/>
   ﬁnd()
   <br/>
   update()
   <br/>
   Abstract classes and interfaces that
   <br/>
   application classes extend or implement
  </p>
<p>
   Figure 6.10
   <br/>
   The main classes and interfaces provided by the Eventuate client framework for Java
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0236_original/original_page.png" alt="Original Page 236">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Implementing an event store</strong></h3>
<pre><code class="language-java">...
}
</code></pre>
<p>
   دو type parameter که به ReflectiveMutableCommandProcessingAggregate منتقل می‌شوند، Order و OrderCommand هستند، که رابط پایه برای commands از Order است.
  </p>
<h4><strong style="color:darkblue">DEFINING AGGREGATE COMMANDS</strong></h4>
<p>
   classهای command از یک aggregate، باید یک interface پایه aggregate-specific را گسترش دهند، که خود باید interface به نام Command را گسترش دهد. به عنوان مثال، commands از Order aggregate، OrderCommand را گسترش می‌دهند:
  </p>
<pre><code class="language-java">public interface OrderCommand extends Command {
}
public class CreateOrderCommand implements OrderCommand { ... }
</code></pre>
<p>
   The OrderCommand interface، Command را گسترش می‌دهد و class command به نام CreateOrderCommand، OrderCommand را گسترش می‌دهد.
  </p>
<h4><strong style="color:darkblue">DEFINING DOMAIN EVENTS</strong></h4>
<p>
   classهای event از یک aggregate باید interface به نام Event را گسترش دهند، که یک marker interface بدون method است. همچنین تعریف یک interface مشترک پایه، که Event را برای تمام classهای event از یک aggregate گسترش می‌دهد، مفید است. به عنوان مثال، در اینجا تعریف از OrderCreated event آمده است:
  </p>
<pre><code class="language-java">interface OrderEvent extends Event {
}
public class OrderCreated extends OrderEvent { ... }
</code></pre>
<p>
   class به نام OrderCreated event، OrderEvent را گسترش می‌دهد، که رابط پایه برای classهای event از Order aggregate است. The OrderEvent interface، Event را گسترش می‌دهد.
  </p>
<h4><strong style="color:darkblue">CREATING, FINDING, AND UPDATING AGGREGATES WITH THE AGGREGATEREPOSITORY CLASS</strong></h4>
<p>
   فریم‌ورک چندین راه برای ایجاد، یافتن و update کردن aggregates فراهم می‌کند. ساده‌ترین رویکرد، که من در اینجا توضیح می‌دهم، استفاده از یک AggregateRepository است. AggregateRepository یک generic class است که توسط class aggregate و base command class از aggregate پارامتریزه شده است. این سه method overload شده را فراهم می‌کند:
  </p>
<ul>
<li>save()—یک aggregate را ایجاد می‌کند</li>
<li>find()—یک aggregate را پیدا می‌کند</li>
<li>update()—یک aggregate را update می‌کند</li>
</ul>
<p>
   The save () و update() methods به ویژه مناسب هستند زیرا کد boilerplate مورد نیاز برای ایجاد و update کردن aggregates را کپسوله می‌کنند. به عنوان مثال، save() یک command object را به عنوان یک پارامتر می‌گیرد و مراحل زیر را انجام می‌دهد:
  </p>
<ol>
<li>Instantiates the aggregate using its default constructor</li>
<li>Invokes process() to process the command</li>
</ol>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0237_original/original_page.png" alt="Original Page 237">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Developing business logic with event sourcing</strong></h3>
<p>
   3 Apply the generated events by calling apply()
  </p>
<p>
   4 Saves the generated events in the event store
  </p>
<p>
   The update() method شبیه است. این دو پارامتر دارد، یک aggregate ID و یک command، و مراحل زیر را انجام می‌دهد:
  </p>
<ol>
<li>Retrieves the aggregate from the event store</li>
<li>Invokes process() to process the command</li>
<li>Applies the generated events by calling apply()</li>
<li>Saves the generated events in the event store</li>
</ol>
<p>
   The AggregateRepository class در درجه اول توسط services استفاده می‌شود، که aggregates را در پاسخ به requestsهای خارجی ایجاد و update می‌کنند. به عنوان مثال، listing زیر نشان می‌دهد که چگونه OrderService از یک AggregateRepository برای ایجاد یک Order استفاده می‌کند.
  </p>
<pre><code class="language-java">public class OrderService {
private AggregateRepository&lt;Order, OrderCommand&gt; orderRepository;
public OrderService(AggregateRepository&lt;Order, OrderCommand&gt; orderRepository)
{
this.orderRepository = orderRepository;
}
public EntityWithIdAndVersion&lt;Order&gt; createOrder(OrderDetails orderDetails) {
return orderRepository.save(new CreateOrder(orderDetails));
}
</code></pre>
<p>
   OrderService با یک AggregateRepository برای Orders تزریق می‌شود. method به نام create() آن، AggregateRepository.save() را با یک command به نام CreateOrder فراخوانی می‌کند.
  </p>
<h4><strong style="color:darkblue">SUBSCRIBING TO DOMAIN EVENTS</strong></h4>
<p>
   فریم‌ورک Eventuate Client همچنین یک API برای نوشتن event handlers فراهم می‌کند. Listing 6.5 یک event handler را برای events به نام CreditReserved نشان می‌دهد. annotation به نام @EventSubscriber، ID از durable subscription را مشخص می‌کند. Events که زمانی که subscriber در حال اجرا نیست منتشر می‌شوند، هنگامی که راه‌اندازی می‌شود، تحویل داده می‌شوند. annotation به نام @EventHandlerMethod، method به نام creditReserved() را به عنوان یک event handler شناسایی می‌کند.
  </p>
<pre><code class="language-java">@EventSubscriber(id="orderServiceEventHandlers")
public class OrderServiceEventHandlers {
@EventHandlerMethod
public void creditReserved(EventHandlerContext&lt;CreditReserved&gt; ctx) {
CreditReserved event = ctx.getEvent();
...
}
</code></pre>
<p>
   Listing 6.4
   <br/>
   OrderService uses an AggregateRepository
  </p>
<p>
   Listing 6.5
   <br/>
   An event handler for OrderCreatedEvent
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0238_original/original_page.png" alt="Original Page 238">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Using sagas and event sourcing together</strong></h3>
<p>
   فریم‌ورک Eventuate Client همچنین یک API را برای نوشتن event handlers فراهم می‌کند. listing 6.5 یک event handler را برای رویدادهای به نام CreditReserved نشان می‌دهد. annotation به نام @EventSubscriber، ID از durable subscription را مشخص می‌کند. Events که وقتی subscriber در حال اجرا نیست منتشر می‌شوند، وقتی که شروع به کار می‌کند، تحویل داده می‌شوند. annotation به نام @EventHandlerMethod، method به نام creditReserved() را به عنوان یک event handler شناسایی می‌کند.
  </p>
<p>
   اکنون که ما به نحوه نوشتن business logic مبتنی بر event sourcing با استفاده از فریم‌ورک Eventuate client نگاهی انداختیم، بیایید ببینیم چگونه از business logic مبتنی بر event sourcing با sagas استفاده کنیم.
  </p>
<h4><strong style="color:darkblue">6.3: Using sagas and event sourcing together</strong></h4>
<p>
   تصور کنید که شما یک یا چند service را با استفاده از event sourcing پیاده‌سازی کرده‌اید. شما احتمالاً servicesهایی مشابه نمونه نشان داده شده در listing 6.4 نوشته‌اید. اما اگر فصل 4 را خوانده‌اید، می‌دانید که servicesها اغلب نیاز دارند که sagas را آغاز و در آنها مشارکت کنند، sequences از local transactions که برای حفظ data consistency در سراسر services استفاده می‌شوند. به عنوان مثال، Order Service از یک saga برای validate کردن یک Order استفاده می‌کند. Kitchen Service، Consumer Service و Accounting Service در آن saga مشارکت می‌کنند. در نتیجه، شما باید sagas و business logic مبتنی بر event sourcing را ادغام کنید.
  </p>
<p>
   Event sourcing، استفاده از choreography-based sagas را آسان می‌کند. شرکت‌کنندگان domain events منتشر شده توسط aggregates خود را exchange می‌کنند. The aggregates از هر participant، events را با processing commands و emitting new events handle می‌کنند. شما باید aggregates و classهای event handler را بنویسید، که aggregatesها را update می‌کنند.
  </p>
<p>
   اما ادغام business logic مبتنی بر event sourcing با orchestration-based sagas می‌تواند چالش‌برانگیزتر باشد. این به این دلیل است که مفهوم event store از یک transaction ممکن است کاملاً محدود باشد. هنگام استفاده از برخی event stores، یک application فقط می‌تواند یک aggregate را ایجاد یا update کند و event(s) حاصل را منتشر کند. اما هر مرحله از یک saga شامل چندین action است که باید به صورت atomic انجام شوند:
  </p>
<ul>
<li>Saga creation—A service that initiates a saga must atomically create or update an aggregate and create the saga orchestrator. For example, Order Service’s createOrder() method must create an Order aggregate and a CreateOrderSaga.</li>
<li>Saga orchestration—A saga orchestrator must atomically consume replies, update its state, and send command messages.</li>
<li>Saga participants—Saga participants, such as Kitchen Service and Order Service, must atomically consume messages, detect and discard duplicates, create or update aggregates, and send reply messages.</li>
</ul>
<p>
   به دلیل این mismatch بین این requirements و قابلیت‌های transactional از یک event store، ادغام orchestration-based sagas و event sourcing به طور بالقوه برخی از challenges جالب را ایجاد می‌کند.
  </p>
<p>
   یک عامل کلیدی در تعیین سهولت ادغام event sourcing و orchestration-based sagas این است که آیا event store از یک RDBMS یا یک NoSQL database استفاده می‌کند یا خیر. فریم‌ورک Eventuate Tram saga که در فصل 4 توضیح داده شده است و فریم‌ورک messaging Tram که در فصل 3 توضیح داده شد، به معاملات ACID انعطاف‌پذیر ارائه شده توسط RDBMS متکی هستند. saga orchestrator و participants از saga از transactions ACID برای update کردن atomic database و exchange messages استفاده می‌کنند. اگر application از یک event store مبتنی بر RDBMS، مانند Eventuate Local، استفاده می‌کند، سپس می‌تواند تقلب کند و
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0239_original/original_page.png" alt="Original Page 239">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">فصل 6: Developing business logic with event sourcing</strong></h3>
<p>
   Eventuate Tram saga framework و event store را در یک transaction ACID update می‌کند. اما اگر event store از یک NoSQL database استفاده کند، که نمی‌تواند در همان transaction به عنوان فریم‌ورک Eventuate Tram saga مشارکت کند، باید یک رویکرد متفاوت را در پیش بگیرد.
  </p>
<p>
   بیایید نگاهی دقیق‌تر به برخی از سناریوها و مسائل مختلفی که باید به آنها رسیدگی کنید، بیندازیم:
  </p>
<ul>
<li>Implementing choreography-based sagas</li>
<li>Creating an orchestration-based saga</li>
<li>Implementing an event sourcing-based saga participant</li>
<li>Implementing saga orchestrators using event sourcing</li>
</ul>
<p>
   ما با نگاهی به نحوه پیاده‌سازی choreography-based sagas با استفاده از event sourcing شروع می‌کنیم.
  </p>
<h4><strong style="color:darkblue">6.3.1: Implementing choreography-based sagas using event sourcing</strong></h4>
<p>
   ماهیت event-driven از event sourcing، پیاده‌سازی choreography-based sagas را بسیار ساده می‌کند. هنگامی که یک aggregate update می‌شود، یک event را emit می‌کند. یک event handler برای یک aggregate متفاوت می‌تواند آن event را consume کند و aggregate خود را update کند. فریم‌ورک event sourcing به طور خودکار هر event handler را idempotent می‌کند.
  </p>
<p>
   به عنوان مثال، فصل 4 در مورد چگونگی پیاده‌سازی Create Order Saga با استفاده از choreography بحث می‌کند. ConsumerService، KitchenService و AccountingService به events از OrderService و بالعکس subscribe می‌کنند. هر service دارای یک event handler است که شبیه به نمونه نشان داده شده در listing 6.5 است. event handler، aggregate مربوطه را update می‌کند، که یک event دیگر را emit می‌کند.
  </p>
<p>
   Event sourcing و choreography-based sagas با هم بسیار خوب کار می‌کنند. Event sourcing، mechanismهایی را فراهم می‌کند که sagasها به آن نیاز دارند، از جمله messaging-based IPC، message de-duplication و atomic updating از state و message sending. با وجود سادگی‌اش، choreography-based sagas، چندین نقطه ضعف دارد. من در مورد برخی از نقاط ضعف در فصل 4 صحبت می‌کنم، اما یک نقطه ضعف وجود دارد که مختص event sourcing است.
  </p>
<p>
   مشکل استفاده از events برای saga choreography این است که events اکنون یک هدف دوگانه دارند. Event sourcing از events برای نشان دادن state changes استفاده می‌کند، اما استفاده از events برای saga choreography نیاز دارد که یک aggregate، یک event را emit کند، حتی اگر هیچ state change وجود نداشته باشد. به عنوان مثال، اگر update کردن یک aggregate، یک business rule را نقض کند، سپس aggregate باید یک event را برای گزارش خطا emit کند. یک مشکل بدتر این است که یک saga participant نمی‌تواند یک aggregate را ایجاد کند. هیچ aggregate وجود ندارد که بتواند یک event از نوع error را emit کند.
  </p>
<p>
   به دلیل این نوع مسائل، بهتر است sagasهای پیچیده‌تر را با استفاده از orchestration پیاده‌سازی کنید. بخش‌های زیر نحوه ادغام orchestration-based sagas و event sourcing را توضیح می‌دهند. همانطور که خواهید دید، این امر شامل حل برخی از مشکلات جالب می‌شود.
  </p>
<p>
   بیایید ابتدا به این نکته نگاهی بیندازیم که چگونه یک service method مانند OrderService.createOrder()، یک saga orchestrator را ایجاد می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0240_original/original_page.png" alt="Original Page 240">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">Using sagas and event sourcing together</strong></h3>
<h4><strong style="color:darkblue">6.3.2: Creating an orchestration-based saga</strong></h4>
<p>
   Saga orchestrators توسط برخی از service methods ایجاد می‌شوند. سایر service methodsها، مانند OrderService.createOrder()، دو کار انجام می‌دهند: یک aggregate را ایجاد یا update می‌کنند و یک saga orchestrator ایجاد می‌کنند. service باید هر دو action را به روشی انجام دهد که تضمین کند اگر action اول را انجام دهد، پس از آن action دوم در نهایت انجام خواهد شد.
  </p>
<p>
   چگونگی اطمینان از انجام هر دو action توسط service به نوع event store ای که استفاده می‌کند بستگی دارد.
  </p>
<h4><strong style="color:darkblue">CREATING A SAGA ORCHESTRATOR WHEN USING AN RDBMS-BASED EVENT STORE</strong></h4>
<p>
   اگر یک service از یک event store مبتنی بر RDBMS استفاده می‌کند، می‌تواند event store را update کند و یک saga orchestrator را در همان ACID transaction ایجاد کند. به عنوان مثال، تصور کنید که OrderService از Eventuate Local و فریم‌ورک Eventuate Tram saga استفاده می‌کند. method به نام createOrder() آن به این صورت خواهد بود:
  </p>
<pre><code class="language-java">class OrderService
@Autowired
private SagaManager&lt;CreateOrderSagaState&gt; createOrderSagaManager;
@Transactional
public EntityWithIdAndVersion&lt;Order&gt; createOrder(OrderDetails orderDetails) {
EntityWithIdAndVersion&lt;Order&gt; order =
orderRepository.save(new CreateOrder(orderDetails));
CreateOrderSagaState data =
new CreateOrderSagaState(order.getId(), orderDetails);
createOrderSagaManager.create(data, Order.class, order.getId());
return order;
}
...
</code></pre>
<p>
   این ترکیبی از OrderService در listing 6.4 و OrderService است که در فصل 4 توضیح داده شده است. از آنجایی که Eventuate Local از یک RDBMS استفاده می‌کند، می‌تواند در همان transaction ACID به عنوان فریم‌ورک Eventuate Tram saga مشارکت کند. اما اگر یک service از یک event store مبتنی بر NoSQL استفاده می‌کند، ایجاد یک saga orchestrator به همان اندازه ساده نیست.
  </p>
<h4><strong style="color:darkblue">CREATING A SAGA ORCHESTRATOR WHEN USING A NOSQL-BASED EVENT STORE</strong></h4>
<p>
   یک service که از یک event store مبتنی بر NoSQL استفاده می‌کند، به احتمال زیاد قادر به update کردن atomic event store و ایجاد یک saga orchestrator نخواهد بود. فریم‌ورک saga orchestration ممکن است از یک database کاملاً متفاوت استفاده کند. حتی اگر از همان database NoSQL استفاده کند، application قادر نخواهد بود دو object متفاوت را به صورت atomic ایجاد یا update کند، زیرا مدل transaction محدود از database NoSQL وجود دارد. در عوض، یک service باید یک event handler داشته باشد که saga orchestrator را در پاسخ به یک domain event منتشر شده توسط aggregate ایجاد می‌کند.
  </p>
<p>
   به عنوان مثال، شکل 6.11 نشان می‌دهد که چگونه Order Service یک CreateOrderSaga را با استفاده از یک event handler برای event به نام OrderCreated ایجاد می‌کند. Order Service ابتدا یک
  </p>
<p>
   Ensure the createOrder() executes
   <br/>
   within a database transaction.
   <br/>
   Create the Order
   <br/>
   aggregate.
   <br/>
   Create the
   <br/>
   CreateOrderSaga.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0241_original/original_page.png" alt="Original Page 241">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong style="color:darkblue">CHAPTER 6: Developing business logic with event sourcing</strong></h3>
<p>
   Order aggregate و آن را در event store persist می‌کند. event store، event به نام OrderCreated را منتشر می‌کند، که توسط event handler مصرف می‌شود. event handler، فریم‌ورک Eventuate Tram saga را برای ایجاد یک CreateOrderSaga فراخوانی می‌کند.
  </p>
<p>
   یک مسئله که باید هنگام نوشتن یک event handler که یک saga orchestrator ایجاد می‌کند، در نظر داشت این است که باید eventsهای تکراری را handle کند. At-least-once message delivery به این معنی است که event handler که saga را ایجاد می‌کند ممکن است چندین بار فراخوانی شود. اطمینان حاصل کردن از اینکه فقط یک instance از saga ایجاد شده است، مهم است.
  </p>
<p>
   یک رویکرد ساده این است که ID از saga را از یک attribute منحصر به فرد از event مشتق کنید. چند گزینه مختلف وجود دارد. یکی این است که از ID از aggregate که event را emit می‌کند، به عنوان ID از saga استفاده کنید. این کار برای sagas که در پاسخ به events ایجاد aggregate ایجاد می‌شوند، خوب عمل می‌کند.
  </p>
<p>
   یک گزینه دیگر این است که از event ID به عنوان saga ID استفاده کنید. از آنجایی که event IDsها منحصر به فرد هستند، این امر تضمین می‌کند که saga ID منحصر به فرد است. اگر یک event، یک duplicate است، تلاش event handler برای ایجاد saga شکست می‌خورد زیرا ID قبلاً وجود دارد. این گزینه زمانی مفید است که چندین instance از همان saga می‌توانند برای یک aggregate instance داده شده، وجود داشته باشند.
  </p>
<p>
   یک service که از یک event store مبتنی بر RDBMS استفاده می‌کند، همچنین می‌تواند از همان رویکرد event-driven برای ایجاد sagas استفاده کند. یک مزیت این رویکرد این است که loose coupling را ترویج می‌کند زیرا servicesهایی مانند OrderService دیگر به طور صریح، sagas را instantiate نمی‌کنند.
  </p>
<p>
   اکنون که ما به نحوه ایجاد reliable saga orchestrator نگاهی انداختیم، بیایید ببینیم چگونه services مبتنی بر event sourcing می‌توانند در orchestration-based sagas شرکت کنند.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAAA9Fq21AAAACXBIWXMAAC4jAAAuIwF4pT94AAAgAElEQVR4nO2dd1wT17nv/9+wQ/7g1x/rE72x4eKk7h5x19R0v8Yx9x97Pz6g9Qy8G9+0401n7/98B7L30r/p/h8sE/3/B9x/w7u83y937m/3w/i3c+8c03J/12+b0zPz4qB4/995u67/93dF3H/3zBf7/5+7t92+P7Wv9/fFv9s/+4tD+cWpWw9mQf/T1/4N7f1e7e/z88zMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzM39
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0242_original/original_page.png" alt="Original Page 242">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Using sagas and event sourcing together</mark></h3>
<h4><mark>6.3.3 Implementing an event sourcing-based saga participant</mark></h4>
<p>
   تصور کنید که شما از <mark>event sourcing</mark> برای پیاده‌سازی یک <mark>service</mark> استفاده کرده‌اید که نیاز دارد در یک <mark>orchestration-based saga</mark> شرکت کند. جای تعجب نیست که اگر <mark>service</mark> شما از یک <mark>RDBMS-based</mark> <mark>event store</mark> مانند <mark>Eventuate Local</mark> استفاده می‌کند، می‌توانید به راحتی اطمینان حاصل کنید که به‌طور اتمی پیام‌های <mark>saga command</mark> را پردازش می‌کند و پاسخ‌ها را ارسال می‌کند. این می‌تواند <mark>event store</mark> را به عنوان بخشی از <mark>ACID transaction</mark> که توسط فریم‌ورک <mark>Eventuate Tram</mark> آغاز شده است، به‌روزرسانی کند. اما اگر <mark>service</mark> شما از یک <mark>event store</mark> استفاده می‌کند که نمی‌تواند در همان <mark>transaction</mark> با فریم‌ورک <mark>Eventuate Tram</mark> شرکت کند، باید از یک رویکرد کاملاً متفاوت استفاده کنید.
  </p>
<p>
   شما باید به چند مسئله مختلف بپردازید:
  </p>
<ul>
<li><mark>Idempotent command message handling</mark></li>
<li><mark>Atomically sending a reply message</mark></li>
</ul>
<p>
   بیایید ابتدا نگاهی به چگونگی پیاده‌سازی <mark>idempotent command message handlers</mark> بیندازیم.
  </p>
<h5><mark>IDEMPOTENT COMMAND MESSAGE HANDLING</mark></h5>
<p>
   اولین مشکلی که باید حل شود این است که چگونه یک <mark>event sourcing-based saga participant</mark> می‌تواند پیام‌های تکراری را شناسایی و دور بریزد تا <mark>idempotent command message handling</mark> را پیاده‌سازی کند. خوشبختانه، این یک مشکل آسان است که با استفاده از مکانیسم <mark>idempotent</mark> <mark>message handling</mark> که قبلاً توضیح داده شد، برطرف می‌شود. یک <mark>saga participant</mark>، <mark>message ID</mark> را در <mark>events</mark> که هنگام پردازش <mark>message</mark> تولید می‌شوند، ثبت می‌کند. قبل از به‌روزرسانی یک <mark>aggregate</mark>، <mark>saga participant</mark> تأیید می‌کند که قبلاً <mark>message</mark> را پردازش نکرده است و این کار را با جستجوی <mark>message ID</mark> در <mark>events</mark> انجام می‌دهد.
  </p>
<h5><mark>ATOMICALLY SENDING REPLY MESSAGES</mark></h5>
<p>
   دومین مشکلی که باید حل شود این است که چگونه یک <mark>event sourcing-based saga participant</mark> می‌تواند به‌طور اتمی پاسخ‌ها را ارسال کند. در اصل، یک <mark>saga orchestrator</mark> می‌تواند به <mark>events</mark> منتشر شده توسط یک <mark>aggregate</mark> مشترک شود، اما دو مشکل در این رویکرد وجود دارد. اولین مورد این است که یک <mark>saga command</mark> ممکن است در واقع وضعیت یک <mark>aggregate</mark> را تغییر ندهد. در این سناریو، <mark>aggregate</mark> یک <mark>event</mark> منتشر نمی‌کند، بنابراین هیچ پاسخی به <mark>saga orchestrator</mark> ارسال نمی‌شود. مشکل دوم این است که این رویکرد نیازمند آن است که <mark>saga orchestrator</mark> با <mark>saga participants</mark> که از <mark>event sourcing</mark> استفاده می‌کنند، متفاوت از آن‌هایی که استفاده نمی‌کنند، رفتار کند. این به این دلیل است که برای دریافت <mark>domain events</mark>، <mark>saga orchestrator</mark> باید علاوه بر <mark>reply channel</mark> خود، به <mark>event channel</mark> <mark>aggregate</mark> نیز مشترک شود.
  </p>
<p>
   یک رویکرد بهتر این است که <mark>saga participant</mark> به ارسال یک <mark>reply message</mark> به <mark>saga orchestrator</mark> خود ادامه دهد. اما به جای ارسال مستقیم <mark>reply message</mark>، یک <mark>saga participant</mark> از یک فرآیند دو مرحله‌ای استفاده می‌کند:
  </p>
<ol>
<li>
    هنگامی که یک <mark>saga command handler</mark> یک <mark>aggregate</mark> را ایجاد یا به‌روزرسانی می‌کند، ترتیب می‌دهد که یک <mark>SagaReplyRequested</mark> <mark>pseudo event</mark> به همراه <mark>events</mark> واقعی منتشر شده توسط <mark>aggregate</mark> در <mark>event store</mark> ذخیره شود.
   </li>
<li>
    یک <mark>event handler</mark> برای <mark>SagaReplyRequested</mark> <mark>pseudo event</mark> از داده‌های موجود در <mark>event</mark> برای ساختن <mark>reply message</mark> استفاده می‌کند، که سپس آن را در <mark>reply channel</mark> <mark>saga orchestrator</mark> می‌نویسد.
   </li>
</ol>
<p>
   بیایید به یک مثال نگاهی بیندازیم تا ببینیم این چگونه کار می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0243_original/original_page.png" alt="Original Page 243">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 6</mark></h3>
<p>
<mark>Developing business logic with event sourcing</mark>
</p>
<h5><mark>EXAMPLE EVENT SOURCING-BASED SAGA PARTICIPANT</mark></h5>
<p>
   این مثال به <mark>Accounting Service</mark>، یکی از <mark>participants</mark>های <mark>Create Order Saga</mark>، نگاهی می‌اندازد. شکل 6.12 نشان می‌دهد که چگونه <mark>Accounting Service</mark>، <mark>Authorize Command</mark> ارسال شده توسط <mark>saga</mark> را مدیریت می‌کند. <mark>Accounting Service</mark> با استفاده از فریم‌ورک <mark>Eventuate Saga</mark> پیاده‌سازی شده است. فریم‌ورک <mark>Eventuate Saga</mark> یک فریم‌ورک متن‌باز برای نوشتن <mark>sagas</mark> است که از <mark>event sourcing</mark> استفاده می‌کند. این بر روی فریم‌ورک <mark>Eventuate Client</mark> ساخته شده است.
  </p>
<p>
   این شکل نشان می‌دهد که چگونه <mark>Create Order Saga</mark> و <mark>AccountingService</mark> با هم تعامل دارند. توالی <mark>events</mark> به شرح زیر است:
  </p>
<p>
<mark>AccountCreated</mark>
<br/>
   ....
   <br/>
<mark>AccountAuthorized</mark>
<br/>
<mark>AccountAuthorized</mark>
<br/>
<mark>SagaReplyRequested</mark>
</p>
<p>
<mark>Event store</mark>
</p>
<p>
<mark>Event dispatcher</mark>
</p>
<p>
<mark>Eventuate API</mark>
</p>
<p>
<mark>Accounting Service</mark>
</p>
<p>
<mark>SagaReplyRequested</mark>
</p>
<p>
<mark>Order Service</mark>
</p>
<p>
<mark>Aggregate</mark>
</p>
<p>
<mark>repository</mark>
</p>
<p>
<mark>SagaReply</mark>
<br/>
<mark>requested</mark>
</p>
<p>
<mark>EventHandler</mark>
</p>
<p>
<mark>Eventuate saga framework</mark>
</p>
<p>
<mark>Saga command</mark>
<br/>
<mark>dispatcher</mark>
</p>
<p>
<mark>Authorize</mark>
<br/>
<mark>command</mark>
</p>
<p>
<mark>Authorize</mark>
<br/>
<mark>reply</mark>
</p>
<p>
<mark>Account</mark>
<br/>
<mark>command channel</mark>
</p>
<p>
<mark>Create order saga</mark>
<br/>
<mark>reply channel</mark>
</p>
<p>
<mark>Create</mark>
<br/>
<mark>order</mark>
<br/>
<mark>saga</mark>
</p>
<p>
<mark>Account</mark>
<br/>
<mark>authorize()</mark>
</p>
<p>
<mark>Authorize account</mark>
<br/>
<mark>command handler</mark>
</p>
<p>
<mark>Authorize</mark>
<br/>
<mark>the account.</mark>
<br/>
<mark>Send command to</mark>
<br/>
<mark>accounting service.</mark>
<br/>
<mark>Handle SagaReply</mark>
<br/>
<mark>requested event</mark>
<br/>
<mark>and send reply.</mark>
<br/>
<mark>Emit</mark>
<br/>
<mark>SagaReply</mark>
<br/>
<mark>requested</mark>
<br/>
<mark>event.</mark>
</p>
<p>
   شکل 6.12
   <br/>
   چگونگی مشارکت <mark>Accounting Service</mark> مبتنی بر <mark>event sourcing</mark> در <mark>Create</mark>
<br/>
<mark>Order Saga</mark>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0244_original/original_page.png" alt="Original Page 244">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Using sagas and event sourcing together</mark></h3>
<p>
   1
   <mark>Create Order Saga</mark> یک دستور <mark>AuthorizeAccount</mark> را به <mark>Accounting-Service</mark> از طریق یک کانال پیام‌رسانی ارسال می‌کند. <mark>SagaCommand-Dispatcher</mark> فریم‌ورک <mark>Eventuate Saga</mark>، <mark>AccountingServiceCommandHandler</mark> را برای رسیدگی به پیام دستور فراخوانی می‌کند.
  </p>
<p>
   2
   <mark>AccountingServiceCommandHandler</mark> دستور را به <mark>Account aggregate</mark> مشخص شده ارسال می‌کند.
  </p>
<p>
   3
   <mark>Aggregate</mark> دو <mark>event</mark> منتشر می‌کند، <mark>AccountAuthorized</mark> و <mark>SagaReplyRequested-Event</mark>.
  </p>
<p>
   4
   <mark>SagaReplyRequestedEventHandler</mark> با ارسال یک پیام پاسخ به <mark>CreateOrderSaga</mark>، به <mark>SagaReplyRequestedEvent</mark> رسیدگی می‌کند.
  </p>
<p>
<mark>AccountingServiceCommandHandler</mark> که در لیست زیر نشان داده شده است، با فراخوانی <mark>AggregateRepository.update()</mark> برای به‌روزرسانی <mark>Account aggregate</mark>، به پیام دستور <mark>AuthorizeAccount</mark> رسیدگی می‌کند.
  </p>
<pre><code class="language-java">public class AccountingServiceCommandHandler {
 @Autowired
 private AggregateRepository&lt;Account, AccountCommand&gt; accountRepository;
 public void authorize(CommandMessage&lt;AuthorizeCommand&gt; cm) {
  AuthorizeCommand command = cm.getCommand();
  accountRepository.update(command.getOrderId(),
  command,
  replyingTo(cm)
  .catching(AccountDisabledException.class,
  () -&gt; withFailure(new AccountDisabledReply()))
  .build());
 }
 ...
</code></pre>
<p>
   متد <mark>authorize()</mark> یک <mark>AggregateRepository</mark> را برای به‌روزرسانی <mark>Account aggregate</mark> فراخوانی می‌کند. آرگومان سوم به <mark>update()</mark>، که <mark>UpdateOptions</mark> است، توسط این عبارت محاسبه می‌شود:
  </p>
<pre><code>replyingTo(cm)
 .catching(AccountDisabledException.class,
 () -&gt; withFailure(new AccountDisabledReply()))
 .build()
</code></pre>
<p>
   این <mark>UpdateOptions</mark> متد <mark>update()</mark> را برای انجام موارد زیر پیکربندی می‌کند:
  </p>
<p>
   1
   از <mark>message id</mark> به عنوان یک <mark>idempotency key</mark> استفاده کنید تا اطمینان حاصل شود که پیام دقیقاً یک بار پردازش می‌شود. همانطور که قبلاً ذکر شد، فریم‌ورک <mark>Eventuate</mark>، <mark>idempotency key</mark> را در تمام <mark>events</mark> تولید شده ذخیره می‌کند و این امکان را فراهم می‌کند تا تلاش‌های تکراری برای به‌روزرسانی یک <mark>aggregate</mark> را شناسایی و نادیده بگیرد.
  </p>
<p>
   لیست 6.6
   <br/>
   رسیدگی به پیام‌های دستور ارسال شده توسط <mark>sagas</mark>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0245_original/original_page.png" alt="Original Page 245">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 6</mark></h3>
<p>
<mark>Developing business logic with event sourcing</mark>
</p>
<p>
   2
   یک <mark>SagaReplyRequestedEvent</mark> <mark>pseudo event</mark> به لیست <mark>events</mark> ذخیره شده در <mark>event store</mark> اضافه کنید. هنگامی که <mark>SagaReplyRequestedEventHandler</mark>، <mark>SagaReply-RequestedEvent</mark> <mark>pseudo event</mark> را دریافت می‌کند، یک پاسخ به <mark>reply channel</mark> <mark>CreateOrderSaga</mark> ارسال می‌کند.
  </p>
<p>
   3
   هنگامی که <mark>aggregate</mark> یک <mark>AccountDisabledException</mark> را <mark>throw</mark> می‌کند، به جای پاسخ خطای پیش‌فرض، یک <mark>AccountDisabledReply</mark> ارسال کنید.
  </p>
<p>
   اکنون که به چگونگی پیاده‌سازی <mark>saga participants</mark> با استفاده از <mark>event sourcing</mark> نگاهی انداختیم، بیایید نحوه پیاده‌سازی <mark>saga orchestrators</mark> را دریابیم.
  </p>
<h4><mark>6.3.4 Implementing saga orchestrators using event sourcing</mark></h4>
<p>
   تا به حال در این بخش، من توضیح داده‌ام که چگونه <mark>services</mark> مبتنی بر <mark>event sourcing</mark> می‌توانند <mark>sagas</mark> را آغاز و در آن‌ها مشارکت کنند. شما همچنین می‌توانید از <mark>event sourcing</mark> برای پیاده‌سازی <mark>saga orchestrators</mark> استفاده کنید. این به شما امکان می‌دهد برنامه‌هایی را توسعه دهید که کاملاً مبتنی بر یک <mark>event store</mark> هستند.
  </p>
<p>
   هنگام پیاده‌سازی یک <mark>saga orchestrator</mark> سه مشکل طراحی کلیدی وجود دارد که باید حل کنید:
  </p>
<ol>
<li>
    چگونه می‌توانید یک <mark>saga orchestrator</mark> را <mark>persist</mark> کنید؟
   </li>
<li>
    چگونه می‌توانید به‌طور اتمی وضعیت <mark>orchestrator</mark> را تغییر دهید و پیام‌های <mark>command</mark> را ارسال کنید؟
   </li>
<li>
    چگونه می‌توانید اطمینان حاصل کنید که یک <mark>saga orchestrator</mark> پیام‌های پاسخ را دقیقاً یک بار پردازش می‌کند؟
   </li>
</ol>
<p>
   فصل 4 نحوه پیاده‌سازی یک <mark>RDBMS-based saga orchestrator</mark> را مورد بحث قرار می‌دهد. بیایید نگاهی بیندازیم به نحوه حل این مشکلات هنگام استفاده از <mark>event sourcing</mark>.
  </p>
<h5><mark>PERSISTING A SAGA ORCHESTRATOR USING EVENT SOURCING</mark></h5>
<p>
   یک <mark>saga orchestrator</mark> یک چرخه عمر بسیار ساده دارد. ابتدا ایجاد می‌شود. سپس در پاسخ به پاسخ‌ها از <mark>saga participants</mark>، به‌روزرسانی می‌شود. بنابراین، ما می‌توانیم یک <mark>saga</mark> را با استفاده از <mark>events</mark> زیر <mark>persist</mark> کنیم:
  </p>
<p>
<ul>
<li><mark>SagaOrchestratorCreated</mark>—<mark>Saga orchestrator</mark> ایجاد شده است.</li>
<li><mark>SagaOrchestratorUpdated</mark>—<mark>Saga orchestrator</mark> به‌روزرسانی شده است.</li>
</ul>
</p>
<p>
   یک <mark>saga orchestrator</mark> یک <mark>SagaOrchestratorCreated event</mark> را هنگام ایجاد و یک <mark>SagaOrchestratorUpdated event</mark> را هنگام به‌روزرسانی منتشر می‌کند. این <mark>events</mark> حاوی داده‌های لازم برای بازسازی وضعیت <mark>saga orchestrator</mark> هستند. به عنوان مثال، <mark>events</mark> برای <mark>CreateOrderSaga</mark>، که در فصل 4 توضیح داده شد، شامل یک <mark>serialized</mark> (به عنوان مثال، <mark>JSON</mark>) <mark>CreateOrderSagaState</mark> خواهد بود.
  </p>
<h5><mark>SENDING COMMAND MESSAGES RELIABLY</mark></h5>
<p>
   یکی دیگر از مسائل مهم طراحی این است که چگونه می‌توان وضعیت <mark>saga</mark> را به‌طور اتمی به‌روزرسانی کرد و یک <mark>command</mark> را ارسال کرد. همانطور که در فصل 4 توضیح داده شد، پیاده‌سازی <mark>saga</mark> مبتنی بر <mark>Eventuate Tram</mark> این کار را با به‌روزرسانی <mark>orchestrator</mark> و وارد کردن پیام <mark>command</mark> به یک جدول پیام به عنوان بخشی از همان <mark>transaction</mark> انجام می‌دهد. یک application که از یک
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0246_original/original_page.png" alt="Original Page 246">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Using sagas and event sourcing together</mark></h3>
<p>
<mark>RDBMS-based event store</mark>، مانند <mark>Eventuate Local</mark>، می‌تواند از همین رویکرد استفاده کند. یک application که از یک <mark>NoSQL-based event store</mark>، مانند <mark>Eventuate SaaS</mark>، استفاده می‌کند، می‌تواند با وجود داشتن یک مدل <mark>transaction</mark> بسیار محدود، از یک رویکرد مشابه استفاده کند.
  </p>
<p>
   ترفند این است که یک <mark>SagaCommandEvent</mark>، که نشان دهنده یک دستور برای ارسال است، <mark>persist</mark> شود. سپس یک <mark>event handler</mark> به <mark>SagaCommandEvents</mark> مشترک می‌شود و هر پیام دستور را به کانال مناسب ارسال می‌کند. شکل 6.13 نشان می‌دهد که این چگونه کار می‌کند.
  </p>
<p>
<mark>saga orchestrator</mark> از یک فرآیند دو مرحله‌ای برای ارسال دستورات استفاده می‌کند:
  </p>
<ol>
<li>
    یک <mark>saga orchestrator</mark> برای هر دستوری که می‌خواهد ارسال کند، یک <mark>SagaCommandEvent</mark> منتشر می‌کند. <mark>SagaCommandEvent</mark> شامل تمام داده‌های مورد نیاز برای ارسال دستور، مانند کانال مقصد و <mark>command object</mark>، است. این <mark>events</mark> در <mark>event store</mark> <mark>persist</mark> می‌شوند.
   </li>
<li>
    یک <mark>event handler</mark> این <mark>SagaCommandEvents</mark> را پردازش می‌کند و پیام‌های دستور را به کانال پیام مقصد ارسال می‌کند.
   </li>
</ol>
<p>
   این رویکرد دو مرحله‌ای تضمین می‌کند که دستور حداقل یک بار ارسال می‌شود. از آنجایی که <mark>event store</mark> تحویل <mark>at-least-once</mark> را فراهم می‌کند، ممکن است یک <mark>event handler</mark> با یک <mark>event</mark> یکسان چندین بار فراخوانی شود. با این حال، این باعث می‌شود که <mark>event handler</mark> برای <mark>SagaCommandEvents</mark> پیام‌های دستور تکراری را ارسال کند. خوشبختانه، یک <mark>saga participant</mark> می‌تواند به راحتی دستورات تکراری را با استفاده از موارد زیر شناسایی و دور بریزد
  </p>
<p>
   2. رسیدگی به <mark>SagaCommandEvent</mark> با ارسال یک دستور.
  </p>
<p>
   1. انتشار یک <mark>SagaCommandEvent</mark> برای هر دستور برای ارسال.
  </p>
<p>
<mark>SagaCommandEvent</mark>
</p>
<p>
<mark>SagaCreatedEvent</mark>
</p>
<p>
<mark>SagaCommandEvent</mark>
</p>
<p>
<mark>SagaUpdatedEvent</mark>
</p>
<p>
   «<mark>saga</mark>»
  </p>
<p>
<mark>CreateOrderSaga</mark>
</p>
<p>
<mark>SagaCommand</mark>
</p>
<p>
<mark>EventHandler</mark>
</p>
<p>
<mark>Event store</mark>
</p>
<p>
<mark>Persisted as</mark>
</p>
<p>
<mark>Service</mark>
</p>
<p>
<mark>Service Command</mark>
<br/>
<mark>Channel</mark>
</p>
<p>
<mark>Sends</mark>
<br/>
<mark>command</mark>
</p>
<p>
<mark>Message broker</mark>
</p>
<p>
   شکل 6.13
   <br/>
   چگونه یک <mark>saga orchestrator</mark> مبتنی بر <mark>event sourcing</mark> دستورات را به <mark>saga participants</mark> ارسال می‌کند
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0247_original/original_page.png" alt="Original Page 247">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 6</mark></h3>
<p>
<mark>Developing business logic with event sourcing</mark>
</p>
<p>
   مکانیسم. <mark>ID</mark>ی <mark>SagaCommandEvent</mark>، که منحصربه‌فرد بودن آن تضمین شده است، به عنوان <mark>ID</mark> پیام دستور استفاده می‌شود. در نتیجه، پیام‌های تکراری دارای <mark>ID</mark> یکسان خواهند بود. یک <mark>saga participant</mark> که یک پیام دستور تکراری دریافت می‌کند، با استفاده از مکانیسم توضیح داده شده در قبل، آن را دور می‌زند.
  </p>
<h5><mark>PROCESSING REPLIES EXACTLY ONCE</mark></h5>
<p>
   یک <mark>saga orchestrator</mark> همچنین باید پیام‌های پاسخ تکراری را شناسایی و دور بریزد، که می‌تواند این کار را با استفاده از مکانیسم توضیح داده شده در قبل انجام دهد. <mark>Orchestrator</mark>، <mark>ID</mark> پیام پاسخ را در <mark>events</mark>ای که هنگام پردازش پاسخ منتشر می‌کند، ذخیره می‌کند. سپس می‌تواند به راحتی تعیین کند که آیا یک پیام تکراری است یا خیر.
  </p>
<p>
   همانطور که می‌بینید، <mark>event sourcing</mark> یک پایه خوب برای پیاده‌سازی <mark>sagas</mark> است. این علاوه بر مزایای دیگر <mark>event sourcing</mark>، از جمله تولید ذاتی قابل اعتماد <mark>events</mark> در هر زمان که داده‌ها تغییر می‌کنند، ثبت حسابرسی قابل اعتماد و توانایی انجام <mark>temporal queries</mark> است. با این حال، <mark>Event sourcing</mark> یک راه‌حل جادویی نیست. این شامل یک منحنی یادگیری قابل توجه است. تکامل <mark>event schema</mark> همیشه ساده نیست.
  </p>
<p>
   اما با وجود این معایب، <mark>event sourcing</mark> نقش مهمی در یک معماری <mark>microservice</mark> دارد. در فصل بعد، ما موضوع را تغییر می‌دهیم و به نحوه مقابله با یک چالش مدیریت داده‌های توزیع شده متفاوت در یک معماری <mark>microservice</mark> نگاه می‌کنیم:
   <mark>queries</mark>. من توضیح خواهم داد که چگونه <mark>queries</mark> را پیاده‌سازی کنیم که داده‌های پراکنده در چندین <mark>service</mark> را بازیابی می‌کنند.
  </p>
<p>
   خلاصه
  </p>
<p>
<ul>
<li><mark>Event sourcing</mark> یک <mark>aggregate</mark> را به عنوان یک توالی از <mark>events persist</mark> می‌کند. هر <mark>event</mark> نشان‌دهنده ایجاد <mark>aggregate</mark> یا یک تغییر وضعیت است. یک application، وضعیت یک <mark>aggregate</mark> را با <mark>replaying events</mark> دوباره ایجاد می‌کند. <mark>Event sourcing</mark> تاریخچه یک <mark>domain object</mark> را حفظ می‌کند، یک <mark>audit log</mark> دقیق ارائه می‌دهد و <mark>domain events</mark> را به طور قابل اعتماد منتشر می‌کند.</li>
<li><mark>Snapshots</mark> با کاهش تعداد <mark>events</mark> که باید دوباره پخش شوند، عملکرد را بهبود می‌بخشند.</li>
<li><mark>Events</mark> در یک <mark>event store</mark> ذخیره می‌شوند، ترکیبی از یک <mark>database</mark> و یک <mark>message broker</mark>. هنگامی که یک <mark>service</mark> یک <mark>event</mark> را در یک <mark>event store</mark> ذخیره می‌کند، <mark>event</mark> را به مشترکین تحویل می‌دهد.</li>
<li><mark>Eventuate Local</mark> یک <mark>event store</mark> متن‌باز مبتنی بر <mark>MySQL</mark> و <mark>Apache Kafka</mark> است. توسعه‌دهندگان از فریم‌ورک مشتری <mark>Eventuate</mark> برای نوشتن <mark>aggregates</mark> و <mark>event handlers</mark> استفاده می‌کنند.</li>
<li>یک چالش با استفاده از <mark>event sourcing</mark> رسیدگی به تکامل <mark>events</mark> است. یک application به طور بالقوه باید چندین نسخه <mark>event</mark> را هنگام <mark>replaying events</mark> مدیریت کند. یک راه‌حل خوب استفاده از <mark>upcasting</mark> است که <mark>events</mark> را به آخرین نسخه ارتقا می‌دهد، زمانی که از <mark>event store</mark> بارگذاری می‌شوند.</li>
<li>حذف داده‌ها در یک application <mark>event sourcing</mark> دشوار است. یک application باید از تکنیک‌هایی مانند رمزگذاری و <mark>pseudonymization</mark> استفاده کند تا با مقرراتی مانند <mark>GDPR</mark> اتحادیه اروپا مطابقت داشته باشد که نیاز دارد یک application داده‌های یک فرد را پاک کند.</li>
</ul>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0248_original/original_page.png" alt="Original Page 248">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Summary</mark></h3>
<p>
<ul>
<li><mark>Event sourcing</mark> یک راه ساده برای پیاده‌سازی <mark>sagas</mark> مبتنی بر <mark>choreography</mark> است. <mark>Services</mark> دارای <mark>event handlers</mark> هستند که به <mark>events</mark> منتشر شده توسط <mark>event sourcing-based aggregates</mark> گوش می‌دهند.</li>
<li><mark>Event sourcing</mark> یک راه خوب برای پیاده‌سازی <mark>saga orchestrators</mark> است. در نتیجه، شما می‌توانید برنامه‌هایی بنویسید که منحصراً از یک <mark>event store</mark> استفاده می‌کنند.</li>
</ul>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0249_original/original_page.png" alt="Original Page 249">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Implementing queries in a microservice architecture</mark></h3>
<p>
<mark>Mary</mark> و تیمش تازه داشتند با ایده استفاده از <mark>sagas</mark> برای حفظ <mark>data</mark> درستی، راحت می‌شدند. سپس متوجه شدند که مدیریت <mark>transaction</mark> تنها چالش مرتبط با <mark>data</mark> توزیع شده نبود که هنگام مهاجرت application <mark>FTGO</mark> به <mark>microservices</mark> باید نگران آن می‌بودند. آن‌ها همچنین باید نحوه پیاده‌سازی <mark>queries</mark> را نیز مشخص می‌کردند.
  </p>
<p>
   به منظور پشتیبانی از <mark>UI</mark>، application <mark>FTGO</mark> انواع عملیات <mark>query</mark> را پیاده‌سازی می‌کند. پیاده‌سازی این <mark>queries</mark> در application <mark>monolithic</mark> موجود نسبتاً ساده است، زیرا دارای یک <mark>database</mark> واحد است. برای بیشتر قسمت‌ها، تمام توسعه‌دهندگان <mark>FTGO</mark> فقط نیاز داشتند که دستورات <mark>SQL SELECT</mark> را بنویسند و <mark>indexes</mark> لازم را تعریف کنند. همانطور که <mark>Mary</mark> متوجه شد، نوشتن <mark>queries</mark> در یک معماری <mark>microservice</mark> چالش‌برانگیز است. <mark>Queries</mark> اغلب نیاز دارند که <mark>data</mark> پراکنده را بازیابی کنند.
  </p>
<p>
   این فصل موارد زیر را پوشش می‌دهد
  </p>
<ul>
<li>
    چالش‌های <mark>querying data</mark> در یک معماری <mark>microservice</mark>
</li>
<li>
    چه زمانی و چگونه <mark>queries</mark> را با استفاده از الگوی ترکیب <mark>API</mark> پیاده‌سازی کنیم
   </li>
<li>
    چه زمانی و چگونه <mark>queries</mark> را با استفاده از الگوی <mark>Command query responsibility segregation</mark>
    (<mark>CQRS</mark>) پیاده‌سازی کنیم
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0250_original/original_page.png" alt="Original Page 250">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Querying using the API composition pattern</mark></h3>
<p>
   در میان <mark>databases</mark> متعلق به چندین <mark>services</mark>. با این حال، شما نمی‌توانید از یک مکانیسم <mark>query</mark> توزیع شده سنتی استفاده کنید، زیرا حتی اگر از نظر فنی امکان‌پذیر باشد، <mark>encapsulation</mark> را نقض می‌کند.
  </p>
<p>
   به عنوان مثال، عملیات <mark>query</mark> برای application <mark>FTGO</mark> را که در فصل 2 توضیح داده شد، در نظر بگیرید. برخی از <mark>queries</mark> داده‌هایی را بازیابی می‌کنند که فقط متعلق به یک <mark>service</mark> هستند. به عنوان مثال، <mark>query</mark> <mark>find-ConsumerProfile()</mark>، داده‌ها را از <mark>Consumer Service</mark> برمی‌گرداند. اما سایر عملیات <mark>query</mark> <mark>FTGO</mark>، مانند <mark>findOrder()</mark> و <mark>findOrderHistory()</mark>، داده‌های متعلق به چندین <mark>services</mark> را برمی‌گردانند. پیاده‌سازی این عملیات <mark>query</mark> به این آسانی نیست.
  </p>
<p>
   دو الگو مختلف برای پیاده‌سازی عملیات <mark>query</mark> در یک معماری <mark>microservice</mark> وجود دارد:
  </p>
<ul>
<li>
    الگوی ترکیب <mark>API</mark>— این ساده‌ترین رویکرد است و باید در صورت امکان استفاده شود. این کار با مسئول قرار دادن <mark>clients</mark> از <mark>services</mark>ی که مالک <mark>data</mark> هستند برای فراخوانی <mark>services</mark> و ترکیب نتایج، کار می‌کند.
   </li>
<li>
    الگوی <mark>Command query responsibility segregation</mark> (<mark>CQRS</mark>)— این الگو قدرتمندتر از الگوی ترکیب <mark>API</mark> است، اما پیچیده‌تر نیز هست. این الگو یک یا چند <mark>view databases</mark> را حفظ می‌کند که تنها هدف آن‌ها پشتیبانی از <mark>queries</mark> است.
   </li>
</ul>
<p>
   پس از بحث در مورد این دو الگو، در مورد نحوه طراحی <mark>CQRS views</mark> صحبت خواهم کرد، و به دنبال آن پیاده‌سازی یک <mark>view</mark> نمونه انجام می‌شود. بیایید با نگاهی به الگوی ترکیب <mark>API</mark> شروع کنیم.
  </p>
<h4><mark>7.1 Querying using the API composition pattern</mark></h4>
<p>
   Application <mark>FTGO</mark> عملیات <mark>query</mark> متعددی را پیاده‌سازی می‌کند. همانطور که قبلاً ذکر شد، برخی از <mark>queries</mark> داده‌ها را از یک <mark>service</mark> واحد بازیابی می‌کنند. پیاده‌سازی این <mark>queries</mark> معمولاً ساده است - اگرچه در اواخر این فصل، زمانی که الگوی <mark>CQRS</mark> را پوشش می‌دهم، نمونه‌هایی از <mark>queries</mark> تک <mark>service</mark> را خواهید دید که پیاده‌سازی آن‌ها چالش‌برانگیز است.
  </p>
<p>
   همچنین <mark>queries</mark>ای وجود دارد که داده‌ها را از چندین <mark>service</mark> بازیابی می‌کنند. در این بخش، من عملیات <mark>query</mark> <mark>findOrder()</mark> را توضیح می‌دهم، که نمونه‌ای از یک <mark>query</mark> است که داده‌ها را از چندین <mark>service</mark> بازیابی می‌کند. من چالش‌هایی را که اغلب هنگام پیاده‌سازی این نوع <mark>query</mark> در یک معماری <mark>microservice</mark> ایجاد می‌شود، توضیح می‌دهم. سپس الگوی ترکیب <mark>API</mark> را توضیح می‌دهم و نشان می‌دهم که چگونه می‌توانید از آن برای پیاده‌سازی <mark>queries</mark> مانند <mark>findOrder()</mark> استفاده کنید.
  </p>
<h5><mark>7.1.1 The findOrder() query operation</mark></h5>
<p>
   عملیات <mark>findOrder()</mark> یک سفارش را بر اساس <mark>primary key</mark> آن بازیابی می‌کند. این یک <mark>orderId</mark> را به عنوان یک پارامتر دریافت می‌کند و یک شی <mark>OrderDetails</mark> را برمی‌گرداند، که شامل اطلاعاتی در مورد سفارش است. همانطور که در شکل 7.1 نشان داده شده است، این عملیات توسط یک ماژول <mark>frontend</mark>، مانند یک دستگاه تلفن همراه یا یک application وب، که نمای وضعیت سفارش را پیاده‌سازی می‌کند، فراخوانی می‌شود.
  </p>
<p>
   اطلاعاتی که توسط نمای وضعیت سفارش نمایش داده می‌شود شامل اطلاعات اولیه در مورد سفارش، از جمله وضعیت آن، وضعیت پرداخت، وضعیت سفارش از
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0251_original/original_page.png" alt="Original Page 251">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
   از دیدگاه رستوران، و وضعیت تحویل، از جمله موقعیت مکانی و زمان تحویل تخمینی آن، اگر در حال حمل و نقل باشد.
  </p>
<p>
   از آنجایی که داده‌های آن در یک <mark>database</mark> واحد قرار دارد، application <mark>monolithic FTGO</mark> می‌تواند به راحتی جزئیات سفارش را با اجرای یک عبارت <mark>SELECT</mark> واحد که جداول مختلف را <mark>join</mark> می‌کند، بازیابی کند. در مقابل، در نسخه مبتنی بر <mark>microservices</mark> application <mark>FTGO</mark>، داده‌ها در <mark>services</mark> زیر پراکنده شده‌اند:
  </p>
<ul>
<li>
<mark>Order Service</mark>— اطلاعات سفارش اولیه، از جمله جزئیات و وضعیت
   </li>
<li>
<mark>Kitchen Service</mark>— وضعیت سفارش از دیدگاه رستوران و زمان تخمینی آماده شدن آن برای تحویل
   </li>
<li>
<mark>Delivery Service</mark>— وضعیت تحویل سفارش، اطلاعات تحویل تخمینی و موقعیت مکانی فعلی آن
   </li>
<li>
<mark>Accounting Service</mark>— وضعیت پرداخت سفارش
   </li>
</ul>
<p>
   هر <mark>client</mark> که به جزئیات سفارش نیاز دارد، باید از همه این <mark>services</mark> درخواست کند.
  </p>
<h5><mark>7.1.2 Overview of the API composition pattern</mark></h5>
<p>
   یک راه برای پیاده‌سازی عملیات <mark>query</mark>، مانند <mark>findOrder()</mark>، که داده‌های متعلق به چندین <mark>services</mark> را بازیابی می‌کند، استفاده از الگوی ترکیب <mark>API</mark> است. این الگو یک
  </p>
<p>
<mark>Order</mark>
<br/>
<mark>Order Service</mark>
<br/>
<mark>id:3492-2323</mark>
<br/>
<mark>restaurant:Ajanta</mark>
</p>
<p>
<mark>Ticket</mark>
<br/>
<mark>Kitchen Service</mark>
</p>
<p>
   application <mark>FTGO</mark>
<br/>
<mark>OrderDetails findOrder(orderId)</mark>
</p>
<p>
<mark>FTGO frontend</mark>
</p>
<p>
<mark>Order status view</mark>
</p>
<p>
<mark>Order id:</mark>
<br/>
<mark>Restaurant:</mark>
<br/>
<mark>Status:</mark>
<br/>
<mark>ETA:</mark>
<br/>
<mark>Payment:</mark>
<br/>
<mark>3492-2323</mark>
<br/>
<mark>Ajanta</mark>
<br/>
<mark>En route</mark>
<br/>
<mark>6:25 pm</mark>
<br/>
<mark>Paid</mark>
</p>
<p>
<mark>id:3492-2323</mark>
<br/>
<mark>status:PREPARED</mark>
</p>
<p>
<mark>Delivery</mark>
<br/>
<mark>Delivery Service</mark>
<br/>
<mark>id:45-4545</mark>
<br/>
<mark>orderId:3492-2323</mark>
<br/>
<mark>status:ENROUTE</mark>
<br/>
<mark>eta:6:25 pm</mark>
</p>
<p>
<mark>Bill</mark>
<br/>
<mark>Accounting Service</mark>
<br/>
<mark>id:343-45611</mark>
<br/>
<mark>orderId:3492-2323</mark>
<br/>
<mark>status:PAID</mark>
</p>
<p>
   وضعیت سفارش
   <br/>
<mark>Data</mark> از چندین <mark>services</mark>
<br/>
   دستگاه تلفن همراه یا application وب
  </p>
<p>
   شکل 7.1
   <br/>
   عملیات <mark>findOrder()</mark> توسط یک ماژول <mark>FTGO frontend</mark> فراخوانی می‌شود و جزئیات یک <mark>Order</mark> را برمی‌گرداند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0252_original/original_page.png" alt="Original Page 252">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Querying using the API composition pattern</mark></h3>
<p>
   عملیات <mark>query</mark> با فراخوانی <mark>services</mark>ی که مالک <mark>data</mark> هستند و ترکیب نتایج. شکل 7.2 ساختار این الگو را نشان می‌دهد. این الگو دارای دو نوع شرکت‌کننده است:
  </p>
<ul>
<li>
    یک <mark>API composer</mark>— این عملیات <mark>query</mark> را با <mark>querying</mark> <mark>provider services</mark> پیاده‌سازی می‌کند.
   </li>
<li>
    یک <mark>provider service</mark>— این یک <mark>service</mark> است که مالک بخشی از <mark>data</mark> است که <mark>query</mark> برمی‌گرداند.
   </li>
</ul>
<p>
   شکل 7.2 سه <mark>provider services</mark> را نشان می‌دهد. <mark>API composer</mark>، <mark>query</mark> را با بازیابی <mark>data</mark> از <mark>provider services</mark> و ترکیب نتایج، پیاده‌سازی می‌کند. یک <mark>API composer</mark> ممکن است یک <mark>client</mark> باشد، مانند یک application وب، که برای رندر کردن یک صفحه وب به <mark>data</mark> نیاز دارد. یا، ممکن است یک <mark>service</mark> باشد، مانند یک <mark>API gateway</mark> و <mark>Backends for frontends</mark> آن که در فصل 8 توضیح داده شد، که عملیات <mark>query</mark> را به عنوان یک <mark>API endpoint</mark> در معرض دید قرار می‌دهد.
  </p>
<p>
   اینکه آیا می‌توانید از این الگو برای پیاده‌سازی یک عملیات <mark>query</mark> خاص استفاده کنید، به عوامل متعددی بستگی دارد، از جمله نحوه تقسیم <mark>data</mark>، قابلیت‌های <mark>APIs</mark> ارائه شده توسط <mark>services</mark>ی که مالک <mark>data</mark> هستند، و قابلیت‌های <mark>databases</mark>ی که توسط <mark>services</mark> استفاده می‌شوند. به عنوان مثال، حتی اگر <mark>Provider services</mark> دارای <mark>APIs</mark> برای بازیابی
  </p>
<p>
   الگو: ترکیب <mark>API</mark>
<br/>
   یک <mark>query</mark> را پیاده‌سازی کنید که <mark>data</mark> را از چندین <mark>services</mark> با <mark>querying</mark> هر <mark>service</mark> از طریق <mark>API</mark> آن و ترکیب نتایج، بازیابی می‌کند. به <mark>http://microservices.io/patterns/data/api-composition.html</mark> مراجعه کنید.
  </p>
<p>
<mark>query()</mark>
<br/>
<mark>API composer</mark>
</p>
<p>
<mark>Provider Service A</mark>
<br/>
<mark>Database A</mark>
<br/>
<mark>queryA()</mark>
</p>
<p>
<mark>Provider Service B</mark>
<br/>
<mark>Database B</mark>
<br/>
<mark>queryB()</mark>
</p>
<p>
<mark>Provider Service C</mark>
<br/>
<mark>Database C</mark>
<br/>
<mark>queryC()</mark>
</p>
<p>
   عملیات <mark>query</mark> را با فراخوانی <mark>providers</mark> و
   <br/>
   ترکیب نتایج، پیاده‌سازی می‌کند.
   <br/>
<mark>Services</mark> که مالک <mark>data</mark> هستند
  </p>
<p>
   شکل 7.2
   <br/>
   الگوی ترکیب <mark>API</mark> از یک <mark>API composer</mark> و دو یا چند <mark>provider services</mark> تشکیل شده است. <mark>API composer</mark> یک <mark>query</mark> را با <mark>querying</mark> <mark>providers</mark> و ترکیب نتایج، پیاده‌سازی می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0253_original/original_page.png" alt="Original Page 253">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
<mark>data</mark> مورد نیاز، جمع‌کننده ممکن است نیاز به انجام یک <mark>join</mark> درون حافظه‌ای ناکارآمد از <mark>datasets</mark> بزرگ داشته باشد. در ادامه، نمونه‌هایی از عملیات <mark>query</mark> را مشاهده خواهید کرد که نمی‌توانند با استفاده از این الگو پیاده‌سازی شوند. با این حال، خوشبختانه، سناریوهای زیادی وجود دارد که این الگو در آن‌ها قابل اجرا است. برای دیدن آن در عمل، به یک مثال نگاه می‌کنیم.
  </p>
<h4><mark>7.1.3 Implementing the findOrder() query operation using the API composition pattern</mark></h4>
<p>
   عملیات <mark>query</mark> <mark>findOrder()</mark> مربوط به یک <mark>query</mark> <mark>equi-join</mark> مبتنی بر <mark>primary key</mark> ساده است. منطقی است که انتظار داشته باشیم که هر یک از <mark>Provider services</mark> یک <mark>API endpoint</mark> برای بازیابی <mark>data</mark> مورد نیاز توسط <mark>orderId</mark> داشته باشد. در نتیجه، عملیات <mark>query</mark> <mark>findOrder()</mark> یک کاندیدای عالی برای پیاده‌سازی توسط الگوی ترکیب <mark>API</mark> است. <mark>API composer</mark> چهار <mark>service</mark> را فراخوانی می‌کند و نتایج را با هم ترکیب می‌کند.
  </p>
<p>
   شکل 7.3 طراحی <mark>Find Order Composer</mark> را نشان می‌دهد.
  </p>
<p>
   در این مثال، <mark>API composer</mark> یک <mark>service</mark> است که <mark>query</mark> را به عنوان یک <mark>REST endpoint</mark> در معرض دید قرار می‌دهد. <mark>Provider services</mark> نیز <mark>REST APIs</mark> را پیاده‌سازی می‌کنند. اما اگر <mark>services</mark> از پروتکل ارتباط بین فرآیندی دیگری مانند <mark>gRPC</mark> به جای <mark>HTTP</mark> استفاده می‌کردند، مفهوم یکسان بود. <mark>Find Order Composer</mark> یک <mark>REST endpoint</mark> <mark>GET /order/{orderId}</mark> را پیاده‌سازی می‌کند. این چهار <mark>service</mark> را فراخوانی می‌کند و پاسخ‌ها را با استفاده از <mark>orderId</mark> <mark>join</mark> می‌کند. هر <mark>Provider service</mark> یک <mark>REST endpoint</mark> را پیاده‌سازی می‌کند که پاسخی مربوط به یک <mark>aggregate</mark> واحد را برمی‌گرداند. <mark>OrderService</mark> نسخه خود از یک <mark>Order</mark> را با <mark>primary key</mark> بازیابی می‌کند و سایر <mark>services</mark> از <mark>orderId</mark> به عنوان یک <mark>foreign key</mark> برای بازیابی <mark>aggregates</mark> خود استفاده می‌کنند.
  </p>
<p>
   همانطور که می‌بینید، الگوی ترکیب <mark>API</mark> بسیار ساده است. بیایید به چند مسئله طراحی که باید هنگام اعمال این الگو به آن‌ها رسیدگی کنید، نگاهی بیندازیم.
  </p>
<p>
<mark>Find Order</mark>
<br/>
<mark>Composer</mark>
</p>
<p>
<mark>Order Service</mark>
<br/>
   «<mark>aggregate</mark>»
   <br/>
<mark>Order</mark>
<br/>
<mark>GET/orders/</mark>
<br/>
<mark>{orderId}</mark>
</p>
<p>
<mark>GET/charges?</mark>
<br/>
<mark>orderId=</mark>
<br/>
<mark>{orderId}</mark>
</p>
<p>
<mark>GET/tickets?</mark>
<br/>
<mark>orderId=</mark>
<br/>
<mark>{orderId}</mark>
</p>
<p>
<mark>GET/deliveries?</mark>
<br/>
<mark>orderId=</mark>
<br/>
<mark>{orderId}</mark>
</p>
<p>
<mark>Kitchen Service</mark>
<br/>
   «<mark>aggregate</mark>»
   <br/>
<mark>RestaurantOrder</mark>
</p>
<p>
<mark>Delivery Service</mark>
<br/>
   «<mark>aggregate</mark>»
   <br/>
<mark>Delivery</mark>
</p>
<p>
<mark>Accounting Service</mark>
<br/>
   «<mark>aggregate</mark>»
   <br/>
<mark>Charge</mark>
<br/>
<mark>GET/order/{orderId}</mark>
</p>
<p>
   شکل 7.3
   <br/>
   پیاده‌سازی <mark>findOrder()</mark> با استفاده از الگوی ترکیب <mark>API</mark>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0254_original/original_page.png" alt="Original Page 254">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Querying using the API composition pattern</mark></h3>
<h4><mark>7.1.4 API composition design issues</mark></h4>
<p>
   هنگام استفاده از این الگو، شما باید به چند مسئله طراحی رسیدگی کنید:
  </p>
<ul>
<li>
    تصمیم‌گیری در مورد اینکه کدام کامپوننت در معماری شما، <mark>API</mark> <mark>composer</mark> عملیات <mark>query</mark> است
   </li>
<li>
    چگونه منطق تجمیع کارآمد را بنویسیم
   </li>
</ul>
<p>
   بیایید به هر مسئله نگاهی بیندازیم.
  </p>
<h5><mark>WHO PLAYS THE ROLE OF THE API COMPOSER?</mark></h5>
<p>
   یک تصمیم که شما باید بگیرید این است که چه کسی نقش <mark>API</mark> <mark>composer</mark> عملیات <mark>query</mark> را ایفا می‌کند. شما سه گزینه دارید. اولین گزینه، که در شکل 7.4 نشان داده شده است، این است که یک <mark>client</mark> از <mark>services</mark>، <mark>API</mark> <mark>composer</mark> باشد.
  </p>
<p>
   یک <mark>client frontend</mark>، مانند یک application وب، که نمای وضعیت سفارش را پیاده‌سازی می‌کند و در همان <mark>LAN</mark> در حال اجرا است، می‌تواند داده‌های سفارش را با استفاده از این الگو به طور کارآمد بازیابی کند. اما همانطور که در فصل 8 خواهید آموخت، این گزینه احتمالاً برای <mark>clients</mark>ی که خارج از <mark>firewall</mark> هستند و از طریق یک شبکه کندتر به <mark>services</mark> دسترسی دارند، عملی نیست.
  </p>
<p>
   گزینه دوم، که در شکل 7.5 نشان داده شده است، این است که یک <mark>API gateway</mark>، که <mark>API</mark> خارجی application را پیاده‌سازی می‌کند، نقش یک <mark>API composer</mark> را برای یک عملیات <mark>query</mark> ایفا کند.
  </p>
<p>
   این گزینه منطقی است اگر عملیات <mark>query</mark> بخشی از <mark>API</mark> خارجی application باشد. به جای مسیریابی یک درخواست به یک <mark>service</mark> دیگر، <mark>API gateway</mark> منطق ترکیب <mark>API</mark> را پیاده‌سازی می‌کند. این رویکرد، یک <mark>client</mark>، مانند یک دستگاه تلفن همراه، که در خارج از <mark>firewall</mark> در حال اجرا است، را قادر می‌سازد تا داده‌ها را از چندین <mark>services</mark> با یک تماس <mark>API</mark> واحد به طور کارآمد بازیابی کند. من در فصل 8 در مورد <mark>API gateway</mark> بحث می‌کنم.
  </p>
<p>
   گزینه سوم، که در شکل 7.6 نشان داده شده است، پیاده‌سازی یک <mark>API composer</mark> به عنوان یک <mark>service</mark> مستقل است.
  </p>
<p>
<mark>Client</mark>، مانند application وب
  </p>
<p>
<mark>Order</mark>
<br/>
<mark>Service</mark>
</p>
<p>
<mark>Delivery</mark>
<br/>
<mark>Service</mark>
</p>
<p>
<mark>Kitchen</mark>
<br/>
<mark>Service</mark>
</p>
<p>
<mark>Accounting</mark>
<br/>
<mark>Service</mark>
</p>
<p>
<mark>API composer</mark>
</p>
<p>
   شکل 7.4
   <br/>
   پیاده‌سازی ترکیب <mark>API</mark> در یک <mark>client</mark>. <mark>Client</mark> <mark>queries</mark> را به <mark>provider services</mark> برای بازیابی <mark>data</mark> ارسال می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0255_original/original_page.png" alt="Original Page 255">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
<mark>API gateway</mark>
<br/>
<mark>External client</mark>، مانند
   <br/>
   application تلفن همراه
  </p>
<p>
<mark>Order</mark>
<br/>
<mark>Service</mark>
</p>
<p>
<mark>Delivery</mark>
<br/>
<mark>Service</mark>
</p>
<p>
<mark>Kitchen</mark>
<br/>
<mark>Service</mark>
</p>
<p>
<mark>Accounting</mark>
<br/>
<mark>Service</mark>
</p>
<p>
<mark>ﬁndOrder()</mark>
<br/>
<mark>API composer</mark>
</p>
<p>
   شکل 7.5
   <br/>
   پیاده‌سازی ترکیب <mark>API</mark> در <mark>API gateway</mark>. <mark>API</mark>، <mark>queries</mark> را به <mark>provider services</mark> برای بازیابی
   <br/>
<mark>data</mark> ارسال می‌کند، نتایج را ترکیب می‌کند و یک پاسخ را به <mark>client</mark> برمی‌گرداند.
  </p>
<p>
<mark>Order</mark>
<br/>
<mark>Service</mark>
</p>
<p>
<mark>Delivery</mark>
<br/>
<mark>Service</mark>
</p>
<p>
<mark>Kitchen</mark>
<br/>
<mark>Service</mark>
</p>
<p>
<mark>Accounting</mark>
<br/>
<mark>Service</mark>
</p>
<p>
<mark>Find Order Service</mark>
<br/>
<mark>Clients</mark>
</p>
<p>
<mark>ﬁndOrder()</mark>
<br/>
<mark>API composer</mark>
</p>
<p>
   شکل 7.6
   <br/>
   یک عملیات <mark>query</mark> را که توسط چندین <mark>clients</mark> و <mark>services</mark> استفاده می‌شود، به عنوان یک <mark>service</mark> مستقل پیاده‌سازی کنید.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0256_original/original_page.png" alt="Original Page 256">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Querying using the API composition pattern</mark></h3>
<p>
   شما باید از این گزینه برای یک عملیات <mark>query</mark> که به صورت داخلی توسط چندین <mark>service</mark> استفاده می‌شود، استفاده کنید. این عملیات همچنین می‌تواند برای عملیات <mark>query</mark> قابل دسترسی خارجی که منطق تجمیع آن‌ها برای بخشی از یک <mark>API gateway</mark> بیش از حد پیچیده است، استفاده شود.
  </p>
<h5><mark>API COMPOSERS SHOULD USE A REACTIVE PROGRAMMING MODEL</mark></h5>
<p>
   هنگام توسعه یک سیستم توزیع شده، به حداقل رساندن تأخیر یک نگرانی همیشگی است. هر زمان که امکان داشته باشد، یک <mark>API composer</mark> باید <mark>services</mark> <mark>provider</mark> را به صورت موازی فراخوانی کند تا زمان پاسخ برای یک عملیات <mark>query</mark> را به حداقل برساند. به عنوان مثال، <mark>Find Order Aggregator</mark>، باید چهار <mark>service</mark> را همزمان فراخوانی کند زیرا هیچ وابستگی بین فراخوانی‌ها وجود ندارد. با این حال، گاهی اوقات، یک <mark>API composer</mark> برای فراخوانی <mark>service</mark> دیگری به نتیجه یک <mark>Provider service</mark> نیاز دارد. در این صورت، لازم است که برخی از <mark>services</mark> <mark>provider</mark> را به صورت متوالی فراخوانی کند - اما امیدوارم که نه همه آن‌ها را.
  </p>
<p>
   منطق برای اجرای کارآمد ترکیبی از فراخوانی‌های <mark>service</mark> متوالی و موازی می‌تواند پیچیده باشد. برای اینکه یک <mark>API composer</mark> هم قابل نگهداری و هم با کارایی و مقیاس‌پذیری باشد، باید از یک طراحی واکنشی مبتنی بر <mark>Java Completable-Future’s</mark>، <mark>RxJava observables</mark>، یا یک انتزاع معادل دیگر استفاده کند. من این موضوع را در فصل 8 که الگوی <mark>API gateway</mark> را پوشش می‌دهم، بیشتر مورد بحث قرار می‌دهم.
  </p>
<h5><mark>7.1.5 The benefits and drawbacks of the API composition pattern</mark></h5>
<p>
   این الگو یک راه ساده و شهودی برای پیاده‌سازی عملیات <mark>query</mark> در یک معماری <mark>microservice</mark> است. اما دارای معایبی است:
  </p>
<ul>
<li>
    افزایش سربار
   </li>
<li>
    خطر کاهش دسترسی‌پذیری
   </li>
<li>
    عدم سازگاری <mark>data</mark> تراکنشی
   </li>
</ul>
<p>
   بیایید نگاهی به آن‌ها بیندازیم.
  </p>
<h5><mark>INCREASED OVERHEAD</mark></h5>
<p>
   یکی از معایب این الگو، سربار فراخوانی چندین <mark>services</mark> و <mark>querying</mark> چندین <mark>databases</mark> است. در یک application <mark>monolithic</mark>، یک <mark>client</mark> می‌تواند داده‌ها را با یک درخواست واحد بازیابی کند، که اغلب یک <mark>query</mark> <mark>database</mark> واحد را اجرا می‌کند. در مقایسه، استفاده از الگوی ترکیب <mark>API</mark> شامل چندین درخواست و <mark>database queries</mark> است. در نتیجه، منابع محاسباتی و شبکه بیشتری مورد نیاز است که هزینه اجرای application را افزایش می‌دهد.
  </p>
<h5><mark>RISK OF REDUCED AVAILABILITY</mark></h5>
<p>
   یکی دیگر از معایب این الگو، کاهش دسترسی‌پذیری است. همانطور که در فصل 3 توضیح داده شد، دسترسی‌پذیری یک عملیات با تعداد <mark>services</mark> درگیر کاهش می‌یابد. از آنجایی که پیاده‌سازی یک عملیات <mark>query</mark> شامل حداقل سه <mark>service</mark> است—<mark>API composer</mark> و حداقل دو <mark>provider services</mark>—دسترسی‌پذیری آن به طور قابل توجهی کمتر از یک <mark>service</mark> واحد خواهد بود. به عنوان مثال، اگر دسترسی‌پذیری یک <mark>service</mark> فردی 99.5٪ باشد، در این صورت دسترسی‌پذیری <mark>endpoint</mark> <mark>findOrder()</mark>، که چهار <mark>provider services</mark> را فراخوانی می‌کند، 99.5٪(4+1) = 97.5٪ است!
  </p>
<p>
   چندین استراتژی وجود دارد که می‌توانید برای بهبود دسترسی‌پذیری از آن‌ها استفاده کنید. اولین استراتژی این است که <mark>API composer</mark> در صورت عدم موفقیت یک <mark>Provider service</mark>، داده‌های ذخیره شده قبلی را برگرداند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0257_original/original_page.png" alt="Original Page 257">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
   ناموجود. یک <mark>API composer</mark> گاهی اوقات داده‌های بازگشتی توسط یک <mark>Provider service</mark> را برای بهبود عملکرد در حافظه پنهان ذخیره می‌کند. همچنین می‌تواند از این <mark>cache</mark> برای بهبود دسترسی‌پذیری استفاده کند. اگر یک <mark>provider</mark> در دسترس نباشد، <mark>API composer</mark> می‌تواند داده‌ها را از <mark>cache</mark> برگرداند، اگرچه ممکن است بالقوه قدیمی باشد.
  </p>
<p>
   یک استراتژی دیگر برای بهبود دسترسی‌پذیری این است که <mark>API composer</mark> داده‌های ناقص را برگرداند. به عنوان مثال، تصور کنید که <mark>Kitchen Service</mark> به طور موقت در دسترس نیست.
   <br/>
<mark>API Composer</mark> برای عملیات <mark>query</mark> <mark>findOrder()</mark> می‌تواند داده‌های آن <mark>service</mark> را از پاسخ حذف کند، زیرا <mark>UI</mark> همچنان می‌تواند اطلاعات مفیدی را نمایش دهد. جزئیات بیشتری در مورد طراحی <mark>API</mark>، <mark>caching</mark>، و قابلیت اطمینان را در فصل 8 مشاهده خواهید کرد.
  </p>
<h5><mark>LACK OF TRANSACTIONAL DATA CONSISTENCY</mark></h5>
<p>
   یکی دیگر از معایب الگوی ترکیب <mark>API</mark>، عدم سازگاری <mark>data</mark> است. یک application <mark>monolithic</mark> معمولاً یک عملیات <mark>query</mark> را با استفاده از یک <mark>transaction database</mark> واحد اجرا می‌کند. تراکنش‌های <mark>ACID</mark>— منوط به چاپ ریز در مورد سطوح <mark>isolation</mark>— تضمین می‌کنند که یک application دارای یک نمای سازگار از <mark>data</mark> است، حتی اگر چندین <mark>database queries</mark> را اجرا کند. در مقابل، الگوی ترکیب <mark>API</mark> چندین <mark>database queries</mark> را در برابر چندین <mark>databases</mark> اجرا می‌کند. بنابراین، این خطر وجود دارد که یک عملیات <mark>query</mark> داده‌های ناسازگار را برمی‌گرداند.
  </p>
<p>
   به عنوان مثال، یک <mark>Order</mark> بازیابی شده از <mark>Order Service</mark> ممکن است در وضعیت <mark>CANCELLED</mark> باشد، در حالی که <mark>Ticket</mark> مربوطه بازیابی شده از <mark>Kitchen Service</mark> ممکن است هنوز لغو نشده باشد. <mark>API composer</mark> باید این اختلاف را حل کند، که پیچیدگی کد را افزایش می‌دهد. بدتر از آن، یک <mark>API composer</mark> ممکن است همیشه نتواند داده‌های ناسازگار را شناسایی کند و آن را به <mark>client</mark> برمی‌گرداند.
  </p>
<p>
   با وجود این معایب، الگوی ترکیب <mark>API</mark> بسیار مفید است. شما می‌توانید از آن برای پیاده‌سازی بسیاری از عملیات <mark>query</mark> استفاده کنید. اما برخی از عملیات <mark>query</mark> وجود دارد که نمی‌توان آن‌ها را با استفاده از این الگو به طور کارآمد پیاده‌سازی کرد. به عنوان مثال، یک عملیات <mark>query</mark> ممکن است نیاز داشته باشد که <mark>API composer</mark> یک <mark>join</mark> درون حافظه‌ای از <mark>datasets</mark> بزرگ را انجام دهد.
  </p>
<p>
   معمولاً بهتر است این نوع عملیات <mark>query</mark> را با استفاده از الگوی <mark>CQRS</mark> پیاده‌سازی کنید. بیایید نگاهی به نحوه عملکرد این الگو بیندازیم.
  </p>
<h4><mark>7.2 Using the CQRS pattern</mark></h4>
<p>
   بسیاری از application های سازمانی از یک <mark>RDBMS</mark> به عنوان سیستم سوابق <mark>transactional</mark> و یک <mark>database</mark> جستجوی متنی، مانند <mark>Elasticsearch</mark> یا <mark>Solr</mark>، برای <mark>text search queries</mark> استفاده می‌کنند. برخی از application ها با نوشتن همزمان در هر دو، <mark>databases</mark> را همگام نگه می‌دارند. سایرین به صورت دوره‌ای داده‌ها را از <mark>RDBMS</mark> به موتور جستجوی متنی کپی می‌کنند. application هایی با این معماری، از نقاط قوت چندین <mark>database</mark> بهره می‌برند: ویژگی‌های <mark>transactional</mark> <mark>RDBMS</mark> و قابلیت‌های <mark>querying</mark> <mark>database</mark> متنی.
  </p>
<p>
   الگو: جداسازی مسئولیت <mark>command query</mark>
<br/>
   یک <mark>query</mark> را پیاده‌سازی کنید که برای <mark>data</mark> از چندین <mark>services</mark> با استفاده از <mark>events</mark> برای حفظ یک <mark>view</mark> فقط خواندنی که داده‌ها را از <mark>services</mark> تکرار می‌کند، نیاز دارد. به <mark>http://microservices</mark> مراجعه کنید.
   <br/>
   .io/patterns/data/cqrs.html.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0258_original/original_page.png" alt="Original Page 258">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Using the CQRS pattern</mark></h3>
<p>
<mark>CQRS</mark> یک تعمیم از این نوع معماری است. این الگو یک یا چند <mark>view databases</mark>— نه فقط <mark>text search databases</mark>— را حفظ می‌کند که یک یا چند <mark>queries</mark> application را پیاده‌سازی می‌کنند. برای درک دلیل مفید بودن این موضوع، به برخی از <mark>queries</mark> که نمی‌توانند با استفاده از الگوی ترکیب <mark>API</mark> به طور کارآمد پیاده‌سازی شوند، نگاهی می‌اندازیم. من توضیح خواهم داد که <mark>CQRS</mark> چگونه کار می‌کند و سپس در مورد مزایا و معایب <mark>CQRS</mark> صحبت خواهم کرد. بیایید نگاهی بیندازیم به زمانی که شما نیاز به استفاده از <mark>CQRS</mark> دارید.
  </p>
<h4><mark>7.2.1 Motivations for using CQRS</mark></h4>
<p>
   الگوی ترکیب <mark>API</mark> یک راه خوب برای پیاده‌سازی بسیاری از <mark>queries</mark> است که باید داده‌ها را از چندین <mark>services</mark> بازیابی کنند. متأسفانه، این فقط یک راه‌حل جزئی برای مشکل <mark>querying</mark> در یک معماری <mark>microservice</mark> است. این به این دلیل است که چندین <mark>service queries</mark> وجود دارد که الگوی ترکیب <mark>API</mark> نمی‌تواند آن‌ها را به طور کارآمد پیاده‌سازی کند.
  </p>
<p>
   علاوه بر این، <mark>single service queries</mark> نیز وجود دارد که پیاده‌سازی آن‌ها چالش‌برانگیز است. شاید <mark>database</mark> سرویس، <mark>query</mark> را به طور کارآمد پشتیبانی نکند. از طرف دیگر، گاهی اوقات منطقی است که یک <mark>service</mark> یک <mark>query</mark> را پیاده‌سازی کند که داده‌های متعلق به یک <mark>service</mark> دیگر را بازیابی می‌کند. بیایید به این مشکلات نگاهی بیندازیم، با یک <mark>query</mark> چند <mark>service</mark> شروع می‌کنیم که نمی‌تواند با استفاده از ترکیب <mark>API</mark> به طور کارآمد پیاده‌سازی شود.
  </p>
<h5><mark>IMPLEMENTING THE FINDORDERHISTORY() QUERY OPERATION</mark></h5>
<p>
   عملیات <mark>findOrderHistory()</mark>، تاریخچه سفارش یک مصرف‌کننده را بازیابی می‌کند. این چندین پارامتر دارد:
  </p>
<ul>
<li>
<mark>consumerId</mark>— مصرف‌کننده را شناسایی می‌کند
   </li>
<li>
<mark>pagination</mark>— صفحه نتایج برای بازگشت
   </li>
<li>
<mark>filter</mark>— معیارهای فیلتر، از جمله حداکثر سن سفارش‌ها برای بازگشت، یک وضعیت سفارش اختیاری، و کلمات کلیدی اختیاری که با نام رستوران و موارد منو مطابقت دارند
   </li>
</ul>
<p>
   این عملیات <mark>query</mark> یک شی <mark>OrderHistory</mark> را برمی‌گرداند که شامل خلاصه‌ای از سفارش‌های منطبق است که بر اساس افزایش سن مرتب شده‌اند. این توسط ماژولی فراخوانی می‌شود که نمای تاریخچه سفارش را پیاده‌سازی می‌کند. این نما خلاصه‌ای از هر سفارش را نمایش می‌دهد که شامل شماره سفارش، وضعیت سفارش، کل سفارش و زمان تحویل تخمینی است.
  </p>
<p>
   در ظاهر، این عملیات شبیه به عملیات <mark>query</mark> <mark>findOrder()</mark> است. تنها تفاوت این است که چندین سفارش را برمی‌گرداند، نه فقط یک سفارش. ممکن است به نظر برسد که <mark>API composer</mark> فقط باید همان <mark>query</mark> را در برابر هر <mark>Provider service</mark> اجرا کند و نتایج را ترکیب کند. متأسفانه، این به آن سادگی نیست.
  </p>
<p>
   این به این دلیل است که همه <mark>services</mark>، ویژگی‌هایی را که برای فیلتر کردن یا مرتب‌سازی استفاده می‌شوند، ذخیره نمی‌کنند. به عنوان مثال، یکی از معیارهای فیلتر عملیات <mark>findOrderHistory()</mark>، یک کلمه کلیدی است که با یک مورد منو مطابقت دارد. فقط دو <mark>services</mark>، <mark>Order Service</mark> و <mark>Kitchen Service</mark>، موارد منوی یک <mark>Order</mark> را ذخیره می‌کنند. نه <mark>Delivery Service</mark> و نه <mark>Accounting Service</mark> موارد منو را ذخیره نمی‌کنند، بنابراین نمی‌توانند داده‌های خود را با استفاده از این کلمه کلیدی فیلتر کنند. به طور مشابه، نه <mark>Kitchen Service</mark> و نه <mark>Delivery Service</mark> نمی‌توانند بر اساس ویژگی <mark>orderCreationDate</mark> مرتب‌سازی کنند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0259_original/original_page.png" alt="Original Page 259">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
   دو راه برای حل این مشکل توسط یک <mark>API composer</mark> وجود دارد. یک راه‌حل این است که <mark>API composer</mark> یک <mark>join</mark> درون حافظه‌ای انجام دهد، همانطور که در شکل 7.7 نشان داده شده است. این تمام سفارش‌ها را برای مصرف‌کننده از <mark>Delivery Service</mark> و <mark>Accounting Service</mark> بازیابی می‌کند و یک <mark>join</mark> را با سفارش‌های بازیابی شده از <mark>Order Service</mark> و <mark>Kitchen Service</mark> انجام می‌دهد.
  </p>
<p>
   ایراد این رویکرد این است که به‌طور بالقوه نیازمند آن است که <mark>API composer</mark> <mark>datasets</mark> بزرگ را بازیابی و <mark>join</mark> کند، که ناکارآمد است.
  </p>
<p>
   راه‌حل دیگر این است که <mark>API composer</mark> سفارش‌های منطبق را از <mark>Order Service</mark> و <mark>Kitchen Service</mark> بازیابی کند و سپس سفارش‌ها را از <mark>services</mark> دیگر بر اساس <mark>ID</mark> درخواست کند.
   <br/>
   اما این فقط در صورتی عملی است که آن <mark>services</mark> یک <mark>bulk fetch API</mark> داشته باشند. درخواست تک به تک سفارش‌ها احتمالاً به دلیل ترافیک بیش از حد شبکه ناکارآمد خواهد بود.
  </p>
<p>
<mark>Queries</mark> مانند <mark>findOrderHistory()</mark> نیازمند آن هستند که <mark>API composer</mark> عملکرد یک موتور اجرای <mark>query</mark> <mark>RDBMS</mark> را تکرار کند. از یک طرف، این به‌طور بالقوه کار را از <mark>database</mark>ای که مقیاس‌پذیری کمتری دارد به application که مقیاس‌پذیری بیشتری دارد، منتقل می‌کند. از طرف دیگر، این کارایی کمتری دارد. همچنین، توسعه‌دهندگان باید عملکرد تجاری را بنویسند، نه یک موتور اجرای <mark>query</mark> را.
  </p>
<p>
   در ادامه به شما نشان می‌دهم که چگونه الگوی <mark>CQRS</mark> را اعمال کنید و از یک <mark>datastore</mark> جداگانه استفاده کنید، که برای پیاده‌سازی کارآمد عملیات <mark>query</mark> <mark>findOrderHistory()</mark> طراحی شده است.
  </p>
<p>
   شکل 7.7
   <br/>
   ترکیب <mark>API</mark> نمی‌تواند به‌طور کارآمد سفارش‌های یک مصرف‌کننده را بازیابی کند، زیرا برخی از <mark>providers</mark>، مانند <mark>Delivery Service</mark>، ویژگی‌های مورد استفاده برای فیلتر کردن را ذخیره نمی‌کنند.
   <br/>
<mark>Find orders</mark>
<br/>
<mark>composer</mark>
</p>
<p>
<mark>Order Service</mark>
<br/>
   «<mark>aggregate</mark>»
   <br/>
<mark>Order</mark>
<br/>
<mark>GET/orders?</mark>
<br/>
<mark>consumerId=</mark>
<br/>
<mark>&amp;keyword=</mark>
</p>
<p>
<mark>GET/charges?</mark>
<br/>
<mark>consumerId=</mark>
</p>
<p>
<mark>GET/tickets?</mark>
<br/>
<mark>consumerId=</mark>
<br/>
<mark>&amp;keyword=</mark>
</p>
<p>
<mark>GET/deliveries?</mark>
<br/>
<mark>consumerId=</mark>
</p>
<p>
<mark>Kitchen Service</mark>
<br/>
   «<mark>aggregate</mark>»
   <br/>
<mark>RestaurantOrder</mark>
</p>
<p>
<mark>Delivery Service</mark>
<br/>
   «<mark>aggregate</mark>»
   <br/>
<mark>Delivery</mark>
</p>
<p>
<mark>Accounting Service</mark>
<br/>
   «<mark>aggregate</mark>»
   <br/>
<mark>Charge</mark>
</p>
<p>
<mark>GET/order?consumerId=&amp;keyword=</mark>
</p>
<p>
   این <mark>services</mark> داده‌های مورد نیاز برای یک جستجوی کلمه کلیدی را ذخیره نمی‌کنند، بنابراین تمام سفارش‌های یک مصرف‌کننده را برمی‌گردانند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0260_original/original_page.png" alt="Original Page 260">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Using the CQRS pattern</mark></h3>
<p>
   اما ابتدا، بیایید به مثالی از یک عملیات <mark>query</mark> نگاهی بیندازیم که پیاده‌سازی آن چالش‌برانگیز است، با وجود اینکه به یک <mark>service</mark> واحد محلی است.
  </p>
<h5><mark>A CHALLENGING SINGLE SERVICE QUERY: FINDAVAILABLERESTAURANTS()</mark></h5>
<p>
   همانطور که دیدید، پیاده‌سازی <mark>queries</mark> که داده‌ها را از چندین <mark>services</mark> بازیابی می‌کنند می‌تواند چالش‌برانگیز باشد. اما حتی <mark>queries</mark> که به یک <mark>service</mark> واحد محلی هستند نیز می‌توانند دشوار باشند. چند دلیل وجود دارد که چرا این ممکن است اتفاق بیفتد. یکی این است که، همانطور که به زودی مورد بحث قرار می‌گیرد، گاهی اوقات مناسب نیست که <mark>service</mark>ای که مالک داده است، <mark>query</mark> را پیاده‌سازی کند. دلیل دیگر این است که گاهی اوقات <mark>database</mark> (یا مدل داده) یک <mark>service</mark>، <mark>query</mark> را به طور کارآمد پشتیبانی نمی‌کند.
  </p>
<p>
   به عنوان مثال، عملیات <mark>query</mark> <mark>findAvailableRestaurants()</mark> را در نظر بگیرید. این <mark>query</mark> رستوران‌هایی را پیدا می‌کند که برای تحویل به یک آدرس معین در یک زمان معین در دسترس هستند. قلب این <mark>query</mark> یک جستجوی فضایی (مبتنی بر مکان) برای رستوران‌هایی است که در یک فاصله مشخص از آدرس تحویل قرار دارند. این بخش مهمی از فرآیند سفارش است و توسط ماژول <mark>UI</mark> که رستوران‌های موجود را نمایش می‌دهد، فراخوانی می‌شود.
  </p>
<p>
   چالش اصلی هنگام پیاده‌سازی این عملیات <mark>query</mark>، انجام یک <mark>query</mark> فضایی کارآمد است. نحوه پیاده‌سازی <mark>query</mark> <mark>findAvailableRestaurants()</mark> به قابلیت‌های <mark>database</mark>ای که رستوران‌ها را ذخیره می‌کند، بستگی دارد. به عنوان مثال، پیاده‌سازی <mark>query</mark> <mark>findAvailableRestaurants()</mark> با استفاده از <mark>MongoDB</mark> یا افزونه‌های فضایی <mark>Postgres</mark> و <mark>MySQL</mark> ساده است. این <mark>databases</mark> از انواع داده‌های فضایی، <mark>indexes</mark> و <mark>queries</mark> پشتیبانی می‌کنند. هنگام استفاده از یکی از این <mark>databases</mark>، <mark>Restaurant Service</mark> یک <mark>Restaurant</mark> را به عنوان یک رکورد <mark>database</mark> که دارای یک ویژگی موقعیت مکانی است، <mark>persist</mark> می‌کند. این رستوران‌های موجود را با استفاده از یک <mark>query</mark> فضایی که توسط یک <mark>geospatial index</mark> بر روی ویژگی موقعیت مکانی بهینه شده است، پیدا می‌کند.
  </p>
<p>
   اگر application <mark>FTGO</mark> رستوران‌ها را در نوع دیگری از <mark>database</mark> ذخیره کند، پیاده‌سازی <mark>query</mark> <mark>findAvailableRestaurant()</mark> چالش‌برانگیزتر است. این باید یک <mark>replica</mark> از داده‌های رستوران را در قالبی که برای پشتیبانی از <mark>query</mark> فضایی طراحی شده است، حفظ کند. به عنوان مثال، application می‌تواند از <mark>Geospatial Indexing Library</mark> برای <mark>DynamoDB</mark>
   (<mark>https://github.com/awslabs/dynamodb-geo</mark>) استفاده کند که از یک جدول به عنوان یک <mark>geospatial index</mark> استفاده می‌کند. از طرف دیگر، application می‌تواند یک <mark>replica</mark> از داده‌های رستوران را در یک نوع <mark>database</mark> کاملاً متفاوت ذخیره کند، موقعیتی بسیار شبیه به استفاده از یک <mark>text search database</mark> برای <mark>text queries</mark>.
  </p>
<p>
   چالش استفاده از <mark>replicas</mark> این است که آن‌ها را هر زمان که <mark>data</mark> اصلی تغییر می‌کند، به‌روز نگه دارید. همانطور که در زیر خواهید آموخت، <mark>CQRS</mark> مشکل همگام‌سازی <mark>replicas</mark> را حل می‌کند.
  </p>
<h5><mark>THE NEED TO SEPARATE CONCERNS</mark></h5>
<p>
   یکی دیگر از دلایلی که چرا <mark>single service queries</mark> چالش‌برانگیز هستند این است که گاهی اوقات <mark>service</mark>ای که مالک <mark>data</mark> است، نباید <mark>query</mark> را پیاده‌سازی کند.
   <br/>
   عملیات <mark>query</mark> <mark>findAvailableRestaurants()</mark> داده‌هایی را بازیابی می‌کند که متعلق به <mark>Restaurant Service</mark> است. این <mark>service</mark> به صاحبان رستوران این امکان را می‌دهد که مشخصات و موارد منوی رستوران خود را مدیریت کنند. این ویژگی‌های مختلف یک رستوران، از جمله نام، آدرس، غذاها، منو و ساعات کار آن را ذخیره می‌کند. با توجه به اینکه این <mark>service</mark> مالک
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0261_original/original_page.png" alt="Original Page 261">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
<mark>data</mark>، منطقی است، حداقل در ظاهر، که آن را برای پیاده‌سازی این عملیات <mark>query</mark> پیاده‌سازی کند.
   <br/>
   اما مالکیت <mark>data</mark> تنها عامل مورد توجه نیست.
  </p>
<p>
   شما همچنین باید نیاز به جداسازی نگرانی‌ها و اجتناب از اضافه بار <mark>services</mark> با مسئولیت‌های زیاد را در نظر بگیرید. به عنوان مثال، مسئولیت اصلی تیمی که <mark>Restaurant Service</mark> را توسعه می‌دهد، فعال کردن مدیران رستوران برای مدیریت پروفایل و موارد منوی رستوران‌هایشان است. این کاملاً با پیاده‌سازی یک <mark>query</mark> بحرانی با حجم بالا متفاوت است. علاوه بر این، اگر آن‌ها مسئول عملیات <mark>query</mark> <mark>findAvailableRestaurants()</mark> بودند، تیم دائماً از استقرار تغییری که از قرار دادن سفارش‌ها توسط مصرف‌کنندگان جلوگیری می‌کند، می‌ترسید.
  </p>
<p>
   منطقی است که <mark>Restaurant Service</mark> صرفاً داده‌های رستوران را به یک <mark>service</mark> دیگر ارائه دهد که عملیات <mark>query</mark> <mark>findAvailableRestaurants()</mark> را پیاده‌سازی می‌کند و به احتمال زیاد متعلق به تیم <mark>Order Service</mark> است. مانند عملیات <mark>query</mark> <mark>findOrderHistory()</mark>، و هنگامی که نیاز به حفظ <mark>geospatial index</mark> وجود دارد، یک نیاز برای حفظ یک <mark>replica</mark> سازگار نهایی از برخی <mark>data</mark> برای پیاده‌سازی یک <mark>query</mark> وجود دارد. بیایید ببینیم چگونه می‌توان این کار را با استفاده از <mark>CQRS</mark> انجام داد.
  </p>
<h4><mark>7.2.2 Overview of CQRS</mark></h4>
<p>
   مثال‌های شرح داده شده در بخش 7.2.1 سه مشکل را برجسته کردند که معمولاً هنگام پیاده‌سازی <mark>queries</mark> در یک معماری <mark>microservice</mark> با آن‌ها مواجه می‌شویم:
  </p>
<ul>
<li>
    استفاده از الگوی ترکیب <mark>API</mark> برای بازیابی <mark>data</mark> پراکنده در چندین <mark>services</mark> منجر به <mark>joins</mark> درون حافظه‌ای پرهزینه و ناکارآمد می‌شود.
   </li>
<li>
<mark>service</mark>ای که مالک <mark>data</mark> است، <mark>data</mark> را به شکلی یا در یک <mark>database</mark> ذخیره می‌کند که به طور کارآمد از <mark>query</mark> مورد نیاز پشتیبانی نمی‌کند.
   </li>
<li>
    نیاز به جداسازی نگرانی‌ها به این معنی است که <mark>service</mark>ای که مالک <mark>data</mark> است، <mark>service</mark>ای نیست که باید عملیات <mark>query</mark> را پیاده‌سازی کند.
   </li>
</ul>
<p>
   راه‌حل برای هر سه این مشکلات استفاده از الگوی <mark>CQRS</mark> است.
  </p>
<h5><mark>CQRS SEPARATES COMMANDS FROM QUERIES</mark></h5>
<p>
   همانطور که از نامش پیداست، جداسازی مسئولیت <mark>Command Query</mark>، همه چیز در مورد جداسازی یا جداسازی نگرانی‌ها است. همانطور که شکل 7.8 نشان می‌دهد، یک مدل <mark>data</mark>ی پایدار و ماژول‌هایی را که از آن استفاده می‌کنند به دو بخش تقسیم می‌کند: سمت دستور و سمت <mark>query</mark>. ماژول‌ها و مدل <mark>data</mark>ی سمت دستور، عملیات ایجاد، به‌روزرسانی و حذف را پیاده‌سازی می‌کنند (به اختصار <mark>CUD</mark>—به عنوان مثال، <mark>HTTP POSTs</mark>، <mark>PUTs</mark> و <mark>DELETEs</mark>). ماژول‌ها و مدل <mark>data</mark>ی سمت <mark>query</mark>، <mark>queries</mark> را پیاده‌سازی می‌کنند (مانند <mark>HTTP GETs</mark>). سمت <mark>query</mark> مدل <mark>data</mark> خود را با اشتراک در <mark>events</mark> منتشر شده توسط سمت دستور، با مدل <mark>data</mark> سمت دستور همگام نگه می‌دارد.
  </p>
<p>
   نسخه‌های غیر <mark>CQRS</mark> و <mark>CQRS</mark> <mark>service</mark>، هر دو دارای یک <mark>API</mark> هستند که شامل عملیات <mark>CRUD</mark> مختلف است. در یک <mark>service</mark> مبتنی بر غیر <mark>CQRS</mark>، آن عملیات معمولاً توسط یک مدل <mark>domain</mark> پیاده‌سازی می‌شوند که به یک <mark>database</mark> نگاشت شده است. برای عملکرد، ممکن است چند <mark>query</mark> از مدل <mark>domain</mark> عبور کرده و مستقیماً به <mark>database</mark> دسترسی داشته باشند. یک مدل <mark>data</mark>ی پایدار واحد هم از دستورات و هم از <mark>queries</mark> پشتیبانی می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0262_original/original_page.png" alt="Original Page 262">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Using the CQRS pattern</mark></h3>
<p>
   در یک <mark>service</mark> مبتنی بر <mark>CQRS</mark>، مدل <mark>domain</mark> سمت دستور عملیات <mark>CRUD</mark> را مدیریت می‌کند و به <mark>database</mark> خود نگاشت می‌شود. همچنین ممکن است <mark>queries</mark> ساده، مانند <mark>queries</mark> غیر <mark>join</mark>، مبتنی بر <mark>primary key</mark> را مدیریت کند. سمت دستور، هر زمان که داده‌هایش تغییر می‌کند، <mark>domain events</mark> را منتشر می‌کند. این <mark>events</mark> ممکن است با استفاده از یک فریم‌ورک مانند <mark>Eventuate Tram</mark> یا با استفاده از <mark>event sourcing</mark> منتشر شوند.
  </p>
<p>
   یک مدل <mark>query</mark> جداگانه، <mark>queries</mark> غیر بدیهی را مدیریت می‌کند. این مدل بسیار ساده‌تر از سمت دستور است زیرا مسئول پیاده‌سازی قوانین تجاری نیست. سمت <mark>query</mark> از هر نوع <mark>database</mark>ای که برای <mark>queries</mark>ی که باید پشتیبانی کند، منطقی باشد، استفاده می‌کند. سمت <mark>query</mark> دارای <mark>event handlers</mark> است که به <mark>domain events</mark> مشترک می‌شوند و <mark>database</mark> یا <mark>databases</mark> را به‌روزرسانی می‌کنند. حتی ممکن است چندین مدل <mark>query</mark> وجود داشته باشد، یکی برای هر نوع <mark>query</mark>.
  </p>
<h5><mark>CQRS AND QUERY-ONLY SERVICES</mark></h5>
<p>
   نه تنها می‌توان <mark>CQRS</mark> را در یک <mark>service</mark> اعمال کرد، بلکه می‌توانید از این الگو برای تعریف <mark>query services</mark> نیز استفاده کنید. یک <mark>query service</mark> دارای یک <mark>API</mark> است که فقط از عملیات <mark>query</mark> تشکیل شده است—هیچ عملیات دستوری وجود ندارد. این عملیات <mark>query</mark> را با <mark>querying</mark> یک <mark>database</mark> پیاده‌سازی می‌کند که با اشتراک در <mark>events</mark> منتشر شده توسط یک یا چند <mark>services</mark> دیگر، آن را به‌روز نگه می‌دارد. یک <mark>service</mark> سمت <mark>query</mark> یک راه خوب برای پیاده‌سازی یک <mark>view</mark> است که توسط
  </p>
<p>
<mark>Service</mark>
<br/>
<mark>CRUD</mark>
<br/>
   عملیات <mark>CRUD</mark>
<br/>
<mark>R</mark>
<br/>
   مدل <mark>Domain</mark>
<br/>
<mark>Aggregate</mark>
<br/>
<mark>Query</mark>
<br/>
<mark>bypass</mark>
<br/>
<mark>Aggregate</mark>
<br/>
<mark>Database</mark>
<br/>
   یک <mark>database</mark> برای ایجاد، به‌روزرسانی و حذف. یک
   <br/>
<mark>database</mark> جداگانه برای <mark>queries</mark>. این با استفاده از <mark>events</mark>ی که هر زمان
   <br/>
   که <mark>database</mark> سمت دستور تغییر می‌کند، منتشر می‌شوند، به‌روز نگه داشته می‌شود.
  </p>
<p>
<mark>Database</mark> واحد برای همه <mark>CRUD</mark>
</p>
<p>
<mark>Service</mark>
<br/>
<mark>CUD</mark>
<br/>
   عملیات <mark>CRUD</mark>
<br/>
<mark>R</mark>
<br/>
   مدل <mark>Command/domain</mark>
<br/>
<mark>Events</mark>
</p>
<p>
<mark>CQRS</mark>
</p>
<p>
   غیر <mark>CQRS</mark>
</p>
<p>
<mark>Aggregate</mark>
</p>
<p>
<mark>Event</mark>
<br/>
<mark>handler</mark>
<br/>
<mark>Aggregate</mark>
<br/>
<mark>Command-side</mark>
<br/>
<mark>database</mark>
<br/>
<mark>Query database</mark>
<br/>
   مدل <mark>Query</mark>
</p>
<p>
   شکل 7.8
   <br/>
   در سمت چپ نسخه غیر <mark>CQRS</mark>ی <mark>service</mark>، و در سمت راست نسخه <mark>CQRS</mark> قرار دارد.
   <br/>
<mark>CQRS</mark> یک <mark>service</mark> را به ماژول‌های سمت دستور و سمت <mark>query</mark> بازسازی می‌کند، که دارای <mark>databases</mark> جداگانه هستند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0263_original/original_page.png" alt="Original Page 263">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
   با اشتراک در <mark>events</mark> منتشر شده توسط چندین <mark>services</mark>. این نوع <mark>view</mark> به هیچ <mark>service</mark> خاصی تعلق ندارد، بنابراین منطقی است که آن را به عنوان یک <mark>service</mark> مستقل پیاده‌سازی کنید. یک مثال خوب از این <mark>service</mark>، <mark>Order History Service</mark> است، که یک <mark>query service</mark> است که عملیات <mark>query</mark> <mark>findOrderHistory()</mark> را پیاده‌سازی می‌کند. همانطور که شکل 7.9 نشان می‌دهد، این <mark>service</mark> به <mark>events</mark> منتشر شده توسط چندین <mark>services</mark>، از جمله <mark>Order Service</mark>، <mark>Delivery Service</mark> و غیره، مشترک می‌شود.
  </p>
<p>
<mark>Order History Service</mark> دارای <mark>event handlers</mark> است که به <mark>events</mark> منتشر شده توسط چندین <mark>services</mark> مشترک می‌شوند و <mark>Order History View Database</mark> را به‌روزرسانی می‌کنند. من پیاده‌سازی این <mark>service</mark> را با جزئیات بیشتر در بخش 7.4 توضیح می‌دهم.
  </p>
<p>
   یک <mark>query service</mark> همچنین یک راه خوب برای پیاده‌سازی یک <mark>view</mark> است که داده‌های متعلق به یک <mark>service</mark> واحد را تکرار می‌کند، اما به دلیل نیاز به جداسازی نگرانی‌ها، بخشی از آن <mark>service</mark> نیست.
   <br/>
   به عنوان مثال، توسعه‌دهندگان <mark>FTGO</mark> می‌توانند یک <mark>Available Restaurants Service</mark> را تعریف کنند، که عملیات <mark>query</mark> <mark>findAvailableRestaurants()</mark> را که قبلاً توضیح داده شد، پیاده‌سازی می‌کند. این سرویس به <mark>events</mark> منتشر شده توسط <mark>Restaurant Service</mark> مشترک می‌شود و یک <mark>database</mark> را که برای <mark>queries</mark> فضایی کارآمد طراحی شده است، به‌روزرسانی می‌کند.
  </p>
<p>
   از بسیاری جهات، <mark>CQRS</mark> یک تعمیم مبتنی بر <mark>event</mark> از رویکرد محبوب استفاده از <mark>RDBMS</mark> به عنوان سیستم سوابق و یک موتور جستجوی متنی، مانند <mark>Elasticsearch</mark>، برای رسیدگی به <mark>text queries</mark> است. آنچه متفاوت است این است که <mark>CQRS</mark> از طیف وسیع‌تری از <mark>database</mark>
</p>
<p>
<mark>Order Service</mark>
</p>
<p>
<mark>Kitchen Service</mark>
</p>
<p>
<mark>Order History</mark>
<br/>
<mark>Service</mark>
<br/>
<mark>ﬁndOrderHistory()</mark>
<br/>
<mark>ﬁndOrder()</mark>
</p>
<p>
<mark>Delivery Service</mark>
</p>
<p>
<mark>Accounting Service</mark>
</p>
<p>
<mark>Order history</mark>
<br/>
<mark>view database</mark>
</p>
<p>
<mark>Event</mark>
<br/>
<mark>handlers</mark>
</p>
<p>
<mark>Order</mark>
<br/>
<mark>events</mark>
</p>
<p>
<mark>Ticket</mark>
<br/>
<mark>events</mark>
</p>
<p>
<mark>Delivery</mark>
<br/>
<mark>events</mark>
</p>
<p>
<mark>Accounting</mark>
<br/>
<mark>events</mark>
</p>
<p>
   شکل 7.9
   <br/>
   طراحی <mark>Order History Service</mark>، که یک <mark>service</mark> سمت <mark>query</mark> است. این عملیات <mark>query</mark> <mark>findOrderHistory()</mark> را با <mark>querying</mark> یک <mark>database</mark>، که با اشتراک در <mark>events</mark> منتشر شده توسط چندین <mark>services</mark> دیگر، آن را حفظ می‌کند، پیاده‌سازی می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0264_original/original_page.png" alt="Original Page 264">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Using the CQRS pattern</mark></h3>
<p>
<mark>types</mark>—نه فقط یک موتور جستجوی متنی. همچنین، <mark>CQRS query-side views</mark> در زمان نزدیک با اشتراک در <mark>events</mark> به‌روزرسانی می‌شوند.
  </p>
<p>
   بیایید اکنون به مزایا و معایب <mark>CQRS</mark> نگاهی بیندازیم.
  </p>
<h4><mark>7.2.3 The benefits of CQRS</mark></h4>
<p>
<mark>CQRS</mark> هم مزایا و هم معایبی دارد. مزایا به شرح زیر است:
  </p>
<ul>
<li>
    امکان پیاده‌سازی کارآمد <mark>queries</mark> در یک معماری <mark>microservice</mark>
</li>
<li>
    امکان پیاده‌سازی کارآمد <mark>queries</mark> متنوع
   </li>
<li>
    امکان <mark>querying</mark> را در یک application مبتنی بر <mark>event sourcing</mark> فراهم می‌کند
   </li>
<li>
    جداسازی نگرانی‌ها را بهبود می‌بخشد
   </li>
</ul>
<h5><mark>ENABLES THE EFFICIENT IMPLEMENTATION OF QUERIES IN A MICROSERVICE ARCHITECTURE</mark></h5>
<p>
   یکی از مزایای الگوی <mark>CQRS</mark> این است که <mark>queries</mark>ی را که داده‌ها را از چندین <mark>services</mark> بازیابی می‌کنند، به طور کارآمد پیاده‌سازی می‌کند. همانطور که قبلاً توضیح داده شد، استفاده از الگوی ترکیب <mark>API</mark> برای پیاده‌سازی <mark>queries</mark> گاهی اوقات منجر به <mark>joins</mark> درون حافظه‌ای پرهزینه و ناکارآمد از <mark>datasets</mark> بزرگ می‌شود. برای آن <mark>queries</mark>، استفاده از یک <mark>CQRS view</mark> که به راحتی <mark>query</mark> می‌شود و داده‌ها را از دو یا چند <mark>services</mark> از قبل <mark>join</mark> می‌کند، کارآمدتر است.
  </p>
<h5><mark>ENABLES THE EFFICIENT IMPLEMENTATION OF DIVERSE QUERIES</mark></h5>
<p>
   یکی دیگر از مزایای <mark>CQRS</mark> این است که یک application یا <mark>service</mark> را قادر می‌سازد تا مجموعه متنوعی از <mark>queries</mark> را به طور کارآمد پیاده‌سازی کند. تلاش برای پشتیبانی از همه <mark>queries</mark> با استفاده از یک مدل <mark>data</mark>ی پایدار واحد اغلب چالش‌برانگیز و در برخی موارد غیرممکن است. برخی از <mark>databases</mark> <mark>NoSQL</mark> قابلیت‌های <mark>querying</mark> بسیار محدودی دارند. حتی زمانی که یک <mark>database</mark> دارای افزونه‌هایی برای پشتیبانی از یک نوع خاص از <mark>query</mark> است، استفاده از یک <mark>database</mark> تخصصی اغلب کارآمدتر است. الگوی <mark>CQRS</mark> با تعریف یک یا چند <mark>views</mark>، که هر کدام به طور کارآمد <mark>queries</mark> خاصی را پیاده‌سازی می‌کنند، از محدودیت‌های یک <mark>datastore</mark> واحد جلوگیری می‌کند.
  </p>
<h5><mark>ENABLES QUERYING IN AN EVENT SOURCING-BASED APPLICATION</mark></h5>
<p>
<mark>CQRS</mark> همچنین بر یک محدودیت اصلی <mark>event sourcing</mark> غلبه می‌کند. یک <mark>event store</mark> فقط از <mark>queries</mark> مبتنی بر <mark>primary key</mark> پشتیبانی می‌کند. الگوی <mark>CQRS</mark> با تعریف یک یا چند <mark>views</mark> از <mark>aggregates</mark>، که با اشتراک در جریان <mark>events</mark>ی که توسط <mark>aggregates</mark> مبتنی بر <mark>event sourcing</mark> منتشر می‌شوند، به‌روز نگه داشته می‌شوند، به این محدودیت رسیدگی می‌کند. در نتیجه، یک application مبتنی بر <mark>event sourcing</mark> به‌طور قطع از <mark>CQRS</mark> استفاده می‌کند.
  </p>
<h5><mark>IMPROVES SEPARATION OF CONCERNS</mark></h5>
<p>
   یکی دیگر از مزایای <mark>CQRS</mark> این است که نگرانی‌ها را جدا می‌کند. یک مدل <mark>domain</mark> و مدل <mark>data</mark>ی پایدار مربوطه آن، هم دستورات و هم <mark>queries</mark> را مدیریت نمی‌کنند. الگوی <mark>CQRS</mark> ماژول‌های کد و <mark>schemas</mark> <mark>database</mark> جداگانه‌ای را برای سمت دستور و سمت <mark>query</mark> یک <mark>service</mark> تعریف می‌کند. با جداسازی نگرانی‌ها، سمت دستور و سمت <mark>query</mark> به احتمال زیاد ساده‌تر و نگهداری آن‌ها آسان‌تر است.
  </p>
<p>
   علاوه بر این، <mark>CQRS</mark> <mark>service</mark> را قادر می‌سازد که یک <mark>query</mark> را پیاده‌سازی کند و با <mark>service</mark>ی که مالک <mark>data</mark> است، متفاوت باشد. به عنوان مثال، قبلاً توضیح دادم که چگونه، اگرچه <mark>Restaurant Service</mark> مالک <mark>data</mark> است که توسط عملیات <mark>query</mark> <mark>findAvailableRestaurants</mark> <mark>query</mark> می‌شود، منطقی است که یک <mark>service</mark> دیگر چنین
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0265_original/original_page.png" alt="Original Page 265">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
<mark>data</mark>، منطقی است، زیرا <mark>CQRS</mark> یک <mark>query service</mark>، یک <mark>view</mark> را با اشتراک در <mark>events</mark> منتشر شده توسط <mark>service</mark> یا <mark>services</mark>ی که مالک <mark>data</mark> هستند، حفظ می‌کند.
  </p>
<h4><mark>7.2.4 The drawbacks of CQRS</mark></h4>
<p>
   حتی اگر <mark>CQRS</mark> چندین مزیت دارد، معایب قابل توجهی نیز دارد:
  </p>
<ul>
<li>
    معماری پیچیده‌تر
   </li>
<li>
    رسیدگی به <mark>replication lag</mark>
</li>
</ul>
<p>
   بیایید به این معایب، با شروع از پیچیدگی افزوده شده، نگاهی بیندازیم.
  </p>
<h5><mark>MORE COMPLEX ARCHITECTURE</mark></h5>
<p>
   یکی از معایب <mark>CQRS</mark> این است که پیچیدگی را افزایش می‌دهد. توسعه‌دهندگان باید <mark>services</mark> سمت <mark>query</mark> را بنویسند که <mark>views</mark> را به‌روزرسانی و <mark>query</mark> می‌کنند. همچنین پیچیدگی عملیاتی اضافی مدیریت و راه‌اندازی <mark>datastores</mark> اضافی وجود دارد. علاوه بر این، یک application ممکن است از انواع مختلف <mark>databases</mark> استفاده کند، که پیچیدگی بیشتری را برای توسعه‌دهندگان و عملیات اضافه می‌کند.
  </p>
<h5><mark>DEALING WITH THE REPLICATION LAG</mark></h5>
<p>
   یکی دیگر از معایب <mark>CQRS</mark>، رسیدگی به "تاخیر" بین <mark>views</mark> سمت دستور و سمت <mark>query</mark> است. همانطور که انتظار دارید، تاخیری بین زمانی که سمت دستور یک <mark>event</mark> را منتشر می‌کند و زمانی که آن <mark>event</mark> توسط سمت <mark>query</mark> پردازش می‌شود و <mark>view</mark> به‌روزرسانی می‌شود، وجود دارد. یک application <mark>client</mark> که یک <mark>aggregate</mark> را به‌روزرسانی می‌کند و سپس فوراً یک <mark>view</mark> را <mark>query</mark> می‌کند، ممکن است نسخه قبلی <mark>aggregate</mark> را ببیند. اغلب باید به گونه‌ای نوشته شود که از قرار گرفتن این ناسازگاری‌های احتمالی در معرض کاربر جلوگیری شود.
  </p>
<p>
   یک راه‌حل این است که <mark>APIs</mark> سمت دستور و سمت <mark>query</mark>، <mark>client</mark> را با اطلاعات نسخه تأمین کنند که به آن امکان می‌دهد تشخیص دهد که سمت <mark>query</mark> منسوخ شده است. یک <mark>client</mark> می‌تواند <mark>view</mark> سمت <mark>query</mark> را نظرسنجی کند تا زمانی که به‌روز باشد. به زودی در مورد چگونگی امکان‌پذیر کردن این کار برای <mark>client</mark> توسط <mark>APIs</mark> <mark>service</mark> بحث خواهم کرد.
  </p>
<p>
   یک application <mark>UI</mark> مانند یک application <mark>JavaScript</mark> بومی موبایل یا تک صفحه‌ای می‌تواند با به‌روزرسانی مدل محلی خود پس از موفقیت‌آمیز بودن دستور، بدون صدور یک <mark>query</mark>، <mark>replication lag</mark> را مدیریت کند. به عنوان مثال، می‌تواند مدل خود را با استفاده از داده‌های بازگشتی توسط دستور به‌روزرسانی کند. امیدوارم، وقتی یک عمل کاربر یک <mark>query</mark> را فعال می‌کند، <mark>view</mark> به‌روز خواهد بود. یکی از معایب این رویکرد این است که کد <mark>UI</mark> ممکن است برای به‌روزرسانی مدل خود نیاز به تکرار کد سمت سرور داشته باشد.
  </p>
<p>
   همانطور که می‌بینید، <mark>CQRS</mark> هم مزایا و هم معایبی دارد. همانطور که قبلاً ذکر شد، باید در صورت امکان از ترکیب <mark>API</mark> استفاده کنید و فقط در صورت لزوم از <mark>CQRS</mark> استفاده کنید. اکنون که مزایا و معایب <mark>CQRS</mark> را دیده‌اید، بیایید به نحوه طراحی <mark>CQRS views</mark> نگاهی بیندازیم.
  </p>
<h4><mark>7.3 Designing CQRS views</mark></h4>
<p>
   یک ماژول <mark>view</mark> <mark>CQRS</mark> دارای یک <mark>API</mark> است که از یک یا چند عملیات <mark>query</mark> تشکیل شده است. این عملیات <mark>query</mark> را با <mark>querying</mark> یک <mark>database</mark> پیاده‌سازی می‌کند که با اشتراک در <mark>events</mark> منتشر شده توسط یک یا چند <mark>services</mark>، آن را حفظ می‌کند. همانطور که شکل 7.10 نشان می‌دهد، یک ماژول <mark>view</mark> از یک <mark>view database</mark> و سه زیر ماژول تشکیل شده است.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0266_original/original_page.png" alt="Original Page 266">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Designing CQRS views</mark></h3>
<p>
   ماژول <mark>view</mark> <mark>CQRS</mark> دارای یک <mark>API</mark> است که از یک یا چند عملیات <mark>query</mark> تشکیل شده است. این عملیات <mark>query</mark> را با <mark>querying</mark> یک <mark>database</mark> پیاده‌سازی می‌کند که با اشتراک در <mark>events</mark> منتشر شده توسط یک یا چند <mark>services</mark>، آن را حفظ می‌کند. همانطور که شکل 7.10 نشان می‌دهد، یک ماژول <mark>view</mark> از یک <mark>view database</mark> و سه زیر ماژول تشکیل شده است.
  </p>
<p>
   ماژول دسترسی به <mark>data</mark>، منطق دسترسی به <mark>database</mark> را پیاده‌سازی می‌کند. ماژول‌های <mark>event handlers</mark> و <mark>query API</mark> از ماژول دسترسی به <mark>data</mark> برای به‌روزرسانی و <mark>query</mark> کردن <mark>database</mark> استفاده می‌کنند. ماژول‌های <mark>event handlers</mark> به <mark>events</mark> مشترک می‌شوند و <mark>database</mark> را به‌روزرسانی می‌کنند. ماژول <mark>query API</mark>، <mark>query API</mark> را پیاده‌سازی می‌کند.
  </p>
<p>
   شما باید هنگام توسعه یک ماژول <mark>view</mark> چند تصمیم طراحی مهم بگیرید:
  </p>
<ul>
<li>
    شما باید یک <mark>database</mark> را انتخاب و <mark>schema</mark> را طراحی کنید.
   </li>
<li>
    هنگام طراحی ماژول دسترسی به <mark>data</mark>، شما باید به مسائل مختلفی از جمله اطمینان از <mark>idempotent</mark> بودن به‌روزرسانی‌ها و رسیدگی به به‌روزرسانی‌های همزمان بپردازید.
   </li>
<li>
    هنگام پیاده‌سازی یک <mark>view</mark> جدید در یک application موجود یا تغییر <mark>schema</mark> یک application موجود، شما باید یک مکانیسم برای ساخت یا بازسازی کارآمد <mark>view</mark> پیاده‌سازی کنید.
   </li>
<li>
    شما باید تصمیم بگیرید که چگونه یک <mark>client</mark> از <mark>view</mark> را قادر سازید تا با <mark>replication lag</mark>، که قبلاً توضیح داده شد، مقابله کند.
   </li>
</ul>
<p>
   بیایید به هر یک از این مسائل نگاهی بیندازیم.
  </p>
<h4><mark>7.3.1 Choosing a view datastore</mark></h4>
<p>
   یک تصمیم طراحی کلیدی، انتخاب <mark>database</mark> و طراحی <mark>schema</mark> است. هدف اصلی <mark>database</mark> و مدل <mark>data</mark>، پیاده‌سازی کارآمد عملیات <mark>query</mark> ماژول <mark>view</mark> است. این ویژگی‌های آن <mark>queries</mark> هستند که هنگام انتخاب یک <mark>database</mark>، ملاحظات اصلی هستند. اما <mark>database</mark> نیز باید عملیات به‌روزرسانی انجام شده توسط <mark>event handlers</mark> را به طور کارآمد پیاده‌سازی کند.
  </p>
<h5><mark>SQL VS. NOSQL DATABASES</mark></h5>
<p>
   نه چندان دور، یک نوع <mark>database</mark> وجود داشت که بر همه آن‌ها حاکم بود: <mark>RDBMS</mark> مبتنی بر <mark>SQL</mark>. با این حال، با افزایش محبوبیت وب، شرکت‌های مختلفی متوجه شدند که یک <mark>RDBMS</mark> نمی‌تواند الزامات مقیاس وب آن‌ها را برآورده کند. این منجر به ایجاد
  </p>
<p>
   ماژول <mark>view CQRS</mark>
<br/>
<mark>Event</mark>
<br/>
<mark>handlers</mark>
<br/>
<mark>query()</mark>
<br/>
<mark>update()</mark>
<br/>
<mark>Query API</mark>
<br/>
   دسترسی به <mark>Data</mark>
<br/>
<mark>View database</mark>
<br/>
<mark>Events</mark>
<br/>
<mark>ﬁnd...()</mark>
<br/>
   ...
   <br/>
   منطق دسترسی به <mark>data</mark> را پیاده‌سازی می‌کند
  </p>
<p>
   شکل 7.10
   <br/>
   طراحی یک ماژول <mark>view CQRS</mark>. <mark>Event handlers</mark>، <mark>database</mark> <mark>view</mark> را به‌روزرسانی می‌کنند، که توسط ماژول <mark>Query API</mark> <mark>query</mark> می‌شود.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0267_original/original_page.png" alt="Original Page 267">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
<mark>NoSQL databases</mark>. یک <mark>database NoSQL</mark> معمولاً دارای یک فرم محدود از <mark>transactions</mark> و قابلیت‌های <mark>querying</mark> کمتر عمومی است. با این حال، برای موارد استفاده خاص، این <mark>databases</mark> دارای مزایای خاصی نسبت به <mark>SQL databases</mark> هستند، از جمله یک مدل <mark>data</mark> انعطاف‌پذیرتر و عملکرد و مقیاس‌پذیری بهتر.
  </p>
<p>
   یک <mark>database NoSQL</mark> اغلب یک انتخاب خوب برای یک <mark>CQRS view</mark> است، که می‌تواند از نقاط قوت آن استفاده کند و نقاط ضعف آن را نادیده بگیرد. یک <mark>CQRS view</mark> از مدل <mark>data</mark> غنی‌تر و عملکرد یک <mark>database NoSQL</mark> بهره می‌برد. این تحت تأثیر محدودیت‌های یک <mark>database NoSQL</mark> قرار نمی‌گیرد، زیرا فقط از <mark>transactions</mark> ساده استفاده می‌کند و یک مجموعه ثابت از <mark>queries</mark> را اجرا می‌کند.
  </p>
<p>
   با این حال، گاهی اوقات منطقی است که یک <mark>CQRS view</mark> را با استفاده از یک <mark>SQL database</mark> پیاده‌سازی کنید. یک <mark>RDBMS</mark> مدرن که روی سخت‌افزار مدرن اجرا می‌شود، عملکرد بسیار خوبی دارد. توسعه‌دهندگان، مدیران <mark>database</mark> و عملیات <mark>IT</mark>، به‌طور کلی، با <mark>SQL databases</mark> بسیار بیشتر از <mark>databases NoSQL</mark> آشنا هستند. همانطور که قبلاً ذکر شد، <mark>SQL databases</mark> اغلب دارای افزونه‌هایی برای ویژگی‌های غیر رابطه‌ای، مانند انواع داده‌های فضایی و <mark>queries</mark> هستند. همچنین، یک <mark>CQRS view</mark> ممکن است برای پشتیبانی از یک موتور گزارش‌گیری، نیاز به استفاده از یک <mark>SQL database</mark> داشته باشد.
  </p>
<p>
   همانطور که در جدول 7.1 مشاهده می‌کنید، گزینه‌های زیادی برای انتخاب وجود دارد. و برای پیچیده‌تر کردن انتخاب، تفاوت بین انواع مختلف <mark>database</mark> شروع به محو شدن می‌کند. به عنوان مثال، <mark>MySQL</mark>، که یک <mark>RDBMS</mark> است، از <mark>JSON</mark> پشتیبانی عالی دارد، که یکی از نقاط قوت <mark>MongoDB</mark> است، یک <mark>database</mark> با قالب سند <mark>JSON</mark>.
  </p>
<p>
   اکنون که در مورد انواع مختلف <mark>databases</mark> که می‌توانید برای پیاده‌سازی یک <mark>CQRS view</mark> استفاده کنید، بحث کردم، بیایید به مشکل نحوه به‌روزرسانی کارآمد یک <mark>view</mark> نگاهی بیندازیم.
  </p>
<h5><mark>SUPPORTING UPDATE OPERATIONS</mark></h5>
<p>
   علاوه بر پیاده‌سازی کارآمد <mark>queries</mark>، مدل <mark>data</mark> <mark>view</mark> نیز باید عملیات به‌روزرسانی اجرا شده توسط <mark>event handlers</mark> را به طور کارآمد پیاده‌سازی کند. معمولاً، یک <mark>event</mark>
</p>
<p>
   جدول 7.1
   <br/>
<mark>Query-side view stores</mark>
</p>
<p>
   اگر شما نیاز دارید
   <br/>
   استفاده کنید
   <br/>
   مثال
  </p>
<p>
<mark>PK-based lookup</mark> of <mark>JSON</mark>
<br/>
<mark>objects</mark>
</p>
<p>
   یک فروشگاه سند مانند <mark>MongoDB</mark>
<br/>
   یا <mark>DynamoDB</mark>، یا یک فروشگاه <mark>key value</mark>
<br/>
   مانند <mark>Redis</mark>
</p>
<p>
   تاریخچه سفارش را با حفظ یک سند <mark>MongoDB</mark>
<br/>
   که شامل <mark>per-customer</mark> است، پیاده‌سازی کنید.
  </p>
<p>
<mark>Query-based lookup</mark> of <mark>JSON</mark>
<br/>
<mark>objects</mark>
</p>
<p>
   یک فروشگاه سند مانند <mark>MongoDB</mark>
<br/>
   یا <mark>DynamoDB</mark>
</p>
<p>
   نمای مشتری را با استفاده از <mark>MongoDB</mark> یا <mark>DynamoDB</mark> پیاده‌سازی کنید.
  </p>
<p>
<mark>Text queries</mark>
</p>
<p>
   یک موتور جستجوی متنی مانند <mark>Elasticsearch</mark>
</p>
<p>
   جستجوی متن برای سفارش‌ها را با حفظ یک سند <mark>Elasticsearch</mark> در هر سفارش پیاده‌سازی کنید.
  </p>
<p>
<mark>Graph queries</mark>
</p>
<p>
   یک <mark>graph database</mark> مانند <mark>Neo4j</mark>
</p>
<p>
   تشخیص تقلب را با حفظ یک نمودار از مشتریان، سفارش‌ها و سایر داده‌ها پیاده‌سازی کنید.
  </p>
<p>
<mark>Traditional SQL reporting/BI</mark>
</p>
<p>
   یک <mark>RDBMS</mark>
</p>
<p>
   گزارش‌ها و تجزیه و تحلیل‌های کسب و کار استاندارد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0268_original/original_page.png" alt="Original Page 268">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Designing CQRS views</mark></h3>
<p>
<mark>handler</mark> یک رکورد را در <mark>database view</mark> با استفاده از <mark>primary key</mark> آن به‌روزرسانی یا حذف می‌کند. به عنوان مثال، به زودی طراحی یک <mark>CQRS view</mark> را برای <mark>query</mark> <mark>findOrderHistory()</mark> شرح خواهم داد. این، هر <mark>Order</mark> را با استفاده از <mark>orderId</mark> به عنوان <mark>primary key</mark>، به عنوان یک رکورد <mark>database</mark> ذخیره می‌کند. هنگامی که این <mark>view</mark> یک <mark>event</mark> را از <mark>Order Service</mark> دریافت می‌کند، می‌تواند به‌طور مستقیم رکورد مربوطه را به‌روزرسانی کند.
  </p>
<p>
   اما، گاهی اوقات، لازم است که یک رکورد را با استفاده از معادل یک <mark>foreign key</mark> به‌روزرسانی یا حذف کنید. به عنوان مثال، <mark>event handlers</mark> برای <mark>Delivery* events</mark> را در نظر بگیرید. اگر بین یک <mark>Delivery</mark> و یک <mark>Order</mark>، یک رابطه یک به یک وجود داشته باشد، در این صورت <mark>Delivery.id</mark> ممکن است همان <mark>Order.id</mark> باشد. اگر اینطور باشد، در این صورت <mark>Delivery* event handlers</mark> می‌تواند به راحتی رکورد <mark>database</mark> سفارش را به‌روزرسانی کند.
  </p>
<p>
   اما فرض کنید یک <mark>Delivery</mark>، <mark>primary key</mark> خود را دارد یا یک رابطه یک به چند بین یک <mark>Order</mark> و یک <mark>Delivery</mark> وجود دارد. برخی از <mark>Delivery* events</mark>، مانند <mark>Delivery-Created event</mark>، شامل <mark>orderId</mark> خواهند بود. اما <mark>events</mark> دیگر، مانند یک <mark>DeliveryPickedUp event</mark>، ممکن است شامل این مقدار نباشند. در این سناریو، یک <mark>event handler</mark> برای <mark>DeliveryPickedUp</mark> باید رکورد سفارش را با استفاده از <mark>deliveryId</mark> به عنوان معادل یک <mark>foreign key</mark> به‌روزرسانی کند.
  </p>
<p>
   برخی از انواع <mark>database</mark> عملیات به‌روزرسانی مبتنی بر <mark>foreign-key</mark> را به طور کارآمد پشتیبانی می‌کنند. به عنوان مثال، اگر از یک <mark>RDBMS</mark> یا <mark>MongoDB</mark> استفاده می‌کنید، یک <mark>index</mark> بر روی ستون‌های لازم ایجاد می‌کنید. با این حال، به‌روزرسانی‌های مبتنی بر غیر <mark>primary key</mark> هنگام استفاده از سایر <mark>NOSQL databases</mark> ساده نیستند. application باید نوعی نگاشت خاص <mark>database</mark> از یک <mark>foreign key</mark> به یک <mark>primary key</mark> را حفظ کند تا مشخص کند کدام رکورد را باید به‌روزرسانی کرد. به عنوان مثال، یک application که از <mark>DynamoDB</mark> استفاده می‌کند، که فقط از به‌روزرسانی‌ها و حذف‌های مبتنی بر <mark>primary key</mark> پشتیبانی می‌کند، ابتدا باید یک <mark>DynamoDB secondary index</mark> (که به زودی مورد بحث قرار می‌گیرد) را <mark>query</mark> کند تا کلیدهای <mark>primary</mark> موارد را برای به‌روزرسانی یا حذف مشخص کند.
  </p>
<h4><mark>7.3.2 Data access module design</mark></h4>
<p>
   ماژول‌های <mark>event handlers</mark> و <mark>query API</mark> مستقیماً به <mark>datastore</mark> دسترسی ندارند.
   <br/>
   در عوض آن‌ها از ماژول دسترسی به <mark>data</mark> استفاده می‌کنند، که از یک <mark>data access object</mark> (<mark>DAO</mark>) و کلاس‌های کمکی آن تشکیل شده است. <mark>DAO</mark> مسئولیت‌های متعددی دارد. این عملیات به‌روزرسانی فراخوانی شده توسط <mark>event handlers</mark> و عملیات <mark>query</mark> فراخوانی شده توسط ماژول <mark>query</mark> را پیاده‌سازی می‌کند. <mark>DAO</mark> بین انواع <mark>data</mark> مورد استفاده توسط کد سطح بالاتر و <mark>database API</mark> نگاشت می‌کند. همچنین باید به‌روزرسانی‌های همزمان را مدیریت کند و اطمینان حاصل کند که به‌روزرسانی‌ها <mark>idempotent</mark> هستند.
  </p>
<p>
   بیایید به این مسائل نگاهی بیندازیم، با نحوه رسیدگی به به‌روزرسانی‌های همزمان شروع می‌کنیم.
  </p>
<h5><mark>HANDLING CONCURRENCY</mark></h5>
<p>
   گاهی اوقات یک <mark>DAO</mark> باید احتمال به‌روزرسانی‌های همزمان متعدد را برای یک رکورد <mark>database</mark> یکسان مدیریت کند. اگر یک <mark>view</mark> به <mark>events</mark> منتشر شده توسط یک نوع <mark>aggregate</mark> واحد مشترک شود، هیچ مسئله همزمانی وجود نخواهد داشت. این به این دلیل است که <mark>events</mark> منتشر شده توسط یک نمونه <mark>aggregate</mark> خاص به صورت متوالی پردازش می‌شوند. در نتیجه، یک رکورد مربوط به یک نمونه <mark>aggregate</mark> به‌طور همزمان به‌روزرسانی نمی‌شود. اما اگر یک <mark>view</mark> به <mark>events</mark> منتشر شده توسط انواع <mark>aggregate</mark> متعدد مشترک شود، در این صورت ممکن است چندین <mark>event handlers</mark> رکورد یکسان را به‌طور همزمان به‌روزرسانی کنند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0269_original/original_page.png" alt="Original Page 269">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
   به عنوان مثال، یک <mark>event handler</mark> برای یک <mark>Order* event</mark> ممکن است همزمان با یک <mark>event handler</mark> برای یک <mark>Delivery* event</mark> برای همان سفارش فراخوانی شود. هر دو <mark>event handlers</mark> سپس به‌طور همزمان <mark>DAO</mark> را برای به‌روزرسانی رکورد <mark>database</mark> برای آن <mark>Order</mark> فراخوانی می‌کنند. یک <mark>DAO</mark> باید به گونه‌ای نوشته شود که اطمینان حاصل شود که این وضعیت به درستی مدیریت می‌شود. نباید اجازه دهد که یک به‌روزرسانی، به‌روزرسانی دیگری را بازنویسی کند. اگر یک <mark>DAO</mark> به‌روزرسانی‌ها را با خواندن یک رکورد و سپس نوشتن رکورد به‌روزرسانی شده پیاده‌سازی کند، باید از قفل خوش‌بینانه یا بدبینانه استفاده کند. در بخش بعدی، نمونه‌ای از یک <mark>DAO</mark> را مشاهده خواهید کرد که به‌روزرسانی‌های همزمان را با به‌روزرسانی رکوردهای <mark>database</mark> بدون خواندن آن‌ها در ابتدا، مدیریت می‌کند.
  </p>
<h5><mark>IDEMPOTENT EVENT HANDLERS</mark></h5>
<p>
   همانطور که در فصل 3 ذکر شد، یک <mark>event handler</mark> ممکن است با یک <mark>event</mark> یکسان بیش از یک بار فراخوانی شود. این به طور کلی مشکل‌ساز نیست اگر یک <mark>event handler</mark> سمت <mark>query</mark>، <mark>idempotent</mark> باشد. یک <mark>event handler</mark> در صورتی <mark>idempotent</mark> است که رسیدگی به <mark>events</mark> تکراری منجر به نتیجه صحیح شود. در بدترین حالت، <mark>datastore view</mark> موقتاً منسوخ می‌شود. به عنوان مثال، یک <mark>event handler</mark> که نمای تاریخچه سفارش را حفظ می‌کند، ممکن است با توالی <mark>events</mark> (مسلماً بعید) نشان داده شده در شکل 7.11 فراخوانی شود: <mark>Delivery-PickedUp</mark>، <mark>DeliveryDelivered</mark>، <mark>DeliveryPickedUp</mark> و <mark>DeliveryDelivered</mark>. پس از تحویل <mark>events</mark> <mark>DeliveryPickedUp</mark> و <mark>DeliveryDelivered</mark> برای اولین بار، <mark>message broker</mark>، شاید به دلیل یک خطای شبکه، <mark>events</mark> را از یک نقطه زمانی قبلی تحویل می‌دهد و بنابراین <mark>DeliveryPickedUp</mark> و <mark>DeliveryDelivered</mark> را دوباره تحویل می‌دهد.
  </p>
<p>
   پس از اینکه <mark>event handler</mark>، <mark>event</mark> دوم <mark>DeliveryPickedUp</mark> را پردازش کرد، <mark>view</mark> تاریخچه سفارش به طور موقت حاوی وضعیت منسوخ <mark>Order</mark> است تا زمانی که <mark>DeliveryDelivered</mark> پردازش شود. اگر این رفتار نامطلوب باشد، در این صورت <mark>event handler</mark> باید <mark>events</mark> تکراری را شناسایی و دور بریزد، مانند یک <mark>event handler</mark> غیر <mark>idempotent</mark>.
  </p>
<p>
   یک <mark>event handler</mark>، <mark>idempotent</mark> نیست اگر <mark>events</mark> تکراری منجر به یک نتیجه نادرست شوند. به عنوان مثال، یک <mark>event handler</mark> که موجودی یک حساب بانکی را افزایش می‌دهد، <mark>idempotent</mark> نیست. یک <mark>event handler</mark> غیر <mark>idempotent</mark> باید، همانطور که در فصل 3 توضیح داده شد، <mark>events</mark> تکراری را با ثبت <mark>IDs</mark> <mark>events</mark>ی که در <mark>datastore view</mark> پردازش کرده است، شناسایی و دور بریزد.
  </p>
<p>
<mark>Delivery picked up</mark>
<br/>
<mark>Order History View</mark>
<br/>
<mark>OrderId: 123</mark>
<br/>
<mark>State: PICKED_UP</mark>
<br/>
   به‌طور موقت منسوخ شده است
  </p>
<p>
<mark>Delivery delivered</mark>
<br/>
<mark>OrderId: 123</mark>
<br/>
<mark>State: DELIVERED</mark>
</p>
<p>
<mark>Delivery picked up</mark>
<br/>
<mark>OrderId: 123</mark>
<br/>
<mark>State: PICKED_UP</mark>
</p>
<p>
<mark>Delivery delivered</mark>
<br/>
<mark>OrderId: 123</mark>
<br/>
<mark>State: DELIVERED</mark>
</p>
<p>
   زمان
  </p>
<p>
   شکل 7.11
   <br/>
<mark>DeliveryPickedUp</mark> و <mark>DeliveryDelivered events</mark>، دو بار تحویل داده می‌شوند، که باعث می‌شود وضعیت سفارش در <mark>view</mark> به‌طور موقت منسوخ شود.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0270_original/original_page.png" alt="Original Page 270">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Designing CQRS views</mark></h3>
<p>
   به منظور قابل اعتماد بودن، <mark>event handler</mark> باید <mark>event ID</mark> را ثبت کند و <mark>datastore</mark> را به‌طور اتمی به‌روزرسانی کند. نحوه انجام این کار به نوع <mark>database</mark> بستگی دارد. اگر فروشگاه <mark>database view</mark> یک <mark>SQL database</mark> باشد، <mark>event handler</mark> می‌تواند <mark>events</mark> پردازش شده را به عنوان بخشی از <mark>transaction</mark> که <mark>view</mark> را به‌روزرسانی می‌کند، در یک جدول <mark>PROCESSED_EVENTS</mark> درج کند. اما اگر <mark>datastore view</mark> یک <mark>database NoSQL</mark> باشد که دارای یک مدل <mark>transaction</mark> محدود است، <mark>event handler</mark> باید <mark>event</mark> را در "رکورد" <mark>datastore</mark> (به عنوان مثال، یک سند <mark>MongoDB</mark> یا آیتم جدول <mark>DynamoDB</mark>) که به‌روزرسانی می‌کند، ذخیره کند.
  </p>
<p>
   توجه به این نکته مهم است که <mark>event handler</mark> نیازی به ثبت <mark>ID</mark> هر <mark>event</mark> ندارد. اگر، همانطور که در مورد <mark>Eventuate</mark> وجود دارد، <mark>events</mark> دارای یک <mark>ID</mark> منحصراً افزایشی هستند، در این صورت هر رکورد فقط باید <mark>max(eventId)</mark> را که از یک نمونه <mark>aggregate</mark> داده شده دریافت شده است، ذخیره کند. علاوه بر این، اگر رکورد مربوط به یک نمونه <mark>aggregate</mark> واحد باشد، در این صورت <mark>event handler</mark> فقط باید <mark>max(eventId)</mark> را ثبت کند. فقط رکوردهایی که نشان‌دهنده <mark>joins</mark> <mark>events</mark> از <mark>aggregates</mark> متعدد هستند، باید حاوی یک نقشه از [نوع <mark>aggregate</mark>، <mark>aggregate id</mark>] به <mark>max(eventId)</mark> باشند.
  </p>
<p>
   به عنوان مثال، به زودی خواهید دید که پیاده‌سازی <mark>DynamoDB</mark> از <mark>Order History view</mark> شامل مواردی است که دارای ویژگی‌هایی برای ردیابی <mark>events</mark> هستند که به این صورت هستند:
  </p>
<p>
   {...
   <br/>
   "<mark>Order3949384394-039434903" : "0000015e0c6fc18f-0242ac1100e50002</mark>"،
   <br/>
   "<mark>Delivery3949384394-039434903" : "0000015e0c6fc264-0242ac1100e50002</mark>"،
   <br/>
   }
  </p>
<p>
   این <mark>view</mark> یک <mark>join</mark> از <mark>events</mark> منتشر شده توسط <mark>services</mark> مختلف است. نام هر یک از این ویژگی‌های ردیابی <mark>event</mark>، «<mark>aggregateType»«aggregateId</mark>» است و مقدار آن <mark>eventId</mark> است. در ادامه، نحوه عملکرد این را با جزئیات بیشتر توضیح می‌دهم.
  </p>
<h5><mark>ENABLING A CLIENT APPLICATION TO USE AN EVENTUALLY CONSISTENT VIEW</mark></h5>
<p>
   همانطور که قبلاً گفتم، یکی از مسائل استفاده از <mark>CQRS</mark> این است که یک <mark>client</mark> که سمت دستور را به‌روزرسانی می‌کند و سپس فوراً یک <mark>query</mark> را اجرا می‌کند، ممکن است به‌روزرسانی خود را نبیند. <mark>View</mark>، نهایتاً سازگار است زیرا تاخیر اجتناب‌ناپذیر زیرساخت پیام‌رسانی وجود دارد.
  </p>
<p>
<mark>APIs</mark> ماژول‌های <mark>command</mark> و <mark>query</mark> می‌توانند <mark>client</mark> را قادر سازند تا یک ناسازگاری را با استفاده از رویکرد زیر شناسایی کند. یک عملیات سمت دستور، یک <mark>token</mark> حاوی <mark>ID</mark> <mark>event</mark> منتشر شده را به <mark>client</mark> برمی‌گرداند. سپس <mark>client</mark>، <mark>token</mark> را به یک عملیات <mark>query</mark> منتقل می‌کند، که اگر <mark>view</mark> توسط آن <mark>event</mark> به‌روزرسانی نشده باشد، یک خطا برمی‌گرداند. یک ماژول <mark>view</mark> می‌تواند این مکانیسم را با استفاده از مکانیسم تشخیص <mark>event</mark> تکراری پیاده‌سازی کند.
  </p>
<h4><mark>7.3.3 Adding and updating CQRS views</mark></h4>
<p>
<mark>CQRS views</mark> در طول عمر یک application، اضافه و به‌روزرسانی خواهند شد. گاهی اوقات شما نیاز دارید که یک <mark>view</mark> جدید برای پشتیبانی از یک <mark>query</mark> جدید اضافه کنید. در زمان‌های دیگر ممکن است نیاز داشته باشید یک <mark>view</mark> را دوباره ایجاد کنید زیرا <mark>schema</mark> تغییر کرده است یا نیاز دارید یک <mark>bug</mark> را در کدی که <mark>view</mark> را به‌روزرسانی می‌کند، برطرف کنید.
  </p>
<p>
   افزودن و به‌روزرسانی <mark>views</mark> از نظر مفهومی بسیار ساده است. برای ایجاد یک <mark>view</mark> جدید، شما ماژول سمت <mark>query</mark> را توسعه می‌دهید، <mark>datastore</mark> را راه‌اندازی می‌کنید و <mark>service</mark> را مستقر می‌کنید. <mark>query</mark>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0271_original/original_page.png" alt="Original Page 271">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
   در جهت اطمینان، <mark>event handler</mark> باید <mark>event ID</mark> را ثبت کند و <mark>datastore</mark> را به‌طور اتمی به‌روزرسانی کند.
  </p>
<p>
   برای قابل اطمینان بودن، <mark>event handler</mark> باید <mark>event ID</mark> را ثبت کند و <mark>datastore</mark> را به‌طور اتمی به‌روزرسانی کند. نحوه انجام این کار به نوع <mark>database</mark> بستگی دارد. اگر فروشگاه <mark>database view</mark> یک <mark>SQL database</mark> باشد، <mark>event handler</mark> می‌تواند <mark>events</mark> پردازش شده را به عنوان بخشی از <mark>transaction</mark> که <mark>view</mark> را به‌روزرسانی می‌کند، در یک جدول <mark>PROCESSED_EVENTS</mark> درج کند. اما اگر <mark>datastore view</mark> یک <mark>database NoSQL</mark> باشد که دارای یک مدل <mark>transaction</mark> محدود است، <mark>event handler</mark> باید <mark>event</mark> را در "رکورد" <mark>datastore</mark> (به عنوان مثال، یک سند <mark>MongoDB</mark> یا آیتم جدول <mark>DynamoDB</mark>) که به‌روزرسانی می‌کند، ذخیره کند.
  </p>
<p>
   توجه به این نکته مهم است که <mark>event handler</mark> نیازی به ثبت <mark>ID</mark> هر <mark>event</mark> ندارد. اگر، همانطور که در مورد <mark>Eventuate</mark> وجود دارد، <mark>events</mark> دارای یک <mark>ID</mark> منحصراً افزایشی هستند، در این صورت هر رکورد فقط باید <mark>max(eventId)</mark> را که از یک نمونه <mark>aggregate</mark> داده شده دریافت شده است، ذخیره کند.
  </p>
<p>
   به منظور قابل اطمینان بودن، <mark>event handler</mark> باید <mark>event ID</mark> را ثبت کند و <mark>datastore</mark> را به‌طور اتمی به‌روزرسانی کند.
  </p>
<p>
   افزودن و به‌روزرسانی <mark>views</mark> نیز از نظر مفهومی ساده است: شما <mark>event handlers</mark> را تغییر می‌دهید و <mark>view</mark> را از ابتدا بازسازی می‌کنید. با این حال، مشکل این است که این رویکرد بعید است در عمل کار کند. بیایید به مسائل نگاهی بیندازیم.
  </p>
<h5><mark>BUILD CQRS VIEWS USING ARCHIVED EVENTS</mark></h5>
<p>
   یک مشکل این است که <mark>message brokers</mark> نمی‌توانند پیام‌ها را برای مدت نامحدود ذخیره کنند. <mark>message brokers</mark> سنتی مانند <mark>RabbitMQ</mark>، یک پیام را پس از پردازش توسط یک مصرف‌کننده، حذف می‌کنند. حتی <mark>brokers</mark> مدرن‌تر مانند <mark>Apache Kafka</mark>، که پیام‌ها را برای یک دوره نگهداری قابل تنظیم نگه می‌دارند، برای ذخیره <mark>events</mark> برای مدت نامحدود در نظر گرفته نشده‌اند. در نتیجه، یک <mark>view</mark> را نمی‌توان فقط با خواندن تمام <mark>events</mark> مورد نیاز از <mark>message broker</mark> ساخت. در عوض، یک application باید <mark>events</mark> قدیمی‌تر را که در <mark>archive</mark> شده‌اند، برای مثال، <mark>AWS S3</mark>، نیز بخواند. شما می‌توانید این کار را با استفاده از یک فناوری <mark>big data</mark> مقیاس‌پذیر مانند <mark>Apache Spark</mark> انجام دهید.
  </p>
<h5><mark>BUILD CQRS VIEWS INCREMENTALLY</mark></h5>
<p>
   یکی دیگر از مشکلات ایجاد <mark>view</mark> این است که زمان و منابع مورد نیاز برای پردازش تمام <mark>events</mark> با گذشت زمان به رشد خود ادامه می‌دهند. در نهایت، ایجاد <mark>view</mark> بیش از حد کند و پرهزینه خواهد شد. راه‌حل استفاده از یک الگوریتم افزایشی دو مرحله‌ای است. گام اول، دوره‌ای یک <mark>snapshot</mark> از هر نمونه <mark>aggregate</mark> براساس <mark>snapshot</mark> قبلی و <mark>events</mark>ی که از زمان ایجاد آن <mark>snapshot</mark> رخ داده است، محاسبه می‌کند. گام دوم یک <mark>view</mark> را با استفاده از <mark>snapshots</mark> و هر <mark>events</mark> بعدی ایجاد می‌کند.
  </p>
<h4><mark>7.4 Implementing a CQRS view with AWS DynamoDB</mark></h4>
<p>
   اکنون که به مسائل مختلف طراحی که هنگام استفاده از <mark>CQRS</mark> باید به آن‌ها رسیدگی کنید، نگاهی انداختیم، بیایید به یک مثال بپردازیم. این بخش نحوه پیاده‌سازی یک <mark>CQRS view</mark> برای عملیات <mark>findOrderHistory()</mark> با استفاده از <mark>DynamoDB</mark> را شرح می‌دهد. <mark>AWS DynamoDB</mark> یک <mark>database NoSQL</mark> مقیاس‌پذیر است که به عنوان یک سرویس در فضای ابری <mark>Amazon</mark> در دسترس است. مدل <mark>data</mark> <mark>DynamoDB</mark> از جداولی تشکیل شده است که شامل مواردی است که، مانند اشیاء <mark>JSON</mark>، مجموعه‌ای از جفت‌های نام-مقدار سلسله مراتبی هستند. <mark>AWS DynamoDB</mark> یک <mark>database</mark> کاملاً مدیریت شده است و می‌توانید ظرفیت توان عملیاتی یک جدول را به صورت پویا افزایش و کاهش دهید.
  </p>
<p>
<mark>CQRS view</mark> برای <mark>findOrderHistory()</mark>، <mark>events</mark> را از چندین <mark>services</mark> مصرف می‌کند، بنابراین به عنوان یک <mark>Order View Service</mark> مستقل پیاده‌سازی می‌شود. این <mark>service</mark> دارای یک <mark>API</mark> است که دو عملیات را پیاده‌سازی می‌کند: <mark>findOrderHistory()</mark> و <mark>findOrder()</mark>. اگرچه <mark>findOrder()</mark> را می‌توان با استفاده از ترکیب <mark>API</mark> پیاده‌سازی کرد، اما این <mark>view</mark> این عملیات را به صورت رایگان ارائه می‌دهد. شکل 7.12 طراحی این <mark>service</mark> را نشان می‌دهد. <mark>Order History Service</mark> به عنوان مجموعه‌ای از ماژول‌ها ساختار یافته است که هر یک مسئولیت خاصی را برای ساده‌سازی توسعه و تست بر عهده دارد. مسئولیت هر ماژول به شرح زیر است:
  </p>
<ul>
<li>
<mark>OrderHistoryEventHandlers</mark>— به <mark>events</mark> منتشر شده توسط <mark>services</mark> مختلف مشترک می‌شود و <mark>OrderHistoryDAO</mark> را فراخوانی می‌کند
   </li>
<li>
    ماژول <mark>OrderHistoryQuery API</mark>— <mark>REST endpoints</mark> را که قبلاً شرح داده شد، پیاده‌سازی می‌کند
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0272_original/original_page.png" alt="Original Page 272">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Implementing a CQRS view with AWS DynamoDB</mark></h3>
<ul>
<li>
<mark>OrderHistoryDataAccess</mark>— شامل <mark>OrderHistoryDAO</mark> است، که متدهایی را تعریف می‌کند که جدول <mark>DynamoDB</mark> <mark>ftgo-order-history</mark> و کلاس‌های کمکی آن را به‌روزرسانی و <mark>query</mark> می‌کنند
   </li>
<li>
    جدول <mark>DynamoDB</mark> <mark>ftgo-order-history</mark>— جدولی که سفارش‌ها را ذخیره می‌کند
   </li>
</ul>
<p>
   بیایید نگاهی دقیق‌تر به طراحی <mark>event handlers</mark>، <mark>DAO</mark> و جدول <mark>DynamoDB</mark> بیندازیم.
  </p>
<h4><mark>7.4.1 The OrderHistoryEventHandlers module</mark></h4>
<p>
   این ماژول شامل <mark>event handlers</mark> است که <mark>events</mark> را مصرف می‌کنند و جدول <mark>DynamoDB</mark> را به‌روزرسانی می‌کنند. همانطور که در لیست زیر نشان داده شده است، <mark>event handlers</mark> متدهای ساده‌ای هستند. هر متد یک خطی است که یک متد <mark>OrderHistoryDao</mark> را با آرگومان‌هایی که از <mark>event</mark> مشتق شده‌اند، فراخوانی می‌کند.
  </p>
<p>
<mark>Order History Service</mark>
</p>
<p>
<mark>OrderHistory</mark>
<br/>
<mark>Event</mark>
<br/>
<mark>Handlers</mark>
</p>
<p>
<mark>Query</mark>
<br/>
<mark>Update</mark>
<br/>
<mark>OrderHistory</mark>
<br/>
<mark>Query</mark>
</p>
<p>
<mark>OrderHistoryDataAccess</mark>
</p>
<p>
<tex>&lt;DynamoDB table&gt;
<br/>
<mark>ftgo-order-history</mark>
</tex></p>
<p>
<mark>Order</mark>
<br/>
<mark>delivery</mark>
<br/>
   ...
   <br/>
<mark>events</mark>
</p>
<p>
<mark>ﬁndOrderHistory()</mark>
<br/>
<mark>ﬁndOrder</mark>
<br/>
<mark>OrderHistoryDAO</mark>
</p>
<p>
   شکل 7.12
   <br/>
   طراحی <mark>OrderHistoryService</mark>. <mark>OrderHistory-EventHandlers</mark>، <mark>database</mark> را در پاسخ به <mark>events</mark> به‌روزرسانی می‌کند. ماژول <mark>OrderHistoryQuery</mark> عملیات <mark>query</mark> را با <mark>querying</mark> <mark>database</mark> پیاده‌سازی می‌کند. این دو ماژول از ماژول <mark>OrderHistory-DataAccess</mark> برای دسترسی به <mark>database</mark> استفاده می‌کنند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0273_original/original_page.png" alt="Original Page 273">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<pre><code class="language-java">public class OrderHistoryEventHandlers {
 private OrderHistoryDao orderHistoryDao;
 public OrderHistoryEventHandlers(OrderHistoryDao orderHistoryDao) {
  this.orderHistoryDao = orderHistoryDao;
 }
 public void handleOrderCreated(DomainEventEnvelope&lt;OrderCreated&gt; dee) {
  orderHistoryDao.addOrder(makeOrder(dee.getAggregateId(), dee.getEvent()),
  makeSourceEvent(dee));
 }
 private Order makeOrder(String orderId, OrderCreatedEvent event) {
  ...
 }
 public void handleDeliveryPickedUp(DomainEventEnvelope&lt;DeliveryPickedUp&gt;
 dee) {
  orderHistoryDao.notePickedUp(dee.getEvent().getOrderId(),
  makeSourceEvent(dee));
 }
 ...
</code></pre>
<p>
   هر <mark>event handler</mark> دارای یک پارامتر واحد از نوع <mark>DomainEventEnvelope</mark> است، که شامل <mark>event</mark> و برخی <mark>metadata</mark>ها است که <mark>event</mark> را شرح می‌دهد. به عنوان مثال، متد <mark>handleOrderCreated()</mark> برای رسیدگی به یک <mark>OrderCreated event</mark> فراخوانی می‌شود. این، <mark>orderHistoryDao.addOrder()</mark> را برای ایجاد یک <mark>Order</mark> در <mark>database</mark> فراخوانی می‌کند. به طور مشابه، متد <mark>handleDeliveryPickedUp()</mark> برای رسیدگی به یک <mark>DeliveryPickedUp event</mark> فراخوانی می‌شود. این، <mark>orderHistoryDao.notePickedUp()</mark> را برای به‌روزرسانی وضعیت <mark>Order</mark> در <mark>database</mark> فراخوانی می‌کند.
  </p>
<p>
   هر دو متد، متد کمکی <mark>makeSourceEvent()</mark> را فراخوانی می‌کنند، که یک <mark>SourceEvent</mark> حاوی نوع و <mark>ID</mark> <mark>aggregate</mark> که <mark>event</mark> را منتشر کرده است و <mark>event ID</mark> را می‌سازد. در بخش بعدی، مشاهده خواهید کرد که <mark>OrderHistoryDao</mark> از <mark>SourceEvent</mark> برای اطمینان از اینکه عملیات به‌روزرسانی <mark>idempotent</mark> هستند، استفاده می‌کند.
  </p>
<p>
   بیایید اکنون به طراحی جدول <mark>DynamoDB</mark> و پس از آن بررسی <mark>OrderHistoryDao</mark> نگاهی بیندازیم.
  </p>
<h4><mark>7.4.2 Data modeling and query design with DynamoDB</mark></h4>
<p>
   مانند بسیاری از <mark>databases NoSQL</mark>، <mark>DynamoDB</mark> دارای عملیات دسترسی به داده است که بسیار کمتر از آن‌هایی است که توسط یک <mark>RDBMS</mark> ارائه شده‌اند. در نتیجه، شما باید نحوه ذخیره <mark>data</mark> را با دقت طراحی کنید. به طور خاص، <mark>queries</mark> اغلب طراحی <mark>schema</mark> را دیکته می‌کنند. ما باید به چندین مسئله طراحی رسیدگی کنیم:
  </p>
<ul>
<li>
    طراحی جدول <mark>ftgo-order-history</mark>
</li>
<li>
    تعریف یک <mark>index</mark> برای <mark>query findOrderHistory</mark>
</li>
</ul>
<p>
   لیست 7.1
   <br/>
<mark>Event handlers</mark> که <mark>OrderHistoryDao</mark> را فراخوانی می‌کنند
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0274_original/original_page.png" alt="Original Page 274">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Implementing a CQRS view with AWS DynamoDB</mark></h3>
<ul>
<li>
    پیاده‌سازی <mark>query findOrderHistory</mark>
</li>
<li>
    صفحه‌بندی نتایج <mark>query</mark>
</li>
<li>
    به‌روزرسانی سفارشات
   </li>
<li>
    شناسایی <mark>duplicate events</mark>
</li>
</ul>
<p>
   به هر کدام از آن‌ها به‌نوبه خود نگاهی می‌اندازیم.
  </p>
<h5><mark>DESIGNING THE FTGO-ORDER-HISTORY TABLE</mark></h5>
<p>
   مدل ذخیره‌سازی <mark>DynamoDB</mark> از جدول‌ها تشکیل شده است که شامل آیتم‌ها هستند و <mark>indexes</mark>، که راه‌های جایگزینی را برای دسترسی به آیتم‌های یک جدول (که به زودی مورد بحث قرار می‌گیرد) ارائه می‌دهند. یک آیتم مجموعه‌ای از ویژگی‌های نام‌گذاری شده است. مقدار یک ویژگی یا یک مقدار اسکالر مانند یک رشته، یک مجموعه چند مقداری از رشته‌ها، یا مجموعه‌ای از ویژگی‌های نام‌گذاری شده است. اگرچه یک آیتم معادل یک ردیف در یک <mark>RDBMS</mark> است، اما بسیار انعطاف‌پذیرتر است و می‌تواند یک <mark>aggregate</mark> کامل را ذخیره کند.
  </p>
<p>
   این انعطاف‌پذیری، ماژول <mark>OrderHistoryDataAccess</mark> را قادر می‌سازد تا هر <mark>Order</mark> را به عنوان یک آیتم واحد در یک جدول <mark>DynamoDB</mark> به نام <mark>ftgo-order-history</mark> ذخیره کند. هر فیلد کلاس <mark>Order</mark> به یک ویژگی آیتم نگاشت می‌شود، همانطور که در شکل 7.13 نشان داده شده است. فیلدهای ساده‌ای مانند <mark>orderCreationTime</mark> و <mark>status</mark> به ویژگی‌های آیتم تک مقداری نگاشت می‌شوند. فیلد <mark>lineItems</mark> به یک ویژگی نگاشت می‌شود که یک لیست از نقشه‌ها است، یک نقشه در هر خط زمانی. می‌توان آن را به عنوان یک آرایه <mark>JSON</mark> از اشیاء در نظر گرفت.
  </p>
<p>
   یک بخش مهم از تعریف یک جدول، <mark>primary key</mark> آن است. یک application <mark>DynamoDB</mark>، آیتم‌های یک جدول را توسط <mark>primary key</mark> درج، به‌روزرسانی و بازیابی می‌کند. به نظر می‌رسد که <mark>primary key</mark> باید <mark>orderId</mark> باشد. این به <mark>Order History Service</mark> امکان می‌دهد تا یک سفارش را بر اساس <mark>orderId</mark> درج، به‌روزرسانی و بازیابی کند. اما قبل از نهایی کردن این تصمیم، بیایید ابتدا بررسی کنیم که چگونه <mark>primary key</mark> یک جدول بر انواع عملیات دسترسی به داده‌هایی که پشتیبانی می‌کند، تأثیر می‌گذارد.
  </p>
<h5><mark>DEFINING AN INDEX FOR THE FINDORDERHISTORY QUERY</mark></h5>
<p>
   این تعریف جدول از خواندن و نوشتن‌های مبتنی بر <mark>primary key</mark> <mark>Orders</mark> پشتیبانی می‌کند. اما از یک <mark>query</mark> مانند <mark>findOrderHistory()</mark> که چندین سفارش منطبق را بر اساس افزایش سن مرتب شده برمی‌گرداند، پشتیبانی نمی‌کند. این به این دلیل است که، همانطور که در ادامه این بخش خواهید دید، این <mark>query</mark> از عملیات <mark>query()</mark> <mark>DynamoDB</mark> استفاده می‌کند، که نیاز دارد یک جدول
  </p>
<p>
<mark>orderId</mark>
<br/>
   ...
   <br/>
   ...
   <br/>
<mark>Primary key</mark>
<br/>
   جدول <mark>ftgo-order-history</mark>
</p>
<p>
<mark>consumerId</mark>
<br/>
<mark>xyz-abc</mark>
<br/>
   ...
  </p>
<p>
<mark>orderCreationTime</mark>
<br/>
<mark>22939283232</mark>
</p>
<p>
   ...
  </p>
<p>
<mark>status</mark>
<br/>
<mark>CREATED</mark>
<br/>
   ...
  </p>
<p>
<mark>lineItems</mark>
<br/>
   [{...}.
   <br/>
   {...},
   <br/>
   ....]
   <br/>
   ....
   <br/>
   ...
   <br/>
   ...
   <br/>
   شکل 7.13
   <br/>
   ساختار مقدماتی جدول <mark>DynamoDB OrderHistory</mark>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0275_original/original_page.png" alt="Original Page 275">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
   یک <mark>primary key</mark> مرکب متشکل از دو ویژگی اسکالر. اولین ویژگی، یک <mark>partition key</mark> است. <mark>partition key</mark> به این دلیل نامیده می‌شود که مقیاس‌بندی محور <mark>Z</mark> <mark>DynamoDB</mark> (که در فصل 1 توضیح داده شد) از آن برای انتخاب پارتیشن ذخیره‌سازی یک آیتم استفاده می‌کند. ویژگی دوم، <mark>sort key</mark> است. یک عملیات <mark>query()</mark> آن آیتم‌هایی را برمی‌گرداند که دارای <mark>partition key</mark> مشخص شده هستند، یک <mark>sort key</mark> در محدوده مشخص شده دارند، و با عبارت فیلتر اختیاری مطابقت دارند. این آیتم‌ها را به ترتیبی که توسط <mark>sort key</mark> مشخص شده است، برمی‌گرداند.
  </p>
<p>
   عملیات <mark>query</mark> <mark>findOrderHistory()</mark>، سفارش‌های یک مصرف‌کننده را بر اساس افزایش سن مرتب می‌کند. بنابراین به یک <mark>primary key</mark> نیاز دارد که <mark>consumerId</mark> را به عنوان <mark>partition key</mark> و <mark>orderCreationDate</mark> را به عنوان <mark>sort key</mark> داشته باشد. اما منطقی نیست که (consumerId, orderCreationDate) <mark>primary key</mark> جدول <mark>ftgo-order-history</mark> باشد، زیرا منحصربه‌فرد نیست.
  </p>
<p>
   راه‌حل این است که <mark>findOrderHistory()</mark>، چیزی را که <mark>DynamoDB</mark> آن را یک <mark>secondary index</mark> در جدول <mark>ftgo-order-history</mark> می‌نامد، <mark>query</mark> کند. این <mark>index</mark> دارای (consumerId, orderCreationDate) به عنوان کلید غیر منحصربه‌فرد خود است. مانند یک <mark>index RDBMS</mark>، یک <mark>DynamoDB index</mark> به‌طور خودکار هر زمان که جدول آن به‌روزرسانی می‌شود، به‌روزرسانی می‌شود. اما برخلاف یک <mark>index RDBMS</mark> معمولی، یک <mark>DynamoDB index</mark> می‌تواند ویژگی‌های غیر کلیدی داشته باشد. ویژگی‌های غیر کلیدی عملکرد را بهبود می‌بخشند زیرا توسط <mark>query</mark> برگردانده می‌شوند، بنابراین application نیازی به دریافت آن‌ها از جدول ندارد. همچنین، همانطور که به زودی خواهید دید، می‌توان از آن‌ها برای فیلتر کردن استفاده کرد. شکل 7.14 ساختار جدول و این <mark>index</mark> را نشان می‌دهد.
  </p>
<p>
<mark>index</mark> بخشی از تعریف جدول <mark>ftgo-order-history</mark> است و <mark>ftgo-order-history-by-consumer-id-and-creation-time</mark> نامیده می‌شود. ویژگی‌های <mark>index</mark>
</p>
<p>
<mark>orderId</mark>
<br/>
<mark>cde-fgh</mark>
<br/>
   ...
   <br/>
<mark>Primary key</mark>
<br/>
   جدول <mark>ftgo-order-history</mark>
</p>
<p>
<mark>consumerId</mark>
<br/>
<mark>xyz-abc</mark>
<br/>
   ...
  </p>
<p>
<mark>orderCreationTime</mark>
<br/>
<mark>22939283232</mark>
<br/>
   ...
  </p>
<p>
<mark>status</mark>
<br/>
<mark>CREATED</mark>
<br/>
   ...
  </p>
<p>
<mark>lineItems</mark>
<br/>
   [{...}.
   <br/>
   {...},
   <br/>
   ....]
   <br/>
   ....
   <br/>
   ...
   <br/>
   ...
   <br/>
   ...
  </p>
<p>
<mark>Primary key</mark>
<br/>
<mark>ftgo-order-history-by-consumer-id-and-creation-time</mark>
<br/>
<mark>global secondary index</mark>
</p>
<p>
<mark>consumerId</mark>
<br/>
<mark>xyz-abc</mark>
<br/>
   ...
  </p>
<p>
<mark>orderCreationTime</mark>
<br/>
<mark>22939283232</mark>
<br/>
   ...
  </p>
<p>
<mark>orderId</mark>
<br/>
<mark>cde-fgh</mark>
<br/>
   ...
  </p>
<p>
   ...
   <br/>
   ...
   <br/>
   ...
  </p>
<p>
<mark>status</mark>
<br/>
<mark>CREATED</mark>
<br/>
   ...
  </p>
<p>
   شکل 7.14
   <br/>
   طراحی جدول و <mark>index</mark> <mark>OrderHistory</mark>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0276_original/original_page.png" alt="Original Page 276">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Implementing a CQRS view with AWS DynamoDB</mark></h3>
<p>
   شامل ویژگی‌های <mark>primary key</mark>، <mark>consumerId</mark> و <mark>orderCreationTime</mark> و ویژگی‌های غیر کلیدی، از جمله <mark>orderId</mark> و <mark>status</mark>.
  </p>
<p>
<mark>index ftgo-order-history-by-consumer-id-and-creation-time</mark>، <mark>OrderHistoryDaoDynamoDb</mark> را قادر می‌سازد تا سفارش‌های یک مصرف‌کننده را به‌طور کارآمد بر اساس افزایش سن بازیابی کند.
  </p>
<p>
   بیایید اکنون نگاهی بیندازیم به چگونگی بازیابی فقط آن سفارش‌هایی که با معیارهای فیلتر مطابقت دارند.
  </p>
<h5><mark>IMPLEMENTING THE FINDORDERHISTORY QUERY</mark></h5>
<p>
   عملیات <mark>query</mark> <mark>findOrderHistory()</mark> دارای یک پارامتر فیلتر است که معیارهای جستجو را مشخص می‌کند. یک معیار فیلتر، حداکثر سن سفارش‌ها برای بازگشت است. این کار آسانی است زیرا عبارت شرط کلید عملیات <mark>Query</mark> <mark>DynamoDB</mark> از یک محدودیت بازه بر روی <mark>sort key</mark> پشتیبانی می‌کند. سایر معیارهای فیلتر با ویژگی‌های غیر کلیدی مطابقت دارند و می‌توانند با استفاده از یک عبارت فیلتر، که یک عبارت بولی است، پیاده‌سازی شوند. یک عملیات <mark>Query</mark> <mark>DynamoDB</mark>، فقط آن آیتم‌هایی را برمی‌گرداند که عبارت فیلتر را برآورده می‌کنند. به عنوان مثال، برای یافتن <mark>Orders</mark> که <mark>CANCELLED</mark> هستند، <mark>OrderHistoryDao-DynamoDb</mark> از یک عبارت <mark>query</mark> استفاده می‌کند <mark>orderStatus = :orderStatus</mark>، که در آن <mark>:orderStatus</mark> یک پارامتر نگهدارنده است.
  </p>
<p>
   معیار فیلتر کلمه کلیدی، پیاده‌سازی آن دشوارتر است. این سفارش‌هایی را انتخاب می‌کند که نام رستوران یا موارد منوی آن‌ها با یکی از کلمات کلیدی مشخص شده مطابقت داشته باشد. <mark>OrderHistoryDaoDynamoDb</mark> با نشانه‌گذاری نام رستوران و موارد منو و ذخیره مجموعه کلمات کلیدی در یک ویژگی با مقدار مجموعه به نام <mark>keywords</mark>، جستجوی کلمه کلیدی را فعال می‌کند. این سفارش‌هایی را که با کلمات کلیدی مطابقت دارند، با استفاده از یک عبارت فیلتر که از تابع <mark>contains()</mark> استفاده می‌کند، پیدا می‌کند، به عنوان مثال <mark>contains(keywords, :keyword1)</mark>
<br/>
   یا <mark>contains(keywords, :keyword2)</mark>، که در آن <mark>:keyword1</mark> و <mark>:keyword2</mark> مکان‌نماهایی برای کلمات کلیدی مشخص شده هستند.
  </p>
<h5><mark>PAGINATING THE QUERY RESULTS</mark></h5>
<p>
   برخی از مصرف‌کنندگان تعداد زیادی سفارش خواهند داشت. بنابراین منطقی است که عملیات <mark>query</mark> <mark>findOrderHistory()</mark> از صفحه‌بندی استفاده کند. عملیات <mark>Query</mark> <mark>DynamoDB</mark> دارای یک پارامتر <mark>pageSize</mark> است، که حداکثر تعداد آیتم‌هایی را که باید برگردانده شوند، مشخص می‌کند. اگر آیتم‌های بیشتری وجود داشته باشد، نتیجه <mark>query</mark> دارای یک ویژگی <mark>Last-EvaluatedKey</mark> غیر تهی است. یک <mark>DAO</mark> می‌تواند صفحه بعدی آیتم‌ها را با فراخوانی <mark>query</mark> با پارامتر <mark>exclusiveStartKey</mark> تنظیم شده روی <mark>LastEvaluatedKey</mark>، بازیابی کند.
  </p>
<p>
   همانطور که می‌بینید، <mark>DynamoDB</mark> از صفحه‌بندی مبتنی بر موقعیت پشتیبانی نمی‌کند. در نتیجه، <mark>Order History Service</mark> یک <mark>pagination token</mark> نامرئی را به <mark>client</mark> خود برمی‌گرداند. <mark>Client</mark> از این <mark>pagination token</mark> برای درخواست صفحه بعدی نتایج استفاده می‌کند.
  </p>
<p>
   اکنون که نحوه <mark>query</mark> کردن <mark>DynamoDB</mark> برای سفارش‌ها را شرح دادم، بیایید به نحوه درج و به‌روزرسانی آن‌ها نگاهی بیندازیم.
  </p>
<h5><mark>UPDATING ORDERS</mark></h5>
<p>
<mark>DynamoDB</mark> از دو عملیات برای افزودن و به‌روزرسانی آیتم‌ها پشتیبانی می‌کند: <mark>PutItem()</mark> و <mark>UpdateItem()</mark>. عملیات <mark>PutItem()</mark> یک آیتم کامل را با <mark>primary key</mark> آن ایجاد یا جایگزین می‌کند. در تئوری، <mark>OrderHistoryDaoDynamoDb</mark> می‌تواند از این عملیات برای درج
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0277_original/original_page.png" alt="Original Page 277">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
   و به‌روزرسانی سفارشات. با این حال، یک چالش در استفاده از <mark>PutItem()</mark> وجود دارد، اطمینان از اینکه به‌روزرسانی‌های همزمان به یک آیتم یکسان، به درستی مدیریت می‌شوند.
  </p>
<p>
   به عنوان مثال، سناریویی را در نظر بگیرید که در آن دو <mark>event handlers</mark> به‌طور همزمان تلاش می‌کنند تا یک آیتم یکسان را به‌روزرسانی کنند. هر <mark>event handler</mark>، <mark>OrderHistoryDaoDynamoDb</mark> را فراخوانی می‌کند تا آیتم را از <mark>DynamoDB</mark> بارگیری کند، آن را در حافظه تغییر دهد و با استفاده از <mark>PutItem()</mark> آن را در <mark>DynamoDB</mark> به‌روزرسانی کند. یک <mark>event handler</mark> به‌طور بالقوه می‌تواند تغییرات ایجاد شده توسط <mark>event handler</mark> دیگر را بازنویسی کند. <mark>OrderHistoryDaoDynamoDb</mark> می‌تواند با استفاده از مکانیسم قفل خوش‌بینانه <mark>DynamoDB</mark>، از از دست رفتن به‌روزرسانی‌ها جلوگیری کند. اما یک رویکرد حتی ساده‌تر و کارآمدتر استفاده از عملیات <mark>UpdateItem()</mark> است.
  </p>
<p>
   عملیات <mark>UpdateItem()</mark>، ویژگی‌های فردی آیتم را به‌روزرسانی می‌کند، و در صورت لزوم، آیتم را ایجاد می‌کند. از آنجایی که <mark>event handlers</mark> مختلف، ویژگی‌های مختلف آیتم <mark>Order</mark> را به‌روزرسانی می‌کنند، استفاده از <mark>UpdateItem</mark> منطقی است. این عملیات نیز کارآمدتر است زیرا نیازی به بازیابی ابتدا سفارش از جدول نیست.
  </p>
<p>
   یک چالش در به‌روزرسانی <mark>database</mark> در پاسخ به <mark>events</mark>، همانطور که قبلاً ذکر شد، شناسایی و دور انداختن <mark>events</mark> تکراری است. بیایید ببینیم چگونه می‌توان این کار را هنگام استفاده از <mark>DynamoDB</mark> انجام داد.
  </p>
<h5><mark>DETECTING DUPLICATE EVENTS</mark></h5>
<p>
   همه <mark>event handlers</mark> <mark>Order History Service</mark>، <mark>idempotent</mark> هستند. هر کدام یک یا چند ویژگی از آیتم <mark>Order</mark> را تنظیم می‌کنند. بنابراین، <mark>Order History Service</mark> می‌تواند به سادگی مسئله <mark>events</mark> تکراری را نادیده بگیرد. با این حال، جنبه منفی نادیده گرفتن این مسئله این است که آیتم <mark>Order</mark> گاهی اوقات به‌طور موقت منسوخ می‌شود. این به این دلیل است که یک <mark>event handler</mark> که یک <mark>event</mark> تکراری دریافت می‌کند، ویژگی‌های یک آیتم <mark>Order</mark> را روی مقادیر قبلی تنظیم می‌کند. آیتم <mark>Order</mark> تا زمانی که <mark>events</mark> بعدی دوباره تحویل داده نشوند، مقادیر صحیح را نخواهد داشت.
  </p>
<p>
   همانطور که قبلاً توضیح داده شد، یک راه برای جلوگیری از منسوخ شدن <mark>data</mark>، شناسایی و دور انداختن <mark>events</mark> تکراری است. <mark>OrderHistoryDaoDynamoDb</mark> می‌تواند <mark>events</mark> تکراری را با ثبت <mark>events</mark>ی که باعث به‌روزرسانی آن شده‌اند، در هر آیتم شناسایی کند. سپس می‌تواند از مکانیسم به‌روزرسانی مشروط عملیات <mark>UpdateItem()</mark> برای به‌روزرسانی یک آیتم فقط در صورتی استفاده کند که یک <mark>event</mark> تکراری نباشد.
  </p>
<p>
   یک به‌روزرسانی مشروط، فقط در صورتی انجام می‌شود که یک عبارت شرط درست باشد. یک عبارت شرط، وجود یک ویژگی یا داشتن یک مقدار خاص را آزمایش می‌کند. <mark>OrderHistoryDaoDynamoDb DAO</mark> می‌تواند <mark>events</mark> دریافت شده از هر نمونه <mark>aggregate</mark> را با استفاده از ویژگی به نام «<mark>aggregateType»«aggregateId</mark>» که مقدار آن، بالاترین <mark>event ID</mark> دریافت شده است، ردیابی کند. یک <mark>event</mark> در صورتی تکراری است که ویژگی وجود داشته باشد و مقدار آن کمتر یا مساوی <mark>event ID</mark> باشد. <mark>OrderHistoryDaoDynamoDb DAO</mark> از این عبارت شرط استفاده می‌کند:
  </p>
<p>
<mark>attribute_not_exists(«aggregateType»«aggregateId»)
   <br/>
   OR «aggregateType»«aggregateId» &lt; :eventId</mark>
</p>
<p>
   عبارت شرط، فقط در صورتی امکان به‌روزرسانی را می‌دهد که ویژگی وجود نداشته باشد یا <mark>eventId</mark> بزرگتر از <mark>event ID</mark> پردازش شده قبلی باشد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0278_original/original_page.png" alt="Original Page 278">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Implementing a CQRS view with AWS DynamoDB</mark></h3>
<p>
   به عنوان مثال، فرض کنید یک <mark>event handler</mark> یک <mark>DeliveryPickup event</mark> را دریافت می‌کند که <mark>ID</mark> آن 123323-343434 از یک <mark>Delivery aggregate</mark> است که <mark>ID</mark> آن 3949384394-039434903 است. نام ویژگی ردیابی، <mark>Delivery3949384394-039434903</mark> است. <mark>event handler</mark> باید <mark>event</mark> را در صورتی تکراری در نظر بگیرد که مقدار این ویژگی، بزرگتر یا مساوی 123323-343434 باشد. عملیات <mark>query()</mark> که توسط <mark>event handler</mark> فراخوانی می‌شود، آیتم <mark>Order</mark> را با استفاده از این عبارت شرط به‌روزرسانی می‌کند:
  </p>
<p>
<mark>attribute_not_exists(Delivery3949384394-039434903)
   <br/>
   OR Delivery3949384394-039434903 &lt; :eventId</mark>
</p>
<p>
   اکنون که مدل <mark>data</mark> و طراحی <mark>query</mark> <mark>DynamoDB</mark> را شرح دادم، بیایید نگاهی به <mark>OrderHistoryDaoDynamoDb</mark> بیندازیم، که متدهایی را تعریف می‌کند که جدول <mark>ftgo-order-history</mark> را به‌روزرسانی و <mark>query</mark> می‌کند.
  </p>
<h4><mark>7.4.3 The OrderHistoryDaoDynamoDb class</mark></h4>
<p>
   کلاس <mark>OrderHistoryDaoDynamoDb</mark> متدهایی را پیاده‌سازی می‌کند که آیتم‌ها را در جدول <mark>ftgo-order-history</mark> می‌خوانند و می‌نویسند. متدهای به‌روزرسانی آن توسط <mark>OrderHistory-EventHandlers</mark> فراخوانی می‌شوند، و متدهای <mark>query</mark> آن توسط <mark>OrderHistoryQuery API</mark> فراخوانی می‌شوند. بیایید به برخی از متدهای نمونه، با شروع از متد <mark>addOrder()</mark> نگاهی بیندازیم.
  </p>
<h5><mark>THE ADDORDER() METHOD</mark></h5>
<p>
   متد <mark>addOrder()</mark>، که در لیست 7.2 نشان داده شده است، یک سفارش را به جدول <mark>ftgo-order-history</mark> اضافه می‌کند. این دو پارامتر دارد: <mark>order</mark> و <mark>sourceEvent</mark>. پارامتر <mark>order</mark>، <mark>Order</mark> برای افزودن است، که از <mark>OrderCreated event</mark> به دست آمده است. پارامتر <mark>sourceEvent</mark> شامل <mark>eventId</mark> و نوع و <mark>ID</mark> <mark>aggregate</mark> است که <mark>event</mark> را منتشر کرده است. این برای پیاده‌سازی به‌روزرسانی مشروط استفاده می‌شود.
  </p>
<pre><code class="language-java">public class OrderHistoryDaoDynamoDb ...
 @Override
 public boolean addOrder(Order order, Optional&lt;SourceEvent&gt; eventSource) {
  UpdateItemSpec spec = new UpdateItemSpec()
  .withPrimaryKey("orderId", order.getOrderId())
   
  .withUpdateExpression("SET orderStatus = :orderStatus, " +
  "creationDate = :cd, consumerId = :consumerId, lineItems =" +
  " :lineItems, keywords = :keywords, restaurantName = " +
  ":restaurantName")
  .withValueMap(new Maps()
                 
  .add(":orderStatus", order.getStatus().toString())
  .add(":cd", order.getCreationDate().getMillis())
  .add(":consumerId", order.getConsumerId())
  .add(":lineItems", mapLineItems(order.getLineItems()))
  .add(":keywords", mapKeywords(order))
  .add(":restaurantName", order.getRestaurantName())
  .map())
  .withReturnValues(ReturnValue.NONE);
  return idempotentUpdate(spec, eventSource);
 }
</code></pre>
<p>
   لیست 7.2
   <br/>
   متد <mark>addOrder()</mark> یک <mark>Order</mark> را اضافه یا به‌روزرسانی می‌کند
  </p>
<p>
<br/>
<mark>The primary key of the</mark>
<br/>
<mark>Order item to update</mark>
</p>
<p>
<br/>
<mark>The update</mark>
<br/>
<mark>expression that</mark>
<br/>
<mark>updates the</mark>
<br/>
<mark>attributes</mark>
</p>
<p>
<br/>
<mark>The values of the</mark>
<br/>
<mark>placeholders in</mark>
<br/>
<mark>the update</mark>
<br/>
<mark>expression</mark>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0279_original/original_page.png" alt="Original Page 279">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
   متد <mark>addOrder()</mark> یک <mark>UpdateSpec</mark> ایجاد می‌کند، که بخشی از <mark>AWS SDK</mark> است و عملیات به‌روزرسانی را شرح می‌دهد. پس از ایجاد <mark>UpdateSpec</mark>، <mark>idempotentUpdate()</mark> را فراخوانی می‌کند، یک متد کمکی که به‌روزرسانی را پس از افزودن یک عبارت شرطی که از به‌روزرسانی‌های تکراری محافظت می‌کند، انجام می‌دهد.
  </p>
<h5><mark>THE NOTEPICKEDUP() METHOD</mark></h5>
<p>
   متد <mark>notePickedUp()</mark>، که در لیست 7.3 نشان داده شده است، توسط <mark>event handler</mark> برای <mark>DeliveryPickedUp event</mark> فراخوانی می‌شود. وضعیت تحویل آیتم <mark>Order</mark> را به <mark>PICKED_UP</mark> تغییر می‌دهد.
  </p>
<pre><code class="language-java">public class OrderHistoryDaoDynamoDb ...
 @Override
 public void notePickedUp(String orderId, Optional&lt;SourceEvent&gt; eventSource) {
  UpdateItemSpec spec = new UpdateItemSpec()
  .withPrimaryKey("orderId", orderId)
  .withUpdateExpression("SET #deliveryStatus = :deliveryStatus")
  .withNameMap(Collections.singletonMap("#deliveryStatus",
  DELIVERY_STATUS_FIELD))
  .withValueMap(Collections.singletonMap(":deliveryStatus",
  DeliveryStatus.PICKED_UP.toString()))
  .withReturnValues(ReturnValue.NONE);
  idempotentUpdate(spec, eventSource);
 }
</code></pre>
<p>
   این متد شبیه <mark>addOrder()</mark> است. این یک <mark>UpdateItemSpec</mark> ایجاد می‌کند و <mark>idempotentUpdate()</mark> را فراخوانی می‌کند. بیایید به متد <mark>idempotentUpdate()</mark> نگاهی بیندازیم.
  </p>
<h5><mark>THE IDEMPOTENTUPDATE() METHOD</mark></h5>
<p>
   لیست زیر متد <mark>idempotentUpdate()</mark> را نشان می‌دهد، که آیتم را پس از افزودن احتمالی یک عبارت شرطی به <mark>UpdateItemSpec</mark> که از به‌روزرسانی‌های تکراری محافظت می‌کند، به‌روزرسانی می‌کند.
  </p>
<pre><code class="language-java">public class OrderHistoryDaoDynamoDb ...
 private boolean idempotentUpdate(UpdateItemSpec spec, Optional&lt;SourceEvent&gt;
 eventSource) {
  try {
  table.updateItem(eventSource.map(es -&gt; es.addDuplicateDetection(spec))
  .orElse(spec));
  return true;
  } catch (ConditionalCheckFailedException e) {
  // Do nothing
  return false;
  }
 }
</code></pre>
<p>
   لیست 7.3
   <br/>
   متد <mark>notePickedUp()</mark> وضعیت سفارش را به <mark>PICKED_UP</mark> تغییر می‌دهد
  </p>
<p>
   لیست 7.4
   <br/>
   متد <mark>idempotentUpdate()</mark>، <mark>events</mark> تکراری را نادیده می‌گیرد
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0280_original/original_page.png" alt="Original Page 280">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>Implementing a CQRS view with AWS DynamoDB</mark></h3>
<p>
   اگر <mark>sourceEvent</mark> ارائه شود، <mark>idempotentUpdate()</mark>، <mark>SourceEvent.add-DuplicateDetection()</mark> را فراخوانی می‌کند تا عبارت شرطی را که قبلاً شرح داده شد، به <mark>UpdateItemSpec</mark> اضافه کند. متد <mark>idempotentUpdate()</mark>، <mark>ConditionalCheckFailedException</mark> را دریافت می‌کند و نادیده می‌گیرد، که توسط <mark>updateItem()</mark> پرتاب می‌شود اگر <mark>event</mark> تکراری باشد.
  </p>
<p>
   اکنون که کد را که جدول را به‌روزرسانی می‌کند، دیدیم، بیایید به متد <mark>query</mark> نگاهی بیندازیم.
  </p>
<h5><mark>THE FINDORDERHISTORY() METHOD</mark></h5>
<p>
   متد <mark>findOrderHistory()</mark>، که در لیست 7.5 نشان داده شده است، سفارش‌های مصرف‌کننده را با <mark>querying</mark> جدول <mark>ftgo-order-history</mark> با استفاده از <mark>index</mark> ثانویه <mark>ftgo-order-history-by-consumer-id-and-creation-time</mark> بازیابی می‌کند. این دو پارامتر دارد: <mark>consumerId</mark>، مصرف‌کننده را مشخص می‌کند، و <mark>filter</mark> معیارهای جستجو را مشخص می‌کند. این متد، <mark>QuerySpec</mark> را ایجاد می‌کند—که، مانند <mark>UpdateSpec</mark>، بخشی از <mark>AWS SDK</mark> است—از پارامترهای آن، <mark>index</mark> را <mark>query</mark> می‌کند و آیتم‌های بازگشتی را به یک شی <mark>OrderHistory</mark> تبدیل می‌کند.
  </p>
<pre><code class="language-java">public class OrderHistoryDaoDynamoDb ...
 @Override
 public OrderHistory findOrderHistory(String consumerId, OrderHistoryFilter
 filter) {
  QuerySpec spec = new QuerySpec()
  .withScanIndexForward(false)
   
  .withHashKey("consumerId", consumerId)
  .withRangeKeyCondition(new RangeKeyCondition("creationDate")
  .gt(filter.getSince().getMillis()));
  filter.getStartKeyToken().ifPresent(token -&gt;
  spec.withExclusiveStartKey(toStartingPrimaryKey(token)));
  Map&lt;String, Object&gt; valuesMap = new HashMap&lt;&gt;();
  String filterExpression = Expressions.and(
         
  keywordFilterExpression(valuesMap, filter.getKeywords()),
  statusFilterExpression(valuesMap, filter.getStatus()));
  if (!valuesMap.isEmpty())
  spec.withValueMap(valuesMap);
  if (StringUtils.isNotBlank(filterExpression)) {
  spec.withFilterExpression(filterExpression);
  }
  filter.getPageSize().ifPresent(spec::withMaxResultSize);
  ItemCollection&lt;QueryOutcome&gt; result = index.query(spec);
  return new OrderHistory(
  StreamSupport.stream(result.spliterator(), false)
</code></pre>
<p>
   لیست 7.5
   <br/>
   متد <mark>findOrderHistory()</mark> سفارش‌های منطبق یک مصرف‌کننده را بازیابی می‌کند
  </p>
<p>
   مشخص می‌کند که <mark>query</mark> باید
   <br/>
   سفارش‌ها را به ترتیب
   <br/>
   افزایش سن برگرداند
  </p>
<p>
   حداکثر
   <br/>
   سن
   <br/>
   سفارش‌ها برای
   <br/>
   بازگشت
  </p>
<p>
   یک عبارت فیلتر
   <br/>
   و نقشه مقدار <mark>placeholder</mark> را
   <br/>
   از <mark>OrderHistoryFilter</mark> بسازید.
  </p>
<p>
   تعداد را محدود کنید
   <br/>
   نتایج اگر
   <br/>
   فراخوان،
   <br/>
   اندازه صفحه را مشخص کرده است.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0281_original/original_page.png" alt="Original Page 281">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
   .map(this::toOrder)
   <br/>
   .collect(toList()),
   <br/>
   Optional.ofNullable(result
   <br/>
   .getLastLowLevelResult()
   <br/>
   .getQueryResult().getLastEvaluatedKey())
   <br/>
   .map(this::toStartKeyToken));
  </p>
<p>
   پس از ساخت یک <mark>QuerySpec</mark>، این متد سپس یک <mark>query</mark> را اجرا می‌کند و یک <mark>Order-History</mark>، که شامل لیست <mark>Orders</mark> است، از آیتم‌های بازگشتی می‌سازد.
  </p>
<p>
   متد <mark>findOrderHistory()</mark>، صفحه‌بندی را با سریال‌سازی مقداری که توسط <mark>getLastEvaluatedKey()</mark> به یک <mark>token JSON</mark> برمی‌گردد، پیاده‌سازی می‌کند. اگر یک <mark>client</mark> یک <mark>start token</mark> را در <mark>OrderHistoryFilter</mark> مشخص کند، سپس آن را سریال‌سازی می‌کند و <mark>withExclusiveStartKey()</mark> را برای تنظیم <mark>start key</mark> فراخوانی می‌کند.
  </p>
<p>
   همانطور که مشاهده می‌کنید، شما باید به مسائل متعددی هنگام پیاده‌سازی یک <mark>CQRS view</mark> بپردازید، از جمله انتخاب یک <mark>database</mark>، طراحی مدل <mark>data</mark> که به‌طور کارآمد به‌روزرسانی‌ها و <mark>queries</mark> را پیاده‌سازی می‌کند، رسیدگی به به‌روزرسانی‌های همزمان، و رسیدگی به <mark>events</mark> تکراری. تنها بخش پیچیده کد، <mark>DAO</mark> است، زیرا باید همزمان‌سازی را به‌درستی مدیریت کند و اطمینان حاصل کند که به‌روزرسانی‌ها <mark>idempotent</mark> هستند.
  </p>
<p>
   خلاصه
  </p>
<p>
<ul>
<li>پیاده‌سازی <mark>queries</mark> که داده‌ها را از چندین <mark>services</mark> بازیابی می‌کنند، چالش‌برانگیز است زیرا داده‌های هر <mark>service</mark> خصوصی است.</li>
<li>دو راه برای پیاده‌سازی این نوع <mark>query</mark> وجود دارد: الگوی ترکیب <mark>API</mark> و الگوی تفکیک مسئولیت <mark>Command query</mark> (<mark>CQRS</mark>).</li>
<li>الگوی ترکیب <mark>API</mark>، که داده‌ها را از چندین <mark>services</mark> جمع‌آوری می‌کند، ساده‌ترین راه برای پیاده‌سازی <mark>queries</mark> است و باید در صورت امکان استفاده شود.</li>
<li>یک محدودیت الگوی ترکیب <mark>API</mark> این است که برخی از <mark>queries</mark> پیچیده، نیازمند <mark>joins</mark> درون حافظه‌ای ناکارآمد از <mark>datasets</mark> بزرگ هستند.</li>
<li>الگوی <mark>CQRS</mark>، که <mark>queries</mark> را با استفاده از <mark>view databases</mark> پیاده‌سازی می‌کند، قدرتمندتر است اما پیاده‌سازی آن پیچیده‌تر است.</li>
<li>یک ماژول <mark>view CQRS</mark> باید به‌روزرسانی‌های همزمان را مدیریت کند و همچنین <mark>events</mark> تکراری را شناسایی و دور بریزد.</li>
<li><mark>CQRS</mark> جداسازی نگرانی‌ها را با فعال کردن یک <mark>service</mark> برای پیاده‌سازی یک <mark>query</mark> که داده‌های متعلق به یک <mark>service</mark> متفاوت را برمی‌گرداند، بهبود می‌بخشد.</li>
<li><mark>Clients</mark> باید با سازگاری نهایی <mark>CQRS views</mark> مقابله کنند.</li>
</ul>
</p>
<p>
   یک <mark>Order</mark> از
   <br/>
   یک آیتم بازگشتی توسط
   <br/>
   the query.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0282_original/original_page.png" alt="Original Page 282">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
   مانند بسیاری از application‌های دیگر، یک <mark>REST API</mark> دارد. <mark>clients</mark> آن شامل applicationهای تلفن همراه <mark>FTGO</mark>، <mark>JavaScript</mark> در حال اجرا در مرورگر و applicationهای توسعه یافته توسط شرکا است. در چنین معماری <mark>monolithic</mark>، <mark>API</mark>ای که به <mark>clients</mark> ارائه می‌شود، <mark>API</mark> <mark>monolith</mark> است. اما هنگامی که تیم <mark>FTGO</mark> شروع به استقرار <mark>microservices</mark> می‌کند، دیگر یک <mark>API</mark> وجود ندارد، زیرا هر <mark>service</mark>، <mark>API</mark> خود را دارد. <mark>Mary</mark> و تیمش باید تصمیم بگیرند که application <mark>FTGO</mark> اکنون باید چه نوع <mark>API</mark> را به <mark>clients</mark> خود ارائه دهد. به عنوان مثال، آیا <mark>clients</mark> باید از وجود <mark>services</mark> آگاه باشند و مستقیماً به آن‌ها درخواست ارسال کنند؟
  </p>
<p>
   این فصل موارد زیر را پوشش می‌دهد
  </p>
<ul>
<li>
    چالش طراحی <mark>APIs</mark> که از مجموعه‌ای متنوع از <mark>clients</mark> پشتیبانی می‌کنند
   </li>
<li>
    اعمال الگوی <mark>API gateway</mark> و <mark>Backends for frontends</mark>
</li>
<li>
    طراحی و پیاده‌سازی یک <mark>API gateway</mark>
</li>
<li>
    استفاده از برنامه‌نویسی واکنشی برای ساده‌سازی ترکیب <mark>API</mark>
</li>
<li>
    پیاده‌سازی یک <mark>API gateway</mark> با استفاده از <mark>GraphQL</mark>
</li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0283_original/original_page.png" alt="Original Page 283">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
   وظیفه طراحی <mark>API</mark> خارجی یک application، با تنوع <mark>clients</mark> آن حتی دشوارتر می‌شود. <mark>Clients</mark>های مختلف، معمولاً به داده‌های مختلفی نیاز دارند. یک <mark>UI</mark> مبتنی بر مرورگر دسکتاپ معمولاً اطلاعات بسیار بیشتری را نسبت به یک application موبایل نمایش می‌دهد. همچنین، <mark>clients</mark> مختلف از طریق انواع مختلف شبکه‌ها به <mark>services</mark> دسترسی پیدا می‌کنند. <mark>Clients</mark> در داخل <mark>firewall</mark> از یک <mark>LAN</mark> با عملکرد بالا استفاده می‌کنند و <mark>clients</mark> خارج از <mark>firewall</mark> از اینترنت یا شبکه تلفن همراه، که عملکرد کمتری دارند، استفاده می‌کنند. در نتیجه، همانطور که خواهید آموخت، اغلب منطقی نیست که یک <mark>API</mark> واحد و یک‌اندازه داشته باشیم.
  </p>
<p>
   این فصل با توصیف مسائل مختلف طراحی <mark>API</mark> خارجی آغاز می‌شود. سپس الگوهای <mark>API</mark> خارجی را شرح می‌دهم. من الگوی <mark>API gateway</mark> و سپس الگوی <mark>Backends for frontends</mark> را پوشش می‌دهم. پس از آن، در مورد نحوه طراحی و پیاده‌سازی یک <mark>API gateway</mark> بحث می‌کنم. من گزینه‌های مختلف موجود را مرور می‌کنم، که شامل محصولات <mark>API gateway</mark> آماده و فریم‌ورک‌هایی برای توسعه خودتان است. من طراحی و پیاده‌سازی یک <mark>API gateway</mark> را شرح می‌دهم که با استفاده از فریم‌ورک <mark>Spring Cloud Gateway</mark> ساخته شده است. همچنین نحوه ساخت یک <mark>API gateway</mark> را با استفاده از <mark>GraphQL</mark>، یک فریم‌ورک که زبان <mark>query</mark> مبتنی بر نمودار را ارائه می‌دهد، شرح می‌دهم.
  </p>
<h4><mark>8.1 External API design issues</mark></h4>
<p>
   به منظور بررسی مسائل مختلف مربوط به <mark>API</mark>، اجازه دهید application <mark>FTGO</mark> را در نظر بگیریم. همانطور که شکل 8.1 نشان می‌دهد، <mark>services</mark> این application توسط انواع مختلف <mark>clients</mark> مصرف می‌شوند. چهار نوع <mark>client</mark>، <mark>APIs</mark> <mark>services</mark> را مصرف می‌کنند:
  </p>
<ul>
<li>
    applicationهای وب، مانند application وب <mark>Consumer</mark>، که <mark>UI</mark> مبتنی بر مرورگر را برای مصرف‌کنندگان پیاده‌سازی می‌کند، application وب <mark>Restaurant</mark>، که <mark>UI</mark> مبتنی بر مرورگر را برای رستوران‌ها پیاده‌سازی می‌کند، و application وب <mark>Admin</mark>، که <mark>UI</mark> مدیر داخلی را پیاده‌سازی می‌کند
   </li>
<li>
    applicationهای <mark>JavaScript</mark> که در مرورگر در حال اجرا هستند
   </li>
<li>
    applicationهای موبایل، یکی برای مصرف‌کنندگان و دیگری برای پیک‌ها
   </li>
<li>
    applicationهایی که توسط توسعه‌دهندگان شخص ثالث نوشته شده‌اند
   </li>
</ul>
<p>
   applicationهای وب در داخل <mark>firewall</mark> اجرا می‌شوند، بنابراین آن‌ها از طریق یک <mark>LAN</mark> با پهنای باند بالا و تأخیر کم به <mark>services</mark> دسترسی دارند. <mark>Clients</mark> دیگر در خارج از <mark>firewall</mark> اجرا می‌شوند، بنابراین آن‌ها از طریق اینترنت یا شبکه تلفن همراه با پهنای باند کمتر و تأخیر بیشتر به <mark>services</mark> دسترسی دارند.
  </p>
<p>
   یک رویکرد برای طراحی <mark>API</mark> این است که <mark>clients</mark>، <mark>services</mark> را مستقیماً فراخوانی کنند. در ظاهر، این کاملاً ساده به نظر می‌رسد—به هر حال، این نحوه فراخوانی <mark>API</mark> یک application <mark>monolithic</mark> توسط <mark>clients</mark> است. اما این رویکرد به ندرت در یک معماری <mark>microservice</mark> استفاده می‌شود، به دلیل معایب زیر:
  </p>
<ul>
<li>
<mark>APIs</mark> <mark>service</mark> با دانه‌بندی ریز، نیازمند آن هستند که <mark>clients</mark> چندین درخواست برای بازیابی داده‌های مورد نیاز خود ارسال کنند، که ناکارآمد است و می‌تواند منجر به یک تجربه کاربری ضعیف شود.
   </li>
<li>
    عدم وجود کپسوله‌سازی ناشی از آگاهی <mark>clients</mark> از هر <mark>service</mark> و <mark>API</mark> آن، تغییر معماری و <mark>APIs</mark> را دشوار می‌کند.
   </li>
<li>
<mark>Services</mark> ممکن است از مکانیسم‌های <mark>IPC</mark> استفاده کنند که استفاده از آن‌ها برای <mark>clients</mark>، به‌ویژه آن <mark>clients</mark> در خارج از <mark>firewall</mark>، راحت یا عملی نیست.
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0284_original/original_page.png" alt="Original Page 284">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
   برای کسب اطلاعات بیشتر در مورد این معایب، بیایید نگاهی به چگونگی بازیابی داده‌ها از <mark>services</mark> توسط application موبایل <mark>FTGO</mark> برای مصرف‌کنندگان بیندازیم.
  </p>
<h4><mark>8.1.1 API design issues for the FTGO mobile client</mark></h4>
<p>
   مصرف‌کنندگان از <mark>client</mark> موبایل <mark>FTGO</mark> برای ثبت و مدیریت سفارشات خود استفاده می‌کنند. تصور کنید که شما در حال توسعه نمای <mark>View Order</mark> <mark>client</mark> موبایل هستید، که یک سفارش را نمایش می‌دهد. همانطور که در فصل 7 توضیح داده شد، اطلاعاتی که توسط این <mark>view</mark> نمایش داده می‌شود شامل اطلاعات سفارش اولیه، از جمله وضعیت آن، وضعیت پرداخت، وضعیت سفارش از دیدگاه رستوران و وضعیت تحویل، از جمله موقعیت مکانی و زمان تحویل تخمینی آن، اگر در حال حمل و نقل باشد.
  </p>
<p>
   نسخه <mark>monolithic</mark> application <mark>FTGO</mark> دارای یک <mark>API endpoint</mark> است که جزئیات سفارش را برمی‌گرداند. <mark>Client</mark> موبایل اطلاعات مورد نیاز خود را با ارسال یک درخواست واحد بازیابی می‌کند. در مقابل، در نسخه <mark>microservices</mark> application <mark>FTGO</mark>، جزئیات سفارش، همانطور که قبلاً توضیح داده شد، در چندین <mark>services</mark> پراکنده شده است، از جمله موارد زیر:
  </p>
<p>
   اینترنت با عملکرد کمتر
   <br/>
<mark>LAN</mark> با عملکرد بالاتر
  </p>
<p>
<mark>Backend services</mark>
<br/>
<mark>Order Service</mark>
<br/>
<mark>Firewall</mark>
<br/>
<mark>API</mark>
<br/>
   درخواست‌ها
  </p>
<p>
<mark>API</mark>
<br/>
   درخواست‌ها
  </p>
<p>
<mark>API</mark>
<br/>
   درخواست‌ها
  </p>
<p>
   درخواست‌های صفحه وب
   <br/>
   application وب
  </p>
<p>
<mark>Consumer</mark>
<br/>
<mark>Service</mark>
</p>
<p>
<mark>Delivery</mark>
<br/>
<mark>Service</mark>
</p>
<p>
<mark>Kitchen</mark>
<br/>
<mark>Service</mark>
   مرورگر
   <br/>
   application <mark>iPhone/Android</mark>
</p>
<p>
   application شخص ثالث
  </p>
<p>
   شکل 8.1
   <br/>
<mark>Services</mark> application <mark>FTGO</mark> و <mark>clients</mark> آن‌ها. چندین نوع مختلف از <mark>clients</mark> وجود دارد. برخی در داخل <mark>firewall</mark> هستند و برخی دیگر در خارج قرار دارند. آن‌هایی که خارج از <mark>firewall</mark> قرار دارند از طریق اینترنت/شبکه تلفن همراه با عملکرد کمتر به <mark>services</mark> دسترسی پیدا می‌کنند. آن <mark>clients</mark> در داخل <mark>firewall</mark> از یک <mark>LAN</mark> با عملکرد بالاتر استفاده می‌کنند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0285_original/original_page.png" alt="Original Page 285">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 8</mark></h3>
<p>
<mark>External API patterns</mark>
</p>
<ul>
<li>
<mark>Order Service</mark>— اطلاعات سفارش اولیه، از جمله جزئیات و وضعیت
   </li>
<li>
<mark>Kitchen Service</mark>— وضعیت سفارش از دیدگاه رستوران و زمان تخمینی آماده شدن آن برای تحویل
   </li>
<li>
<mark>Delivery Service</mark>— وضعیت تحویل سفارش، زمان تحویل تخمینی آن و موقعیت مکانی فعلی آن
   </li>
<li>
<mark>Accounting Service</mark>— وضعیت پرداخت سفارش
   </li>
</ul>
<p>
   اگر <mark>client</mark> موبایل <mark>services</mark> را مستقیماً فراخوانی کند، در این صورت، همانطور که شکل 8.2 نشان می‌دهد، باید چندین تماس برای بازیابی این <mark>data</mark> انجام دهد.
  </p>
<p>
<mark>FTGO backend services</mark>
<br/>
<mark>Order Service</mark>
<br/>
<mark>Firewall</mark>
<br/>
   application <mark>FTGO Monolithic</mark>
</p>
<p>
<mark>Firewall</mark>
</p>
<p>
   اینترنت
   <br/>
   اینترنت
  </p>
<p>
<mark>getOrder()</mark>
<br/>
<mark>getDelivery()</mark>
</p>
<p>
<mark>getOrderDetails()</mark>
</p>
<p>
<mark>getBill()</mark>
</p>
<p>
<mark>getTicket()</mark>
<br/>
<mark>Delivery</mark>
<br/>
<mark>Service</mark>
<br/>
   application <mark>iPhone/Android</mark> مصرف‌کننده
   <br/>
   application <mark>iPhone/Android</mark> مصرف‌کننده
   <br/>
   یک <mark>API</mark> مورد نیاز است
   <br/>
   تماس‌های <mark>API</mark> زیادی مورد نیاز است
  </p>
<p>
   شکل 8.2
   <br/>
   یک <mark>client</mark> می‌تواند جزئیات سفارش را از application <mark>FTGO monolithic</mark> با یک درخواست واحد بازیابی کند. اما <mark>client</mark> باید چندین درخواست برای بازیابی اطلاعات یکسان در یک معماری <mark>microservice</mark> ارسال کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0286_original/original_page.png" alt="Original Page 286">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 7</mark></h3>
<p>
<mark>Implementing queries in a microservice architecture</mark>
</p>
<p>
   در این طراحی، application موبایل نقش <mark>API composer</mark> را ایفا می‌کند. این، چندین <mark>services</mark> را فراخوانی می‌کند و نتایج را ترکیب می‌کند. اگرچه این رویکرد منطقی به نظر می‌رسد، اما چندین مشکل جدی دارد.
  </p>
<h5><mark>POOR USER EXPERIENCE DUE TO THE CLIENT MAKING MULTIPLE REQUESTS</mark></h5>
<p>
   اولین مشکل این است که application موبایل، گاهی اوقات باید چندین درخواست برای بازیابی داده‌هایی که می‌خواهد به کاربر نمایش دهد، ارسال کند. تعامل پر سر و صدا بین application و <mark>services</mark> می‌تواند باعث شود که application، پاسخگو به نظر نرسد، به‌ویژه زمانی که از اینترنت یا یک شبکه تلفن همراه استفاده می‌کند. اینترنت، پهنای باند بسیار کمتری و تأخیر بیشتری نسبت به <mark>LAN</mark> دارد، و شبکه‌های تلفن همراه حتی بدتر هستند.
   <br/>
   تأخیر یک شبکه تلفن همراه (و اینترنت) معمولاً 100 برابر بیشتر از یک <mark>LAN</mark> است.
  </p>
<p>
   تأخیر بالاتر ممکن است هنگام بازیابی جزئیات سفارش مشکلی ایجاد نکند، زیرا application موبایل تأخیر را با اجرای درخواست‌ها به صورت همزمان به حداقل می‌رساند. زمان پاسخ کلی بیشتر از زمان یک درخواست واحد نیست. اما در سناریوهای دیگر، یک <mark>client</mark> ممکن است نیاز داشته باشد که درخواست‌ها را به صورت متوالی اجرا کند، که منجر به یک تجربه کاربری ضعیف می‌شود.
  </p>
<p>
   علاوه بر این، تجربه کاربری ضعیف به دلیل تأخیر شبکه تنها مشکل یک <mark>API</mark> پر سر و صدا نیست. این امر مستلزم آن است که توسعه‌دهنده موبایل، کد ترکیب <mark>API</mark> بالقوه پیچیده‌ای را بنویسد. این کار یک حواس‌پرتی از وظیفه اصلی آن‌ها یعنی ایجاد یک تجربه کاربری عالی است. همچنین، از آنجایی که هر درخواست شبکه، انرژی مصرف می‌کند، یک <mark>API</mark> پر سر و صدا، باتری دستگاه تلفن همراه را سریع‌تر خالی می‌کند.
  </p>
<h5><mark>LACK OF ENCAPSULATION REQUIRES FRONTEND DEVELOPERS TO CHANGE THEIR CODE IN LOCKSTEP
   WITH THE BACKEND</mark></h5>
<p>
   یکی دیگر از معایب یک application موبایل که مستقیماً به <mark>services</mark> دسترسی دارد، عدم کپسوله‌سازی است. همانطور که یک application تکامل می‌یابد، توسعه‌دهندگان یک <mark>service</mark>، گاهی اوقات یک <mark>API</mark> را به گونه‌ای تغییر می‌دهند که <mark>clients</mark> موجود را خراب می‌کند. آن‌ها حتی ممکن است نحوه تجزیه سیستم به <mark>services</mark> را تغییر دهند. توسعه‌دهندگان ممکن است <mark>services</mark> جدیدی را اضافه کنند و <mark>services</mark> موجود را تقسیم یا ادغام کنند. اما اگر دانش در مورد <mark>services</mark> در یک application موبایل پخته شود، تغییر <mark>APIs</mark> <mark>services</mark> می‌تواند دشوار باشد.
  </p>
<p>
   برخلاف به‌روزرسانی یک application سمت سرور، راه‌اندازی یک نسخه جدید از یک application موبایل ساعت‌ها یا شاید حتی روزها طول می‌کشد. <mark>Apple</mark> یا <mark>Google</mark> باید ارتقا را تأیید کرده و آن را برای دانلود در دسترس قرار دهند. کاربران ممکن است ارتقا را فوراً (یا اگر بخواهند) دانلود نکنند. و شما ممکن است نخواهید کاربران بی‌میل را مجبور به ارتقا کنید. استراتژی ارائه <mark>APIs</mark> <mark>service</mark> به موبایل، یک مانع قابل توجه برای تکامل آن <mark>APIs</mark> ایجاد می‌کند.
  </p>
<h5><mark>SERVICES MIGHT USE CLIENT-UNFRIENDLY IPC MECHANISMS</mark></h5>
<p>
   چالش دیگر با یک application موبایل که مستقیماً <mark>services</mark> را فراخوانی می‌کند این است که برخی از <mark>services</mark> می‌توانند از پروتکل‌هایی استفاده کنند که به راحتی توسط یک <mark>client</mark> مصرف نمی‌شوند. applicationهای <mark>client</mark> که در خارج از <mark>firewall</mark> اجرا می‌شوند، معمولاً از پروتکل‌هایی مانند <mark>HTTP</mark> و <mark>WebSockets</mark> استفاده می‌کنند. اما همانطور که در فصل 3 توضیح داده شد، توسعه‌دهندگان <mark>service</mark>، پروتکل‌های زیادی برای انتخاب دارند—نه فقط <mark>HTTP</mark>. برخی از <mark>services</mark> یک application ممکن است از <mark>gRPC</mark> استفاده کنند، در حالی که برخی دیگر می‌توانند از پروتکل پیام‌رسانی <mark>AMQP</mark> استفاده کنند. این نوع پروتکل‌ها به خوبی کار می‌کنند
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0287_original/original_page.png" alt="Original Page 287">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 8</mark></h3>
<p>
<mark>External API patterns</mark>
</p>
<p>
   در این طراحی، application موبایل نقش <mark>API composer</mark> را ایفا می‌کند. این، چندین <mark>services</mark> را فراخوانی می‌کند و نتایج را ترکیب می‌کند.
  </p>
<p>
   به منظور کسب اطلاعات بیشتر در مورد این معایب، بیایید نگاهی به چگونگی بازیابی داده‌ها از <mark>services</mark> توسط application موبایل <mark>FTGO</mark> برای مصرف‌کنندگان بیندازیم.
  </p>
<h5><mark>POOR USER EXPERIENCE DUE TO THE CLIENT MAKING MULTIPLE REQUESTS</mark></h5>
<p>
   اولین مشکل این است که application موبایل، گاهی اوقات باید چندین درخواست برای بازیابی داده‌هایی که می‌خواهد به کاربر نمایش دهد، ارسال کند. تعامل پر سر و صدا بین application و <mark>services</mark> می‌تواند باعث شود که application، پاسخگو به نظر نرسد، به‌ویژه زمانی که از اینترنت یا یک شبکه تلفن همراه استفاده می‌کند. اینترنت، پهنای باند بسیار کمتری و تأخیر بیشتری نسبت به <mark>LAN</mark> دارد، و شبکه‌های تلفن همراه حتی بدتر هستند.
   <br/>
   تأخیر بالاتر ممکن است هنگام بازیابی جزئیات سفارش مشکلی ایجاد نکند، زیرا application موبایل تأخیر را با اجرای درخواست‌ها به صورت همزمان به حداقل می‌رساند. اما در سناریوهای دیگر، یک <mark>client</mark> ممکن است نیاز داشته باشد که درخواست‌ها را به صورت متوالی اجرا کند، که منجر به یک تجربه کاربری ضعیف می‌شود.
  </p>
<p>
   علاوه بر این، تجربه کاربری ضعیف به دلیل تأخیر شبکه تنها مشکل یک <mark>API</mark> پر سر و صدا نیست. این امر مستلزم آن است که توسعه‌دهنده موبایل، کد ترکیب <mark>API</mark> بالقوه پیچیده‌ای را بنویسد. این کار یک حواس‌پرتی از وظیفه اصلی آن‌ها یعنی ایجاد یک تجربه کاربری عالی است. همچنین، از آنجایی که هر درخواست شبکه، انرژی مصرف می‌کند، یک <mark>API</mark> پر سر و صدا، باتری دستگاه تلفن همراه را سریع‌تر خالی می‌کند.
  </p>
<h5><mark>LACK OF ENCAPSULATION REQUIRES FRONTEND DEVELOPERS TO CHANGE THEIR CODE IN LOCKSTEP
   WITH THE BACKEND</mark></h5>
<p>
   یکی دیگر از معایب یک application موبایل که مستقیماً به <mark>services</mark> دسترسی دارد، عدم کپسوله‌سازی است. همانطور که یک application تکامل می‌یابد، توسعه‌دهندگان یک <mark>service</mark>، گاهی اوقات یک <mark>API</mark> را به گونه‌ای تغییر می‌دهند که <mark>clients</mark> موجود را خراب می‌کند. آن‌ها حتی ممکن است نحوه تجزیه سیستم به <mark>services</mark> را تغییر دهند. توسعه‌دهندگان ممکن است <mark>services</mark> جدیدی را اضافه کنند و <mark>services</mark> موجود را تقسیم یا ادغام کنند. اما اگر دانش در مورد <mark>services</mark> در یک application موبایل پخته شود، تغییر <mark>APIs</mark> <mark>services</mark> می‌تواند دشوار باشد.
  </p>
<p>
   برخلاف به‌روزرسانی یک application سمت سرور، راه‌اندازی یک نسخه جدید از یک application موبایل ساعت‌ها یا شاید حتی روزها طول می‌کشد. <mark>Apple</mark> یا <mark>Google</mark> باید ارتقا را تأیید کرده و آن را برای دانلود در دسترس قرار دهند. کاربران ممکن است ارتقا را فوراً (یا اگر بخواهند) دانلود نکنند. و شما ممکن است نخواهید کاربران بی‌میل را مجبور به ارتقا کنید. استراتژی ارائه <mark>APIs</mark> <mark>service</mark> به موبایل، یک مانع قابل توجه برای تکامل آن <mark>APIs</mark> ایجاد می‌کند.
  </p>
<h5><mark>SERVICES MIGHT USE CLIENT-UNFRIENDLY IPC MECHANISMS</mark></h5>
<p>
   چالش دیگر با یک application موبایل که مستقیماً <mark>services</mark> را فراخوانی می‌کند این است که برخی از <mark>services</mark> می‌توانند از پروتکل‌هایی استفاده کنند که به راحتی توسط یک <mark>client</mark> مصرف نمی‌شوند. applicationهای <mark>client</mark> که در خارج از <mark>firewall</mark> اجرا می‌شوند، معمولاً از پروتکل‌هایی مانند <mark>HTTP</mark> و <mark>WebSockets</mark> استفاده می‌کنند. اما همانطور که در فصل 3 توضیح داده شد، توسعه‌دهندگان <mark>service</mark>، پروتکل‌های زیادی برای انتخاب دارند—نه فقط <mark>HTTP</mark>. برخی از <mark>services</mark> یک application ممکن است از <mark>gRPC</mark> استفاده کنند، در حالی که برخی دیگر می‌توانند از پروتکل پیام‌رسانی <mark>AMQP</mark> استفاده کنند. این نوع پروتکل‌ها به خوبی
  </p>
<h4><mark>8.1.2 API design issues for other kinds of clients</mark></h4>
<p>
   من <mark>client</mark> موبایل را انتخاب کردم زیرا این یک راه عالی برای نشان دادن معایب دسترسی مستقیم <mark>clients</mark> به <mark>services</mark> است. اما مشکلات ایجاد شده با قرار دادن <mark>services</mark> در معرض <mark>clients</mark>، فقط به <mark>clients</mark> موبایل محدود نمی‌شود. انواع دیگر <mark>clients</mark>، به‌ویژه آن‌هایی که در خارج از <mark>firewall</mark> قرار دارند، نیز با این مشکلات مواجه هستند. همانطور که قبلاً توضیح داده شد، <mark>services</mark> application <mark>FTGO</mark> توسط applicationهای وب، applicationهای <mark>JavaScript</mark> مبتنی بر مرورگر و applicationهای شخص ثالث مصرف می‌شوند. بیایید به مسائل طراحی <mark>API</mark> با این <mark>clients</mark> نگاهی بیندازیم.
  </p>
<h5><mark>API DESIGN ISSUES FOR WEB APPLICATIONS</mark></h5>
<p>
   applicationهای وب سنتی سمت سرور، که درخواست‌های <mark>HTTP</mark> را از مرورگرها مدیریت می‌کنند و صفحات <mark>HTML</mark> را برمی‌گردانند، در داخل <mark>firewall</mark> اجرا می‌شوند و از طریق یک <mark>LAN</mark> به <mark>services</mark> دسترسی پیدا می‌کنند. پهنای باند و تأخیر شبکه، مانعی برای پیاده‌سازی ترکیب <mark>API</mark> در یک application وب نیستند. همچنین، applicationهای وب می‌توانند از پروتکل‌های غیر وب‌دوست برای دسترسی به <mark>services</mark> استفاده کنند. تیم‌هایی که applicationهای وب را توسعه می‌دهند، بخشی از یک سازمان واحد هستند و اغلب در همکاری نزدیک با تیم‌هایی که <mark>services backend</mark> را می‌نویسند، کار می‌کنند، بنابراین یک application وب می‌تواند به راحتی هر زمان که <mark>services backend</mark> تغییر کردند، به‌روزرسانی شود. در نتیجه، امکان‌پذیر است که یک application وب مستقیماً به <mark>services backend</mark> دسترسی داشته باشد.
  </p>
<h5><mark>API DESIGN ISSUES FOR BROWSER-BASED JAVASCRIPT APPLICATIONS</mark></h5>
<p>
   applicationهای مرورگر مدرن از مقداری <mark>JavaScript</mark> استفاده می‌کنند. حتی اگر <mark>HTML</mark> در درجه اول توسط یک application وب سمت سرور تولید شود، معمول است که <mark>JavaScript</mark> که در مرورگر اجرا می‌شود، <mark>services</mark> را فراخوانی کند. به عنوان مثال، همه applicationهای وب <mark>FTGO</mark>—مصرف‌کننده، <mark>Restaurant</mark>، و <mark>Admin</mark>— حاوی <mark>JavaScript</mark> هستند که <mark>services backend</mark> را فراخوانی می‌کنند. به عنوان مثال، application وب <mark>Consumer</mark>، صفحه جزئیات سفارش را به صورت پویا با استفاده از <mark>JavaScript</mark> که <mark>APIs</mark> <mark>service</mark> را فراخوانی می‌کند، بازخوانی می‌کند.
  </p>
<p>
   از یک سو، applicationهای <mark>JavaScript</mark> مبتنی بر مرورگر، هنگام تغییر <mark>APIs</mark> <mark>service</mark>، به‌روزرسانی آن‌ها آسان است. از سوی دیگر، applicationهای <mark>JavaScript</mark> که از طریق اینترنت به <mark>services</mark> دسترسی دارند، همان مشکلات مربوط به تأخیر شبکه را با applicationهای موبایل دارند.
   <br/>
   برای بدتر کردن اوضاع، <mark>UIs</mark> مبتنی بر مرورگر، به‌ویژه آن‌هایی که برای دسکتاپ هستند، معمولاً پیچیده‌تر هستند و نیاز به ترکیب <mark>services</mark> بیشتری نسبت به applicationهای موبایل دارند.
   <br/>
   به احتمال زیاد، applicationهای <mark>Consumer</mark> و <mark>Restaurant</mark>، که از طریق اینترنت به <mark>services</mark> دسترسی دارند، نمی‌توانند <mark>APIs</mark> <mark>service</mark> را به طور کارآمد ترکیب کنند.
  </p>
<h5><mark>DESIGNING APIS FOR THIRD-PARTY APPLICATIONS</mark></h5>
<p>
<mark>FTGO</mark>، مانند بسیاری از سازمان‌های دیگر، یک <mark>API</mark> را به توسعه‌دهندگان شخص ثالث ارائه می‌دهد. توسعه‌دهندگان می‌توانند از <mark>API</mark> <mark>FTGO</mark> برای نوشتن applicationهایی استفاده کنند که سفارش‌ها را ثبت و مدیریت می‌کنند. این applicationهای شخص ثالث از طریق اینترنت به <mark>APIs</mark> دسترسی پیدا می‌کنند، بنابراین ترکیب <mark>API</mark> احتمالاً ناکارآمد است. اما ناکارآمدی ترکیب <mark>API</mark> یک مشکل نسبتاً جزئی در مقایسه با چالش بسیار بزرگتر طراحی یک <mark>API</mark> است.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0288_original/original_page.png" alt="Original Page 288">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 8</mark></h3>
<p>
<mark>External API patterns</mark>
</p>
<p>
<mark>API</mark> که توسط applicationهای شخص ثالث استفاده می‌شود. این به این دلیل است که توسعه‌دهندگان شخص ثالث به یک <mark>API</mark> پایدار نیاز دارند.
  </p>
<p>
   تعداد بسیار کمی از سازمان‌ها می‌توانند توسعه‌دهندگان شخص ثالث را مجبور به ارتقا به یک <mark>API</mark> جدید کنند. سازمان‌هایی که دارای یک <mark>API</mark> ناپایدار هستند، خطر از دست دادن توسعه‌دهندگان را به یک رقیب دارند. در نتیجه، شما باید تکامل یک <mark>API</mark> را که توسط توسعه‌دهندگان شخص ثالث استفاده می‌شود، با دقت مدیریت کنید. شما معمولاً باید نسخه‌های قدیمی‌تر را برای مدت طولانی—احتمالاً برای همیشه—نگه دارید.
  </p>
<p>
   این الزامات، یک بار سنگین برای یک سازمان است. غیرعملی است که توسعه‌دهندگان <mark>services backend</mark> را مسئول حفظ سازگاری به عقب درازمدت کنید. به جای اینکه <mark>services</mark> را مستقیماً در معرض توسعه‌دهندگان شخص ثالث قرار دهید، سازمان‌ها باید یک <mark>API</mark> عمومی جداگانه داشته باشند که توسط یک تیم جداگانه توسعه داده می‌شود.
   <br/>
   همانطور که بعداً خواهید آموخت، <mark>API</mark> عمومی توسط یک کامپوننت معماری به نام <mark>API gateway</mark> پیاده‌سازی می‌شود. بیایید نگاهی به نحوه عملکرد یک <mark>API gateway</mark> بیندازیم.
  </p>
<h4><mark>8.2 The API gateway pattern</mark></h4>
<p>
   همانطور که دیدید، معایب متعددی در دسترسی مستقیم <mark>services</mark> به <mark>services</mark> وجود دارد. اغلب برای یک <mark>client</mark> عملی نیست که ترکیب <mark>API</mark> را از طریق اینترنت انجام دهد. عدم کپسوله‌سازی، تغییر تفکیک <mark>service</mark> و <mark>APIs</mark> را برای توسعه‌دهندگان دشوار می‌کند. <mark>Services</mark> گاهی اوقات از پروتکل‌های ارتباطی استفاده می‌کنند که در خارج از <mark>firewall</mark> مناسب نیستند. در نتیجه، یک رویکرد بسیار بهتر استفاده از یک <mark>API gateway</mark> است.
  </p>
<p>
   یک <mark>API gateway</mark>، یک <mark>service</mark> است که نقطه ورود به application از دنیای بیرون است. این <mark>service</mark> مسئول مسیریابی درخواست، ترکیب <mark>API</mark> و سایر توابع، مانند <mark>Authentication</mark> است. این بخش الگوی <mark>API gateway</mark> را پوشش می‌دهد. من در مورد مزایا و معایب آن بحث می‌کنم و مسائل طراحی مختلفی را که باید هنگام توسعه یک <mark>API gateway</mark> به آن‌ها رسیدگی کنید، شرح می‌دهم.
  </p>
<h5><mark>8.2.1 Overview of the API gateway pattern</mark></h5>
<p>
   بخش 8.1.1 معایب <mark>clients</mark>، مانند application موبایل <mark>FTGO</mark>، را در ارسال چندین درخواست برای نمایش اطلاعات به کاربر، شرح داد. یک رویکرد بسیار بهتر این است که یک <mark>client</mark> یک درخواست واحد را به یک <mark>API gateway</mark> ارسال کند، یک <mark>service</mark> که به عنوان نقطه ورود واحد برای درخواست‌های <mark>API</mark> به یک application از خارج از <mark>firewall</mark> عمل می‌کند. این شبیه به الگوی <mark>Facade</mark> از طراحی شی‌گرا است. مانند یک نما، یک <mark>API gateway</mark> معماری داخلی application را کپسوله می‌کند و یک <mark>API</mark> را به <mark>clients</mark> خود ارائه می‌دهد. همچنین ممکن است مسئولیت‌های دیگری داشته باشد، مانند <mark>Authentication</mark>، نظارت،
  </p>
<p>
   الگو: <mark>API gateway</mark>
<br/>
   یک <mark>service</mark> را پیاده‌سازی کنید که نقطه ورود به application مبتنی بر <mark>microservices</mark> از <mark>clients API</mark> خارجی است. به <mark>http://microservices.io/patterns/apigateway.html</mark> مراجعه کنید.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0289_original/original_page.png" alt="Original Page 289">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><mark>CHAPTER 8</mark></h3>
<p>
<mark>External API patterns</mark>
</p>
<p>
   و محدودیت نرخ. شکل 8.3 رابطه بین <mark>clients</mark>، <mark>API gateway</mark> و <mark>services</mark> را نشان می‌دهد.
  </p>
<p>
<mark>API gateway</mark> مسئول مسیریابی درخواست، ترکیب <mark>API</mark> و سایر عملکردها، مانند <mark>Authentication</mark> است. این بخش، الگوی <mark>API gateway</mark> را پوشش می‌دهد. من در مورد مزایا و معایب آن بحث می‌کنم و مسائل طراحی مختلفی را که باید هنگام توسعه یک <mark>API gateway</mark> به آن‌ها رسیدگی کنید، شرح می‌دهم.
  </p>
<h5><mark>8.2.1 Overview of the API gateway pattern</mark></h5>
<p>
   بخش 8.1.1 معایب <mark>clients</mark>، مانند application موبایل <mark>FTGO</mark>، را در ارسال چندین درخواست برای نمایش اطلاعات به کاربر، شرح داد. یک رویکرد بسیار بهتر این است که یک <mark>client</mark> یک درخواست واحد را به یک <mark>API gateway</mark> ارسال کند، یک <mark>service</mark> که به عنوان نقطه ورود واحد برای درخواست‌های <mark>API</mark> به یک application از خارج از <mark>firewall</mark> عمل می‌کند. این شبیه به الگوی <mark>Facade</mark> از طراحی شی‌گرا است. مانند یک نما، یک <mark>API gateway</mark> معماری داخلی application را کپسوله می‌کند و یک <mark>API</mark> را به <mark>clients</mark> خود ارائه می‌دهد. همچنین ممکن است مسئولیت‌های دیگری داشته باشد، مانند <mark>Authentication</mark>، نظارت،
  </p>
<p>
   الگو: <mark>API gateway</mark>
<br/>
   یک <mark>service</mark> را پیاده‌سازی کنید که نقطه ورود به application مبتنی بر <mark>microservices</mark> از <mark>clients API</mark> خارجی است. به <mark>http://microservices.io/patterns/apigateway.html</mark> مراجعه کنید.
  </p>
<p>
<mark>API</mark>
<br/>
   درخواست‌ها
  </p>
<p>
<mark>API</mark>
<br/>
   درخواست‌ها
  </p>
<p>
<mark>API</mark>
<br/>
   درخواست‌ها
  </p>
<p>
   درخواست‌های صفحه وب
   <br/>
   application وب
  </p>
<p>
<mark>Consumer</mark>
<br/>
<mark>Service</mark>
</p>
<p>
<mark>Delivery</mark>
<br/>
<mark>Service</mark>
<br/>
   مرورگر
   <br/>
   application <mark>iPhone/Android</mark>
</p>
<p>
   application شخص ثالث
   <br/>
<mark>HTML</mark>
<br/>
<mark>JavaScript</mark>
<br/>
   application
  </p>
<p>
<mark>API</mark>
<br/>
<mark>gateway</mark>
</p>
<p>
   شکل 8.3
   <br/>
<mark>API gateway</mark>، نقطه ورود واحد به application برای تماس‌های <mark>API</mark> از خارج از <mark>firewall</mark> است.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0290_original/original_page.png" alt="Original Page 290">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<p>
<strong>API COMPOSITION</strong>
   یک API gateway معمولاً بیشتر از یک reverse proxy ساده انجام می‌دهد. همچنین ممکن است برخی از عملیات API را با استفاده از API composition پیاده‌سازی کند. به عنوان مثال، API gateway FTGO، عملیات API Get Order Details را با استفاده از API composition پیاده‌سازی می‌کند. همانطور که شکل 8.4 نشان می‌دهد، application موبایل یک درخواست را به API gateway ارسال می‌کند که جزئیات سفارش را از چندین service دریافت می‌کند.
  </p>
<p>
   API gateway FTGO یک API coarse-grained ارائه می‌دهد که به client های موبایل اجازه می‌دهد تا داده‌های مورد نیاز خود را با یک درخواست واحد بازیابی کنند. برای مثال، client موبایل یک درخواست getOrderDetails() واحد را به API gateway ارسال می‌کند.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAhwAAAEsCAYAAACs9jQpAAAgAElEQVR4nO3dfZAU1Z3g+M99d54B0+yR1nK07XW02uBvO8Xz091z6t2j8yWz3jYh2QjC2iM2U2iIioKkQEEFFxX6vJ0y92sPj8rS249nZ73s+7uS6mJm+jK5x/v5zF6f3a2F99/eOzz7+d4c/A0BAoAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0291_original/original_page.png" alt="Original Page 291">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>فصل 8</h3>
<h3>الگوهای API خارجی</h3>
<p>
<strong>PROTOCOL TRANSLATION</strong>
</p>
<p>
   یک API gateway همچنین ممکن است protocol translation را انجام دهد. ممکن است یک API از نوع RESTful را به client های خارجی ارائه دهد، حتی اگر service های application به صورت داخلی از ترکیبی از پروتکل‌ها، از جمله REST و gRPC، استفاده کنند. در صورت نیاز، پیاده‌سازی برخی از عملیات API بین API خارجی RESTful و API های داخلی مبتنی بر gRPC ترجمه می‌کند.
  </p>
<p>
<strong>THE API GATEWAY PROVIDES EACH CLIENT WITH CLIENT-SPECIFIC API</strong>
</p>
<p>
   یک API gateway می‌تواند یک API واحد (OSFA) one-size-fits-all را ارائه دهد. مشکل API واحد این است که client های مختلف اغلب نیازهای متفاوتی دارند. به عنوان مثال، یک application third-party ممکن است نیاز داشته باشد که عملیات API Get Order Details، جزئیات کامل Order را برگرداند، در حالی که یک client موبایل فقط به زیرمجموعه‌ای از داده‌ها نیاز دارد.
  </p>
<p>
   یک راه حل برای این مشکل این است که به client ها این گزینه را بدهید که در یک request مشخص کنند که چه فیلدها و objects مرتبطی را server باید برگرداند. این رویکرد برای یک API عمومی که باید طیف وسیعی از application های third-party را سرویس دهد، مناسب است، اما اغلب کنترل مورد نیاز را به client ها نمی دهد.
  </p>
<p>
   یک رویکرد بهتر این است که API gateway، هر client را با API خود ارائه دهد.
   به عنوان مثال، API gateway FTGO می‌تواند API ای را به client موبایل FTGO ارائه دهد که به طور خاص برای برآورده کردن requirements های آن طراحی شده است. حتی ممکن است API های مختلفی برای applications های موبایل Android و iPhone داشته باشد. API gateway همچنین یک API عمومی برای استفاده توسعه‌دهندگان third-party پیاده‌سازی خواهد کرد. بعداً، من الگوی Backends for frontends را توضیح خواهم داد که این مفهوم API-per-client را با تعریف یک API gateway جداگانه برای هر client، بیشتر پیش می‌برد.
  </p>
<p>
<strong>IMPLEMENTING EDGE FUNCTIONS</strong>
</p>
<p>
   اگرچه مسئولیت‌های اصلی یک API gateway، API routing و composition است، اما ممکن است عملکردهایی را نیز پیاده‌سازی کند که به عنوان edge functions شناخته می‌شوند. همانطور که از نامش پیداست، یک edge function، یک function پردازش request است که در edge یک application پیاده‌سازی می‌شود. نمونه‌هایی از edge functions که یک application ممکن است پیاده‌سازی کند عبارتند از:
  </p>
<ul>
<li>
<strong>Authentication</strong>—تأیید هویت client که request را انجام می‌دهد.
   </li>
<li>
<strong>Authorization</strong>—تأیید اینکه آیا client مجاز به انجام آن operation خاص است یا خیر.
   </li>
<li>
<strong>Rate limiting</strong> —محدود کردن تعداد request ها در ثانیه از یک client خاص و/یا از همه client ها.
   </li>
<li>
<strong>Caching</strong>—Cache کردن پاسخ‌ها برای کاهش تعداد request هایی که به service ها داده می‌شوند.
   </li>
<li>
<strong>Metrics collection</strong>—جمع‌آوری metrics در مورد استفاده از API برای اهداف تجزیه و تحلیل صورتحساب.
   </li>
<li>
<strong>Request logging</strong>—Log کردن request ها.
   </li>
</ul>
<p>
   سه مکان مختلف در application شما وجود دارد که می‌توانید این edge functions را پیاده‌سازی کنید. ابتدا، می‌توانید آن‌ها را در service های backend پیاده‌سازی کنید. این ممکن است برای برخی از functions، مانند caching، metrics collection و احتمالاً authorization منطقی باشد. اما به طور کلی امن‌تر است اگر application درخواست‌ها را در edge قبل از رسیدن به service ها احراز هویت کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0292_original/original_page.png" alt="Original Page 292">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<p>
   گزینه دوم این است که این edge functions را در یک edge service که upstream از API gateway است، پیاده‌سازی کنید. edge service اولین نقطه تماس برای یک client خارجی است. این request را احراز هویت می‌کند و سایر پردازش‌های edge را قبل از انتقال آن به API gateway انجام می‌دهد.
  </p>
<p>
   یک مزیت مهم استفاده از یک edge service اختصاصی، این است که <em>Separates concerns</em> می شود. API gateway بر روی API routing و composition تمرکز دارد. مزیت دیگر این است که مسئولیت edge functions های حیاتی مانند authentication را متمرکز می‌کند.
   این امر به ویژه زمانی ارزشمند است که یک application دارای چندین API gateway باشد که احتمالاً با استفاده از زبان‌ها و فریم‌ورک‌های مختلف نوشته شده‌اند. بعداً بیشتر در مورد آن صحبت خواهم کرد. نقطه ضعف این رویکرد این است که latency شبکه را به دلیل hop اضافی افزایش می‌دهد. همچنین به پیچیدگی application می‌افزاید.
  </p>
<p>
   در نتیجه، اغلب راحت است که از گزینه سوم استفاده کنید و این edge functions، به ویژه authorization را، در خود API gateway پیاده‌سازی کنید. یک hop شبکه کمتر وجود دارد که latency را بهبود می‌بخشد. همچنین قطعات متحرک کمتری وجود دارد که پیچیدگی را کاهش می‌دهد. فصل 11 نحوه همکاری API gateway و service ها برای پیاده‌سازی security را شرح می‌دهد.
  </p>
<p>
<strong>API GATEWAY ARCHITECTURE</strong>
</p>
<p>
   یک API gateway دارای یک معماری لایه‌ای و ماژولار است. معماری آن، که در شکل 8.5 نشان داده شده است، از دو لایه تشکیل شده است: لایه API و یک لایه مشترک. لایه API از یک یا چند ماژول API مستقل تشکیل شده است. هر ماژول API یک API را برای یک ... پیاده‌سازی می‌کند.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAhwAAAEsCAYAAACs9jQpAAAgAElEQVR4nO3dfZAU1Z3g+M99d54B0+yR1nK07XW02uBvO8Xz091z6t2j8yWz3jYh2QjC2iM2U2iIioKkQEEFFxX6vJ0y92sPj8rS249nZ73s+7uS6mJm+jK5x/v5zF6f3a2F99/eOzz7+d4c/A0BAoAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0293_original/original_page.png" alt="Original Page 293">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>فصل 8</h3>
<h3>الگوهای API خارجی</h3>
<p>
   client خاص. لایه مشترک، functionality مشترک، از جمله edge functions ها مانند authentication را پیاده‌سازی می‌کند.
  </p>
<p>
   در این مثال، API gateway دارای سه ماژول API است:
  </p>
<ul>
<li>
<strong>Mobile API</strong>—API را برای client موبایل FTGO پیاده‌سازی می‌کند
   </li>
<li>
<strong>Browser API</strong>—API را برای application JavaScript که در browser اجرا می‌شود، پیاده‌سازی می‌کند
   </li>
<li>
<strong>Public API</strong>—API را برای توسعه‌دهندگان third-party پیاده‌سازی می‌کند
   </li>
</ul>
<p>
   یک ماژول API، هر operation API را به یکی از دو روش پیاده‌سازی می‌کند. برخی از عملیات API مستقیماً به عملیات API single service نگاشت می‌شوند. یک ماژول API این عملیات را با routing requests به عملیات API service مربوطه پیاده‌سازی می‌کند. ممکن است requests را با استفاده از یک ماژول routing عمومی که یک فایل configuration را که قوانین routing را توصیف می‌کند، می‌خواند، route کند.
  </p>
<p>
   یک ماژول API، عملیات API دیگر، پیچیده‌تر را با استفاده از API composition پیاده‌سازی می‌کند. پیاده‌سازی این operation API از کد سفارشی تشکیل شده است. هر پیاده‌سازی operation API، request ها را با فراخوانی چندین service و ترکیب نتایج مدیریت می‌کند.
  </p>
<p>
<strong>API GATEWAY OWNERSHIP MODEL</strong>
</p>
<p>
   یک سوال مهم که باید به آن پاسخ دهید این است که چه کسی مسئول توسعه API gateway و operation آن است؟ چند گزینه مختلف وجود دارد. یکی این است که یک تیم جداگانه مسئول API gateway باشد. نقطه ضعف این است که شبیه به SOA است، جایی که یک تیم Enterprise Service Bus (ESB) مسئول تمام توسعه ESB بود. اگر یک developer که روی application موبایل کار می‌کند، نیاز به دسترسی به یک service خاص داشته باشد، باید یک request را به تیم API gateway ارسال کند و منتظر بماند تا API را expose کنند. این نوع centralized bottleneck در سازمان بسیار مخالف فلسفه معماری microservice است که تیم‌های مستقل و loosely coupled را ترویج می‌کند.
  </p>
<p>
   یک رویکرد بهتر، که توسط Netflix ترویج شده است، این است که تیم‌های client - تیم‌های موبایل، وب و public API - ماژول API را که API آن‌ها را expose می‌کند، داشته باشند. یک تیم API gateway مسئول توسعه ماژول Common و جنبه‌های عملیاتی gateway است. این ownership model، که در شکل 8.6 نشان داده شده است، به تیم‌ها کنترل API هایشان را می‌دهد.
  </p>
<p>
   هنگامی که یک تیم نیاز به تغییر API خود دارد، تغییرات را در source repository برای API gateway check in می‌کند. برای عملکرد خوب، deployment pipeline API gateway باید کاملاً خودکار باشد. در غیر این صورت، تیم‌های client اغلب برای deploy کردن version جدید منتظر تیم API gateway مسدود می‌شوند.
  </p>
<p>
<strong>USING THE BACKENDS FOR FRONTENDS PATTERN</strong>
</p>
<p>
   یکی از نگرانی‌ها در مورد API gateway این است که مسئولیت آن مبهم است. چندین تیم به یک code base یکسان کمک می‌کنند. یک تیم API gateway مسئول operation آن است. اگرچه به اندازه SOA ESB بد نیست، اما این blurring of responsibilities، مخالف فلسفه معماری microservice "if you build it, you own it" است.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0294_original/original_page.png" alt="Original Page 294">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<p>
   راه‌حل این است که یک API gateway برای هر client داشته باشید، الگوی به اصطلاح Backends for frontends (BFF) که توسط Phil Calçado (http://philcalcado.com/) و همکارانش در SoundCloud پیشگام شد. همانطور که شکل 8.7 نشان می‌دهد، هر ماژول API به API gateway مستقل خود تبدیل می‌شود که توسط یک تیم client واحد توسعه و اداره می‌شود.
  </p>
<p>
<strong>Pattern: Backends for frontends</strong>
</p>
<p>
   یک API gateway جداگانه برای هر نوع client پیاده‌سازی کنید. به http://microservices.io/patterns/apigateway.html مراجعه کنید.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAhwAAAEsCAYAAACs9jQpAAAgAElEQVR4nO3dfZAU1Z3g+M99d54B0+yR1nK07XW02uBvO8Xz091z6t2j8yWz3jYh2QjC2iM2U2iIioKkQEEFFxX6vJ0y92sPj8rS249nZ73s+7uS6mJm+jK5x/v5zF6f3a2F99/eOzz7+d4c/A0BAoAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0295_original/original_page.png" alt="Original Page 295">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>فصل 8</h3>
<h3>الگوهای API خارجی</h3>
<p>
   تیم public API مالک و اپراتور API gateway خود است، تیم موبایل مالک و اپراتور API gateway خود است و به همین ترتیب. در تئوری، API gateways های مختلف می‌توانند با استفاده از technology stacks های مختلف توسعه داده شوند. اما این امر خطر تکرار کد برای functionality مشترک، مانند کدی که edge functions ها را پیاده‌سازی می‌کند، دارد. در حالت ایده‌آل، همه API gateways از technology stack یکسانی استفاده می‌کنند. The common functionality یک کتابخانه مشترک است که توسط تیم API gateway پیاده‌سازی می‌شود.
  </p>
<p>
   علاوه بر تعریف واضح مسئولیت‌ها، الگوی BFF مزایای دیگری نیز دارد. ماژول‌های API از یکدیگر جدا شده‌اند که قابلیت اطمینان را بهبود می‌بخشد. یک API که به درستی رفتار نمی‌کند، نمی‌تواند به راحتی بر سایر API ها تأثیر بگذارد. همچنین قابلیت مشاهده را بهبود می‌بخشد، زیرا ماژول‌های API مختلف فرآیندهای مختلفی هستند. مزیت دیگر الگوی BFF این است که هر API به طور مستقل قابل مقیاس‌پذیری است. الگوی BFF همچنین زمان راه‌اندازی را کاهش می‌دهد زیرا هر API gateway یک application کوچکتر و ساده‌تر است.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAhwAAAEsCAYAAACs9jQpAAAgAElEQVR4nO3dfZAU1Z3g+M99d54B0+yR1nK07XW02uBvO8Xz091z6t2j8yWz3jYh2QjC2iM2U2iIioKkQEEFFxX6vJ0y92sPj8rS249nZ73s+7uS6mJm+jK5x/v5zF6f3a2F99/eOzz7+d4c/A0BAoAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0296_original/original_page.png" alt="Original Page 296">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<h4>8.2.2</h4>
<h3>مزایا و معایب یک API gateway</h3>
<p>
   همانطور که انتظار می‌رود، الگوی API gateway هم مزایا و هم معایبی دارد.
  </p>
<p>
<strong>BENEFITS OF AN API GATEWAY</strong>
</p>
<p>
   یک مزیت اصلی استفاده از یک API gateway این است که ساختار داخلی application را کپسوله می‌کند. به جای فراخوانی service های خاص، client ها با gateway صحبت می‌کنند.
   API gateway به هر client یک API خاص client ارائه می‌دهد که تعداد round-trips بین client و application را کاهش می‌دهد. همچنین کد client را ساده می‌کند.
  </p>
<p>
<strong>DRAWBACKS OF AN API GATEWAY</strong>
</p>
<p>
   الگوی API gateway همچنین دارای برخی معایب است. این یک component بسیار در دسترس دیگر است که باید توسعه، deploy و مدیریت شود. همچنین این خطر وجود دارد که API gateway به یک bottleneck توسعه تبدیل شود. developers باید API gateway را به منظور expose کردن API service خود به‌روزرسانی کنند. مهم است که فرآیند به‌روزرسانی API gateway تا حد امکان سبک باشد. در غیر این صورت، developers مجبور خواهند شد برای به‌روزرسانی gateway در صف منتظر بمانند. با وجود این معایب، برای اکثر application های دنیای واقعی، استفاده از API gateway منطقی است. در صورت لزوم، می‌توانید از الگوی Backends for frontends برای فعال کردن تیم‌ها برای توسعه و deploy کردن API های خود به طور مستقل استفاده کنید.
  </p>
<h4>8.2.3</h4>
<h3>Netflix به عنوان نمونه‌ای از API gateway</h3>
<p>
   یک مثال عالی از API gateway، Netflix API است. service استریمینگ Netflix در صدها نوع مختلف دستگاه از جمله تلویزیون، پخش‌کننده‌های Blu-ray، تلفن‌های هوشمند و بسیاری از گجت‌های دیگر در دسترس است. در ابتدا، Netflix سعی کرد یک API به سبک one-size-fits-all برای service استریمینگ خود داشته باشد (www.programmableweb.com/news/why-rest-keeps-me-night/2012/05/15). اما این شرکت به زودی متوجه شد که این به دلیل تنوع دستگاه‌ها و نیازهای مختلفشان خوب کار نمی‌کند. امروزه، Netflix از یک API gateway استفاده می‌کند که یک API جداگانه برای هر دستگاه پیاده‌سازی می‌کند. تیم دستگاه client، پیاده‌سازی API را توسعه و در اختیار دارد.
  </p>
<p>
   در نسخه اول API gateway، هر تیم client API خود را با استفاده از Groovy scripts که routing و API composition را انجام می‌دهند، پیاده‌سازی می‌کرد. هر script، یک یا چند service API را با استفاده از کتابخانه‌های client جاوا ارائه شده توسط تیم‌های service فراخوانی می‌کرد. از یک طرف، این خوب کار می‌کند و developers client هزاران script نوشته‌اند. API gateway Netflix میلیاردها request در روز را مدیریت می‌کند و به طور متوسط ​​هر API call به شش یا هفت service backend ختم می‌شود. از سوی دیگر، Netflix متوجه شده است که این معماری monolithic تا حدودی دست و پا گیر است.
  </p>
<p>
   در نتیجه، Netflix اکنون در حال انتقال به یک معماری API gateway مشابه الگوی Backends for frontends است. در این معماری جدید، تیم‌های client، ماژول‌های API را با استفاده از NodeJS می‌نویسند. هر ماژول API container Docker خود را اجرا می‌کند، اما scripts ها service ها را مستقیماً فراخوانی نمی‌کنند. در عوض، آنها یک "API gateway" دوم را فراخوانی می‌کنند، که API های service را با استفاده از Netflix Falcor در معرض دید قرار می‌دهد. Netflix Falcor یک technology API است که API composition اعلانی و پویا را انجام می‌دهد و client را قادر می‌سازد تا چندین ... را فراخوانی کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0297_original/original_page.png" alt="Original Page 297">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>فصل 8</h3>
<h3>الگوهای API خارجی</h3>
<p>
   service ها با استفاده از یک request واحد. این معماری جدید دارای تعدادی مزیت است. ماژول‌های API از یکدیگر جدا شده‌اند که قابلیت اطمینان و observability را بهبود می‌بخشد و ماژول API client به طور مستقل قابل مقیاس‌پذیری است.
  </p>
<h4>8.2.4</h4>
<h3>مسائل طراحی API gateway</h3>
<p>
   اکنون که به الگوی API gateway و مزایا و معایب آن نگاهی انداختیم، بیایید مسائل مختلف طراحی API gateway را بررسی کنیم. هنگام طراحی یک API gateway چندین مسئله وجود دارد که باید در نظر بگیرید:
  </p>
<ul>
<li>
    عملکرد و مقیاس‌پذیری
   </li>
<li>
    نوشتن کد قابل نگهداری با استفاده از انتزاع‌های برنامه‌نویسی reactive
   </li>
<li>
    Handling partial failure
   </li>
<li>
    Being a good citizen در معماری application
   </li>
</ul>
<p>
   ما به هر یک نگاهی خواهیم انداخت.
  </p>
<p>
<strong>PERFORMANCE AND SCALABILITY</strong>
</p>
<p>
   یک API gateway در ورودی application است. تمام requests های خارجی ابتدا باید از gateway عبور کنند. اگرچه اکثر شرکت‌ها در مقیاس Netflix که میلیاردها request در روز را مدیریت می‌کند، فعالیت نمی‌کنند، عملکرد و مقیاس‌پذیری API gateway معمولاً بسیار مهم است. یک تصمیم طراحی کلیدی که بر عملکرد و مقیاس‌پذیری تأثیر می‌گذارد این است که آیا API gateway باید از I/O synchronous یا asynchronous استفاده کند.
  </p>
<p>
   در synchronous I/O model، هر connection شبکه توسط یک thread اختصاصی مدیریت می‌شود. این یک مدل برنامه‌نویسی ساده است و به خوبی کار می‌کند. به عنوان مثال، این اساس فریم‌ورک servlet Java EE است که به طور گسترده مورد استفاده قرار می‌گیرد، اگرچه این فریم‌ورک گزینه تکمیل یک request را به صورت asynchronous ارائه می‌دهد. با این حال، یک محدودیت I/O synchronous این است که thread های operating system سنگین هستند، بنابراین یک محدودیت در تعداد thread ها، و از این رو connections همزمان، وجود دارد که یک API gateway می‌تواند داشته باشد.
  </p>
<p>
   رویکرد دیگر استفاده از asynchronous (nonblocking) I/O model است. در این مدل، یک thread event loop واحد، request های I/O را به event handlers ارسال می‌کند. شما انواع technology های I/O asynchronous را برای انتخاب دارید. در JVM می‌توانید از یکی از فریم‌ورک‌های مبتنی بر NIO مانند Netty، Vertx، Spring Reactor یا JBoss Undertow استفاده کنید. یکی از گزینه‌های محبوب غیر JVM، NodeJS است، پلتفرمی که بر روی engine JavaScript Chrome ساخته شده است.
  </p>
<p>
   I/O Nonblocking بسیار مقیاس‌پذیرتر است زیرا سربار استفاده از چندین thread را ندارد. با این حال، نقطه ضعف این است که مدل برنامه‌نویسی مبتنی بر callback-asynchronous بسیار پیچیده‌تر است. کد نوشتن، درک و اشکال‌زدایی آن دشوارتر است. Event handlers ها باید سریع برگردند تا از blocking شدن thread event loop جلوگیری شود.
  </p>
<p>
   همچنین، اینکه آیا استفاده از I/O nonblocking یک مزیت کلی معنی‌داری دارد یا خیر، به ویژگی‌های منطق request-processing API gateway بستگی دارد. Netflix نتایج متفاوتی داشت زمانی که Zuul، edge server خود را، برای استفاده از NIO بازنویسی کرد (به https://medium.com/netflix-techblog/zuul-2-the-netflix-journey-to-asynchronous-non-blocking-systems-45947377fb5c مراجعه کنید).
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0298_original/original_page.png" alt="Original Page 298">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<p>
   از یک طرف، همانطور که انتظار می‌رود، استفاده از NIO هزینه هر connection شبکه را کاهش داد، به این دلیل که دیگر یک thread اختصاصی برای هر کدام وجود ندارد. همچنین، یک خوشه Zuul که منطق I/O-intensive - مانند request routing - را اجرا می‌کرد، 25٪ افزایش در throughput و 25٪ کاهش در CPU utilization داشت. از طرف دیگر، یک خوشه Zuul که منطق CPU-intensive - مانند رمزگشایی و فشرده‌سازی - را اجرا می‌کرد، هیچ بهبودی نشان نداد.
  </p>
<p>
<strong>USE REACTIVE PROGRAMMING ABSTRACTIONS</strong>
</p>
<p>
   همانطور که قبلاً ذکر شد، API composition شامل فراخوانی چندین service backend است.
   برخی از request های service backend کاملاً به پارامترهای request client بستگی دارد.
   برخی دیگر ممکن است به نتایج request های service دیگر بستگی داشته باشند. یک رویکرد این است که یک متد handler API endpoint، service ها را به ترتیبی که توسط dependencies تعیین می‌شود، فراخوانی کند. به عنوان مثال، فهرست زیر handler را برای request findOrder() نشان می‌دهد که به این روش نوشته شده است. این متد، هر یک از چهار service را یکی پس از دیگری فراخوانی می‌کند.
  </p>
<pre><code class="language-java">@RestController
public class OrderDetailsController {
@RequestMapping("/order/{orderId}")
public OrderDetails getOrderDetails(@PathVariable String orderId) {
OrderInfo orderInfo = orderService.findOrderById(orderId);
TicketInfo ticketInfo = kitchenService
.findTicketByOrderId(orderId);
DeliveryInfo deliveryInfo = deliveryService
.findDeliveryByOrderId(orderId);
BillInfo billInfo = accountingService
.findBillByOrderId(orderId);
OrderDetails orderDetails =
OrderDetails.makeOrderDetails(orderInfo, ticketInfo,
deliveryInfo, billInfo);
return orderDetails;
}
...</code></pre>
<p>
   نقطه ضعف فراخوانی service ها به صورت ترتیبی این است که زمان پاسخگویی، مجموع زمان‌های پاسخگویی service است. به منظور به حداقل رساندن زمان پاسخگویی، منطق composition باید، در صورت امکان، service ها را به طور همزمان فراخوانی کند. در این مثال، هیچ dependencies ای بین فراخوانی‌های service وجود ندارد. همه service ها باید به طور همزمان فراخوانی شوند که زمان پاسخگویی را به میزان قابل توجهی کاهش می‌دهد. چالش این است که کد همزمانی بنویسید که قابل نگهداری باشد.
  </p>
<p>
   این به این دلیل است که روش سنتی برای نوشتن کد مقیاس‌پذیر و همزمان، استفاده از callback ها است. I/O Asynchronous و event-driven ذاتاً مبتنی بر callback است. حتی یک Servlet
  </p>
<p>
<strong>Listing 8.1</strong>
   Fetching the order details by calling the backend services sequentially
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0299_original/original_page.png" alt="Original Page 299">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>فصل 8</h3>
<h3>الگوهای API خارجی</h3>
<p>
   API-based API composer که service ها را به طور همزمان فراخوانی می‌کند، معمولاً از callback ها استفاده می‌کند. می‌تواند requests را با فراخوانی ()ExecutorService.submitCallable به طور همزمان اجرا کند.
   مشکل این است که این متد، یک Future را برمی‌گرداند که دارای یک API blocking است. یک رویکرد مقیاس‌پذیرتر این است که یک API composer، ()ExecutorService.submit (Runnable) را فراخوانی کند و برای هر Runnable یک callback را با نتیجه request فراخوانی کند. callback، نتایج را جمع‌آوری می‌کند و پس از دریافت همه آنها، پاسخ را به client برمی‌گرداند.
  </p>
<p>
   نوشتن کد API composition با استفاده از رویکرد callback asynchronous سنتی، شما را سریعاً به callback hell می‌رساند. کد درهم‌تنیده، دشوار برای درک و مستعد خطا خواهد بود، به خصوص زمانی که composition به ترکیبی از request های موازی و متوالی نیاز دارد. یک رویکرد بسیار بهتر این است که کد API composition را با سبک اعلانی با استفاده از رویکرد reactive بنویسید. نمونه‌هایی از انتزاع‌های reactive برای JVM عبارتند از:
  </p>
<ul>
<li>
    Java 8 CompletableFutures
   </li>
<li>
    Project Reactor Monos
   </li>
<li>
    RxJava (Reactive Extensions for Java) Observables، که توسط Netflix به طور خاص برای حل این مشکل در API gateway خود ایجاد شده است
   </li>
<li>
    Scala Futures
   </li>
</ul>
<p>
   یک API gateway مبتنی بر NodeJS از JavaScript promises یا RxJS استفاده می‌کند که extensions reactive برای JavaScript است. استفاده از یکی از این انتزاع‌های reactive شما را قادر می‌سازد تا کد همزمانی بنویسید که ساده و آسان برای درک است. بعداً در این فصل، من نمونه‌ای از این سبک کدنویسی را با استفاده از Project Reactor Monos و نسخه 5 Spring Framework نشان می‌دهم.
  </p>
<p>
<strong>HANDLING PARTIAL FAILURES</strong>
</p>
<p>
   علاوه بر مقیاس‌پذیری، یک API gateway نیز باید قابل اعتماد باشد. یک راه برای دستیابی به قابلیت اطمینان، اجرای چندین نمونه از gateway در پشت یک load balancer است. اگر یک نمونه شکست بخورد، load balancer، requests را به نمونه‌های دیگر route می‌کند.
  </p>
<p>
   راه دیگر برای اطمینان از قابلیت اطمینان یک API gateway، رسیدگی صحیح به request های ناموفق و request هایی است که latency بسیار بالایی دارند. هنگامی که یک API gateway یک service را فراخوانی می‌کند، همیشه این احتمال وجود دارد که service کند یا در دسترس نباشد. یک API gateway ممکن است برای مدت زمان بسیار طولانی، شاید برای مدت نامحدود، منتظر پاسخ باشد که منابع را مصرف می‌کند و از ارسال پاسخ به client خود جلوگیری می‌کند. یک request برجسته به یک service ناموفق ممکن است حتی یک منبع محدود و ارزشمند مانند یک thread را مصرف کند و در نهایت منجر به این شود که API gateway قادر به رسیدگی به هیچ request دیگری نباشد. راه‌حل، همانطور که در فصل 3 توضیح داده شد، این است که یک API gateway از الگوی Circuit breaker هنگام فراخوانی service ها استفاده کند.
  </p>
<p>
<strong>BEING A GOOD CITIZEN IN THE ARCHITECTURE</strong>
</p>
<p>
   در فصل 3 من الگوهایی را برای service discovery شرح دادم و در فصل 11، الگوهایی را برای observability پوشش می‌دهم. الگوهای service discovery یک service client، مانند یک API gateway، را قادر می‌سازند تا موقعیت شبکه یک instance service را تعیین کند تا بتواند آن را فراخوانی کند. الگوهای observability به developers اجازه می‌دهند تا ... را مانیتور کنند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0300_original/original_page.png" alt="Original Page 300">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<p>
   رفتار یک application و عیب‌یابی مشکلات. یک API gateway، مانند سایر service ها در معماری، باید الگوهایی را که برای معماری انتخاب شده‌اند، پیاده‌سازی کند.
  </p>
<h3>8.3</h3>
<h3>پیاده‌سازی یک API gateway</h3>
<p>
   بیایید اکنون نگاهی بیندازیم به نحوه پیاده‌سازی یک API gateway. همانطور که قبلاً ذکر شد، مسئولیت‌های یک API gateway به شرح زیر است:
  </p>
<ul>
<li>
    Request routing—requests ها را به service ها با استفاده از معیارهایی مانند متد و مسیر request HTTP route می‌کند. API gateway باید با استفاده از متد request HTTP route کند، زمانی که application دارای یک یا چند service query از نوع CQRS باشد. همانطور که در فصل 7 بحث شد، در چنین معماری، دستورات و queries توسط service های جداگانه مدیریت می‌شوند.
   </li>
<li>
    API composition—یک endpoint GET REST را با استفاده از الگوی API composition، که در فصل 7 توضیح داده شد، پیاده‌سازی می‌کند. request handler، نتایج فراخوانی چندین service را ترکیب می‌کند.
   </li>
<li>
    Edge functions—که برجسته‌ترین آن‌ها authentication است.
   </li>
<li>
    Protocol translation—بین پروتکل‌های client-friendly و پروتکل‌های client-unfriendly که توسط service ها استفاده می‌شوند، ترجمه می‌کند.
   </li>
<li>
    Being a good citizen در معماری application.
   </li>
</ul>
<p>
   چندین راه مختلف برای پیاده‌سازی یک API gateway وجود دارد:
  </p>
<ul>
<li>
    استفاده از یک محصول/service API gateway آماده - این گزینه به توسعه کمی نیاز دارد یا اصلاً نیازی ندارد، اما کمترین انعطاف‌پذیری را دارد. به عنوان مثال، یک API gateway آماده معمولاً از API composition پشتیبانی نمی‌کند
   </li>
<li>
    توسعه API gateway خود با استفاده از یک فریم‌ورک API gateway یا یک فریم‌ورک وب به عنوان نقطه شروع - این رویکرد انعطاف‌پذیرترین رویکرد است، اگرچه به مقداری تلاش برای توسعه نیاز دارد.
   </li>
</ul>
<p>
   بیایید به این گزینه‌ها نگاهی بیندازیم، با استفاده از یک محصول یا service API gateway آماده شروع می‌کنیم.
  </p>
<h4>8.3.1</h4>
<h3>استفاده از یک محصول/service API gateway آماده</h3>
<p>
   چندین service و محصول آماده، ویژگی‌های API gateway را پیاده‌سازی می‌کنند. ابتدا به چند service که توسط AWS ارائه می‌شود نگاهی می‌اندازیم. پس از آن، در مورد برخی از محصولاتی که می‌توانید دانلود، پیکربندی و خودتان اجرا کنید، بحث خواهم کرد.
  </p>
<p>
<strong>AWS API GATEWAY</strong>
</p>
<p>
   AWS API gateway، یکی از خدمات متعددی که توسط Amazon Web Services ارائه می‌شود، یک service برای deploy و مدیریت API ها است. یک AWS API gateway API مجموعه‌ای از resource های REST است که هر کدام از یک یا چند متد HTTP پشتیبانی می‌کنند. شما API gateway را طوری پیکربندی می‌کنید که هر (متد، Resource) را به یک service backend route کند. یک service backend یا یک Function از نوع AWS Lambda است که بعداً در فصل 12 توضیح داده می‌شود، یک service HTTP تعریف شده توسط application یا یک service AWS است. در صورت لزوم، می‌توانید API را پیکربندی کنید ...
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0301_original/original_page.png" alt="Original Page 301">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>فصل 8</h3>
<h3>الگوهای API خارجی</h3>
<p>
   gateway برای تبدیل request و response با استفاده از یک مکانیزم مبتنی بر template.
   AWS API gateway همچنین می‌تواند requests را احراز هویت کند.
  </p>
<p>
   AWS API gateway، برخی از requirements ها را برای یک API gateway که قبلاً فهرست کردم، برآورده می‌کند. API gateway توسط AWS ارائه شده است، بنابراین شما مسئول نصب و operations نیستید. شما API gateway را پیکربندی می‌کنید و AWS بقیه موارد از جمله scaling را مدیریت می‌کند.
  </p>
<p>
   متأسفانه، AWS API gateway دارای چندین نقطه ضعف و محدودیت است که باعث می‌شود سایر requirements ها را برآورده نکند. از API composition پشتیبانی نمی‌کند، بنابراین شما باید API composition را در service های backend پیاده‌سازی کنید. AWS API gateway تنها از HTTP(S) با تأکید زیاد بر JSON پشتیبانی می‌کند. این فقط از الگوی Server-side discovery، که در فصل 3 توضیح داده شد، پشتیبانی می‌کند. یک application معمولاً از یک AWS Elastic Load Balancer برای load balance کردن requests در سراسر مجموعه ای از instances های EC2 یا containers های ECS استفاده می‌کند. با وجود این محدودیت‌ها، مگر اینکه به API composition نیاز داشته باشید، AWS API gateway یک پیاده‌سازی خوب از الگوی API gateway است.
  </p>
<p>
<strong>AWS APPLICATION LOAD BALANCER</strong>
</p>
<p>
   یکی دیگر از service های AWS که functionality شبیه به API gateway را ارائه می‌دهد، AWS Application Load Balancer است که یک load balancer برای HTTP، HTTPS، WebSocket و HTTP/2 است (https://aws.amazon.com/blogs/aws/new-aws-application-load-balancer/).
   هنگام پیکربندی یک Application Load Balancer، شما قوانین routing را تعریف می‌کنید که requests را به service های backend route می‌کند که باید روی instances های AWS EC2 اجرا شوند.
  </p>
<p>
   مانند AWS API gateway، AWS Application Load Balancer، برخی از requirements ها را برای یک API gateway برآورده می‌کند. این functionality routing اساسی را پیاده‌سازی می‌کند. میزبانی می‌شود، بنابراین شما مسئول نصب یا operations نیستید. متاسفانه، کاملاً محدود است. این، routing مبتنی بر متد HTTP را پیاده‌سازی نمی‌کند. همچنین API composition یا authentication را پیاده‌سازی نمی‌کند. در نتیجه، AWS Application Load Balancer، requirements های یک API gateway را برآورده نمی‌کند.
  </p>
<p>
<strong>USING AN API GATEWAY PRODUCT</strong>
</p>
<p>
   یک گزینه دیگر استفاده از یک product API gateway مانند Kong یا Traefik است. اینها بسته های open source هستند که شما خودتان نصب و operate می‌کنید. Kong بر اساس سرور HTTP NGINX است و Traefik در GoLang نوشته شده است. هر دو product به شما اجازه می‌دهند تا قوانین routing انعطاف‌پذیری را پیکربندی کنید که از متد HTTP، headers و path برای انتخاب service backend استفاده می‌کنند. Kong به شما این امکان را می‌دهد که plugins هایی را پیکربندی کنید که edge functions ها مانند authentication را پیاده‌سازی می‌کنند. Traefik حتی می‌تواند با برخی از service registries ها، که در فصل 3 توضیح داده شده‌اند، ادغام شود.
  </p>
<p>
   اگرچه این products، edge functions و قابلیت‌های routing قدرتمند را پیاده‌سازی می‌کنند، اما دارای برخی معایب هستند. شما باید آن‌ها را خودتان نصب، پیکربندی و operate کنید. از API composition پشتیبانی نمی‌کنند. و اگر می‌خواهید API gateway، API composition را انجام دهد، باید API gateway خود را توسعه دهید.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0302_original/original_page.png" alt="Original Page 302">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<h4>8.3.2</h4>
<h3>توسعه API gateway خودتان</h3>
<p>
   توسعه یک API gateway، به طور خاص دشوار نیست. اساساً یک application وب است که requests را به service های دیگر proxy می‌کند. می‌توانید یکی را با استفاده از فریم‌ورک وب مورد علاقه خود بسازید. با این حال، دو مشکل طراحی کلیدی وجود دارد که باید حل کنید:
  </p>
<ul>
<li>
    پیاده‌سازی یک مکانیزم برای تعریف قوانین routing به منظور به حداقل رساندن coding پیچیده
   </li>
<li>
    پیاده‌سازی صحیح رفتار proxy کردن HTTP، از جمله نحوه handling کردن headers HTTP
   </li>
</ul>
<p>
   در نتیجه، یک نقطه شروع بهتر برای توسعه یک API gateway، استفاده از یک فریم‌ورک است که برای آن هدف طراحی شده است. عملکرد داخلی آن، میزان کد مورد نیاز برای نوشتن را به میزان قابل توجهی کاهش می‌دهد.
  </p>
<p>
   ما به Netflix Zuul، یک project open source توسط Netflix نگاهی می‌اندازیم، و سپس Spring Cloud Gateway، یک project open source از Pivotal را در نظر می‌گیریم.
  </p>
<p>
<strong>USING NETFLIX ZUUL</strong>
</p>
<p>
   Netflix، فریم‌ورک Zuul را برای پیاده‌سازی edge functions ها مانند routing، rate limiting و authentication توسعه داد (https://github.com/Netflix/zuul). فریم‌ورک Zuul از مفهوم filters، request interceptors های قابل استفاده مجدد که شبیه به servlet filters ها یا middleware های NodeJS Express هستند، استفاده می‌کند. Zuul یک request HTTP را با جمع‌آوری یک زنجیره از filters های قابل اجرا مدیریت می‌کند که سپس request را تبدیل می‌کنند، service های backend را فراخوانی می‌کنند و response را قبل از ارسال دوباره به client تبدیل می‌کنند. اگرچه می‌توانید مستقیماً از Zuul استفاده کنید، اما استفاده از Spring Cloud Zuul، یک project open source از Pivotal، بسیار آسان‌تر است. Spring Cloud Zuul بر اساس Zuul ساخته شده است و از طریق convention-over-configuration، توسعه یک server مبتنی بر Zuul را به طرز چشمگیری آسان می‌کند.
  </p>
<p>
   Zuul، routing و edge functionality را مدیریت می‌کند. می‌توانید Zuul را با تعریف controller های Spring MVC که API composition را پیاده‌سازی می‌کنند، گسترش دهید. اما یک محدودیت عمده Zuul این است که فقط می‌تواند routing مبتنی بر path را پیاده‌سازی کند. به عنوان مثال، قادر به route کردن GET /orders به یک service و POST /orders به یک service متفاوت نیست. در نتیجه، Zuul از معماری query که در فصل 7 توضیح داده شد، پشتیبانی نمی‌کند.
  </p>
<p>
<strong>ABOUT SPRING CLOUD GATEWAY</strong>
</p>
<p>
   هیچ یک از گزینه‌هایی که تاکنون توضیح دادم، تمام requirements ها را برآورده نمی‌کنند. در واقع، من در جستجوی خود برای یک فریم‌ورک API gateway دست از کار کشیده بودم و توسعه یک API gateway مبتنی بر Spring MVC را شروع کرده بودم. اما بعد project Spring Cloud Gateway را کشف کردم (https://cloud.spring.io/spring-cloud-gateway/). این یک فریم‌ورک API gateway است که بر اساس چندین فریم‌ورک، از جمله Spring Framework 5، Spring Boot 2 و Spring Webflux، که یک فریم‌ورک وب reactive است که بخشی از Spring Framework 5 است و بر اساس Project Reactor ساخته شده است. Project Reactor یک فریم‌ورک reactive مبتنی بر NIO برای JVM است که انتزاع Mono را ارائه می‌دهد که کمی بعد در این فصل استفاده می‌شود.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0303_original/original_page.png" alt="Original Page 303">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>فصل 8</h3>
<h3>الگوهای API خارجی</h3>
<p>
   Spring Cloud Gateway یک روش ساده اما جامع برای انجام موارد زیر ارائه می‌دهد:
  </p>
<ul>
<li>
    Route کردن requests به service های backend.
   </li>
<li>
    پیاده‌سازی request handlers ها که API composition را انجام می‌دهند.
   </li>
<li>
    Handling edge functions ها مانند authentication.
   </li>
</ul>
<p>
   شکل 8.8 بخش‌های کلیدی یک API gateway را که با استفاده از این فریم‌ورک ساخته شده است، نشان می‌دهد.
  </p>
<p>
   API gateway از بسته‌های زیر تشکیل شده است:
  </p>
<ul>
<li>
    بسته ApiGatewayMain—برنامه Main را برای API gateway تعریف می‌کند.
   </li>
<li>
    یک یا چند بسته API—یک بسته API مجموعه‌ای از API endpoints را پیاده‌سازی می‌کند.
    به عنوان مثال، بسته Orders، API endpoints های مرتبط با Order را پیاده‌سازی می‌کند.
   </li>
<li>
    بسته Proxy—از کلاس‌های proxy تشکیل شده است که توسط بسته‌های API برای فراخوانی service ها استفاده می‌شود.
   </li>
</ul>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAjgAAAEsCAYAAABmY+n4AAAgAElEQVR4nOzdfZBU1Z3g+c/1d54gI1v9vT09w/T33oG74s2H23Q7nJ3zH/mO5/i35z/z4+85/PzH4/dYd3z3jXUvCgAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0304_original/original_page.png" alt="Original Page 304">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<p>
   کلاس OrderConfiguration، Spring beans های مسئول routing کردن requests های مرتبط با Order را تعریف می‌کند. یک قانون routing می‌تواند با ترکیبی از متد HTTP، headers و path مطابقت داشته باشد. orderProxyRoutes @Bean، قوانینی را تعریف می‌کند که عملیات API را به URL های service backend نگاشت می‌کنند. به عنوان مثال، paths هایی را که با /orders شروع می‌شوند، به Order Service route می‌کند.
  </p>
<p>
   orderHandlers @Bean، قوانینی را تعریف می‌کند که آنهایی را که توسط orderProxyRoutes تعریف شده‌اند، override می‌کند. این قوانین، عملیات API را به متدهای handler که معادل Spring WebFlux از متدهای controller Spring MVC هستند، نگاشت می‌کنند. به عنوان مثال، orderHandlers عملیات GET /orders/{orderId} را به متد OrderHandlers::getOrderDetails() نگاشت می‌کند.
  </p>
<p>
   کلاس OrderHandlers، متدهای مختلف request handler را پیاده‌سازی می‌کند، مانند OrderHandlers::getOrderDetails(). این متد از API composition برای دریافت جزئیات order (که قبلاً توضیح داده شد) استفاده می‌کند. متدهای handle، service های backend را با استفاده از کلاس‌های remote proxy، مانند OrderService فراخوانی می‌کنند. این کلاس، متدهایی را برای فراخوانی OrderService تعریف می‌کند.
  </p>
<p>
   بیایید به کد نگاهی بیندازیم، با کلاس OrderConfiguration شروع می‌کنیم.
  </p>
<p>
<strong>THE ORDERCONFIGURATION CLASS</strong>
</p>
<p>
   کلاس OrderConfiguration، که در listing 8.2 نشان داده شده است، یک کلاس @Configuration Spring است.
   این، Spring @Beans هایی را تعریف می‌کند که /orders endpoints را پیاده‌سازی می‌کنند. orderProxyRouting و orderHandlerRouting @Beans از Spring WebFlux routing DSL برای تعریف request routing استفاده می‌کنند. orderHandlers @Bean، request handlers هایی را پیاده‌سازی می‌کند که API composition را انجام می‌دهند.
  </p>
<pre><code class="language-java">@Configuration
@EnableConfigurationProperties(OrderDestinations.class)
public class OrderConfiguration {
@Bean
public RouteLocator orderProxyRouting(OrderDestinations orderDestinations) {
return Routes.locator()
.route("orders")
.uri(orderDestinations.orderServiceUrl)
.predicate(path("/orders").or(path("/orders/*")))
  
.and()
...
.build();
}
@Bean
public RouterFunction&lt;ServerResponse&gt;
orderHandlerRouting(OrderHandlers orderHandlers) {
return RouterFunctions.route(GET("/orders/{orderId}"),
  
orderHandlers::getOrderDetails);
}</code></pre>
<p>
<strong>Listing 8.2</strong>
   The Spring @Beans that implement the /orders endpoints
  </p>
<p>
   By default, route all requests whose
   path begins with /orders to the URL
   orderDestinations.orderServiceUrl.
   Route a GET
   /orders/{orderId}
   to orderHandlers::
   getOrderDetails.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0305_original/original_page.png" alt="Original Page 305">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>فصل 8</h3>
<h3>الگوهای API خارجی</h3>
<pre><code class="language-java">@Bean
public OrderHandlers orderHandlers(OrderService orderService,
KitchenService kitchenService,
DeliveryService deliveryService,
AccountingService accountingService) {
return new OrderHandlers(orderService, kitchenService,
      
deliveryService, accountingService);
}</code></pre>
<p>
   OrderDestinations، که در فهرست زیر نشان داده شده است، یک کلاس @Configuration-Properties Spring است که پیکربندی externalized URL های service backend را فعال می‌کند.
  </p>
<pre><code class="language-java">@ConfigurationProperties(prefix = "order.destinations")
public class OrderDestinations {
@NotNull
public String orderServiceUrl;
public String getOrderServiceUrl() {
return orderServiceUrl;
}
public void setOrderServiceUrl(String orderServiceUrl) {
this.orderServiceUrl = orderServiceUrl;
}
...
}</code></pre>
<p>
   به عنوان مثال، می‌توانید URL Order Service را به عنوان property order.destinations.orderServiceUrl در یک فایل properties یا به عنوان یک متغیر محیطی operating system، ORDER_DESTINATIONS_ORDER_SERVICE_URL مشخص کنید.
  </p>
<p>
<strong>THE ORDERHANDLERS CLASS</strong>
</p>
<p>
   کلاس OrderHandlers، که در فهرست زیر نشان داده شده است، متدهای request handler را تعریف می‌کند که رفتار سفارشی را پیاده‌سازی می‌کنند، از جمله API composition. متد getOrderDetails()، به عنوان مثال، API composition را برای بازیابی اطلاعات در مورد یک order انجام می‌دهد. این کلاس، با چندین کلاس proxy تزریق می‌شود که requests را به service های backend انجام می‌دهند.
  </p>
<pre><code class="language-java">public class OrderHandlers {
private OrderService orderService;
private KitchenService kitchenService;
private DeliveryService deliveryService;
private AccountingService accountingService;</code></pre>
<p>
<strong>Listing 8.3</strong>
   The externalized configuration of backend service URLs
  </p>
<p>
<strong>Listing 8.4</strong>
   The OrderHandlers class implements custom request-handling logic.
   The @Bean, which implements the
   custom request-handling logic
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0306_original/original_page.png" alt="Original Page 306">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<pre><code class="language-java">public OrderHandlers(OrderService orderService,
KitchenService kitchenService,
DeliveryService deliveryService,
AccountingService accountingService) {
this.orderService = orderService;
this.kitchenService = kitchenService;
this.deliveryService = deliveryService;
this.accountingService = accountingService;
}
public Mono&lt;ServerResponse&gt; getOrderDetails(ServerRequest serverRequest) {
String orderId = serverRequest.pathVariable("orderId");
Mono&lt;OrderInfo&gt; orderInfo = orderService.findOrderById(orderId);
Mono&lt;Optional&lt;TicketInfo&gt;&gt; ticketInfo =
kitchenService
.findTicketByOrderId(orderId)
.map(Optional::of)
      
.onErrorReturn(Optional.empty());
  
Mono&lt;Optional&lt;DeliveryInfo&gt;&gt; deliveryInfo =
deliveryService
.findDeliveryByOrderId(orderId)
.map(Optional::of)
.onErrorReturn(Optional.empty());
Mono&lt;Optional&lt;BillInfo&gt;&gt; billInfo = accountingService
.findBillByOrderId(orderId)
.map(Optional::of)
.onErrorReturn(Optional.empty());
Mono&lt;Tuple4&lt;OrderInfo, Optional&lt;TicketInfo&gt;,
  
Optional&lt;DeliveryInfo&gt;, Optional&lt;BillInfo&gt;&gt;&gt; combined =
Mono.when(orderInfo, ticketInfo, deliveryInfo, billInfo);
Mono&lt;OrderDetails&gt; orderDetails =
               
combined.map(OrderDetails::makeOrderDetails);
return orderDetails.flatMap(person -&gt; ServerResponse.ok()   
.contentType(MediaType.APPLICATION_JSON)
.body(fromObject(person)));
}
}</code></pre>
<p>
   متد getOrderDetails()، API composition را برای دریافت جزئیات order پیاده‌سازی می‌کند. این، با سبک reactive و مقیاس‌پذیر با استفاده از Mono abstraction نوشته شده است که توسط Project Reactor ارائه می‌شود. یک Mono، که نوع غنی‌تری از Java 8 CompletableFuture است، حاوی نتیجه یک operation asynchronous است که یا یک value یا یک exception است. این یک API غنی برای transform و ترکیب values برگردانده شده توسط عملیات asynchronous دارد. می‌توانید از Monos ها برای نوشتن کد concurrent به سبکی استفاده کنید که ...
  </p>
<p>
   Transform a TicketInfo into
   an Optional&lt;TicketInfo&gt;.
  </p>
<p>
   If the service invocation failed,
   return Optional.empty().
  </p>
<p>
   Combine the four
   values into a single
   value, a Tuple4.
  </p>
<p>
   Transform the Tuple4
   into an OrderDetails.
  </p>
<p>
   Transform the
   OrderDetails into
   a ServerResponse.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0307_original/original_page.png" alt="Original Page 307">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>فصل 8</h3>
<h3>الگوهای API خارجی</h3>
<p>
   ساده و آسان برای درک است. در این مثال، متد getOrderDetails()، چهار service را به صورت موازی فراخوانی می‌کند و نتایج را برای ایجاد یک object از نوع OrderDetails ترکیب می‌کند.
  </p>
<p>
   متد getOrderDetails() یک ServerRequest را که نشان‌دهنده Spring WebFlux از یک request HTTP است، به عنوان پارامتر می‌گیرد و موارد زیر را انجام می‌دهد:
  </p>
<ol>
<li>
    orderId را از path استخراج می‌کند.
   </li>
<li>
    چهار service را به صورت asynchronous از طریق proxy هایشان که Monos را برمی‌گردانند، فراخوانی می‌کند.
    به منظور بهبود availability، getOrderDetails() با نتایج تمام service ها به جز OrderService به عنوان optional رفتار می‌کند. اگر یک Mono که توسط یک service optional برگردانده می‌شود، شامل یک exception باشد، فراخوانی onErrorReturn() آن را به یک Mono شامل یک Optional خالی تبدیل می‌کند.
   </li>
<li>
    نتایج را به صورت asynchronous با استفاده از Mono.when() ترکیب می‌کند که یک Mono&lt;Tuple4&gt; حاوی چهار value را برمی‌گرداند.
   </li>
<li>
    با فراخوانی OrderDetails::makeOrderDetails، Mono&lt;Tuple4&gt; را به یک Mono&lt;OrderDetails&gt; تبدیل می‌کند.
   </li>
<li>
    OrderDetails را به یک ServerResponse، که نشان‌دهنده Spring WebFlux از پاسخ JSON/HTTP است، تبدیل می‌کند.
   </li>
</ol>
<p>
   همانطور که می‌بینید، از آنجایی که getOrderDetails() از Monos استفاده می‌کند، service ها را به طور همزمان فراخوانی می‌کند و نتایج را بدون استفاده از callback های نامرتب و دشوار برای خواندن، ترکیب می‌کند. بیایید نگاهی به یکی از service proxies هایی بیندازیم که نتایج یک call service API را که در یک Mono wrapped شده است، برمی‌گرداند.
  </p>
<p>
<strong>THE ORDERSERVICE CLASS</strong>
</p>
<p>
   کلاس OrderService، که در فهرست زیر نشان داده شده است، یک proxy remote برای Order Service است. این، Order Service را با استفاده از WebClient، که client HTTP reactive Spring WebFlux است، فراخوانی می‌کند.
  </p>
<pre><code class="language-java">@Service
public class OrderService {
private OrderDestinations orderDestinations;
private WebClient client;
public OrderService(OrderDestinations orderDestinations, WebClient client)
{
this.orderDestinations = orderDestinations;
this.client = client;
}
public Mono&lt;OrderInfo&gt; findOrderById(String orderId) {
Mono&lt;ClientResponse&gt; response = client
.get()</code></pre>
<p>
<strong>Listing 8.5</strong>
   OrderService class—a remote proxy for Order Service
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0308_original/original_page.png" alt="Original Page 308">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<pre><code class="language-java">.uri(orderDestinations.orderServiceUrl + "/orders/{orderId}",
orderId)
.exchange();
    
return response.flatMap(resp -&gt; resp.bodyToMono(OrderInfo.class));</code></pre>
<p>
   متد findOrder()، OrderInfo را برای یک order بازیابی می‌کند. این از WebClient برای ایجاد request HTTP به Order Service استفاده می‌کند و پاسخ JSON را به یک OrderInfo deserializes می‌کند. WebClient دارای یک API reactive است و response در یک Mono wrapped شده است.
   متد findOrder() از flatMap() برای transform کردن Mono&lt;ClientResponse&gt; به یک Mono&lt;OrderInfo&gt; استفاده می‌کند. همانطور که از نامش پیداست، متد bodyToMono()، بدنه پاسخ را به عنوان یک Mono برمی‌گرداند.
  </p>
<p>
<strong>THE APIGATEWAYAPPLICATION CLASS</strong>
</p>
<p>
   کلاس ApiGatewayApplication، که در فهرست زیر نشان داده شده است، متد main() API gateway را پیاده‌سازی می‌کند. این یک کلاس اصلی Spring Boot استاندارد است.
  </p>
<pre><code class="language-java">@SpringBootConfiguration
@EnableAutoConfiguration
@EnableGateway
@Import(OrdersConfiguration.class)
public class ApiGatewayApplication {
public static void main(String[] args) {
SpringApplication.run(ApiGatewayApplication.class, args);
}
}</code></pre>
<p>
   annotation @EnableGateway، پیکربندی Spring را برای فریم‌ورک Spring Cloud Gateway وارد می‌کند.
  </p>
<p>
   Spring Cloud Gateway یک فریم‌ورک عالی برای پیاده‌سازی یک API gateway است.
   این شما را قادر می‌سازد تا proxy کردن پایه را با استفاده از یک DSL ساده و مختصر از قوانین routing پیکربندی کنید.
   همچنین route کردن requests به متدهای handler که API composition و protocol translation را انجام می‌دهند، ساده است. Spring Cloud Gateway با استفاده از فریم‌ورک‌های مقیاس‌پذیر و reactive Spring Framework 5 و Project Reactor ساخته شده است. اما یک گزینه جذاب دیگر برای توسعه API gateway خودتان وجود دارد: GraphQL، یک فریم‌ورک که زبان query مبتنی بر graph را ارائه می‌دهد. بیایید ببینیم که چگونه کار می‌کند.
  </p>
<h4>8.3.3</h4>
<h3>پیاده‌سازی یک API gateway با استفاده از GraphQL</h3>
<p>
   تصور کنید که شما مسئول پیاده‌سازی API Gateway's GET FTGO /orders/{orderId} endpoint هستید، که جزئیات order را برمی‌گرداند. در ظاهر، پیاده‌سازی این endpoint ممکن است ساده به نظر برسد. اما همانطور که در بخش 8.1 توضیح داده شد، این endpoint داده‌ها را از چندین service بازیابی می‌کند. در نتیجه، شما باید از ... استفاده کنید.
  </p>
<p>
<strong>Listing 8.6</strong>
   The main() method for the API gateway
  </p>
<p>
   Invoke the
   service.
  </p>
<p>
   Convert the response
   body to an OrderInfo.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0309_original/original_page.png" alt="Original Page 309">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>فصل 8</h3>
<h3>الگوهای API خارجی</h3>
<p>
   API composition pattern و نوشتن کدی که service ها را فراخوانی می‌کند و نتایج را ترکیب می‌کند.
  </p>
<p>
   چالش دیگر، که قبلاً ذکر شد، این است که client های مختلف به داده‌های کمی متفاوت نیاز دارند. به عنوان مثال، برخلاف application موبایل، application SPA دسکتاپ، rating شما را برای order نمایش می‌دهد. یک راه برای تنظیم داده‌های بازگردانده شده توسط endpoint، همانطور که در فصل 3 توضیح داده شد، این است که به client این امکان را بدهید تا داده‌های مورد نیاز خود را مشخص کند. یک endpoint می‌تواند، به عنوان مثال، از query parameters هایی مانند پارامتر expand که منابع مرتبط برای بازگرداندن را مشخص می‌کند و پارامتر field که fields های هر resource را برای بازگرداندن مشخص می‌کند، پشتیبانی کند. گزینه دیگر این است که چندین version از این endpoint را به عنوان بخشی از اعمال الگوی Backends for frontends تعریف کنید. این کار زیادی برای فقط یکی از بسیاری از API endpoints ها است که API Gateway FTGO باید پیاده‌سازی کند.
  </p>
<p>
   پیاده‌سازی یک API gateway با یک API REST که از مجموعه متنوعی از client ها به خوبی پشتیبانی می‌کند، زمان‌بر است. در نتیجه، ممکن است بخواهید استفاده از یک فریم‌ورک API مبتنی بر graph، مانند GraphQL را که برای پشتیبانی از data fetching کارآمد طراحی شده است، در نظر بگیرید. ایده اصلی فریم‌ورک‌های API مبتنی بر graph این است که، همانطور که شکل 8.9 نشان می‌دهد، API server از یک schema مبتنی بر graph تشکیل شده است. schema مبتنی بر graph، مجموعه‌ای از nodes (types) را تعریف می‌کند که دارای properties (fields) و روابط با سایر nodes هستند.
   client داده‌ها را با اجرای یک query که داده‌های مورد نیاز را بر حسب nodes و properties و روابط آن‌ها مشخص می‌کند، بازیابی می‌کند. در نتیجه، یک client می‌تواند داده‌های مورد نیاز خود را در یک round-trip واحد به API gateway بازیابی کند.
  </p>
<p>
   technology API مبتنی بر graph، چند مزیت مهم دارد. این، کنترل را بر روی داده‌های بازگردانده شده به client ها می‌دهد. در نتیجه، توسعه یک API واحد که انعطاف‌پذیر است ...
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAhwAAAEsCAYAAACs9jQpAAAgAElEQVR4nO3dfZAU1Z3g+M99d54B0+yR1nK07XW02uBvO8Xz091z6t2j8yWz3jYh2QjC2iM2U2iIioKkQEEFFxX6vJ0y92sPj8rS249nZ73s+7uS6mJm+jK5x/v5zF6f3a2F99/eOzz7+d4c/A0BAoAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
				&lt;/div&gt;
			

        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0310_original/original_page.png" alt="Original Page 310">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<p>
   به اندازه‌ای انعطاف‌پذیر است که از client های متنوع پشتیبانی کند، امکان‌پذیر می‌شود. مزیت دیگر این است که حتی اگر API بسیار انعطاف‌پذیرتر باشد، این رویکرد تلاش‌های توسعه را به میزان قابل توجهی کاهش می‌دهد. به این دلیل که شما کد سمت server را با استفاده از یک فریم‌ورک اجرای query می‌نویسید که برای پشتیبانی از API composition و projections طراحی شده است. به این صورت است که به جای اینکه client ها را مجبور کنید داده‌ها را از طریق stored procedures که شما باید بنویسید و نگهداری کنید، بازیابی کنند، به آنها اجازه می‌دهید تا queries را در برابر database زیربنایی اجرا کنند.
  </p>
<p>
   این بخش در مورد نحوه توسعه یک API gateway با استفاده از Apollo GraphQL صحبت می‌کند. من فقط به چند مورد از ویژگی‌های کلیدی GraphQL و Apollo GraphQL خواهم پرداخت. برای اطلاعات بیشتر، باید با مستندات GraphQL و Apollo GraphQL مشورت کنید.
  </p>
<p>
   API gateway مبتنی بر GraphQL، که در شکل 8.10 نشان داده شده است، با استفاده از فریم‌ورک وب NodeJS Express و سرور Apollo GraphQL با JavaScript نوشته شده است. بخش‌های کلیدی طراحی به شرح زیر است:
  </p>
<ul>
<li>
    GraphQL schema—GraphQL schema مدل داده سمت server و queries هایی را که پشتیبانی می‌کند، تعریف می‌کند.
   </li>
<li>
    Resolver functions—resolve functions عناصر schema را به service های backend مختلف نگاشت می‌کند.
   </li>
<li>
    Proxy classes—proxy classes، service های application FTGO را فراخوانی می‌کنند.
   </li>
</ul>
<p>
   همچنین مقدار کمی کد glue وجود دارد که سرور GraphQL را با فریم‌ورک وب Express ادغام می‌کند. بیایید به هر بخش نگاهی بیندازیم، با GraphQL schema شروع می‌کنیم.
  </p>
<p>
<strong>Schema-driven API technologies</strong>
</p>
<p>
   دو فناوری API مبتنی بر graph محبوب عبارتند از GraphQL (http://graphql.org) و Netflix Falcor (http://netflix.github.io/falcor/). Netflix Falcor، داده‌های سمت server را به عنوان یک graph object مجازی JSON مدل می‌کند. client Falcor، داده‌ها را از یک server Falcor با اجرای یک query که properties آن object JSON را بازیابی می‌کند، بازیابی می‌کند. client همچنین می‌تواند properties را به‌روزرسانی کند. در server Falcor، properties های graph object به منابع داده backend، مانند service ها با REST APIs نگاشت می‌شوند. سرور، یک request برای تنظیم یا دریافت properties را با فراخوانی یک یا چند منبع داده backend مدیریت می‌کند.
  </p>
<p>
   GraphQL که توسط فیسبوک توسعه داده شده و در سال 2015 منتشر شد، یک فناوری API مبتنی بر graph محبوب دیگر است. داده‌های سمت server را به عنوان یک graph از objects که دارای fields و references به objects دیگر هستند، مدل می‌کند. object graph به منابع داده backend نگاشت می‌شود. client های GraphQL می‌توانند queries هایی را اجرا کنند که داده‌ها را بازیابی می‌کنند و mutations ها را ایجاد و به‌روزرسانی می‌کنند. برخلاف Netflix Falcor، که یک پیاده‌سازی است، GraphQL یک استاندارد است که client ها و servers ها برای انواع زبان‌ها، از جمله NodeJS، Java و Scala در دسترس هستند.
  </p>
<p>
   Apollo GraphQL یک پیاده‌سازی محبوب JavaScript/NodeJS است (www.apollographql.com). این یک پلتفرم است که شامل یک سرور و client GraphQL است. Apollo GraphQL برخی از extensions های قدرتمند را به specification GraphQL، مانند subscriptions که داده‌های تغییر یافته را به client انتقال می‌دهد، پیاده‌سازی می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0311_original/original_page.png" alt="Original Page 311">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>فصل 8</h3>
<h3>الگوهای API خارجی</h3>
<p>
<strong>DEFINING A GRAPHQL SCHEMA</strong>
</p>
<p>
   یک GraphQL API حول یک schema متمرکز شده است که از مجموعه‌ای از types تشکیل شده است که ساختار مدل داده سمت server و عملیات، مانند queries، را که یک client می‌تواند انجام دهد، تعریف می‌کند. GraphQL، چندین نوع مختلف از types را دارد. کد مثال در این بخش فقط از دو نوع از types استفاده می‌کند: object types، که ... هستند.
  </p>
<pre><code class="language-java">type Query{
orders(consumerId:Int!): [Order]
order(orderId : int!): Order
consumer(consumerId : int!): Consumer
}
type Order {
orderId: ID,
consumerId: Int,
consumer: Consumer
restaurant: Restaurant
deliveryInfo : DeliveryInfo
...
const resolvers = {
Query:{
orders: resolveOrders,
order: resolveOrder,
...
},
Order:{
consumer: resolveOrderConsumer,
restaurant: resolveOrderRestaurant,
deliveryInfo: resolveOrderDeliveryInfo
},
...
function resolveOrder(_. {orderId}, context){
return context.orderServiceProxy.ﬁndOrder(orderI
d);
}
function resolveOrderDeliveryInfo({orderId}, args,
context) {
return context.deliveryServiceProxy.ﬁndDeliveryF
orOrder(orderId);
}</code></pre>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAhwAAAEsCAYAAACs9jQpAAAgAElEQVR4nO3dfZBU1Z3g+M99d54B0+yR1nK07XW02uBvO8Xz091z6t2j8yWz3jYh2QjC2iM2U2iIioKkQEEFFxX6vJ0y92sPj8rS249nZ73s+7uS6mJm+jK5x/v5zF6f3a2F99/eOzz7+d4c/A0BAoAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0312_original/original_page.png" alt="Original Page 312">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<p>
<strong>DEFINING A GRAPHQL SCHEMA</strong>
</p>
<p>
   GraphQL API، حول یک schema متمرکز شده است که از مجموعه‌ای از انواع تشکیل شده است که ساختار مدل داده سمت server و عملیات، مانند queries، را که یک client می‌تواند انجام دهد، تعریف می‌کند. GraphQL، چندین نوع مختلف از انواع را دارد. کد مثال در این بخش فقط از دو نوع از types استفاده می‌کند: object types که ... هستند.
  </p>
<p>
   نوع object دارای یک نام و مجموعه‌ای از fields های typed، named است. یک field می‌تواند یک scalar type، مانند یک عدد، string یا enum باشد. یک list از انواع scalar; یک reference به object type دیگر; یا مجموعه‌ای از references به object type دیگر. با وجود شباهت به یک field از یک کلاس object-oriented سنتی، یک field GraphQL از نظر مفهومی یک function است که یک value را برمی‌گرداند. می‌تواند آرگومان‌هایی داشته باشد که client GraphQL را قادر می‌سازد تا داده‌هایی را که function برمی‌گرداند، تنظیم کند.
  </p>
<p>
   GraphQL همچنین از fields برای تعریف queries پشتیبانی شده توسط schema استفاده می‌کند. شما queries های schema را با اعلان یک object type که طبق قرارداد Query نامیده می‌شود، تعریف می‌کنید. هر field از object Query، یک query نامگذاری شده است که دارای یک مجموعه اختیاری از پارامترها و یک return type است. من این روش تعریف queries را زمانی که برای اولین بار با آن مواجه شدم، کمی گیج‌کننده یافتم، اما کمک می‌کند به خاطر داشته باشید که یک field GraphQL، یک function است. زمانی که به نحوه اتصال fields به منابع داده backend نگاه می‌کنیم، حتی واضح‌تر خواهد شد.
  </p>
<p>
   فهرست زیر، بخشی از schema را برای API gateway FTGO مبتنی بر GraphQL نشان می‌دهد. این، چندین object types را تعریف می‌کند. اکثر object types با نهادهای Consumer، Order و Restaurant application FTGO مطابقت دارند. همچنین دارای یک object type از نوع Query است که queries های schema را تعریف می‌کند.
  </p>
<pre><code class="language-java">type Query {
   
orders(consumerId : Int!): [Order]
order(orderId : Int!): Order
consumer(consumerId : Int!): Consumer
}
type Consumer {
id: ID
  
firstName: String
lastName: String
orders: [Order]
     
}
type Order {
orderId: ID,
consumerId : Int,
consumer: Consumer
restaurant: Restaurant
deliveryInfo : DeliveryInfo
...
}
type Restaurant {
id: ID
name: String
...
}</code></pre>
<p>
<strong>Listing 8.7</strong>
   The GraphQL schema for the FTGO API gateway
  </p>
<p>
   Defines the queries
   that a client can
   execute
  </p>
<p>
   The unique ID
   for a Consumer
  </p>
<p>
   A consumer has
   a list of orders.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0313_original/original_page.png" alt="Original Page 313">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>فصل 8</h3>
<h3>الگوهای API خارجی</h3>
<pre><code class="language-java">type DeliveryInfo {
status : DeliveryStatus
estimatedDeliveryTime : Int
assignedCourier :String
}
enum DeliveryStatus {
PREPARING
READY_FOR_PICKUP
PICKED_UP
DELIVERED
}</code></pre>
<p>
   با وجود داشتن syntax متفاوت، object types های Consumer، Order، Restaurant و DeliveryInfo از نظر ساختاری شبیه به کلاس‌های Java مربوطه هستند. یک تفاوت، type ID است که یک شناسه منحصر به فرد را نشان می‌دهد.
  </p>
<p>
   این schema، سه query را تعریف می‌کند:
  </p>
<ul>
<li>
    orders()—Orders را برای Consumer مشخص شده برمی‌گرداند
   </li>
<li>
    order()—Order مشخص شده را برمی‌گرداند
   </li>
<li>
    consumer()—Consumer مشخص شده را برمی‌گرداند
   </li>
</ul>
<p>
   این queries ممکن است با API endpoints های REST معادل، متفاوت به نظر نرسند، اما GraphQL به client کنترل زیادی بر روی داده‌های بازگشتی می‌دهد. برای درک دلیل آن، بیایید به نحوه اجرای queries های GraphQL توسط یک client نگاهی بیندازیم.
  </p>
<p>
<strong>EXECUTING GRAPHQL QUERIES</strong>
</p>
<p>
   مزیت اصلی استفاده از GraphQL این است که زبان query آن، کنترل باورنکردنی را بر روی داده‌های بازگردانده شده به client می‌دهد. یک client، یک query را با ایجاد یک request حاوی یک query document به server اجرا می‌کند. در حالت ساده، یک query document، نام query، مقادیر argument و fields از object result را برای بازگرداندن مشخص می‌کند. در اینجا یک query ساده وجود دارد که firstName و lastName از consumer با یک ID خاص را بازیابی می‌کند:
  </p>
<pre><code class="language-java">query {
consumer(consumerId:1)
  
{
  
firstName
lastName
}
}</code></pre>
<p>
   این query آن fields های Consumer مشخص شده را برمی‌گرداند.
  </p>
<p>
   در اینجا یک query مفصل‌تر وجود دارد که یک consumer، orders های آنها و ID و نام restaurant هر order را برمی‌گرداند:
  </p>
<pre><code class="language-java">query {
consumer(consumerId:1)
{
id
firstName
lastName
Specifies the query called consumer,
which fetches a consumer
The fields of the
Consumer to return</code></pre>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0314_original/original_page.png" alt="Original Page 314">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<pre><code class="language-java">orders {
orderId
restaurant {
id
name
}
deliveryInfo {
estimatedDeliveryTime
name
}
}
}</code></pre>
<p>
   این query به server می‌گوید که بیش از fields های Consumer را برگرداند. این، orders های consumer و restaurant هر Order را بازیابی می‌کند. همانطور که می‌بینید، یک client GraphQL می‌تواند دقیقاً داده‌های مورد نیاز برای بازگشت را مشخص کند، از جمله fields های objects مرتبط انتقالی.
  </p>
<p>
   زبان query، انعطاف‌پذیرتر از چیزی است که در ابتدا به نظر می‌رسد. این به این دلیل است که یک query، یک field از object Query است و یک query document، مشخص می‌کند که server باید کدام یک از آن fields ها را برگرداند. این مثال‌های ساده، یک field واحد را بازیابی می‌کنند، اما یک query document می‌تواند چندین query را با مشخص کردن چندین field اجرا کند. برای هر field، query document، آرگومان‌های field را ارائه می‌دهد و مشخص می‌کند که به چه fields هایی از object result علاقه‌مند است. در اینجا یک query وجود دارد که دو consumer مختلف را بازیابی می‌کند:
  </p>
<pre><code class="language-java">query {
c1: consumer (consumerId:1)
{ id, firstName, lastName}
c2: consumer (consumerId:2)
{ id, firstName, lastName}
}</code></pre>
<p>
   در این query document، c1 و c2، آنچه GraphQL aliases می‌نامد، هستند. آنها برای تمایز بین دو Consumer در result استفاده می‌شوند که در غیر این صورت هر دو consumer نامیده می‌شوند. این مثال، دو object از یک type یکسان را بازیابی می‌کند، اما یک client می‌تواند چندین object از types های مختلف را بازیابی کند.
  </p>
<p>
   یک schema GraphQL، شکل داده و queries های پشتیبانی شده را تعریف می‌کند. برای مفید بودن، باید به منبع داده متصل شود. بیایید نگاهی بیندازیم که چگونه این کار را انجام دهیم.
  </p>
<p>
<strong>CONNECTING THE SCHEMA TO THE DATA</strong>
</p>
<p>
   هنگامی که سرور GraphQL، یک query را اجرا می‌کند، باید داده‌های درخواستی را از یک یا چند data stores بازیابی کند. در مورد application FTGO، سرور GraphQL باید APIs service هایی را که داده‌ها را در اختیار دارند، فراخوانی کند. شما یک schema GraphQL را با data sources با متصل کردن resolver functions به fields های object types تعریف شده توسط schema مرتبط می‌کنید. سرور GraphQL، الگوی API composition را با فراخوانی resolver functions برای بازیابی داده‌ها، ابتدا برای query top-level و سپس به صورت بازگشتی برای fields از object result یا objects پیاده‌سازی می‌کند.
  </p>
<p>
   جزئیات نحوه ارتباط resolver functions با schema به این بستگی دارد که از چه سرور GraphQL استفاده می‌کنید. Listing 8.8 نحوه تعریف resolvers را نشان می‌دهد ...
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0315_original/original_page.png" alt="Original Page 315">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>فصل 8</h3>
<h3>الگوهای API خارجی</h3>
<p>
<strong>DEFINING A GRAPHQL SCHEMA</strong>
</p>
<p>
   ...
  </p>
<p>
<strong>CONNECTING THE SCHEMA TO THE DATA</strong>
</p>
<p>
   ...
  </p>
<p>
   when using the Apollo GraphQL server. You create a doubly nested JavaScript object.
   Each top-level property corresponds to an object type, such as Query and Order. Each
   second-level property, such as Order.consumer, defines a field’s resolver function.
  </p>
<pre><code class="language-java">const resolvers = {
Query: {
orders: resolveOrders,
consumer: resolveConsumer,
order: resolveOrder
},
Order: {
consumer: resolveOrderConsumer,
  
restaurant: resolveOrderRestaurant,
deliveryInfo: resolveOrderDeliveryInfo
...
};</code></pre>
<p>
   یک resolver function دارای سه پارامتر است:
  </p>
<ul>
<li>
    Object—برای یک field query top-level، مانند resolveOrders، object یک root object است که معمولاً توسط resolver function نادیده گرفته می‌شود. در غیر این صورت، object، value بازگشتی توسط resolver برای object parent است. به عنوان مثال، resolver function برای field Order.consumer، value بازگشتی توسط function resolver Order را منتقل می‌کند.
   </li>
<li>
    Query arguments—اینها توسط query document ارائه می‌شوند.
   </li>
<li>
    Context—حالت global از اجرای query که توسط همه resolvers ها قابل دسترسی است. به عنوان مثال، برای انتقال اطلاعات کاربر و dependencies به resolvers ها استفاده می‌شود.
   </li>
</ul>
<p>
   یک resolver function ممکن است یک service واحد را فراخوانی کند یا ممکن است الگوی API composition را پیاده‌سازی کند و داده‌ها را از چندین service بازیابی کند. یک function resolver سرور Apollo GraphQL، یک Promise را برمی‌گرداند، که نسخه JavaScript از CompletableFuture جاوا است. promise شامل object (یا لیستی از objects) است که resolver function از data store بازیابی کرده است. GraphQL engine، value بازگشتی را در object result قرار می‌دهد.
  </p>
<p>
   بیایید به چند نمونه نگاهی بیندازیم. در اینجا function resolveOrders() وجود دارد که resolver برای query orders است:
  </p>
<pre><code class="language-java">function resolveOrders(_, { consumerId }, context) {
return context.orderServiceProxy.findOrders(consumerId);
}</code></pre>
<p>
   این function، OrderServiceProxy را از context دریافت می‌کند و آن را برای fetch کردن orders های یک consumer فراخوانی می‌کند. پارامتر اول خود را نادیده می‌گیرد. آرگومان consumerId که توسط query document ارائه شده است، به OrderServiceProxy.findOrders() منتقل می‌کند. متد findOrders()، orders های consumer را از OrderHistoryService بازیابی می‌کند.
  </p>
<p>
<strong>Listing 8.8</strong>
   Attaching the resolver functions to fields of the GraphQL schema
  </p>
<p>
   The resolver for
   the orders query
  </p>
<p>
   The resolver for
   the consumer field
   of an Order
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0316_original/original_page.png" alt="Original Page 316">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<p>
   در اینجا function resolveOrderRestaurant() وجود دارد، که resolver برای field Order.restaurant است که restaurant یک order را بازیابی می‌کند:
  </p>
<pre><code class="language-java">function resolveOrderRestaurant({restaurantId}, args, context) {
return context.restaurantServiceProxy.findRestaurant(restaurantId);
}</code></pre>
<p>
   پارامتر اول آن Order است. این، RestaurantServiceProxy.findRestaurant() را با restaurantId Order که توسط resolveOrders() ارائه شده بود، فراخوانی می‌کند.
  </p>
<p>
   GraphQL از یک الگوریتم بازگشتی برای اجرای resolver functions استفاده می‌کند. ابتدا، function resolver را برای query top-level که توسط Query document مشخص شده است، اجرا می‌کند.
   بعد، برای هر object که توسط query برگردانده می‌شود، fields هایی را که در Query document مشخص شده‌اند، تکرار می‌کند. اگر یک field دارای یک resolver باشد، resolver را با object و arguments از Query document فراخوانی می‌کند. سپس در object یا objects برگردانده شده توسط آن resolver تکرار می‌کند.
  </p>
<p>
   شکل 8.11 نشان می‌دهد که چگونه این الگوریتم، query ای را اجرا می‌کند که orders های یک consumer و اطلاعات delivery و restaurant هر order را بازیابی می‌کند. ابتدا، GraphQL engine، resolveConsumer() را فراخوانی می‌کند که Consumer را بازیابی می‌کند. بعد، resolveConsumerOrders() را فراخوانی می‌کند که resolver برای field Consumer.orders است که orders های consumer را برمی‌گرداند. سپس GraphQL engine، از طریق Orders تکرار می‌کند و resolvers ها را برای fields های Order.restaurant و Order.deliveryInfo فراخوانی می‌کند.
  </p>
<p>
   نتیجه اجرای resolvers ها یک object از نوع Consumer است که با داده‌های بازیابی شده از چندین service پر شده است.
  </p>
<p>
   اکنون بیایید به نحوه بهینه‌سازی اجرای resolvers با استفاده از batching و caching نگاهی بیندازیم.
  </p>
<p>
   Resolver functions
  </p>
<p>
   Schema
  </p>
<p>
   Query document
  </p>
<pre><code class="language-java">type Query{
consumer(consumerId:int!): Consumer
}
type Order {
...
restaurant: Restaurant
deliveryInfo : DeliveryInfo
...
query{
consumer(consumerId:1){
id
ﬁrstName
lastName
orders{
orderId
restaurant{
id
name
}
deliveryInfo{
estimatedDeliveryTime
name
}
}
}
}</code></pre>
<p>
   Query arguments passed to resolver
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAhwAAAEsCAYAAACs9jQpAAAgAElEQVR4nO3dfZBU1Z3g+M99d54B0+yR1nK07XW02uBvO8Xz091z6t2j8yWz3jYh2QjC2iM2U2iIioKkQEEFFxX6vJ0y92sPj8rS249nZ73s+7uS6mJm+jK5x/v5zF6f3a2F99/eOzz7+d4c/A0BAoAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0317_original/original_page.png" alt="Original Page 317">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>فصل 8</h3>
<h3>الگوهای API خارجی</h3>
<p>
<strong>OPTIMIZING LOADING USING BATCHING AND CACHING</strong>
</p>
<p>
   GraphQL می‌تواند به طور بالقوه تعداد زیادی resolver را هنگام اجرای یک query اجرا کند. از آنجا که سرور GraphQL، هر resolver را به طور مستقل اجرا می‌کند، خطر عملکرد ضعیف به دلیل round-trips های بیش از حد به service ها وجود دارد. به عنوان مثال، یک query را در نظر بگیرید که یک consumer، orders های آنها و restaurants های orders ها را بازیابی می‌کند. اگر N order وجود داشته باشد، یک پیاده‌سازی ساده، یک call به Consumer Service، یک call به Order History Service و سپس N call به Restaurant Service انجام می‌دهد.
   حتی اگر GraphQL engine معمولاً calls ها را به Restaurant Service به صورت موازی انجام دهد، خطر عملکرد ضعیف وجود دارد. خوشبختانه، می‌توانید از چند تکنیک برای بهبود عملکرد استفاده کنید.
  </p>
<p>
   یک بهینه‌سازی مهم، استفاده از ترکیبی از batching سمت server و caching است. Batching، N calls به یک service، مانند Restaurant Service، را به یک call واحد تبدیل می‌کند که یک batch از N object را بازیابی می‌کند. Caching، از نتیجه یک fetch قبلی از object یکسان برای جلوگیری از انجام یک call تکراری غیرضروری استفاده می‌کند. ترکیب batching و caching، تعداد round-trips ها را به service های backend به میزان قابل توجهی کاهش می‌دهد.
  </p>
<p>
   یک سرور GraphQL مبتنی بر NodeJS می‌تواند از ماژول DataLoader برای پیاده‌سازی batching و caching استفاده کند (https://github.com/facebook/dataloader). این، loads هایی را که در یک اجرای single از event loop رخ می‌دهند، جمع می‌کند و یک function batch loading که شما ارائه می‌کنید، فراخوانی می‌کند. همچنین برای حذف loads های تکراری، calls ها را cache می‌کند. فهرست زیر نشان می‌دهد که چگونه RestaurantServiceProxy می‌تواند از DataLoader استفاده کند. متد findRestaurant()، یک Restaurant را از طریق DataLoader بارگذاری می‌کند.
  </p>
<pre><code class="language-java">const DataLoader = require('dataloader');
class RestaurantServiceProxy {
constructor() {
this.dataLoader =
      
new DataLoader(restaurantIds =&gt;
this.batchFindRestaurants(restaurantIds));
}
findRestaurant(restaurantId) {
         
return this.dataLoader.load(restaurantId);
}
batchFindRestaurants(restaurantIds) {
     
...
}
}</code></pre>
<p>
   RestaurantServiceProxy و از این رو، DataLoader برای هر request ایجاد می‌شوند، بنابراین هیچ امکانی برای DataLoader وجود ندارد که داده‌های users های مختلف را با هم ترکیب کند.
  </p>
<p>
   اکنون بیایید نگاهی بیندازیم که چگونه GraphQL engine را با یک فریم‌ورک وب ادغام کنیم تا client ها بتوانند آن را فراخوانی کنند.
  </p>
<p>
<strong>Listing 8.9</strong>
   Using a DataLoader to optimize calls to Restaurant Service
  </p>
<p>
   Create a DataLoader, which uses
   batchFindRestaurants() as the
   batch loading functions.
  </p>
<p>
   Load the specified Restaurant
   via the DataLoader.
  </p>
<p>
   Load a batch of
   Restaurants.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0318_original/original_page.png" alt="Original Page 318">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<p>
<strong>INTEGRATING THE APOLLO GRAPHQL SERVER WITH EXPRESS</strong>
</p>
<p>
   سرور Apollo GraphQL، queries های GraphQL را اجرا می‌کند. به منظور فراخوانی آن توسط clients ها، شما باید آن را با یک فریم‌ورک وب ادغام کنید. سرور Apollo GraphQL از چندین فریم‌ورک وب، از جمله Express، یک فریم‌ورک وب محبوب NodeJS، پشتیبانی می‌کند.
  </p>
<p>
   Listing 8.10 نشان می‌دهد که چگونه از سرور Apollo GraphQL در یک application Express استفاده کنید. function کلیدی graphqlExpress است که توسط ماژول apollo-server-express ارائه شده است. این، یک request handler Express را می‌سازد که queries های GraphQL را در برابر یک schema اجرا می‌کند. این مثال، Express را برای route کردن requests به GET /graphql و POST /graphql endpoints از این request handler GraphQL پیکربندی می‌کند. همچنین یک context GraphQL حاوی proxies ها ایجاد می‌کند که آنها را برای resolvers ها در دسترس قرار می‌دهد.
  </p>
<pre><code class="language-java">const {graphqlExpress} = require("apollo-server-express");
const typeDefs = gql`
   
type Query {
orders: resolveOrders,
...
}
type Consumer {
...
const resolvers = {     
Query: {
...
}
}
const schema = makeExecutableSchema({ typeDefs, resolvers });    
const app = express();
function makeContextWithDependencies(req) {      
const orderServiceProxy = new OrderServiceProxy();
const consumerServiceProxy = new ConsumerServiceProxy();
const restaurantServiceProxy = new RestaurantServiceProxy();
...
return {orderServiceProxy, consumerServiceProxy,
restaurantServiceProxy, ...};
}
function makeGraphQLHandler() {
   
return graphqlExpress(req =&gt; {
return {schema: schema, context: makeContextWithDependencies(req)}
});
}
app.post('/graphql', bodyParser.json(), makeGraphQLHandler());
  
app.get('/graphql', makeGraphQLHandler());
app.listen(PORT);</code></pre>
<p>
<strong>Listing 8.10</strong>
   Integrating the GraphQL server with the Express web framework
  </p>
<p>
   Define the GraphQL
   schema.
  </p>
<p>
   Define the
   resolvers.
  </p>
<p>
   Combine the
   schema with the
   resolvers to create
   an executable
   schema.
  </p>
<p>
   Inject repositories into
   the context so they’re
   available to resolvers.
  </p>
<p>
   Make an express request handler
   that executes GraphQL queries
   against the executable schema.
  </p>
<p>
   Route POST /graphql and GET
   /graphql endpoints to the
   GraphQL server.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0319_original/original_page.png" alt="Original Page 319">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>فصل 8</h3>
<h3>الگوهای API خارجی</h3>
<p>
   این مثال، نگرانی‌هایی مانند security را مدیریت نمی‌کند، اما پیاده‌سازی آنها ساده خواهد بود. به عنوان مثال، API gateway می‌تواند کاربران را با استفاده از Passport، یک فریم‌ورک security NodeJS که در فصل 11 توضیح داده شده است، احراز هویت کند. function makeContextWithDependencies() اطلاعات کاربر را به constructor هر repository منتقل می‌کند تا بتوانند اطلاعات کاربر را به service ها انتقال دهند.
  </p>
<p>
   اکنون بیایید نگاهی بیندازیم که چگونه یک client می‌تواند این server را برای اجرای queries های GraphQL فراخوانی کند.
  </p>
<p>
<strong>WRITING A GRAPHQL CLIENT</strong>
</p>
<p>
   چند راه مختلف وجود دارد که یک application client می‌تواند server GraphQL را فراخوانی کند. از آنجا که سرور GraphQL دارای یک API مبتنی بر HTTP است، یک application client می‌تواند از یک کتابخانه HTTP برای ایجاد requests استفاده کند، مانند GET http://localhost:3000/graphql?query={orders(consumerId:1){orderId,restaurant{id}}}'. با این حال، استفاده از یک کتابخانه client GraphQL، که مراقب فرمت‌بندی مناسب requests است و معمولاً ویژگی‌هایی مانند caching سمت client را ارائه می‌دهد، آسان‌تر است.
  </p>
<p>
   فهرست زیر، کلاس FtgoGraphQLClient را نشان می‌دهد، که یک client ساده مبتنی بر GraphQL برای application FTGO است. constructor آن، ApolloClient را نمونه‌سازی می‌کند که توسط کتابخانه client Apollo GraphQL ارائه می‌شود. کلاس FtgoGraphQLClient یک متد findConsumer() را تعریف می‌کند که از client برای بازیابی نام یک consumer استفاده می‌کند.
  </p>
<pre><code class="language-java">class FtgoGraphQLClient {
constructor(...) {
this.client = new ApolloClient({ ... });
}
findConsumer(consumerId) {
return this.client.query({
variables: { cid: consumerId},
  
query: gql
query foo($cid : Int!) {
  
consumer(consumerId: $cid)
{
  
id
firstName
lastName
}
} ,
})
}
}</code></pre>
<p>
   کلاس FtgoGraphQLClient می‌تواند انواع مختلفی از متدهای query، مانند findConsumer() را تعریف کند. هر کدام، یک query را اجرا می‌کند که دقیقاً داده‌های مورد نیاز client را بازیابی می‌کند.
  </p>
<p>
<strong>Listing 8.11</strong>
   Using the Apollo GraphQL client to execute queries
  </p>
<p>
   Supply the value
   of the $cid.
  </p>
<p>
   Define $cid as a
   variable of type Int.
  </p>
<p>
   Set the value of
   query parameter
   consumerid to $cid.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0320_original/original_page.png" alt="Original Page 320">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>الگوی API Gateway</h3>
<p>
<strong>Summary</strong>
</p>
<p>
   این بخش به سختی توانایی‌های GraphQL را شرح داده است. امیدوارم نشان داده باشم که GraphQL یک جایگزین بسیار جذاب برای یک API gateway سنتی و مبتنی بر REST است. این به شما امکان می‌دهد یک API را پیاده‌سازی کنید که به اندازه‌ای انعطاف‌پذیر باشد که از مجموعه متنوعی از client ها پشتیبانی کند. در نتیجه، باید استفاده از GraphQL را برای پیاده‌سازی API gateway خود در نظر بگیرید.
  </p>
<p>
<strong>Summary</strong>
</p>
<ul>
<li>
    clients های خارجی application شما معمولاً از service های application از طریق یک API gateway دسترسی پیدا می‌کنند. یک API gateway به هر client یک API سفارشی ارائه می‌دهد. مسئول request routing، API composition، protocol translation و پیاده‌سازی edge functions ها مانند authentication است.
   </li>
<li>
    application شما می‌تواند یک API gateway واحد داشته باشد یا از الگوی Backends for frontends استفاده کند، که یک API gateway را برای هر نوع client تعریف می‌کند. مزیت اصلی الگوی Backends for frontends این است که به تیم‌های client استقلال بیشتری می‌دهد، زیرا آنها API gateway خود را توسعه، deploy و operate می‌کنند.
   </li>
<li>
    فناوری‌های متعددی وجود دارد که می‌توانید از آنها برای پیاده‌سازی یک API gateway، از جمله products API gateway آماده، استفاده کنید. یا می‌توانید با استفاده از یک فریم‌ورک، API gateway خود را توسعه دهید.
   </li>
<li>
    Spring Cloud Gateway یک فریم‌ورک خوب و آسان برای استفاده برای توسعه یک API gateway است. requests را با استفاده از هر request attribute، از جمله متد و path، route می‌کند. Spring Cloud Gateway می‌تواند یک request را مستقیماً به یک service backend یا به یک متد handler سفارشی route کند. این با استفاده از فریم‌ورک‌های مقیاس‌پذیر و reactive Spring Framework 5 و Project Reactor ساخته شده است. شما می‌توانید request handlers های سفارشی خود را با سبک reactive با استفاده از، به عنوان مثال، انتزاع Mono از Project Reactor، بنویسید.
   </li>
<li>
    GraphQL، یک فریم‌ورک که زبان query مبتنی بر graph را ارائه می‌دهد، یک پایه عالی دیگر برای توسعه یک API Gateway است. شما یک schema oriented graph را برای توصیف مدل داده سمت server و queries های پشتیبانی شده آن می‌نویسید. سپس با نوشتن resolvers ها که داده‌ها را بازیابی می‌کنند، آن schema را به service های خود نگاشت می‌کنید. client های مبتنی بر GraphQL، queries هایی را در برابر schema اجرا می‌کنند که دقیقاً داده‌هایی را که server باید برگرداند، مشخص می‌کنند. در نتیجه، یک API gateway مبتنی بر GraphQL می‌تواند از client های متنوع پشتیبانی کند.
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0321_original/original_page.png" alt="Original Page 321">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   FTGO، مانند بسیاری از سازمان‌ها، یک رویکرد سنتی را برای testing اتخاذ کرده بود. Testing، در درجه اول فعالیتی است که پس از توسعه رخ می‌دهد. developers های FTGO، کد خود را به تیم QA می‌اندازند، که تأیید می‌کنند نرم‌افزار همانطور که انتظار می‌رود، کار می‌کند. علاوه بر این، بیشتر testing آنها به صورت دستی انجام می‌شود. متأسفانه، این رویکرد برای testing به دو دلیل شکست می‌خورد:
  </p>
<ul>
<li>
    Manual testing فوق‌العاده ناکارآمد است—شما هرگز نباید از یک انسان بخواهید کاری را انجام دهد که یک ماشین می‌تواند بهتر انجام دهد. انسان‌ها در مقایسه با ماشین‌ها کند هستند و نمی‌توانند 24/7 کار کنند. اگر به manual testing متکی باشید، نمی‌توانید نرم‌افزار را سریع و ایمن ارائه دهید. ضروری است که شما automated tests بنویسید.
   </li>
<li>
    Testing، خیلی دیر در فرآیند delivery انجام می‌شود—مطمئناً نقشی برای تست هایی وجود دارد که یک application را پس از نوشته شدن آن نقد می‌کنند، اما تجربه نشان داده است که این تست ها کافی نیستند. یک رویکرد بسیار بهتر این است که developers ...
   </li>
</ul>
<p>
   This chapter covers
  </p>
<ul>
<li>
    Effective testing strategies for microservices
   </li>
<li>
    Using mocks and stubs to test a software
    element in isolation
   </li>
<li>
    Using the test pyramid to determine where to
    focus testing efforts
   </li>
<li>
    Unit testing the classes inside a service
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0322_original/original_page.png" alt="Original Page 322">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
   write automated tests به عنوان بخشی از توسعه. این امر، بهره‌وری آنها را بهبود می‌بخشد، زیرا، به عنوان مثال، آنها تست هایی خواهند داشت که بازخورد فوری را در هنگام ویرایش کد ارائه می‌دهند.
  </p>
<p>
   از این نظر، FTGO یک سازمان کاملاً معمولی است. گزارش Sauce Labs Testing Trends در سال 2018 یک تصویر کاملاً تیره از وضعیت test automation را ترسیم می‌کند (https://saucelabs.com/resources/white-papers/testing-trends-for-2018). این گزارش نحوه خودکار بودن تنها 26٪ از سازمان‌ها را عمدتاً توضیح می‌دهد و 3٪ ناچیز کاملاً خودکار هستند!
  </p>
<p>
   اتکا به manual testing به دلیل کمبود tooling و frameworks نیست.
   به عنوان مثال، JUnit، یک فریم‌ورک testing محبوب جاوا، اولین بار در سال 1998 منتشر شد.
   دلیل عدم وجود automated tests، عمدتاً فرهنگی است: "Testing، کار QA است"، "این بهترین استفاده از زمان یک developers نیست" و غیره. همچنین کمک نمی‌کند که توسعه یک مجموعه تست سریع، اما مؤثر و قابل نگهداری چالش برانگیز باشد. و، یک application monolithic بزرگ و معمولی، آزمایش آن بسیار دشوار است.
  </p>
<p>
   یکی از انگیزه های کلیدی برای استفاده از معماری microservice، همانطور که در فصل 2 توضیح داده شد، بهبود testability است. با این حال، در عین حال، پیچیدگی معماری microservice، ایجاب می‌کند که شما automated tests بنویسید. علاوه بر این، برخی از جنبه‌های testing microservices چالش‌برانگیز هستند. این به این دلیل است که ما باید تأیید کنیم که service ها می‌توانند به درستی تعامل داشته باشند و در عین حال تعداد end-to-end-tests های slow، complex و unreliable را که service های زیادی را راه‌اندازی می‌کنند، به حداقل برسانیم.
  </p>
<p>
   این فصل اولین فصل از دو فصل در مورد testing است. این یک مقدمه برای testing است. فصل 10 مفاهیم testing پیشرفته‌تر را پوشش می‌دهد. این دو فصل طولانی هستند، اما با هم، ایده‌ها و تکنیک‌های testing را پوشش می‌دهند که به طور کلی برای توسعه نرم‌افزار مدرن و به ویژه برای معماری microservice ضروری هستند.
  </p>
<p>
   من این فصل را با توصیف استراتژی‌های testing مؤثر برای یک application مبتنی بر microservices شروع می‌کنم. این استراتژی‌ها شما را قادر می‌سازند تا مطمئن شوید که نرم‌افزار شما کار می‌کند، در حالی که complexity و زمان اجرا تست را به حداقل می‌رساند. پس از آن، من نحوه نوشتن یک نوع خاص از تست را برای service های شما شرح می‌دهم: unit tests. فصل 10 انواع دیگر تست ها را پوشش می‌دهد: integration، component و end-to-end.
  </p>
<p>
   بیایید با نگاهی به استراتژی‌های testing برای microservices شروع کنیم.
  </p>
<p>
   Why an introduction to testing?
  </p>
<p>
   ممکن است تعجب کنید که چرا این فصل شامل مقدمه‌ای بر مفاهیم testing اساسی است. اگر قبلاً با مفاهیمی مانند test pyramid و انواع مختلف تست ها آشنا هستید، در این فصل سرعت خواندن خود را افزایش دهید و به فصل بعدی بروید، که بر موضوعات testing مخصوص microservices تمرکز دارد. اما بر اساس تجربیات من در مشاوره و آموزش client ها در سراسر جهان، یک ضعف اساسی بسیاری از سازمان‌های توسعه نرم‌افزار، عدم وجود automated testing است. این به این دلیل است که اگر می‌خواهید نرم‌افزار را سریع و مطمئن ارائه دهید، انجام automated testing کاملاً ضروری است. این تنها راه برای داشتن یک lead time کوتاه است که مدت زمانی است که طول می‌کشد تا کد committed شده را وارد production کنید. شاید مهم‌تر از آن، automated testing ضروری است زیرا شما را مجبور می‌کند یک application testable را توسعه دهید. معرفی automating testing در یک application از قبل بزرگ و complex، معمولاً بسیار دشوار است. به عبارت دیگر، مسیر سریع به monolithic hell، ننوشتن automated tests است.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0323_original/original_page.png" alt="Original Page 323">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<h4>9.1</h4>
<h3>Testing strategies for microservice architectures</h3>
<p>
   بیایید فرض کنیم که شما یک تغییری در Order Service application FTGO ایجاد کرده‌اید. بدیهی است که گام بعدی این است که کد خود را اجرا کنید و تأیید کنید که تغییر به درستی کار می‌کند. یک گزینه این است که تغییر را به صورت دستی تست کنید. ابتدا، شما Order Service و همه dependencies آن را اجرا می‌کنید که شامل service های infrastructure مانند یک database و سایر application services ها می‌شود. سپس شما service را با فراخوانی API آن یا استفاده از UI application FTGO "test" می‌کنید. نقطه ضعف این رویکرد این است که این یک روش آهسته و دستی برای تست کد شماست.
  </p>
<p>
   یک گزینه بسیار بهتر این است که automated tests هایی داشته باشید که بتوانید در طول توسعه آنها را اجرا کنید. workflow توسعه شما باید اینگونه باشد: ویرایش کد، اجرای تست ها (در حالت ایده‌آل با یک keystroke واحد)، تکرار. تست های fast-running به سرعت به شما می‌گویند که آیا تغییرات شما در عرض چند ثانیه کار می‌کند یا خیر. اما چگونه تست های fast-running می‌نویسید؟ و آیا آنها کافی هستند یا به تست های جامع‌تری نیاز دارید؟ اینها سوالاتی هستند که در این و سایر بخش‌های این فصل به آنها پاسخ می‌دهم.
  </p>
<p>
   من این بخش را با مروری بر مفاهیم مهم automated testing شروع می‌کنم. ما به هدف testing و ساختار یک تست معمولی نگاه خواهیم کرد. انواع مختلف تست هایی را که باید بنویسید پوشش می‌دهم. من همچنین test pyramid را شرح می‌دهم که راهنمایی‌های ارزشمندی را در مورد جایی که باید تلاش‌های testing خود را متمرکز کنید، ارائه می‌دهد. پس از پوشش مفاهیم testing، من استراتژی‌هایی را برای testing microservices بحث می‌کنم. ما به چالش‌های متمایز testing application هایی که دارای معماری microservice هستند، نگاه خواهیم کرد. من تکنیک‌هایی را شرح می‌دهم که می‌توانید از آنها برای نوشتن تست های ساده‌تر و سریع‌تر، اما همچنان مؤثر برای microservices های خود استفاده کنید.
  </p>
<p>
   بیایید نگاهی به مفاهیم testing بیندازیم.
  </p>
<h4>9.1.1</h4>
<h3>Overview of testing</h3>
<p>
   در این فصل، تمرکز من بر روی automated testing است و من از اصطلاح test به عنوان shorthand برای automated test استفاده می‌کنم. ویکی پدیا یک test case، یا test را به شرح زیر تعریف می‌کند:
  </p>
<p>
   یک test case، مجموعه‌ای از test inputs، شرایط اجرا و نتایج مورد انتظار است که برای یک objective خاص، مانند اعمال یک مسیر برنامه خاص یا تأیید انطباق با یک requirement خاص، توسعه یافته است.
  </p>
<p>
   https://en.wikipedia.org/wiki/Test_case
  </p>
<p>
   به عبارت دیگر، هدف از یک تست، همانطور که شکل 9.1 نشان می‌دهد، تأیید رفتار System Under Test (SUT) است. در این تعریف، system یک اصطلاح فانتزی است که به معنای عنصر نرم‌افزاری در حال testing است. ممکن است چیزی به کوچکی یک کلاس، به بزرگی کل application، یا چیزی در این بین، مانند یک خوشه از کلاس‌ها یا یک service فردی باشد. مجموعه‌ای از تست های مرتبط، یک test suite را تشکیل می‌دهند.
  </p>
<p>
   ابتدا به مفهوم یک automated test نگاهی بیندازیم. سپس انواع مختلف تست هایی را که باید بنویسید، مورد بحث قرار می‌دهم. پس از آن، من در مورد test pyramid بحث می‌کنم که نسبت‌های نسبی انواع مختلف تست هایی را که باید بنویسید، شرح می‌دهد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0324_original/original_page.png" alt="Original Page 324">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservice architectures</h3>
<p>
<strong>WRITING AUTOMATED TESTS</strong>
</p>
<p>
   Automated tests معمولاً با استفاده از یک framework testing نوشته می‌شوند. JUnit، به عنوان مثال، یک فریم‌ورک testing محبوب جاوا است. شکل 9.2 ساختار یک automated test را نشان می‌دهد.
   هر تست توسط یک test method پیاده‌سازی می‌شود که متعلق به یک test class است.
  </p>
<p>
   یک automated test معمولاً از چهار فاز تشکیل شده است (http://xunitpatterns.com/Four%20Phase%20Test.html):
  </p>
<ol>
<li>
    Setup—Initialize کردن the test fixture، که شامل SUT و dependencies آن، به حالت اولیه مورد نظر است. به عنوان مثال، کلاس در حال تست را ایجاد کنید و آن را به حالتی که برای نشان دادن رفتار مورد نظرش لازم است، مقداردهی اولیه کنید.
   </li>
<li>
    Exercise—فراخوانی SUT—به عنوان مثال، فراخوانی یک متد در کلاس در حال تست.
   </li>
<li>
    Verify—ایجاد assertion هایی در مورد نتیجه فراخوانی و state SUT. به عنوان مثال، تأیید value بازگشتی متد و state جدید کلاس در حال تست.
   </li>
</ol>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAk4AAAD9CAYAAADxJzE0AAAgAElEQVR4nO2deZCU1ZXHP93xJgI7wZlM2cZmds10T+cI2N5Jd4b33f7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0325_original/original_page.png" alt="Original Page 325">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   4
   Teardown—Clean up the test fixture، در صورت نیاز. بسیاری از تست ها این فاز را حذف می‌کنند، اما برخی از انواع database test ها، به عنوان مثال، یک transaction را که توسط فاز setup آغاز شده است، rollback می‌کنند.
  </p>
<p>
   به منظور کاهش duplication کد و ساده‌سازی تست ها، یک test class ممکن است متدهای setup داشته باشد که قبل از یک test method اجرا می‌شوند، و متدهای teardown که بعد از آن اجرا می‌شوند. یک test suite، مجموعه‌ای از test classes ها است. تست ها توسط یک test runner اجرا می‌شوند.
  </p>
<p>
<strong>TESTING USING MOCKS AND STUBS</strong>
</p>
<p>
   یک SUT، اغلب dependencies هایی دارد. مشکل با dependencies ها این است که می‌توانند تست ها را پیچیده و کند کنند. به عنوان مثال، کلاس OrderController، OrderService را فراخوانی می‌کند که در نهایت به service های application و infrastructure services های دیگری وابسته است. تست کردن کلاس OrderController با اجرای بخش بزرگی از system، عملی نخواهد بود. ما به یک راه برای تست کردن یک SUT در isolation نیاز داریم.
  </p>
<p>
   راه حل، همانطور که شکل 9.3 نشان می‌دهد، جایگزینی dependencies SUT با test doubles است. یک test double، یک object است که رفتار dependency را شبیه‌سازی می‌کند.
   دو نوع test double وجود دارد: stubs و mocks. اصطلاحات stubs و mocks اغلب به جای یکدیگر استفاده می‌شوند، اگرچه رفتار کمی متفاوتی دارند. A stub یک test double است که مقادیری را به SUT برمی‌گرداند. A mock یک test double است که یک تست از آن برای تأیید اینکه SUT به درستی یک dependency را فراخوانی می‌کند، استفاده می‌کند. همچنین، یک mock اغلب یک stub است.
  </p>
<p>
   بعداً در این فصل، نمونه‌هایی از test doubles را در عمل خواهید دید. به عنوان مثال، بخش 9.2.5 نشان می‌دهد که چگونه کلاس OrderController را در isolation با استفاده از یک test double برای کلاس OrderService تست کنید. در آن مثال، OrderService test double با استفاده از Mockito، یک فریم‌ورک محبوب mock object برای جاوا، پیاده‌سازی می‌شود. فصل 10 نشان می‌دهد که چگونه Order Service را با استفاده از test doubles برای سایر service هایی که فراخوانی می‌کند، تست کنید. آن test doubles به پیام‌های command ارسال شده توسط Order Service پاسخ می‌دهند.
  </p>
<p>
   بیایید اکنون به انواع مختلف تست ها نگاهی بیندازیم.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAjgAAAEsCAYAAAB6X4mPAAAgAElEQVR4nO2dfZBU1ZXHP93xJgI7wZlM2cZmds10T+cI2N5Jd4b33f7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0326_original/original_page.png" alt="Original Page 326">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
<strong>TESTING STRATEGIES FOR MICROSERVICE ARCHITECTURES</strong>
</p>
<p>
<strong>THE DIFFERENT TYPES OF TESTS</strong>
</p>
<p>
   انواع مختلفی از تست ها وجود دارد. برخی از تست ها، مانند performance tests و usability tests، تأیید می‌کنند که application نیازهای quality of service خود را برآورده می‌کند. در این فصل، من بر روی automated tests تمرکز می‌کنم که جنبه‌های functional application یا service را تأیید می‌کنند. من نحوه نوشتن چهار نوع مختلف از تست ها را توضیح می‌دهم:
  </p>
<ul>
<li>
    Unit tests—یک بخش کوچک از یک service، مانند یک کلاس را تست می‌کند.
   </li>
<li>
    Integration tests—تأیید می‌کند که یک service می‌تواند با service های infrastructure مانند databases و سایر application services ها تعامل داشته باشد.
   </li>
<li>
    Component tests—Acceptance tests ها برای یک service فردی.
   </li>
<li>
    End-to-end tests—Acceptance tests ها برای کل application.
   </li>
</ul>
<p>
   آنها، در درجه اول از نظر scope با هم تفاوت دارند. در یک انتهای طیف، unit tests ها قرار دارند که رفتار کوچکترین عنصر برنامه معنی‌دار را تأیید می‌کنند. برای یک زبان object-oriented مانند جاوا، این یک کلاس است. در انتهای دیگر طیف، end-to-end tests ها قرار دارند که رفتار کل application را تأیید می‌کنند. در میانه، component tests ها قرار دارند که service های فردی را تست می‌کنند. Integration tests، همانطور که در فصل بعد خواهید دید، scope نسبتاً کوچکی دارند، اما از unit tests خالص پیچیده‌تر هستند. Scope تنها یک راه برای شناسایی تست ها است. راه دیگر، استفاده از test quadrant است.
  </p>
<p>
<strong>USING THE TEST QUADRANT TO CATEGORIZE TESTS</strong>
</p>
<p>
   یک راه خوب برای طبقه‌بندی تست ها، test quadrant Brian Marick است (www.exampler.com/old-blog/2003/08/21/#agile-testing-project-1). test quadrant، که در شکل 9.4 نشان داده شده است، تست ها را در امتداد دو بعد طبقه‌بندی می‌کند:
  </p>
<ul>
<li>
    اینکه آیا تست، business facing یا technology facing است—یک تست business-facing با استفاده از اصطلاحات یک domain expert توصیف می‌شود، در حالی که یک تست technology-facing با استفاده از اصطلاحات developers و implementation توصیف می‌شود.
   </li>
<li>
    اینکه آیا هدف از تست، پشتیبانی از programming است یا critique application—developers ها از تست هایی استفاده می‌کنند که از programming به عنوان بخشی از کار روزانه خود پشتیبانی می‌کنند. تست هایی که critique application را دارند، با هدف شناسایی مناطقی که نیاز به بهبود دارند.
   </li>
</ul>
<p>
   Compile-time unit tests
  </p>
<p>
   Testing یک بخش جدایی‌ناپذیر از توسعه است. workflow توسعه مدرن، ویرایش کد، و سپس اجرای تست ها است. علاوه بر این، اگر شما یک Test-Driven Development (TDD) practitioner هستید، یک ویژگی جدید را توسعه می‌دهید یا یک باگ را با نوشتن ابتدا یک تست ناموفق و سپس نوشتن کد برای گذراندن آن، برطرف می‌کنید. حتی اگر شما یک TDD adherent نیستید، یک راه عالی برای رفع یک باگ، نوشتن یک تست است که باگ را بازتولید می‌کند و سپس کد را می‌نویسید که آن را برطرف می‌کند.
  </p>
<p>
   تست هایی که شما به عنوان بخشی از این workflow اجرا می‌کنید، به عنوان compile-time tests شناخته می‌شوند. در یک IDE مدرن، مانند IntelliJ IDEA یا Eclipse، شما معمولاً کد خود را به عنوان یک گام جداگانه compile نمی‌کنید. در عوض، شما از یک keystroke واحد برای compile کردن کد و اجرای تست ها استفاده می‌کنید. برای اینکه در جریان کار باقی بمانید، این تست ها باید سریع اجرا شوند - در حالت ایده‌آل، بیش از چند ثانیه نباشد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0327_original/original_page.png" alt="Original Page 327">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   The test quadrant defines four different categories of tests:
  </p>
<ul>
<li>
    Q1—Support programming/technology facing: unit and integration tests
   </li>
<li>
    Q2—Support programming/business facing: component and end-to-end test
   </li>
<li>
    Q3—Critique application/business facing: usability and exploratory testing
   </li>
<li>
    Q4—Critique application/technology facing: nonfunctional acceptance tests such
    as performance tests
   </li>
</ul>
<p>
   The test quadrant isn’t the only way of organizing tests. There’s also the test pyramid,
   which provides guidance on how many tests of each type to write.
  </p>
<p>
<strong>USING THE TEST PYRAMID AS A GUIDE TO FOCUSING YOUR TESTING EFFORTS</strong>
</p>
<p>
   ما باید انواع مختلفی از تست ها را بنویسیم تا مطمئن شویم که application ما کار می‌کند. با این حال، چالش این است که زمان اجرا و complexity یک تست با scope آن افزایش می‌یابد. همچنین، هرچه scope یک تست بزرگتر و قطعات متحرک بیشتری داشته باشد، کمتر قابل اعتماد می‌شود. تست های Unreliable تقریباً به اندازه نداشتن تست بد هستند، زیرا اگر نمی‌توانید به یک تست اعتماد کنید، احتمالاً failures ها را نادیده می‌گیرید.
  </p>
<p>
   در یک انتهای طیف، unit tests ها برای کلاس‌های فردی وجود دارد. اجرای آنها سریع، نوشتن آسان و قابل اعتماد است. در انتهای دیگر طیف، end-to-end tests ها برای کل application وجود دارد. اینها تمایل دارند به دلیل complexity، slow، دشوار برای نوشتن و اغلب unreliable باشند. از آنجایی که ما بودجه نامحدودی برای توسعه و testing نداریم، می‌خواهیم روی نوشتن تست هایی تمرکز کنیم که scope کوچکی دارند بدون به خطر انداختن effectiveness تست suite.
  </p>
<p>
   The test pyramid، که در شکل 9.5 نشان داده شده است، یک راهنمای خوب است (https://martinfowler.com/bliki/TestPyramid.html). در پایه هرم، unit tests های fast، simple و reliable قرار دارند. در بالای هرم، end-to-end tests های slow، complex و brittle قرار دارند. مانند the USDA food pyramid، اگرچه مفیدتر و کمتر بحث‌برانگیز است (https://en.wikipedia.org/wiki/History_of_USDA_nutrition_guides)، the test pyramid نسبت‌های نسبی هر نوع تست را شرح می‌دهد.
  </p>
<p>
   ایده اصلی the test pyramid این است که با حرکت به سمت بالای هرم، باید تست های کمتری بنویسیم. ما باید تعداد زیادی unit tests و تعداد بسیار کمی end-to-end tests بنویسیم.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAk4AAAD9CAYAAADxJzE0AAAgAElEQVR4nO2deZBU1ZXHP93xJgI7wZlM2cZmds10T+cI2N5Jd4b33f7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0328_original/original_page.png" alt="Original Page 328">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
   As you’ll see in this chapter, I describe a strategy that emphasizes testing the pieces of
   a service. It even minimizes the number of component tests, which test an entire service.
  </p>
<p>
   It’s clear how to test individual microservices such as Consumer Service, which
   don’t depend on any other services. But what about services such as Order Service,
   that do depend on numerous other services? And how can we be confident that the
   application as a whole works? This is the key challenge of testing applications that
   have a microservice architecture. The complexity of testing has moved from the
   individual services to the interactions between them. Let’s look at how to tackle this
   problem.
  </p>
<h4>9.1.2</h4>
<h3>The challenge of testing microservices</h3>
<p>
   Interprocess communication نقش بسیار مهم‌تری در یک application مبتنی بر microservices نسبت به یک application monolithic ایفا می‌کند. یک application monolithic ممکن است با چند client و service خارجی ارتباط برقرار کند. به عنوان مثال، version monolithic از application FTGO از چند web service third-party استفاده می‌کند، مانند Stripe برای پرداخت‌ها، Twilio برای پیام‌رسانی و Amazon SES برای ایمیل، که دارای APIs های stable هستند. هر تعاملی بین ماژول‌های application از طریق APIs مبتنی بر زبان برنامه‌نویسی است. Interprocess communication، بسیار در edge application است.
  </p>
<p>
   در مقابل، interprocess communication برای معماری microservice، مرکزی است. یک application مبتنی بر microservices، یک system توزیع شده است. تیم‌ها به طور مداوم service های خود را توسعه می‌دهند و APIs های خود را توسعه می‌دهند. ضروری است که developers یک service، تست هایی را بنویسند که تأیید کند که service آنها با dependencies و clients هایش تعامل دارد.
  </p>
<p>
   همانطور که در فصل 3 توضیح داده شد، service ها با استفاده از انواع مختلف interaction styles و mechanisms IPC با یکدیگر ارتباط برقرار می‌کنند. برخی از service ها از interaction-style از نوع request/response که با استفاده از یک پروتکل synchronous، مانند REST یا gRPC پیاده‌سازی شده است، استفاده می‌کنند.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAjgAAAEsCAYAAAB463B+AAAgAElEQVR4nO2ddZBU1ZXHP93xJgI7wZlM2cZmds10T+cI2N5Jd4b33f7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0329_original/original_page.png" alt="Original Page 329">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   Other services از طریق request/asynchronous reply یا publish/subscribe با استفاده از asynchronous messaging تعامل دارند. به عنوان مثال، شکل 9.6 نشان می‌دهد که چگونه برخی از service ها در application FTGO ارتباط برقرار می‌کنند. هر فلش از یک service consumer به یک service producer اشاره دارد.
  </p>
<p>
   فلش در جهت dependency، از consumer از API به provider از API اشاره دارد. فرضیاتی که یک consumer در مورد یک API می‌سازد، به ماهیت تعامل بستگی دارد:
  </p>
<ul>
<li>
    REST client  service—API gateway، requests ها را به service ها route می‌کند و API composition را پیاده‌سازی می‌کند.
   </li>
<li>
    Domain event consumer  publisher—Order History Service، رویدادهای منتشر شده توسط Order Service را مصرف می‌کند.
   </li>
<li>
    Command message requestor  replier—Order Service، پیام‌های command را به service های مختلف ارسال می‌کند و پاسخ‌ها را مصرف می‌کند.
   </li>
</ul>
<p>
<img 4="" <="" d97w3f="" data:image="" div="" e5lqr68a12j+hn12xbnq8v9h="" png;base64,ivborw0kggoaaaansuheugaaahwaaaescayaaacs9jqpaaagaeleqvr4no2dezbcvz3h="" pvf66j6z9j0gaqeagaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa="" q9z9="" qx1p3t447c3tj3="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAlMAAABJCAYAAADkZgZRAAAgAElEQVR4nO3dfXxU5bX3/r7/f/VfA3M0aQxM/yR0z+j7X6Q+gO7u7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v了
  &lt;p&gt;
   &lt;img src=" z937u7vd3w+us6am=""/>
</p></div>
<div class="page-images">
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0330_original/original_page.png" alt="Original Page 330">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   هر تعامل بین یک جفت service، یک توافق یا contract بین دو service را نشان می‌دهد. Order History Service و Order Service، به عنوان مثال، باید در مورد ساختار message رویداد و کانالی که به آن منتشر می‌شوند، توافق داشته باشند. به طور مشابه، API gateway و service ها باید در مورد REST API endpoints ها توافق داشته باشند. و Order Service و هر service که آن را با استفاده از request/response asynchronous فراخوانی می‌کند، باید در مورد کانال command و فرمت پیام‌های command و reply توافق داشته باشند.
  </p>
<p>
   به عنوان یک developer از یک service، شما باید مطمئن باشید که service هایی که مصرف می‌کنید، دارای APIs های stable هستند. به طور مشابه، شما نمی‌خواهید تغییرات مخربی را ناخواسته در API service خود ایجاد کنید. به عنوان مثال، اگر شما روی Order Service کار می‌کنید، می‌خواهید مطمئن شوید که developers های dependencies service شما، مانند Consumer Service و Kitchen Service، APIs های خود را به روش‌هایی که با service شما سازگار نیستند، تغییر ندهند. به طور مشابه، شما باید اطمینان حاصل کنید که API Order Services را به گونه‌ای تغییر ندهید که API Gateway یا Order History Service را بشکند.
  </p>
<p>
   یک راه برای تأیید اینکه دو service می‌توانند با یکدیگر تعامل داشته باشند، اجرای هر دو service، فراخوانی یک API که ارتباط را فعال می‌کند، و تأیید اینکه نتیجه مورد انتظار را دارد، است. این مطمئناً مشکلات integration را برطرف می‌کند، اما اساساً یک end-to-end است. تست احتمالاً باید چندین dependencies های transitive دیگر از آن service ها را اجرا کند. یک تست همچنین ممکن است نیاز به فراخوانی functionality های complex، high-level مانند business logic داشته باشد، حتی اگر هدف آن، تست IPC نسبتاً low-level باشد. بهتر است از نوشتن end-to-end tests هایی مانند اینها اجتناب کنید. به نحوی، ما باید تست هایی سریع‌تر، ساده‌تر و قابل اعتمادتر بنویسیم که در حالت ایده‌آل service ها را در isolation تست کنند. راه‌حل، استفاده از چیزی است که به عنوان consumer-driven contract testing شناخته می‌شود.
  </p>
<p>
<strong>CONSUMER-DRIVEN CONTRACT TESTING</strong>
</p>
<p>
   تصور کنید که شما عضو تیمی هستید که API Gateway را توسعه می‌دهند، که در فصل 8 توضیح داده شد. API Gateway's OrderServiceProxy، چندین REST endpoints را فراخوانی می‌کند، از جمله GET /orders/{orderId} endpoint. ضروری است که ما تست هایی بنویسیم که تأیید کنند که API Gateway و Order Service در مورد یک API توافق دارند. در اصطلاحات consumer contract testing، دو service در یک رابطه consumer-provider شرکت می‌کنند. API Gateway یک consumer است و Order Service یک provider است. یک consumer contract test، یک integration test برای یک provider، مانند Order Service است، که تأیید می‌کند که API آن با انتظارات یک consumer، مانند API Gateway مطابقت دارد.
  </p>
<p>
   یک consumer contract test، بر تأیید اینکه "shape" از API یک provider، انتظارات consumer را برآورده می‌کند، متمرکز است. برای یک REST endpoint، یک contract test تأیید می‌کند که provider، یک endpoint را پیاده‌سازی می‌کند که
  </p>
<ul>
<li>
    متد و path HTTP مورد انتظار را دارد
   </li>
<li>
    headers های مورد انتظار را می‌پذیرد، در صورت وجود
   </li>
<li>
    یک بدنه request را می‌پذیرد، در صورت وجود
   </li>
<li>
    یک response را با status code، headers و body مورد انتظار برمی‌گرداند
   </li>
</ul>
<p>
   مهم است به یاد داشته باشید که contract tests ها، business logic provider را به طور کامل تست نمی‌کنند. این کار unit tests ها است. بعداً، خواهید دید که consumer contract tests ها برای یک REST API در واقع mock controller tests هستند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0331_original/original_page.png" alt="Original Page 331">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   The team that develops the consumer writes a contract test suite and adds it (for
   example, via a pull request) to the provider’s test suite. The developers of other ser-
   vices that invoke Order Service also contribute a test suite, as shown in figure 9.7.
   Each test suite will test those aspects of Order Service’s API that are relevant to each
   consumer. The test suite for Order History Service, for example, verifies that Order
   Service publishes the expected events.
  </p>
<p>
   These test suites are executed by the deployment pipeline for Order Service. If a con-
   sumer contract test fails, that failure tells the producer team that they’ve made a break-
   ing change to the API. They must either fix the API or talk to the consumer team.
  </p>
<p>
   Consumer-driven contract tests typically use testing by example. The interaction
   between a consumer and provider is defined by a set of examples, known as contracts.
   Each contract consists of example messages that are exchanged during one interaction.
  </p>
<p>
   Pattern: Consumer-driven contract test
  </p>
<p>
   Verify that a service meets the expectations of its clients See http://microser-
   vices.io/patterns/testing/service-integration-contract-test.html.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAsMAAAG9CAYAAADX3R5kAAAgAElEQVR4nO3dfXwU5bX3v+5/Z+519u0zM0iBIIkCQgQhIAiAgQAgCIjCAIggAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIg
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0332_original/original_page.png" alt="Original Page 332">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
   برای مثال، یک contract برای یک REST API، از یک مثال request و response HTTP تشکیل شده است. در ظاهر، ممکن است تعریف تعامل با استفاده از schema هایی که با استفاده از، به عنوان مثال، OpenAPI یا JSON schema نوشته شده‌اند، بهتر به نظر برسد. اما مشخص می‌شود که schema ها در نوشتن تست ها چندان مفید نیستند. یک تست می‌تواند response را با استفاده از schema تأیید کند، اما همچنان نیاز به فراخوانی provider با یک request نمونه دارد.
  </p>
<p>
   علاوه بر این، تست های consumer نیز به responses های نمونه نیاز دارند. این به این دلیل است که اگرچه تمرکز consumer-driven contract testing بر روی تست یک provider است، contract ها نیز برای تأیید اینکه consumer با contract مطابقت دارد یا خیر، استفاده می‌شوند. به عنوان مثال، یک consumer-side contract test برای یک client REST، از contract برای پیکربندی یک service HTTP stub استفاده می‌کند که تأیید می‌کند request HTTP با request contract مطابقت دارد و response HTTP contract را برمی‌گرداند. تست کردن هر دو طرف تعامل تضمین می‌کند که consumer و provider در مورد API توافق دارند. بعداً به نمونه‌هایی از نحوه نوشتن این نوع testing نگاهی خواهیم انداخت، اما ابتدا بیایید ببینیم چگونه با استفاده از Spring Cloud Contract، consumer contract tests را بنویسیم.
  </p>
<p>
<strong>TESTING SERVICES USING SPRING CLOUD CONTRACT</strong>
</p>
<p>
   دو فریم‌ورک محبوب contract testing عبارتند از Spring Cloud Contract (https://cloud.spring.io/spring-cloud-contract/)، که یک فریم‌ورک consumer contract testing برای application های Spring است، و خانواده فریم‌ورک‌های Pact (https://github.com/pact-foundation)، که از انواع زبان‌ها پشتیبانی می‌کنند. application FTGO یک application مبتنی بر فریم‌ورک Spring است، بنابراین در این فصل، من قصد دارم نحوه استفاده از Spring Cloud Contract را توضیح دهم. این، یک زبان domain-specific Groovy (DSL) را برای نوشتن contract ها ارائه می‌دهد. هر contract یک نمونه concrete از تعامل بین یک consumer و یک provider، مانند یک request و response HTTP است. کد Spring Cloud Contract، contract tests ها را برای provider ایجاد می‌کند. همچنین mocks ها، مانند یک mock HTTP server را برای consumer integration tests ها پیکربندی می‌کند.
  </p>
<p>
   بگویید، به عنوان مثال، شما روی API Gateway کار می‌کنید و می‌خواهید یک consumer contract test را برای Order Service بنویسید. شکل 9.8 این فرآیند را نشان می‌دهد که نیاز دارد شما با تیم‌های Order Service همکاری کنید. شما contract هایی را می‌نویسید که نحوه تعامل API Gateway با Order Service را تعریف می‌کنند. تیم Order Service از این contract ها برای تست کردن Order Service استفاده می‌کند، و شما از آنها برای تست کردن API Gateway استفاده می‌کنید. توالی مراحل به شرح زیر است:
  </p>
<ol>
<li>
    شما یک یا چند contract، مانند موردی که در listing 9.1 نشان داده شده است، می‌نویسید. هر contract شامل یک request HTTP است که API Gateway ممکن است به Order Service ارسال کند و یک response HTTP مورد انتظار. شما contract ها را، شاید از طریق یک request Git pull، به تیم Order Service می‌دهید.
   </li>
<li>
    تیم Order Service، Order Service را با استفاده از consumer contract tests ها تست می‌کند، که کد Spring Cloud Contract از contract ها تولید می‌کند.
   </li>
</ol>
<p>
   Pattern: Consumer-side contract test
  </p>
<p>
   Verify that the client of a service can communicate with the service. See https://
   microservices.io/patterns/testing/consumer-side-contract-test.html.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0333_original/original_page.png" alt="Original Page 333">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   3
   تیم Order Service، contract هایی را که Order Service را تست کردند، به یک Maven repository منتشر می‌کند.
  </p>
<p>
   4
   شما از contract های منتشر شده برای نوشتن تست ها برای API Gateway استفاده می‌کنید.
  </p>
<p>
   از آنجایی که شما API Gateway را با استفاده از contract های منتشر شده تست می‌کنید، می‌توانید مطمئن باشید که با Order Service deployed شده، کار می‌کند.
  </p>
<p>
   Contract ها قسمت کلیدی این استراتژی testing هستند. فهرست زیر، یک مثال Spring Cloud Contract را نشان می‌دهد. این، شامل یک request HTTP و یک response HTTP است.
  </p>
<pre><code class="language-java">org.springframework.cloud.contract.spec.Contract.make {
request {
                   
method 'GET'
url '/orders/1223232'
}
response {
       
status 200
headers {
header('Content-Type': 'application/json;charset=UTF-8')
}
body("{ ... }")
}
}</code></pre>
<p>
<strong>Listing 9.1</strong>
   A contract that describes how API Gateway invokes Order Service
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAApwAAAEsCAYAAACbT7y2AAAgAElEQVR4nO3dfXwU5bX3v+7/Z+519m7vIgiRIEAoI0oICiAgCIiCAIggAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCII
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0334_original/original_page.png" alt="Original Page 334">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
   Each team that develops a service that consumes Order Service’s API contributes
   a contract test suite. The test suite verifies that the API matches the consumer’s expectations.
   This test suite, along with those contributed by other teams, is run by Order Service’s
   deployment pipeline.
  </p>
<p>
   The request element is an HTTP request for the REST endpoint GET /orders/
   {orderId}. The response element is an HTTP response that describes an Order
   expected by API Gateway. The Groovy contracts are part of the provider’s code base.
  </p>
<p>
   هر تیم consumer، contract tests suite را می‌نویسد و آن را (به عنوان مثال، از طریق یک pull request) به test suite provider اضافه می‌کند. developers های service های دیگری که Order Service را فراخوانی می‌کنند نیز یک test suite را مشارکت می‌کنند، همانطور که در شکل 9.7 نشان داده شده است.
   هر test suite جنبه‌هایی از API Order Service را که مربوط به هر consumer هستند، تست می‌کند. به عنوان مثال، test suite برای Order History Service تأیید می‌کند که Order Service، رویدادهای مورد انتظار را منتشر می‌کند.
  </p>
<p>
   این تست suite ها توسط deployment pipeline برای Order Service اجرا می‌شوند. اگر یک consumer contract test شکست بخورد، آن failure به تیم producer می‌گوید که آنها یک breaking change در API ایجاد کرده‌اند. آنها باید یا API را برطرف کنند یا با تیم consumer صحبت کنند.
  </p>
<p>
   Consumer-driven contract tests، معمولاً از testing by example استفاده می‌کنند. تعامل بین یک consumer و provider، توسط مجموعه‌ای از مثال‌ها، که به عنوان contract شناخته می‌شوند، تعریف می‌شود. هر contract، از مثال message هایی تشکیل شده است که در طول یک تعامل مبادله می‌شوند.
  </p>
<p>
   Pattern: Consumer-side contract test
  </p>
<p>
   Verify that the client of a service can communicate with the service. See https://
   microservices.io/patterns/testing/consumer-side-contract-test.html.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAsMAAAG9CAYAAADX3R5kAAAgAElEQVR4nO3dfXxU5bX3v+5/Z+519m7vIgiRIEAoI0oICiAgCIiCAIggAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAAgCIIgAgiIgAA
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0335_original/original_page.png" alt="Original Page 335">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   یک series از مراحل است که test suites ها را اجرا می‌کنند، به دنبال آن مرحله‌ای که service را منتشر یا deploy می‌کند، می‌آید. در حالت ایده‌آل، کاملاً automated است، اما ممکن است شامل مراحل manual باشد. یک deployment pipeline اغلب با استفاده از یک Continuous Integration (CI) server، مانند Jenkins، پیاده‌سازی می‌شود.
  </p>
<p>
   همانطور که کد از طریق pipeline جریان می‌یابد، test suites آن را در محیط هایی که بیشتر شبیه production هستند، به تست کاملاً thorough تری وادار می‌کنند. در همان زمان، زمان اجرا هر test suite معمولاً افزایش می‌یابد. ایده این است که بازخورد را در مورد test failures ها تا حد امکان سریع ارائه دهید.
  </p>
<p>
   example deployment pipeline که در شکل 9.9 نشان داده شده است، از مراحل زیر تشکیل شده است:
  </p>
<ul>
<li>
    Pre-commit tests stage—unit tests ها را اجرا می‌کند. این، توسط developer قبل از commit کردن changes آنها اجرا می‌شود.
   </li>
<li>
    Commit tests stage—service را compile می‌کند، unit tests ها را اجرا می‌کند و static code analysis را انجام می‌دهد.
   </li>
<li>
    Integration tests stage—integration tests ها را اجرا می‌کند.
   </li>
<li>
    Component tests stage—component tests ها را برای service اجرا می‌کند.
   </li>
<li>
    Deploy stage—service را وارد production می‌کند.
   </li>
</ul>
<p>
   CI server، مرحله commit را زمانی اجرا می‌کند که یک developer تغییری را commit می‌کند. این، فوق‌العاده سریع اجرا می‌شود، بنابراین بازخورد سریعی در مورد commit ارائه می‌دهد. مراحل بعدی اجرایشان طولانی‌تر است و بازخورد کمتری ارائه می‌دهند. اگر تمام تست ها با موفقیت انجام شوند، مرحله نهایی زمانی است که این pipeline آن را وارد production می‌کند.
  </p>
<p>
   در این مثال، deployment pipeline به طور کامل از commit تا deployment، automated است. با این حال، موقعیت‌هایی وجود دارد که نیاز به مراحل manual دارند. به عنوان مثال، ممکن است به یک مرحله manual testing، مانند یک staging environment، نیاز داشته باشید. در چنین سناریویی، کد به مرحله بعدی پیش می‌رود، زمانی که یک tester روی یک دکمه کلیک می‌کند تا نشان دهد که موفقیت‌آمیز بوده است. یا، یک deployment pipeline برای یک on-premise
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAk4AAAD9CAYAAADkZgZRAAAgAElEQVR4nO3deXxU5bX3/r7/f/VfA3M0aQxM/yR0z+j7X6Q+gO7u7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0336_original/original_page.png" alt="Original Page 336">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   این مثال به concerns هایی مانند security نمی‌پردازد، اما پیاده‌سازی آنها ساده خواهد بود.
  </p>
<p>
   ...
  </p>
<p>
   . The team that develops the consumer writes a contract test suite and adds it (for
   example, via a pull request) to the provider’s test suite. The developers of other ser-
   vices that invoke Order Service also contribute a test suite, as shown in figure 9.7.
   Each test suite will test those aspects of Order Service’s API that are relevant to each
   consumer. The test suite for Order History Service, for example, verifies that Order
   Service publishes the expected events.
  </p>
<p>
   این تست suite ها توسط deployment pipeline برای Order Service اجرا می‌شوند. اگر یک consumer contract test شکست بخورد، آن failure به تیم producer می‌گوید که آنها یک breaking change در API ایجاد کرده‌اند. آنها باید یا API را برطرف کنند یا با تیم consumer صحبت کنند.
  </p>
<p>
<strong>9.1.3</strong>
   The deployment pipeline
  </p>
<p>
   هر service دارای یک deployment pipeline است. کتاب Jez Humble، Continuous Delivery (Addison-Wesley, 2010) یک deployment pipeline را به عنوان فرآیند خودکار دریافت کد از desktop developer به production توصیف می‌کند. همانطور که شکل 9.9 نشان می‌دهد، این شامل ...
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAApwAAAEsCAYAAACbT7y2AAAgAElEQVR4nO3dfXxU5bX3/r7/f/VfA3M0aQxM/yR0z+j7X6Q+gO7u7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0337_original/original_page.png" alt="Original Page 337">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   There are two types of unit tests (https://martinfowler.com/bliki/UnitTest.html):
  </p>
<ul>
<li>
    Solitary unit test—یک کلاس را در isolation با استفاده از mock objects برای dependencies کلاس تست می‌کند
   </li>
<li>
    Sociable unit test—یک کلاس و dependencies آن را تست می‌کند
   </li>
</ul>
<p>
   مسئولیت‌های کلاس و نقش آن در معماری، نوع تستی را که باید استفاده کنید، تعیین می‌کند. شکل 9.11 معماری Hexagonal یک service معمولی و نوع unit test را که معمولاً برای هر نوع کلاس استفاده می‌کنید، نشان می‌دهد. کلاس‌های Controller و service، اغلب با استفاده از solitary unit tests تست می‌شوند. Domain objects ها، مانند entities و value objects، معمولاً با استفاده از sociable unit tests تست می‌شوند.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAtMAAAG9CAYAAADW19v7AAAgAElEQVR4nO3deXxU5bX3/r7/f/VfA3M0aQxM/yR0z+j7X6Q+gO7u7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0338_original/original_page.png" alt="Original Page 338">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   The typical testing strategy for each class is as follows:
  </p>
<ul>
<li>
    Entities، مانند Order، که همانطور که در فصل 5 توضیح داده شد، objects هایی با persistent identity هستند، با استفاده از sociable unit tests تست می‌شوند.
   </li>
<li>
    Value objects ها، مانند Money، که همانطور که در فصل 5 توضیح داده شد، objects هایی هستند که مجموعه‌ای از values ها هستند، با استفاده از sociable unit tests تست می‌شوند.
   </li>
<li>
    Sagas ها، مانند CreateOrderSaga، که همانطور که در فصل 4 توضیح داده شد، consistency داده را در service ها حفظ می‌کنند، با استفاده از sociable unit tests تست می‌شوند.
   </li>
<li>
    Domain services ها، مانند OrderService، که همانطور که در فصل 5 توضیح داده شد، کلاس‌هایی هستند که business logic را پیاده‌سازی می‌کنند که به entities یا value objects تعلق ندارد، با استفاده از solitary unit tests تست می‌شوند.
   </li>
<li>
    Controllers ها، مانند OrderController، که requests HTTP را مدیریت می‌کنند، با استفاده از solitary unit tests تست می‌شوند.
   </li>
<li>
    Inbound و outbound messaging gateways ها با استفاده از solitary unit tests تست می‌شوند.
   </li>
</ul>
<p>
   بیایید با نگاهی به نحوه تست کردن entities شروع کنیم.
  </p>
<h4>9.2.1</h4>
<h3>Developing unit tests for entities</h3>
<p>
   فهرست زیر، قسمتی از کلاس OrderTest را نشان می‌دهد که unit tests ها را برای entity Order پیاده‌سازی می‌کند. این کلاس دارای یک متد @Before setUp() است که یک Order را قبل از اجرای هر تست ایجاد می‌کند. متدهای @Test آن ممکن است Order را بیشتر initialize کنند، یکی از متدهای آن را فراخوانی کنند و سپس در مورد value بازگشتی و state از Order assertion هایی ایجاد کنند.
  </p>
<pre><code class="language-java">public class OrderTest {
private ResultWithEvents&lt;Order&gt; createResult;
private Order order;
@Before
public void setUp() throws Exception {
createResult = Order.createOrder(CONSUMER_ID, AJANTA_ID, CHICKEN_VINDALOO
_LINE_ITEMS);
order = createResult.result;
}
@Test
public void shouldCalculateTotal() {
assertEquals(CHICKEN_VINDALOO_PRICE.multiply(CHICKEN_VINDALOO_QUANTITY),
order.getOrderTotal());
}
...
}</code></pre>
<p>
   متد @Test shouldCalculateTotal()، تأیید می‌کند که Order.getOrderTotal()، value مورد انتظار را برمی‌گرداند. Unit tests ها، business logic را به طور کامل تست می‌کنند. آنها هستند
  </p>
<p>
<strong>Listing 9.2</strong>
   A simple, fast-running unit test for the Order entity
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0339_original/original_page.png" alt="Original Page 339">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   sociable unit tests ها را برای کلاس Order و dependencies آن پیاده‌سازی کنید. شما می‌توانید از آنها به عنوان compile-time tests استفاده کنید، زیرا آنها فوق‌العاده سریع اجرا می‌شوند. کلاس Order به value object از نوع Money متکی است، بنابراین مهم است که آن کلاس را نیز تست کنید. بیایید ببینیم چگونه این کار را انجام دهیم.
  </p>
<h4>9.2.2</h4>
<h3>Writing unit tests for value objects</h3>
<p>
   Value objects ها غیرقابل تغییر هستند، بنابراین تست کردن آنها آسان است. شما لازم نیست نگران side effects ها باشید. یک تست برای یک value object، معمولاً یک value object را در یک state خاص ایجاد می‌کند، یکی از متدهای آن را فراخوانی می‌کند و در مورد value بازگشتی assertion هایی ایجاد می‌کند. Listing 9.3، تست ها را برای value object Money نشان می‌دهد، که یک کلاس ساده است که یک value پولی را نشان می‌دهد. این تست ها، رفتار متدهای کلاس Money، از جمله add()، که دو object از نوع Money را اضافه می‌کند و multiply()، که یک object از نوع Money را در یک عدد صحیح ضرب می‌کند، تأیید می‌کنند. آنها solitary tests هستند زیرا کلاس Money به هیچ کلاس application دیگری وابسته نیست.
  </p>
<pre><code class="language-java">public class MoneyTest {
private final int M1_AMOUNT = 10;
private final int M2_AMOUNT = 15;
private Money m1 = new Money(M1_AMOUNT);
private Money m2 = new Money(M2_AMOUNT);
@Test
public void shouldAdd() {
         
assertEquals(new Money(M1_AMOUNT + M2_AMOUNT), m1.add(m2));
}
@Test
public void shouldMultiply() {     
int multiplier = 12;
assertEquals(new Money(M2_AMOUNT * multiplier), m2.multiply(multiplier));
}
...
}</code></pre>
<p>
   Entities و value objects، بلوک‌های سازنده business logic یک service هستند. اما برخی از business logic ها نیز در sagas و service های service قرار دارند. بیایید ببینیم چگونه آنها را تست کنیم.
  </p>
<h4>9.2.3</h4>
<h3>Developing unit tests for sagas</h3>
<p>
   یک saga، مانند کلاس CreateOrderSaga، business logic مهمی را پیاده‌سازی می‌کند، بنابراین باید تست شود. این یک object persistent است که پیام‌های command را به شرکت‌کنندگان saga ارسال می‌کند و به پاسخ‌های آنها رسیدگی می‌کند. همانطور که در فصل 4 توضیح داده شد، CreateOrderSaga پیام‌های command/reply را با چندین service، مانند Consumer Service و Kitchen Service، مبادله می‌کند. یک تست برای این کلاس، یک saga ایجاد می‌کند و تأیید می‌کند که ...
  </p>
<p>
<strong>Listing 9.3</strong>
   A simple, fast-running test for the Money value object
  </p>
<p>
   Verify that two
   Money objects can
   be added together.
  </p>
<p>
   Verify that a Money
   object can be multiplied
   by an integer.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0340_original/original_page.png" alt="Original Page 340">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   The team that develops the consumer writes a contract test suite and adds it (for
   example, via a pull request) to the provider’s test suite. The developers of other ser-
   vices that invoke Order Service also contribute a test suite, as shown in figure 9.7.
   Each test suite will test those aspects of Order Service’s API that are relevant to each
   consumer. The test suite for Order History Service, for example, verifies that Order
   Service publishes the expected events.
  </p>
<p>
   These test suites are executed by the deployment pipeline for Order Service. If a con-
   sumer contract test fails, that failure tells the producer team that they’ve made a break-
   ing change to the API. They must either fix the API or talk to the consumer team.
  </p>
<p>
   Consumer-driven contract tests typically use testing by example. The interaction
   between a consumer and provider is defined by a set of examples, known as contracts.
   Each contract consists of example messages that are exchanged during one interaction.
  </p>
<p>
   Pattern: Consumer-driven contract test
  </p>
<p>
   Verify that a service meets the expectations of its clients See http://microser-
   vices.io/patterns/testing/service-integration-contract-test.html.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAk4AAAD9CAYAAADkZgZRAAAgAElEQVR4nO3dfZBU1ZXHP93xJgI7wZlM2cZmds10T+cI2N5Jd4b33f7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0341_original/original_page.png" alt="Original Page 341">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<pre><code class="language-java">failureReply().
            
expect().
command(new RejectOrderCommand(ORDER_ID)).
to(OrderServiceChannels.orderServiceChannel);
      
}
}</code></pre>
<p>
   متد @Test shouldCreateOrder() مسیر موفقیت‌آمیز را تست می‌کند. متد @Test shouldRejectOrderDueToConsumerVerificationFailed() سناریویی را تست می‌کند که در آن Consumer Service، order را رد می‌کند. این تأیید می‌کند که CreateOrderSaga، یک پیام RejectOrderCommand را برای جبران رد شدن consumer ارسال می‌کند. کلاس CreateOrderSagaTest متدهایی دارد که سایر سناریوهای failure را تست می‌کند.
  </p>
<p>
   بیایید اکنون به نحوه تست کردن domain services ها نگاهی بیندازیم.
  </p>
<h4>9.2.4</h4>
<h3>Developing unit tests for sagas</h3>
<p>
   اکثریت business logic یک service توسط entities، value objects و sagas پیاده‌سازی می‌شود. کلاس‌های domain service، مانند کلاس OrderService، باقیمانده را پیاده‌سازی می‌کنند. این کلاس، یک کلاس domain service معمولی است. متدهای آن، entities و repositories را فراخوانی می‌کنند و domain events را منتشر می‌کنند. یک راه مؤثر برای تست کردن این نوع کلاس، استفاده از یک unit test عمدتاً solitary است که dependencies هایی مانند repositories و classes messaging را mock می‌کند.
  </p>
<p>
   Listing 9.5 کلاس OrderServiceTest را نشان می‌دهد که OrderService را تست می‌کند. این، solitary unit tests را تعریف می‌کند که از Mockito mocks ها برای dependencies service استفاده می‌کند. هر تست، فازهای تست را به شرح زیر پیاده‌سازی می‌کند:
  </p>
<ol>
<li>
    Setup—پیکربندی mock objects ها برای dependencies service.
   </li>
<li>
    Execute—فراخوانی یک متد service.
   </li>
<li>
    Verify—تأیید اینکه value بازگشتی توسط متد service صحیح است و dependencies ها به درستی فراخوانی شده‌اند.
   </li>
</ol>
<pre><code class="language-java">public class OrderServiceTest {
private OrderService orderService;
private OrderRepository orderRepository;
private DomainEventPublisher eventPublisher;
private RestaurantRepository restaurantRepository;
private SagaManager&lt;CreateOrderSagaState&gt; createOrderSagaManager;
private SagaManager&lt;CancelOrderSagaData&gt; cancelOrderSagaManager;
private SagaManager&lt;ReviseOrderSagaData&gt; reviseOrderSagaManager;
@Before
public void setup() {
orderRepository = mock(OrderRepository.class);         
eventPublisher = mock(DomainEventPublisher.class);
restaurantRepository = mock(RestaurantRepository.class);</code></pre>
<p>
<strong>Listing 9.5</strong>
   A simple, fast-running unit test for the OrderService class
  </p>
<p>
   Send a failure
   reply indicating
   that Consumer
   Service rejected
   Order.
  </p>
<p>
   Verify that the saga sends
   a RejectOrderCommand
   message to Order Service.
  </p>
<p>
   Create Mockito
   mocks for
   OrderService’s
   dependencies.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0342_original/original_page.png" alt="Original Page 342">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<pre><code class="language-java">createOrderSagaManager = mock(SagaManager.class);
cancelOrderSagaManager = mock(SagaManager.class);
reviseOrderSagaManager = mock(SagaManager.class);
orderService = new OrderService(orderRepository, eventPublisher,  
restaurantRepository, createOrderSagaManager,
cancelOrderSagaManager, reviseOrderSagaManager);</code></pre>
</p>
<p>
   متد @Test shouldCreateOrder()، نشان می‌دهد که OrderService.createOrder()، OrderRepository را برای ذخیره Order تازه ایجاد شده، فراخوانی می‌کند، یک OrderCreatedEvent را منتشر می‌کند و یک CreateOrderSaga ایجاد می‌کند.
  </p>
<p>
   اکنون که دیدیم چگونه business logic classes ها را unit test می‌کنیم، بیایید نگاهی بیندازیم که چگونه adapters هایی را که با system های خارجی تعامل دارند، unit test کنیم.
  </p>
<h4>9.2.5</h4>
<h3>Developing unit tests for controllers</h3>
<p>
   Service ها، مانند Order Service، معمولاً دارای یک یا چند controller هستند که requests های HTTP را از service های دیگر و API gateway مدیریت می‌کنند. یک کلاس controller، از مجموعه‌ای از متدهای request handler تشکیل شده است. هر متد، یک REST API endpoint را پیاده‌سازی می‌کند. پارامترهای یک متد، مقادیری از request HTTP را نشان می‌دهند، مانند path variables. این، معمولاً یک domain service یا یک repository را فراخوانی می‌کند و یک response object را برمی‌گرداند.
  </p>
<pre><code class="language-java">   .findById(AJANTA_ID)).thenReturn(Optional.of(AJANTA_RESTAURANT_);
when(orderRepository.save(any(Order.class))).then(invocation -&gt; {  
Order order = (Order) invocation.getArguments()[0];
order.setId(ORDER_ID);
return order;
});
Order order = orderService.createOrder(CONSUMER_ID,
   
AJANTA_ID, CHICKEN_VINDALOO_MENU_ITEMS_AND_QUANTITIES);
verify(orderRepository).save(same(order));        
verify(eventPublisher).publish(Order.class, ORDER_ID,     
singletonList(
new OrderCreatedEvent(CHICKEN_VINDALOO_ORDER_DETAILS)));
verify(createOrderSagaManager)
                  
.create(new CreateOrderSagaState(ORDER_ID,
CHICKEN_VINDALOO_ORDER_DETAILS),
Order.class, ORDER_ID);</code></pre>
<p>
   Create an OrderService injected
   with mock dependencies.
  </p>
<p>
   Configure RestaurantRepository.findById()
   to return the Ajanta restaurant.
  </p>
<p>
   Configure OrderRepository.save()
   to set Order’s ID.
  </p>
<p>
   Invoke
   OrderService
   .create().
  </p>
<p>
   Verify that
   OrderService saved
   the newly created
   Order in the database.
  </p>
<p>
   Verify that
   OrderService
   published
   an Order-
   CreatedEvent.
  </p>
<p>
   Verify that Order-
   Service created a
   CreateOrderSaga.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0343_original/original_page.png" alt="Original Page 343">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   به عنوان مثال، OrderController، OrderService و OrderRepository را فراخوانی می‌کند. یک استراتژی testing مؤثر برای controllers، solitary unit tests است که service ها و repositories را mock می‌کند.
  </p>
<p>
   شما می‌توانید یک test class را مشابه کلاس OrderServiceTest بنویسید تا یک کلاس controller را نمونه‌سازی کنید و متدهای آن را فراخوانی کنید. اما این رویکرد، برخی از functionality های مهم، مانند request routing را تست نمی‌کند. استفاده از یک فریم‌ورک testing mock MVC، مانند Spring Mock Mvc که بخشی از Spring Framework است، یا Rest Assured Mock MVC که بر اساس Spring Mock Mvc ساخته شده است، بسیار مؤثرتر است. تست هایی که با استفاده از یکی از این فریم‌ورک‌ها نوشته شده‌اند، چیزی را که به نظر می‌رسد request های HTTP هستند، ایجاد می‌کنند و در مورد response های HTTP assertion هایی ایجاد می‌کنند. این فریم‌ورک‌ها شما را قادر می‌سازند تا request routing HTTP و تبدیل objects جاوا به و از JSON را بدون نیاز به برقراری calls های شبکه واقعی، تست کنید. Spring Mock Mvc، در زیر ساختارهای خود، به اندازه کافی از کلاس‌های Spring MVC را نمونه‌سازی می‌کند تا این امکان را فراهم کند.
  </p>
<p>
   Listing 9.6 کلاس OrderControllerTest را نشان می‌دهد که OrderController از Order Service را تست می‌کند. این solitary unit tests هایی را تعریف می‌کند که از mocks ها برای dependencies های OrderController استفاده می‌کنند. این با استفاده از Rest Assured Mock MVC نوشته شده است که یک DSL ساده ارائه می‌دهد که جزئیات تعامل با controllers را انتزاع می‌کند. Rest Assured، ارسال یک request HTTP mock را به یک controller و تأیید response را آسان می‌کند. OrderControllerTest یک controller را ایجاد می‌کند که با Mockito mocks ها برای OrderService و OrderRepository تزریق می‌شود. هر تست، mocks ها را پیکربندی می‌کند، یک request HTTP ایجاد می‌کند، تأیید می‌کند که response درست است و احتمالاً تأیید می‌کند که controller، mocks ها را فراخوانی کرده است.
  </p>
<pre><code class="language-java">public class OrderControllerTest {
private OrderService orderService;
private OrderRepository orderRepository;
@Before
public void setUp() throws Exception {
orderService = mock(OrderService.class);
      
orderRepository = mock(OrderRepository.class);</code></pre>
<p>
<strong>Are these really unit tests?</strong>
</p>
<p>
   از آنجایی که این تست ها از Spring Framework استفاده می‌کنند، ممکن است استدلال کنید که آنها unit tests نیستند. آنها مطمئناً سنگین‌تر از unit tests هایی هستند که تاکنون توضیح داده‌ام.
   مستندات Spring Mock Mvc به این موارد به عنوان out-of-servlet-container integration tests اشاره دارد (https://docs.spring.io/spring/docs/current/spring-framework-reference/testing.html#spring-mvc-test-vs-end-to-end-integration-tests). با این حال Rest Assured Mock MVC، این تست ها را به عنوان unit tests توصیف می‌کند (https://github.com/rest-assured/rest-assured/wiki/Usage#spring-mock-mvc-module). صرف نظر از بحث در مورد اصطلاحات، اینها تست های مهمی هستند که باید نوشته شوند.
  </p>
<p>
<strong>Listing 9.6</strong>
   A simple, fast-running unit test for the OrderController class
  </p>
<p>
   Create mocks for
   OrderController’s
   dependencies.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0344_original/original_page.png" alt="Original Page 344">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<pre><code class="language-java">orderController = new OrderController(orderService, orderRepository);
}
@Test
public void shouldFindOrder() {
when(orderRepository.findById(1L))
.thenReturn(Optional.of(CHICKEN_VINDALOO_ORDER_);    
given().
standaloneSetup(configureControllers(
      
new OrderController(orderService, orderRepository))).
when().
get("/orders/1").
    
then().
statusCode(200).
   
body("orderId",
            
equalTo(new Long(OrderDetailsMother.ORDER_ID).intValue())).
body("state",
equalTo(OrderDetailsMother.CHICKEN_VINDALOO_ORDER_STATE.name())).
body("orderTotal",
equalTo(CHICKEN_VINDALOO_ORDER_TOTAL.asString()))
;</code></pre>
</p>
<p>
   متد shouldFindOrder() ابتدا OrderRepository mock را پیکربندی می‌کند تا یک Order را برگرداند. سپس یک request HTTP برای بازیابی order ایجاد می‌کند. در نهایت، بررسی می‌کند که request موفقیت‌آمیز بوده است و بدنه پاسخ حاوی داده‌های مورد انتظار است.
  </p>
<p>
   Controllers ها تنها adapters هایی نیستند که درخواست‌ها را از system های خارجی مدیریت می‌کنند.
   همچنین event/message handlers ها وجود دارند، بنابراین بیایید در مورد نحوه unit test کردن آنها صحبت کنیم.
  </p>
<h4>9.2.6</h4>
<h3>Developing unit tests for event and message handlers</h3>
<p>
   Service ها اغلب message هایی را که توسط system های خارجی ارسال می‌شوند، پردازش می‌کنند. به عنوان مثال، Order Service دارای OrderEventConsumer است که یک message adapter است که domain events منتشر شده توسط service های دیگر را مدیریت می‌کند. مانند controllers ها، message adapters ها تمایل به کلاس‌های ساده‌ای دارند که service های domain را فراخوانی می‌کنند. هر یک از متدهای message adapter، معمولاً یک متد service را با داده‌های message یا event فراخوانی می‌کند.
  </p>
<p>
   ما می‌توانیم message adapters را با استفاده از رویکردی مشابه با آنچه برای unit testing controllers استفاده کردیم، unit test کنیم. هر تست، message adapter را نمونه‌سازی می‌کند، یک message را به یک channel ارسال می‌کند و تأیید می‌کند که service mock به درستی فراخوانی شده است. در پشت ...
  </p>
<p>
   Configure the mock
   OrderRepository to
   return an Order.
  </p>
<p>
   Configure
   OrderController.
  </p>
<p>
   Make an
   HTTP
   request.
  </p>
<p>
   Verify the response
   status code.
  </p>
<p>
   Verify
   elements
   of the JSON
   response
   body.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0345_original/original_page.png" alt="Original Page 345">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   در این صحنه‌ها، service های infrastructure، اگرچه، زیر stub قرار دارند، بنابراین هیچ message broker ای درگیر نیست. بیایید نگاهی به نحوه تست کردن کلاس OrderEventConsumer بیندازیم.
  </p>
<p>
   Listing 9.7 قسمتی از کلاس OrderEventConsumerTest را نشان می‌دهد که OrderEventConsumer را تست می‌کند. این، تأیید می‌کند که OrderEventConsumer، هر event را به متد handler مناسب route می‌کند و OrderService را به درستی فراخوانی می‌کند. این تست از فریم‌ورک Eventuate Tram Mock Messaging، که یک DSL آسان برای استفاده برای نوشتن تست های mock messaging فراهم می‌کند که از قالب given-when-then یکسان با Rest Assured استفاده می‌کند، استفاده می‌کند. هر تست، OrderEventConsumer را با یک OrderService mock شده نمونه‌سازی می‌کند، یک domain event را منتشر می‌کند و تأیید می‌کند که OrderEventConsumer به درستی، service mock را فراخوانی کرده است.
  </p>
<pre><code class="language-java">public class OrderEventConsumerTest {
private OrderService orderService;
private OrderEventConsumer orderEventConsumer;
@Before
public void setUp() throws Exception {
orderService = mock(OrderService.class);
orderEventConsumer = new OrderEventConsumer(orderService);
  
}
@Test
public void shouldCreateMenu() {
given().
eventHandlers(orderEventConsumer.domainEventHandlers()).  
when().
aggregate("net.chrisrichardson.ftgo.restaurantservice.domain.Restaurant",
AJANTA_ID).
publishes(new RestaurantCreated(AJANTA_RESTAURANT_NAME,   
RestaurantMother.AJANTA_RESTAURANT_MENU))
then().
verify(() =&gt; {
    
verify(orderService)
.createMenu(AJANTA_ID,
new RestaurantMenu(RestaurantMother.AJANTA_RESTAURANT_MENU_ITEMS));
})
;
}
}</code></pre>
<p>
   متد setUp() یک OrderEventConsumer ایجاد می‌کند که با یک OrderService mock شده تزریق شده است. متد shouldCreateMenu() یک رویداد RestaurantCreated را منتشر می‌کند و تأیید می‌کند که OrderEventConsumer، OrderService.createMenu() را فراخوانی کرده است. کلاس OrderEventConsumerTest و سایر کلاس‌های unit test به سرعت اجرا می‌شوند.
   The unit tests run in just a few seconds.
  </p>
<p>
<strong>Listing 9.7</strong>
   A fast-running unit test for the OrderEventConsumer class
  </p>
<p>
   Instantiate
   OrderEventConsumer with
   mocked dependencies.
  </p>
<p>
   Configure
   OrderEventConsumer
   domain handlers.
  </p>
<p>
   Publish a
   Restaurant-
   Created
   event.
  </p>
<p>
   Verify that OrderEventConsumer
   invoked OrderService.createMenu().
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0346_original/original_page.png" alt="Original Page 346">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 1</strong>
</p>
<p>
   اما unit tests ها تأیید نمی‌کنند که یک service، مانند Order Service، به درستی با service های دیگر تعامل دارد. به عنوان مثال، unit tests ها تأیید نمی‌کنند که یک Order می‌تواند در MySQL ذخیره شود. آنها همچنین تأیید نمی‌کنند که CreateOrderSaga، پیام‌های command را با فرمت صحیح به کانال پیام مناسب ارسال می‌کند. و آنها تأیید نمی‌کنند که رویداد RestaurantCreated که توسط OrderEventConsumer پردازش می‌شود، ساختار یکسانی با رویداد منتشر شده توسط Restaurant Service دارد. به منظور تأیید اینکه یک service به درستی با service های دیگر تعامل دارد، ما باید integration tests ها را بنویسیم. ما همچنین باید component tests هایی را بنویسیم که یک service کامل را در isolation تست می‌کنند. فصل بعد در مورد نحوه انجام آن انواع تست ها و همچنین end-to-end tests ها بحث می‌کند.
  </p>
<p>
<strong>Summary</strong>
</p>
<ul>
<li>
    Automated testing، پایه اصلی delivery ایمن و سریع نرم‌افزار است.
    علاوه بر این، به دلیل complex بودن ذاتی آن، برای بهره‌مندی کامل از معماری microservice، باید تست های خود را automated کنید.
   </li>
<li>
    هدف از یک تست، تأیید رفتار system under test (SUT) است. در این تعریف، system یک اصطلاح فانتزی است که به معنای عنصر نرم‌افزاری است که تست می‌شود. ممکن است چیزی به کوچکی یک کلاس، به بزرگی کل application، یا چیزی در این بین، مانند یک خوشه از کلاس‌ها یا یک service فردی باشد. مجموعه‌ای از تست های مرتبط، یک test suite را تشکیل می‌دهند.
   </li>
<li>
    یک راه خوب برای ساده‌سازی و سرعت بخشیدن به یک تست، استفاده از test doubles ها است. A test double یک object است که رفتار dependency یک SUT را شبیه‌سازی می‌کند. دو نوع test double وجود دارد: stubs و mocks. A stub، یک test double است که مقادیری را به SUT برمی‌گرداند. A mock یک test double است که یک تست برای تأیید اینکه SUT به درستی یک dependency را فراخوانی می‌کند، از آن استفاده می‌کند.
   </li>
<li>
    از test pyramid برای تعیین جایی که باید تلاش‌های testing خود را برای service های خود متمرکز کنید، استفاده کنید. اکثر تست های شما باید fast، reliable و easy-to-write unit tests باشند. شما باید تعداد end-to-end tests ها را به حداقل برسانید، زیرا آنها slow، brittle و زمان‌بر هستند.
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0347_original/original_page.png" alt="Original Page 347">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   این فصل بر فصل قبل بنا شده است، که مفاهیم testing، از جمله test pyramid را معرفی کرد. test pyramid، نسبت‌های نسبی انواع مختلف تست هایی را که باید بنویسید، شرح می‌دهد. فصل قبل نحوه نوشتن unit tests ها را که در پایه the testing pyramid قرار دارند، توضیح داد. در این فصل، ما به صعود خود از the testing pyramid ادامه می‌دهیم.
  </p>
<p>
   این فصل با نحوه نوشتن integration tests ها شروع می‌شود که سطح بالاتری نسبت به unit tests ها در the testing pyramid هستند. Integration tests، تأیید می‌کنند که یک service می‌تواند به درستی با service های infrastructure، مانند databases و سایر application services ها، تعامل داشته باشد. در مرحله بعد، من component tests ها را پوشش می‌دهم، که acceptance tests ها برای service ها هستند. یک component test، یک service را در isolation با استفاده از stubs برای dependencies آن تست می‌کند. پس از آن، من نحوه نوشتن end-to-end tests ها را توضیح می‌دهم که یک گروه از service ها یا ... را تست می‌کنند.
  </p>
<p>
   This chapter covers
  </p>
<ul>
<li>
    Techniques for testing services in isolation
   </li>
<li>
    Using consumer-driven contract testing to write
    tests that quickly yet reliably verify interservice
    communication
   </li>
<li>
    When and how to do end-to-end testing of
    applications
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0348_original/original_page.png" alt="Original Page 348">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   entire application. End-to-end tests در بالای the test pyramid قرار دارند و بنابراین، باید با احتیاط استفاده شوند.
  </p>
<p>
   بیایید با نگاهی به نحوه نوشتن integration tests ها شروع کنیم.
  </p>
<h4>10.1</h4>
<h3>Writing integration tests</h3>
<p>
   Service ها معمولاً با service های دیگر تعامل دارند. به عنوان مثال، Order Service، همانطور که شکل 10.1 نشان می‌دهد، با چندین service تعامل دارد. API REST آن توسط API Gateway مصرف می‌شود و domain events آن توسط service هایی از جمله Order History Service مصرف می‌شوند.
   Order Service از چندین service دیگر استفاده می‌کند. Order ها را در MySQL ذخیره می‌کند. همچنین command ها را ارسال می‌کند و پاسخ‌ها را از چندین service دیگر، مانند Kitchen Service، مصرف می‌کند.
  </p>
<p>
   به منظور اطمینان از اینکه یک service مانند Order Service همانطور که انتظار می‌رود کار می‌کند، ما باید تست هایی را بنویسیم که تأیید کنند service می‌تواند به درستی با service های infrastructure و سایر application services ها تعامل داشته باشد. یک رویکرد، راه‌اندازی همه service ها و تست کردن آنها از طریق APIs آنها است. با این حال، این چیزی است که به عنوان end-to-end testing شناخته می‌شود که slow، brittle و costly است. همانطور که در بخش 10.3 توضیح داده شد، نقشی برای end-to-end ...
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAApwAAAEsCAYAAACbT7y2AAAgAElEQVR4nO2deXxU5bX3/r7/f/VfA3M0aQxM/yR0z+j7X6Q+gO7u7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0349_original/original_page.png" alt="Original Page 349">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   testing گاهی اوقات، اما در بالای the test pyramid قرار دارد، بنابراین شما می‌خواهید تعداد end-to-end tests ها را به حداقل برسانید.
  </p>
<p>
   یک استراتژی بسیار مؤثرتر، نوشتن چیزی است که به عنوان integration tests شناخته می‌شود. همانطور که شکل 10.2 نشان می‌دهد، integration tests ها، لایه‌ای بالاتر از unit tests ها در the testing pyramid هستند.
   آنها تأیید می‌کنند که یک service می‌تواند به درستی با service های infrastructure و سایر service ها تعامل داشته باشد. اما بر خلاف end-to-end tests ها، آنها service ها را راه‌اندازی نمی‌کنند. در عوض، ما از چند استراتژی استفاده می‌کنیم که تست ها را بدون تأثیر بر effectiveness آنها، به میزان قابل توجهی ساده می‌کند.
  </p>
<p>
   اولین استراتژی، تست کردن هر یک از service's adapters ها، همراه با، شاید کلاس‌های پشتیبانی کننده adapter است. به عنوان مثال، در بخش 10.1.1 شما یک test persistence JPA را خواهید دید که تأیید می‌کند که Order ها به درستی persistent شده‌اند. به جای تست کردن persistence از طریق API Order Service، کلاس OrderRepository را مستقیماً تست می‌کند. به طور مشابه، در بخش 10.1.3 شما تستی را خواهید دید که تأیید می‌کند که Order Service، domain events های ساختار یافته را با تست کردن کلاس OrderDomainEventPublisher به درستی منتشر می‌کند. مزیت تست کردن فقط تعداد کمی از کلاس‌ها به جای کل service این است که تست ها به طور قابل توجهی ساده‌تر و سریع‌تر هستند.
  </p>
<p>
   استراتژی دوم برای ساده‌سازی integration tests ها که تعاملات بین application services را تأیید می‌کنند، استفاده از contract ها است که در فصل 9 مورد بحث قرار گرفت. A contract یک مثال concrete از تعامل بین یک جفت service است. همانطور که جدول 10.1 نشان می‌دهد، ساختار یک contract به نوع تعامل بین service ها بستگی دارد.
  </p>
<p>
   Table 10.1
   The structure of a contract depends on the type of interaction between the services.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAApwAAAEsCAYAAACbT7y2AAAgAElEQVR4nO3dfXxU5bX3/r7/f/VfA3M0aQxM/yR0z+j7X6Q+gO7u7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0350_original/original_page.png" alt="Original Page 350">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   یک contract، از یک message تشکیل شده است، در مورد تعاملات از نوع publish/subscribe، یا دو message، در مورد تعاملات از نوع request/response و asynchronous request/response.
  </p>
<p>
   Contracts ها برای تست کردن هم consumer و هم provider استفاده می‌شوند که تضمین می‌کند در مورد API توافق دارند. بسته به اینکه آیا شما در حال تست کردن consumer هستید یا provider، به روش‌های کمی متفاوت استفاده می‌شوند:
  </p>
<ul>
<li>
    Consumer-side tests—اینها تست هایی برای adapter های consumer هستند. آنها از contract ها برای پیکربندی stubs ها که provider را شبیه‌سازی می‌کنند، استفاده می‌کنند و شما را قادر می‌سازند تا integration tests ها را برای یک consumer بنویسید که به یک provider در حال اجرا نیاز ندارد.
   </li>
<li>
    Provider-side tests—اینها تست هایی برای adapter های provider هستند. آنها از contract ها برای تست کردن adapters ها با استفاده از mocks ها برای dependencies های adapters's استفاده می‌کنند.
   </li>
</ul>
<p>
   بعداً در این بخش، نمونه‌هایی از این نوع تست ها را شرح می‌دهم — اما ابتدا بیایید نگاهی بیندازیم که چگونه تست های persistence را بنویسیم.
  </p>
<h4>10.1.1 Persistence integration tests</h4>
<p>
   Service ها معمولاً داده‌ها را در یک database ذخیره می‌کنند. به عنوان مثال، Order Service، aggregates ها، مانند Order را، در MySQL با استفاده از JPA persistent می‌کند. به طور مشابه، Order History Service یک view از نوع CQRS را در AWS DynamoDB نگهداری می‌کند. unit tests هایی که قبلاً نوشتیم، فقط objects های in-memory را تست می‌کنند. به منظور اطمینان از اینکه یک service به درستی کار می‌کند، ما باید persistence integration tests ها را بنویسیم که تأیید می‌کنند که logic دسترسی به database یک service همانطور که انتظار می‌رود، کار می‌کند. در مورد Order Service، این به معنای تست کردن JPA repositories ها، مانند OrderRepository است.
  </p>
<p>
   هر فاز از یک persistence integration test به شرح زیر رفتار می‌کند:
  </p>
<ul>
<li>
    Setup—Database را با ایجاد database schema و initialize کردن آن به یک state شناخته شده تنظیم کنید. همچنین ممکن است یک transaction database را شروع کند.
   </li>
<li>
    Execute—یک operation database را انجام دهید.
   </li>
<li>
    Verify—در مورد state database و objects بازیابی شده از database، assertion هایی ایجاد کنید.
   </li>
<li>
    Teardown—یک فاز اختیاری که ممکن است تغییرات ایجاد شده در database را با، به عنوان مثال، rolling back the transaction که توسط فاز setup شروع شده است، undo کند.
   </li>
</ul>
<p>
   Listing 10.1 یک persistence integration test را برای Order aggregate و OrderRepository نشان می‌دهد. به جز تکیه بر JPA برای ایجاد database schema، persistence integration tests ها هیچ فرضی در مورد state database ندارند. در نتیجه، تست ها نیازی به roll back کردن تغییراتی که در database ایجاد می‌کنند، ندارند، که از مشکلات caching داده های ORM در حافظه جلوگیری می‌کند.
  </p>
<pre><code class="language-java">@RunWith(SpringRunner.class)
@SpringBootTest(classes = OrderJpaTestConfiguration.class)
public class OrderJpaTest {</code></pre>
<p>
<strong>Listing 10.1</strong>
   An integration test that verifies that an Order can be persisted
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0351_original/original_page.png" alt="Original Page 351">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<pre><code class="language-java">@Autowired
private OrderRepository orderRepository;
@Autowired
private TransactionTemplate transactionTemplate;
@Test
public void shouldSaveAndLoadOrder() {
Long orderId = transactionTemplate.execute((ts) -&gt; {
Order order =
new Order(CONSUMER_ID, AJANTA_ID, CHICKEN_VINDALOO_LINE_ITEMS);
orderRepository.save(order);
return order.getId();
});
transactionTemplate.execute((ts) -&gt; {
Order order = orderRepository.findById(orderId).get();
assertEquals(OrderState.APPROVAL_PENDING, order.getState());
assertEquals(AJANTA_ID, order.getRestaurantId());
assertEquals(CONSUMER_ID, order.getConsumerId().longValue());
assertEquals(CHICKEN_VINDALOO_LINE_ITEMS, order.getLineItems());
return null;
});
}
}</code></pre>
<p>
   متد shouldSaveAndLoadOrder()، دو transaction را اجرا می‌کند. اولین مورد یک Order تازه ایجاد شده را در database ذخیره می‌کند. transaction دوم، Order را بارگذاری می‌کند و تأیید می‌کند که fields های آن به درستی initialize شده‌اند.
  </p>
<p>
   یک مشکلی که شما باید حل کنید این است که چگونه database را که در persistence integration tests استفاده می‌شود، تهیه کنید. یک راه‌حل مؤثر برای اجرای یک نمونه از database در طول testing، استفاده از Docker است. بخش 10.2 نحوه استفاده از plugin Gradle Docker Compose را برای اجرای خودکار service ها در طول component testing، توضیح می‌دهد. به عنوان مثال، می‌توانید از یک رویکرد مشابه برای اجرای MySQL در طول persistence integration testing استفاده کنید.
  </p>
<p>
   Database، تنها یکی از external services هایی است که یک service با آن تعامل دارد. اکنون بیایید نگاهی بیندازیم که چگونه integration tests ها را برای interservice communication ها بین application services ها، با شروع از REST، بنویسیم.
  </p>
<h4>10.1.2 Integration testing REST-based request/response style</h4>
<p>
   REST، یک mechanism interservice communication است که به طور گسترده مورد استفاده قرار می‌گیرد. client REST و service REST باید در مورد REST API توافق داشته باشند، که شامل REST endpoints و ساختار request و response bodies می‌شود. client باید یک request HTTP را به endpoint صحیح ارسال کند و service باید response ای را که client انتظار دارد، برگرداند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0352_original/original_page.png" alt="Original Page 352">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   به عنوان مثال، فصل 8 نحوه ایجاد API Gateway application FTGO REST API calls ها را به service های متعدد، از جمله ConsumerService، Order Service، و Delivery Service شرح می‌دهد. endpoint GET /orders/{orderId} OrderService یکی از endpoints هایی است که توسط API Gateway فراخوانی می‌شود. به منظور اطمینان از اینکه API Gateway و Order Service می‌توانند بدون استفاده از یک end-to-end test ارتباط برقرار کنند، ما باید integration tests ها را بنویسیم.
  </p>
<p>
   همانطور که در فصل قبل گفته شد، یک استراتژی integration testing خوب، استفاده از consumer-driven contract tests ها است. تعامل بین API Gateway و GET /orders/{orderId} را می‌توان با استفاده از مجموعه‌ای از contract های مبتنی بر HTTP توصیف کرد. هر contract، از یک request و response HTTP تشکیل شده است. contract ها برای تست کردن API Gateway و Order Service استفاده می‌شوند.
  </p>
<p>
   شکل 10.3 نحوه استفاده از Spring Cloud Contract را برای تست تعاملات مبتنی بر REST نشان می‌دهد. consumer-side API Gateway integration tests، از contract ها برای پیکربندی یک server HTTP stub که رفتار Order Service را شبیه‌سازی می‌کند، استفاده می‌کند. request از یک contract، یک request HTTP را از API gateway مشخص می‌کند، و response از contract، پاسخ را مشخص می‌کند که stub به API gateway بازمی‌گرداند. Spring Cloud Contract، از contract ها برای code-generate کردن provider-side Order Service integration tests ها استفاده می‌کند که controllers ها را با استفاده از Spring Mock MVC یا Rest Assured Mock MVC تست می‌کند. request از contract، request HTTP را برای ایجاد به controller مشخص می‌کند، و response از contract، response مورد انتظار controller را مشخص می‌کند.
  </p>
<p>
   The consumer-side OrderServiceProxyTest، OrderServiceProxy را فراخوانی می‌کند که برای ایجاد requests HTTP به WireMock پیکربندی شده است. WireMock یک ابزار برای mocking کردن efficient HTTP servers است—در این تست، Order Service را شبیه‌سازی می‌کند. Spring Cloud ...
  </p>
<pre><code class="language-java">OrderService
ProxyTest
class HttpTest
extends BaseHttp {
}
abstract class BaseHttp {
@Before
public void setup() {
RestAssuredMockMvc
.standaloneSetup(...);
}</code></pre>
<pre><code class="language-java">Contract.make {
request {..}
response {...}
}</code></pre>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAApwAAAEsCAYAAACbT7y2AAAgAElEQVR4nO3dfZBU1ZXHP93xJgI7wZlM2cZmds10T+cI2N5Jd4b33f7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0353_original/original_page.png" alt="Original Page 353">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   Contract، WireMock را مدیریت می‌کند و آن را برای پاسخ دادن به requests HTTP که توسط contract ها تعریف شده‌اند، پیکربندی می‌کند.
  </p>
<p>
   در سمت provider، Spring Cloud Contract، یک test class به نام HttpTest تولید می‌کند که از Rest Assured Mock MVC برای تست کردن controllers های Order Service استفاده می‌کند. کلاس‌های تست مانند HttpTest باید یک کلاس base دستی را گسترش دهند. در این مثال، کلاس base BaseHttp، OrderController را که با dependencies های mock شده تزریق شده است، نمونه‌سازی می‌کند و RestAssuredMockMvc.standaloneSetup() را برای پیکربندی Spring MVC فراخوانی می‌کند.
  </p>
<p>
   بیایید نگاهی دقیق‌تر به نحوه عملکرد این کار بیندازیم، با یک مثال contract شروع می‌کنیم.
  </p>
<p>
<strong>AN EXAMPLE CONTRACT FOR A REST API</strong>
</p>
<p>
   یک contract REST، مانند موردی که در listing 10.2 نشان داده شده است، یک request HTTP را مشخص می‌کند که توسط client REST ارسال می‌شود، و response HTTP را که client انتظار دارد از server REST دریافت کند، مشخص می‌کند. request از یک contract، متد HTTP، path و headers های اختیاری را مشخص می‌کند. response از یک contract، status code HTTP، headers های اختیاری و، در صورت مناسب بودن، body مورد انتظار را مشخص می‌کند.
  </p>
<pre><code class="language-java">org.springframework.cloud.contract.spec.Contract.make {
request {
method 'GET'
url '/orders/1223232'
}
response {
status 200
headers {
header('Content-Type': 'application/json;charset=UTF-8')
}
body("{"orderId" : "1223232", "state" : "APPROVAL_PENDING"}")
}
}</code></pre>
<p>
   این contract خاص، یک تلاش موفقیت‌آمیز توسط API Gateway برای بازیابی یک Order از Order Service را شرح می‌دهد. اکنون بیایید نگاهی بیندازیم که چگونه از این contract برای نوشتن integration tests ها استفاده کنیم، با تست ها برای Order Service شروع می‌کنیم.
  </p>
<p>
<strong>CONSUMER-DRIVEN CONTRACT INTEGRATION TESTS FOR ORDER SERVICE</strong>
</p>
<p>
   The consumer-driven contract integration tests برای Order Service، تأیید می‌کنند که API آن، انتظارات client هایش را برآورده می‌کند. Listing 10.3 HttpBase را نشان می‌دهد که کلاس base انتزاعی برای کد تست class generated by Spring Cloud Contract است. این مسئول فاز setup تست است. controllers ها را که با dependencies های mock شده تزریق شده‌اند، ایجاد می‌کند و آن mocks ها را پیکربندی می‌کند تا مقادیری را برگردانند که باعث می‌شوند controller، response مورد انتظار را تولید کند.
  </p>
<pre><code class="language-java">public abstract class HttpBase {
private StandaloneMockMvcBuilder controllers(Object... controllers) {
...</code></pre>
<p>
<strong>Listing 10.2</strong>
   A contract that describes an HTTP-based request/response style interaction
  </p>
<p>
<strong>Listing 10.3</strong>
   The abstract base class for the tests code-generated by Spring Cloud Contract
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0354_original/original_page.png" alt="Original Page 354">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
   در این صورت، کد، tests ها را برای API Gateway و Order Service ایجاد می‌کند و از Spring Mock MVC یا Rest Assured Mock MVC استفاده می‌کند.
   request از contract، request HTTP را برای ایجاد به controller مشخص می‌کند، و response از contract، response مورد انتظار controller را مشخص می‌کند.
  </p>
<p>
<pre><code class="language-java">return MockMvcBuilders.standaloneSetup(controllers)
.setMessageConverters(...);
}
@Before
public void setup() {
OrderService orderService = mock(OrderService.class);
  
OrderRepository orderRepository = mock(OrderRepository.class);
OrderController orderController =
new OrderController(orderService, orderRepository);
when(orderRepository.findById(1223232L))
            
.thenReturn(Optional.of(OrderDetailsMother.CHICKEN_VINDALOO_ORDER));
...
RestAssuredMockMvc.standaloneSetup(controllers(orderController));</code></pre>
</p>
<p>
   آرگومان 1223232L که به متد findById() از OrderRepository mock شده، منتقل می‌شود، با orderId مشخص شده در contract که در listing 10.3 نشان داده شده است، مطابقت دارد. این تست تأیید می‌کند که Order Service یک endpoint GET /orders/{orderId} دارد که با انتظارات client آن مطابقت دارد.
  </p>
<p>
   بیایید نگاهی به تست client مربوطه بیندازیم.
  </p>
<p>
<strong>CONSUMER-SIDE INTEGRATION TEST FOR API GATEWAY’S ORDERSERVICEPROXY</strong>
</p>
<p>
   API Gateway’s OrderServiceProxy، endpoint GET /orders/{orderId} را فراخوانی می‌کند. Listing 10.4 کلاس تست OrderServiceProxyIntegrationTest را نشان می‌دهد که تأیید می‌کند که با contract ها مطابقت دارد. این کلاس با @AutoConfigureStubRunner که توسط Spring Cloud Contract ارائه شده است، annotation نویسی شده است. این، به Spring Cloud Contract می‌گوید که سرور WireMock را روی یک پورت تصادفی اجرا کند و آن را با استفاده از contract های مشخص شده پیکربندی کند. OrderServiceProxyIntegrationTest، OrderServiceProxy را پیکربندی می‌کند تا requests ها را به پورت WireMock ارسال کند.
  </p>
<pre><code class="language-java">@RunWith(SpringRunner.class)
@SpringBootTest(classes=TestConfiguration.class,
webEnvironment= SpringBootTest.WebEnvironment.NONE)
@AutoConfigureStubRunner(ids =
        
{"net.chrisrichardson.ftgo.contracts:ftgo-order-service-contracts"},
workOffline = false)
@DirtiesContext
public class OrderServiceProxyIntegrationTest {
@Value("${stubrunner.runningstubs.ftgo-order-service-contracts.port}")  </code></pre>
<p>
<strong>Listing 10.4</strong>
   A consumer-side integration test for API Gateway's
   OrderServiceProxy
  </p>
<p>
   Create
   OrderRepository
   injected with mocks.
  </p>
<p>
   Configure OrderResponse to return an Order when findById()
   is invoked with the orderId specified in the contract.
  </p>
<p>
   Configure Spring MVC with
   OrderController.
  </p>
<p>
   Tell Spring Cloud Contract
   to configure WireMock with
   Order Service’s contracts.
  </p>
<p>
   Obtain the randomly assigned port
   that WireMock is running on.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0355_original/original_page.png" alt="Original Page 355">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<pre><code class="language-java">private int port;
private OrderDestinations orderDestinations;
private OrderServiceProxy orderService;
@Before
public void setUp() throws Exception {
orderDestinations = new OrderDestinations();
String orderServiceUrl = "http://localhost:" + port;
orderDestinations.setOrderServiceUrl(orderServiceUrl);
orderService = new OrderServiceProxy(orderDestinations,
  
WebClient.create());
}
@Test
public void shouldVerifyExistingCustomer() {
OrderInfo result = orderService.findOrderById("1223232").block();
assertEquals("1223232", result.getOrderId());
assertEquals("APPROVAL_PENDING", result.getState());
}
@Test(expected = OrderNotFoundException.class)
public void shouldFailToFindMissingOrder() {
orderService.findOrderById("555").block();
}
}</code></pre>
<p>
   هر متد تست، OrderServiceProxy را فراخوانی می‌کند و تأیید می‌کند که یا مقادیر صحیح را برمی‌گرداند یا exception مورد انتظار را پرتاب می‌کند. متد shouldVerifyExistingCustomer()، تأیید می‌کند که findOrderById()، مقادیری برابر با مقادیر مشخص شده در response contract را برمی‌گرداند. the shouldFailToFindMissingOrder() تلاش می‌کند تا یک Order غیر موجود را بازیابی کند و تأیید می‌کند که OrderServiceProxy، یک OrderNotFoundException را پرتاب می‌کند. Testing هر دو سمت تعامل REST client و service REST با استفاده از contract های یکسان، تضمین می‌کند که در مورد API توافق دارند.
  </p>
<p>
   اکنون بیایید نگاهی بیندازیم که چگونه همین نوع تست را برای service هایی که با استفاده از messaging تعامل دارند، انجام دهیم.
  </p>
<h4>10.1.3 Integration testing publish/subscribe-style interactions</h4>
<p>
   Service ها اغلب domain events هایی را منتشر می‌کنند که توسط یک یا چند service دیگر مصرف می‌شوند. Integration testing باید تأیید کند که publisher و consumers آن در مورد message channel و ساختار domain events توافق دارند. به عنوان مثال، Order Service، رویدادهای Order* را هر زمان که یک Order aggregate را ایجاد یا به‌روزرسانی می‌کند، منتشر می‌کند. Order History Service یکی از consumers های آن رویدادها است. بنابراین، ما باید تست هایی را بنویسیم که تأیید کنند که این service ها می‌توانند تعامل داشته باشند.
  </p>
<p>
   شکل 10.4 رویکردی را برای integration testing publish/subscribe interactions نشان می‌دهد. این، کاملاً شبیه به رویکردی است که برای تست کردن تعاملات REST استفاده می‌شود. مانند قبل، تعاملات توسط مجموعه‌ای از contract ها تعریف می‌شوند. چیزی که متفاوت است این است که هر contract، یک domain event را مشخص می‌کند.
  </p>
<p>
   Create an OrderServiceProxy
   configured to make requests
   to WireMock.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0356_original/original_page.png" alt="Original Page 356">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   Each consumer-side test، event را که توسط contract مشخص شده است، منتشر می‌کند و تأیید می‌کند که OrderHistoryEventHandlers، dependencies های mock شده خود را به درستی فراخوانی می‌کند.
  </p>
<p>
   در سمت provider، کد Spring Cloud Contract، test classes هایی را تولید می‌کند که MessagingBase را گسترش می‌دهند، که یک superclass انتزاعی دستی است. هر متد تست، یک متد hook را که توسط MessagingBase تعریف شده است، فراخوانی می‌کند، که انتظار می‌رود انتشار یک event را توسط service فعال کند. در این مثال، هر متد hook، OrderDomainEventPublisher را فراخوانی می‌کند که مسئول انتشار رویدادهای Order aggregate است. سپس متد تست تأیید می‌کند که OrderDomainEventPublisher، event مورد انتظار را منتشر کرده است. بیایید نگاهی به جزئیات نحوه عملکرد این تست ها بیندازیم، با contract شروع می‌کنیم.
  </p>
<p>
<strong>THE CONTRACT FOR PUBLISHING AN ORDERCREATED EVENT</strong>
</p>
<p>
   Listing 10.5، contract را برای یک رویداد OrderCreated نشان می‌دهد. این، channel رویداد، به همراه بدنه و message headers های مورد انتظار را مشخص می‌کند.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAArMAAAG9CAYAAADz179CAAAgAElEQVR4nO3dcWAVV33g30197d393f29tBghyY040d05zQ1u+z//3f3s+Z3zN8+fX5JjM7Ym5s7MzMxMTEzMzExMTH1wAQkIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0357_original/original_page.png" alt="Original Page 357">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   مجموعه تست های Order Service را تست کرد و آن را به یک repository منتشر کرد.
   The API Gateway team writes the contracts. The Order Service team
   uses those contracts to test Order Service and publishes them to a repository. The
   API Gateway team uses the published contracts to test API Gateway.
   The HTTP request’s
   method and path
   The HTTP response’s status
   code, headers, and body
  </p>
<p>
   برای مثال، فصل 8 نشان می‌دهد که چگونه API Gateway application FTGO، REST API calls ها را به service های متعدد، از جمله ConsumerService، Order Service، و Delivery Service ایجاد می‌کند. endpoint GET /orders/{orderId} OrderService یکی از endpoints هایی است که توسط API Gateway فراخوانی می‌شود. به منظور اطمینان از اینکه API Gateway و Order Service می‌توانند بدون استفاده از یک end-to-end test ارتباط برقرار کنند، ما باید integration tests ها را بنویسیم.
  </p>
<p>
   همانطور که در فصل قبل گفته شد، یک استراتژی integration testing خوب، استفاده از consumer-driven contract tests ها است. تعامل بین API Gateway و GET /orders/{orderId} را می‌توان با استفاده از مجموعه‌ای از contract های مبتنی بر HTTP توصیف کرد. هر contract، از یک request و response HTTP تشکیل شده است. contract ها برای تست کردن API Gateway و Order Service استفاده می‌شوند.
  </p>
<p>
   شکل 10.3 نحوه استفاده از Spring Cloud Contract را برای تست تعاملات مبتنی بر REST نشان می‌دهد. consumer-side API Gateway integration tests، از contract ها برای پیکربندی یک server HTTP stub که رفتار Order Service را شبیه‌سازی می‌کند، استفاده می‌کند. request از یک contract، یک request HTTP را از API gateway مشخص می‌کند، و response از contract، پاسخ را مشخص می‌کند که stub به API gateway بازمی‌گرداند. Spring Cloud Contract، از contract ها برای code-generate کردن provider-side Order Service integration tests ها استفاده می‌کند که controllers ها را با استفاده از Spring Mock MVC یا Rest Assured Mock MVC تست می‌کند. request از contract، request HTTP را برای ایجاد به controller مشخص می‌کند، و response از contract، response مورد انتظار controller را مشخص می‌کند.
  </p>
<p>
   در این مثال، the deployment pipeline کاملاً automated است.
  </p>
<p>
   The shouldSaveAndLoadOrder() method، دو transaction را اجرا می‌کند.
  </p>
<p>
<pre><code class="language-java">package contracts;
org.springframework.cloud.contract.spec.Contract.make {
label 'orderCreatedEvent'
  
input {
triggeredBy('orderCreated()')       
}
outputMessage {
sentTo('net.chrisrichardson.ftgo.orderservice.domain.Order')
body("{"orderDetails":{"lineItems":[{"quantity":5,"menuItemId":"1",
                 "name":"Chicken Vindaloo","price":"12.34","total":"61.70"}],
                 "orderTotal":"61.70","restaurantId":1, 
        "consumerId":1511300065921},"orderState":"APPROVAL_PENDING"}")
        headers {
            header('event-aggregate-type', 
                        'net.chrisrichardson.ftgo.orderservice.domain.Order')
            header('event-aggregate-id', '1')
        }
}
}</code></pre>
<p>
   این contract خاص، یک تلاش موفقیت‌آمیز توسط API Gateway برای بازیابی یک Order از Order Service را شرح می‌دهد. اکنون بیایید نگاهی بیندازیم که چگونه از این contract برای نوشتن integra-
   tion tests ها استفاده کنیم، با تست ها برای Order Service شروع می‌کنیم.
  </p>
<p>
<strong>CONSUMER-DRIVEN CONTRACT TESTS FOR ORDER SERVICE</strong>
</p>
<p>
   The consumer-driven contract integration tests برای Order Service، تأیید می‌کنند که API آن، انتظارات client هایش را برآورده می‌کند. Listing 10.3 HttpBase را نشان می‌دهد که کلاس base انتزاعی برای کد تست class generated by Spring Cloud Contract است. این مسئول فاز setup تست است. controllers ها را که با dependencies های mock شده تزریق شده‌اند، ایجاد می‌کند و آن mocks ها را پیکربندی می‌کند تا مقادیری را برگردانند که باعث می‌شوند controller، response مورد انتظار را تولید کند.
  </p>
<pre><code class="language-java">public abstract class HttpBase {
private StandaloneMockMvcBuilder controllers(Object... controllers) {
...</code></pre>
<p>
   Create mocks for
   OrderController’s
   dependencies.
  </p>
<p>
   ...
  </p>
<p>
   هر متد تست، OrderServiceProxy را فراخوانی می‌کند و تأیید می‌کند که یا مقادیر صحیح را برمی‌گرداند یا exception مورد انتظار را پرتاب می‌کند. متد shouldVerifyExistingCustomer()، تأیید می‌کند که findOrderById()، مقادیری برابر با مقادیر مشخص شده در response contract را برمی‌گرداند. the shouldFailToFindMissingOrder() تلاش می‌کند تا یک Order غیر موجود را بازیابی کند و تأیید می‌کند که OrderServiceProxy، یک OrderNotFoundException را پرتاب می‌کند. Testing هر دو سمت تعامل REST client و service REST با استفاده از contract های یکسان، تضمین می‌کند که در مورد API توافق دارند.
  </p>
<p>
   Let’s now look at how to do the same kind of testing for services that interact using
   messaging.
  </p>
<p>
<strong>10.1.3 Integration testing publish/subscribe-style interactions</strong>
</p>
<p>
   Service ها اغلب domain events هایی را منتشر می‌کنند که توسط یک یا چند service دیگر مصرف می‌شوند. Integration testing باید تأیید کند که publisher و consumers آن در مورد message channel و ساختار domain events توافق دارند. به عنوان مثال، Order Service، رویدادهای Order* را هر زمان که یک Order aggregate را ایجاد یا به‌روزرسانی می‌کند، منتشر می‌کند. Order History Service یکی از consumers های آن رویدادها است. بنابراین، ما باید تست هایی را بنویسیم که تأیید کنند که این service ها می‌توانند تعامل داشته باشند.
  </p>
<p>
   شکل 10.4 رویکردی را برای integration testing publish/subscribe interactions نشان می‌دهد. این، کاملاً شبیه به رویکردی است که برای تست کردن تعاملات REST استفاده می‌شود. مانند قبل، تعاملات توسط مجموعه‌ای از contract ها تعریف می‌شوند. چیزی که متفاوت است این است که هر contract، یک domain event را مشخص می‌کند.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAApwAAAEsCAYAAACbT7y2AAAgAElEQVR4nO3dfZBU1ZXHP93xJgI7wZlM2cZmds10T+cI2N5Jd4b33f7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0358_original/original_page.png" alt="Original Page 358">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
<pre><code class="language-java">@Configuration
@EnableAutoConfiguration
@Import({EventuateContractVerifierConfiguration.class,
TramEventsPublisherConfiguration.class,
TramInMemoryConfiguration.class})
public static class TestConfiguration {
@Bean
public OrderDomainEventPublisher
OrderDomainEventPublisher(DomainEventPublisher eventPublisher) {
return new OrderDomainEventPublisher(eventPublisher);
}
}
@Autowired
private OrderDomainEventPublisher OrderDomainEventPublisher;
protected void orderCreated() {
    
OrderDomainEventPublisher.publish(CHICKEN_VINDALOO_ORDER,
singletonList(new OrderCreatedEvent(CHICKEN_VINDALOO_ORDER_DETAILS)
));
}</code></pre>
</p>
<p>
   متد orderCreated()، توسط یک زیرکلاس تست code-generated شده، برای انتشار event فراخوانی می‌شود.
  </p>
<p>
   This test class configures OrderDomainEventPublisher with in-memory messaging
   stubs. orderCreated() is invoked by the test method generated from the contract
   shown earlier in listing 10.5. It invokes OrderDomainEventPublisher to publish an
   OrderCreated event. The test method attempts to receive this event and then verifies
   that it matches the event specified in the contract. Let’s now look at the correspond-
   ing consumer-side tests.
  </p>
<p>
<strong>CONSUMER-SIDE CONTRACT TEST FOR THE ORDER HISTORY SERVICE</strong>
</p>
<p>
   Order History Service، رویدادهایی را که توسط Order Service منتشر می‌شوند، مصرف می‌کند. همانطور که در فصل 7 شرح دادم، کلاس adapter که این رویدادها را مدیریت می‌کند، کلاس OrderHistoryEventHandlers است. event handlers های آن، OrderHistoryDao را برای به‌روزرسانی view CQRS فراخوانی می‌کنند.
   Listing 10.7، integration test سمت consumer را نشان می‌دهد. این، یک OrderHistoryEventHandlers را ایجاد می‌کند که با یک OrderHistoryDao mock شده، تزریق شده است. هر متد تست ابتدا Spring Cloud را فراخوانی می‌کند تا event تعریف شده در contract را منتشر کند و سپس تأیید می‌کند که OrderHistoryEventHandlers، OrderHistoryDao را به درستی فراخوانی کرده است.
  </p>
<pre><code class="language-java">@RunWith(SpringRunner.class)
@SpringBootTest(classes= OrderHistoryEventHandlersTest.TestConfiguration.class,
webEnvironment= SpringBootTest.WebEnvironment.NONE)
@AutoConfigureStubRunner(ids =
{"net.chrisrichardson.ftgo.contracts:ftgo-order-service-contracts"},
workOffline = false)</code></pre>
<p>
<strong>Listing 10.7</strong>
   The consumer-side integration test for the OrderHistoryEventHandlers
   class
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0359_original/original_page.png" alt="Original Page 359">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<pre><code class="language-java">@DirtiesContext
public class OrderHistoryEventHandlersTest {
@Configuration
@EnableAutoConfiguration
@Import({OrderHistoryServiceMessagingConfiguration.class,
TramCommandProducerConfiguration.class,
TramInMemoryConfiguration.class,
EventuateContractVerifierConfiguration.class})
public static class TestConfiguration {
@Bean
public OrderHistoryDao orderHistoryDao() {
return mock(OrderHistoryDao.class);
  
}
}
@Test
public void shouldHandleOrderCreatedEvent() throws ... {
stubFinder.trigger("orderCreatedEvent");
         
eventually(() =&gt; {
      
verify(orderHistoryDao).addOrder(any(Order.class), any(Optional.class));
});
}</code></pre>
<p>
   The shouldHandleOrderCreatedEvent() test method، به Spring Cloud Contract می‌گوید که رویداد OrderCreated را منتشر کند. سپس تأیید می‌کند که OrderHistoryEventHandlers، orderHistoryDao.addOrder() را فراخوانی کرده است. تست کردن هم publisher domain event و هم consumer با استفاده از contract های یکسان، تضمین می‌کند که آنها در مورد API توافق دارند. اکنون بیایید نگاهی بیندازیم که چگونه service های integration test را انجام دهیم که با استفاده از request/response asynchronous تعامل دارند.
  </p>
<h4>10.1.4 Integration contract tests for asynchronous request/response</h4>
<p>
   Publish/subscribe، تنها سبک interaction مبتنی بر messaging نیست. service ها همچنین با استفاده از request/response asynchronous تعامل دارند. به عنوان مثال، در فصل 4 دیدیم که Order Service، sagas ها را پیاده‌سازی می‌کند که پیام‌های command را به service های مختلف، مانند Kitchen Service، ارسال می‌کند و به پیام‌های reply رسیدگی می‌کند.
  </p>
<p>
   دو طرف در یک تعامل request/response asynchronous، requestor هستند، که service ای است که command را ارسال می‌کند، و replier، که service ای است که به command رسیدگی می‌کند و یک reply را برمی‌گرداند. آنها باید در مورد نام کانال message command و ساختار پیام‌های command و reply توافق داشته باشند. بیایید نگاهی بیندازیم که چگونه integration tests ها را برای تعاملات request/response asynchronous بنویسیم.
  </p>
<p>
   شکل 10.5 نحوه تست کردن تعامل بین Order Service و Kitchen Service را نشان می‌دهد. رویکرد integration testing asynchronous request/response interactions، کاملاً شبیه به رویکردی است که برای تست کردن تعاملات REST استفاده می‌شود. تعاملات بین service ها توسط مجموعه‌ای از contract ها تعریف می‌شوند. چیزی که متفاوت است این است که یک contract، یک message ورودی و یک message خروجی را به جای یک request و reply HTTP مشخص می‌کند.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAArMAAAG9CAYAAADX3R5kAAAgAElEQVR4nO3dfZBU1ZXHP93xJgI7wZlM2cZmds10T+cI2N5Jd4b33f7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0360_original/original_page.png" alt="Original Page 360">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   The consumer-side test، تأیید می‌کند که کلاس proxy پیام command، message های command با ساختار صحیح را ارسال می‌کند و پیام‌های reply را به درستی پردازش می‌کند. در این مثال، KitchenServiceProxyTest کلاس KitchenServiceProxy را تست می‌کند. این از Spring Cloud Contract برای پیکربندی messaging stubs ها استفاده می‌کند که تأیید می‌کنند که message command، با message ورودی یک contract مطابقت دارد و با message خروجی مربوطه پاسخ می‌دهد.
  </p>
<p>
   The provider-side tests are code-generated by Spring Cloud Contract. Each test
   method corresponds to a contract. It sends the contract’s input message as a com-
   mand message and verifies that the reply message matches the contract’s output mes-
   sage. Let’s look at the details, starting with the contract.
  </p>
<p>
<strong>EXAMPLE ASYNCHRONOUS REQUEST/RESPONSE CONTRACT</strong>
</p>
<p>
   Listing 10.8، contract را برای یک interaction نشان می‌دهد. این شامل یک message ورودی و یک message خروجی است. هر دو message، یک message channel، بدنه پیام و message headers ها را مشخص می‌کنند.
   Convention نامگذاری از دیدگاه provider است. element messageFrom از message ورودی، کانالی را مشخص می‌کند که message از آن خوانده می‌شود.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAApwAAAEsCAYAAACbT7y2AAAgAElEQVR4nO3dfZBU1ZXHP93xJgI7wZlM2cZmds10T+cI2N5Jd4b33f7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0361_original/original_page.png" alt="Original Page 361">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   به طور مشابه، element sentTo از message خروجی، کانالی را مشخص می‌کند که reply باید به آن ارسال شود.
  </p>
<pre><code class="language-java">package contracts;
org.springframework.cloud.contract.spec.Contract.make {
label 'createTicket'
input {
    
messageFrom('kitchenService')
messageBody("{"orderId":1,"restaurantId":1,"ticketDetails":{...}}")
messageHeaders {
header('command_type','net.chrisrichardson...CreateTicket')
header('command_saga_type','net.chrisrichson...CreateOrderSaga')
header('command_saga_id',$(consumer(regex('[0-9a-f]{16}-[0-9a-f]
{16}'))))
header('command_reply_to','net.chrisrichardson...CreateOrderSaga-Reply')
}
}
outputMessage {
     
sentTo('net.chrisrichardson...CreateOrderSaga-reply')
body([
ticketId: 1
])
headers {
header('reply_type', 'net.chrisrichson...CreateTicketReply')
header('reply_outcome-type', 'SUCCESS')
}
}
}</code></pre>
<p>
   In this example contract, the input message is a CreateTicket command that’s sent to
   the kitchenService channel. The output message is a successful reply that’s sent to the
   CreateOrderSaga’s reply channel. Let’s look at how to use this contract in tests, start-
   ing with the consumer-side tests for Order Service.
  </p>
<p>
<strong>CONSUMER-SIDE CONTRACT INTEGRATION TEST FOR AN ASYNCHRONOUS REQUEST/RESPONSE
   INTERACTION</strong>
</p>
<p>
   استراتژی برای نوشتن یک consumer-side integration test برای یک interaction request/response asynchronous، مشابه تست کردن یک client REST است. تست، messaging proxy service را فراخوانی می‌کند و دو جنبه از رفتار آن را تأیید می‌کند. ابتدا، تأیید می‌کند که messaging proxy، یک message command را ارسال می‌کند که با contract مطابقت دارد. ثانیاً، تأیید می‌کند که proxy به درستی message reply را مدیریت می‌کند.
  </p>
<p>
   Listing 10.9 کلاس تست OrderServiceProxyIntegrationTest را نشان می‌دهد که تست consumer-side را برای KitchenServiceProxy انجام می‌دهد، که proxy messaging است که توسط Order Service برای فراخوانی Kitchen Service استفاده می‌شود. هر تست، یک message command را با استفاده از KitchenServiceProxy ارسال می‌کند و تأیید می‌کند که نتیجه مورد انتظار را برمی‌گرداند. این از Spring Cloud Contract برای پیکربندی messaging stubs ها برای
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAk4AAAD9CAYAAADxJzE0AAAgAElEQVR4nO3ddZBU1ZXHP93xJgI7wZlM2cZmds10T+cI2N5Jd4b33f7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0362_original/original_page.png" alt="Original Page 362">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   The consumer-side test، Kitchen Service، که contract ای را پیدا می‌کند که message ورودی آن با message command مطابقت دارد و message خروجی خود را به عنوان reply ارسال می‌کند. تست ها از messaging in-memory برای سادگی و سرعت استفاده می‌کنند.
  </p>
<pre><code class="language-java">@RunWith(SpringRunner.class)
@SpringBootTest(classes= 
KitchenServiceProxyIntegrationTest.TestConfiguration.class,
webEnvironment= SpringBootTest.WebEnvironment.NONE)
@AutoConfigureStubRunner(ids =
      
{"net.chrisrichardson.ftgo.contracts:ftgo-kitchen-service-contracts"},
workOffline = false)
@DirtiesContext
public class KitchenServiceProxyIntegrationTest {
@Configuration
@EnableAutoConfiguration
@Import({TramCommandProducerConfiguration.class,
TramInMemoryConfiguration.class,
EventuateContractVerifierConfiguration.class})
public static class TestConfiguration { ... }</code></pre>
<p>
   متد setUp()، یک OrderHistoryEventHandlers را ایجاد می‌کند که با یک OrderHistoryDao mock شده، تزریق شده است. هر متد تست ابتدا Spring Cloud را فراخوانی می‌کند تا event تعریف شده در contract را منتشر کند و سپس تأیید می‌کند که OrderHistoryEventHandlers، OrderHistoryDao را به درستی فراخوانی کرده است.
  </p>
<p>
   Listing 10.7، کلاس تست OrderHistoryEventHandlersTest را نشان می‌دهد.
  </p>
<p>
<pre><code class="language-java">@Autowired
private SagaMessagingTestHelper sagaMessagingTestHelper;
@Autowired
private
KitchenServiceProxy kitchenServiceProxy;
@Test
public void shouldSuccessfullyCreateTicket() {
CreateTicket command = new CreateTicket(AJANTA_ID,
OrderDetailsMother.ORDER_ID,
new TicketDetails(Collections.singletonList(
new TicketLineItem(CHICKEN_VINDALOO_MENU_ITEM_ID,
CHICKEN_VINDALOO,
CHICKEN_VINDALOO_QUANTITY))));
String sagaType = CreateOrderSaga.class.getName();
CreateTicketReply reply =
sagaMessagingTestHelper
      
.sendAndReceiveCommand(kitchenServiceProxy.create,
command,
CreateTicketReply.class, sagaType);
assertEquals(new CreateTicketReply(OrderDetailsMother.ORDER_ID), reply);</code></pre>
</p>
<p>
   متد shouldHandleOrderCreatedEvent() به Spring Cloud Contract می‌گوید رویداد OrderCreated را منتشر کند.
  </p>
<p>
   این تست،  KitchenService را پیکربندی می‌کند که به message ها پاسخ دهد.
  </p>
<p>
   The shouldSuccessfullyCreateTicket()
  </p>
<p>
<strong>Listing 10.9</strong>
   The consumer-side contract integration test for Order Service
  </p>
<p>
<p>
    متد، command را ارسال می‌کند و منتظر یک reply می‌ماند.
   </p>
</p>
<p>
   تأیید reply
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0363_original/original_page.png" alt="Original Page 363">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   متد shouldSuccessfullyCreateTicket()، یک message command از نوع CreateTicket را ارسال می‌کند و تأیید می‌کند که reply حاوی داده‌های مورد انتظار است. از SagaMessagingTestHelper، که یک کلاس helper تست است که به طور synchronous پیام‌ها را ارسال و دریافت می‌کند، استفاده می‌کند.
  </p>
<p>
   بیایید اکنون نگاهی بیندازیم که چگونه تست های integration provider-side را بنویسیم.
  </p>
<p>
<strong>WRITING PROVIDER-SIDE, CONSUMER-DRIVEN CONTRACT TESTS FOR ASYNCHRONOUS
   REQUEST/RESPONSE INTERACTIONS</strong>
</p>
<p>
   یک provider-side integration test باید تأیید کند که provider، یک message command را با ارسال reply صحیح مدیریت می‌کند. Spring Cloud Contract، کلاس‌های تستی را تولید می‌کند که دارای یک test method برای هر contract هستند. هر متد تست، message ورودی contract را به عنوان یک message command ارسال می‌کند و تأیید می‌کند که reply با message خروجی contract مطابقت دارد.
  </p>
<p>
   The provider-side integration tests for Kitchen Service، KitchenServiceCommandHandler را تست می‌کند. کلاس KitchenServiceCommandHandler یک message را با فراخوانی KitchenService مدیریت می‌کند. listing 10.10 کلاس AbstractKitchenServiceConsumerContractTest را نشان می‌دهد، که کلاس base برای تست های code-generated شده Spring Cloud Contract است. این کلاس، class  KitchenServiceCommandHandler را ایجاد می‌کند که با یک KitchenService mock شده، تزریق شده است.
  </p>
<pre><code class="language-java">@RunWith(SpringRunner.class)
@SpringBootTest(classes = 
AbstractKitchenServiceConsumerContractTest.TestConfiguration.class,
webEnvironment = SpringBootTest.WebEnvironment.NONE)
@AutoConfigureMessageVerifier
public abstract class AbstractKitchenServiceConsumerContractTest {
@Configuration
@Import(RestaurantMessageHandlersConfiguration.class)
public static class TestConfiguration {
...
@Bean
public KitchenService kitchenService() {
   
return mock(KitchenService.class);
}
}
@Autowired
private KitchenService kitchenService;
@Before
public void setup() {
reset(kitchenService);
when(kitchenService
.createTicket(eq(1L), eq(1L),
    
any(TicketDetails.class)))
.thenReturn(new Ticket(1L, 1L,</code></pre>
<p>
<strong>Listing 10.10</strong>
   Superclass of provider-side, consumer-driven contract tests for Kitchen
   Service
  </p>
<p>
   Invokes the
   trigger function
   that veriﬁes that the output
   message is published to the
   expected channel
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0364_original/original_page.png" alt="Original Page 364">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
<pre><code class="language-java">new TicketDetails(Collections.emptyList())));
}
}</code></pre>
</p>
<p>
   KitchenServiceCommandHandler، KitchenService را با آرگومان‌هایی که از message ورودی یک contract مشتق شده‌اند، فراخوانی می‌کند و یک message reply را ایجاد می‌کند که از value بازگشتی مشتق شده است. متد setup() کلاس تست، KitchenService را برای برگرداندن مقادیری که با message خروجی contract مطابقت دارند، پیکربندی می‌کند
  </p>
<p>
   Integration tests ها و unit tests ها رفتار بخش‌های فردی یک service را تأیید می‌کنند.
   Integration tests ها تأیید می‌کنند که service ها می‌توانند با clients و dependencies هایشان ارتباط برقرار کنند. unit tests ها تأیید می‌کنند که logic یک service صحیح است. هیچ یک از این نوع تست ها، کل service را اجرا نمی‌کنند. به منظور تأیید اینکه یک service به طور کلی کار می‌کند، ما به بالای هرم می‌رویم و نگاهی می‌اندازیم که چگونه component tests ها را بنویسیم.
  </p>
<h4>10.2</h4>
<h3>Developing component tests</h3>
<p>
   تاکنون، ما به نحوه تست کردن کلاس‌های فردی و clusters of classes نگاه کرده‌ایم. اما تصور کنید که اکنون می‌خواهیم تأیید کنیم که Order Service همانطور که انتظار می‌رود، کار می‌کند. به عبارت دیگر، ما می‌خواهیم acceptance tests های service را بنویسیم که آن را به عنوان یک جعبه سیاه در نظر می‌گیرند و رفتار آن را از طریق API آن تأیید می‌کنند. یک رویکرد این است که اساساً end-to-end tests ها را بنویسیم و Order Service و تمام dependencies های transitive آن را deploy کنیم. همانطور که اکنون باید بدانید، این یک روش slow، brittle و گران برای تست کردن یک service است.
  </p>
<p>
   یک راه بسیار بهتر برای نوشتن acceptance tests ها برای یک service، استفاده از component testing است. همانطور که شکل 10.6 نشان می‌دهد، component tests ها بین integration tests ها و end-to-end tests ها قرار دارند. Component testing، رفتار یک service را در isolation تأیید می‌کند. این، dependencies service را با stubs ها که رفتار آنها را شبیه‌سازی می‌کنند، جایگزین می‌کند. حتی ممکن است از versions های in-memory service های infrastructure مانند databases استفاده کند. در نتیجه، component tests ها نوشتن آنها بسیار آسان‌تر و اجرای آنها سریع‌تر است.
  </p>
<p>
   من با توصیف مختصر نحوه استفاده از یک DSL testing به نام Gherkin برای نوشتن acceptance tests ها برای service ها، مانند Order Service، شروع می‌کنم. پس از آن، من مسائل مختلف طراحی component testing را مورد بحث قرار می‌دهم. سپس نحوه نوشتن acceptance tests ها را برای Order Service نشان می‌دهم.
  </p>
<p>
   بیایید نگاهی به نوشتن acceptance tests ها با استفاده از Gherkin بیندازیم.
  </p>
<p>
   Pattern: Service component test
  </p>
<p>
   Test a service in isolation. See http://microservices.io/patterns/testing/service-
   component-test.html.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAlMAAABJCAYAAADkZgZRAAAgAElEQVR4nO3dfXwU5bX3/r7/f/VfA3M0aQxM/yR0z+j7X6Q+gO7u7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0365_original/original_page.png" alt="Original Page 365">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   The shouldSuccessfullyCreateTicket() test method sends a CreateTicket com-
   mand message and verifies that the reply contains the expected data. It uses Saga-
   MessagingTestHelper, which is a test helper class that synchronously sends and receives
   messages.
  </p>
<p>
   The consumer-driven contract integration tests for Order Service verify that its API
   meets its clients’ expectations. Listing 10.3 shows HttpBase, which is the base class
   for the test class code-generated by Spring Cloud Contract. It’s responsible for the
   setup phase of the test. It creates the controllers injected with mock dependencies
   and configures those mocks to return values that cause the controller to generate the
   expected response.
  </p>
<p>
   The shouldSaveAndLoadOrder() test method executes two transactions. The first
   saves a newly created Order in the database. The second transaction loads the Order
   and verifies that its fields are properly initialized.
  </p>
<p>
   In this example, the deployment pipeline is fully automated.
  </p>
<p>
   ...
  </p>
<p>
   Let’s now look at how to write provider-side integration tests.
  </p>
<p>
<strong>WRITING PROVIDER-SIDE, CONSUMER-DRIVEN CONTRACT TESTS FOR ASYNCHRONOUS
   REQUEST/RESPONSE INTERACTIONS</strong>
</p>
<p>
   A provider-side integration test must verify that the provider handles a command mes-
   sage by sending the correct reply. Spring Cloud Contract generates test classes that
   have a test method for each contract. Each test method sends the contract’s input
   message and verifies that the reply matches the contract’s output message.
  </p>
<p>
   The provider-side integration tests for Kitchen Service test KitchenService-
   CommandHandler. The KitchenServiceCommandHandler class handles a message by
   invoking KitchenService. The following listing shows the AbstractKitchenService-
   ConsumerContractTest class, which is the base class for the Spring Cloud Contract-
   generated tests. It creates a KitchenServiceCommandHandler injected with a mock
   KitchenService.
  </p>
<p>
<pre><code class="language-java">@RunWith(SpringRunner.class)
@SpringBootTest(classes = 
AbstractKitchenServiceConsumerContractTest.TestConfiguration.class,
webEnvironment = SpringBootTest.WebEnvironment.NONE)
@AutoConfigureStubRunner(ids =
      
{"net.chrisrichardson.ftgo.contracts:ftgo-kitchen-service-contracts"},
workOffline = false)</code></pre>
</p>
<p>
   ...
  </p>
<p>
   Let’s now look at how to write integration tests.
  </p>
<p>
<strong>10.2.1 Defining acceptance tests</strong>
</p>
<p>
   Acceptance tests، business-facing تست هایی برای یک component نرم‌افزاری هستند. آنها رفتار مورد نظر externally visible را از دیدگاه clients component به‌جای اصطلاحات implementation داخلی، شرح می‌دهند. این تست ها از user stories یا use cases ها مشتق شده‌اند. به عنوان مثال، یکی از key stories ها برای Order Service، داستان Place Order است:
  </p>
<p>
   As a consumer of the Order Service
   I should be able to place an order
  </p>
<p>
   We can expand this story into scenarios such as the following:
  </p>
<p>
   Given a valid consumer
  </p>
<p>
   Given using a valid credit card
  </p>
<p>
   Given the restaurant is accepting orders
  </p>
<p>
   When I place an order for Chicken Vindaloo at Ajanta
  </p>
<p>
   Then the order should be APPROVED
  </p>
<p>
   And an OrderAuthorized event should be published
  </p>
<p>
   This scenario describes the desired behavior of Order Service in terms of its API.
  </p>
<p>
   Each scenario defines an acceptance test. The givens correspond to the test’s setup
   phase, the when maps to the execute phase, and the then and the and to the verifica-
   tion phase. Later, you see a test for this scenario that does the following:
  </p>
<ol>
<li>
    Creates an Order by invoking the POST /orders endpoint
   </li>
<li>
    Verifies the state of the Order by invoking the GET /orders/{orderId} endpoint
   </li>
<li>
    Verifies that the Order Service published an OrderAuthorized event by sub-
    scribing to the appropriate message channel
   </li>
</ol>
<p>
   We could translate each scenario into Java code. An easier option, though, is to write
   the acceptance tests using a DSL such as Gherkin.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAArMAAAG9CAYAAADX3R5kAAAgAElEQVR4nO3dfZBU1ZXHP93xJgI7wZlM2cZmds10T+cI2N5Jd4b33f7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0366_original/original_page.png" alt="Original Page 366">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   The consumer-side test، همانند REST client است.
  </p>
<p>
   ..
  </p>
<p>
   The provider-side tests are code-generated by Spring Cloud Contract. Each test
   method sends the contract’s input
   message and verifies that the reply message matches the contract’s output mes-
   sage. Let’s look at the details, starting with the contract.
  </p>
<p>
   ...
  </p>
<p>
<strong>10.2.2 Writing acceptance tests using Gherkin</strong>
</p>
<p>
   نوشتن acceptance tests ها در جاوا چالش‌برانگیز است. این خطر وجود دارد که سناریوها و تست های جاوا متفاوت باشند. همچنین یک disconnect بین سناریوهای high-level و تست های جاوا وجود دارد، که شامل جزئیات implementation low-level می‌شوند. همچنین، این خطر وجود دارد که یک سناریو فاقد دقت یا مبهم باشد و نتواند به کد جاوا ترجمه شود.
  </p>
<p>
   یک رویکرد بسیار بهتر این است که مرحله ترجمه manual را حذف کنید و سناریوهای قابل اجرا بنویسید.
  </p>
<p>
   Gherkin یک DSL برای نوشتن مشخصات قابل اجرا است. هنگام استفاده از Gherkin، شما acceptance tests های خود را با استفاده از سناریوهای شبیه به انگلیسی، مانند نمونه‌ای که قبلاً نشان داده شد، تعریف می‌کنید. سپس مشخصات را با استفاده از Cucumber، یک فریم‌ورک test automation برای Gherkin، اجرا می‌کنید. Gherkin و Cucumber نیاز به ترجمه دستی سناریوها به کد قابل اجرا را از بین می‌برند.
  </p>
<p>
   مشخصات Gherkin برای یک service مانند Order Service، از مجموعه‌ای از features تشکیل شده است. هر feature، توسط مجموعه‌ای از سناریوها مانند موردی که قبلاً مشاهده کردید، توضیح داده می‌شود. A sce-
   nario has the given-when-then structure. The givens are the preconditions, the when is
   the action or event that occurs, and the then/and are the expected outcome.
  </p>
<p>
   به عنوان مثال، رفتار مورد نظر Order Service توسط چندین feature، از جمله Place Order، Cancel Order و Revise Order تعریف می‌شود. Listing 10.11، یک excerpt از feature Place Order است. این feature از چندین عنصر تشکیل شده است:
  </p>
<ul>
<li>
    Name—برای این feature، نام Place Order است.
   </li>
<li>
    Specification brief—این، توضیح می‌دهد که چرا feature وجود دارد. برای این feature، specification brief، user story است.
   </li>
<li>
    Scenarios—Order authorized و Order rejected due to expired credit card.
   </li>
</ul>
<pre><code class="language-java">Feature: Place Order
As a consumer of the Order Service
I should be able to place an order
Scenario: Order authorized
Given a valid consumer
Given using a valid credit card
Given the restaurant is accepting orders
When I place an order for Chicken Vindaloo at Ajanta
Then the order should be APPROVED
And an OrderAuthorized event should be published
Scenario: Order rejected due to expired credit card
Given a valid consumer
Given using an expired credit card
Given the restaurant is accepting orders
When I place an order for Chicken Vindaloo at Ajanta
Then the order should be REJECTED
And an OrderRejected event should be published
...</code></pre>
<p>
<strong>Listing 10.11</strong>
   The Gherkin definition of the Place Order feature and some of its scenarios
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0367_original/original_page.png" alt="Original Page 367">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   In both scenarios, a consumer attempts to place an order. In the first scenario, they
   succeed. In the second scenario, the order is rejected because the consumer’s credit
   card has expired. For more information on Gherkin, see the book Writing Great Specifi-
   cations: Using Specification by Example and Gherkin by Kamil Nicieja (Manning, 2017).
  </p>
<p>
<strong>EXECUTING GHERKIN SPECIFICATIONS USING CUCUMBER</strong>
</p>
<p>
   Cucumber، یک فریم‌ورک automated testing است که تست هایی را که در Gherkin نوشته شده‌اند، اجرا می‌کند.
   این در انواع مختلف زبان‌ها، از جمله جاوا، در دسترس است. هنگام استفاده از Cucumber برای جاوا، شما یک step definition class را می‌نویسید، مانند موردی که در listing 10.12 نشان داده شده است. یک step definition class، از متدهایی تشکیل شده است که معنای هر گام given-then-when را تعریف می‌کنند. هر step definition method با @Given، @When، @Then یا @And annotation نویسی شده است. هر یک از این annotations ها دارای یک value element هستند که یک regular expression است که Cucumber، آن را با گام‌ها مطابقت می‌دهد.
  </p>
<pre><code class="language-java">public class StepDefinitions ...
{
...
@Given("A valid consumer")
public void useConsumer() { ... }
@Given("using a(.?) (.*) credit card")
public void useCreditCard(String ignore, String creditCard) { ... }
@When("I place an order for Chicken Vindaloo at Ajanta")
public void placeOrder() { ... }
@Then("the order should be (.*)")
public void theOrderShouldBe(String desiredOrderState) { ... }
@And("an (.*) event should be published")
public void verifyEventPublished(String expectedEventClass)
{ ... }
}</code></pre>
<p>
   Each type of method is part of a particular phase of the test:
  </p>
<ul>
<li>
    @Given—The setup phase
   </li>
<li>
    @When—The execute phase
   </li>
<li>
    @Then and @And—The verification phase
   </li>
</ul>
<p>
   Later in section 10.2.4, when I describe this class in more detail, you’ll see that many
   of these methods make REST calls to Order Service. For example, the placeOrder()
   method creates Order by invoking the POST /orders REST endpoint. The the-
   OrderShouldBe() method verifies the status of the order by invoking GET /orders/
   {orderId}.
  </p>
<p>
   But before getting into the details of how to write step classes, let’s explore some
   design issues with component tests.
  </p>
<p>
<img page-images"="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAArMAAAG9CAYAAADX3R5kAAAgAElEQVR4nO3dfXxU5bX3/r7/f/VfA3M0aQxM/yR0z+j7X6Q+gO7u7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v7v
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="/>
</p></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</div>
                
            </div>
            <div class="page original-page">
                <img src="page_0368_original/original_page.png" alt="Original Page 368">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3>Testing microservices:</h3>
<p>
<strong>Part 2</strong>
</p>
<p>
   The consumer-side test، همانند REST client است.
  </p>
<p>
   ...
  </p>
<p>
   Listing 10.9 shows the consumer-side integration test for Order Service.
   تیم تولیدکننده، از این قراردادها برای تست Order Service استفاده می‌کند.
   This test suite, along with those contributed by other teams, is run by Order Service’s
   deployment pipeline.
  </p>
<p>
   ....
  </p>
<p>
<strong>10.2.2 Writing acceptance tests using Gherkin</strong>
</p>
<p>
   و هر دو، در مورد API توافق دارند. ما قبلاً به آن پرداختیم.
  </p>
<p>
   ...
  </p>
<p>
   The gherkin specification for a service such as Order Service consists of a set of fea-
   tures. Each feature is described by a set of scenarios such as the one you saw earlier. A sce-
   nario has the given-when-then structure. The givens are the preconditions, the when is
   the action or event that occurs, and the then/and are the expected outcome.
  </p>
<p>
   به عنوان مثال، رفتار مورد نظر Order Service توسط چندین feature، از جمله Place Order، Cancel Order و Revise Order تعریف می‌شود. Listing 10.11، یک excerpt از feature Place Order است. این feature از چندین عنصر تشکیل شده است:
  </p>
<ol>
<li>
    Name—برای این feature، نام Place Order است.
   </li>
<li>
    Specification brief—این، توضیح می‌دهد که چرا feature وجود دارد. برای این feature، specification brief، user story است.
   </li>
<li>
    Scenarios—Order authorized و Order rejected due to expired credit card.
   </li>
</ol>
<p>
<pre><code class="language-java">Feature: Place Order
As a consumer of the Order Service
I should be able to place an order
Scenario: Order authorized
Given a valid consumer
Given using a valid credit card
Given the restaurant is accepting orders
When I place an order for Chicken Vindaloo at Ajanta
Then the order should be APPROVED
And an OrderAuthorized event should be published
Scenario: Order rejected due to expired credit card
Given a valid consumer
Given using an expired credit card
Given the restaurant is accepting orders
When I place an order for Chicken Vindaloo at Ajanta
Then the order should be REJECTED
And an OrderRejected event should be published
...</code></pre>
</p>
<p>
<strong>Listing 10.11</strong>
   The Gherkin definition of the Place Order feature and some of its scenarios
  </p>
<p>
   به این می پردازیم که:
  </p>
<p>
   ...
  </p>
<p>
   Let’s look at the details, starting with the contract.
  </p>
<p>
   ...
  </p>
<p>
   و سپس بررسی میکنیم که برای چه چیزی از آن استفاده می‌کنیم.
  </p>
<h4>10.2.3 Designing component tests</h4>
<p>
   تصور کنید که شما در حال پیاده‌سازی component tests برای Order Service هستید. بخش 10.2.2 نشان می‌دهد که چگونه رفتار مورد نظر را با استفاده از Gherkin مشخص کنید و آن را با استفاده از Cucumber اجرا کنید. اما قبل از اینکه یک component test بتواند سناریوهای Gherkin را اجرا کند، باید ابتدا Order Service را اجرا کند و dependencies های service را راه‌اندازی کند. شما باید Order Service را در isolation تست کنید، بنابراین component test باید stubs ها را برای service های مختلف، از جمله Kitchen Service، پیکربندی کند. همچنین باید یک database و زیرساخت messaging را راه‌اندازی کند.
  </p>
<p>
   چندین گزینه مختلف وجود دارد که سرعت و سادگی را با هم مقایسه می‌کنند.
  </p>
<p>
<strong>IN-PROCESS COMPONENT TESTS</strong>
</p>
<p>
   یک گزینه، نوشتن in-process component tests ها است. یک in-process component test، service را با stubs ها و mocks های in-memory برای dependencies های آن اجرا می‌کند. به عنوان مثال، شما می‌توانید یک component test را برای یک service مبتنی بر Spring Boot با استفاده از فریم‌ورک testing Spring Boot بنویسید. یک test class که با @SpringBootTest annotation نویسی شده است، service را در همان JVM که تست در آن قرار دارد، اجرا می‌کند. از dependency injection برای پیکربندی service برای استفاده از mocks و stubs استفاده می‌کند. به عنوان مثال، یک تست برای Order Service، آن را پیکربندی می‌کند تا از یک database JDBC in-memory، مانند H2، HSQLDB یا Derby، و stubs های in-memory برای Eventuate Tram استفاده کند. In-process tests، نوشتن آنها ساده‌تر و سریع‌تر است، اما نقطه ضعف آن، تست نکردن service deployable است.
  </p>
<p>
<strong>OUT-OF-PROCESS COMPONENT TESTING</strong>
</p>
<p>
   یک رویکرد واقع‌بینانه‌تر، بسته بندی service در یک قالب production-ready و اجرای آن به عنوان یک process جداگانه است. به عنوان مثال، فصل 12 توضیح می‌دهد که بسته بندی service ها به عنوان container images های Docker، به طور فزاینده‌ای رایج است. An out-of-process component test از service های infrastructure واقعی، مانند databases و message brokers، استفاده می‌کند، اما از stubs ها برای هر گونه dependencies که application services هستند، استفاده می‌کند. به عنوان مثال، یک out-of-process component test برای FTGO Order Service، از MySQL و Apache Kafka، و stubs ها برای service ها از جمله Consumer Service و Accounting Service استفاده می‌کند. از آنجایی که Order Service با آن service ها با استفاده از messaging تعامل دارد، این stubs ها پیام‌ها را از Apache Kafka مصرف می‌کنند و پیام‌های reply را برمی‌گردانند.
  </p>
<p>
   یک مزیت کلیدی of out-of-process component testing این است که coverage تست را بهبود می‌بخشد، زیرا آنچه تست می‌شود، بسیار نزدیک‌تر به چیزی است که deploy می‌شود. نقطه ضعف این است که نوشتن این نوع تست، اجرا کردن آن کندتر، و به‌طور بالقوه brittleتر از یک in-process component test است. همچنین شما باید نحوه stub کردن application services ها را بفهمید. بیایید نگاهی بیندازیم که چگونه این کار را انجام دهیم.
  </p>
<p>
<strong>HOW TO STUB SERVICES IN OUT-OF-PROCESS COMPONENT TESTS</strong>
</p>
<p>
   Service under test اغلب dependencies ها را با استفاده از interaction styles هایی که شامل ارسال یک response هستند، فراخوانی می‌کند. Order Service، به عنوان مثال، از request/response asynchronous استفاده می‌کند و پیام‌های command را به service های مختلف ارسال می‌کند. API Gateway از HTTP استفاده می‌کند، که یک interaction style از نوع request/response است. یک out-of-process test، باید stubs ها را برای این نوع dependencies ها، که requests ها را مدیریت می‌کنند و reply ها را برمی‌گردانند، پیکربندی کند.
  </p>
<p>
   One option is to use Spring Cloud Contract, which we looked at earlier in sec-
   tion 10.1 when discussing integration tests. We could write contracts that configure
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0369_original/original_page.png" alt="Original Page 369">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 10</span></h3>
<h3><span style="font-weight: bold;">Testing microservices: Part 2</span></h3>
<p>
   stubs برای component tests. یک نکته که باید در نظر گرفت این است که احتمالاً این
   contracts، برخلاف آنهایی که برای integration استفاده می‌شوند، فقط توسط component tests استفاده خواهند شد.
   یکی دیگر از معایب استفاده از Spring Cloud Contract برای component testing این است که
   به دلیل تمرکز آن بر روی consumer contract testing، یک رویکرد نسبتاً سنگین وزن را در پیش می‌گیرد.
   فایل‌های JAR شامل contracts باید در یک Maven repository مستقر شوند، نه اینکه فقط در classpath باشند.
   مدیریت تعاملات شامل مقادیر تولید شده به صورت پویا نیز چالش برانگیز است. در نتیجه، یک گزینه ساده‌تر
   این است که stubs را از داخل خود test پیکربندی کنید.
  </p>
<p>
   به عنوان مثال، یک test می‌تواند یک HTTP stub را با استفاده از WireMock stubbing
   DSL پیکربندی کند. به طور مشابه، یک test برای یک service که از Eventuate Tram messaging استفاده می‌کند می‌تواند
   messaging stubs را پیکربندی کند. در ادامه این بخش، یک کتابخانه Java آسان برای استفاده را نشان می‌دهم که این کار را انجام می‌دهد.
  </p>
<p>
   اکنون که به نحوه طراحی component tests پرداختیم، بیایید در نظر بگیریم که چگونه
   component tests را برای FTGO Order Service بنویسیم.
  </p>
<h4><span style="font-weight: bold;">10.2.4 نوشتن component tests برای FTGO Order Service</span></h4>
<p>
   همانطور که قبلاً در این بخش دیدید، چند روش مختلف برای پیاده‌سازی compo-
   nent tests وجود دارد. این بخش component tests برای Order Service را توصیف می‌کند که از
   استراتژی out-of-process برای تست service در حال اجرا به عنوان یک Docker container استفاده می‌کند. خواهید دید
   که چگونه tests از یک Gradle plugin برای شروع و توقف Docker container استفاده می‌کنند. من در مورد نحوه
   استفاده از Cucumber برای اجرای سناریوهای مبتنی بر Gherkin که رفتار مورد نظر را تعریف می‌کنند، بحث خواهم کرد.
   برای Order Service.
  </p>
<p>
<img alt="تصویری از طرح تست" src="figure_10_7.png" width="500"/>
   Figure 10.7 نحوه طراحی component tests برای Order Service را نشان می‌دهد. Order-
   ServiceComponentTest، کلاس test است که Cucumber را اجرا می‌کند:
  </p>
<pre><code class="language-java">
  @RunWith(Cucumber.class)
  @CucumberOptions(features = "src/component-test/resources/features")
  public class OrderServiceComponentTest {
  }
  </code></pre>
<p>
   این یک annotation به نام @CucumberOptions دارد که مشخص می‌کند کجا فایل‌های Gherkin
   را پیدا کند. همچنین با @RunWith(Cucumber.class) annotation شده است، که به JUNIT
   می‌گوید از Cucumber test runner استفاده کند. اما بر خلاف یک کلاس test مبتنی بر JUNIT معمولی،
   هیچ متد test ندارد. در عوض، تست‌ها را با خواندن Gherkin تعریف می‌کند
   features و از کلاس OrderServiceComponentTestStepDefinitions برای اجرایی کردن آنها استفاده می‌کند.
  </p>
<p>
   استفاده از Cucumber با Spring Boot testing framework به یک ساختار کمی غیرمعمول نیاز دارد.
   علیرغم اینکه یک کلاس test نیست، OrderServiceComponentTestStepDefinitions
   هنوز با @ContextConfiguration annotation شده است، که بخشی از Spring Testing
   framework است. این Spring ApplicationContext را ایجاد می‌کند، که مؤلفه‌های مختلف Spring، از جمله messaging stubs را تعریف می‌کند. بیایید نگاهی به جزئیات step definitions بیندازیم.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0370_original/original_page.png" alt="Original Page 370">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Developing component tests</span></h3>
<h4><span style="font-weight: bold;">THE ORDERSERVICECOMPONENTTESTSTEPDEFINITIONS CLASS</span></h4>
<p>
   The OrderServiceComponentTestStepDefinitions class هسته اصلی tests است. این
   class، معنی هر step را در component tests از Order Service تعریف می‌کند.
   فهرست زیر، متد usingCreditCard() را نشان می‌دهد، که معنی step به صورت Given using … credit card را تعریف می‌کند.
  </p>
<pre><code class="language-java">
  @ContextConfiguration(classes =
  OrderServiceComponentTestStepDefinitions.TestConfiguration.class)
  public class OrderServiceComponentTestStepDefinitions {
  ...
  @Autowired
  protected SagaParticipantStubManager sagaParticipantStubManager;
  @Given("using a(.?) (.*) credit card")
  public void useCreditCard(String ignore, String creditCard) {
  if (creditCard.equals("valid"))
  sagaParticipantStubManager
  .forChannel("accountingService")
  .when(AuthorizeCommand.class).replyWithSuccess();
  else if (creditCard.equals("invalid"))
  sagaParticipantStubManager
  </code></pre>
<p>
   Listing 10.13
   متد @GivenuseCreditCard()، معنی step به صورت Given using … credit card را تعریف می‌کند.
  </p>
<p>
   As a consumer of the Order Service
   I should be able to create an order
   Scenario: Order authorized
   Given a valid consumer
   Given using a valid credit card
   dockerCompose {
   ...
   }
  </p>
<pre><code class="language-yaml">
  ftgo-order-service:
  build: .
  ports:
  - "8082:8080"
  </code></pre>
<p>
   OrderService
   Component
   Test
   Order Service
   docker
   container
   src/component-test/resources/
   createorder.feature
   Docker-compose.yml
   build.gradle
   Written using the
   Cucumber testing framework
   Kafka
   MySQL
   Invokes
   REST API
   Runs
   Runs
   Runs
   Reads command
   and sends
   replies
   Reads events
   Reads
   Uses
   Uses
   OrderService
   Component
   Step
   Deﬁnitions
  </p>
<p>
   Figure 10.7
   The component tests for Order Service از Cucumber testing framework برای
   execute tests scenarios که با استفاده از Gherkin acceptance testing DSL نوشته شده‌اند، استفاده می‌کنند. The tests از Docker برای اجرا
   Order Service به همراه زیرساخت serviceهای آن، مانند Apache Kafka و MySQL استفاده می‌کنند.
   Send a
   success reply.
   Send a failure
   reply.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0371_original/original_page.png" alt="Original Page 371">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 10</span></h3>
<h3><span style="font-weight: bold;">Testing microservices: Part 2</span></h3>
<p>
   .forChannel("accountingService")
   .when(AuthorizeCommand.class).replyWithFailure();
   else
   fail("Don't know what to do with this credit card");
  </p>
<p>
   این متد از کلاس SagaParticipantStubManager استفاده می‌کند، یک کلاس test helper که
   stubs را برای participants از saga پیکربندی می‌کند. متد useCreditCard() از آن برای پیکربندی
   Accounting Service stub استفاده می‌کند تا با یک پیام success یا failure پاسخ دهد،
   بسته به credit card مشخص شده.
  </p>
<p>
   فهرست زیر متد placeOrder() را نشان می‌دهد، که When I را تعریف می‌کند
   place an order for Chicken Vindaloo at Ajanta step. این متد Order Service را فراخوانی می‌کند
   REST API برای ایجاد Order و پاسخ را برای اعتبارسنجی در یک step بعدی ذخیره می‌کند.
  </p>
<pre><code class="language-java">
  @ContextConfiguration(classes =
  OrderServiceComponentTestStepDefinitions.TestConfiguration.class)
  public class OrderServiceComponentTestStepDefinitions {
  private int port = 8082;
  private String host = System.getenv("DOCKER_HOST_IP");
  protected String baseUrl(String path) {
  return String.format("http://%s:%s%s", host, port, path);
  }
  private Response response;
  @When("I place an order for Chicken Vindaloo at Ajanta")
  public void placeOrder() {
  response = given().
  body(new CreateOrderRequest(consumerId,
  RestaurantMother.AJANTA_ID, Collections.singletonList(
  new CreateOrderRequest.LineItem(
  RestaurantMother.CHICKEN_VINDALOO_MENU_ITEM_ID,
  OrderDetailsMother.CHICKEN_VINDALOO_QUANTITY)))).
  contentType("application/json").
  when().
  post(baseUrl("/orders"));
  }
  </code></pre>
<p>
   متد help baseUrl() ، URL از order service را برمی‌گرداند.
  </p>
<p>
   Listing 10.15 متد theOrderShouldBe() را نشان می‌دهد، که معنی
   Then the order should be … step. این تایید می‌کند که Order با موفقیت ایجاد شده است
   و در state مورد انتظار قرار دارد.
  </p>
<p>
   Listing 10.14
   متد placeOrder() ، When I place an order for
   Chicken Vindaloo at Ajanta step را تعریف می‌کند.
  </p>
<p>
   Invokes the Order
   Service REST API
   to create Order
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0372_original/original_page.png" alt="Original Page 372">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Developing component tests</span></h3>
<pre><code class="language-java">
  @ContextConfiguration(classes =
  OrderServiceComponentTestStepDefinitions.TestConfiguration.class)
  public class OrderServiceComponentTestStepDefinitions {
  @Then("the order should be (.*)")
  public void theOrderShouldBe(String desiredOrderState) {
  Integer orderId =
  this.response. then(). statusCode(200).
  extract(). path("orderId");
  assertNotNull(orderId);
  eventually(() -&gt; {
  String state = given().
  when().
  get(baseUrl("/orders/" + orderId)).
  then().
  statusCode(200)
  .extract().
  path("state");
  assertEquals(desiredOrderState, state);
  });
  }
  </code></pre>
<p>
   The assertion از state مورد انتظار در یک call به eventually() قرار گرفته است، که
   به طور مکرر assertion را اجرا می‌کند.
  </p>
<p>
   فهرست زیر متد verifyEventPublished() را نشان می‌دهد، که
   the And an … event should be published step را تعریف می‌کند. این تایید می‌کند که domain مورد انتظار
   event منتشر شده است.
  </p>
<pre><code class="language-java">
  @ContextConfiguration(classes =
  OrderServiceComponentTestStepDefinitions.TestConfiguration.class)
  public class OrderServiceComponentTestStepDefinitions {
  @Autowired
  protected MessageTracker messageTracker;
  @And("an (.*) event should be published")
  public void verifyEventPublished(String expectedEventClass) throws ClassNot
  FoundException {
  messageTracker.assertDomainEventPublished("net.chrisrichardson.ftgo.order
  service.domain.Order",
  </code></pre>
<p>
   Listing 10.15
   متد @ThentheOrderShouldBe() تایید می‌کند که HTTP request
   موفقیت آمیز بوده است.
  </p>
<p>
   Listing 10.16
   کلاس step definitions از Cucumber برای component tests از Order Service
  </p>
<p>
   Verify that Order
   was created
   successfully.
   Verify the
   state of
   Order.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0373_original/original_page.png" alt="Original Page 373">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 10</span></h3>
<h3><span style="font-weight: bold;">Testing microservices: Part 2</span></h3>
<pre><code class="language-java">
  (Class&lt;DomainEvent&gt;)Class.forName("net.chrisrichardson.ftgo.order
  service.domain." + expectedEventClass));
  }
  ....
  }
  </code></pre>
<p>
   متد verifyEventPublished() از کلاس MessageTracker استفاده می‌کند، یک کلاس test helper
   که events را که در طول test منتشر شده‌اند، ثبت می‌کند. این class
   و SagaParticipantStubManager توسط کلاس TestConfiguration
   @Configuration ایجاد می‌شوند.
  </p>
<p>
   اکنون که به step definitions پرداختیم، بیایید ببینیم چگونه component tests را اجرا کنیم.
  </p>
<h4><span style="font-weight: bold;">RUNNING THE COMPONENT TESTS</span></h4>
<p>
   از آنجایی که این tests نسبتاً کند هستند، ما نمی‌خواهیم آنها را به عنوان بخشی از ./gradlew
   test اجرا کنیم. در عوض، ما کد test را در یک دایرکتوری جداگانه src/component-test/java قرار می‌دهیم
   و آنها را با استفاده از ./gradlew componentTest اجرا می‌کنیم. به ftgo-order-service/ نگاهی بیندازید
   build.gradle file تا پیکربندی Gradle را ببینید.
  </p>
<p>
   The tests از Docker برای اجرای Order Service و وابستگی‌های آن استفاده می‌کنند. همانطور که در
   فصل 12 توضیح داده شد، یک Docker container یک مکانیزم مجازی سازی سیستم عامل سبک است که
   به شما امکان می‌دهد یک نمونه service را در یک sandbox ایزوله مستقر کنید. Docker
   Compose یک ابزار فوق العاده مفید است که با آن می‌توانید مجموعه‌ای از containers را تعریف کنید
   و آنها را به عنوان یک واحد شروع و متوقف کنید. برنامه FTGO دارای یک docker-compose file است
   در root directory که containers را برای همه services و زیرساخت‌ها تعریف می‌کند.
   service.
  </p>
<p>
   ما می‌توانیم از Gradle Docker Compose plugin برای اجرای containers قبل از exe-
   cuting the tests و متوقف کردن containers پس از اتمام tests استفاده کنیم:
  </p>
<pre><code class="language-groovy">
  apply plugin: 'docker-compose'
  dockerCompose.isRequiredBy(componentTest)
  componentTest.dependsOn(assemble)
  dockerCompose {
  startedServices = [ 'ftgo-order-service']
  }
  </code></pre>
<p>
   The preceding snippet of Gradle configuration دو کار را انجام می‌دهد. اول، پیکربندی می‌کند
   Gradle Docker Compose plugin برای اجرا قبل از component tests و شروع
   Order Service به همراه زیرساخت services که برای وابستگی به آن پیکربندی شده است.
   دوم، componentTest را پیکربندی می‌کند تا به assemble وابسته باشد تا فایل JAR
   مورد نیاز توسط Docker image ابتدا ساخته شود. با وجود این، ما می‌توانیم این com-
   ponent tests را با دستورات زیر اجرا کنیم:
  </p>
<p>
   ./gradlew
   :ftgo-order-service:componentTest
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0374_original/original_page.png" alt="Original Page 374">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Writing end-to-end tests</span></h3>
<p>
   Those commands، که چند دقیقه طول می‌کشد، اقدامات زیر را انجام می‌دهند:
  </p>
<ol>
<li>Build Order Service.</li>
<li>Run the service و زیرساخت serviceهای آن.</li>
<li>Run the tests.</li>
<li>Stop the running services.</li>
</ol>
<p>
   اکنون که به نحوه تست یک service در isolation پرداختیم، خواهیم دید که چگونه کل
   application را تست کنیم.
  </p>
<h4><span style="font-weight: bold;">10.3 Writing end-to-end tests</span></h4>
<p>
   Component testing هر service را جداگانه تست می‌کند. با این حال، end-to-end testing،
   کل application را تست می‌کند. همانطور که شکل 10.8 نشان می‌دهد، end-to-end testing در بالای test pyra-
   mid قرار دارد. به این دلیل که این نوع tests - با من تکرار کنید - slow, brittle و
   زمان بر هستند.
  </p>
<p>
   End-to-end tests دارای تعداد زیادی moving parts هستند. شما باید چندین ser-
   vices و زیرساخت serviceهای پشتیبان آنها را مستقر کنید. در نتیجه، end-to-end tests slow هستند.
   همچنین، اگر test شما نیاز به استقرار تعداد زیادی service دارد، احتمال زیادی وجود دارد
   که یکی از آنها در استقرار شکست بخورد و tests غیرقابل اعتماد شوند. در نتیجه، شما باید
   تعداد end-to-end tests را به حداقل برسانید.
  </p>
<h4><span style="font-weight: bold;">10.3.1 Designing end-to-end tests</span></h4>
<p>
   همانطور که توضیح دادم، بهتر است تا حد امکان کمتر از این موارد بنویسید. یک استراتژی خوب این است که
   user journey tests را بنویسید. یک user journey test با یک user’s journey از طریق
   system مطابقت دارد. به عنوان مثال، به جای تست create order، revise order و cancel order sep-
   به طور جداگانه، می‌توانید یک test واحد بنویسید که هر سه مورد را انجام دهد. این رویکرد به طور قابل توجهی
   تعداد tests را که باید بنویسید کاهش می‌دهد و زمان اجرای test را کوتاه می‌کند.
  </p>
<p>
   End-to-end
   Component
   Integration
   Unit
   End-to-end
   test
   Tests
   Service
   Service 1
   Service 2
   Service ...
  </p>
<p>
   Figure 10.8
   End-to-end tests در بالای test pyramid قرار دارند. آنها slow, brittle و زمان
   بر هستند. شما باید تعداد end-to-end tests را به حداقل برسانید.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0375_original/original_page.png" alt="Original Page 375">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 10</span></h3>
<h3><span style="font-weight: bold;">Testing microservices: Part 2</span></h3>
<h4><span style="font-weight: bold;">10.3.2 Writing end-to-end tests</span></h4>
<p>
   End-to-end tests هستند، مانند acceptance tests که در بخش 10.2 پوشش داده شدند، business-facing
   tests. منطقی است که آنها را در یک DSL سطح بالا بنویسیم که توسط افراد business درک می‌شود. شما می‌توانید، به عنوان مثال،
   end-to-end tests را با استفاده از Gherkin بنویسید و آنها را با استفاده از Cucumber اجرا کنید. فهرست زیر نمونه‌ای از این
   test را نشان می‌دهد. این test مشابه acceptance tests است که قبلاً به آنها نگاه کردیم. تفاوت اصلی این است که به جای
   یک Then واحد، این test چندین action دارد.
  </p>
<p>
   Feature: Place Revise and Cancel
   As a consumer of the Order Service
   I should be able to place, revise, and cancel an order
   Scenario: Order created, revised, and cancelled
   Given a valid consumer
   Given using a valid credit card
   Given the restaurant is accepting orders
   When I place an order for Chicken Vindaloo at Ajanta
   Then the order should be APPROVED
   Then the order total should be 16.33
   And when I revise the order by adding 2 vegetable samosas
   Then the order total should be 20.97
   And when I cancel the order
   Then the order should be CANCELLED
  </p>
<p>
   This scenario یک order را place می‌کند، آن را revise می‌کند و سپس آن را cancel می‌کند. بیایید ببینیم چگونه آن را اجرا کنیم.
  </p>
<h4><span style="font-weight: bold;">10.3.3 Running end-to-end tests</span></h4>
<p>
   End-to-end tests باید کل application، از جمله هرگونه infrastructure service مورد نیاز را اجرا کنند. همانطور که در
   بخش 10.2 قبلاً دیدید، Gradle Docker Compose plugin یک راه مناسب برای انجام این کار ارائه می‌دهد. به جای اجرای یک application service واحد،
   Docker Compose file تمام services از application را اجرا می‌کند.
  </p>
<p>
   اکنون که به جنبه‌های مختلف طراحی و نوشتن end-to-end tests پرداختیم، بیایید یک نمونه end-to-end test را ببینیم.
  </p>
<p>
   ماژول ftgo-end-to-end-test end-to-end tests را برای application FTGO پیاده‌سازی می‌کند. پیاده‌سازی end-to-end test کاملاً مشابه
   implementation از component tests است که قبلاً در بخش 10.2 مورد بحث قرار گرفت. این tests
   با استفاده از Gherkin نوشته شده و با استفاده از Cucumber اجرا می‌شوند. Gradle Docker Compose
   plugin containers را قبل از اجرای tests اجرا می‌کند. شروع containers و اجرای tests حدود چهار تا پنج دقیقه طول می‌کشد.
  </p>
<p>
   ممکن است این زمان زیادی به نظر نرسد، اما این یک application نسبتاً ساده با
   فقط تعداد انگشت شماری از containers و tests است. تصور کنید اگر صدها containers وجود داشت
   و تعداد زیادی tests دیگر. تست‌ها می‌توانند زمان زیادی ببرند. در نتیجه، بهتر است روی
   نوشتن tests که در پایین هرم قرار دارند تمرکز کنید.
  </p>
<p>
   Listing 10.17
   A Gherkin-based specification of a user journey
   Create
   Order.
   Revise
   Order.
   Cancel
   Order.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0376_original/original_page.png" alt="Original Page 376">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Summary</span></h3>
<p>
   Use contracts, which are example messages, to drive the testing of interactions
   between services. Rather than write slow-running tests that run both services
   and their transitive dependencies, write tests that verify that the adapters of
   both services conform to the contracts.
  </p>
<p>
   Write component tests to verify the behavior of a service via its API. You should
   simplify and speed up component tests by testing a service in isolation, using
   stubs for its dependencies.
  </p>
<p>
   Write user journey tests to minimize the number of end-to-end tests, which are
   slow, brittle, and time consuming. A user journey test simulates a user’s journey
   through the application and verifies high-level behavior of a relatively large
   slice of the application’s functionality. Because there are few tests, the amount
   of per-test overhead, such as test setup, is minimized, which speeds up the tests.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0377_original/original_page.png" alt="Original Page 377">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Developing</span></h3>
<h3><span style="font-weight: bold;">production-ready services</span></h3>
<p>
   Mary و تیمش احساس می‌کردند که بر service decomposition, interservice
   communication, transaction management, querying و business logic design و
   testing مسلط شده‌اند. آنها مطمئن بودند که می‌توانند services را توسعه دهند که نیازهای func-
   tional خود را برآورده کنند. اما برای اینکه یک service آماده استقرار در
   production باشد، آنها باید اطمینان حاصل می‌کردند که سه ویژگی کیفیت بسیار مهم را نیز برآورده می‌کند: security، configurability و observability.
  </p>
<p>
   این فصل موارد زیر را پوشش می‌دهد:
  </p>
<p>
   Developing secure services
   Applying the Externalized configuration pattern
   Applying the observability patterns:
  </p>
<ul>
<li>– Health check API</li>
<li>– Log aggregation</li>
<li>– Distributed tracing</li>
<li>– Exception tracking</li>
<li>– Application metrics</li>
<li>– Audit logging</li>
</ul>
<p>
   Simplifying the development of services by
   applying the Microservice chassis pattern
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0378_original/original_page.png" alt="Original Page 378">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Developing secure services</span></h3>
<p>
   The first quality attribute is application security. It’s essential to develop secure appli-
   cations, unless you want your company to be in the headlines for a data breach. Fortu-
   nately, most aspects of security in a microservice architecture are not any different
   than in a monolithic application. The FTGO team knew that much of what they had
   learned over the years developing the monolith also applied to microservices. But the
   microservice architecture forces you to implement some aspects of application-level
   security differently. For example, you need to implement a mechanism to pass the
   identity of the user from one service to another.
  </p>
<p>
   The second quality attribute you must address is service configurability. A service typ-
   ically uses one or more external services, such as message brokers and databases. The
   network location and credentials of each external service often depend on the envi-
   ronment that the service is running in. You can’t hard-wire the configuration proper-
   ties into the service. Instead, you must use an externalized configuration mechanism
   that provides a service with configuration properties at runtime.
  </p>
<p>
   The third quality attribute is observability. The FTGO team had implemented
   monitoring and logging for the existing application. But a microservice architecture
   is a distributed system, and that presents some additional challenges. Every request
   is handled by the API gateway and at least one service. Imagine, for example, that
   you’re trying to determine which of six services is causing a latency issue. Or imag-
   ine trying to understand how a request is handled when the log entries are scattered
   across five different services. In order to make it easier to understand the behavior
   of your application and troubleshoot problems, you must implement several observ-
   ability patterns.
  </p>
<p>
   I begin this chapter by describing how to implement security in a microservice
   architecture. Next, I discuss how to design services that are configurable. I cover a
   couple of different service configuration mechanisms. After that I talk about how to
   make your services easier to understand and troubleshoot by using the observability
   patterns. I end the chapter by showing how to simplify the implementation of these
   and other concerns by developing your services on top of a microservice chassis
   framework.
  </p>
<p>
   Let’s first look at security.
  </p>
<h4><span style="font-weight: bold;">11.1 Developing secure services</span></h4>
<p>
   Cybersecurity has become a critical issue for every organization. Almost every day
   there are headlines about how hackers have stolen a company’s data. In order to
   develop secure software and stay out of the headlines, an organization needs to
   tackle a diverse range of security issues, including physical security of the hardware,
   encryption of data in transit and at rest, authentication و authorization و pol-
   icies for patching software vulnerabilities. Most of these issues are the same regard-
   less of whether you’re using a monolithic or microservice architecture. This section
   focuses on how the microservice architecture impacts security at the application
   level.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0379_original/original_page.png" alt="Original Page 379">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<p>
   یک توسعه‌دهنده application در درجه اول مسئول پیاده‌سازی چهار جنبه مختلف
   از security است:
  </p>
<p>
   Authentication—Verifying the identity از application یا human (a.k.a. the
   principal) که در تلاش برای دسترسی به application است. به عنوان مثال، یک applica-
   tion معمولاً credentials از یک principal، مانند user ID و password یا
   یک API key و secret از application را تأیید می‌کند.
  </p>
<p>
   Authorization—Verifying that the principal مجاز به انجام عملیات درخواستی است
   بر روی data مشخص شده. Applications اغلب از ترکیبی از role-
   based security و access control lists (ACLs) استفاده می‌کنند. Role-based security به هر
   user یک یا چند role اختصاص می‌دهد که به آنها اجازه می‌دهد operations خاصی را فراخوانی کنند.
   ACLs به users یا roles اجازه می‌دهند تا یک operation را روی یک partic-
   ular business object یا aggregate انجام دهند.
  </p>
<p>
   Auditing—Tracking the operations که یک principal برای شناسایی انجام می‌دهد
   security issues، کمک به customer support و اجرای compliance.
  </p>
<p>
   Secure interprocess communication—ایده‌آل، همه communication در داخل و خارج از ser-
   vices باید از طریق Transport Layer Security (TLS) باشد. Interservice communica-
   tion ممکن است حتی نیاز به استفاده از authentication داشته باشد.
  </p>
<p>
   I describe auditing in detail در بخش 11.3 و به secure interservice com-
   munication هنگام بحث در مورد service meshes در بخش 11.4.1 اشاره می‌کنم. این بخش بر روی
   implementing authentication و authorization متمرکز است.
  </p>
<p>
   I begin by first describing how security is implemented in the FTGO monolith
   application. I then describe the challenges with implementing security in a microser-
   vice architecture و اینکه چگونه تکنیک‌هایی که در یک monolithic architecture خوب عمل می‌کنند نمی‌توانند
   در یک microservice architecture استفاده شوند. بعد از آن، من نحوه پیاده‌سازی security را پوشش می‌دهم
   در یک microservice architecture.
  </p>
<p>
   Let’s start by reviewing how the monolithic FTGO application handles security.
  </p>
<h4><span style="font-weight: bold;">11.1.1 Overview of security in a traditional monolithic application</span></h4>
<p>
   The FTGO application دارای چندین نوع human users است، از جمله consumers, cou-
   riers و restaurant staff. آنها با استفاده از browser-based web به application دسترسی دارند
   applications و mobile applications. All FTGO users باید برای دسترسی به appli-
   cation وارد شوند. شکل 11.1 نشان می‌دهد که چگونه clients از monolithic FTGO application authen-
   ticate کرده و requests را انجام می‌دهند.
  </p>
<p>
   When a user logs in with their user ID و password، client یک POST
   request حاوی credentials کاربر را به FTGO application ارسال می‌کند. FTGO appli-
   cation credentials را تأیید می‌کند و یک session token را به client برمی‌گرداند. The client
   session token را در هر request بعدی به FTGO application قرار می‌دهد.
  </p>
<p>
   Figure 11.2 یک نمای سطح بالا از نحوه پیاده‌سازی FTGO application از secu-
   rity را نشان می‌دهد. The FTGO application در Java نوشته شده است و از Spring Security framework استفاده می‌کند،
   اما من design را با استفاده از اصطلاحات عمومی که برای سایر frame-
   works، مانند Passport for NodeJS قابل استفاده هستند، توضیح خواهم داد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0380_original/original_page.png" alt="Original Page 380">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Developing secure services</span></h3>
<p>
   One key part of the security architecture is the session, which stores the principal’s ID
   و roles. The FTGO application یک application سنتی Java EE است، بنابراین session یک
   HttpSession in-memory session است. A session توسط یک session token شناسایی می‌شود، که
   client در هر request آن را قرار می‌دهد. این معمولاً یک token opaque مانند یک cryptographi-
   cally strong random number است. The FTGO application’s session token یک HTTP است
   cookie به نام JSESSIONID.
  </p>
<p>
   The other key part of the security implementation، security context است که
   اطلاعاتی در مورد user که request فعلی را انجام می‌دهد، ذخیره می‌کند. The Spring Security
  </p>
<h4><span style="font-weight: bold;">Using a security framework</span></h4>
<p>
   Implementing authentication و authorization به درستی چالش برانگیز است. بهتر است
   از یک security framework اثبات شده استفاده کنید. اینکه کدام framework را استفاده کنید به application’s technology stack شما بستگی دارد. برخی از frameworks محبوب عبارتند از:
  </p>
<p>
   Spring Security (https://projects.spring.io/spring-security/)—A popular frame-
   work برای Java applications. It’s a sophisticated framework که authentication و authorization را مدیریت می‌کند.
  </p>
<p>
   Apache Shiro (https://shiro.apache.org)—Another Java framework.
  </p>
<p>
   Passport (http://www.passportjs.org)—A popular security framework for NodeJS
   applications که بر authentication متمرکز است.
  </p>
<p>
   Log in to obtain session
   token, which is a cookie.
   Include session token cookie,
   which identiﬁes the user, in
   subsequent requests.
   Consumer
   restaurant
   courier
   Browser
   or mobile
   application
   POST /login
   id=...
   password=...
   HTTP/1.1 200 OK
   Set-cookie: JSESSIONID=...
   ...
   GET /orders/order-xyz
   Cookie: JSESSIONID=...
   FTGO
   application
  </p>
<p>
   Figure 11.1
   A client از FTGO application ابتدا برای به دست آوردن یک session token وارد می‌شود، که اغلب یک
   cookie است. The client session token را در هر request بعدی که به application ارسال می‌کند، قرار می‌دهد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0381_original/original_page.png" alt="Original Page 381">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<p>
   framework از رویکرد استاندارد Java EE برای ذخیره security context در یک
   static, thread-local variable استفاده می‌کند، که به راحتی برای هر کدی که برای han-
   dle کردن request فراخوانی می‌شود، در دسترس است. A request handler می‌تواند SecurityContextHolder.getContext() را فراخوانی کند
   .getAuthentication() تا اطلاعاتی در مورد user فعلی، مانند their
   identity و roles، به دست آورد. در مقابل، Passport framework، security context را به عنوان
   the user attribute از request ذخیره می‌کند.
  </p>
<p>
   The sequence of events نشان داده شده در شکل 11.2 به شرح زیر است:
  </p>
<ol>
<li>The client یک login request را به FTGO application انجام می‌دهد.</li>
<li>The login request توسط LoginHandler، که credentials را تأیید می‌کند، cre-
    ates the session و اطلاعاتی در مورد principal را در session ذخیره می‌کند، مدیریت می‌شود.</li>
<li>Login Handler یک session token را به client برمی‌گرداند.</li>
<li>The client session token را در requests که operations را فراخوانی می‌کنند، قرار می‌دهد.</li>
<li>These requests ابتدا توسط SessionBasedSecurityInterceptor پردازش می‌شوند. The
    interceptor هر request را با تأیید session token authenticates می‌کند و یک security context ایجاد می‌کند. The security context principal و roles آن را توصیف می‌کند.</li>
</ol>
<p>
   User
   database
   Log in with user ID
   and password.
   Initializes
   Provides session cookie
   Establishes
   Reads
   Return session cookie.
   Jane
   Login-based
   client
   SessionBased
   Security
   Interceptor
   OrderDetails
   RequestHandler
   UserId: jane
   rules: [CONSUMER]
   ...
   UserId: jane
   rules: [CONSUMER]
   ...
   Login
   handler
   POST /login
   userId-Jane&amp;password=..
   HTTP/1.1 200 OK
   Set-cookie: JSESSIONID=...
   ...
   GET /orders/order-xyz
   Cookie: JSESSIONID=...
   FTGO application
   Retrieves user information
   from database
   Reads
   Establishes
   Security context
   Session
  </p>
<p>
   Figure 11.2
   When a client از FTGO application یک login request انجام می‌دهد، Login Handler the را authenticates می‌کند
   user، information of the session user را initialises می‌کند و یک session token cookie را برمی‌گرداند، که به طور ایمن مشخص می‌کند
   session. Next, when the client makes a request containing the session token, SessionBasedSecurity-
   Interceptor اطلاعات user را از session مشخص شده بازیابی می‌کند و security context را ایجاد می‌کند.
   Request handlers, such as OrderDetailsRequestHandler، اطلاعات user را از security
   context.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0382_original/original_page.png" alt="Original Page 382">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Developing secure services</span></h3>
<p>
   6
   A request handler از security context برای تعیین اینکه آیا به یک
   user اجازه داده شود که operation درخواستی را انجام دهد و identity آنها را به دست آورد، استفاده می‌کند.
  </p>
<p>
   The FTGO application از role-based authorization استفاده می‌کند. این چندین role را تعریف می‌کند corre-
   sponding to the different kinds of users، از جمله CONSUMER, RESTAURANT, COURIER,
   و ADMIN. It uses Spring Security’s declarative security mechanism برای محدود کردن دسترسی به
   URLs و service methods به roles خاص. Roles همچنین در business logic در هم تنیده شده‌اند. به عنوان مثال، یک consumer فقط می‌تواند به orders خود دسترسی داشته باشد، در حالی که یک adminis-
   trator می‌تواند به همه orders دسترسی داشته باشد.
  </p>
<p>
   The security design مورد استفاده توسط monolithic FTGO application تنها یک راه ممکن است
   برای پیاده‌سازی security. به عنوان مثال، یک نقطه ضعف استفاده از یک in-memory session
   این است که به همه requests برای یک session خاص نیاز دارد که به همان applica-
   tion instance هدایت شوند. این requirement load balancing و operations را پیچیده می‌کند. شما باید،
   به عنوان مثال، یک session draining mechanism را پیاده‌سازی کنید که منتظر می‌ماند تا همه sessions
   منقضی شوند قبل از خاموش کردن یک application instance. A alternative approach، که
   از این مشکلات اجتناب می‌کند، این است که session را در یک database ذخیره کنید.
  </p>
<p>
   You can sometimes eliminate the server-side session entirely. به عنوان مثال، بسیاری
   applications دارای API clients هستند که credentials خود را ارائه می‌دهند، مانند یک API key و
   secret, in every request. در نتیجه، نیازی به نگهداری از یک server-side session نیست.
   Alternatively, the application می‌تواند session state را در session token ذخیره کند. Later in
   این بخش، من یک راه برای استفاده از session token برای ذخیره session state را توضیح می‌دهم. But
   let’s begin by looking at the challenges of implementing security in a microservice
   architecture.
  </p>
<h4><span style="font-weight: bold;">11.1.2 Implementing security in a microservice architecture</span></h4>
<p>
   A microservice architecture یک distributed architecture است. Each external request است
   توسط API gateway و حداقل یک service مدیریت می‌شود. به عنوان مثال، get-
   OrderDetails() query، که در فصل 8 مورد بحث قرار گرفت. The API gateway این query را با
   فراخوانی چندین service، از جمله Order Service, Kitchen Service و Accounting
   Service. Each service باید برخی از جنبه‌های security را پیاده‌سازی کند. به عنوان مثال، Order
   Service باید فقط به یک consumer اجازه دهد تا orders آنها را ببیند، که نیاز به ترکیبی از authentication و authorization دارد. In order to implement security in a micros-
   ervice architecture ما باید تعیین کنیم که چه کسی مسئول authenticating است
   user و چه کسی مسئول authorization است.
  </p>
<p>
   One challenge با implementing security در یک microservices application این است که ما
   فقط نمی‌توانیم design را از یک monolithic application کپی کنیم. That’s because two aspects of
   the monolithic application’s security architecture برای یک microservice nonstarters است
   architecture:
  </p>
<p>
   In-memory security context—استفاده از یک in-memory security context، مانند یک thread-
   local, to pass around user identity. Services نمی‌توانند memory را به اشتراک بگذارند، بنابراین نمی‌توانند
   از یک in-memory security context، مانند یک thread-local، برای انتقال استفاده کنید
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0383_original/original_page.png" alt="Original Page 383">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<p>
   user identity. In a microservice architecture, ما به یک mechanism متفاوت برای
   passing user identity از یک service به service دیگر نیاز داریم.
  </p>
<p>
   Centralized session—به دلیل اینکه یک in-memory security context منطقی نیست،
   یک in-memory session نیز منطقی نیست. In theory، چندین services می‌توانند به یک
   database-based session دسترسی داشته باشند، به جز اینکه اصل loose cou-
   pling را نقض می‌کند. We need a different session mechanism در یک microservice architecture.
  </p>
<p>
   Let’s begin our exploration of security در یک microservice architecture by looking at
   چگونه authentication را مدیریت کنیم.
  </p>
<h4><span style="font-weight: bold;">HANDLING AUTHENTICATION IN THE API GATEWAY</span></h4>
<p>
   There are a couple of different ways to handle authentication. One option این است که
   services فردی user را authenticate کنند. The problem با این رویکرد این است که
   requests unauthenticated را برای ورود به internal network مجاز می‌کند. It relies on every
   development team به درستی security را در تمام services خود پیاده‌سازی می‌کند. در نتیجه،
   یک risk قابل توجه از یک application حاوی security vulnerabilities وجود دارد.
  </p>
<p>
   Another problem با implementing authentication در services این است که differ-
   ent clients به روش‌های مختلف authenticate می‌شوند. Pure API clients credentials را با
   هر request با استفاده از، به عنوان مثال، basic authentication فراهم می‌کنند. Other clients ممکن است ابتدا وارد شوند
   و سپس یک session token را با هر request ارائه دهند. ما می‌خواهیم از نیاز به services اجتناب کنیم
   برای مدیریت یک مجموعه متنوع از authentication mechanisms.
  </p>
<p>
   A better approach این است که API gateway یک request را قبل از forward-
   ing آن به services authenticate کند. Centralizing API authentication در API gateway دارای
   این مزیت است که فقط یک مکان برای درست کردن وجود دارد. در نتیجه، یک شانس بسیار کوچکتر
   از یک security vulnerability وجود دارد. Another benefit این است که فقط API gateway باید
   با authentication mechanisms مختلف سروکار داشته باشد. It hides this complexity
   از services.
  </p>
<p>
   شکل 11.3 نشان می‌دهد که این رویکرد چگونه کار می‌کند. Clients با API gate-
   way authenticate می‌شوند. API clients credentials را در هر request قرار می‌دهند. Login-based clients POST
   the user’s credentials را به authentication API gateway’s می‌کند و یک session token دریافت می‌کند.
   Once the API gateway یک request را authenticated کرده است، یک یا چند service را فراخوانی می‌کند.
   A service که توسط API gateway فراخوانی می‌شود، باید principal making the request را بداند.
   It must also verify که request authenticated شده است. The solution این است که API
   gateway یک token را در هر service request قرار دهد. The service از token برای vali-
   date کردن request و به دست آوردن اطلاعات در مورد principal استفاده می‌کند. The API gateway might
   همچنین همان token را به clients session-oriented بدهد تا به عنوان session token استفاده شود.
  </p>
<p>
   Pattern: Access token
   The API gateway یک token حاوی اطلاعات در مورد user، مانند their
   identity و their roles, to the services که آن را فراخوانی می‌کند، منتقل می‌کند. See http://microservices.io/
   patterns/security/access-token.html.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0384_original/original_page.png" alt="Original Page 384">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Developing secure services</span></h3>
<p>
   The sequence of events for API clients به شرح زیر است:
  </p>
<ol>
<li>A client یک request حاوی credentials را انجام می‌دهد.</li>
<li>The API gateway credentials را authenticate می‌کند، یک security token ایجاد می‌کند و
    آن را به service یا services منتقل می‌کند.</li>
</ol>
<p>
   The sequence of events for login-based clients به شرح زیر است:
  </p>
<ol>
<li>A client یک login request حاوی credentials را انجام می‌دهد.</li>
<li>The API gateway یک security token را برمی‌گرداند.</li>
<li>The client security token را در requests که operations را فراخوانی می‌کنند، قرار می‌دهد.</li>
<li>The API gateway security token را تأیید می‌کند و آن را به service یا
    services forward می‌کند.</li>
</ol>
<p>
   A little later در این فصل، من نحوه پیاده‌سازی tokens را توضیح می‌دهم، اما بیایید ابتدا به
   the other main aspect از security: authorization نگاهی بیندازیم.
  </p>
<p>
   Order
   Service
   API clients supply credentials
   in the Authorization header.
   Pass token to services so
   that they can identify and
   authorize the user.
   Include the security token
   in each request.
   Login clients ﬁrst obtain
   a security token.
   Authentication
   Interceptor
   API gateway
   Login-based
   client
   GET /orders/1
   Authorization: ...CREDENTIALS...
   ...
   GET /orders/1
   ...SECURITY_TOKEN...
   HTTP/1.1 200 OK
   ...SECURITY_TOKEN...
   GET /orders/1
   ...SECURITY_TOKEN...
   POST /login
   id=...
   password=...
   API client
  </p>
<p>
   Figure 11.3
   The API gateway requests را از clients authenticates می‌کند و یک security token را در requests قرار می‌دهد
   it makes to services. The services از token برای به دست آوردن اطلاعات در مورد principal استفاده می‌کنند. The API gateway می‌تواند
   همچنین از security token به عنوان یک session token استفاده کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0385_original/original_page.png" alt="Original Page 385">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<h4><span style="font-weight: bold;">HANDLING AUTHORIZATION</span></h4>
<p>
   Authenticating a client’s credentials مهم است اما کافی نیست. An application
   همچنین باید یک authorization mechanism را پیاده‌سازی کند که تأیید کند که client مجاز
   به انجام operation درخواستی است. به عنوان مثال، در FTGO application
   the getOrderDetails() query فقط می‌تواند توسط consumer که Order را place کرده است (یک نمونه از instance-based security) و یک customer service agent که
   به consumer کمک می‌کند، فراخوانی شود.
  </p>
<p>
   One place برای implement authorization، API gateway است. It can, for example,
   دسترسی به GET /orders/{orderId} را فقط به users که consumers و cus-
   tomer service agents هستند، محدود می‌کند. If a user isn’t allowed به دسترسی به یک path خاص، API gateway
   می‌تواند request را قبل از ارسال آن به service رد کند. As with authentication،
   centralizing authorization در داخل API gateway، خطر security vulnera-
   bilities را کاهش می‌دهد. You can implement authorization در API gateway با استفاده از یک security frame-
   work، مانند Spring Security.
  </p>
<p>
   One drawback از implementing authorization در API gateway این است که ریسک
   coupling the API gateway به services، که نیاز به به‌روزرسانی آنها در lockstep دارد.
   What’s more, the API gateway می‌تواند معمولاً فقط role-based access را به URL
   paths پیاده‌سازی کند. It’s generally not practical برای API gateway برای پیاده‌سازی ACLs که کنترل
   access به individual domain objects، زیرا این کار نیاز به دانش دقیقی از ser-
   vice’s domain logic دارد.
  </p>
<p>
   The other place برای implement authorization در services است. A service می‌تواند imple-
   ment role-based authorization برای URLs و برای service methods. It can also implement
   ACLs برای مدیریت دسترسی به aggregates. Order Service می‌تواند، به عنوان مثال، the
   role-based و ACL-based authorization mechanism را برای کنترل دسترسی به orders پیاده‌سازی کند.
   Other services در FTGO application logic authorization مشابهی را پیاده‌سازی می‌کنند.
  </p>
<h4><span style="font-weight: bold;">USING JWTS TO PASS USER IDENTITY AND ROLES</span></h4>
<p>
   When implementing security در یک microservice architecture، شما باید تصمیم بگیرید که کدام
   type از token یک API gateway باید برای انتقال اطلاعات user به services استفاده کند.
  </p>
<p>
   There are two types از tokens برای انتخاب. One option این است که از opaque tokens استفاده کنید،
   که معمولاً UUIDs هستند. The downside از opaque tokens این است که performance را کاهش می‌دهند
   و availability و latency را افزایش می‌دهند. That’s because recipient از چنین
   token باید یک synchronous RPC call را به یک security service انجام دهد تا token را تأیید کند
   و اطلاعات user را بازیابی کند.
  </p>
<p>
   An alternative approach، که تماس با security service را حذف می‌کند، استفاده از a
   transparent token حاوی اطلاعات در مورد user است. One such popular standard
   برای transparent tokens the JSON Web Token (JWT) است. JWT یک روش استاندارد برای ایمن
   represent claims، مانند user identity و roles، بین دو طرف است. A JWT یک pay-
   load دارد، که یک object از نوع JSON است که حاوی اطلاعاتی در مورد user، مانند their
   identity و roles و other metadata، مانند an expiration date است. It’s signed with a
   secret که فقط برای creator از JWT، مانند API gateway و the
   recipient از JWT، مانند یک service شناخته شده است. The secret تضمین می‌کند که یک third party مخرب
   can’t forge یا tamper با یک JWT.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0386_original/original_page.png" alt="Original Page 386">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Developing secure services</span></h3>
<p>
   One issue با JWT این است که به دلیل اینکه یک token خودمحصور است، غیرقابل برگشت است. By
   design، یک service عملیات request را پس از تأیید signature و
   expiration date از JWT انجام می‌دهد. As a result، هیچ راه عملی برای revoking یک JWT مجزا وجود ندارد
   که به دست یک third party مخرب افتاده باشد. The solution این است که JWTs را صادر کنیم
   با short expiration times، زیرا این امر آنچه را که یک party مخرب می‌تواند انجام دهد، محدود می‌کند. One
   drawback از JWTs با عمر کوتاه، این است که application باید به نوعی به طور مداوم
   JWTs را دوباره صادر کند تا session فعال بماند. Fortunately, این یکی از many protocols است
   که توسط یک standard security به نام OAuth 2.0 حل می‌شوند. Let’s look at how that works.
  </p>
<h4><span style="font-weight: bold;">USING OAUTH 2.0 IN A MICROSERVICE ARCHITECTURE</span></h4>
<p>
   Let’s say شما می‌خواهید یک User Service را برای FTGO application که man-
   ages یک user database حاوی اطلاعات user، مانند credentials و roles است، پیاده‌سازی کنید. The
   API gateway User Service را فراخوانی می‌کند تا یک client request را authenticate کند و یک JWT به دست آورد.
   You could design a User Service API و آن را با استفاده از your favorite web frame-
   work پیاده‌سازی کنید. But that’s generic functionality که به FTGO application مربوط نمی‌شود -
   توسعه چنین service، استفاده کارآمد از منابع توسعه نخواهد بود.
  </p>
<p>
   Fortunately, شما نیازی به توسعه این نوع زیرساخت security ندارید. You can
   از یک service یا framework آماده که یک standard به نام OAuth 2.0 را پیاده‌سازی می‌کند، استفاده کنید.
   OAuth 2.0 یک authorization protocol است که در اصل برای فعال کردن یک user از
   a public cloud service، مانند GitHub یا Google، برای اعطای یک third-party application
   access به اطلاعات خود بدون آشکار کردن password آن. For example, OAuth 2.0 است
   the mechanism که به شما امکان می‌دهد به طور ایمن به یک سرویس Continuous مبتنی بر cloud third party (CI)
   service access به GitHub repository خود.
  </p>
<p>
   Although the original focus از OAuth 2.0 authorizing access به public cloud
   services بود، شما همچنین می‌توانید از آن برای authentication و authorization در application خود استفاده کنید.
   Let’s take a quick look at how a microservice architecture ممکن است از OAuth 2.0 استفاده کند.
  </p>
<p>
   The key concepts در OAuth 2.0 به شرح زیر است:
  </p>
<p>
   
   Authorization Server—یک API برای authenticating users و به دست آوردن فراهم می‌کند
   یک access token و یک refresh token. Spring OAuth یک مثال عالی از a است
   framework برای ساختن یک OAuth 2.0 authorization server.
  </p>
<p>
   
   Access Token—A token که به یک Resource Server access می‌دهد. The format از
   the access token به پیاده‌سازی وابسته است. But some implementations،
   مانند Spring OAuth، از JWTs استفاده می‌کنند.
  </p>
<h4><span style="font-weight: bold;">About OAuth 2.0</span></h4>
<p>
   OAuth 2.0 یک موضوع پیچیده است. In this chapter، من فقط می‌توانم یک مرور کلی مختصر ارائه کنم و
   توضیح دهید که چگونه می‌توان از آن در یک microservice architecture استفاده کرد. For more information
   on OAuth 2.0، check out the online book OAuth 2.0 Servers by Aaron Parecki
   (www.oauth.com). فصل 7 از Spring Microservices in Action (Manning, 2017) نیز
   این موضوع را پوشش می‌دهد (https://livebook.manning.com/#!/book/spring-microservices-in-
   action/chapter-7/).
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0387_original/original_page.png" alt="Original Page 387">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<p>
   
   Refresh Token—A long-lived yet revocable token که یک Client برای به دست آوردن استفاده می‌کند
   یک AccessToken جدید.
  </p>
<p>
   
   Resource Server—A service که از یک access token برای authorize access استفاده می‌کند. In a
   microservice architecture, the services، resource servers هستند.
  </p>
<p>
   
   Client—A client که می‌خواهد به یک Resource Server دسترسی داشته باشد. In a microservice
   architecture, API Gateway، the OAuth 2.0 client است.
  </p>
<p>
   Later در این بخش، من نحوه پشتیبانی از login-based clients را توضیح می‌دهم. But first، بیایید در مورد
   چگونه authenticate API clients صحبت کنیم.
  </p>
<p>
   Figure 11.4 نشان می‌دهد که چگونه API gateway یک request را از یک API client authenticate می‌کند.
   The API gateway API client را با انجام یک request به OAuth 2.0 authenticates می‌کند
   authorization server، که یک access token را برمی‌گرداند. The API gateway سپس یک
   یا بیشتر requests که شامل access token هستند، به services ارسال می‌کند.
  </p>
<p>
   The sequence of events نشان داده شده در شکل 11.4 به شرح زیر است:
  </p>
<ol>
<li>The client یک request را انجام می‌دهد و credentials خود را با استفاده از basic authentication ارائه می‌دهد.</li>
<li>The API gateway یک OAuth 2.0 Password Grant request را انجام می‌دهد (www.oauth.com/
    oauth2-servers/access-tokens/password-grant/) به OAuth 2.0 authentication
    server.</li>
</ol>
<p>
   Order
   Service
   User
   database
   Contains the user
   ID و their roles
   Password grant request
   API gateway
   Spring OAuth2
   Authentication
   Server
   GET /orders/1
   Authorization: Basic...
   ....
   POST/oauth/token
   userid=...&amp;password=...
   GET /orders/1
   Authorization: Bearer AccessToken
   HTTP/1.1 200 OK
   ...
   {
   "access_token": "AccessToken"
   ...
   }
   API client
  </p>
<p>
   Figure 11.4
   An API gateway یک API client را با انجام یک Password Grant request به OAuth 2.0 authenticates می‌کند
   authentication server. The server یک access token را برمی‌گرداند، که API gateway به services منتقل می‌کند. A service
   the token’s signature را تأیید می‌کند و اطلاعاتی در مورد user، از جمله identity و roles آنها، استخراج می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0388_original/original_page.png" alt="Original Page 388">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Developing secure services</span></h3>
<p>
   3
   The authentication server credentials از API client را تأیید می‌کند و
   یک access token و یک refresh token را برمی‌گرداند.
  </p>
<p>
   4
   The API gateway access token را در requests که به ser-
   vices ارسال می‌کند، قرار می‌دهد. A service access token را تأیید می‌کند و از آن برای authorization درخواست استفاده می‌کند.
  </p>
<p>
   An OAuth 2.0-based API gateway می‌تواند login-based clients را با استفاده از یک
   OAuth 2.0 access token به عنوان یک session token authenticates کند. What’s more، وقتی access token
   منقضی می‌شود، می‌تواند یک access token جدید با استفاده از refresh token به دست آورد. Figure 11.5 نشان می‌دهد که چگونه
   یک API gateway می‌تواند از OAuth 2.0 برای مدیریت login-based clients استفاده کند. An API cli-
   ent یک session را با POSTing credentials خود به API gateway’s /login end-
   point آغاز می‌کند. The API gateway یک access token و یک refresh token را به client برمی‌گرداند. The
   API client سپس هر دو token را زمانی که requests را به API gateway انجام می‌دهد، ارائه می‌دهد.
  </p>
<p>
   The sequence of events به شرح زیر است:
  </p>
<ol>
<li>The login-based client credentials خود را به API gateway ارسال می‌کند.</li>
<li>The API gateway’s Login Handler یک OAuth 2.0 Password Grant request را انجام می‌دهد
    (www.oauth.com/oauth2-servers/access-tokens/password-grant/) به OAuth
    2.0 authentication server.</li>
</ol>
<p>
   Order
   Service
   User
   database
   Password grant request
   API gateway
   Spring OAuth2
   Authentication
   Server
   POST/login
   userId=...&amp;password=...
   GET/orders/1
   Cookie: access_token=...;refresh_token...
   HTTP/1.1 200 OK
   Set-Cookie: access_token=...
   Set-Cookie:refresh_token=...
   POST/oauth/token
   userid=...&amp;password=...
   GET /orders/1
   Authorization: Bearer AccessToken
   HTTP/1.1 200 OK
   ...
   {
   "access_token": "AccessToken"
   ...
   }
   Login-based
   client
   Login
   handler
   Session
   authentication
   interceptor
  </p>
<p>
   Figure 11.5
   A client logs in by POSTing its credentials to the API gateway. The API gateway authenticates the
   credentials با استفاده از OAuth 2.0 authentication server و access token و refresh token را به عنوان cookies برمی‌گرداند.
   A client این tokens را در requests که به API gateway انجام می‌دهد، قرار می‌دهد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0389_original/original_page.png" alt="Original Page 389">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<p>
   3
   The authentication server credentials از client را تأیید می‌کند و access
   token و یک refresh token را برمی‌گرداند.
  </p>
<p>
   4
   The API gateway access و refresh tokens را به client - به عنوان cookies، برمی‌گرداند،
   به عنوان مثال.
  </p>
<p>
   5
   The client access و refresh tokens را در requests که به API
   gateway انجام می‌دهد، قرار می‌دهد.
  </p>
<p>
   6
   The API gateway’s Session Authentication Interceptor the access را تأیید می‌کند
   token و آن را در requests که به services انجام می‌دهد، قرار می‌دهد.
  </p>
<p>
   If the access token منقضی شده است یا در شرف منقضی شدن است، API gateway یک new
   access token را با انجام یک OAuth 2.0 Refresh Grant request (www.oauth.com/
   oauth2-servers/access-tokens/refreshing-access-tokens/)، که حاوی refresh است
   token, to the authorization server. If the refresh token منقضی نشده است یا revok شده است،
   the authorization server یک access token جدید را برمی‌گرداند. API Gateway the new را منتقل می‌کند
   access token به services و آن را به client برمی‌گرداند.
  </p>
<p>
   An important benefit از استفاده از OAuth 2.0 این است که یک standard security اثبات شده است.
   Using an off-the-shelf OAuth 2.0 Authentication Server یعنی شما مجبور نیستید
   زمان را با دوباره اختراع کردن چرخ یا ریسک توسعه یک design ناامن تلف کنید. But OAuth
   2.0 تنها راه برای پیاده‌سازی security در یک microservice architecture نیست. Regardless
   از اینکه از کدام رویکرد استفاده می‌کنید، سه ایده کلیدی به شرح زیر است:
  </p>
<p>
   The API gateway مسئول authenticating clients است.
  </p>
<p>
   The API gateway و services از یک transparent token، مانند یک JWT، برای انتقال استفاده می‌کنند
   اطلاعات در مورد principal.
  </p>
<p>
   A service از token برای به دست آوردن identity و roles از principal استفاده می‌کند.
  </p>
<p>
   اکنون که نحوه ایمن‌سازی services را بررسی کردیم، بیایید ببینیم چگونه آنها را
   configurable کنیم.
  </p>
<h4><span style="font-weight: bold;">11.2 Designing configurable services</span></h4>
<p>
   Imagine که شما مسئول Order History Service هستید. As figure 11.6 نشان می‌دهد، the
   service events را از Apache Kafka مصرف می‌کند و items از جدول AWS DynamoDB را می‌خواند و می‌نویسد.
   In order for this service to run، به properties configuration مختلف نیاز دارد،
   از جمله network location از Apache Kafka و credentials و network loca-
   tion برای AWS DynamoDB.
  </p>
<p>
   The values از این configuration properties به این بستگی دارد که service در کدام environment در حال اجرا است.
   For example, the developer و production environments will
   از different Apache Kafka brokers و credentials مختلف AWS استفاده کنید. It doesn’t make
   sense to hard-wire a particular environment’s configuration property values into the
   deployable service because that would require it to be rebuilt for each environment.
   Instead, a service باید یک بار توسط deployment pipeline ساخته شود و در آن مستقر شود
   محیط‌های متعدد
  </p>
<p>
   Nor does it make sense to hard-wire sets مختلفی از configuration properties into
   the source code و استفاده از، به عنوان مثال، Spring Framework’s profile mechanism برای
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0390_original/original_page.png" alt="Original Page 390">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Designing configurable services</span></h3>
<p>
   select the appropriate set at runtime. That’s because انجام این کار یک secu-
   rity vulnerability را معرفی می‌کند و جایی را که می‌تواند مستقر شود، محدود می‌کند. Additionally, sensitive data مانند
   credentials باید با استفاده از یک secrets storage mechanism، مانند
   Hashicorp Vault (www.vaultproject.io) یا AWS Parameter Store (https://docs.aws
   .amazon.com/systems-manager/latest/userguide/systems-manager-paramstore.html)، به طور ایمن ذخیره شود.
  </p>
<p>
   Instead, شما باید configuration properties مناسب را در service ارائه دهید
   runtime با استفاده از Externalized configuration pattern.
  </p>
<p>
   An externalized configuration mechanism، configuration property values را فراهم می‌کند
   به یک service instance در runtime. There are two main approaches:
  </p>
<p>
   Push model—زیرساخت استقرار، configuration properties را منتقل می‌کند
   به service instance با استفاده از، به عنوان مثال، operating system environment vari-
   ables یا یک configuration file.
  </p>
<p>
   Pull model—The service instance، configuration properties خود را از a con-
   figuration server می‌خواند.
  </p>
<p>
   We’ll look at each approach، starting with the push model.
  </p>
<p>
   Pattern: Externalized configuration
   Supply configuration property values, such as database credentials و network
   location, to a service at runtime. See http://microservices.io/patterns/externalized-
   configuration.html.
  </p>
<p>
   Order
   History
   Service
   Environment-speciﬁc conﬁguration
   Environment-speciﬁc conﬁguration
   Apache
   Kafka
   consumer
   Apache Kafka
   bootstrap.servers=kafka1:9092
   ..
   aws.access.key.id=...
   aws.secret.access.key=...
   aws.region=...
   «Order event channel»
   DynamoDB
   adapter
   AWS DynamoDB
   «Delivery event channel»
  </p>
<p>
   Figure 11.6
   Order History Service از Apache Kafka و AWS DynamoDB استفاده می‌کند. It needs to be
   با network location، credentials و غیره هر service پیکربندی شده است.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0391_original/original_page.png" alt="Original Page 391">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<h4><span style="font-weight: bold;">11.2.1 Using push-based externalized configuration</span></h4>
<p>
   The push model به collaboration از deployment environment و the
   service متکی است. The deployment environment configuration properties را فراهم می‌کند
   زمانی که یک service instance را ایجاد می‌کند. It might, as figure 11.7 shows، configuration prop-
   erties را به عنوان environment variables منتقل کند. Alternatively, the deployment environment ممکن است sup-
   ply the configuration properties با استفاده از یک configuration file. The service instance سپس
   configuration properties را زمانی که راه‌اندازی می‌شود، می‌خواند.
  </p>
<p>
   The deployment environment و the service باید در مورد نحوه configuration
   properties توافق داشته باشند. The precise mechanism به specific deployment
   environment بستگی دارد. For example, فصل 12 نحوه مشخص کردن environment را توضیح می‌دهد
   variables از یک Docker container.
  </p>
<p>
   Let’s imagine که شما تصمیم گرفته‌اید تا externalized configuration property
   values با استفاده از environment variables ارائه دهید. Your application می‌تواند System.getenv() را فراخوانی کند
   to obtain their values. But if you’re a Java developer، احتمالاً شما از یک frame-
   work استفاده می‌کنید که یک mechanism راحت‌تر ارائه می‌دهد. The FTGO services با استفاده از
   Spring Boot ساخته شده‌اند، که یک extremely flexible externalized configuration mechanism دارد
   که configuration properties را از منابع مختلف با pre-defined well-
   cedence rules بازیابی می‌کند (https://docs.spring.io/spring-boot/docs/current/reference/html/boot-
   features-external-config.html). Let’s look at how it works.
  </p>
<p>
   Spring Boot properties را از منابع مختلف می‌خواند. I find the following sources
   useful در یک microservice architecture:
  </p>
<p>
   Order
   History Service
   instance
   Process
   Environment variables
   Deployment
   infrastructure
   Conﬁgures
   Creates
   Reads
   BOOTSTRAP_SERVERS=kafka1:9092
   AWS_ACCESS_KEY_ID=
   AWS_SECRET_ACCESS_KEY=...
   AWS_REGION=...
   ....
  </p>
<p>
   Figure 11.7
   When the deployment infrastructure یک instance از Order History ایجاد می‌کند
   Service, it sets the environment variables حاوی externalized configuration. Order
   History Service این environment variables را می‌خواند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0392_original/original_page.png" alt="Original Page 392">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Designing configurable services</span></h3>
<p>
   1
   Command-line arguments
  </p>
<p>
   2
   SPRING_APPLICATION_JSON, یک operating system environment variable یا JVM
   system property که حاوی JSON است
  </p>
<p>
   3
   JVM System properties
  </p>
<p>
   4
   Operating system environment variables
  </p>
<p>
   5
   A configuration file در current directory
  </p>
<p>
   A particular property value از یک منبع زودتر در این لیست، the same prop-
   erty را از یک منبع دیرتر در این لیست بازنویسی می‌کند. For example, operating system environment vari-
   ables properties را که از یک configuration file خوانده می‌شوند، بازنویسی می‌کنند.
  </p>
<p>
   Spring Boot این properties را در دسترس Spring Framework’s قرار می‌دهد
   ApplicationContext. A service می‌تواند، به عنوان مثال، مقدار یک property را با استفاده از
   the @Value annotation به دست آورد:
  </p>
<pre><code class="language-java">
  public class OrderHistoryDynamoDBConfiguration {
  @Value("${aws.region}")
  private String awsRegion;
  </code></pre>
<p>
   The Spring Framework فیلد awsRegion را به مقدار aws.region مقداردهی اولیه می‌کند
   property. This property از یکی از منابع ذکر شده در بالا، مانند یک config-
   uration file یا از متغیر محیطی AWS_REGION خوانده می‌شود.
  </p>
<p>
   The push model یک mechanism مؤثر و پرکاربرد برای پیکربندی یک ser-
   vice است. One limitation, however, این است که reconfiguring یک service در حال اجرا ممکن است chal-
   lenging باشد، اگر غیرممکن نباشد. The deployment infrastructure ممکن است به شما اجازه ندهد تا
   externalized configuration از یک service در حال اجرا را بدون راه‌اندازی مجدد آن تغییر دهید. You
   can’t, for example, متغیرهای محیطی یک process در حال اجرا را تغییر دهید. Another
   limitation این است که یک ریسک از configuration property values وجود دارد که پراکنده شود
   throughout the definition از numerous services. در نتیجه، شما ممکن است بخواهید در نظر بگیرید
   استفاده از a pull-based model. Let’s look at how it works.
  </p>
<h4><span style="font-weight: bold;">11.2.2 Using pull-based externalized configuration</span></h4>
<p>
   In the pull model, a service instance configuration properties خود را از یک configura-
   tion server می‌خواند. Figure 11.8 نشان می‌دهد که چگونه کار می‌کند. On startup، یک service instance the را query می‌کند
   configuration service برای configuration خود. The configuration properties برای دسترسی
   the configuration server، مانند network location آن، به service ارائه می‌شود
   instance via a push-based configuration mechanism، مانند environment variables.
  </p>
<p>
   There are a variety of ways برای implement a configuration server، از جمله
   به شرح زیر است:
  </p>
<p>
   Version control system مانند Git
  </p>
<p>
   SQL و NoSQL databases
  </p>
<p>
   Specialized configuration servers، مانند Spring Cloud Config Server, Hashicorp
   Vault، که یک store برای data حساس مانند credentials، و AWS Parameter است
   Store
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0393_original/original_page.png" alt="Original Page 393">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<p>
   The Spring Cloud Config project یک مثال خوب از یک configuration server-based است
   framework. It consists از یک server و یک client. The server پشتیبانی می‌کند از variety از backends
   برای ذخیره configuration properties، از جمله version control systems، databases، و
   Hashicorp Vault. The client configuration properties را از server بازیابی می‌کند و
   آنها را در Spring ApplicationContext تزریق می‌کند.
  </p>
<p>
   Using a configuration server دارای چندین benefit است:
  </p>
<p>
   Centralized configuration—تمام configuration properties در یک
   place ذخیره می‌شوند، که مدیریت آنها را آسان‌تر می‌کند. What’s more، برای حذف
   duplicate configuration properties، برخی از پیاده‌سازی‌ها به شما اجازه می‌دهند که global را تعریف کنید
   defaults، که می‌تواند بر اساس هر service نادیده گرفته شود.
  </p>
<p>
   Transparent decryption of sensitive data—رمزگذاری data حساس مانند database
   credentials یک security best practice است. One challenge از استفاده از encryption, though,
   این است که معمولاً service instance نیاز به decrypt آنها دارد، که به این معنی است که به
   encryption keys نیاز دارد. Some configuration server implementations به طور خودکار
   properties را قبل از بازگرداندن آنها به service decrypt می‌کند.
  </p>
<p>
   Dynamic reconfiguration—A service می‌تواند بالقوه updated property val-
   ues را با، به عنوان مثال، polling، تشخیص دهد و خود را reconfigure کند.
  </p>
<p>
   The primary drawback از استفاده از یک configuration server این است که تا زمانی که توسط
   the infrastructure ارائه نشود، این یک قطعه دیگر از infrastructure است که نیاز به راه‌اندازی و
   maintenance دارد. Fortunately, there are various open source frameworks، مانند Spring
   Cloud Config, which make it easier to run a configuration server.
  </p>
<p>
   Now that we’ve looked at how to design configurable services، بیایید در مورد اینکه چگونه صحبت کنیم
   to design observable services.
  </p>
<h4><span style="font-weight: bold;">11.3 Designing observable services</span></h4>
<p>
   Let’s say شما application FTGO را در production مستقر کرده‌اید. You probably want
   to know که application چه می‌کند: requests در هر ثانیه، resource utilization، و
  </p>
<p>
   Order
   History Service
   instance
   Process
   Conﬁgures
   Creates
   CONFIG_SERVER_URL=...
   getConﬁguration(“orderHistoryService”)
   BOOTSTRAP_SERVERS=kafka1:9092
   AWS_ACCESS_KEY_ID=
   AWS_SECRET_ACCESS_KEY=...
   AWS_REGION=...
   ....
   Environment variables
   Deployment
   infrastructure
   Conﬁguration
   server
  </p>
<p>
   Figure 11.8
   On startup, a service instance configuration properties خود را از یک configuration server بازیابی می‌کند. The
   deployment infrastructure configuration properties را برای دسترسی به configuration server فراهم می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0394_original/original_page.png" alt="Original Page 394">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Designing observable services</span></h3>
<p>
   so on. You also need to be alerted اگر یک مشکل وجود دارد، مانند یک service instance ناموفق
   یا پر شدن دیسک — ideally قبل از اینکه بر یک user تأثیر بگذارد. And, if there’s a problem، شما
   باید قادر باشید که مشکل را troubleshooting کنید و علت اصلی آن را شناسایی کنید.
  </p>
<p>
   Many aspects از مدیریت یک application در production خارج از scope از
   developer است، مانند monitoring hardware availability و utilization. These are
   clearly the responsibility از operations. But there are several patterns که شما، به عنوان یک ser-
   vice developer، باید پیاده‌سازی کنید تا service خود را آسان‌تر مدیریت و trouble-
   shoot کنید. These patterns, shown in figure 11.9, یک service instance’s behavior و
   health را نشان می‌دهند. They enable a monitoring system to track و visualize the state از یک service
   و generate alerts زمانی که یک مشکل وجود دارد. These patterns همچنین trouble-
   shooting problems را آسان‌تر می‌کنند.
  </p>
<p>
   You can use the following patterns برای design observable services:
  </p>
<p>
   Health check API—Expose an endpoint که health از service را برمی‌گرداند.
  </p>
<p>
   Log aggregation—Log service activity و write logs به یک centralized logging
   server، که searching و alerting را فراهم می‌کند.
  </p>
<p>
   Pattern
   participant
   Key
   Operations
   responsibility
   Distributed
   tracing
   server
   Exception
   Tracking
   Service
   Logging
   Server
   Logging
   aggregation
   pipeline
   Log ﬁle
   Metrics
   Service
   Developer
   responsibility
   Pattern
   Observable
   Service
   Distributed
   tracing
   exporter
   Exception
   reporter
   Metrics
   exporter
   Health
   check
   API
   Health check
   invoker, such as
   monitoring service
   Invokes
   Audit
   database
   adapter
   Auditing
   database
   Logging
   adapter
   Distributed
   tracing pattern
   Application
   metrics pattern
   Audit
   logging pattern
   Health check
   API pattern
   Exception
   tracking pattern
   Log aggregation
   pattern
  </p>
<p>
   Figure 11.9
   The observability patterns enable developers و operations to understand the behavior از یک
   application و troubleshoot problems. Developers مسئول اطمینان از observable بودن services خود هستند.
   Operations مسئول زیرساختی هستند که اطلاعات ارائه شده توسط services را جمع‌آوری می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0395_original/original_page.png" alt="Original Page 395">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<p>
   Distributed tracing—هر external request را به یک unique ID اختصاص دهید و requests را
   همانطور که بین services جریان دارند، ردیابی کنید.
  </p>
<p>
   Exception tracking—Exceptions را به یک exception tracking service گزارش دهید، که
   exceptions را de-duplicates می‌کند، به developers هشدار می‌دهد و resolution هر را ردیابی می‌کند
   exception.
  </p>
<p>
   Application metrics—Services metrics را نگهداری می‌کنند، مانند counters و gauges، و
   آنها را به یک metrics server نشان می‌دهند.
  </p>
<p>
   Audit logging—Log user actions.
  </p>
<p>
   A distinctive feature از اکثر این patterns این است که هر pattern یک developer دارد
   component و یک operations component. Consider, for example, the Health check
   API pattern. The developer مسئول اطمینان از این است که service آنها یک
   health check endpoint را پیاده‌سازی می‌کند. Operations مسئول the monitoring system است که peri-
   odically health check API را فراخوانی می‌کند. Similarly, for the Log aggregation pattern، a
   developer مسئول اطمینان از این است که services آنها اطلاعات مفید را log می‌کنند،
   در حالی که operations مسئول log aggregation است.
  </p>
<p>
   Let’s take a look at each از این patterns، شروع با Health check API pattern.
  </p>
<h4><span style="font-weight: bold;">11.3.1 Using the Health check API pattern</span></h4>
<p>
   Sometimes a service ممکن است در حال اجرا باشد اما قادر به handle کردن requests نباشد. For instance, a
   newly started service instance ممکن است آماده پذیرش requests نباشد. The FTGO Con-
   sumer Service، به عنوان مثال، حدود 10 ثانیه طول می‌کشد تا messaging را مقداردهی اولیه کند و
   database adapters. It would be pointless برای زیرساخت استقرار برای route کردن
   HTTP requests به یک service instance تا زمانی که آماده پردازش آنها شود.
  </p>
<p>
   Also, a service instance می‌تواند بدون خاتمه یافتن، شکست بخورد. For example, a bug ممکن است
   باعث شود که یک instance از Consumer Service از database connections خارج شود و
   قادر به دسترسی به database نباشد. The deployment infrastructure نباید route
   requests را به یک service instance که شکست خورده است اما همچنان در حال اجرا است. And, if the service
   instance بازیابی نمی‌شود، the deployment infrastructure باید آن را خاتمه دهد و ایجاد کند
   یک instance جدید.
  </p>
<p>
   A service instance نیاز دارد تا بتواند به زیرساخت استقرار بگوید که آیا
   قادر به handle کردن requests است یا خیر. A good solution این است که یک service a را implement کند
   health check endpoint، که در شکل 11.10 نشان داده شده است. The Spring Boot Actuator Java library,
   به عنوان مثال، a GET /actuator/health endpoint را پیاده‌سازی می‌کند، که 200 را برمی‌گرداند if and
   only if the service is healthy, و 503 otherwise. Similarly, the HealthChecks .NET
   Pattern: Health check API
   A service exposes a health check API endpoint, such as GET /health, که
   health از service را برمی‌گرداند. See http://microservices.io/patterns/observability/health-
   check-api.html.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0396_original/original_page.png" alt="Original Page 396">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Designing observable services</span></h3>
<p>
   library implements a GET /hc endpoint (https://docs.microsoft.com/en-us/dotnet/
   standard/microservices-architecture/implement-resilient-applications/monitor-app-
   health). The deployment infrastructure به طور دوره‌ای این endpoint را برای تعیین
   health از service instance فراخوانی می‌کند و در صورت ناسالم بودن، action مناسب را انجام می‌دهد.
  </p>
<p>
   A Health Check Request Handler معمولاً connections از service instance را به
   external services تست می‌کند. It might, for example, یک test query را در برابر یک database اجرا کند. If all
   the tests succeed, Health Check Request Handler یک پاسخ سالم، مانند
   an HTTP 200 status code را برمی‌گرداند. If any of them fails، یک پاسخ ناسالم، مانند
   an HTTP 500 status code را برمی‌گرداند.
  </p>
<p>
   Health Check Request Handler ممکن است به سادگی یک پاسخ HTTP خالی را با
   the appropriate status code برگرداند. Or it might return a detailed description از health از
   each of the adapters. The detailed information برای troubleshooting مفید است. But
   به دلیل اینکه ممکن است حاوی اطلاعات حساس باشد، برخی از frameworks، مانند Spring Boot
   Actuator، به شما اجازه می‌دهند که level از detail را در health endpoint response پیکربندی کنید.
  </p>
<p>
   There are two issues که شما باید هنگام استفاده از health checks در نظر بگیرید. The first is
   the implementation از endpoint، که باید به health از ser-
   vice instance گزارش دهد. The second issue این است که چگونه deployment infrastructure را برای
   فراخوانی health check endpoint پیکربندی کنیم. Let’s first look at how to implement the endpoint.
  </p>
<h4><span style="font-weight: bold;">IMPLEMENTING THE HEALTH CHECK ENDPOINT</span></h4>
<p>
   The code که health check endpoint را پیاده‌سازی می‌کند، باید به نوعی تعیین کند
   health از service instance. One simple approach این است که تأیید کنیم service
   instance می‌تواند به external infrastructure services خود دسترسی داشته باشد. How to do this به
   the Service بستگی دارد
   Checks
   Checks
   Health check
   invoker
   Invokes
   Health check
   endpoint
   Health check
   request
   handler
   Messaging
   adapter
   Message
   broker
   Database
   adapter
   MySQL
   Tests the service’s connections
   to infrastructure services
   For example: monitoring
   system, Service registry, and others
  </p>
<p>
   Figure 11.10
   A service یک health check endpoint را پیاده‌سازی می‌کند، که به طور دوره‌ای توسط
   the deployment infrastructure برای تعیین health از service instance فراخوانی می‌شود.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0397_original/original_page.png" alt="Original Page 397">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<p>
   infrastructure service. The health check code می‌تواند، به عنوان مثال، تأیید کند که
   به یک RDBMS متصل است با به دست آوردن یک database connection و اجرای یک test query.
   A more elaborate approach این است که یک synthetic transaction را اجرا کنید که
   فراخوانی API از service را توسط یک client شبیه‌سازی می‌کند. This kind of health check جامع‌تر است،
   اما احتمالاً زمان بیشتری برای پیاده‌سازی می‌برد و اجرای آن بیشتر طول می‌کشد.
  </p>
<p>
   A great example از یک health check library Spring Boot Actuator است. As mentioned
   earlier، it implements a /actuator/health endpoint. The code که این را پیاده‌سازی می‌کند
   endpoint نتیجه اجرای یک set از health checks را برمی‌گرداند. By using convention
   over configuration, Spring Boot Actuator یک set از health checks را پیاده‌سازی می‌کند
   بر اساس infrastructure services که توسط service استفاده می‌شود. If, for example, a service uses
   a JDBC DataSource, Spring Boot Actuator یک health check را پیکربندی می‌کند که یک
   test query را اجرا می‌کند. Similarly, if the service از RabbitMQ message broker استفاده می‌کند، به طور خودکار
   یک health check را پیکربندی می‌کند که تأیید می‌کند که سرور RabbitMQ فعال است.
  </p>
<p>
   You can also این رفتار را با implement additional health checks برای
   service خود سفارشی کنید. You implement a custom health check با تعریف یک class که imple-
   ments the HealthIndicator interface. This interface یک health() method را تعریف می‌کند،
   که توسط implementation از /actuator/health endpoint فراخوانی می‌شود. It returns
   the outcome از health check.
  </p>
<h4><span style="font-weight: bold;">INVOKING THE HEALTH CHECK ENDPOINT</span></h4>
<p>
   A health check endpoint، اگر کسی آن را فراخوانی نکند، استفاده زیادی ندارد. When you deploy your ser-
   vice, شما باید deployment infrastructure را پیکربندی کنید تا endpoint را فراخوانی کنید. How
   you do that به جزئیات خاص از deployment infrastructure شما بستگی دارد. For
   example, as described در فصل 3، شما می‌توانید برخی از service registries، مانند
   Netflix Eureka، را پیکربندی کنید تا health check endpoint را فراخوانی کنید تا تعیین کنید که آیا
   traffic باید به service instance هدایت شود. فصل 12 در مورد نحوه پیکربندی بحث می‌کند
   Docker و Kubernetes برای فراخوانی a health check endpoint.
  </p>
<h4><span style="font-weight: bold;">11.3.2 Applying the Log aggregation pattern</span></h4>
<p>
   Logs یک ابزار troubleshooting ارزشمند هستند. If you want to know که مشکل application چیست، یک مکان خوب برای شروع، log files است. But using logs در یک microservice archi-
   tecture چالش برانگیز است. For example, imagine شما در حال debugging یک مشکل با
   getOrderDetails() query هستید. As described در فصل 8، the FTGO application imple-
   ments این query با استفاده از API composition. As a result، log entries که شما نیاز دارید پراکنده هستند
   across the log files از API gateway و چندین services، از جمله Order
   Service و Kitchen Service.
  </p>
<p>
   Pattern: Log aggregation
   Aggregate the logs از همه services در یک database متمرکز که از searching پشتیبانی می‌کند
   و alerting. See http://microservices.io/patterns/observability/application-logging
   .html.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0398_original/original_page.png" alt="Original Page 398">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Designing observable services</span></h3>
<p>
   The solution استفاده از log aggregation است. As figure 11.11 نشان می‌دهد، log aggregation pipe-
   line logs از تمام service instances را به یک centralized logging server ارسال می‌کند. Once
   the logs توسط logging server ذخیره می‌شوند، شما می‌توانید آنها را view، search و analyze کنید. You
   همچنین می‌توانید alerts را پیکربندی کنید که وقتی messages خاصی در logs ظاهر می‌شوند، فعال می‌شوند.
  </p>
<p>
   The logging pipeline و server معمولاً responsibility از operations هستند. But ser-
   vice developers مسئول نوشتن services هستند که logs مفید تولید می‌کنند. Let’s first
   look at how a service generates a log.
  </p>
<h4><span style="font-weight: bold;">HOW A SERVICE GENERATES A LOG</span></h4>
<p>
   As a service developer, there are a couple از issues که شما نیاز دارید در نظر بگیرید. First شما
   نیاز دارید که تصمیم بگیرید که از کدام logging library استفاده کنید. The second issue این است که کجا
   log entries را بنویسید. Let’s first look at the logging library.
  </p>
<p>
   Most programming languages یک یا چند logging libraries دارند که این کار را آسان می‌کنند
   برای generate correctly structured log entries. For example, سه Java logging محبوب
   libraries عبارتند از Logback, log4j, و JUL (java.util.logging). There’s also SLF4J, which is a
   logging facade API برای logging frameworks مختلف. Similarly, Log4JS یک محبوب است
   logging framework برای NodeJS. One reasonable way برای استفاده از logging این است که
   calls را به یکی از این logging libraries در code از service خود پاشید. But if you have strict logging
   requirements که نمی‌توانند توسط logging library اعمال شوند، شما ممکن است نیاز داشته باشید
   logging API خود را تعریف کنید که یک logging library را در بر می‌گیرد.
  </p>
<p>
   You also نیاز دارید که تصمیم بگیرید که کجا log کنید. Traditionally، شما would configure the log-
   ging framework برای نوشتن به یک log file در یک location در filesystem. But
   با technologies deployment مدرن‌تر، مانند containers و serverless،
   Service A
   instance 1
   Logging
   library
   Service B
   instance 1
   Logging
   library
   Service A
   instance 2
   Logging
   library
   Log
   View
   Notify
   Log
   Log
   Log
   pipeline
   Logging
   server
   User
  </p>
<p>
   Figure 11.11
   The log aggregation infrastructure logs از هر service instance را به یک
   centralized logging server ارسال می‌کند. Users می‌توانند logs را view و search کنند. They can also set up alerts, which are
   triggered زمانی که log entries با search criteria مطابقت دارند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0399_original/original_page.png" alt="Original Page 399">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<p>
   described در فصل 12، این اغلب بهترین رویکرد نیست. In some environments،
   مانند AWS Lambda، حتی یک filesystem “permanent” برای نوشتن logs وجود ندارد!
   Instead, service شما باید به stdout log کنید. The deployment infrastructure سپس
   تصمیم می‌گیرد که با output از service شما چه کند.
  </p>
<h4><span style="font-weight: bold;">THE LOG AGGREGATION INFRASTRUCTURE</span></h4>
<p>
   The logging infrastructure مسئول aggregate کردن logs، ذخیره کردن آنها و
   enabling the user برای search کردن آنها است. One popular logging infrastructure، ELK است
   stack. ELK از سه محصول open source تشکیل شده است:
  </p>
<p>
   Elasticsearch—A text search-oriented NoSQL database که به عنوان logging استفاده می‌شود
   server
  </p>
<p>
   Logstash—A log pipeline که logs از service را جمع‌آوری می‌کند و آنها را می‌نویسد
   به Elasticsearch
  </p>
<p>
   Kibana—A visualization tool برای Elasticsearch
  </p>
<p>
   Other open source log pipelines شامل Fluentd و Apache Flume. Examples از log-
   ging servers شامل cloud services، مانند AWS CloudWatch Logs و همچنین numerous
   commercial offerings. Log aggregation یک ابزار debugging مفید در یک microservice است
   architecture.
  </p>
<p>
   Let’s now look at distributed tracing، که یک راه دیگر برای درک
   behavior از یک microservices-based application است.
  </p>
<h4><span style="font-weight: bold;">11.3.3 Using the Distributed tracing pattern</span></h4>
<p>
   Imagine شما یک FTGO developer هستید که در حال بررسی دلیل کند شدن getOrderDetails()
   query است. You’ve ruled out the problem being an external networking
   issue. The increased latency باید توسط یا API gateway یا یکی از
   services که آن را فراخوانی کرده است، ایجاد شود. One option این است که به میانگین response time هر service نگاه کنید.
   The trouble with this option این است که یک میانگین در سراسر requests است و نه tim-
   ing breakdown برای یک request مجزا. Plus scenarios پیچیده‌تر ممکن است شامل
   many nested service invocations باشد. You may not even be familiar با تمام services. As a
   result، it can be challenging to troubleshoot و تشخیص این نوع از performance
   problems در یک microservice architecture.
  </p>
<p>
   A good way برای get insight به آنچه application شما انجام می‌دهد، استفاده از distributed trac-
   ing است. Distributed tracing به یک performance profiler در یک monolithic applica-
   tion شباهت دارد. It records information (به عنوان مثال، start time و end time) در مورد tree از
   service calls که هنگام handling یک request انجام می‌شود. You can then see how the services
   Pattern: Distributed tracing
   Assign each external request a unique ID و record که چگونه از طریق system جریان دارد
   از یک service به service بعدی در یک centralized server که visualization و
   analysis را فراهم می‌کند. See http://microservices.io/patterns/observability/distributed-tracing.html.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0400_original/original_page.png" alt="Original Page 400">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Designing observable services</span></h3>
<p>
   interact during the handling از external requests، از جمله یک breakdown از کجا
   the time صرف می‌شود.
  </p>
<p>
   Figure 11.12 یک مثال از نحوه نمایش یک distributed tracing server را نشان می‌دهد
   what happens وقتی API gateway یک request را مدیریت می‌کند. It shows the inbound request to the
   API gateway و request که gateway به Order Service انجام می‌دهد. For each
   request، the distributed tracing server عملیات را که انجام می‌شود و
   timing از request را نشان می‌دهد.
  </p>
<p>
   Figure 11.12 نشان می‌دهد که در distributed tracing terminology چه چیزی را یک trace نامیده می‌شود. A trace
   یک external request را نشان می‌دهد و از یک یا چند span تشکیل شده است. A span نشان می‌دهد
   an operation، و key attributes آن، یک operation name، start timestamp و end است
   time. A span می‌تواند یک یا چند child spans داشته باشد، که نشان‌دهنده nested operations است.
   For example, a top-level span ممکن است the invocation از API gateway را نشان دهد، as
   is the case در شکل 11.12. Its child spans the invocations از services توسط
   API gateway.
  </p>
<p>
   A valuable side effect از distributed tracing این است که یک ID منحصر به فرد به هر
   external request اختصاص می‌دهد. A service می‌تواند request ID را در log entries خود قرار دهد. When com-
   bined با log aggregation، the request ID به شما امکان می‌دهد تا به راحتی تمام log entries را پیدا کنید
   برای یک external request خاص. For example, here’s an example log entry از
   Order Service:
  </p>
<pre><code class="language-text">
  2018-03-04 17:38:12.032 DEBUG [ftgo-order-
  service,8d8fdc37be104cc6,8d8fdc37be104cc6,false]
  7 --- [nio-8080-exec-6] org.hibernate.SQL
  :
  select order0_.id as id1_3_0_, order0_.consumer_id as consumer2_3_0_, order
  0_.city as city3_3_0_,
  order0_.delivery_state as delivery4_3_0_, order0_.street1 as street5_3_0_,
  order0_.street2 as street6_3_0_, order0_.zip as zip7_3_0_,
  order0_.delivery_time as delivery8_3_0_, order0_.a
  </code></pre>
<p>
   Parent span
   Child span
   Trace
  </p>
<p>
   Figure 11.12
   The Zipkin server نشان می‌دهد که چگونه FTGO application یک request را مدیریت می‌کند که
   by the API gateway to Order Service هدایت می‌شود. Each request توسط یک trace نشان داده می‌شود. A trace یک set از
   spans است. Each span، که می‌تواند شامل child spans باشد، the invocation از یک service است. Depending on the
   level of detail collected، a span همچنین می‌تواند the invocation از یک operation در داخل یک service را نشان دهد.
  </p>
</div>
</div>
                <div class="page-images">
<div class="page-image"><img alt="Image from page 401" src="page_0401/image_1.png"/></div>
</div>
            </div>
            <div class="page original-page">
                <img src="page_0401_original/original_page.png" alt="Original Page 401">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<p>
   The [ftgo-order-service,8d8fdc37be104cc6,8d8fdc37be104cc6,false] قسمت از
   log entry (the SLF4J Mapped Diagnostic Context—see www.slf4j.org/manual.html)
   اطلاعاتی از the distributed tracing infrastructure را شامل می‌شود. It consists از چهار
   values:
  </p>
<p>
   
   ftgo-order-service—The name از application
  </p>
<p>
   
   8d8fdc37be104cc6—The traceId
  </p>
<p>
   
   8d8fdc37be104cc6—The spanId
  </p>
<p>
   
   false—Indicates که این span به the distributed tracing server صادر نشده است
  </p>
<p>
   If you search the logs for 8d8fdc37be104cc6، شما تمام log entries را برای آن request پیدا خواهید کرد.
  </p>
<p>
   Figure 11.13 نشان می‌دهد که چگونه distributed tracing کار می‌کند. There are two parts to distrib-
   uted tracing: an instrumentation library، که توسط هر service استفاده می‌شود، و یک distributed
   tracing server. The instrumentation library traces و spans را مدیریت می‌کند. It also adds
   Span ABC: API gateway
   Trace XYZ
   API
   gateway
   GET/orders/1 HTTP/1.1
   ....
   GET/orders/1 HTTP/1.1
   X-B3-TraceId: XYZ
   X-B3-ParentSpanId: ABC
   Service: API gateway
   TraceId: XYZ
   ParentSpan: NONE
   Span: ABC
   Views traces
   Service: Order Service
   TraceId: XYZ
   ParentSpan: ABC
   Span: DEF
   Span DEF: Order Service
   Transport
   Distributed tracing server
   Order
   Service
   Instrumentation
   library
   Instrumentation
   library
   User
   Trace
   database
  </p>
<p>
   Figure 11.13
   Each service (از جمله API gateway) از یک instrumentation library استفاده می‌کند. The
   instrumentation library یک ID را به هر external request اختصاص می‌دهد، tracing state را بین
   services منتشر می‌کند و spans را به distributed tracing server گزارش می‌دهد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0402_original/original_page.png" alt="Original Page 402">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Designing observable services</span></h3>
<p>
   tracing information، مانند the current trace ID و the parent span ID، به outbound
   requests. For example, one common standard برای propagating trace information،
   the B3 standard است (https://github.com/openzipkin/b3-propagation)، که از head-
   ers مانند X-B3-TraceId و X-B3-ParentSpanId استفاده می‌کند. The instrumentation library نیز
   traces را به distributed tracing server گزارش می‌دهد. The distributed tracing server ذخیره می‌کند
   the traces و یک UI برای visualizing آنها فراهم می‌کند.
  </p>
<p>
   Let’s take a look at the instrumentation library و the distribution tracing server،
   شروع با the library.
  </p>
<h4><span style="font-weight: bold;">USING AN INSTRUMENTATION LIBRARY</span></h4>
<p>
   The instrumentation library، the tree از spans را می‌سازد و آنها را به distributed
   tracing server ارسال می‌کند. The service code می‌تواند instrumentation library را مستقیماً فراخوانی کند، اما این کار
   منطق instrumentation را با business و other logic در هم می‌آمیزد. A cleaner
   approach استفاده از interceptors یا aspect-oriented programming (AOP) است.
  </p>
<p>
   A great example از یک AOP-based framework Spring Cloud Sleuth است. It uses the
   Spring Framework’s AOP mechanism to automagically distributed tracing را
   در service ادغام کنید. As a result, شما باید Spring Cloud Sleuth را به عنوان یک project depen-
   dency اضافه کنید. Your service نیازی به فراخوانی a distributed tracing API ندارد، به جز در مواردی که
   توسط Spring Cloud Sleuth مدیریت نمی‌شوند.
  </p>
<h4><span style="font-weight: bold;">ABOUT THE DISTRIBUTED TRACING SERVER</span></h4>
<p>
   The instrumentation library spans را به یک distributed tracing server ارسال می‌کند. The dis-
   tributed tracing server spans را با هم ترکیب می‌کند تا traces کامل را تشکیل دهد و
   آنها را در یک database ذخیره می‌کند. One popular distributed tracing server Open Zipkin است. Zipkin بود
   originally developed توسط Twitter. Services می‌تواند spans را به Zipkin با استفاده از یا
   HTTP یا یک message broker. Zipkin traces را در یک storage backend ذخیره می‌کند، که
   یا یک database SQL یا NoSQL است. It has یک UI که traces را نمایش می‌دهد، همانطور که قبلاً در
   شکل 11.12 نشان داده شد. AWS X-ray مثال دیگری از یک distributed tracing server است.
  </p>
<h4><span style="font-weight: bold;">11.3.4 Applying the Application metrics pattern</span></h4>
<p>
   A key part از production environment، monitoring و alerting است. As figure 11.14
   نشان می‌دهد، the monitoring system metrics را جمع‌آوری می‌کند، که اطلاعات حیاتی را ارائه می‌دهند
   در مورد health از یک application، از هر قسمت از technology stack. Metrics
   range from infrastructure-level metrics، مانند CPU، memory و disk utilization، to
   application-level metrics، مانند service request latency و number از requests exe-
   cuted. Order Service, for example, metrics را در مورد تعداد placed جمع‌آوری می‌کند،
   approved و rejected orders. The metrics توسط یک metrics service جمع‌آوری می‌شوند، که
   visualization و alerting را فراهم می‌کند.
  </p>
<p>
   Pattern: Application metrics
   Services report metrics به یک central server که aggregation، visualization را فراهم می‌کند،
   و alerting.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0403_original/original_page.png" alt="Original Page 403">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<p>
   Metrics به طور دوره‌ای sample می‌شوند. A metric sample دارای سه property زیر است:
  </p>
<p>
   Name—The name از metric، مانند jvm_memory_max_bytes یا placed_orders
  </p>
<p>
   Value—A numeric value
  </p>
<p>
   Timestamp—The time از sample
  </p>
<p>
   In addition، برخی از monitoring systems از مفهوم dimensions پشتیبانی می‌کنند، که
   arbitrary name-value pairs هستند. For example, jvm_memory_max_bytes با dimen-
   sions مانند area="heap",id="PS Eden Space" و area="heap",id="PS Old Gen" گزارش می‌شود.
  </p>
<p>
   Dimensions اغلب برای ارائه اطلاعات اضافی، مانند machine استفاده می‌شود
   name یا service name، یا یک service instance identifier. A monitoring system معمولاً
   metric samples را در امتداد یک یا چند dimension جمع‌آوری (جمع یا میانگین‌گیری) می‌کند.
  </p>
<p>
   Many aspects از monitoring the responsibility از operations است. But a service
   developer مسئول دو جنبه از metrics است. First, they must instrument their
   service تا metrics را در مورد behavior خود جمع‌آوری کند. Second، آنها باید those را expose کنند
   service metrics، به همراه metrics از JVM و the application framework، to
   the metrics server.
  </p>
<p>
   Let’s first look at how a service collects metrics.
  </p>
<h4><span style="font-weight: bold;">COLLECTING SERVICE-LEVEL METRICS</span></h4>
<p>
   How much work شما نیاز دارید تا metrics را جمع‌آوری کنید به frameworks که بستگی دارد
   application شما استفاده می‌کند و the metrics که می‌خواهید جمع‌آوری کنید. A Spring Boot-based service
   می‌تواند، به عنوان مثال، gather (و expose) basic metrics، مانند JVM metrics، با شامل کردن
   View
   Notify
   Metrics
   Service
   User
   Service instance
   Deployment infrastructure
   Metrics sample:
   name=cpu_percent
   value=68
   timestamp=34938934893
   dimensions:
   machine=node1
   ...
   Application framework
   Language runtime
   Application code
   Metrics library
   Visualization
   Metrics
   ingestion
   Alerts
   Metrics
   database
  </p>
<p>
   Figure 11.14
   Metrics در هر level از stack جمع‌آوری و در یک metrics service ذخیره می‌شوند، که
   visualization و alerting را فراهم می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0404_original/original_page.png" alt="Original Page 404">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Designing observable services</span></h3>
<p>
   the Micrometer Metrics library را به عنوان یک dependency و استفاده از چند خط از configura-
   tion. Spring Boot’s autoconfiguration مراقب configuring the metrics library و
   exposing the metrics است. A service فقط نیاز دارد تا از Micrometer Metrics API به طور مستقیم استفاده کند
   اگر metrics مخصوص application را جمع‌آوری می‌کند.
  </p>
<p>
   فهرست زیر نشان می‌دهد که چگونه OrderService می‌تواند metrics را در مورد تعداد
   orders placed، approved و rejected جمع‌آوری کند. It uses MeterRegistry، که the interface-
   provided Micrometer Metrics است، تا custom metrics را جمع‌آوری کند. Each method یک
   counter که به درستی نام‌گذاری شده است، را افزایش می‌دهد.
  </p>
<pre><code class="language-java">
  public class OrderService {
  @Autowired
  private MeterRegistry meterRegistry;
  public Order createOrder(...) {
  ...
  meterRegistry.counter("placed_orders").increment();
  return order;
  }
  public void approveOrder(long orderId) {
  ...
  meterRegistry.counter("approved_orders").increment();
  }
  public void rejectOrder(long orderId) {
  ...
  meterRegistry.counter("rejected_orders").increment();
  }
  </code></pre>
<h4><span style="font-weight: bold;">DELIVERING METRICS TO THE METRICS SERVICE</span></h4>
<p>
   A service metrics را به Metrics Service به یکی از دو روش تحویل می‌دهد: push یا pull. With
   the push model, a service instance metrics را با فراخوانی به Metrics Service ارسال می‌کند
   یک API. AWS Cloudwatch metrics، به عنوان مثال، push model را پیاده‌سازی می‌کند.
  </p>
<p>
   With the pull model, the Metrics Service (or its agent که به صورت محلی در حال اجرا است) یک
   service API را برای بازیابی metrics از service instance فراخوانی می‌کند. Prometheus، یک popular
   open source monitoring و alerting system، از pull model استفاده می‌کند.
  </p>
<p>
   The FTGO application’s Order Service از micrometer-registry-prometheus استفاده می‌کند
   library تا با Prometheus ادغام شود. Because این library در classpath است، Spring
   Boot یک GET /actuator/prometheus endpoint را نمایش می‌دهد، که metrics را در
   format که Prometheus انتظار دارد، برمی‌گرداند. The custom metrics از OrderService به شرح زیر گزارش می‌شود:
  </p>
<pre><code class="language-text">
  $ curl -v http://localhost:8080/actuator/prometheus | grep _orders
  # HELP placed_orders_total
  # TYPE placed_orders_total counter
  </code></pre>
<p>
   Listing 11.1
   OrderService tracks the number از orders placed، approved، و
   rejected.
   The Micrometer Metrics
   library API برای مدیریت
   application-specific meters
   Increments the
   placedOrders counter
   when an order has
   successfully been
   placed
   Increments the
   approvedOrders
   counter when an
   order has been
   approved
   Increments the
   rejectedOrders
   counter when an
   order has been
   rejected
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0405_original/original_page.png" alt="Original Page 405">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<pre><code class="language-text">
  placed_orders_total{service="ftgo-order-service",} 1.0
  # HELP approved_orders_total
  # TYPE approved_orders_total counter
  approved_orders_total{service="ftgo-order-service",} 1.0
  </code></pre>
<p>
   The placed_orders counter، به عنوان مثال، به عنوان یک metric از نوع counter گزارش می‌شود.
  </p>
<p>
   The Prometheus server به طور دوره‌ای این endpoint را برای بازیابی metrics poll می‌کند. Once
   the metrics در Prometheus هستند، شما می‌توانید آنها را با استفاده از Grafana، یک data visualization
   tool (https://grafana.com) مشاهده کنید. You can also set up alerts برای این metrics، مانند زمانی که
   the rate از change برای placed_orders_total به زیر یک threshold می‌رسد.
  </p>
<p>
   Application metrics insights ارزشمندی را در رفتار application شما ارائه می‌دهند.
   Alerts که توسط metrics فعال می‌شوند، به شما امکان می‌دهند تا به سرعت به یک issue در production پاسخ دهید، per-
   haps قبل از اینکه بر کاربران تأثیر بگذارد. Let’s now look at how to observe و پاسخ دادن به another
   source از alerts: exceptions.
  </p>
<h4><span style="font-weight: bold;">11.3.5 Using the Exception tracking pattern</span></h4>
<p>
   A service باید به ندرت یک exception را log کند، و when it does، این مهم است که شما
   علت اصلی را شناسایی کنید. The exception ممکن است یک symptom از a failure یا a program-
   ming bug باشد. The traditional way برای view exceptions این است که در logs نگاه کنید. You might even
   the logging server را پیکربندی کنید تا به شما هشدار دهد اگر یک exception در log file ظاهر شود. There
   are, however, several problems با این رویکرد:
  </p>
<p>
   Log files are oriented around single-line log entries، در حالی که exceptions متشکل از
   چندین خط است.
  </p>
<p>
   There’s no mechanism برای ردیابی the resolution از exceptions که در log
   files رخ می‌دهند. You would have to manually copy/paste the exception into an issue tracker.
  </p>
<p>
   There are likely to be duplicate exceptions، اما هیچ mecha-
   nism خودکاری برای رفتار با آنها به عنوان یک وجود ندارد.
  </p>
<p>
   A better approach استفاده از یک exception tracking service است. As figure 11.15 نشان می‌دهد، شما
   service خود را برای گزارش exceptions به یک exception tracking service از طریق، برای
   به عنوان مثال، a REST API، پیکربندی می‌کنید. The exception tracking service de-duplicates exceptions، gener-
   ates alerts و the resolution از exceptions را مدیریت می‌کند.
  </p>
<p>
   There are a couple از راه‌ها برای ادغام the exception tracking service در your
   application. Your service می‌تواند API از exception tracking service را مستقیماً فراخوانی کند. A
   better approach استفاده از یک client library ارائه شده توسط the exception tracking service است.
   For example, HoneyBadger’s client library چندین integration آسان برای استفاده را فراهم می‌کند
   mechanisms، از جمله یک Servlet Filter که exceptions را می‌گیرد و گزارش می‌دهد.
  </p>
<p>
   Pattern: Exception tracking
   Services exceptions را به یک central service گزارش می‌دهند که exceptions را de-duplicates می‌کند، gener-
   ates alerts و the resolution از exceptions را مدیریت می‌کند. See http://microservices.io/
   patterns/observability/audit-logging.html.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0406_original/original_page.png" alt="Original Page 406">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Designing observable services</span></h3>
<p>
   The Exception tracking pattern یک راه مفید برای شناسایی سریع و پاسخگویی به pro-
   duction issues است.
  </p>
<p>
   It’s also مهم است که رفتار user را ردیابی کنید. Let’s look at how to do that.
  </p>
<h4><span style="font-weight: bold;">11.3.6 Applying the Audit logging pattern</span></h4>
<p>
   The purpose از audit logging ثبت actions از هر user است. An audit log معمولاً
   استفاده می‌شود تا به customer support کمک کند، compliance را تضمین کند و رفتار مشکوک را تشخیص دهد.
   Each audit log entry، identity از user، action که آنها انجام داده‌اند و
   the business object(s) را ثبت می‌کند. An application معمولاً audit log را در یک database table ذخیره می‌کند.
  </p>
<p>
   Exception tracking services
   There are several exception tracking services. Some, such as Honeybadger (www
   .honeybadger.io)، کاملاً مبتنی بر cloud هستند. Others، مانند Sentry.io (https://sentry.io/
   welcome/)، همچنین یک نسخه open source دارند که می‌توانید آن را در infra-
   structure خود مستقر کنید. These services exceptions را از application شما دریافت می‌کنند و alerts را تولید می‌کنند.
   They provide a console برای viewing exceptions و مدیریت the resolution آنها. An excep-
   tion tracking service معمولاً client libraries را در انواع مختلف زبان‌ها ارائه می‌دهد.
  </p>
<p>
   Pattern: Audit logging
   Record user actions در یک database برای کمک به customer support، تضمین com-
   pliance و تشخیص رفتار مشکوک. See http://microservices.io/patterns/
   observability/audit-logging.html.
   View &amp; manage
   Notify
   User
   POST/exceptions
   java.lang.NullPointerException
   at net.chrisrichardson.ftgo...
   at net.chrisrichardson.ftgo...
   at net.chrisrichardson.ftgo...
   Order Service
   Exception tracking
   client library
   Exception database
   Exception tracking service
   Report exception
  </p>
<p>
   Figure 11.15
   A service exceptions را به یک exception tracking service گزارش می‌دهد، که
   exceptions را de-duplicates می‌کند و به developers هشدار می‌دهد. It has یک UI برای viewing و مدیریت exceptions.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0407_original/original_page.png" alt="Original Page 407">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<p>
   There are a few different ways برای implement audit logging:
  </p>
<p>
   Add audit logging code به business logic.
  </p>
<p>
   Use aspect-oriented programming (AOP).
  </p>
<p>
   Use event sourcing.
  </p>
<p>
   Let’s look at each option.
  </p>
<h4><span style="font-weight: bold;">ADD AUDIT LOGGING CODE TO THE BUSINESS LOGIC</span></h4>
<p>
   The first و most straightforward option، sprinkle audit logging code throughout
   your service’s business logic است. Each service method، به عنوان مثال، می‌تواند یک
   audit log entry ایجاد کند و آن را در database ذخیره کند. The drawback با این رویکرد این است که
   intertwines auditing logging code و business logic، که maintainability را کاهش می‌دهد.
   The other drawback این است که احتمالاً مستعد خطا است، زیرا به devel-
   oper writing audit logging code متکی است.
  </p>
<h4><span style="font-weight: bold;">USE ASPECT-ORIENTED PROGRAMMING</span></h4>
<p>
   The second option استفاده از AOP است. You can use an AOP framework، مانند Spring
   AOP، برای تعریف advice که به طور خودکار هر service method call را intercept می‌کند و per-
   sists یک audit log entry را. This is a much more reliable approach، زیرا به طور خودکار
   every service method invocation را ثبت می‌کند. The main drawback از استفاده از AOP این است که
   the advice فقط به method name و arguments آن دسترسی دارد، بنابراین ممکن است
   challenging باشد to determine the business object که در حال انجام است و یک business-
   oriented audit log entry را ایجاد کند.
  </p>
<h4><span style="font-weight: bold;">USE EVENT SOURCING</span></h4>
<p>
   The third و final option این است که business logic خود را با استفاده از event sourcing پیاده‌سازی کنید.
   As mentioned در فصل 6، event sourcing به طور خودکار یک audit log را برای cre-
   ate و update operations فراهم می‌کند. You need to record identity از user در هر event.
   One limitation با استفاده از event sourcing، این است که queries را ثبت نمی‌کند. If
   your service باید log entries را برای queries ایجاد کند، then you’ll have to use one of the
   other options as well.
  </p>
<h4><span style="font-weight: bold;">11.4 Developing services using the Microservice chassis 
   pattern</span></h4>
<p>
   این فصل numerous concerns را توصیف کرده است که یک service باید implement کند، شامل
   metrics, reporting exceptions به یک exception tracker, logging و health checks،
   externalized configuration و security. Moreover, as described در فصل 3، a ser-
   vice همچنین ممکن است نیاز به مدیریت service discovery و implement circuit breakers داشته باشد. That’s
   not چیزی که شما بخواهید از ابتدا هر بار که یک ser-
   vice جدید را implement می‌کنید، تنظیم کنید. If you did، این به طور بالقوه می‌تواند روزها باشد، اگر نه هفته‌ها، قبل از اینکه اولین
   line از business logic خود را بنویسید.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0408_original/original_page.png" alt="Original Page 408">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Developing services using the Microservice chassis pattern</span></h3>
<p>
   A much faster way برای توسعه services، ساختن services شما بر اساس microservices است
   chassis. As figure 11.16 نشان می‌دهد، a microservice chassis یک framework یا set از frameworks است
   که این concerns را مدیریت می‌کند. When using a microservice chassis، شما کم می‌نویسید، اگر هر،
   code برای مدیریت این concerns.
  </p>
<p>
   In this section, من ابتدا مفهوم a microservice chassis را توضیح می‌دهم و برخی را پیشنهاد می‌کنم
   excellent microservice chassis frameworks. After that من مفهوم از یک ser-
   vice mesh را معرفی می‌کنم، که در زمان نوشتن، به عنوان یک جایگزین جذاب برای
   استفاده از frameworks و libraries در حال ظهور است.
  </p>
<p>
   Let’s first look at the idea از یک microservice chassis.
  </p>
<h4><span style="font-weight: bold;">11.4.1 Using a microservice chassis</span></h4>
<p>
   A microservices chassis یک framework یا set از frameworks است که numerous را مدیریت می‌کند
   concerns شامل موارد زیر:
  </p>
<p>
   Externalized configuration
  </p>
<p>
   Health checks
  </p>
<p>
   Application metrics
  </p>
<p>
   Service discovery
  </p>
<p>
   Pattern: Microservice chassis
   Build services on a framework یا collection از frameworks که cross-cutting را مدیریت می‌کنند
   concerns، مانند exception tracking, logging, health checks, externalized configu-
   ration و distributed tracing. See http://microservices.io/patterns/microservice-
   chassis.html.
  </p>
<p>
   Service
   Service code
   Circuit breaker
   Microservice chassis
   Service discovery
   Distributed tracing
   Application metrics
   Logging
   Health check
   Externalized conﬁg.
   ...
  </p>
<p>
   Figure 11.16
   A microservice chassis
   یک framework است که numerous را مدیریت می‌کند
   concerns, such as exception tracking,
   logging, health checks, externalized
   configuration و distributed tracing.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0409_original/original_page.png" alt="Original Page 409">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<p>
   Circuit breakers
  </p>
<p>
   Distributed tracing
  </p>
<p>
   It significantly reduces the amount از code که شما نیاز دارید بنویسید. You may not even need
   to write any code. Instead, شما microservice chassis را برای مطابقت با require-
   ments خود پیکربندی می‌کنید. A microservice chassis به شما امکان می‌دهد بر توسعه service’s busi-
   ness logic خود تمرکز کنید.
  </p>
<p>
   The FTGO application از Spring Boot و Spring Cloud به عنوان microservice استفاده می‌کند
   chassis. Spring Boot عملکردهایی مانند externalized configuration را فراهم می‌کند. Spring
   Cloud عملکردهایی مانند circuit breakers را فراهم می‌کند. It also implements client-side ser-
   vice discovery، اگرچه FTGO application به infrastructure برای service متکی است
   discovery. Spring Boot و Spring Cloud تنها microservice chassis frame-
   works نیستند. If, for example, شما در حال نوشتن services در GoLang هستید، می‌توانید از Go Kit استفاده کنید
   (https://github.com/go-kit/kit) یا Micro (https://github.com/micro/micro).
  </p>
<p>
   One drawback از استفاده از یک microservice chassis این است که شما به یکی برای هر lan-
   guage/platform combination که برای توسعه services استفاده می‌کنید، نیاز دارید. Fortunately, احتمال دارد
   that many از functions که توسط a microservice chassis پیاده‌سازی شده‌اند، در عوض
   توسط the infrastructure پیاده‌سازی خواهند شد. For example, as described در فصل 3، many
   deployment environments service discovery را مدیریت می‌کنند. What’s more، بسیاری از the network-
   related functions از یک microservice chassis توسط آنچه به عنوان a service شناخته می‌شود، مدیریت می‌شود
   mesh، یک infrastructure layer که خارج از services در حال اجرا است.
  </p>
<h4><span style="font-weight: bold;">11.4.2 From microservice chassis to service mesh</span></h4>
<p>
   A microservice chassis یک راه خوب برای implement various cross-cutting است
   concerns، مانند circuit breakers. But one obstacle to استفاده از a microservice chassis این است که شما نیاز دارید
   یکی برای هر زبان برنامه‌نویسی که استفاده می‌کنید. For example, Spring Boot و Spring
   Cloud مفید هستند اگر شما یک Java/Spring developer هستید، اما اگر شما
   می‌خواهید یک NodeJS-based service را بنویسید، هیچ کمکی نمی‌کنند.
  </p>
<p>
   An emerging alternative که از این مشکل اجتناب می‌کند این است که برخی از این func-
   tionality را خارج از service در آنچه که به عنوان a service شناخته می‌شود، implement کنید. A service mesh است net-
   working infrastructure که communication را بین یک service و دیگر
   services و external applications واسطه می‌کند. As figure 11.17 نشان می‌دهد، تمام network traffic در داخل و خارج
   از یک service از طریق service mesh عبور می‌کند. It implements various concerns شامل
   circuit breakers, distributed tracing, service discovery, load balancing, و rule-based
   traffic routing. A service mesh همچنین می‌تواند interprocess communication را با استفاده از
   Pattern: Service mesh
   Route all network traffic in و out از services از طریق یک networking layer که imple-
   ments various concerns، شامل circuit breakers, distributed tracing, service dis-
   covery, load balancing و rule-based traffic routing است. See http://microservices.io/
   patterns/deployment/service-mesh.html.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0410_original/original_page.png" alt="Original Page 410">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Developing services using the Microservice chassis pattern</span></h3>
<p>
   TLS-based IPC بین services. As a result, شما دیگر نیازی به پیاده‌سازی اینها ندارید
   concerns خاص در services.
  </p>
<p>
   When using a service mesh، microservice chassis بسیار ساده‌تر است. It only needs
   تا concerns را implement کند که به شدت با application code ادغام شده‌اند، مانند
   externalized configuration و health checks. The microservice chassis باید از
   distributed tracing با propagating distributed tracing information پشتیبانی کند، مانند B3
   standard headers که در بخش 11.3.3 در مورد آن بحث کردم.
  </p>
<p>
   The service mesh concept یک ایده بسیار امیدوارکننده است. It frees the developer from
   داشتن برای مقابله با various cross-cutting concerns. Also, the ability از یک service mesh to
   The current state از service mesh implementations
  </p>
<p>
   There are various service mesh implementations، شامل موارد زیر:
  </p>
<p>
   Istio (https://istio.io)
  </p>
<p>
   Linkerd (https://linkerd.io)
  </p>
<p>
   Conduit (https://conduit.io)
  </p>
<p>
   As of the time از writing, Linkerd بالغ‌ترین است، در حالی که Istio و Conduit هنوز در حال
   active development هستند. For more information در مورد این فناوری جدید هیجان‌انگیز، یک
   نگاهی به مستندات هر محصول داشته باشید.
  </p>
<p>
   API
   gateway
   Microservice
   chassis
   Order
   Service
   Service
   mesh
   Microservice
   chassis
   Restaurant
   Service
   Microservice
   chassis
   Deployment infrastructure
   Circuit breaker
   Service discovery
   Distributed tracing
   Smart trafﬁc routing
   Load balancing
   Logging
   Microservice chassis
   Functionality moved from
   microservice chassis to
   service mesh
   Fewer functions
   Externalized conﬁg.
   Distributed tracing
   Application metrics
   Health check
   ...
   Secure communications
  </p>
<p>
   Figure 11.17
   All network traffic در داخل و خارج از یک service از طریق service mesh جریان دارد. The service
   mesh implements various functions شامل circuit breakers, distributed tracing, service discovery،
   و load balancing. Fewer functions توسط microservice chassis پیاده‌سازی می‌شوند. It also secures
   interprocess communication با استفاده از TLS-based IPC بین services.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0411_original/original_page.png" alt="Original Page 411">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 11</span></h3>
<h3><span style="font-weight: bold;">Developing production-ready services</span></h3>
<p>
   route traffic شما را قادر می‌سازد تا deployment را از release جدا کنید. It gives you the ability
   برای deploy کردن یک نسخه جدید از یک service در production اما فقط آن را به users خاص،
   مانند internal test users، release کنید. فصل 12 این مفهوم را زمانی که توضیح می‌دهد
   چگونه services را با استفاده از Kubernetes مستقر کنید، بیشتر مورد بحث قرار می‌دهد.
  </p>
<h4><span style="font-weight: bold;">Summary</span></h4>
<p>
   It’s essential که یک service الزامات functional خود را پیاده‌سازی کند، اما باید
   همچنین secure, configurable و observable باشد.
  </p>
<p>
   Many aspects از security در یک microservice architecture با معماری monolithic تفاوتی ندارند. But there are some aspects از application security
   که لزوماً متفاوت هستند، از جمله اینکه چگونه user identity بین
   API gateway و services منتقل می‌شود و چه کسی مسئول authentication و autho-
   rization است. A commonly used approach این است که API gateway clients را authenticate کند.
   The API gateway یک transparent token، مانند یک JWT، را در هر request به یک
   service قرار می‌دهد. The token شامل identity از principal و roles آنها است. The ser-
   vices از اطلاعات در token برای authorize access به resources استفاده می‌کنند. OAuth 2.0
   یک foundation خوب برای security در یک microservice architecture است.
  </p>
<p>
   A service معمولاً از یک یا چند external services استفاده می‌کند، مانند message brokers
   و databases. The network location و credentials از هر external service
   اغلب به environment که service در آن در حال اجرا است، بستگی دارد. You must apply
   the Externalized configuration pattern و یک mechanism را پیاده‌سازی کنید که pro-
   vides یک service با configuration properties در runtime. One commonly used
   approach برای زیرساخت استقرار برای ارائه آن properties از طریق
   operating system environment variables یا یک properties file زمانی که یک
   service instance ایجاد می‌کند. Another option برای یک service instance این است که configu-
   ration خود را از یک configuration properties server بازیابی کند.
  </p>
<p>
   Operations و developers مسئولیت پیاده‌سازی the observ-
   ability patterns را به اشتراک می‌گذارند. Operations مسئول the observability infrastructure است،
   مانند servers که log aggregation, metrics, exception tracking و را مدیریت می‌کنند
   distributed tracing. Developers مسئول اطمینان از این هستند که services آنها
   observable هستند. Services باید health check API endpoints داشته باشند، log تولید کنند
   entries، جمع‌آوری و expose metrics، گزارش exceptions به یک exception tracking
   service و implement distributed tracing.
  </p>
<p>
   In order to simplify و تسریع توسعه، شما باید services را
   بر اساس یک microservices chassis توسعه دهید. A microservices chassis یک framework یا set از
   frameworks است که various cross-cutting concerns را مدیریت می‌کند، از جمله those که توصیف شده‌اند
   در این فصل. Over time، اگرچه، احتمالاً many از the networking-
   related functions از یک microservice chassis به یک service mesh منتقل می‌شوند، a
   layer از infrastructure software که از طریق آن تمام network traffic از یک service
   flows.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0412_original/original_page.png" alt="Original Page 412">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   Mary و تیمش در FTGO تقریباً نوشتن اولین service خود را به پایان رسانده‌اند. اگرچه
   هنوز feature complete نیست، بر روی لپ‌تاپ‌های توسعه‌دهندگان و Jenkins CI در حال اجرا است
   server. But that’s not good enough. Software هیچ ارزشی برای FTGO ندارد تا زمانی که در حال اجرا باشد
   در production و در دسترس کاربران باشد. FTGO نیاز دارد service خود را به
   production مستقر کند.
  </p>
<p>
   This chapter covers
   The four key deployment patterns، نحوه عملکرد آنها،
   و مزایا و معایب آنها:
  </p>
<p>
   – Language-specific packaging format
   – Deploying a service as a VM
   – Deploying a service as a container
   – Serverless deployment
   Deploying services with Kubernetes
   Using a service mesh to separate deployment
   from release
   Deploying services with AWS Lambda
   Picking a deployment pattern
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0413_original/original_page.png" alt="Original Page 413">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   Deployment ترکیبی از دو مفهوم مرتبط است: process و architecture.
   The deployment process از stepهایی تشکیل شده است که باید توسط افراد انجام شود—
   developers و operations—به منظور قرار دادن نرم‌افزار در production. The deploy-
   ment architecture ساختار محیطی را تعریف می‌کند که در آن نرم‌افزار
   اجرا می‌شود. Both aspects از deployment به طور رادیکالی از زمانی که من اولین بار شروع کردم
   developing Enterprise Java applications در اواخر دهه 1990. The manual process از developers
   throwing code over the wall to production، بسیار خودکار شده است. As figure 12.1
   نشان می‌دهد، physical production environments جایگزین light-
   weight و ephemeral computing infrastructure شده‌اند.
  </p>
<p>
   Back in the 1990s، اگر شما می‌خواستید یک application را در production مستقر کنید، first
   step پرتاب application خود همراه با یک set از operating instructions over the بود
   wall to operations. You might, for example, file یک trouble ticket asking operations to
   deploy the application. Whatever happened next کاملاً responsibility از
   operations بود، مگر اینکه آنها با مشکلی روبرو می‌شدند که برای رفع آن به کمک شما نیاز داشتند. Typi-
   cally, operations application servers گران قیمت و سنگین وزن مانند WebLogic یا WebSphere را خریداری و نصب کردند.
   Then they would log in به application server
   console و applications شما را مستقر می‌کنند. They would lovingly مراقبت از آن machines، as
   if they were pets، installing patches و updating the software.
  </p>
<p>
   In the mid 2000s، the expensive application servers با open
   source, lightweight web containers مانند Apache Tomcat و Jetty جایگزین شدند. You could still
   run multiple applications در هر web container، اما داشتن یک application در هر web
   container امکان‌پذیر شد. Also, virtual machines شروع به جایگزینی physical machines کردند.
   Physical
   machine
   Application
   Physical
   machine
   Virtual
   machine
   Application
   Physical
   machine
   Virtual
   machine
   Container
   runtime
   Application
   Physical
   machine
   1990s
   2006
   2013
   2014
   AWS EC2
   released
   Initial Docker
   release
   AWS Lambda
   introduced
   Hidden
   infrastructure
   Serverless
   runtime
   Application
   Lightweight,
   ephemeral,
   automated
   Heavyweight,
   permanent,
   manual
   Time
  </p>
<p>
   Figure 12.1
   Heavyweight و long-lived physical machines از بین رفته‌اند
   by increasingly lightweight و ephemeral technologies.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0414_original/original_page.png" alt="Original Page 414">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   But machines still به عنوان pets محبوب در نظر گرفته می‌شدند، و deployment همچنان یک fundamen-
   tally manual process بود.
  </p>
<p>
   Today، the deployment process کاملاً متفاوت است. Instead از تحویل کد به
   a separate production team، پذیرش DevOps به این معنی است که
   تیم توسعه نیز مسئول deploy کردن application یا services خود هستند. In some organiza-
   tions، operations به developers یک console برای deploying code آنها ارائه می‌دهد. Or, bet-
   ter yet، once the tests pass، the deployment pipeline به طور خودکار کد را
   در production مستقر می‌کند.
  </p>
<p>
   The computing resources که در یک production environment استفاده می‌شوند نیز تغییر کرده‌اند
   به طور رادیکالی با physical machines که از بین رفته‌اند. Virtual machines که در حال اجرا هستند
   a highly automated cloud، مانند AWS، جایگزین physical و طولانی مدت pet-like شده‌اند
   virtual machines. Today’s virtual machines غیرقابل تغییر هستند. They’re treated as disposable
   cattle به جای pets و دور انداخته می‌شوند و دوباره ایجاد می‌شوند، نه اینکه دوباره پیکربندی شوند.
   Containers، یک لایه abstraction حتی سبک‌تر از virtual machines، هستند
   یک راه محبوب برای deploying applications. You can also use an even more light-
   weight serverless deployment platform، مانند AWS Lambda، برای بسیاری از موارد استفاده.
  </p>
<p>
   It’s no coincidence که تکامل از deployment processes و architectures همزمان شده است با
   the growing adoption از microservice architecture. An application
   ممکن است ده‌ها یا صدها service داشته باشد که در انواع مختلف زبان‌ها و frame-
   works نوشته شده‌اند. Because each service یک application کوچک است، این به این معنی است که شما
   دها یا صدها applications در production دارید. It’s no longer practical, for example, برای system adminis-
   trators برای hand configure servers و services. If you want to deploy microservices at
   scale، شما به یک highly automated deployment process و infrastructure نیاز دارید.
  </p>
<p>
   Figure 12.2 یک high-level view از یک production environment را نشان می‌دهد. The production
   environment developers را قادر می‌سازد تا services خود را پیکربندی و مدیریت کنند، deployment
   Service
   A
   Consumes
   services
   Service
   C
   Service
   B
   Service
   D
   User
   Observe و
   troubleshoot
   services
   Update
   services
   Conﬁgure
   و manage
   services
   Developer
   Routing
   Dash-
   boards
   Monitoring
   Service
   management
   interface
   Runtime
   Service
   management
   Alerting
   Deployment
   pipeline
  </p>
<p>
   Figure 12.2
   A simplified view از production environment. It four main capabilities را فراهم می‌کند:
   service management developers را قادر می‌سازد تا services خود را deploy و مدیریت کنند، runtime management
   مطمئن می‌شود که services در حال اجرا هستند، monitoring رفتار service را تجسم می‌کند و alerts را ایجاد می‌کند،
   و request routing requests را از users به services هدایت می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0415_original/original_page.png" alt="Original Page 415">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   pipeline برای deploy کردن نسخه‌های جدید از services، و users برای دسترسی به functionality imple-
   mented توسط آن services.
  </p>
<p>
   A production environment باید چهار قابلیت کلیدی را پیاده‌سازی کند:
  </p>
<p>
   Service management interface—Enables developers برای create، update و config-
   ure services. Ideally, این interface یک REST API است که توسط command-line و
   GUI deployment tools فراخوانی می‌شود.
  </p>
<p>
   Runtime service management—تلاش می‌کند اطمینان حاصل کند که تعداد مورد نظر از ser-
   vice instances در همه زمان‌ها در حال اجرا است. If a service instance crash می‌کند یا به نوعی
   قادر به handle کردن requests نیست، the production environment باید آن را restart کند. If a
   machine crash می‌کند، the production environment باید those service instances را
   در یک machine متفاوت restart کند.
  </p>
<p>
   Monitoring—Provides developers با insight به آنچه services آنها در حال انجام است،
   شامل log files و metrics. If there are problems, the production environ-
   ment باید به developers هشدار دهد. فصل 11 monitoring را توضیح می‌دهد، که همچنین نامیده می‌شود
   observability.
  </p>
<p>
   Request routing—Routes requests را از users به services.
  </p>
<p>
   In this chapter من چهار main deployment options را بررسی می‌کنم:
  </p>
<p>
   Deploying services به عنوان language-specific packages، مانند Java JAR یا WAR files.
   It’s worthwhile exploring این گزینه، زیرا اگرچه من استفاده از
   یکی از other options را توصیه می‌کنم، معایب آن، other options را تحریک می‌کند.
  </p>
<p>
   Deploying services به عنوان virtual machines، که deployment را با packag-
   ing یک service به عنوان یک virtual machine image که technology stack از service را encapsule می‌کند، ساده می‌کند.
  </p>
<p>
   Deploying services به عنوان containers، که سبک‌تر از virtual
   machines هستند. I show how to deploy the FTGO application’s Restaurant Service
   با استفاده از Kubernetes، یک popular Docker orchestration framework.
  </p>
<p>
   Deploying services با استفاده از serverless deployment، که حتی مدرن‌تر از
   containers است. We’ll look at how to deploy Restaurant Service با استفاده از AWS Lambda,
   یک popular serverless platform.
  </p>
<p>
   Let’s first look at how to deploy services به عنوان language-specific packages.
  </p>
<h4><span style="font-weight: bold;">12.1 Deploying services using the Language-specific 
   packaging format pattern</span></h4>
<p>
   Let’s imagine که شما می‌خواهید application FTGO’s Restaurant Service را مستقر کنید،
   که یک Spring Boot-based Java application است. One way برای deploy این service با
   استفاده از Service as a language-specific package pattern. When using this pattern،
   what’s مستقر در production و what’s managed توسط the service runtime، یک service است
   در language-specific package خود. In the case از Restaurant Service، که یا
   executable JAR file یا یک WAR file است. For other languages، مانند NodeJS، یک service
   یک directory از source code و modules است. For some languages، مانند GoLang، یک service
   یک operating system-specific executable است.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0416_original/original_page.png" alt="Original Page 416">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">Deploying services using the Language-specific packaging format pattern</span></h4>
<p>
   To deploy Restaurant Service در یک machine، شما ابتدا runtime لازم را نصب می‌کنید، که
   در این مورد JDK است. If it’s a WAR file، شما همچنین نیاز به نصب a web container مانند Apache Tomcat دارید. Once you’ve configured the machine، شما
   package را به machine کپی می‌کنید و service را شروع می‌کنید. Each service instance به عنوان
   a JVM process اجرا می‌شود.
  </p>
<p>
   Ideally، شما deployment pipeline خود را برای deploy کردن service به طور خودکار در
   production راه‌اندازی کرده‌اید، همانطور که در شکل 12.3 نشان داده شده است. The deployment pipeline، یک executable
   JAR file یا WAR file را می‌سازد. It then invokes the production environment’s service manage-
   ment interface برای deploy کردن نسخه جدید.
  </p>
<p>
   A service instance معمولاً یک process واحد است اما گاهی اوقات ممکن است یک group از pro-
   cesses باشد. A Java service instance، به عنوان مثال، یک process است که JVM را اجرا می‌کند. A NodeJS
   service ممکن است چندین worker process را برای پردازش requests به طور concur-
   rently ایجاد کند. Some languages از deploying multiple service instances در داخل the same
   process پشتیبانی می‌کنند.
  </p>
<p>
   Sometimes شما ممکن است یک service instance واحد را در یک machine مستقر کنید، در حالی که retain-
   ing the option برای deploy کردن multiple service instances در همان machine. For exam-
   ple, as figure 12.4 shows، شما می‌توانید چندین JVM را در یک machine واحد اجرا کنید. Each JVM
   یک service instance واحد را اجرا می‌کند.
  </p>
<p>
   Pattern: Language-specific packaging format
   Deploy a language-specific package into production. See http://microservices.io/
   patterns/deployment/language-specific-packaging.html.
   JVM
   process
   JVM
   process
   JVM
   process
   Service instance
   Build time
   Runtime
   Service runtime management
   Machine
   Production
   JDK/JRE
   Machine
   JDK/JRE
   Service
   code
   Executable
   JAR/WAR ﬁle
   Deployment
   pipeline
  </p>
<p>
   Figure 12.3
   The deployment pipeline یک executable JAR file را می‌سازد و آن را در production مستقر می‌کند.
   In production, هر service instance یک JVM است که در یک machine در حال اجرا است که JDK یا JRE در آن نصب شده است.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0417_original/original_page.png" alt="Original Page 417">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   Some languages همچنین به شما اجازه می‌دهند تا multiple services instances را در یک process واحد اجرا کنید. For
   example, as figure 12.5 نشان می‌دهد، شما می‌توانید چندین Java service را در یک Apache
   Tomcat واحد اجرا کنید.
  </p>
<p>
   This approach به طور معمول هنگام deployment applications در سنتی، expen-
   sive و heavyweight application servers، مانند WebLogic و WebSphere، استفاده می‌شود. You can
   همچنین services را به عنوان OSGI bundles بسته بندی کنید و چندین service instance را در هر
   OSGI container اجرا کنید.
  </p>
<p>
   The Service as a language-specific package pattern هم benefits و هم draw-
   backs دارد. Let’s first look at the benefits.
  </p>
<h4><span style="font-weight: bold;">12.1.1 Benefits of the Service as a language-specific package pattern</span></h4>
<p>
   The Service as a language-specific package pattern دارای چند benefit است:
  </p>
<p>
   Fast deployment
  </p>
<p>
   Efficient resource utilization، به خصوص هنگام اجرای multiple instances on
   the same machine یا در داخل the same process
  </p>
<p>
   Let’s look at each one.
  </p>
<p>
   JVM
   Process
   Physical or virtual machine
   Tomcat
   Service
   instance A
   JVM
   Process
   Tomcat
   Service
   instance B
   JVM
   Process
   Tomcat
   Service
   instance ...
  </p>
<p>
   Figure 12.4
   Deploying multiple service
   instances در همان machine. They
   might be instances از همان service
   یا instances از services مختلف. The
   overhead از OS بین the به اشتراک گذاشته می‌شود
   service instances. Each service instance
   یک process جداگانه است، بنابراین
   یک عایق‌بندی بین آنها وجود دارد.
   Process
   Physical or virtual machine
   Service
   instance A
   JVM
   Tomcat
   Service
   instance B
   Service
   instance ...
  </p>
<p>
   Figure 12.5
   Deploying multiple
   services instances در همان web
   container یا application server. They
   might be instances از همان service
   یا instances از services مختلف. The
   overhead از OS و runtime بین
   all the service instances به اشتراک گذاشته می‌شود. But
   به دلیل اینکه service instances در
   the same process هستند، هیچ
   عایق‌بندی بین آنها وجود ندارد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0418_original/original_page.png" alt="Original Page 418">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   FAST DEPLOYMENT
   One major benefit از این pattern این است که deploy کردن یک service instance نسبتاً
   fast است: شما service را به یک host کپی می‌کنید و آن را شروع می‌کنید. If the service در Java نوشته شده است، شما
   یک فایل JAR یا WAR کپی می‌کنید. For other languages، مانند NodeJS یا Ruby، شما
   source code را کپی می‌کنید. In either case، تعداد بایت‌های کپی شده از طریق شبکه rela-
   tively small است.
  </p>
<p>
   Also, starting a service به ندرت زمان‌بر است. If the service process خود است،
   شما آن را شروع می‌کنید. Otherwise, if the service یکی از چندین instances است که در حال اجرا است
   the same container process، شما یا به صورت پویا آن را در container مستقر می‌کنید یا restart
   the container. Because از عدم overhead، starting a service معمولاً fast است.
  </p>
<h4><span style="font-weight: bold;">EFFICIENT RESOURCE UTILIZATION</span></h4>
<p>
   Another major benefit از این pattern این است که از منابع نسبتاً کارآمد استفاده می‌کند. Mul-
   tiple service instances machine و operating system آن را به اشتراک می‌گذارند. It’s even more effi-
   cient اگر multiple service instances در داخل the same process اجرا شوند. For example, multiple
   web applications می‌توانند همان Apache Tomcat server و JVM را به اشتراک بگذارند.
  </p>
<h4><span style="font-weight: bold;">12.1.2 Drawbacks of the Service as a language-specific package pattern</span></h4>
<p>
   Despite its appeal, the Service as a language-specific package pattern دارای چندین signif-
   icant drawbacks است:
  </p>
<p>
   Lack از encapsulation از the technology stack.
  </p>
<p>
   No ability برای constrain the resources مصرف شده توسط یک service instance.
  </p>
<p>
   Lack از isolation هنگام اجرای multiple service instances در همان machine.
  </p>
<p>
   Automatically determining که کجا service instances را قرار دهیم چالش برانگیز است.
  </p>
<p>
   Let’s look at each drawback.
  </p>
<h4><span style="font-weight: bold;">LACK OF ENCAPSULATION OF THE TECHNOLOGY STACK</span></h4>
<p>
   The operation team باید جزئیات خاص را بداند که چگونه هر
   service را deploy کند. Each service به یک نسخه خاص از runtime نیاز دارد. A Java web application,
   for example, به نسخه‌های خاص از Apache Tomcat و the JDK نیاز دارد. Operations
   باید نسخه صحیح از هر software package مورد نیاز را نصب کند.
  </p>
<p>
   To make matters worse, services می‌توانند در انواع مختلفی از زبان‌ها و frame-
   works نوشته شوند. They might also be written در چندین نسخه از آن زبان‌ها و frame-
   works. Consequently, the development team باید lots از details را با operations به اشتراک بگذارد.
   This complexity خطر از errors را در طول deployment افزایش می‌دهد. A machine ممکن است، برای
   example, the wrong version از language runtime را داشته باشد.
  </p>
<h4><span style="font-weight: bold;">NO ABILITY TO CONSTRAIN THE RESOURCES CONSUMED BY A SERVICE INSTANCE</span></h4>
<p>
   Another drawback این است که شما نمی‌توانید resources مصرف شده توسط یک service را محدود کنید
   instance. A process می‌تواند بالقوه تمام CPU یا memory از یک machine را مصرف کند، starv-
   ing other service instances و operating systems از resources. This might happen, for
   example, because of a bug.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0419_original/original_page.png" alt="Original Page 419">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">LACK OF ISOLATION WHEN RUNNING MULTIPLE SERVICE INSTANCES ON THE SAME MACHINE</span></h4>
<p>
   The problem حتی زمانی که multiple instances در همان machine اجرا می‌شود، بدتر است.
   The lack از isolation به این معنی است که یک service instance که بد رفتار می‌کند می‌تواند بر other ser-
   vice instances تأثیر بگذارد. As a result، application در معرض خطر غیر قابل اعتماد بودن قرار می‌گیرد، به خصوص when run-
   ning multiple service instances در همان machine.
  </p>
<h4><span style="font-weight: bold;">AUTOMATICALLY DETERMINING WHERE TO PLACE SERVICE INSTANCES IS CHALLENGING</span></h4>
<p>
   Another challenge با running multiple service instances در همان machine است
   determining the placement از service instances. Each machine دارای یک set ثابت از
   resources، CPU، memory و غیره است، و هر service instance به مقداری
   resources نیاز دارد. It’s important برای assign service instances به machines به گونه‌ای که از the
   machines به طور موثر بدون overloading آنها استفاده شود. As I explain shortly, VM-based clouds
   و container orchestration frameworks این را به طور خودکار مدیریت می‌کنند. When deploying
   services natively، احتمال دارد که شما نیاز داشته باشید که به صورت دستی the placement را تعیین کنید.
  </p>
<p>
   As you can see, despite its familiarity, the Service as a language-specific package
   pattern دارای برخی از significant drawbacks است. You should rarely از این رویکرد استفاده کنید، مگر
   شاید زمانی که کارایی بر همه concerns دیگر غلبه کند.
  </p>
<p>
   Let’s now look at modern ways از deploying services که از این مشکلات اجتناب می‌کنند.
  </p>
<h4><span style="font-weight: bold;">12.2 Deploying services using the Service as a virtual 
   machine pattern</span></h4>
<p>
   Once again، imagine شما می‌خواهید FTGO Restaurant Service را مستقر کنید، مگر این
   time در AWS EC2. One option ایجاد و پیکربندی یک EC2 instance خواهد بود
   و کپی کردن فایل اجرایی یا WAR روی آن. Although you would get some benefit
   از استفاده از cloud، این رویکرد از معایب توضیح داده شده در pre-
   ceding section رنج می‌برد. A better, more modern approach این است که service را به عنوان a Ama-
   zon Machine Image (AMI) بسته بندی کنید، همانطور که در شکل 12.6 نشان داده شده است. Each service instance یک EC2 است
   instance که از آن AMI ایجاد شده است. The EC2 instances به طور معمول توسط an مدیریت می‌شوند
   AWS Auto Scaling group، که تلاش می‌کند تا اطمینان حاصل کند که تعداد مورد نظر از
   healthy instances همیشه در حال اجرا است.
  </p>
<p>
   The virtual machine image توسط deployment pipeline از service ساخته شده است. The deploy-
   ment pipeline، همانطور که شکل 12.6 نشان می‌دهد، یک VM image builder را اجرا می‌کند تا یک VM image ایجاد کند
   که حاوی service’s code و هر نرم‌افزاری است که برای اجرای آن لازم است. For
   example, the VM builder برای یک FTGO service JDK و the service’s exe-
   cutable JAR را نصب می‌کند. The VM image builder machine از VM image را پیکربندی می‌کند تا the
   application را هنگام boot شدن VM اجرا کند، با استفاده از Linux’s init system، مانند upstart.
  </p>
<p>
   Pattern: Deploy a service as a VM
   Deploy services packaged به عنوان VM images در production. Each service instance یک
   VM است. See http://microservices.io/patterns/deployment/service-per-vm.html.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0420_original/original_page.png" alt="Original Page 420">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">Deploying services using the Service as a virtual 
   machine pattern</span></h4>
<p>
   There are a variety از tools که deployment pipeline شما می‌تواند از آنها برای ساختن VM
   images استفاده کند. One early tool برای ایجاد EC2 AMIs Aminator است، که توسط Netflix ایجاد شده است، که
   از آن برای deploy کردن service video-streaming خود در AWS استفاده کرد (https://github.com/Netflix/
   aminator). A more modern VM image builder Packer است، که بر خلاف Aminator sup-
   ports از variety از virtualization technologies، شامل EC2, Digital Ocean, Virtual
   Box و VMware (www.packer.io). To use Packer برای ایجاد an AMI، شما یک config-
   uration file می‌نویسید که base image و a set از provisioners را مشخص می‌کند که نرم‌افزار را نصب می‌کند
   و AMI را پیکربندی می‌کند.
  </p>
<h4><span style="font-weight: bold;">About Elastic Beanstalk</span></h4>
<p>
   Elastic Beanstalk، که توسط AWS ارائه شده است، یک راه آسان برای deploy کردن services شما است
   با استفاده از VMs. You upload code خود را، مانند یک فایل WAR، و Elastic Beanstalk deploy می‌کند
   it به عنوان one یا بیشتر load-balanced و managed EC2 instances. Elastic Beanstalk است
   شاید نه به اندازه Kubernetes، اما یک راه آسان برای deployment است
   a microservices-based application در EC2.
  </p>
<p>
   Interestingly, Elastic Beanstalk عناصر سه deployment patterns را ترکیب می‌کند
   توضیح داده شده در این فصل. It supports چندین packaging formats برای چندین lan-
   guages، شامل Java, Ruby و .NET. It deploys application را به عنوان VMs، اما به جای
   ساختن یک AMI، از یک base image استفاده می‌کند که application را در startup نصب می‌کند.
  </p>
<p>
   Build time
   Runtime
   Requests
   Deployed as
   Service
   EC2 instance
   Autoscaling group
   Service
   EC2 instance
   Service
   EC2 instance
   Service
   code
   Deployment pipeline
   Creates
   VM image
   builder
   Elastic load
   balancer
   AMI
   (VM
   image)
  </p>
<p>
   Figure 12.6
   The deployment pipeline یک service را به عنوان یک virtual machine image، مانند an EC2 بسته بندی می‌کند
   AMI، حاوی هر چیزی که برای اجرای service لازم است، از جمله language runtime. At runtime،
   هر service instance یک VM است، مانند an EC2 instance، که از آن image نمونه‌سازی شده است. An EC2 Elastic
   Load Balancer requests را به instances هدایت می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0421_original/original_page.png" alt="Original Page 421">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   Let’s look at the benefits و drawbacks از استفاده از این approach.
  </p>
<h4><span style="font-weight: bold;">12.2.1 The benefits of deploying services as VMs</span></h4>
<p>
   The Service as a virtual machine pattern دارای تعدادی از benefits است:
  </p>
<p>
   The VM image encapsule می‌کند the technology stack.
  </p>
<p>
   Isolated service instances.
  </p>
<p>
   Uses mature cloud infrastructure.
  </p>
<p>
   Let’s look at each one.
  </p>
<h4><span style="font-weight: bold;">THE VM IMAGE ENCAPSULATES THE TECHNOLOGY STACK</span></h4>
<p>
   An important benefit از این pattern این است که the VM image حاوی service و همه
   از dependencies آن است. It eliminates the error-prone requirement برای نصب صحیح و
   set up نرم‌افزاری که یک service برای اجرا به آن نیاز دارد. Once a service به عنوان یک
   virtual machine بسته بندی شده است، به یک black box تبدیل می‌شود که tech از service شما را encapsule می‌کند
   nology stack. The VM image را می‌توان بدون modification در هر جایی مستقر کرد. The API
   برای deploy کردن service به the VM management API تبدیل می‌شود. Deployment می‌شود
   بسیار ساده‌تر و قابل اطمینان‌تر.
  </p>
<h4><span style="font-weight: bold;">SERVICE INSTANCES ARE ISOLATED</span></h4>
<p>
   A major benefit از virtual machines این است که هر service instance در complete iso-
   lation اجرا می‌شود. That, after all, یکی از main goals از virtual machine technology است. Each vir-
   tual machine دارای یک مقدار ثابت از CPU و memory است و نمی‌تواند resources را از
   other services بدزدد.
  </p>
<h4><span style="font-weight: bold;">USES MATURE CLOUD INFRASTRUCTURE</span></h4>
<p>
   Another benefit از deploying microservices شما به عنوان virtual machines این است که شما می‌توانید
   از زیرساخت cloud بالغ و بسیار خودکار استفاده کنید. Public clouds مانند AWS
   تلاش می‌کنند تا VMs را بر روی physical machines به گونه‌ای برنامه‌ریزی کنند که از overloading the اجتناب کند
   machine. They also provide features ارزشمند مانند load balancing از traffic در سراسر
   VMs و autoscaling.
  </p>
<h4><span style="font-weight: bold;">12.2.2 The drawbacks of deploying services as VMs</span></h4>
<p>
   The Service as a VM pattern همچنین دارای برخی از drawbacks است:
  </p>
<p>
   Less-efficient resource utilization
  </p>
<p>
   Relatively slow deployments
  </p>
<p>
   System administration overhead
  </p>
<p>
   Let’s look at each drawback در turn.
  </p>
<p>
   (continued)
   Elastic Beanstalk همچنین می‌تواند Docker containers را مستقر کند. Each EC2 instance یک col-
   lection از one یا بیشتر containers را اجرا می‌کند. Unlike a Docker orchestration framework، پوشش داده شده است
   later در این فصل، the unit از scaling the EC2 instance است و نه a container.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0422_original/original_page.png" alt="Original Page 422">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">LACK OF ISOLATION WHEN RUNNING MULTIPLE SERVICE INSTANCES ON THE SAME MACHINE</span></h4>
<p>
   The problem is even worse when running multiple instances در همان machine.
   The lack از isolation به این معنی است که یک service instance که بد رفتار می‌کند می‌تواند بر other ser-
   vice instances تأثیر بگذارد. As a result, the application در معرض خطر غیر قابل اعتماد بودن قرار می‌گیرد، به خصوص when run-
   ning multiple service instances در همان machine.
  </p>
<h4><span style="font-weight: bold;">LESS-EFFICIENT RESOURCE UTILIZATION</span></h4>
<p>
   Each service instance دارای overhead از یک virtual machine کامل است، شامل
   operating system آن. Moreover, a typical public IaaS virtual machine یک مجموعه محدود ارائه می‌دهد
   از VM sizes، بنابراین VM احتمالاً underutilized خواهد بود. This is less likely to be a prob-
   lem برای Java-based services، زیرا آنها نسبتاً heavyweight هستند. But this pattern
   ممکن است یک راه inefficient از deploying lightweight NodeJS و GoLang services باشد.
  </p>
<h4><span style="font-weight: bold;">RELATIVELY SLOW DEPLOYMENTS</span></h4>
<p>
   Building a VM image معمولاً به چند دقیقه نیاز دارد به دلیل سایز از
   the VM. There are lots از bits برای انتقال از طریق شبکه. Also, instantiating a VM
   از a VM image زمان‌بر است، به دلیل، بار دیگر، مقدار data که
   باید از طریق شبکه منتقل شود. The operating system که در داخل VM در حال اجرا است نیز
   مقدار زمانی برای boot می‌برد، اگرچه slow یک اصطلاح نسبی است. This process، که شاید
   minutes طول می‌کشد، بسیار سریع‌تر از the traditional deployment process است. But it’s much
   سریع‌تر از deployment patterns سبک‌تری که به زودی در مورد آنها خواهید خواند.
  </p>
<h4><span style="font-weight: bold;">SYSTEM ADMINISTRATION OVERHEAD</span></h4>
<p>
   You’re responsible برای patching the operation system و runtime. System administra-
   tion ممکن است اجتناب‌ناپذیر به نظر برسد، اما later در بخش 12.5، I describe
   serverless deployment، که این نوع از system administration را حذف می‌کند.
  </p>
<p>
   Let’s now look at یک راه جایگزین برای deploy microservices که more light-
   weight است، اما هنوز هم بسیاری از benefits از virtual machines را دارد.
  </p>
<h4><span style="font-weight: bold;">12.3 Deploying services using the Service as 
   a container pattern</span></h4>
<p>
   Containers یک mechanism deployment مدرن‌تر و سبک‌تر هستند. They’re an
   operating-system-level virtualization mechanism. A container, as figure 12.7 نشان می‌دهد،
   معمولاً از یک process اما گاهی اوقات multiple processes running در یک sandbox، که
   آن را از other containers جدا می‌کند، تشکیل شده است. A container که یک Java service را اجرا می‌کند، به عنوان مثال،
   به طور معمول از the JVM process تشکیل می‌شود.
  </p>
<p>
   From the perspective از یک process که در یک container در حال اجرا است، انگار که در حال اجرا است
   its own machine. It typically دارای IP address خود است، که port conflicts را حذف می‌کند. All
   Java processes می‌توانند، به عنوان مثال، در پورت 8080 listen کنند. Each container همچنین دارای
   root filesystem خود است. The container runtime از operating system mechanisms برای جدا کردن استفاده می‌کند
   the containers از یکدیگر. The most popular example از a container runtime
   Docker است، اگرچه موارد دیگری نیز وجود دارد، مانند Solaris Zones.
  </p>
<p>
   Pattern: Deploy a service as a container
   Deploy services packaged به عنوان container images در production. Each service instance
   یک container است. See http://microservices.io/patterns/deployment/service-per-container
   .html.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0423_original/original_page.png" alt="Original Page 423">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   When شما یک container ایجاد می‌کنید، می‌توانید resources از CPU، memory و، بسته به
   the container implementation، شاید I/O resources را مشخص کنید. The container run-
   time این limits را اعمال می‌کند و از اینکه یک container resources از machine خود را اشغال کند، جلوگیری می‌کند. When using a Docker orchestration framework مانند Kubernetes،
   espec-
   ially مهم است که resources از یک container را مشخص کنید. That’s because the orchestration
   framework از resources درخواست شده از یک container برای انتخاب machine برای اجرای the
   container استفاده می‌کند و در نتیجه اطمینان حاصل می‌کند که machines overload نشده‌اند.
  </p>
<p>
   Figure 12.8 فرآیند deploy کردن یک service را به عنوان یک container نشان می‌دهد. At build-time،
   the deployment pipeline از یک container image-building tool استفاده می‌کند، که کد از ser-
   vice و یک description از image را می‌خواند، تا container image را ایجاد کند و آن را ذخیره می‌کند
   در یک registry. At runtime، the container image از registry کشیده می‌شود و برای
   create containers استفاده می‌شود.
  </p>
<p>
   Let’s take a look at build-time و runtime steps در detail بیشتر.
  </p>
<p>
   Container
   Machine
   Service
   process
   Container
   Container runtime, such as Docker
   Service
   process
   Container
   Service
   process
   Operating System
   Each container یک sandbox است
   that isolates the processes.
   Shared by all از the containers
  </p>
<p>
   Figure 12.7
   A container متشکل از one یا بیشتر processes است
   running در یک sandbox ایزوله. Multiple containers معمولاً در حال اجرا هستند
   در یک machine واحد. The containers operating system را به اشتراک می‌گذارند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0424_original/original_page.png" alt="Original Page 424">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">Deploying services using the Service as 
   a container pattern</span></h4>
<h4><span style="font-weight: bold;">12.3.1 Deploying services using Docker</span></h4>
<p>
   To deploy a service به عنوان یک container، شما باید آن را به عنوان یک container image بسته‌بندی کنید. A container
   image یک filesystem image است که متشکل از application و هر نرم‌افزاری است که برای
   اجرای service لازم است. It’s often a complete Linux root filesystem، اگرچه سبک‌تر
   images نیز استفاده می‌شوند. For example, برای deploy کردن یک Spring Boot-based service، شما a را می‌سازید
   container image که شامل service’s executable JAR و نسخه صحیح از
   the JDK است. Similarly, برای deploy کردن یک Java web application، شما یک container را می‌سازید
   image که حاوی فایل WAR، Apache Tomcat و the JDK است.
  </p>
<h4><span style="font-weight: bold;">BUILDING A DOCKER IMAGE</span></h4>
<p>
   The first step در building an image ایجاد کردن a Dockerfile است. A Dockerfile چگونگی را توصیف می‌کند
   to build a Docker container image. It specifies the base container image, a series از
   instructions برای نصب نرم‌افزار و پیکربندی container، و shell com-
   mand برای اجرا زمانی که container ایجاد می‌شود. Listing 12.1 the Dockerfile را نشان می‌دهد که برای
   build کردن یک image برای Restaurant Service استفاده می‌شود. It builds a container image که حاوی
   service’s executable JAR file است. It configures the container برای اجرای java -jar com-
   mand در startup.
  </p>
<p>
   Build time
   Runtime
   $ docker build ...
   Deployed
   as
   Deployed
   as
   Service
   instance
   Container
   VM
   VM
   Container
   image registry
   Service
   instance
   Container
   Service
   code
   Container runtime
   Container runtime
   Deployment pipeline
   Creates
   Container
   builder tool
   Docker
   ﬁle
   Service
   container
   image
  </p>
<p>
   Figure 12.8
   A service به عنوان یک container image بسته‌بندی می‌شود، که در یک registry ذخیره می‌شود. At runtime
   the service از multiple containers تشکیل شده است که از آن image ایجاد شده‌اند. Containers معمولاً در حال اجرا هستند
   on virtual machines. A single VM معمولاً چندین containers را اجرا می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0425_original/original_page.png" alt="Original Page 425">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<pre><code class="language-text">
  FROM openjdk:8u171-jre-alpine
  RUN apk --no-cache add curl
  CMD java ${JAVA_OPTS} -jar ftgo-restaurant-service.jar
  HEALTHCHECK --start-period=30s --
  interval=5s CMD curl http://localhost:8080/actuator/health || exit 1
  COPY build/libs/ftgo-restaurant-service.jar .
  </code></pre>
<p>
   The base image openjdk:8u171-jre-alpine یک image از نوع Linux minimal است con-
   taining the JRE. The Dockerfile service’s JAR را به image کپی می‌کند و config-
   ures image برای execute کردن JAR در startup. It also configures Docker برای به صورت دوره‌ای
   health check endpoint، که در فصل 11 توضیح داده شد، فراخوانی کند. The HEALTHCHECK direc-
   tive می‌گوید که health check endpoint API، که در فصل 11 توضیح داده شد، را اجرا کند، هر 5 sec-
   onds پس از یک initial 30-second delay، که به service زمان می‌دهد تا شروع شود.
  </p>
<p>
   Once you’ve written the Dockerfile، شما می‌توانید image را build کنید. The following
   listing نشان می‌دهد که shell commands برای build کردن image برای Restaurant Service. The
   script JAR file از service را build می‌کند و دستور docker build را برای ایجاد
   the image اجرا می‌کند.
  </p>
<pre><code class="language-text">
  cd ftgo-restaurant-service
  ../gradlew assemble
  docker build -t ftgo-restaurant-service .
  </code></pre>
<p>
   The docker build command دارای دو آرگومان است: the -t argument نام را مشخص می‌کند
   از image، و the . مشخص می‌کند که Docker context را صدا می‌کند. The context، که در
   این مثال current directory است، متشکل از Dockerfile و فایل‌هایی است که برای
   build کردن the image استفاده می‌شود. The docker build command context را به Docker dae-
   mon آپلود می‌کند، که the image را می‌سازد.
  </p>
<h4><span style="font-weight: bold;">PUSHING A DOCKER IMAGE TO A REGISTRY</span></h4>
<p>
   The final step از the build process این است که newly built Docker image را به آنچه است
   به عنوان a registry شناخته می‌شود، push کنید. A Docker registry معادل یک Java Maven repository برای
   Java libraries، یا یک NodeJS npm registry برای NodeJS packages است. Docker hub یک exam-
   ple از یک public Docker registry است و معادل Maven Central یا NpmJS.org است. But
   برای applications شما احتمالاً می‌خواهید از یک private registry استفاده کنید که توسط ser-
   vices، مانند Docker Cloud registry یا AWS EC2 Container Registry، ارائه شده است.
  </p>
<p>
   You must use دو دستور Docker برای push کردن یک image به یک registry. First, you use
   the docker tag command برای دادن نام image که با hostname پیشوند دارد
  </p>
<p>
   Listing 12.1
   The Dockerfile used to build Restaurant Service
   Listing 12.2
   The shell commands used to build the container image for
   Restaurant Service
   The base image
   Install curl برای
   استفاده توسط the
   health check.
   Configure Docker
   برای run java -jar ..
   when the container
   is started.
   Configure Docker to
   invoke the health
   check endpoint.
   Copies the JAR in Gradle’s build
   directory into the image
   Change to the
   service’s directory.
   Build the
   service’s JAR.
   Build the image.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0426_original/original_page.png" alt="Original Page 426">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">Deploying services using the Service as 
   a container pattern</span></h4>
<p>
   و optional port از registry. The image name نیز با version پسوند می‌شود،
   که هنگام ایجاد یک release جدید از service مهم خواهد بود. For example, if
   the hostname از registry registry.acme.com است، شما از این دستور برای
   tag کردن image استفاده می‌کنید:
  </p>
<pre><code class="language-text">
  docker tag ftgo-restaurant-service registry.acme.com/ftgo-restaurant-
  service:1.0.0.RELEASE
  </code></pre>
<p>
   Next شما از docker push command برای آپلود that tagged image به registry استفاده می‌کنید:
  </p>
<pre><code class="language-text">
  docker push registry.acme.com/ftgo-restaurant-service:1.0.0.RELEASE
  </code></pre>
<p>
   This command اغلب زمان کمتری نسبت به آنچه انتظار دارید می‌گیرد. That’s because a
   Docker image آنچه را که به عنوان یک layered file system شناخته می‌شود، دارد، که به Docker امکان می‌دهد فقط
   part از image را از طریق شبکه منتقل کند. An image’s operating system, Java run-
   time و application در لایه‌های جداگانه هستند. Docker فقط نیاز دارد که آن لایه‌ها را انتقال دهد
   که در destination وجود ندارند. As a result, transferring an image over a net-
   work هنگامیکه Docker فقط باید لایه‌های application را منتقل کند، که یک
   fraction از image.
  </p>
<p>
   Now that we’ve pushed the image to a registry، بیایید نگاهی بیندازیم به نحوه ایجاد یک
   container.
  </p>
<h4><span style="font-weight: bold;">RUNNING A DOCKER CONTAINER</span></h4>
<p>
   Once شما service خود را به عنوان یک container image بسته‌بندی کرده‌اید، شما می‌توانید سپس یک یا
   بیشتر containers را ایجاد کنید. The container infrastructure، image را از registry می‌کشد
   بر روی یک production server. It will then ایجاد می‌کند one یا بیشتر containers از that image.
   Each container یک instance از service شما است.
  </p>
<p>
   As you might expect, Docker a docker run command را فراهم می‌کند که ایجاد می‌کند و
   یک container را شروع می‌کند. Listing 12.3 نحوه استفاده از این دستور برای اجرای Restaurant را نشان می‌دهد
   Service. The docker run command چندین argument دارد، از جمله the container
   image و یک specification از environment variables برای تنظیم در runtime container.
   These برای passing a externalized configuration استفاده می‌شوند، مانند database’s network
   location و بیشتر.
  </p>
<pre><code class="language-text">
  docker run \
  -d \
  --name ftgo-restaurant-service \
  -p 8082:8080 \
  -e SPRING_DATASOURCE_URL=... -e SPRING_DATASOURCE_USERNAME=... \
  -e SPRING_DATASOURCE_PASSWORD=... \
  registry.acme.com/ftgo-restaurant-service:1.0.0.RELEASE
  </code></pre>
<p>
   Listing 12.3
   Using docker run برای اجرای a containerized service
   Runs it as a
   background daemon
   The name از
   the container
   Binds پورت 8080 از
   the container به پورت 8082
   از the host machine
   Environment
   variables
   Image برای اجرا
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0427_original/original_page.png" alt="Original Page 427">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   The docker run command image را از registry در صورت نیاز، pull می‌کند. It then cre-
   ates و container را شروع می‌کند، که دستور java -jar را که در the
   Dockerfile مشخص شده است، اجرا می‌کند.
  </p>
<p>
   Using the docker run command ممکن است ساده به نظر برسد، اما چندین prob-
   lems وجود دارد. One این است که docker run یک راه قابل اعتماد برای deploy کردن یک service نیست، زیرا
   یک container را که در یک machine واحد در حال اجرا است، ایجاد می‌کند. The Docker engine برخی از basic را فراهم می‌کند
   management features، مانند راه‌اندازی مجدد خودکار containers اگر crash کنند یا اگر
   machine reboot شود. But it doesn’t handle machine crashes.
  </p>
<p>
   Another problem این است که services معمولاً در isolation وجود ندارند. They depend on
   other services، مانند databases و message brokers. It would be nice برای deploy کردن یا
   undeploy کردن یک service و dependencies آن به عنوان یک واحد.
  </p>
<p>
   A better approach که به ویژه در طول توسعه مفید است، استفاده از Docker است
   Compose. Docker Compose ابزاری است که به شما اجازه می‌دهد یک set از contain-
   ers را با استفاده از یک فایل YAML تعریف کنید، و سپس آن containers را به عنوان یک گروه شروع و متوقف کنید. What’s
   more، the YAML file یک راه مناسب برای مشخص کردن numerous externalized configura-
   tion properties است. To learn more about Docker Compose، من خواندن Docker را توصیه می‌کنم
   in Action by Jeff Nickoloff (Manning, 2016) و نگاهی به docker-compose.yml
   file در the example code.
  </p>
<p>
   The problem با Docker Compose، though، این است که به یک machine واحد محدود می‌شود.
   To deploy services به طور قابل اطمینان، شما باید از یک Docker orchestration framework استفاده کنید، مانند
   Kubernetes، که یک set از machines را به یک pool از resources تبدیل می‌کند. I describe how to
   use Kubernetes later، در بخش 12.4. First، بیایید the benefits و drawbacks از
   استفاده از containers را بررسی کنیم.
  </p>
<h4><span style="font-weight: bold;">12.3.2 Benefits of deploying services as containers</span></h4>
<p>
   Deploying services به عنوان containers دارای چندین benefit است. First، containers دارای many از
   the benefits از virtual machines:
  </p>
<p>
   Encapsulation از the technology stack که در آن the API برای مدیریت ser-
   vices شما به the container API تبدیل می‌شود.
  </p>
<p>
   Service instances are isolated.
  </p>
<p>
   Service instances’s resources are constrained.
  </p>
<p>
   But unlike virtual machines, containers یک technology سبک‌وزن هستند. Container
   images معمولاً fast to build هستند. For example, در laptop من، بسته بندی یک Spring Boot application به عنوان یک container image، تنها 5 ثانیه طول می‌کشد. Moving a container
   image over the network، مانند to and from the container registry، نیز نسبتاً
   fast است، عمدتاً به این دلیل که فقط a subset از image’s layers باید منتقل شود. Con-
   tainers همچنین بسیار سریع شروع می‌شوند، زیرا هیچ process lengthy OS boot وجود ندارد. When a
   container starts, all that runs، service است.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0428_original/original_page.png" alt="Original Page 428">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">12.3.3 Drawbacks of deploying services as containers</span></h4>
<p>
   One significant drawback از containers این است که شما مسئول the undifferenti-
   ated heavy lifting از administering the container images هستید. You must patch the operat-
   ing system و runtime. Also, unless شما از یک hosted container solution مانند
   Google Container Engine یا AWS ECS استفاده می‌کنید، شما باید the container infrastruc-
   ture و احتمالاً the VM infrastructure را که بر روی آن اجرا می‌شود، مدیریت کنید.
  </p>
<h4><span style="font-weight: bold;">12.4 Deploying the FTGO application with Kubernetes</span></h4>
<p>
   Now that we’ve looked at containers و their trade-offs، let’s look at how to deploy
   the FTGO application’s Restaurant Service با استفاده از Kubernetes. Docker Compose،
   توضیح داده شده در بخش 12.3.1، برای توسعه و تست عالی است. But to reliably run
   containerized services در production، شما نیاز دارید که از یک con-
   tainer runtime بسیار پیچیده‌تر، مانند Kubernetes، استفاده کنید. Kubernetes یک Docker orchestration framework است،
   a layer از نرم‌افزار در بالای Docker که یک set از machines را به یک pool واحد از
   resources برای running services تبدیل می‌کند. It endeavors برای حفظ تعداد مورد نظر از instances
   از هر service که در همه زمان‌ها در حال اجراست، حتی زمانی که service instances یا machines crash می‌کنند.
  </p>
<p>
   The agility از containers combined با the sophistication از Kubernetes یک compel-
   ling way برای deploy کردن services است.
  </p>
<p>
   In this section, من ابتدا یک overview از Kubernetes، functionality و آن را ارائه می‌دهم
   architecture. After that، من نشان می‌دهم که چگونه یک service را با استفاده از Kubernetes مستقر کنید. Kubernetes است
   یک topic پیچیده، و covering آن به طور جامع فراتر از scope از این کتاب است، بنابراین من فقط
   نشان می‌دهم که چگونه از Kubernetes از perspective از یک developer استفاده کنید. For more informa-
   tion, من توصیه می‌کنم Kubernetes in Action توسط Marko Luksa (Manning, 2018).
  </p>
<h4><span style="font-weight: bold;">12.4.1 Overview of Kubernetes</span></h4>
<p>
   Kubernetes یک Docker orchestration framework است. A Docker orchestration framework رفتار می‌کند
   a set از machines که Docker را به عنوان یک pool از resources اجرا می‌کنند. You tell the Docker orches-
   tration framework برای اجرای N instances از service شما، و آن بقیه را مدیریت می‌کند. Figure 12.9
   the architecture از a Docker orchestration framework را نشان می‌دهد.
  </p>
<p>
   A Docker orchestration framework، مانند Kubernetes، دارای سه function اصلی است:
  </p>
<p>
   Resource management—Treats یک cluster از machines به عنوان a pool از CPU، memory،
   و storage volumes، turning the collection از machines به یک machine واحد.
  </p>
<p>
   Scheduling—انتخاب machine برای اجرای container شما. By default, scheduling
   the resource requirements از container و available از هر node را در نظر می‌گیرد
   resources. It might also implement affinity، که containers را در same node قرار می‌دهد، و anti-affinity، که
   containers را در nodes مختلف قرار می‌دهد.
  </p>
<p>
   Service management—Implements مفهوم از named و versioned services
   that map مستقیماً به services در microservice architecture. The orchestration
   framework تضمین می‌کند که تعداد مورد نظر از healthy instances در حال اجرا است
   در همه زمان‌ها. It load balances requests در سراسر آنها. The orchestration framework
   rolling upgrades از services را انجام می‌دهد و به شما امکان می‌دهد به یک نسخه قدیمی بازگردید.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0429_original/original_page.png" alt="Original Page 429">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   Docker orchestration frameworks یک راه فزاینده محبوب برای deploy applications هستند.
   Docker Swarm بخشی از the Docker engine است، بنابراین آسان است که راه‌اندازی و استفاده شود. Kuber-
   netes برای راه‌اندازی و مدیریت بسیار پیچیده‌تر است، اما بسیار پیچیده‌تر است.
   At the time از writing, Kubernetes دارای momentum زیادی است، با یک عظیم open
   source community. Let’s take a closer look at how it works.
  </p>
<h4><span style="font-weight: bold;">KUBERNETES ARCHITECTURE</span></h4>
<p>
   Kubernetes بر روی یک cluster از machines اجرا می‌شود. Figure 12.10 معماری a را نشان می‌دهد
   Kubernetes cluster. Each machine در یک Kubernetes cluster یا a master است یا a node.
   A typical cluster یک تعداد کمی master دارد—شاید فقط یک—و many nodes.
   A master machine مسئول managing the cluster است. A node یک worker است که اجرا می‌کند
   one یا بیشتر pods. A pod واحد از deployment از Kubernetes است و شامل یک set از
   containers.
  </p>
<p>
   A master چندین component را اجرا می‌کند، شامل موارد زیر:
  </p>
<p>
   API server—The REST API برای deploy کردن و managing services، که توسط
   kubectl command-line interface استفاده می‌شود، به عنوان مثال.
  </p>
<p>
   Etcd—A key-value NoSQL database که the cluster data را ذخیره می‌کند.
   SVC
   A
   SVC
   B
   SVC
   C
   Container
   Docker orchestration framework
   Container
   Container
   Docker
   Operating
   system
   Machine
   Docker
   Operating
   system
   Machine
   Docker
   Operating
   system
   Machine
   Service management
   Scheduling
   Resource management
  </p>
<p>
   Figure 12.9
   A Docker orchestration
   framework یک set از machines که Docker را اجرا می‌کنند به
   یک cluster از resources تبدیل می‌کند. It assigns
   containers to machines. The framework
   تلاش می‌کند تا the desired number از
   healthy containers را در همه زمان‌ها در حال اجرا نگه دارد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0430_original/original_page.png" alt="Original Page 430">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">Deploying the FTGO application with Kubernetes</span></h4>
<p>
   Scheduler—یک node را برای اجرای یک pod انتخاب می‌کند.
  </p>
<p>
   Controller manager—controllers را اجرا می‌کند، که اطمینان حاصل می‌کنند که state از the clus-
   ter با the intended state مطابقت دارد. For example, یک نوع از controller که به عنوان a
   replication controller شناخته می‌شود، تضمین می‌کند که تعداد مورد نظر از instances از یک service
   با راه‌اندازی و خاتمه دادن به instances، در حال اجرا هستند.
  </p>
<p>
   A node چندین component را اجرا می‌کند، شامل موارد زیر:
  </p>
<p>
   Kubelet—pods که در حال اجرا هستند را در node ایجاد و مدیریت می‌کند
  </p>
<p>
   Kube-proxy—Networking را مدیریت می‌کند، از جمله load balancing در سراسر pods
  </p>
<p>
   Pods—The application services
   SVC
   Pod
   Kubernetes master
   etcd
   Kubelet
   Kube-proxy
   Kubernetes node
   SVC
   Pod
   Kubelet
   Kube-proxy
   Kubernetes node
   Application
   requests
   Conﬁguration
   commands
   Developer
   Aplication
   user
   Deployment
   pipeline
   Kubecti
   CLI
   API Server
   Controller
   management
   Scheduler
  </p>
<p>
   Figure 12.9
   A Docker orchestration
   framework یک set از machines را که Docker را اجرا می‌کنند به
   یک cluster از resources تبدیل می‌کند. It assigns
   containers to machines. The framework
   تلاش می‌کند تا the desired number از
   healthy containers را در همه زمان‌ها در حال اجرا نگه دارد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0431_original/original_page.png" alt="Original Page 431">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   Let’s now look at key Kubernetes concepts که شما باید برای deploy کردن services در آن
   Kubernetes تسلط داشته باشید.
  </p>
<h4><span style="font-weight: bold;">KEY KUBERNETES CONCEPTS</span></h4>
<p>
   As mentioned در مقدمه این بخش، Kubernetes بسیار پیچیده است. But it’s
   ممکن است که از Kubernetes به طور موثر استفاده کنید، زمانی که شما به چند مفهوم کلیدی، که نامیده می‌شود، تسلط داشته باشید
   objects. Kubernetes many types از objects را تعریف می‌کند. From a developer’s perspective، the
   مهمترین objects به شرح زیر است:
  </p>
<p>
   Pod—A pod واحد اساسی از deployment در Kubernetes است. It consists از one یا
   بیشتر containers که یک IP address و storage volumes را به اشتراک می‌گذارند. The pod برای a
   service instance اغلب از یک container واحد تشکیل شده است، مانند یک container که در حال اجراست
   the JVM. But in some scenarios a pod شامل one یا بیشتر sidecar containers است،
   که supporting functions را پیاده‌سازی می‌کنند. For example, an NGINX server می‌تواند
   یک sidecar داشته باشد که به طور دوره‌ای یک git pull انجام می‌دهد تا آخرین version را دانلود کند
   از وب‌سایت. A pod ephemeral است، زیرا یا the pod’s containers یا the
   node که بر روی آن در حال اجرا است، ممکن است crash کند.
  </p>
<p>
   Deployment—A declarative specification از یک pod. A deployment یک controller است
   که تضمین می‌کند که تعداد مورد نظر از instances از the pod (service instances)
   همیشه در حال اجرا هستند. It supports versioning با rolling upgrades و roll-
   backs. Later در بخش 12.4.2، شما خواهید دید که هر service در a microservice
   architecture، یک Kubernetes deployment است.
  </p>
<p>
   Service—Provides clients از یک application service با یک static/stable network
   location. It’s a form از infrastructure-provided service discovery، که در
   فصل 3 توضیح داده شد. A service یک IP address و یک DNS name دارد که به آن IP
   address متصل می‌شود و TCP و UDP traffic را در سراسر one یا بیشتر pods load balance می‌کند. The
   IP address و یک DNS name فقط در داخل the Kubernetes قابل دسترسی هستند. Later, I
   describe how to configure services که از خارج از cluster قابل دسترسی هستند.
  </p>
<p>
   ConfigMap—A named collection از name-value pairs که external-
   ized configuration را برای one یا بیشتر application services تعریف می‌کند (فصل 11 را برای
   یک overview از externalized configuration ببینید). The definition از a pod’s container
   می‌تواند به a ConfigMap برای تعریف the container’s environment variables ارجاع دهد. It
   همچنین می‌تواند از a ConfigMap برای ایجاد configuration files در داخل the container استفاده کند. You
   می‌توانید اطلاعات حساس، مانند passwords، را در یک فرم از ConfigMap ذخیره کنید
   به نام a Secret.
  </p>
<p>
   Now that we’ve reviewed the key Kubernetes concepts، بیایید آنها را در عمل با نگاهی بیندازیم
   که چگونه یک application service را در Kubernetes مستقر کنیم.
  </p>
<h4><span style="font-weight: bold;">12.4.2 Deploying the Restaurant service on Kubernetes</span></h4>
<p>
   As mentioned earlier, برای deploy کردن یک service در Kubernetes، شما نیاز دارید یک deploy-
   ment تعریف کنید. The easiest way برای create a Kubernetes object مانند یک deployment نوشتن است
   یک فایل YAML. Listing 12.4 یک فایل YAML است که یک deployment را برای Restaurant Service تعریف می‌کند.
   This deployment specifies running two replicas از یک pod. The pod فقط یک container دارد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0432_original/original_page.png" alt="Original Page 432">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">Deploying the FTGO application with Kubernetes</span></h4>
<p>
   The container definition image Docker را به همراه other attri-
   butes، مانند the values از environment variables، مشخص می‌کند. The container’s environment vari-
   ables externalized configuration از service هستند. They are read توسط Spring Boot و
   properties را در application context در دسترس قرار می‌دهند.
  </p>
<pre><code class="language-text">
  apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
  name: ftgo-restaurant-service
  spec:
  replicas: 2
  template:
  metadata:
  labels:
  app: ftgo-restaurant-service
  spec:
  containers:
  - name: ftgo-restaurant-service
  image: msapatterns/ftgo-restaurant-service:latest
  imagePullPolicy: Always
  ports:
  - containerPort: 8080
  name: httpport
  env:
  - name: JAVA_OPTS
  value: "-Dsun.net.inetaddr.ttl=30"
  - name: SPRING_DATASOURCE_URL
  value: jdbc:mysql://ftgo-mysql/eventuate
  - name: SPRING_DATASOURCE_USERNAME
  valueFrom:
  secretKeyRef:
  name: ftgo-db-secret
  key: username
  - name: SPRING_DATASOURCE_PASSWORD
  valueFrom:
  secretKeyRef:
  name: ftgo-db-secret
  key: password
  - name: SPRING_DATASOURCE_DRIVER_CLASS_NAME
  value: com.mysql.jdbc.Driver
  - name: EVENTUATELOCAL_KAFKA_BOOTSTRAP_SERVERS
  value: ftgo-kafka:9092
  - name: EVENTUATELOCAL_ZOOKEEPER_CONNECTION_STRING
  value: ftgo-zookeeper:2181
  livenessProbe:
  httpGet:
  path: /actuator/health
  port: 8080
  initialDelaySeconds: 60
  periodSeconds: 20
  readinessProbe:
  </code></pre>
<p>
   Listing 12.4
   Kubernetes Deployment برای ftgo-restaurant-service
   Specifies that این یک
   object از نوع Deployment است
   The name از deployment
   Number از pod replicas
   Gives each pod a label
   به نام app که مقدار آن است
   ftgo-restaurant-service
   The specification از
   the pod، که تعریف می‌کند
   فقط یک container
   The container’s port
   The container’s environment
   variables، که توسط
   Spring Boot خوانده می‌شود
   Sensitive values که
   از Kubernetes Secret بازیابی می‌شوند
   به نام ftgo-db-secret
   Configure Kubernetes
   برای فراخوانی the health
   check endpoint.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0433_original/original_page.png" alt="Original Page 433">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<pre><code class="language-text">
  httpGet:
  path: /actuator/health
  port: 8080
  initialDelaySeconds: 60
  periodSeconds: 20
  </code></pre>
<p>
   This deployment definition Kubernetes را پیکربندی می‌کند تا Restaurant Service’s را فراخوانی کند
   health check endpoint. As described در فصل 11، a health check endpoint،
   Kubernetes را قادر می‌سازد تا health از service instance را تعیین کند. Kubernetes پیاده‌سازی می‌کند
   دو checks متفاوت. The first check is readinessProbe، که از آن برای تعیین
   استفاده می‌کند که آیا باید traffic را به یک service instance هدایت کند یا خیر. In this example, Kubernetes
   /actuator/health HTTP endpoint را هر 20 ثانیه پس از یک initial 30-
   second delay فراخوانی می‌کند، که به آن فرصت می‌دهد تا مقداردهی اولیه شود. If some number (default is 1) از
   consecutive readinessProbes succeeds، Kubernetes service را ready در نظر می‌گیرد،
   در حالی که اگر some number (default, 3) از consecutive readinessProbes شکست بخورد، it’s consid-
   ered not to be ready. Kubernetes فقط traffic را به service instance هدایت خواهد کرد when
   the readinessProbe نشان می‌دهد که آن ready است.
  </p>
<p>
   The second health check، livenessProbe است. It’s configured به همان شیوه
   readinessProbe. But rather than determine که آیا traffic باید به a ser-
   vice instance هدایت شود، the livenessProbe تعیین می‌کند که آیا Kubernetes باید خاتمه دهد
   و service instance را restart کند. If some number (default, 3) از consecutive liveness-
   Probes fail در یک ردیف، Kubernetes service را خاتمه می‌دهد و restart می‌کند.
  </p>
<p>
   Once you’ve written the YAML file، شما می‌توانید deployment را با
   استفاده از the kubectl apply command ایجاد یا به‌روزرسانی کنید:
  </p>
<pre><code class="language-text">
  kubectl apply -f ftgo-restaurant-service/src/deployment/kubernetes/ftgo-
  restaurant-service.yml
  </code></pre>
<p>
   This command یک request را به the Kubernetes API server انجام می‌دهد که منجر به cre-
   ation از deployment و the pods می‌شود.
  </p>
<p>
   To create this deployment، شما باید first the Kubernetes Secret را به نام ایجاد کنید
   ftgo-db-secret. One quick و insecure way برای انجام این کار به شرح زیر است:
  </p>
<pre><code class="language-text">
  kubectl create secret generic ftgo-db-secret \
  --from-literal=username=mysqluser --from-literal=password=mysqlpw
  </code></pre>
<p>
   This command یک secret حاوی database user ID و password را که مشخص شده است ایجاد می‌کند
   on the command line. See the Kubernetes documentation (https://kubernetes
   .io/docs/concepts/configuration/secret/#creating-your-own-secrets) برای ایمن‌تر
   ways برای create secrets.
  </p>
<h4><span style="font-weight: bold;">CREATING A KUBERNETES SERVICE</span></h4>
<p>
   At this point the pods در حال اجرا هستند و the Kubernetes deployment بهترین تلاش خود را انجام خواهد داد تا
   keep them running. The problem این است که the pods IP به صورت پویا اختصاص داده شده‌اند
   addresses و، as such، برای یک client که می‌خواهد a HTTP
   request را انجام دهد، چندان مفید نیستند. As described در فصل 3، the solution استفاده از a service discovery mechanism است.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0434_original/original_page.png" alt="Original Page 434">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">Deploying the FTGO application with Kubernetes</span></h4>
<p>
   One approach استفاده از یک client-side discovery mechanism و نصب یک service registry است،
   مانند Netflix OSS Eureka. Fortunately, ما می‌توانیم با استفاده از service از این کار اجتناب کنیم
   discovery mechanism که در Kubernetes ساخته شده است و یک Kubernetes service را تعریف کنیم.
  </p>
<p>
   A service یک Kubernetes object است که به clients از one یا بیشتر pods با یک
   stable endpoint ارائه می‌دهد. It has یک IP address و یک DNS name که به آن IP
   address متصل می‌شود. The service load balances traffic به آن IP address در سراسر pods. Listing 12.5
   Kubernetes service را برای Restaurant Service نشان می‌دهد. This service routes traffic
   از http://ftgo-restaurant-service:8080 به pods که توسط the deploy-
   ment نشان داده شده در listing تعریف شده‌اند.
  </p>
<pre><code class="language-text">
  apiVersion: v1
  kind: Service
  metadata:
  name: ftgo-restaurant-service
  spec:
  ports:
  - port: 8080
  targetPort: 8080
  selector:
  app: ftgo-restaurant-service
  ---
  </code></pre>
<p>
   The key part از service definition selector است، که the target pods را انتخاب می‌کند. It selects
   those pods که یک label به نام app با مقدار ftgo-restaurant-service دارند. If
   شما از نزدیک نگاه کنید، خواهید دید که the container که در listing 12.4 تعریف شده است، دارای چنین label است.
  </p>
<p>
   Once you’ve written the YAML file، شما می‌توانید service را با استفاده از این command ایجاد کنید:
  </p>
<pre><code class="language-text">
  kubectl apply -f ftgo-restaurant-service-service.yml
  </code></pre>
<p>
   Now that we’ve created the Kubernetes service، هر client از Restaurant Service
   که در داخل Kubernetes cluster در حال اجرا است، می‌تواند به REST API آن از طریق http:// دسترسی داشته باشد
   ftgo-restaurant-service:8080. Later, I discuss how to upgrade running services،
   but first let’s take a look at how to make the services accessible from outside the
   Kubernetes cluster.
  </p>
<h4><span style="font-weight: bold;">12.4.3 Deploying the API gateway</span></h4>
<p>
   The Kubernetes service برای Restaurant Service، که در listing 12.5 نشان داده شده است، فقط accessi-
   ble از داخل cluster است. That’s not a problem برای Restaurant Service، اما what
   about API Gateway? The role آن این است که traffic را از دنیای بیرون به service هدایت کند. It
   به همین دلیل باید از خارج از cluster قابل دسترسی باشد. Fortunately, a Kubernetes
   service از این use case نیز پشتیبانی می‌کند. The service ما قبلاً به آن نگاه کردیم یک ClusterIP است
   service، که the default است، اما، there are, however, two other types از services: Node-
   Port و LoadBalancer.
  </p>
<p>
   Listing 12.5
   The YAML definition از the Kubernetes service برای
   ftgo-restaurant-service
   The name از the service،
   همچنین the DNS name
   The exposed
   port
   The container port
   برای route کردن traffic به
   Selects the containers
   برای route کردن traffic به
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0435_original/original_page.png" alt="Original Page 435">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   A NodePort service از طریق یک cluster-wide port در تمام nodes در the clus-
   ter قابل دسترسی است. Any traffic به آن port در هر cluster node به pods backend load balanced می‌شود.
   You must یک پورت در محدوده 30000–32767 را انتخاب کنید. For example, listing 12.6
   یک service را نشان می‌دهد که traffic را به پورت 30000 از Consumer Service هدایت می‌کند.
  </p>
<pre><code class="language-text">
  apiVersion: v1
  kind: Service
  metadata:
  name: ftgo-api-gateway
  spec:
  type: NodePort
  ports:
  - nodePort: 30000
  port: 80
  targetPort: 8080
  selector:
  app: ftgo-api-gateway
  ---
  </code></pre>
<p>
   API Gateway در داخل cluster با استفاده از URL http://ftgo-api-gateway و out-
   side از URL http://<node-ip-address>:3000/ قرار دارد، که node-ip-address the IP است
   address از یکی از nodes. After configuring a NodePort service شما می‌توانید، برای exam-
   ple، یک AWS Elastic Load Balancer (ELB) را پیکربندی کنید تا requests را از
   internet در سراسر nodes load balance کند. A key benefit از این رویکرد این است که ELB کاملاً
   under your control است. You have complete flexibility هنگام پیکربندی آن.
  </node-ip-address></p>
<p>
   A NodePort type service تنها گزینه نیست. You can also use a Load-
   Balancer service، که به طور خودکار یک cloud-specific load balancer را پیکربندی می‌کند. The
   load balancer یک ELB خواهد بود اگر Kubernetes در AWS در حال اجرا باشد. One benefit از this
   type از service این است که شما دیگر مجبور نیستید load balancer خود را پیکربندی کنید. The
   drawback، however، این است که اگرچه Kubernetes چند گزینه برای configur-
   ing the ELB می‌دهد، مانند گواهی SSL، شما کنترل بسیار کمتری بر روی configuration آن دارید.
  </p>
<h4><span style="font-weight: bold;">12.4.4 Zero-downtime deployments</span></h4>
<p>
   Imagine شما Restaurant Service را به‌روزرسانی کرده‌اید و می‌خواهید آن تغییرات را به
   production مستقر کنید. Updating a running service یک process سه‌مرحله‌ای ساده هنگام استفاده است
   Kubernetes:
  </p>
<p>
   1
   Build یک container image جدید و آن را به registry با استفاده از همان process
   described earlier push کنید. The only difference این است که image با یک dif-
   ferent version tag برچسب‌گذاری می‌شود—به عنوان مثال، ftgo-restaurant-service:1.1.0.RELEASE.
  </p>
<p>
   2
   Edit the YAML file برای service’s deployment تا به image جدید اشاره کند.
  </p>
<p>
   3
   Update the deployment با استفاده از the kubectl apply -f command.
  </p>
<p>
   Kubernetes سپس a rolling upgrade از pods را انجام می‌دهد. It will incrementally cre-
   ate pods که version 1.1.0.RELEASE را اجرا می‌کنند و pods که version را اجرا می‌کنند، خاتمه می‌دهند
  </p>
<p>
   Listing 12.6
   The YAML definition از a NodePort service که traffic را به پورت هدایت می‌کند
   8082 از Consumer Service
   Specifies a type
   از NodePort
   The cluster-
   wide port
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0436_original/original_page.png" alt="Original Page 436">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">Deploying the FTGO application with Kubernetes</span></h4>
<p>
   1.0.0.RELEASE. What’s great about نحوه انجام این کار توسط Kubernetes این است که it doesn’t ter-
   minate old pods until their replacements are ready to handle requests. It uses the
   readinessProbe mechanism، یک health check mechanism که قبلاً در این
   بخش توضیح داده شد، برای تعیین اینکه آیا یک pod ready است یا خیر. As a result, همیشه pods وجود خواهد داشت
   available برای handle کردن requests. Eventually, با فرض اینکه new pods با موفقیت شروع شوند، همه
   deployment’s pods version جدید را اجرا خواهند کرد.
  </p>
<p>
   But what if there’s a problem و version 1.1.0.RELEASE pods شروع نمی‌شوند؟
   Perhaps یک bug وجود دارد، مانند یک image name از container غلط املایی شده یا یک envi-
   ronment variable از a new configuration property وجود ندارد. If the pods fail to start، the deploy-
   ment گیر خواهد کرد. At that point، شما دو option دارید. One option این است که file YAML را fix کنید و
   kubectl apply -f را دوباره اجرا کنید تا deployment را به‌روزرسانی کنید. The other option است
   to roll back the deployment.
  </p>
<p>
   A deployment تاریخچه آنچه که rollouts نامیده می‌شود را حفظ می‌کند. Each time شما
   deployment را به‌روزرسانی می‌کنید، یک rollout جدید ایجاد می‌کند. As a result، شما می‌توانید به راحتی a را roll back کنید
   deployment به یک نسخه قبلی با اجرای دستور زیر:
  </p>
<pre><code class="language-text">
  kubectl rollout undo deployment ftgo-restaurant-service
  </code></pre>
<p>
   Kubernetes سپس pods که version 1.1.0.RELEASE را اجرا می‌کنند را با pods run-
   ning the older version, 1.0.0.RELEASE جایگزین می‌کند.
  </p>
<p>
   A Kubernetes deployment یک راه خوب برای deploy کردن یک service بدون downtime است. But
   اگر یک bug فقط پس از ready شدن pod و دریافت traffic از production ظاهر شود، چه می‌شود؟ In
   that situation, Kubernetes به roll out نسخه‌های جدید ادامه خواهد داد، بنابراین یک تعداد در حال رشد
   از users تحت تأثیر قرار خواهند گرفت. Though your monitoring system امیدوارانه این issue را تشخیص می‌دهد
   و به سرعت deployment را roll back می‌کند، شما از تأثیر گذاشتن بر حداقل برخی از users اجتناب نخواهید کرد. To
   address this issue و باعث می‌شود که rolling out یک نسخه جدید از یک service قابل اطمینان‌تر باشد، ما نیاز داریم
   to separate deploying، که به معنای اجرا شدن service در production است، از
   releasing the service، که به معنای در دسترس قرار دادن آن برای handle کردن production traffic است.
  </p>
<p>
   Let’s look at how to accomplish that با استفاده از a service mesh.
  </p>
<h4><span style="font-weight: bold;">12.4.5 Using a service mesh to separate deployment from release</span></h4>
<p>
   The traditional way to roll out یک version جدید از یک service این است که ابتدا آن را در یک staging
   environment تست کنید. Then, once it’s passed the test in staging، شما در production مستقر می‌شوید
   با انجام یک rolling upgrade که instances قدیمی از service را با service جدید جایگزین می‌کند
   instances. On one hand, همانطور که دیدید، Kubernetes deployments doing a roll-
   ing upgrade را بسیار ساده می‌کند. On the other hand، این رویکرد فرض می‌کند که
   once یک service version tests را در the staging environment پاس کرده است، در
   production کار خواهد کرد. Sadly, this is not always the case.
  </p>
<p>
   One reason این است که staging بعید است یک clone دقیق باشد، اگر برای دلیل دیگری نباشد
   than the production environment احتمالاً بسیار بزرگتر است و traffic بیشتری را مدیریت می‌کند. It’s also time consuming برای keep the two environments synchronized. As a result
   از discrepancies، احتمال دارد که برخی از bugs فقط در production نشان داده شوند. And even it
   were an exact clone, شما نمی‌توانید تضمین کنید که testing تمام bugs را catch خواهد کرد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0437_original/original_page.png" alt="Original Page 437">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   A much more reliable way برای roll out یک version جدید این است که deployment را از
   release جدا کنید:
  </p>
<p>
   Deployment—Running در production environment
  </p>
<p>
   Releasing a service—Making it available به end users
  </p>
<p>
   You then deploy a service به production با استفاده از steps زیر:
  </p>
<p>
   1
   Deploy the new version به production بدون routing any end-user requests
   به آن.
  </p>
<p>
   2
   Test it در production.
  </p>
<p>
   3
   Release آن به یک تعداد کمی از end users.
  </p>
<p>
   4
   Incrementally آن را به یک تعداد فزاینده‌ای از users release کنید تا اینکه han-
   dling تمام production traffic.
  </p>
<p>
   5
   If at any point there’s an issue، به version قدیمی برگردید—در غیر این صورت، once
   you’re confident the new version در حال کار است، version قدیمی را حذف کنید.
  </p>
<p>
   Ideally، those steps توسط یک fully automated deployment pipeline که انجام می‌دهد
   به دقت service که به تازگی مستقر شده است را برای خطاها نظارت می‌کند.
  </p>
<p>
   Traditionally، separating deployments و releases به این روش چالش‌برانگیز بوده است
   زیرا به کار زیادی برای پیاده‌سازی آن نیاز دارد. But one of the benefits از using a
   service mesh این است که استفاده از این style از deployment بسیار آسان‌تر است. A service mesh است، as
   described در فصل 11، networking infrastructure که واسطه تمام communication را انجام می‌دهد
   بین یک service و other services و external applications. In addition to taking
   on some از responsibilities از the microservice chassis framework, a service mesh
   rule-based load balancing و traffic routing را فراهم می‌کند که به شما امکان می‌دهد به طور ایمن multiple را اجرا کنید
   versions از services شما به طور همزمان. Later در این بخش، شما خواهید دید که شما می‌توانید
   route test users به یک version از یک service و end-users به یک version متفاوت، برای
   example.
  </p>
<p>
   As described در فصل 11، چندین service meshes برای انتخاب وجود دارد. In this
   section, من به شما نشان می‌دهم که چگونه از Istio استفاده کنید، a popular, open source service mesh که در اصل
   developed توسط Google, IBM, و Lyft. I begin با ارائه یک overview مختصر از Istio و
   a few از many features آن. Next من نحوه deploy کردن یک application با استفاده از Istio را توضیح می‌دهم.
   After that, من نشان می‌دهم که چگونه از قابلیت‌های traffic-routing آن برای deploy و release کردن یک
   upgrade به یک service استفاده کنید.
  </p>
<h4><span style="font-weight: bold;">OVERVIEW OF THE ISTIO SERVICE MESH</span></h4>
<p>
   The Istio website Istio را به عنوان “An open platform برای connect، manage، و
   secure microservices” (https://istio.io) توصیف می‌کند. It’s a networking layer که از طریق آن همه
   your services’ network traffic flows. Istio یک set غنی از features را دارد که به چهار بخش اصلی تقسیم شده است:
  </p>
<p>
   Traffic management—شامل service discovery, load balancing, routing rules،
   و circuit breakers
  </p>
<p>
   Security—Secures interservice communication با استفاده از Transport Layer Security
   (TLS)
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0438_original/original_page.png" alt="Original Page 438">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">Deploying the FTGO application with Kubernetes</span></h4>
<p>
   Telemetry—Captures metrics در مورد network traffic و implements distributed
   tracing
  </p>
<p>
   Policy enforcement—Enforces quotas و rate limits
  </p>
<p>
   This section بر روی traffic-management capabilities از Istio متمرکز است.
  </p>
<p>
   Figure 12.11 architecture از Istio را نشان می‌دهد. It consists از a control plane و a data
   plane. The control plane implements management functions، شامل configuring
   the data plane برای route کردن traffic. The data plane از Envoy proxies تشکیل شده است، یک برای هر ser-
   vice instance.
  </p>
<p>
   The two main components از control plane the Pilot و the Mixer هستند. The Pilot
   اطلاعات را در مورد deployed services از the underlying infrastructure استخراج می‌کند. When
   running در Kubernetes، به عنوان مثال، the Pilot services و healthy pods را بازیابی می‌کند. It
   Envoy proxies را برای route کردن traffic با توجه به the defined routing rules، پیکربندی می‌کند. The
   Mixer telemetry را از Envoy proxies جمع‌آوری می‌کند و policies را اعمال می‌کند.
  </p>
<p>
   API Gateway
   container
   GET/consumers/1
   GET/consumers/1
   GET/consumers/1
   Host: ftgo-consumer-service
   GET/consumers/1
   Host: ftgo-consumer-service
   Pod
   Service registry
   Consumer
   Service
   container
   Istio Envoy
   container
   Logging
   Server
   Service
   Pod
   Metrics
   Server
   Istio Envoy
   container
   Mixer
   Pilot
   Istio control plane
   Conﬁgures
   Checks
   Telemetry
   Kubernetes
   Pod
   Key
   Conﬁguration
   Requests
   Policy check
   Telemetry
   Monitoring infrastructure
   Istio data plane
   Queries for deployed services
  </p>
<p>
   Figure 12.11
   Istio متشکل از یک control plane است، که مؤلفه‌های آن شامل the Pilot و the Mixer است، و a data
   plane، که از Envoy proxy servers تشکیل شده است. The Pilot اطلاعات را در مورد deployed services از the
   underlying infrastructure استخراج می‌کند و the data plane را پیکربندی می‌کند. The Mixer policies را مانند quotas اعمال می‌کند و
   telemetry را جمع‌آوری می‌کند و آن را به the monitoring infrastructure servers گزارش می‌دهد. The Envoy proxy servers traffic را در داخل و خارج از
   services هدایت می‌کنند. There’s one Envoy proxy server در هر service instance.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0439_original/original_page.png" alt="Original Page 439">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   The Istio Envoy proxy یک version اصلاح شده از Envoy است (www.envoyproxy.io). It’s a high-
   performance proxy که از variety از protocols پشتیبانی می‌کند، شامل TCP، low-level pro-
   tocols مانند HTTP و HTTPS، و higher-level protocols. It also understands
   MongoDB, Redis و DynamoDB protocols. Envoy همچنین از interservice قوی پشتیبانی می‌کند
   communication با features مانند circuit breakers، rate limiting و automatic
   retries. It can secure communication در داخل application با استفاده از TLS برای inter-
   Envoy communication.
  </p>
<p>
   Istio از Envoy به عنوان یک sidecar استفاده می‌کند، یک process یا container که در کنار service
   instance اجرا می‌شود و cross-cutting concerns را پیاده‌سازی می‌کند. When running در Kubernetes، the
   Envoy proxy یک container در داخل service’s pod است. In other environments که ندارند
   the pod concept، Envoy در همان container که service است، اجرا می‌شود. All traffic to
   و از service از طریق the Envoy proxy آن جریان دارد، که traffic را با توجه به
   routing rules به آن توسط the control plane داده می‌شود. For example, direct Service  Service
   communication تبدیل به Service  Source Envoy  Destination Envoy  Service می‌شود.
  </p>
<p>
   Istio با استفاده از Kubernetes-style YAML configuration files پیکربندی شده است. It has یک command-
   line tool به نام istioctl که شبیه به kubectl است. You use istioctl برای ایجاد،
   updating، و deleting rules و policies. When using Istio on Kubernetes، شما می‌توانید
   همچنین از kubectl استفاده کنید.
  </p>
<p>
   Let’s look at نحوه deploy کردن یک service با Istio.
  </p>
<h4><span style="font-weight: bold;">DEPLOYING A SERVICE WITH ISTIO</span></h4>
<p>
   Deploying a service در Istio کاملاً ساده است. You define a Kubernetes Service
   و a Deployment برای هر یک از services از application شما. Listing 12.7 the را نشان می‌دهد
   definition از Service و Deployment برای Consumer Service. Although it’s almost identical
   به the definitions که من قبلاً نشان دادم، چند تفاوت وجود دارد. That’s because Istio has
   a few requirements برای the Kubernetes services و pods:
  </p>
<p>
   A Kubernetes service port باید از the Istio naming convention از <proto- col="">[-<suffix>] استفاده کند، که در آن protocol http، http2، grpc، mongo یا redis است. If the
   port unnamed است، Istio the port را به عنوان a TCP port و won’t apply rule-
   based routing.
  </suffix></proto-></p>
<p>
   A pod باید یک app label مانند app: ftgo-consumer-service داشته باشد، که
   the service را شناسایی می‌کند، به منظور پشتیبانی از Istio distributed tracing.
  </p>
<p>
   In order to run multiple versions از یک service به طور همزمان، نام از a
   Kubernetes deployment باید شامل version، مانند ftgo-consumer-
   service-v1, ftgo-consumer-service-v2 و غیره باشد. A deployment’s pods باید داشته باشد
   a version label، مانند version: v1، که version را مشخص می‌کند، تا
   Istio می‌تواند به یک version خاص route کند.
  </p>
<p>
   Pattern: Sidecar
   Implement cross-cutting concerns در یک sidecar process یا container که در کنار اجرا می‌شود
   the service instance. See http://microservices.io/patterns/deployment/sidecar.html.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0440_original/original_page.png" alt="Original Page 440">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">Deploying the FTGO application with Kubernetes</span></h4>
<pre><code class="language-text">
  apiVersion: v1
  kind: Service
  metadata:
  name: ftgo-consumer-service
  spec:
  ports:
  - name: http
  port: 8080
  targetPort: 8080
  selector:
  app: ftgo-consumer-service
  ---
  apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
  name: ftgo-consumer-service-v2
  spec:
  replicas: 1
  template:
  metadata:
  labels:
  app: ftgo-consumer-service
  version: v2
  spec:
  containers:
  - image: image: ftgo-consumer-service:v2
  ...
  </code></pre>
<p>
   By now, you may be wondering چگونه container Envoy proxy را در service’s اجرا کنید
   pod. Fortunately, Istio این را با خودکارسازی modifying the pod بسیار آسان می‌کند
   definition برای شامل کردن the Envoy proxy. There are two ways برای انجام این کار. The first این است که از
   manual sidecar injection استفاده کنید و دستور istioctl kube-inject را اجرا کنید:
  </p>
<pre><code class="language-text">
  istioctl kube-inject -f ftgo-consumer-service/src/deployment/kubernetes/ftgo-
  consumer-service.yml | kubectl apply -f -
  </code></pre>
<p>
   This command a Kubernetes YAML file را می‌خواند و the modified configura-
   tion حاوی the Envoy proxy را خروجی می‌دهد. The modified configuration سپس در
   kubectl apply piping می‌شود.
  </p>
<p>
   The second way برای اضافه کردن the Envoy sidecar به pod این است که از automatic sidecar injec-
   tion استفاده کنید. When this feature enabled است، شما یک service را با استفاده از kubectl apply مستقر می‌کنید. Kubernetes
   به طور خودکار Istio را فراخوانی می‌کند تا the pod definition را برای include کردن the Envoy proxy اصلاح کند.
  </p>
<p>
   If شما the service’s pod را describe می‌کنید، خواهید دید که متشکل از more than your ser-
   vice’s container:
  </p>
<pre><code class="language-text">
  $ kubectl describe po ftgo-consumer-service-7db65b6f97-q9jpr
  Name:
  ftgo-consumer-service-7db65b6f97-q9jpr
  Namespace:
  default
  ...
  </code></pre>
<p>
   Listing 12.7
   Deploying Consumer Service با Istio
   Named port
   Versioned
   deployment
   Recommended
   labels
   Image
   version
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0441_original/original_page.png" alt="Original Page 441">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   Init Containers:
  </p>
<pre><code class="language-text">
  istio-init:
  Image:
  docker.io/istio/proxy_init:0.8.0
  ....
  Containers:
  ftgo-consumer-service:
  Image:
  msapatterns/ftgo-consumer-service:latest
  ...
  istio-proxy:
  Image:
  docker.io/istio/proxyv2:0.8.0
  ...
  </code></pre>
<p>
   Now that we’ve deployed the service، بیایید به نحوه تعریف routing rules نگاه کنیم.
  </p>
<h4><span style="font-weight: bold;">CREATE ROUTING RULES TO ROUTE TO THE V1 VERSION</span></h4>
<p>
   Let’s imagine که شما the ftgo-consumer-service-v2 deployment را مستقر کردید. In the
   absence از routing rules, Istio requests را در همه versions از یک service load balance می‌کند. It
   would, therefore, across versions 1 و 2 از ftgo-consumer-service load balance کند،
   که the purpose از استفاده از Istio را شکست می‌دهد. In order to safely roll out یک version جدید، شما
   باید یک routing rule را تعریف کنید که تمام traffic را به version فعلی v1 هدایت کند.
  </p>
<p>
   Initializes the pod
   The service
   container
   The Envoy
   container
   API gateway
   pod
   VirtualService
   DestinationRule
   Consumer
   Service
   v1 pod
   metadata:
   labels:
   app: ftgo-consumer-service
   version: v1
   Consumer
   Service
   v2 pod
   Routes to the v
   subset
   1
   Routing rule for the
   Consumer Service
   Deﬁnes subsets از
   pods از یک service
   No trafﬁc routed to v2.
   Deﬁnes subsets
   v
   و v2
   1
   All trafﬁc routed to v1
   metadata:
   labels:
   app: ftgo-consumer-service
   version: v2
   kind: DestinationRule
   metadata:
   name:ftgo-consumer-service
   spec:
   host: ftgo-consumer-service
   subsets:
   -name: v1
   labels:
   version: v1
   -name: v2
   labels:
   version: v2
   kind: VirtualService
   metadata:
   name:ftgo-consumer-service
   spec:
   hosts:
   -ftgo-consumer-service
   http:
   -route:
   -destination:
   host: ftgo-consumer-service
   subset: v1
   weight: 100
   GET/consumers/1
   host:ftgo-consumer-
   service
  </p>
<p>
   Figure 12.12
   The routing rule for Consumer Service، که تمام traffic را به v1 pods هدایت می‌کند. It consists از a
   VirtualService، که traffic خود را به the v1 subset هدایت می‌کند، و یک DestinationRule، که v1 را تعریف می‌کند
   subset به عنوان pods که با version: v1 برچسب‌گذاری شده‌اند. Once you’ve defined this rule، شما می‌توانید به طور ایمن یک version جدید را مستقر کنید
   بدون routing any traffic به آن در ابتدا.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0442_original/original_page.png" alt="Original Page 442">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">Deploying the FTGO application with Kubernetes</span></h4>
<p>
   Figure 12.12 نشان می‌دهد the routing rule برای Consumer Service، که تمام traffic را به v1 هدایت می‌کند.
   It consists از دو Istio objects: a VirtualService و a DestinationRule.
  </p>
<p>
   A VirtualService نحوه route کردن requests برای one یا بیشتر hostnames را تعریف می‌کند. In this
   example, VirtualService مسیرها را برای یک hostname واحد تعریف می‌کند: ftgo-consumer-
   service. Here’s the definition از VirtualService برای Consumer Service:
  </p>
<pre><code class="language-text">
  apiVersion: networking.istio.io/v1alpha3
  kind: VirtualService
  metadata:
  name: ftgo-consumer-service
  spec:
  hosts:
  - ftgo-consumer-service
  http:
  - route:
  - destination:
  host: ftgo-consumer-service
  subset: v1
  </code></pre>
<p>
   It routes all requests برای v1 subset از the pods از Consumer Service. Later, I show
   examples پیچیده‌تری که بر اساس HTTP requests route می‌شوند و load balance در سراسر
   multiple weighted destinations.
  </p>
<p>
   In addition به VirtualService، شما همچنین باید a DestinationRule را تعریف کنید، که
   one یا بیشتر subsets از pods را برای یک service تعریف می‌کند. A subset از pods معمولاً یک service است
   version. A DestinationRule همچنین می‌تواند traffic policies، مانند load-balancing را تعریف کند
   algorithm. Here’s the DestinationRule برای Consumer Service:
  </p>
<pre><code class="language-text">
  apiVersion: networking.istio.io/v1alpha3
  kind: DestinationRule
  metadata:
  name: ftgo-consumer-service
  spec:
  host: ftgo-consumer-service
  subsets:
  - name: v1
  labels:
  version: v1
  - name: v2
  labels:
  version: v2
  </code></pre>
<p>
   This DestinationRule دو subsets از pods را تعریف می‌کند: v1 و v2. The v1 subset
   pods را با label version: v1 انتخاب می‌کند. The v2 subset pods را با label version: v2 انتخاب می‌کند.
  </p>
<p>
   Once you’ve defined these rules، Istio فقط traffic را pods که برچسب‌گذاری شده‌اند version:
   v1 را route می‌کند. It’s now safe برای deploy کردن v2.
  </p>
<p>
   Applies to the
   Consumer Service
   Routes to
   Consumer Service
   The v1 subset
   The name از
   the subset
   The pod selector
   برای the subset
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0443_original/original_page.png" alt="Original Page 443">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">DEPLOYING VERSION 2 OF CONSUMER SERVICE</span></h4>
<p>
   Here’s یک excerpt از version 2 Deployment برای Consumer Service:
  </p>
<pre><code class="language-text">
  apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
  name: ftgo-consumer-service-v2
  spec:
  replicas: 1
  template:
  metadata:
  labels:
  app: ftgo-consumer-service
  version: v2
  ...
  </code></pre>
<p>
   This deployment به نام ftgo-consumer-service-v2 نامیده می‌شود. It labels pods خود را با version:
   v2. After creating this deployment، هر دو versions از ftgo-consumer-service در حال اجرا خواهند بود. But
   به دلیل the routing rules، Istio هیچ traffic را به v2 هدایت نمی‌کند. You’re
   now ready برای route کردن برخی از test traffic به v2.
  </p>
<h4><span style="font-weight: bold;">ROUTING TEST TRAFFIC TO VERSION 2</span></h4>
<p>
   Once you’ve deployed یک version جدید از یک service، step بعدی تست آن است. Let’s sup-
   pose که requests از test users یک testuser header دارند. We can enhance the ftgo-
   consumer-service VirtualService برای route کردن requests با این header به v2 instances
   با ایجاد تغییر زیر:
  </p>
<pre><code class="language-text">
  apiVersion: networking.istio.io/v1alpha3
  kind: VirtualService
  metadata:
  name: ftgo-consumer-service
  spec:
  hosts:
  - ftgo-consumer-service
  http:
  - match:
  - headers:
  testuser:
  regex: "^.+$"
  route:
  - destination:
  host: ftgo-consumer-service
  subset: v2
  - route:
  - destination:
  host: ftgo-consumer-service
  subset: v1
  </code></pre>
<p>
   In addition به the original default route, VirtualService یک routing rule دارد که
   requests را با the testuser header به the v2 subset هدایت می‌کند. After you’ve updated the
   rules، شما اکنون می‌توانید Consumer Service را تست کنید. Then، once شما احساس اعتماد به نفس می‌کنید که the v2 است
   working، شما می‌توانید برخی از production traffic را به آن هدایت کنید. Let’s look at how to do that.
  </p>
<p>
   Version 2
   Pod برچسب‌گذاری شده است
   با the version
   Matches یک nonblank
   testuser header
   Routes test
   users به v2
   Routes everyone
   else به v1
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0444_original/original_page.png" alt="Original Page 444">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">DEPLOYING VERSION 2 OF CONSUMER SERVICE</span></h4>
<h4><span style="font-weight: bold;">ROUTING PRODUCTION TRAFFIC TO VERSION 2</span></h4>
<p>
   After you’ve tested یک service که newly deployed شده است، step بعدی شروع کردن routing produc-
   tion traffic به آن است. A good strategy این است که در ابتدا فقط a small amount از traffic را route کنید.
   Here, for example, is a rule که 95% از traffic را به v1 و 5% را به v2 هدایت می‌کند:
  </p>
<pre><code class="language-text">
  apiVersion: networking.istio.io/v1alpha3
  kind: VirtualService
  metadata:
  name: ftgo-consumer-service
  spec:
  hosts:
  - ftgo-consumer-service
  http:
  - route:
  - destination:
  host: ftgo-consumer-service
  subset: v1
  weight: 95
  - destination:
  host: ftgo-consumer-service
  subset: v2
  weight: 5
  </code></pre>
<p>
   As you gain confidence که service می‌تواند production traffic را مدیریت کند، شما می‌توانید به طور incre-
   mentally مقدار traffic را که به version 2 pods می‌رود، افزایش دهید تا به
   100% برسد. At that point, Istio هیچ traffic را به v1 pods هدایت نمی‌کند. You could leave them
   running برای a little while longer قبل از حذف version 1 Deployment.
  </p>
<p>
   By letting you easily separate deployment از release، Istio باعث می‌شود که rolling out a
   version جدید از یک service بسیار reliable باشد. Yet I’ve barely scratched the surface از
   Istio’s capabilities. As of the time از writing, the current version از Istio 0.8 است. I’m
   excited to watch it و the other service meshes mature و become a standard part
   از یک production environment.
  </p>
<h4><span style="font-weight: bold;">12.5 Deploying services using the Serverless deployment 
   pattern</span></h4>
<p>
   The Language-specific packaging (بخش 12.1)، Service as a VM (بخش 12.2)، و
   Service as a container (بخش 12.3) patterns همگی کاملاً متفاوت هستند، اما آنها به اشتراک می‌گذارند
   some common characteristics. The first این است که با هر سه patterns شما باید prepro-
   vision some computing resources — یا physical machines، virtual machines، یا con-
   tainers. Some deployment platforms implement autoscaling، که به صورت پویا تنظیم می‌کند
   تعداد VMs یا containers بر اساس load. But you’ll always need برای pay کردن برای
   some VMs یا containers، حتی اگر idle هستند.
  </p>
<p>
   Another common characteristic این است که شما مسئول system administra-
   tion هستید. If you’re running هر نوع machine، شما باید operating system را patch کنید. In
   the case از physical machines، این شامل racking و stacking نیز می‌شود. You’re also
   مسئول managing the language runtime. This یک مثال از آنچه Ama-
   zon “undifferentiated heavy lifting” نامیده است. Since the early days از computing, system
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0445_original/original_page.png" alt="Original Page 445">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<p>
   administration بوده است، یکی از آن چیزهایی که شما باید انجام دهید. As it turns out, though,
   a solution وجود دارد: serverless.
  </p>
<h4><span style="font-weight: bold;">12.5.1 Overview of serverless deployment with AWS Lambda</span></h4>
<p>
   At AWS Re:Invent 2014، Werner Vogels، the CTO از Amazon، AWS را معرفی کرد
   Lambda با عبارت شگفت‌انگیز “magic happens at the intersection of functions,
   events, and data.” As this phrase suggests, AWS Lambda در ابتدا برای deploy کردن بود
   event-driven services. It’s “magic” به این دلیل که، همانطور که خواهید دید، AWS Lambda یک مثال از
   serverless deployment technology است.
  </p>
<p>
   AWS Lambda از Java, NodeJS, C#, GoLang و Python پشتیبانی می‌کند. A lambda function یک
   stateless service است. It typically requests را با فراخوانی AWS services مدیریت می‌کند. For example, a
   lambda function که زمانی فراخوانی می‌شود که یک image به یک S3 bucket آپلود شود، می‌تواند
   یک item را در یک جدول DynamoDB IMAGES وارد کند و یک پیام را به Kinesis منتشر کند تا
   image processing را فعال کند. A lambda function همچنین می‌تواند third-party web services را فراخوانی کند.
  </p>
<p>
   To deploy a service، شما application خود را به عنوان یک فایل ZIP یا JAR file بسته‌بندی می‌کنید، آن را آپلود می‌کنید
   به AWS Lambda، و نام function را برای فراخوانی برای handle کردن یک request
   (همچنین یک event نامیده می‌شود) را مشخص کنید. AWS Lambda به طور خودکار instances کافی از your
   microservice را برای handle کردن incoming requests اجرا می‌کند. You’re for each request based on the
   time taken و memory مصرف شده. Of course, the devil is in the details، و later
   you’ll see که AWS Lambda دارای محدودیت‌هایی است. But the notion که نه شما به عنوان یک devel-
   oper و نه هیچ کس در سازمان شما نیازی به نگرانی در مورد any aspect از servers، virtual
   machines، یا containers ندارد، به طرز باورنکردنی قدرتمند است.
  </p>
<h4><span style="font-weight: bold;">Serverless deployment technologies</span></h4>
<p>
   The main public clouds همه یک serverless deployment option را ارائه می‌دهند، اگرچه AWS
   Lambda پیشرفته‌ترین است. Google Cloud دارای Google Cloud functions است، که به عنوان
   از time writing در beta است (https://cloud.google.com/functions/). Microsoft Azure
   دارای Azure functions است (https://azure.microsoft.com/en-us/services/functions).
  </p>
<p>
   There are also open source serverless frameworks، مانند Apache Openwhisk
   (https://openwhisk.apache.org) و Fission برای Kubernetes (https://fission.io)، که
   شما می‌توانید بر روی infrastructure خود اجرا کنید. But I’m not entirely convinced از value آنها.
   You need to manage infrastructure که serverless framework را اجرا می‌کند—که
   دقیقاً شبیه serverless به نظر نمی‌رسد. Moreover, as you’ll see later در این بخش،
   serverless یک constrained programming model را در ازای minimal sys-
   tem administration ارائه می‌دهد. If you need برای مدیریت infrastructure، سپس شما con-
   straints را بدون benefit دارید.
  </p>
<p>
   Pattern: Serverless deployment
   Deploy services با استفاده از a serverless deployment mechanism که توسط a public cloud ارائه شده است.
   See http://microservices.io/patterns/deployment/serverless-deployment.html.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0446_original/original_page.png" alt="Original Page 446">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">Deploying services using the Serverless deployment 
   pattern</span></h4>
<h4><span style="font-weight: bold;">12.5.2 Developing a lambda function</span></h4>
<p>
   Unlike when using the other three patterns، شما باید از یک programming متفاوت استفاده کنید
   model برای lambda functions خود. A lambda function’s code و the packaging
   به زبان برنامه‌نویسی بستگی دارد. A Java lambda function یک class است که imple-
   ments the generic interface RequestHandler، که توسط the AWS Lambda تعریف شده است
   Java core library و در لیست زیر نشان داده شده است. This interface دو type را می‌گیرد
   parameters: I، که the input type است، و O، که the output type است. The type از I
   و O به the specific kind از request که the lambda handles، بستگی دارد.
  </p>
<pre><code class="language-java">
  public interface RequestHandler&lt;I, O&gt; {
  public O handleRequest(I input, Context context);
  }
  </code></pre>
<p>
   The RequestHandler interface یک handleRequest() method واحد را تعریف می‌کند. This method
   دارای دو پارامتر است، یک input object و یک context، که دسترسی به the lambda را فراهم می‌کند
   execution environment، مانند the request ID. The handleRequest() method
   یک output object را برمی‌گرداند. For lambda functions که HTTP requests را مدیریت می‌کنند که هستند
   proxied توسط an AWS API Gateway، I و O به ترتیب APIGatewayProxyRequestEvent و
   APIGatewayProxyResponseEvent هستند. As you’ll soon see، the handler func-
   tions کاملاً شبیه به old-style Java EE servlets هستند.
  </p>
<p>
   A Java lambda به عنوان یک فایل ZIP یا یک فایل JAR بسته‌بندی می‌شود. A JAR file یک uber JAR است
   (یا fat JAR) که، به عنوان مثال، توسط the Maven Shade plugin ایجاد شده است. A ZIP file دارای the
   classes در root directory و JAR dependencies در lib directory. Later, I show
   که چگونه یک پروژه Gradle می‌تواند یک فایل ZIP ایجاد کند. But first، بیایید به راه‌های مختلف نگاه کنیم
   از فراخوانی a lambda function.
  </p>
<h4><span style="font-weight: bold;">12.5.3 Invoking lambda functions</span></h4>
<p>
   There are four ways برای فراخوانی a lambda function:
  </p>
<p>
   HTTP requests
  </p>
<p>
   Events که توسط AWS services ایجاد شده‌اند
  </p>
<p>
   Scheduled invocations
  </p>
<p>
   Directly با استفاده از یک API call
  </p>
<p>
   Let’s look at each one.
  </p>
<h4><span style="font-weight: bold;">HANDLING HTTP REQUESTS</span></h4>
<p>
   One way برای فراخوانی a lambda function این است که یک AWS API Gateway را برای route
   HTTP requests به lambda شما پیکربندی کنید. The API gateway, function شما را به عنوان
   یک HTTPS endpoint نشان می‌دهد. It functions به عنوان یک HTTP proxy، lambda function را فراخوانی می‌کند
   با یک HTTP request object، و انتظار دارد که the lambda function یک HTTP را برگرداند
   response object. By using the API gateway با AWS Lambda شما می‌توانید، به عنوان مثال،
   deploy RESTful services به عنوان lambda functions.
  </p>
<p>
   Listing 12.8
   A Java lambda function یک class است که the RequestHandler را پیاده‌سازی می‌کند
   interface.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0447_original/original_page.png" alt="Original Page 447">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><span style="font-weight: bold;">فصل 12</span></h3>
<h3><span style="font-weight: bold;">Deploying microservices</span></h3>
<h4><span style="font-weight: bold;">DEPLOYING VERSION 2 OF CONSUMER SERVICE</span></h4>
<h4><span style="font-weight: bold;">HANDLING EVENTS GENERATED BY AWS SERVICES</span></h4>
<p>
   The second way برای فراخوانی a lambda function این است که lambda function خود را پیکربندی کنید تا
   رویدادهایی را که توسط یک AWS service ایجاد شده‌اند، مدیریت کند. Examples از events که می‌توانند a را trigger کنند
   lambda function شامل موارد زیر است:
  </p>
<p>
   An object در یک S3 bucket ایجاد شده است.
  </p>
<p>
   An item در یک جدول DynamoDB ایجاد، به‌روزرسانی یا حذف می‌شود.
  </p>
<p>
   A message برای خواندن از یک جریان Kinesis در دسترس است.
  </p>
<p>
   An email از طریق the Simple email service دریافت شده است.
  </p>
<p>
   Because از این ادغام با دیگر AWS services، AWS Lambda برای طیف گسترده‌ای از tasks مفید است.
  </p>
<h4><span style="font-weight: bold;">DEFINING SCHEDULED LAMBDA FUNCTIONS</span></h4>
<p>
   Another way برای فراخوانی a lambda function، استفاده از a Linux cron-like schedule است. You can
   lambda function خود را طوری پیکربندی کنید که به صورت دوره‌ای فراخوانی شود—به عنوان مثال، هر دقیقه،
   3 hours، یا 7 days. Alternatively، شما می‌توانید از یک cron expression برای مشخص کردن زمان
   AWS باید lambda شما را فراخوانی کند. cron expressions انعطاف‌پذیری زیادی را به شما می‌دهند. For exam-
   ple، شما می‌توانید یک lambda را برای فراخوانی در ساعت 2:15 p.m. دوشنبه تا جمعه پیکربندی کنید.
  </p>
<h4><span style="font-weight: bold;">INVOKING A LAMBDA FUNCTION USING A WEB SERVICE REQUEST</span></h4>
<p>
   The fourth way برای فراخوانی a lambda function این است که application شما آن را با استفاده از a
   web service request فراخوانی کند. The web service request نام از the lambda function را مشخص می‌کند
   و data از input event. Your application می‌تواند یک lambda function را به طور synchronous فراخوانی کند
   یا asynchronous. If your application the lambda function را به طور synchronous فراخوانی می‌کند، the
   web service’s HTTP response شامل response از the lambda function است. Other-
   wise, اگر it the lambda function را به طور asynchronous فراخوانی می‌کند، the web service response indi-
   cates که آیا اجرای the lambda با موفقیت آغاز شده است یا خیر.
  </p>
<h4><span style="font-weight: bold;">12.5.4 Benefits of using lambda functions</span></h4>
<p>
   Deploying services با استفاده از lambda functions دارای چندین benefit است:
  </p>
<p>
   Integrated با many AWS services—It’s remarkably straightforward برای نوشتن lamb-
   das که events را که توسط AWS services ایجاد شده‌اند، مصرف می‌کنند، مانند DynamoDB و
   Kinesis، و handle HTTP requests از طریق the AWS API Gateway.
  </p>
<p>
   Eliminates many system administration tasks—شما دیگر مسئول low-
   level system administration نیستید. There are no operating systems یا runtimes to
   patch. As a result، شما می‌توانید بر developing application خود تمرکز کنید.
  </p>
<p>
   Elasticity—AWS Lambda به تعداد زیادی instance از application شما که
   برای handle کردن load مورد نیاز است، اجرا می‌شود. You don’t have the challenge از predicting needed capacity یا
   run the risk از underprovisioning یا overprovisioning VMs یا containers.
  </p>
<p>
   Usage-based pricing—بر خلاف a typical IaaS cloud، که توسط the minute یا
   hour برای یک VM یا container، حتی زمانی که idle است، شارژ می‌کند، AWS Lambda فقط شما را شارژ می‌کند
   برای the resources که هنگام پردازش هر request مصرف می‌شوند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0448_original/original_page.png" alt="Original Page 448">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>12.5.5 Drawbacks of using lambda functions</strong></h3>
<p>همانطور که مشاهده می‌کنید، AWS Lambda یک روش بسیار مناسب برای deploy کردن services است، اما
  دارای محدودیت‌ها و معایب قابل توجهی است:</p>
<ul>
<li>
<strong>Long-tail latency</strong>—از آنجایی که AWS Lambda به صورت پویا کد شما را اجرا می‌کند، برخی
    requestsها دارای latency بالایی هستند، زیرا مدتی طول می‌کشد تا AWS یک instance از
    application شما را فراهم کند و application شروع به کار کند. این امر به ویژه زمانی چالش برانگیز است که
    services مبتنی بر Java اجرا می‌شوند، زیرا معمولاً حداقل چند ثانیه طول می‌کشد تا شروع شوند. به عنوان
    مثال، lambda function نمونه‌ای که در بخش بعدی توضیح داده شده است، مدتی طول می‌کشد تا راه‌اندازی شود. در نتیجه، AWS Lambda ممکن است برای servicesهایی که به latency حساس هستند، مناسب نباشد.
   </li>
<li>
<strong>Limited event/request-based programming model</strong>—AWS Lambda برای
    deploy کردن servicesهای طولانی مدت، مانند serviceای که messages را از یک third-party message broker دریافت می‌کند، در نظر گرفته نشده است.
   </li>
</ul>
<p>به دلیل این معایب و محدودیت‌ها، AWS Lambda برای همه servicesها مناسب نیست. اما هنگام انتخاب یک deployment pattern، توصیه می‌کنم ابتدا ارزیابی کنید که آیا deployment serverless از requirementsهای service شما پشتیبانی می‌کند یا خیر، قبل از اینکه جایگزین‌ها را در نظر بگیرید.</p>
<h3><strong>12.6 Deploying a RESTful service using AWS Lambda و AWS Gateway</strong></h3>
<p>بیایید نگاهی به نحوه deploy کردن Restaurant Service با استفاده از AWS Lambda بیندازیم. این یک ser-
  vice است که دارای یک REST API برای ایجاد و مدیریت restaurants است. به عنوان مثال، اتصالات طولانی مدتی به Apache Kafka ندارد، بنابراین برای AWS lambda مناسب است. Fig-
  ure 12.13 معماری deployment را برای این service نشان می‌دهد. این service شامل
  چندین lambda function است، یکی برای هر REST endpoint. یک AWS API Gateway مسئول
  routing HTTP requests به lambda functions است.</p>
<p>
   هر lambda function دارای یک request handler class است. ftgo-create-restaurant
   lambda function، کلاس CreateRestaurantRequestHandler را فراخوانی می‌کند و ftgo-
   find-restaurant lambda function، FindRestaurantRequestHandler را فراخوانی می‌کند. از آنجایی که
   این request handler classes جنبه‌های مرتبط با service را پیاده‌سازی می‌کنند،
   آنها در یک فایل ZIP به نام restaurant-service-aws-lambda
   .zip بسته‌بندی شده‌اند. بیایید نگاهی به طراحی service، از جمله آن handler classes بیندازیم.
  </p>
<h3><strong>12.6.1 The design of the AWS Lambda version of Restaurant Service</strong></h3>
<p>معماری service، که در شکل 12.14 نشان داده شده است، بسیار شبیه به یک service سنتی است.
  تفاوت اصلی این است که Spring MVC controllersها با AWS Lambda request handler classes جایگزین شده‌اند. بقیه منطق business بدون تغییر باقی مانده است.</p>
<p>
   این service از یک presentation tier متشکل از request handlers تشکیل شده است که
   توسط AWS Lambda برای handle کردن HTTP requests فراخوانی می‌شوند، و یک business سنتی
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0449_original/original_page.png" alt="Original Page 449">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 12</strong></h2>
<h3><strong>Deploying microservices</strong></h3>
<p>
   API gateway
   <br/>
   AWS Lambda
   <br/>
   functions
   <br/>
   ftgo-create-restaurant
   <br/>
   ftgo-ﬁnd-restaurant
   <br/>
   ftgo-restaurant-service-aws-lambda.zip
   <br/>
   ftgo-...
   <br/>
   POST/restaurant
   <br/>
   GET/restaurant/
   <br/>
   {restaurantId}
   <br/>
   «class»
   <br/>
   Create
   <br/>
   Restaurant
   <br/>
   Request
   <br/>
   Handler
   <br/>
   «class»
   <br/>
   FindRestaurant
   <br/>
   Request
   <br/>
   Handler
   <br/>
   «class»
   <br/>
   ...
   <br/>
   Request
   <br/>
   Handler
  </p>
<p>
<strong>Figure 12.13</strong>
   Deploying Restaurant Service as AWS Lambda functions. The
   AWS API Gateway routes HTTP requests to the AWS Lambda functions, which are
   implemented by request handler classes defined by Restaurant Service.
  </p>
<p>
   Create
   <br/>
   Restaurant
   <br/>
   Request
   <br/>
   Handler
   <br/>
   Presentation layer
   <br/>
   POST/restaurant
   <br/>
   GET/restaurant/{restaurantId}
   <br/>
   Business and
   <br/>
   data access layer
   <br/>
   Find
   <br/>
   Restaurant
   <br/>
   Request
   <br/>
   Handler
   <br/>
   RestaurantService
   <br/>
   RestaurantRepository
   <br/>
   Restaurant
   <br/>
   ...
   <br/>
   Request
   <br/>
   Handler
  </p>
<p>
<strong>Figure 12.14</strong>
   The design of the AWS Lambda-based Restaurant Service. The
   presentation layer consists of request handler classes, which implement the lambda
   functions. They invoke the business tier, which is written in a traditional style
   consisting of a service class, an entity, and a repository.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0450_original/original_page.png" alt="Original Page 450">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Deploying a RESTful service using AWS Lambda and AWS Gateway</strong></h3>
<p>tier. The business tier از RestaurantService، موجودیت Restaurant JPA و
   RestaurantRepository تشکیل شده است، که database را encapsulated می‌کند.
   <br/>
   بیایید نگاهی به کلاس FindRestaurantRequestHandler بیندازیم.
  </p>
<h3><strong>THE FINDRESTAURANTREQUESTHANDLER CLASS</strong></h3>
<p>
   کلاس FindRestaurantRequestHandler، endpoint را پیاده‌سازی می‌کند. این کلاس به همراه سایر request handler classes،
   leaves از سلسله مراتب کلاس‌ها هستند که در شکل 12.15 نشان داده شده است. ریشه این سلسله مراتب
   RequestHandler است که بخشی از AWS SDK است. زیرکلاس‌های abstract آن، errors را handle کرده و dependencies را inject می‌کنند.
  </p>
<p>
   کلاس AbstractHttpHandler، کلاس پایه abstract برای HTTP request handlersها است.
   این کلاس exceptionsهای unhandled را که در طول request handling پرتاب می‌شوند، catch می‌کند و یک 500 -
   internal server error response را برمی‌گرداند. کلاس AbstractAutowiringHttpRequestHandler، dependency injection را برای request handlersها پیاده‌سازی می‌کند. من به زودی این superclassesهای abstract را توضیح خواهم داد، اما ابتدا بیایید نگاهی به کد FindRestaurantRequestHandler بیندازیم.
  </p>
<p>
   Listing 12.9، کد کلاس FindRestaurantRequestHandler را نشان می‌دهد.
   کلاس FindRestaurantRequestHandler دارای متد handleHttpRequest() است که
   یک APIGatewayProxyRequestEvent را که نشان دهنده یک HTTP request است، به عنوان یک پارامتر می‌گیرد. این متد، RestaurantService را برای یافتن restaurant فراخوانی می‌کند و یک APIGateway-
   ProxyResponseEvent را که HTTP response را توصیف می‌کند، برمی‌گرداند.
  </p>
<p>
   Request
   <br/>
   Handler
   <br/>
   Abstract
   <br/>
   HttpHandler
   <br/>
   Abstract
   <br/>
   Autowiring
   <br/>
   HttpRequest
   <br/>
   Handler
   <br/>
   Create
   <br/>
   Restaurant
   <br/>
   Request
   <br/>
   Handler
   <br/>
   Find
   <br/>
   Restaurant
   <br/>
   Request
   <br/>
   Handler
   <br/>
   ...
   <br/>
   Request
   <br/>
   Handler
  </p>
<p>
<strong>Figure 12.15</strong>
   The design of the request handler
   classes. The abstract superclasses implement
   dependency injection and error handling.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0451_original/original_page.png" alt="Original Page 451">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 12</strong></h2>
<h3><strong>Deploying microservices</strong></h3>
<pre><code class="language-java">
public class FindRestaurantRequestHandler 
extends AbstractAutowiringHttpRequestHandler {
@Autowired
private RestaurantService restaurantService;
@Override
protected Class<?> getApplicationContextClass() {
return CreateRestaurantRequestHandler.class;
  
}
@Override
protected APIGatewayProxyResponseEvent
handleHttpRequest(APIGatewayProxyRequestEvent request, Context context) {
long restaurantId;
try {
restaurantId = Long.parseLong(request.getPathParameters()
          .get("restaurantId"));
} catch (NumberFormatException e) {
return makeBadRequestResponse(context);
  
}
Optional&lt;Restaurant&gt; possibleRestaurant = restaurantService.findById(restaur
antId);
return possibleRestaurant
  
.map(this::makeGetRestaurantResponse)
.orElseGet(() -&gt; makeRestaurantNotFoundResponse(context,
restaurantId));
}
private APIGatewayProxyResponseEvent makeBadRequestResponse(Context context) {
...
}
private APIGatewayProxyResponseEvent
makeRestaurantNotFoundResponse(Context context, long restaurantId) { ... }
private
APIGatewayProxyResponseEvent
makeGetRestaurantResponse(Restaurant restaurant) { ... }
}
  </code></pre>
<p>
   همانطور که مشاهده می‌کنید، این کلاس بسیار شبیه به یک servlet است، با این تفاوت که به جای یک متد service()، که یک HttpServletRequest را می‌گیرد و HttpServletResponse را برمی‌گرداند، یک
   متد handleHttpRequest() دارد که یک APIGatewayProxyRequestEvent را می‌گیرد و
   APIGatewayProxyResponseEvent را برمی‌گرداند.
  </p>
<p>
   اکنون بیایید نگاهی به superclass آن بیندازیم، که dependency injection را پیاده‌سازی می‌کند.
  </p>
<p>
<strong>Listing 12.9</strong>
<br/>
   The handler class for GET /restaurant/{restaurantId}
   <br/>
   The Spring Java
   <br/>
   configuration class to use
   <br/>
   for the application context
   <br/>
   Returns a 400 - bad request
   <br/>
   response if the restaurantId
   <br/>
   is missing or invalid
   <br/>
   Returns either the
   <br/>
   restaurant or a 404 -
   <br/>
   not found response
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0452_original/original_page.png" alt="Original Page 452">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Deploying a RESTful service using AWS Lambda and AWS Gateway</strong></h3>
<h3><strong>DEPENDENCY INJECTION USING THE ABSTRACTAUTOWIRINGHTTPREQUESTHANDLER CLASS</strong></h3>
<p>
   یک AWS Lambda function نه یک web application است و نه یک application با یک
   main() method. اما شرم‌آور خواهد بود که نتوانیم از featuresهای Spring
   Boot که به آنها عادت کرده‌ایم، استفاده کنیم. کلاس AbstractAutowiringHttpRequestHandler، که در listing زیر نشان داده شده است، dependency injection را برای request han-
   dlersها پیاده‌سازی می‌کند. این کلاس یک ApplicationContext را با استفاده از SpringApplication.run() ایجاد می‌کند و
   dependenciesها را قبل از handle کردن اولین request، autowires می‌کند. زیرکلاس‌هایی مانند FindRestaurant-
   RequestHandler باید متد getApplicationContextClass() را پیاده‌سازی کنند.
  </p>
<pre><code class="language-java">
public abstract class AbstractAutowiringHttpRequestHandler 
extends AbstractHttpHandler {
private static ConfigurableApplicationContext ctx;
private ReentrantReadWriteLock ctxLock = new ReentrantReadWriteLock();
private boolean autowired = false;
protected synchronized ApplicationContext getAppCtx() {   
ctxLock.writeLock().lock();
try {
if (ctx == null) {
ctx =
SpringApplication.run(getApplicationContextClass());
}
return ctx;
} finally {
ctxLock.writeLock().unlock();
}
}
@Override
protected void
beforeHandling(APIGatewayProxyRequestEvent request, Context context) {
super.beforeHandling(request, context);
if (!autowired) {
getAppCtx().getAutowireCapableBeanFactory().autowireBean(this);  
autowired = true;
}
}
protected abstract Class<?> getApplicationContextClass();
  
}
  </code></pre>
<p>
   این کلاس، متد beforeHandling() را که توسط AbstractHttpHandler تعریف شده است، override می‌کند.
   متد beforeHandling() آن، dependencies را با استفاده از autowiring قبل از handling
   اولین request، inject می‌کند.
  </p>
<h3><strong>THE ABSTRACTHTTPHANDLER CLASS</strong></h3>
<p>
   Request handlersها برای Restaurant Service در نهایت، AbstractHttpHandler را گسترش می‌دهند،
   که در listing 12.11 نشان داده شده است. این کلاس RequestHandler&lt;APIGatewayProxy را پیاده‌سازی می‌کند.
   RequestEvent and APIGatewayProxyResponseEvent&gt;. مسئولیت اصلی آن، catch کردن
   exceptionsها است که هنگام handling یک request پرتاب می‌شوند و یک error code 500 را پرتاب می‌کنند.
  </p>
<p>
<strong>Listing 12.10</strong>
<br/>
   An abstract RequestHandler that implements dependency injection
   <br/>
   Creates the Spring
   <br/>
   Boot application
   <br/>
   context just once
   <br/>
   Injects dependencies into
   <br/>
   the request handler using
   <br/>
   autowiring before handling
   <br/>
   the first request
   <br/>
   Returns the @Configuration
   <br/>
   class used to create
   <br/>
   ApplicationContext
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0453_original/original_page.png" alt="Original Page 453">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 12</strong></h2>
<h3><strong>Deploying microservices</strong></h3>
<pre><code class="language-java">
public abstract class AbstractHttpHandler implements
RequestHandler&lt;APIGatewayProxyRequestEvent, APIGatewayProxyResponseEvent&gt; {
private Logger log = LoggerFactory.getLogger(this.getClass());
@Override
public APIGatewayProxyResponseEvent handleRequest(
APIGatewayProxyRequestEvent input, Context context) {
log.debug("Got request: {}", input);
try {
beforeHandling(input, context);
return handleHttpRequest(input, context);
} catch (Exception e) {
log.error("Error handling request id: {}", context.getAwsRequestId(), e);
return buildErrorResponse(new AwsLambdaError(
"Internal Server Error",
"500",
context.getAwsRequestId(),
"Error handling request: " + context.getAwsRequestId() + " " 
+ input.toString()));
}
}
protected void beforeHandling(APIGatewayProxyRequestEvent request, 
Context context) {
// do nothing
}
protected abstract APIGatewayProxyResponseEvent handleHttpRequest(
APIGatewayProxyRequestEvent request, Context context);
}
  </code></pre>
<h3><strong>12.6.2 Packaging the service as ZIP file</strong></h3>
<p>
   قبل از اینکه service deploy شود، باید آن را به عنوان یک فایل ZIP بسته‌بندی کنیم. ما به راحتی می‌توانیم
   فایل ZIP را با استفاده از Gradle task زیر بسازیم:
  </p>
<pre><code class="language-java">
task buildZip(type: Zip) {
from compileJava
from processResources
into('lib') {
from configurations.runtime
}
}
  </code></pre>
<p>
   این task یک ZIP را با classesها و resourcesها در سطح بالا و JAR
   dependenciesها در دایرکتوری lib می‌سازد.
  </p>
<p>
   اکنون که ما فایل ZIP را ساختیم، بیایید نگاهی به نحوه deploy کردن lambda function بیندازیم.
  </p>
<p>
<strong>Listing 12.11</strong>
<br/>
   An abstract RequestHandler that catches exceptions and returns
   <br/>
   a 500 HTTP response
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0454_original/original_page.png" alt="Original Page 454">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Deploying a RESTful service using AWS Lambda and AWS Gateway</strong></h3>
<h3><strong>12.6.3 Deploying lambda functions using the Serverless framework</strong></h3>
<p>
   استفاده از ابزارهای ارائه شده توسط AWS برای deploy کردن lambda functions و configure کردن API
   gateway، بسیار خسته‌کننده است. خوشبختانه، پروژه متن باز Serverless، استفاده از
   lambda functions را بسیار آسان‌تر می‌کند. هنگام استفاده از Serverless، شما یک فایل server-
   less.yml ساده می‌نویسید که lambda functionsها و RESTful endpointsهای آن‌ها را تعریف می‌کند.
   <br/>
   Serverless سپس lambda functionsها را deploy می‌کند و یک API gate-
   way ایجاد و configure می‌کند که requestsها را به آنها هدایت می‌کند.
  </p>
<p>
   listing زیر، یک excerpt از serverless.yml است که Restaurant
   Service را به عنوان یک lambda deploy می‌کند.
  </p>
<pre><code class="language-yaml">
service: ftgo-application-lambda
provider:
name: aws
  
runtime: java8
timeout: 35
region: ${env:AWS_REGION}
stage: dev
environment:
  
SPRING_DATASOURCE_DRIVER_CLASS_NAME: com.mysql.jdbc.Driver
SPRING_DATASOURCE_URL: ...
SPRING_DATASOURCE_USERNAME: ...
SPRING_DATASOURCE_PASSWORD: ...
package:
  
artifact: ftgo-restaurant-service-aws-lambda/build/distributions/
ftgo-restaurant-service-aws-lambda.zip
functions:
  
create-restaurant:
handler: net.chrisrichardson.ftgo.restaurantservice.lambda
.CreateRestaurantRequestHandler
events:
- http:
path: restaurants
method: post
find-restaurant:
handler: net.chrisrichardson.ftgo.restaurantservice.lambda
.FindRestaurantRequestHandler
events:
- http:
path: restaurants/{restaurantId}
method: get
  </code></pre>
<p>
   سپس می‌توانید از serverless deploy command استفاده کنید، که فایل serverless.yml را می‌خواند،
   lambda functionsها را deploy می‌کند و AWS API Gateway را configure می‌کند. بعد از یک زمان کوتاه
  </p>
<p>
<strong>Listing 12.12</strong>
<br/>
   The serverless.yml deploys Restaurant Service.
   <br/>
   Tells serverless to
   <br/>
   deploy on AWS
   <br/>
   Supplies the service’s
   <br/>
   externalized configuration
   <br/>
   via environment variables
   <br/>
   The ZIP file
   <br/>
   containing the
   <br/>
   lambda functions
   <br/>
   Lambda function definitions
   <br/>
   consisting of the handler
   <br/>
   function and HTTP endpoint
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0455_original/original_page.png" alt="Original Page 455">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 12</strong></h2>
<h3><strong>Deploying microservices</strong></h3>
<p>
   منتظر بمانید، service شما از طریق URL endpoint API gateway قابل دسترسی خواهد بود. AWS Lambda
   به تعداد کافی از instances از هر lambda function Restaurant Service که برای
   پشتیبانی از load مورد نیاز است، provision خواهد کرد. اگر کد را تغییر دهید، می‌توانید به راحتی lambda را با
   rebuilding فایل ZIP و rerunning serverless deploy، آپدیت کنید. هیچ سروری درگیر نیست!
  </p>
<p>
   تکامل زیرساخت‌ها قابل توجه است. نه چندان دور، ما به صورت دستی
   applicationsها را روی ماشین‌های فیزیکی deploy می‌کردیم. امروزه، cloudهای عمومی بسیار خودکار
   طیف وسیعی از گزینه‌های virtual deployment را ارائه می‌دهند. یک گزینه deploy کردن servicesها به عنوان vir-
   tual machines است. یا بهتر از آن، ما می‌توانیم servicesها را به عنوان containers بسته‌بندی کرده و آن‌ها را
   با استفاده از frameworksهای sophisticated Docker orchestration مانند Kubernetes deploy کنیم. گاهی اوقات
   ما حتی از فکر کردن در مورد زیرساخت‌ها به طور کلی اجتناب می‌کنیم و servicesها را به عنوان light-
   weight، ephemeral lambda functions deploy می‌کنیم.
  </p>
<h3><strong>Summary</strong></h3>
<ul>
<li>
    شما باید lightweight deployment pattern را انتخاب کنید که از requirementsهای
    service شما پشتیبانی می‌کند. گزینه‌ها را به ترتیب زیر ارزیابی کنید: serverless,
    containers, virtual machines و language-specific packages.
   </li>
<li>
    یک serverless deployment برای هر service مناسب نیست، به دلیل long-tail
    latencies و requirement استفاده از یک programming
    model مبتنی بر event/request. با این حال، هنگامی که مناسب است، serverless deployment یک گزینه بسیار
    جذاب است زیرا نیازی به مدیریت operating sys-
    tems و runtimes را از بین می‌برد و provisioning الاستیک خودکار و request-
    based pricing را ارائه می‌دهد.
   </li>
<li>
    Docker containers، که یک technol-
    ogy مجازی‌سازی OS-level سبک وزن هستند، انعطاف‌پذیرتر از serverless deployment هستند و latency قابل پیش‌بینی‌تری دارند.
    بهتر است از یک Docker orchestration framework مانند Kuberne-
    tes استفاده کنید، که containersها را روی یک cluster از machines مدیریت می‌کند. نقطه ضعف
    استفاده از containers این است که شما باید operating systems و run-
    times و به احتمال زیاد Docker orchestration framework و VMs که
    روی آن اجرا می‌شود را مدیریت کنید.
   </li>
<li>
    سومین گزینه deployment این است که service خود را به عنوان یک virtual machine deploy کنید. از یک طرف، virtual machines یک
    heavyweight deployment option هستند، بنابراین deploy-
    ment کندتر است و به احتمال زیاد از منابع بیشتری نسبت به گزینه دوم استفاده می‌کند. از سوی دیگر، cloudهای مدرن مانند Amazon EC2 بسیار
    خودکار هستند و مجموعه غنی از featuresها را ارائه می‌دهند. در نتیجه، گاهی اوقات ممکن است
    deploy کردن یک application کوچک و ساده با استفاده از virtual machines آسان‌تر از
    راه اندازی یک Docker orchestration framework باشد.
   </li>
<li>
    Deploy کردن servicesهای خود به عنوان language-specific packages به طور کلی بهتر است اجتناب شود
    مگر اینکه شما فقط تعداد کمی service داشته باشید. به عنوان مثال، همانطور که در
    فصل 13 توضیح داده شد، هنگام شروع سفر خود به microservices، احتمالاً
    servicesها را با استفاده از همان مکانیزمی که برای application monolithic خود استفاده می‌کنید، deploy خواهید کرد، که به احتمال زیاد این گزینه است. شما باید فقط تنظیمات را در نظر بگیرید
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0456_original/original_page.png" alt="Original Page 456">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h3><strong>Summary</strong></h3>
<p>
   up a sophisticated deployment infrastructure such as Kubernetes once you’ve
   developed some services.
  </p>
<ul>
<li>
    یکی از مزایای فراوان استفاده از service mesh—یک networking layer که
    تمامی network traffic را در servicesها و از آنها میانجی‌گری می‌کند—این است که به شما امکان می‌دهد
    یک service را در production deploy کنید، آن را تست کنید و فقط سپس production traffic را به آن
    route کنید. جدا کردن deployment از release، قابلیت اطمینان را در rolling out
    نسخه‌های جدید servicesها بهبود می‌بخشد.
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0457_original/original_page.png" alt="Original Page 457">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>Refactoring to</strong></h2>
<h2><strong>microservices</strong></h2>
<p>
   امیدوارم این کتاب درک خوبی از معماری microservice، مزایا و معایب آن و زمان استفاده از آن را به شما داده باشد. با این حال،
   احتمالاً شما روی یک application monolithic بزرگ و پیچیده کار می‌کنید.
   <br/>
   تجربه روزانه شما از developing و deploying application شما کند و
   دردناک است. Microservicesها، که به نظر می‌رسد برای application شما مناسب هستند، به نظر می‌رسد
   nirvana دور هستند. مانند Mary و بقیه تیم توسعه FTGO، شما در تعجب هستید که چگونه می‌توانید معماری microservice را اتخاذ کنید؟
  </p>
<p>
   خوشبختانه، استراتژی‌هایی وجود دارد که می‌توانید برای فرار از جهنم monolithic استفاده کنید
   بدون نیاز به rewrite کردن application خود از ابتدا. شما به صورت افزایشی تبدیل می‌کنید
  </p>
<p>
   This chapter covers
   <ul>
<li>
     When to migrate a monolithic application to a
     microservice architecture
    </li>
<li>
     Why using an incremental approach is essential
     when refactoring a monolithic application to
     microservices
    </li>
<li>
     Implementing new features as services
    </li>
<li>
     Extracting services from the monolith
    </li>
<li>
     Integrating a service and the monolith
    </li>
</ul>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0458_original/original_page.png" alt="Original Page 458">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>Overview of refactoring to microservices</strong></h2>
<p>
   monolith خود را به microservicesها با توسعه آنچه که به عنوان یک strangler applica-
   tion شناخته می‌شود، تبدیل کنید. ایده یک strangler application از strangler vinesها می‌آید، که در
   جنگل‌های بارانی با دربرگرفتن و گاهی کشتن درختان رشد می‌کنند. یک strangler application یک
   application جدید است که از microservicesها تشکیل شده است که شما با پیاده‌سازی عملکرد
   جدید به عنوان servicesها و استخراج servicesها از monolith توسعه می‌دهید. با گذشت زمان، همانطور که
   strangler application، عملکرد بیشتری را پیاده‌سازی می‌کند، کوچک می‌شود و در نهایت
   monolith را از بین می‌برد. یک مزیت مهم توسعه یک strangler application این است که،
   برخلاف یک big bang rewrite، ارزش را به کسب‌وکار زودتر و اغلب ارائه می‌دهد.
  </p>
<p>
   من این فصل را با توصیف انگیزه‌ها برای refactoring یک monolith به یک
   microservice architecture شروع می‌کنم. سپس نحوه توسعه strangler application را با
   پیاده‌سازی عملکرد جدید به عنوان servicesها و استخراج servicesها از
   monolith توضیح می‌دهم. در مرحله بعد، موضوعات مختلف طراحی، از جمله نحوه یکپارچه‌سازی mono-
   lith و services، نحوه حفظ database consistency در سراسر monolith و
   servicesها، و نحوه رسیدگی به security را پوشش می‌دهم. من فصل را با توصیف چند
   example service به پایان می‌رسانم. یک service، Delayed Order Service است که نام تجاری را پیاده‌سازی می‌کند
   عملکرد جدید The. service دیگر، Delivery Service است که از
   monolith استخراج شده است. بیایید با نگاهی به مفهوم refactoring به یک micro-
   service architecture شروع کنیم.
  </p>
<h3><strong>13.1 Overview of refactoring to microservices</strong></h3>
<p>
   خودتان را جای Mary قرار دهید. شما مسئول application FTGO هستید، یک application monolithic بزرگ و
   قدیمی. کسب‌وکار از ناتوانی مهندسی در ارائه سریع و قابل اطمینان featuresها، بسیار ناامید شده است. به نظر می‌رسد FTGO از
   یک مورد کلاسیک از جهنم monolithic رنج می‌برد. Microservicesها، حداقل در ظاهر، به نظر می‌رسد که
   پاسخ هستند. آیا باید پیشنهاد دهید که منابع توسعه را از توسعه feature به سمت migrat-
   ing به یک microservice architecture منحرف کنید؟
  </p>
<p>
   من این بخش را با بحث در مورد اینکه چرا باید refactoring را به microser-
   vices در نظر بگیرید، شروع می‌کنم. من همچنین در مورد اینکه چرا مهم است که مطمئن شوید که مشکلات توسعه نرم‌افزار شما به این دلیل است
   که شما در جهنم monolithic هستید تا به عنوان مثال، در یک
   software development process ضعیف. سپس استراتژی‌هایی را برای refactoring افزایشی
   monolith خود به یک microservice architecture توضیح می‌دهم. در مرحله بعد، در مورد اهمیت
   ارائه بهبودها در اوایل و اغلب برای حفظ پشتیبانی از busi-
   ness بحث می‌کنم. سپس توضیح می‌دهم که چرا باید از سرمایه‌گذاری در یک deployment
   infrastructure پیچیده تا زمانی که چند services را توسعه داده‌اید، اجتناب کنید. در نهایت، من را توصیف می‌کنم
   استراتژی‌های مختلفی که می‌توانید برای معرفی servicesها در معماری خود استفاده کنید، از جمله imple-
   menting features جدید به عنوان servicesها و استخراج servicesها از monolith.
  </p>
<h3><strong>13.1.1 Why refactor a monolith?</strong></h3>
<p>
   معماری microservice همانطور که در فصل 1 توضیح داده شد، مزایای متعددی دارد. این
   قابلیت نگهداری، testability و deployability بسیار بهتری دارد، بنابراین توسعه را تسریع می‌کند.
   معماری microservice مقیاس‌پذیرتر است و باعث بهبود fault isolation می‌شود.
   همچنین تکامل technology stack شما بسیار آسان‌تر است. اما refactoring یک monolith به
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0459_original/original_page.png" alt="Original Page 459">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   microservices یک کار مهم است. این کار منابع را از توسعه features جدید منحرف می‌کند.
   در نتیجه، احتمالاً کسب‌وکار تنها از پذیرش microservices در صورتی حمایت می‌کند که یک
   مشکل مهم تجاری را حل کند.
  </p>
<p>
   اگر شما در جهنم monolithic هستید، احتمالاً از قبل حداقل یک مشکل تجاری دارید. در اینجا نمونه‌هایی از مشکلات تجاری ناشی از جهنم monolithic آورده شده است:
   <ul>
<li>
     Slow delivery—Application درک، نگهداری و تست آن دشوار است، بنابراین
     developer productivity پایین است. در نتیجه، سازمان قادر به رقابت موثر نیست و در معرض خطر است که توسط رقبا از بین برود.
    </li>
<li>
     Buggy software releases—عدم testability به این معنی است که software releasesها اغلب buggy هستند. این باعث نارضایتی مشتریان می‌شود که منجر به از دست دادن مشتریان و کاهش درآمد می‌شود.
    </li>
<li>
     Poor scalability—Scaling یک application monolithic دشوار است زیرا modulesها را با requirementsهای resource بسیار متفاوت در یک executable compo-
     nent ترکیب می‌کند. عدم scalability به این معنی است که scale کردن application فراتر از یک نقطه معین غیرممکن یا گران است. در نتیجه، appli-
     cation نمی‌تواند از نیازهای فعلی یا پیش‌بینی شده کسب‌وکار پشتیبانی کند.
    </li>
</ul>
</p>
<p>
   مهم است که مطمئن شوید این مشکلات وجود دارد، زیرا شما از معماری خود فراتر رفته‌اید. یک دلیل رایج برای slow delivery و buggy releases، یک software است
   development process ضعیف است. به عنوان مثال، اگر هنوز به manual testing متکی هستید، سپس
   تنها اتخاذ automated testing می‌تواند به طور قابل توجهی development velocity را افزایش دهد.
   به طور مشابه، گاهی اوقات می‌توانید مشکلات scalability را بدون تغییر معماری خود حل کنید.
   ابتدا باید راه‌حل‌های ساده‌تری را امتحان کنید. اگر، و فقط اگر، هنوز هم software دارید
   delivery problemsها، سپس باید به microservice architecture مهاجرت کنید. بیایید
   نگاهی به نحوه انجام این کار بیندازیم.
  </p>
<h3><strong>13.1.2 Strangling the monolith</strong></h3>
<p>
   فرآیند تبدیل یک application monolithic به microservices، نوعی از
   application modernization (https://en.wikipedia.org/wiki/Software_modernization) است.
   Application modernization، فرآیند تبدیل یک application legacy به یک application است که دارای
   یک معماری مدرن و technology stack است. Developersها سال‌هاست که در حال modernizing appli-
   cationsها هستند. در نتیجه، دانشی وجود دارد که از طریق تجربه انباشته شده است و ما
   می‌توانیم هنگام refactoring یک application به یک microservice architecture از آن استفاده کنیم. مهم‌ترین
   درسی که در طول سال‌ها آموخته شد این است که یک big bang rewrite انجام ندهید.
  </p>
<p>
   یک big bang rewrite زمانی است که شما یک application جدید—در این مورد، یک microservices-
   based application—را از ابتدا توسعه می‌دهید. اگرچه شروع از ابتدا و رها کردن legacy
   code base به نظر جذاب می‌رسد، اما بسیار خطرناک است و احتمالاً با شکست مواجه می‌شود.
   شما ماه‌ها، احتمالاً سال‌ها، به تکرار عملکرد موجود خواهید پرداخت و تنها
   سپس می‌توانید featuresهایی را که کسب‌وکار امروز به آنها نیاز دارد، پیاده‌سازی کنید! همچنین، شما
   به هر حال باید application legacy را توسعه دهید، که تلاش را از
   rewrite منحرف می‌کند و به این معنی است که شما یک target constantly moving دارید.
   علاوه بر این، ممکن است
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0460_original/original_page.png" alt="Original Page 460">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>Overview of refactoring to microservices</strong></h2>
<p>
   که شما زمان خود را صرف reimplement کردن featuresهایی می‌کنید که دیگر مورد نیاز نیستند. همانطور که Martin
   Fowler گزارش داد، "تنها چیزی که یک Big Bang rewrite تضمین می‌کند، یک Big Bang است!"
   (www.randyshoup.com/evolutionary-architecture).
  </p>
<p>
   به جای انجام یک big bang rewrite، شما باید، همانطور که شکل 13.1 نشان می‌دهد، به صورت افزایشی
   application monolithic خود را refactor کنید. شما به تدریج یک application جدید می‌سازید که
   strangler application نامیده می‌شود. این شامل microservicesهایی است که همزمان اجرا می‌شوند
   با application monolithic شما. با گذشت زمان، مقدار functionality که توسط application monolithic imple-
   mented می‌شود، تا زمانی که یا به طور کامل ناپدید می‌شود یا
   تبدیل به یک microservice دیگر می‌شود، کوچک می‌شود. این استراتژی شبیه به سرویس‌دهی به ماشین شما در حالی است که
   در بزرگراه با سرعت 70 مایل در ساعت رانندگی می‌کنید. این کار چالش برانگیز است، اما بسیار کم خطرتر از تلاش برای
   یک big bang rewrite است.
  </p>
<p>
   Martin Fowler به این استراتژی application modernization، الگوی Strangler appli-
   cation (www.martinfowler.com/bliki/StranglerApplication.html) اشاره دارد. این نام
   از strangler vine (یا strangler fig—به https://en.wikipedia.org/wiki/ مراجعه کنید
   Strangler_fig) که در جنگل‌های بارانی یافت می‌شود. یک strangler vine، به دور یک درخت در
  </p>
<p>
   The monolith shrinks over time.
   <br/>
   The strangler application
   <br/>
   grows larger over time.
   <br/>
   Monolith
   <br/>
   Monolith
   <br/>
   Service
   <br/>
   Strangler application
   <br/>
   Monolith
   <br/>
   Service
   <br/>
   Monolith
   <br/>
   Service
   <br/>
   ...
   <br/>
   ...
   <br/>
   Monolith
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Service
   <br/>
   Time
  </p>
<p>
<strong>Figure 13.1</strong>
<br/>
   The monolith is incrementally replaced by a strangler application comprised of services.
   <br/>
   Eventually, the monolith is replaced entirely by the strangler application or becomes another
   microservice.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0461_original/original_page.png" alt="Original Page 461">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   برای رسیدن به نور خورشید بالای canopy جنگل،
   به دور یک درخت دیگر رشد می‌کند. اغلب درخت می‌میرد، زیرا
   یا توسط vine کشته می‌شود یا بر اثر پیری می‌میرد، و یک vine به شکل درخت باقی می‌ماند.
  </p>
<p>
   فرآیند refactoring معمولاً ماه‌ها یا سال‌ها طول می‌کشد. به عنوان مثال، طبق گفته
   Steve Yegge (https://plus.google.com/+RipRowan/posts/eVeouesvaVX)
   Amazon.com، refactor کردن monolith خود چند سال طول کشید. در مورد یک system بسیار بزرگ،
   ممکن است هرگز این فرآیند را کامل نکنید. به عنوان مثال، ممکن است به نقطه‌ای برسید که شما
   tasksهایی دارید که از شکستن monolith مهم‌تر هستند، مانند imple-
   menting featuresها که درآمدزا هستند. اگر monolith مانعی برای
   development مداوم نیست، ممکن است آن را رها کنید.
  </p>
<h3><strong>DEMONSTRATE VALUE EARLY AND OFTEN</strong></h3>
<p>
   یک مزیت مهم از refactoring افزایشی به یک microservice architecture این است که
   شما بازگشت فوری سرمایه‌گذاری خود را دریافت می‌کنید. این با یک big
   bang rewrite، که هیچ فایده‌ای را تا زمانی که کامل نشود، ارائه نمی‌دهد، بسیار متفاوت است. هنگامی که incremen-
   tally refactoring monolith را انجام می‌دهید، می‌توانید هر service جدید را با استفاده از یک technology
   stack جدید و یک process توسعه و تحویل مدرن، با سرعت بالا و سبک DevOps توسعه دهید. در نتیجه، سرعت تحویل تیم شما به طور پیوسته در طول زمان افزایش می‌یابد.
  </p>
<p>
   علاوه بر این، می‌توانید مناطق با ارزش بالای application خود را ابتدا به microser-
   vicesها مهاجرت دهید. به عنوان مثال، تصور کنید که شما روی application FTGO کار می‌کنید. کسب‌وکار
   ممکن است، به عنوان مثال، تصمیم بگیرد که الگوریتم زمان‌بندی تحویل یک
   competitive advantage کلیدی است. احتمالاً مدیریت تحویل، یک منطقه از constant, ongoing
   development خواهد بود. با استخراج مدیریت تحویل به یک service مستقل، تحویل
   management team قادر خواهد بود به طور مستقل از بقیه developersهای FTGO کار کند
   و به طور قابل توجهی velocity توسعه خود را افزایش دهد. آنها می‌توانند به طور مکرر
   نسخه‌های جدید الگوریتم را deploy کرده و اثربخشی آنها را ارزیابی کنند.
  </p>
<p>
   یکی دیگر از مزایای توانایی ارائه value در اوایل این است که به حفظ
   پشتیبانی کسب‌وکار از تلاش‌های migration کمک می‌کند. پشتیبانی مداوم آنها ضروری است، زیرا
   تلاش refactoring به این معنی است که زمان کمتری صرف توسعه features می‌شود. بعضی
   سازمان‌ها در حذف technical debt مشکل دارند، زیرا تلاش‌های گذشته
   بیش از حد جاه‌طلبانه بودند و سود زیادی نداشتند. در نتیجه، کسب‌وکار می‌شود
   از سرمایه‌گذاری در تلاش‌های بیشتر cleanup خودداری می‌کند. ماهیت افزایشی refactoring به
   microservices به این معنی است که team development قادر به نشان دادن value در اوایل است
   و اغلب.
  </p>
<h3><strong>MINIMIZE CHANGES TO THE MONOLITH</strong></h3>
<p>
   یک موضوع تکراری در این فصل این است که شما باید از ایجاد
   تغییرات گسترده در monolith هنگام migrating به یک microservice architecture اجتناب کنید. این اجتناب ناپذیر است
  </p>
<p>
   Pattern: Strangler application
   <br/>
   Modernize an application by incrementally developing a new (strangler) application
   around the legacy application. See http://microservices.io/patterns/refactoring/
   strangler-application.html.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0462_original/original_page.png" alt="Original Page 462">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>Strategies for refactoring a monolith to microservices</strong></h2>
<p>
   که شما نیاز دارید که برخی تغییرات را ایجاد کنید تا از migration به servicesها پشتیبانی کنید. Sec-
   شن 13.3.2 در مورد چگونگی اصلاح monolith صحبت می‌کند تا بتواند در sagasهایی شرکت کند که database consistency را در سراسر monolith و
   servicesها حفظ می‌کنند. مشکل ایجاد تغییرات گسترده در monolith این است که زمان‌بر است،
   هزینه‌بر است و خطرناک است. به هر حال، احتمالاً به همین دلیل است که می‌خواهید به microservicesها مهاجرت کنید
   در وهله اول.
  </p>
<p>
   خوشبختانه، استراتژی‌هایی وجود دارد که می‌توانید برای کاهش دامنه تغییرات
   که شما نیاز دارید انجام دهید، استفاده کنید. به عنوان مثال، در بخش 13.2.3، من استراتژی تکثیر را توضیح می‌دهم
   data از یک service استخراج شده به database monolith. و در بخش 13.3.2،
   من نشان می‌دهم که چگونه می‌توانید با دقت توالی استخراج servicesها را برای کاهش تأثیر
   بر روی monolith قرار دهید. با اعمال این استراتژی‌ها، می‌توانید میزان کار را کاهش دهید
   که برای refactor کردن monolith مورد نیاز است.
  </p>
<h3><strong>TECHNICAL DEPLOYMENT INFRASTRUCTURE: YOU DON’T NEED ALL OF IT YET</strong></h3>
<p>
   در سراسر این کتاب من در مورد بسیاری از technologyهای جدید و درخشان بحث کرده‌ام، از جمله deploy-
   ment platformsها مانند Kubernetes و AWS Lambda و service discovery mecha-
   nismsها. ممکن است وسوسه شوید که migrat کردن به microservicesها را با انتخاب
   technologiesها و ساختن آن infrastructure آغاز کنید. شما حتی ممکن است از
   business peopleها و از vendor PaaS دوستانه‌تان برای شروع خرج کردن پول
   بر روی این نوع infrastructure.
  </p>
<p>
   همانطور که به نظر می‌رسد ساختن این infrastructure در ابتدا وسوسه‌انگیز است، من توصیه می‌کنم فقط
   یک سرمایه‌گذاری اولیه minimal در توسعه آن انجام دهید. تنها چیزی که شما نمی‌توانید بدون آن زندگی کنید
   یک deployment pipeline است که انجام می‌دهد automating testing. به عنوان مثال، اگر
   شما فقط تعداد انگشت شماری service دارید، شما به یک deployment پیچیده و
   infrastructure observability نیاز ندارید. در ابتدا، شما حتی می‌توانید با استفاده از یک hard-
   coded configuration file برای service discovery کنار بیایید. من پیشنهاد می‌کنم هرگونه تصمیم‌گیری در مورد
   technical infrastructure که شامل سرمایه‌گذاری قابل توجهی است را تا زمانی که واقعی
   experience را با microservice architecture کسب کرده‌اید، به تعویق بیندازید. این فقط زمانی است که شما چند service
   running داشته باشید که شما تجربه انتخاب technologiesها را خواهید داشت.
  </p>
<p>
   اکنون بیایید به استراتژی‌هایی نگاهی بیندازیم که می‌توانید برای migrating به یک microservice
   architecture استفاده کنید.
  </p>
<h3><strong>13.2 Strategies for refactoring a monolith to microservices</strong></h3>
<p>
   سه استراتژی اصلی برای strangling monolith و جایگزینی افزایشی وجود دارد
   با microservices:
  </p>
<ol>
<li>
    Implement new features as services.
   </li>
<li>
    Separate the presentation tier and backend.
   </li>
<li>
    Break up the monolith by extracting functionality into services.
   </li>
</ol>
<p>
   اولین استراتژی، monolith را از رشد باز می‌دارد. این معمولاً یک راه سریع برای
   نشان دادن value of microservices است و به ایجاد پشتیبانی برای migration کمک می‌کند
   effort. دو استراتژی دیگر monolith را از هم جدا می‌کنند. هنگام refactoring شما
   monolith، شما ممکن است گاهی از استراتژی دوم استفاده کنید، اما مطمئناً از
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0463_original/original_page.png" alt="Original Page 463">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   strategy، زیرا این نحوه مهاجرت functionality از monolith به
   strangler application است.
  </p>
<p>
   بیایید نگاهی به هر یک از این استراتژی‌ها بیندازیم، با پیاده‌سازی features جدید به عنوان servicesها شروع می‌کنیم.
  </p>
<h3><strong>13.2.1 Implement new features as services</strong></h3>
<p>
   قانون Holes بیان می‌کند که "اگر خود را در یک سوراخ یافتید، از کندن دست بکشید" (https://
   en.m.wikipedia.org/wiki/Law_of_holes). این یک توصیه عالی است که باید هنگام
   monolithic application شما غیرقابل مدیریت شده است، دنبال کنید. به عبارت دیگر، اگر شما یک
   application monolithic بزرگ و complex دارید، featuresهای جدید را با افزودن کد به
   monolith پیاده‌سازی نکنید. این باعث می‌شود که monolith شما حتی بزرگ‌تر و غیرقابل مدیریت‌تر شود. در عوض،
   شما باید featuresهای جدید را به عنوان servicesها پیاده‌سازی کنید.
  </p>
<p>
   این یک راه عالی برای شروع migrating application monolithic خود به یک microser-
   vice architecture است. این باعث کاهش نرخ رشد monolith می‌شود. توسعه را تسریع می‌کند
   featuresهای جدید، زیرا شما در حال توسعه در یک کد کاملاً جدید هستید
   base. همچنین به سرعت value اتخاذ microservice architecture را نشان می‌دهد.
  </p>
<h3><strong>INTEGRATING THE NEW SERVICE WITH THE MONOLITH</strong></h3>
<p>
   شکل 13.2 معماری application را پس از پیاده‌سازی یک feature جدید به عنوان یک
   service نشان می‌دهد. علاوه بر service جدید و monolith، معماری شامل دو ele-
   ments دیگر است که service را در application ادغام می‌کند:
   <ul>
<li>
     API gateway—requestsها را برای functionality جدید به service جدید route می‌کند و
     requestsهای legacy را به monolith route می‌کند.
    </li>
<li>
     Integration glue code—service را با monolith ادغام می‌کند. این service را قادر می‌سازد تا به data متعلق به monolith دسترسی پیدا کند و functionality را فراخوانی کند که imple-
     mented شده توسط monolith.
    </li>
</ul>
</p>
<p>
   The integration glue code یک component مستقل نیست. در عوض، این شامل adapt-
   ersها در monolith و service است که از یک یا چند interprocess communication استفاده می‌کنند
   mechanismsها. به عنوان مثال، integration glue برای Delayed Delivery Service، شرح داده شده
   در بخش 13.4.1، از REST و domain events استفاده می‌کند. service، اطلاعات قرارداد مشتری را از
   monolith با فراخوانی یک REST API بازیابی می‌کند. monolith pub-
   lishes Order domain eventsها، به طوری که Delayed Delivery Service می‌تواند state of را ردیابی کند
   Orders و به orderهایی پاسخ می‌دهد که به موقع تحویل داده نمی‌شوند. بخش 13.3.1 توضیح می‌دهد
   the integration glue code را با جزئیات بیشتر.
  </p>
<h3><strong>WHEN TO IMPLEMENT A NEW FEATURE AS A SERVICE</strong></h3>
<p>
   در حالت ایده‌آل، شما باید هر feature جدید را در strangler application پیاده‌سازی کنید،
   تا در monolith. شما یک feature جدید را یا به عنوان یک service جدید یا به عنوان بخشی از
   از یک service موجود. به این ترتیب، شما از هرگز دست زدن به کد monolith اجتناب خواهید کرد
   base. متأسفانه، اگرچه، نه هر feature جدید می‌تواند به عنوان یک service پیاده‌سازی شود.
  </p>
<p>
   That’s because the essence of a microservice architecture is a set of loosely coupled
   services that are organized around business capabilities. A feature might, for instance,
   be too small to be a meaningful service. You might, for example, just need to add a
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0464_original/original_page.png" alt="Original Page 464">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>Strategies for refactoring a monolith to microservices</strong></h2>
<p>
   چند فیلد و متد به یک کلاس موجود. یا ممکن است feature جدید خیلی تنگ
   به کد در monolith متصل شود. اگر شما سعی کردید این نوع fea-
   ture را به عنوان یک service پیاده‌سازی کنید، معمولاً متوجه می‌شوید که performance به دلیل
   interprocess communication بیش از حد، آسیب می‌بیند. همچنین ممکن است در حفظ مشکل داشته باشید
   data consistency. اگر یک feature جدید نمی‌تواند به عنوان یک service پیاده‌سازی شود، راه‌حل این است
   اغلب برای پیاده‌سازی اولیه feature جدید در monolith. بعداً، شما می‌توانید آن feature را به همراه سایر featuresهای مرتبط به service خودشان استخراج کنید.
  </p>
<p>
   پیاده‌سازی features جدید به عنوان servicesها، توسعه آن fea-
   turesها را سرعت می‌بخشد. این یک راه خوب برای نشان دادن سریع ارزش microservice architec-
   ture است. همچنین نرخ رشد monolith را کاهش می‌دهد. اما در نهایت، شما نیاز دارید که
   monolith را با استفاده از دو استراتژی دیگر جدا کنید. شما نیاز دارید که functionality را به
   strangler application با استخراج functionality از monolith به servicesها مهاجرت دهید.
   شما همچنین ممکن است بتوانید velocity توسعه را با تقسیم monolith hor-
   izontally بهبود بخشید. بیایید نگاهی به نحوه انجام این کار بیندازیم.
  </p>
<p>
   Monolith
   <br/>
   Outbound
   <br/>
   adapter
   <br/>
   API gateway
   <br/>
   Old features
   <br/>
   New features
   <br/>
   Integration
   <br/>
   glue
   <br/>
   Inbound
   <br/>
   adapter
   <br/>
   Inbound
   <br/>
   adapter
   <br/>
   Database
   <br/>
   adapter
   <br/>
   Database
   <br/>
   adapter
   <br/>
   Inbound
   <br/>
   adapter
   <br/>
   Event
   <br/>
   subscriber
   <br/>
   adapter
   <br/>
   Event
   <br/>
   publisher
   <br/>
   adapter
   <br/>
   Service
   <br/>
   database
   <br/>
   Monolith
   <br/>
   database
   <br/>
   «aggregate»
   <br/>
   DelayedDelivery
   <br/>
   Service
   <br/>
   «aggregate»
   <br/>
   Order
   <br/>
   «aggregate»
   <br/>
   Notification
   <br/>
   Service
   <br/>
   implementing
   <br/>
   new feature
  </p>
<p>
<strong>Figure 13.2</strong>
<br/>
   A new feature is implemented as a service that’s part of the strangler application. The
   integration glue integrates the service with the monolith and consists of adapters that implement
   synchronous and asynchronous APIs. An API gateway routes requests that invoke new functionality
   to the service.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0465_original/original_page.png" alt="Original Page 465">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<h3><strong>13.2.2 Separate presentation tier from the backend</strong></h3>
<p>
   یک استراتژی برای shrinking کردن یک application monolithic، جدا کردن presentation layer است
   از business logic و data access layersها. یک application enterprise معمولی شامل
   layersهای زیر است:
   <ul>
<li>
     Presentation logic—این شامل modulesهایی است که HTTP requestsها را handle می‌کنند و gener-
     ate صفحات HTML که یک web UI را پیاده‌سازی می‌کنند. در یک application که یک user interface sophisticated دارد، presentation tier اغلب یک بدنه قابل توجه از کد است.
    </li>
<li>
     Business logic—این شامل modulesهایی است که business rulesها را پیاده‌سازی می‌کنند، که
     می‌تواند در یک application enterprise پیچیده باشد.
    </li>
<li>
     Data access logic—این شامل modulesهایی است که به infrastructure servicesها مانند
     databasesها و message brokersها دسترسی دارند.
    </li>
</ul>
</p>
<p>
   معمولاً یک جداسازی تمیز بین presentation logic و business
   و data access logic وجود دارد. business tier دارای یک API coarse-grained است که شامل یک یا
   بیشتر facadesهایی است که business logic را encapsulated می‌کنند. این API یک seam طبیعی است
   که در امتداد آن می‌توانید monolith را به دو application کوچک‌تر تقسیم کنید، همانطور که در شکل 13.3 نشان داده شده است.
  </p>
<p>
   Business logic
   <br/>
   Business logic
   <br/>
   REST
   <br/>
   API
   <br/>
   REST
   <br/>
   client
   <br/>
   Web
   <br/>
   app
   <br/>
   Browser
   <br/>
   Browser
   <br/>
   HTML pages
   <br/>
   HTML pages
   <br/>
   Monolith containing
   <br/>
   presentation logic and
   <br/>
   backend business logic
   <br/>
   Smaller, independently
   <br/>
   deployable presentation
   <br/>
   logic monolith
   <br/>
   MySQL
   <br/>
   Database
   <br/>
   adapter
   <br/>
   MySQL
   <br/>
   Database
   <br/>
   adapter
   <br/>
   Web
   <br/>
   application
   <br/>
   Split
   <br/>
   Smaller, independently
   <br/>
   deployable backend
   <br/>
   monolith
   <br/>
   An API that is callable
   <br/>
   by any future services
  </p>
<p>
<strong>Figure 13.3</strong>
<br/>
   Splitting the frontend from the backend enables each to be deployed independently. It also exposes
   an API for services to invoke.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0466_original/original_page.png" alt="Original Page 466">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>Strategies for refactoring a monolith to microservices</strong></h2>
<p>
   یک application شامل presentation layer است و دیگری شامل business
   و data access logic است. پس از split، presentation logic application، از راه دور
   callsها را به business logic application انجام می‌دهد.
  </p>
<p>
   تقسیم monolith به این روش دو مزیت اصلی دارد. این شما را قادر می‌سازد تا توسعه دهید،
   deploy کنید و دو application را به طور مستقل از یکدیگر scale کنید. به طور خاص، این
   به developersهای presentation layer اجازه می‌دهد تا به سرعت بر روی user interface تکرار شوند و
   به راحتی A/B testing را انجام دهند، به عنوان مثال، بدون نیاز به deploy کردن backend.
   <br/>
   یکی دیگر از مزایای این رویکرد این است که یک API remote را در معرض دید قرار می‌دهد که می‌تواند توسط
   microservicesهایی که بعداً توسعه می‌دهید، فراخوانی شود.
  </p>
<p>
   اما این استراتژی تنها یک راه‌حل جزئی است. بسیار محتمل است که حداقل یک یا هر دو
   application حاصل هنوز یک monolith غیرقابل مدیریت باشند. شما نیاز دارید که از
   استراتژی سوم برای جایگزینی monolith با services استفاده کنید.
  </p>
<h3><strong>13.2.3 Extract business capabilities into services</strong></h3>
<p>
   Implementing features جدید به عنوان servicesها و تقسیم frontend web application
   از backend، فقط شما را به این اندازه می‌رساند. شما هنوز هم در حال انجام کارهای زیادی در
   code base monolithic هستید. اگر می‌خواهید به طور قابل توجهی معماری application خود را بهبود بخشید و velocity توسعه خود را افزایش دهید، شما نیاز دارید که
   monolith را با انتقال تدریجی business capabilitiesها از monolith به
   servicesها جدا کنید. به عنوان مثال، بخش 13.5 نحوه استخراج delivery management را شرح می‌دهد
   از FTGO monolith به یک Delivery Service جدید. هنگامی که شما از این استراتژی استفاده می‌کنید،
   با گذشت زمان، تعداد business capabilitiesهایی که توسط servicesها پیاده‌سازی می‌شوند، افزایش می‌یابد و
   monolith به تدریج کوچک می‌شود.
  </p>
<p>
   عملکردی که می‌خواهید به یک service استخراج کنید، یک برش عمودی از طریق
   monolith است. این برش شامل موارد زیر است:
   <ul>
<li>
     Inbound adapters که API endpointsها را پیاده‌سازی می‌کنند
    </li>
<li>
     Domain logic
    </li>
<li>
     Outbound adaptersها مانند database access logic
    </li>
<li>
     The monolith’s database schema
    </li>
</ul>
</p>
<p>
   همانطور که شکل 13.4 نشان می‌دهد، این کد از monolith استخراج شده و به یک stand-
   alone service منتقل می‌شود. یک API gateway، requestsهایی را که business capa-
   bility استخراج شده را به service فراخوانی می‌کنند، route می‌کند و سایر requestsها را به monolith route می‌کند. monolith و
   service از طریق integration glue code با هم همکاری می‌کنند. همانطور که در بخش 13.3.1 توضیح داده شد،
   the integration glue از adaptersها در service و monolith تشکیل شده است که از یک یا چند
   interprocess communication (IPC) mechanismsها استفاده می‌کنند.
  </p>
<p>
   Extracting servicesها چالش برانگیز است. شما نیاز دارید که تعیین کنید چگونه
   domain model monolith را به دو domain model جداگانه تقسیم کنید، که یکی از آنها به ser-
   vice’s domain model تبدیل می‌شود. شما نیاز دارید که وابستگی‌ها مانند object referencesها را بشکنید. شما
   حتی ممکن است نیاز به تقسیم classesها داشته باشید تا functionality را به service منتقل کنید. شما
   همچنین نیاز به refactor کردن database دارید.
  </p>
<p>
   استخراج یک service اغلب زمان‌بر است، به خصوص به این دلیل که code base monolith
   احتمالاً messy است. در نتیجه، شما نیاز دارید که با دقت به اینکه کدام
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0467_original/original_page.png" alt="Original Page 467">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   servicesها را استخراج کنید. مهم است که بر refactoring آن بخش‌هایی از application
   تمرکز کنید که ارزش زیادی ارائه می‌دهند. قبل از استخراج یک service، از خودتان بپرسید که چه
   مزایایی از انجام این کار وجود دارد.
  </p>
<p>
   به عنوان مثال، استخراج یک service که functionality را پیاده‌سازی می‌کند که برای کسب‌وکار
   critical است و به طور مداوم در حال تحول است، ارزشمند است. سرمایه‌گذاری effort در استخراج
   servicesها، زمانی که مزایای زیادی از انجام این کار وجود ندارد، ارزشمند نیست. بعداً در این sec-
   شن، من برخی از استراتژی‌ها را برای تعیین اینکه چه چیزی را استخراج کنم و چه زمانی، توضیح می‌دهم. اما ابتدا،
   بیایید با جزئیات بیشتر به برخی از چالش‌هایی که هنگام استخراج یک service با آن روبرو می‌شوید و نحوه
   برطرف کردن آنها، نگاهی بیندازیم.
  </p>
<p>
   شما هنگام استخراج یک service با چند چالش مواجه خواهید شد:
   <ul>
<li>
     Splitting the domain model
    </li>
<li>
     Refactoring the database
    </li>
</ul>
</p>
<p>
   بیایید به هر کدام نگاهی بیندازیم، با splitting the domain model شروع می‌کنیم.
  </p>
<p>
   Outbound
   <br/>
   adapter
   <br/>
   API gateway
   <br/>
   Service containing
   <br/>
   extracted code
   <br/>
   Integration
   <br/>
   glue
   <br/>
   Inbound
   <br/>
   adapter
   <br/>
   Inbound
   <br/>
   adapter
   <br/>
   Database
   <br/>
   adapter
   <br/>
   Database
   <br/>
   adapter
   <br/>
   Inbound
   <br/>
   adapter
   <br/>
   Outbound
   <br/>
   adapter
   <br/>
   Inbound
   <br/>
   adapter
   <br/>
   Service
   <br/>
   database
   <br/>
   Monolith
   <br/>
   database
   <br/>
   «
   <br/>
   »
   <br/>
   service
   <br/>
   Order Service
   <br/>
   «aggregate»
   <br/>
   Courier
   <br/>
   «aggregate»
   <br/>
   Plan
   <br/>
   «service»
   <br/>
   Order Service
   <br/>
   «aggregate»
   <br/>
   Courier
   <br/>
   «aggregate»
   <br/>
   Plan
   <br/>
   Code to
   <br/>
   extract into
   <br/>
   a service
   <br/>
   Monolith
   <br/>
   «
   <br/>
   »
   <br/>
   service
   <br/>
   Order Service
   <br/>
   «aggregate»
   <br/>
   Order
   <br/>
   «
   <br/>
   »
   <br/>
   aggregate
   <br/>
   Order
   <br/>
   Glue code integrating
   <br/>
   service with monolith
  </p>
<p>
<strong>Figure 13.4</strong>
<br/>
   Break apart the monolith by extracting services. You identify a slice of functionality, which consists
   of business logic and adapters, to extract into a service. You move that code into the service. The newly extracted
   service and the monolith collaborate via the APIs provided by the integration glue.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0468_original/original_page.png" alt="Original Page 468">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>Strategies for refactoring a monolith to microservices</strong></h2>
<h3><strong>SPLITTING THE DOMAIN MODEL</strong></h3>
<p>
   به منظور استخراج یک service، شما نیاز دارید که domain model آن را از domain model monolith استخراج کنید. شما
   نیاز دارید که جراحی بزرگی را برای تقسیم domain modelsها انجام دهید. یک
   چالش که با آن روبرو خواهید شد، حذف object referencesهایی است که در غیر این صورت
   service boundaries را پوشش می‌دهد. ممکن است classesهایی که در monolith باقی می‌مانند، به
   classesهایی که به service منتقل شده‌اند، یا بالعکس، reference کنند. به عنوان مثال، تصور کنید که، همانطور که
   شکل 13.5 نشان می‌دهد، شما Order Service را استخراج می‌کنید، و در نتیجه class Order آن،
   class Restaurant monolith را reference می‌کند. از آنجایی که یک instance service معمولاً یک process است،
   داشتن object referencesهایی که از service boundaries عبور می‌کنند، منطقی نیست. به نوعی
   شما نیاز دارید که این نوع object reference را حذف کنید.
  </p>
<p>
   یک راه خوب برای حل این مشکل این است که از منظر DDD aggregatesها فکر کنید، همانطور که در
   فصل 5 توضیح داده شد. Aggregatesها با استفاده از primary keyها به یکدیگر reference می‌کنند،
   به جای object ref-
   erencesها. بنابراین، شما classesهای Order و Restaurant را به عنوان aggre-
   gatesها در نظر می‌گیرید و، همانطور که شکل 13.6 نشان می‌دهد، reference به Restaurant در class Order را
   با یک فیلد restaurantId که مقدار primary key را ذخیره می‌کند، جایگزین می‌کنید.
  </p>
<p>
   FTGO monolith
   <br/>
   Extracted service
   <br/>
   «Entity»
   <br/>
   Restaurant
   <br/>
   Object reference that spans
   <br/>
   service boundaries
   <br/>
   «Entity»
   <br/>
   Order
   <br/>
   Delivery Service
   <br/>
   FTGO monolith
   <br/>
   ?
   <br/>
   «Entity»
   <br/>
   Restaurant
   <br/>
   «Entity»
   <br/>
   Order
  </p>
<p>
<strong>Figure 13.5</strong>
<br/>
   The Order domain class has a reference to a Restaurant class. If we extract
   Order into a separate service, we need to do something about its reference to Restaurant,
   because object references between processes don’t make sense.
  </p>
<p>
   Replace with primary key.
   <br/>
   Delivery Service
   <br/>
   FTGO monolith
   <br/>
   «Entity»
   <br/>
   Restaurant
   <br/>
   «Entity»
   <br/>
   Order
   <br/>
   restaurantId
   <br/>
   Object reference that spans
   <br/>
   service boundaries
   <br/>
   Delivery Service
   <br/>
   FTGO monolith
   <br/>
   ?
   <br/>
   «Entity»
   <br/>
   Restaurant
   <br/>
   «Entity»
   <br/>
   Order
  </p>
<p>
<strong>Figure 13.6</strong>
<br/>
   The Order class’s reference to Restaurant is replaced with the Restaurant's
   primary key in order to eliminate an object that would span process boundaries.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0469_original/original_page.png" alt="Original Page 469">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   یک مسئله با جایگزینی object referencesها با primary keyها این است که اگرچه این یک
   تغییر جزئی در کلاس است، اما به طور بالقوه می‌تواند تأثیر زیادی بر clientsهای کلاس داشته باشد،
   که انتظار یک object reference را دارند. در ادامه این بخش، من نحوه کاهش
   دامنه تغییرات را با replicating data بین service و monolith توضیح می‌دهم. Delivery
   Service، به عنوان مثال، می‌تواند یک کلاس Restaurant را تعریف کند که یک replica از mono-
   lith’s Restaurant class است.
  </p>
<p>
   استخراج یک service اغلب بسیار بیشتر از انتقال کل classesها به یک
   service، درگیر است. یک چالش بزرگ‌تر با splitting یک domain model، استخراج func-
   tionality است که در یک class که responsibilitiesهای دیگری دارد، تعبیه شده است. این مشکل اغلب
   در god classesها رخ می‌دهد که در فصل 2 توضیح داده شد، که تعداد زیادی از responsi-
   bilitiesها را دارند. به عنوان مثال، کلاس Order یکی از god classesها در application FTGO است.
   این، business capabilitiesهای متعددی، از جمله order management،
   delivery management و غیره را پیاده‌سازی می‌کند. بعداً در بخش 13.5، من در مورد نحوه استخراج
   delivery management به یک service بحث می‌کنم، که شامل استخراج یک کلاس Delivery از
   class Order است. Delivery entity، functionality delivery management را پیاده‌سازی می‌کند
   که قبلاً با functionalityهای دیگر در کلاس Order بسته‌بندی شده بود.
  </p>
<h3><strong>REFACTORING THE DATABASE</strong></h3>
<p>
   Splitting یک domain model، شامل بیش از تغییر کد است. بسیاری از classesها در یک
   domain model، persistent هستند. فیلدهای آن‌ها به یک database schema نگاشت می‌شوند. در نتیجه،
   هنگامی که شما یک service را از monolith استخراج می‌کنید، در حال جابجایی data نیز هستید. شما
   نیاز دارید که جداول را از database monolith به database service منتقل کنید.
  </p>
<p>
   همچنین، هنگامی که شما یک entity را split می‌کنید، نیاز دارید که database table مربوطه را split کنید
   و جدول جدید را به service منتقل کنید. به عنوان مثال، هنگام استخراج delivery manage-
   ment به یک service، شما entity Order را split کرده و یک entity Delivery را استخراج می‌کنید. در سطح
   database، شما جدول ORDERS را split کرده و یک جدول DELIVERY جدید تعریف می‌کنید. سپس
   شما جدول DELIVERY را به service منتقل می‌کنید.
  </p>
<p>
   کتاب Refactoring Databases by Scott W. Ambler and Pramod J. Sadalage (Addison-
   Wesley, 2011) یک مجموعه refactorings را برای یک database schema توضیح می‌دهد. به عنوان مثال، این
   the Split Table refactoring را توضیح می‌دهد، که یک جدول را به دو یا چند جدول تقسیم می‌کند.
   بسیاری از techniqueها در آن کتاب، هنگام استخراج servicesها از
   monolith مفید هستند. یکی از این تکنیک‌ها، ایده replicating data است تا به شما اجازه دهد
   به طور افزایشی clientsهای database را برای استفاده از schema جدید، آپدیت کنید. ما می‌توانیم
   آن ایده را برای کاهش دامنه تغییراتی که باید در monolith هنگام
   استخراج یک service انجام دهید، تطبیق دهیم.
  </p>
<h3><strong>REPLICATE DATA TO AVOID WIDESPREAD CHANGES</strong></h3>
<p>
   همانطور که گفته شد، استخراج یک service، شما را ملزم می‌کند که به domain
   model monolith تغییر دهید. به عنوان مثال، شما object referencesها را با primary keyها جایگزین می‌کنید و classesها را split می‌کنید.
   این نوع تغییرات می‌تواند از طریق code base ripple شود و شما را ملزم می‌کند
   تغییرات گسترده‌ای را در monolith ایجاد کنید. به عنوان مثال، اگر شما entity Order را split کنید و
   یک entity Delivery را استخراج کنید، شما باید هر مکانی را در کدی که به
   fieldsها اشاره دارد، تغییر دهید. ایجاد این نوع تغییرات می‌تواند فوق‌العاده باشد
   وقت‌گیر بوده و می‌تواند به یک مانع بزرگ برای شکستن monolith تبدیل شود.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0470_original/original_page.png" alt="Original Page 470">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>Strategies for refactoring a monolith to microservices</strong></h2>
<p>
   یک راه عالی برای به تاخیر انداختن و احتمالاً اجتناب از ایجاد این نوع تغییرات پرهزینه،
   استفاده از رویکردی است که شبیه به رویکردی است که در Refactoring Databases توضیح داده شده است. یک مانع بزرگ برای refactoring
   یک database، تغییر دادن تمام clientsهای آن database برای استفاده از
   new schema است. راه‌حل پیشنهادی در این کتاب، حفظ schema اصلی برای
   یک دوره transition و استفاده از triggersها برای همگام‌سازی schemasهای اصلی و جدید است. شما
   سپس clientsها را از schema قدیمی به schema جدید در طول زمان مهاجرت می‌دهید.
  </p>
<p>
   ما می‌توانیم از یک رویکرد مشابه هنگام استخراج servicesها از monolith استفاده کنیم. برای
   به عنوان مثال، هنگام استخراج entity Delivery، ما entity Order را عمدتاً
   برای یک دوره transition، بدون تغییر باقی می‌گذاریم. همانطور که شکل 13.7 نشان می‌دهد، ما delivery-related
   fieldsها را read-only می‌کنیم و آنها را با replicating data از Delivery Service
   به monolith، به‌روز نگه می‌داریم. در نتیجه، ما فقط نیاز داریم که مکان‌هایی را در کد monolith پیدا کنیم
   که آن fieldsها را آپدیت می‌کنند و آنها را به فراخوانی Delivery Service جدید تغییر می‌دهیم.
  </p>
<p>
   حفظ ساختار entity Order با replicating data از Delivery
   Service، میزان کاری را که فوراً باید انجام دهیم، به طور قابل توجهی کاهش می‌دهد. بیش از
   زمان، ما می‌توانیم کدی را که از delivery-related Order entity fieldsها یا ORDERS
   table columns به Delivery Service استفاده می‌کند، مهاجرت دهیم. علاوه بر این، این امکان وجود دارد که ما هرگز نیازی به
  </p>
<p>
   Read-only
   <br/>
   delivery-related
   <br/>
   ﬁelds
   <br/>
   ORDER_ID
   <br/>
   ...
   <br/>
   ORDER table
   <br/>
   RESTAURANT_ID
   <br/>
   ...
   <br/>
   SCHEDULED_PICKUP_TIME
   <br/>
   ...
   <br/>
   SCHEDULED_DELIVERY_TIME
   <br/>
   ...
   <br/>
   ...
   <br/>
   ...
   <br/>
   «Entity»
   <br/>
   Order
   <br/>
   FTGO monolith
   <br/>
   ...
   <br/>
   consumerId
   <br/>
   scheduledPickupTime
   <br/>
   scheduledDeliveryTime
   <br/>
   ...
   <br/>
   ORDER_ID
   <br/>
   ...
   <br/>
   ORDER table
   <br/>
   RESTAURANT_ID
   <br/>
   ...
   <br/>
   SCHEDULED_PICKUP_TIME
   <br/>
   ...
   <br/>
   SCHEDULED_DELIVERY_TIME
   <br/>
   ...
   <br/>
   ...
   <br/>
   ...
   <br/>
   «Entity»
   <br/>
   Order
   <br/>
   FTGO monolith
   <br/>
   ...
   <br/>
   consumerId
   <br/>
   scheduledPickupTime
   <br/>
   scheduledDeliveryTime
   <br/>
   ...
   <br/>
   ORDER_ID
   <br/>
   ...
   <br/>
   DELIVERY table
   <br/>
   SCHEDULED_PICKUP_TIME
   <br/>
   ...
   <br/>
   SCHEDULED_DELIVERY_TIME
   <br/>
   ...
   <br/>
   ...
   <br/>
   «Entity»
   <br/>
   Delivery
   <br/>
   Delivery Service
   <br/>
   Extract Order Service and move columns from
   <br/>
   ORDER
   <br/>
   DELIVERY
   <br/>
   table to a new
   <br/>
   table.
   <br/>
   Replicate data from Delivery Service to FTGO monolith.
   <br/>
   ...
   <br/>
   orderId
   <br/>
   scheduledPickupTime
   <br/>
   scheduledDeliveryTime
   <br/>
   ...
  </p>
<p>
<strong>Figure 13.7</strong>
<br/>
   Minimize the scope of the changes to the FTGO monolith by replicating delivery-related data from the
   newly extracted Delivery Service back to the monolith’s database.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0471_original/original_page.png" alt="Original Page 471">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   make that change in the monolith. If that code is subsequently extracted into a ser-
   vice, then the service can access Delivery Service.
  </p>
<h3><strong>WHAT SERVICES TO EXTRACT AND WHEN</strong></h3>
<p>
   همانطور که گفتم، شکستن monolith زمان‌بر است. این باعث می‌شود که effort از
   implementing featuresها منحرف شود. در نتیجه، شما باید با دقت ترتیب را تعیین کنید
   که در آن servicesها را استخراج می‌کنید. شما نیاز دارید که بر استخراج servicesهایی تمرکز کنید که بزرگ-
   ترین benefit را ارائه می‌دهند. علاوه بر این، شما می‌خواهید به طور مداوم به کسب‌وکار نشان دهید که
   value در migrating به یک microservice architecture وجود دارد.
  </p>
<p>
   در هر سفری، دانستن اینکه به کجا می‌روید، ضروری است. یک راه خوب برای شروع
   migration به microservicesها با یک effort تعریف architecture time-boxed است. شما
   باید زمان کمی را صرف کنید، مانند چند هفته، برای brainstorming معماری ایده‌آل خود و
   تعریف یک مجموعه از servicesها. این به شما یک destination می‌دهد که هدف قرار دهید.
   با این حال، مهم است که به یاد داشته باشید که این architecture در سنگ حک نشده است. به عنوان
   شما monolith را جدا می‌کنید و experience کسب می‌کنید، باید architecture را بازبینی کنید
   تا آنچه را که آموخته‌اید در نظر بگیرید.
  </p>
<p>
   هنگامی که شما destination تقریبی را تعیین کردید، گام بعدی این است که شروع کنید
   monolith را جدا کنید. چند استراتژی مختلف وجود دارد که می‌توانید برای
   تعیین ترتیبی که در آن servicesها را استخراج می‌کنید.
  </p>
<p>
   یک استراتژی، به طور موثر freeze کردن development monolith و استخراج ser-
   vicesها در صورت تقاضا است. به جای implementing featuresها یا fixing bugsها در monolith،
   شما service یا services(ها) لازم را استخراج کرده و آنها را تغییر می‌دهید. یک مزیت این
   رویکرد این است که شما را مجبور می‌کند که monolith را بشکنید. یک نقطه ضعف این است که
   استخراج servicesها، توسط requirementsهای کوتاه‌مدت به جای بلندمدت، هدایت می‌شود
   needsها. به عنوان مثال، شما را ملزم می‌کند که servicesها را استخراج کنید، حتی اگر شما در حال ایجاد یک تغییر کوچک به یک بخش نسبتاً پایدار از system هستید. در نتیجه، شما در معرض خطر انجام کارهای زیاد هستید
   برای حداقل benefit.
  </p>
<p>
   یک استراتژی جایگزین یک رویکرد برنامه‌ریزی‌شده‌تر است، جایی که شما modulesها را رتبه‌بندی می‌کنید
   از یک application بر اساس benefit که شما از استخراج آنها پیش‌بینی می‌کنید، دریافت می‌کنید. وجود دارد
   چندین دلیل وجود دارد که چرا استخراج یک service مفید است:
   <ul>
<li>
     Accelerates development—اگر roadmap application شما نشان می‌دهد که یک خاص
     بخش application شما در سال آینده، توسعه زیادی را متحمل خواهد شد،
     سپس تبدیل آن به یک service، توسعه را سرعت می‌بخشد.
    </li>
<li>
     Solves a performance, scaling, or reliability problem—اگر یک بخش خاص از appli-
     cation شما دارای یک performance یا مشکل scalability است یا غیرقابل اعتماد است، پس ارزشمند است
     برای تبدیل آن به یک service.
    </li>
<li>
     Enables the extraction of some other services—گاهی استخراج یک service sim-
     plifies استخراج service دیگری، به دلیل وابستگی‌ها بین modulesها.
    </li>
</ul>
</p>
<p>
   شما می‌توانید از این معیارها برای افزودن refactoring tasksها به backlog application خود استفاده کنید،
   که بر اساس benefit مورد انتظار رتبه‌بندی شده‌اند. مزیت این رویکرد این است که استراتژیک‌تر است
   و بسیار نزدیک‌تر با نیازهای کسب‌وکار هماهنگ شده است. در طول sprint plan-
   ning، شما تصمیم می‌گیرید که آیا implement کردن featuresها یا استخراج servicesها ارزشمندتر است.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0472_original/original_page.png" alt="Original Page 472">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<h3><strong>13.3 Designing how the service and the monolith collaborate</strong></h3>
<p>
   یک service به ندرت standalone است. این معمولاً نیاز دارد که با monolith همکاری کند. Some-
   times یک service نیاز دارد که به data متعلق به monolith دسترسی داشته باشد یا عملیات آن را فراخوانی کند.
   <br/>
   به عنوان مثال، Delayed Delivery Service، که با جزئیات در بخش 13.4.1 توضیح داده شد، نیاز دارد
   دسترسی به orders و customer contact infoهای monolith را داشته باشد. monolith همچنین ممکن است
   نیاز داشته باشد که به data متعلق به service دسترسی داشته باشد یا عملیات آن را فراخوانی کند. به عنوان مثال، بعداً
   در بخش 13.5، هنگام بحث در مورد چگونگی استخراج delivery management به یک service، من
   توضیح می‌دهم که چگونه monolith نیاز دارد Delivery Service را فراخوانی کند.
  </p>
<p>
   یک نگرانی مهم، حفظ data consistency بین service و
   monolith است. به طور خاص، هنگامی که شما یک service را از monolith استخراج می‌کنید، شما به ناچار
   چیزی را که در اصل ACID transactions بودند، split می‌کنید. شما باید مراقب باشید تا اطمینان حاصل کنید که data
   consistency هنوز حفظ شده است. همانطور که بعداً در این بخش توضیح داده شد، گاهی اوقات شما استفاده می‌کنید
   sagasها برای حفظ data consistency.
  </p>
<p>
   تعامل بین یک service و monolith، همانطور که قبلاً توضیح داده شد، توسط facili-
   tated شده توسط integration glue code. شکل 13.8 ساختار integration glue را نشان می‌دهد.
   این شامل adaptersها در service و monolith است که با استفاده از نوعی
   IPC mechanism ارتباط برقرار می‌کنند. بسته به requirementsها، service و monolith ممکن است
   با استفاده از REST تعامل داشته باشند یا ممکن است از messaging استفاده کنند. آنها حتی ممکن است با استفاده از
   چندین IPC mechanism ارتباط برقرار کنند.
  </p>
<p>
   به عنوان مثال، Delayed Delivery Service از REST و domain eventsها استفاده می‌کند. این
   customer contact info را از monolith با استفاده از REST بازیابی می‌کند. این state of را ردیابی می‌کند
   Ordersها با subscribe کردن به domain eventsهایی که توسط monolith منتشر می‌شوند.
  </p>
<p>
   Monolith
   <br/>
   Service
   <br/>
   Inbound
   <br/>
   adapter
   <br/>
   Integration
   <br/>
   glue
   <br/>
   API
   <br/>
   adapter
   <br/>
   API
   <br/>
   adapter
   <br/>
   Outbound
   <br/>
   adapter
   <br/>
   Outbound
   <br/>
   adapter
   <br/>
   Inbound
   <br/>
   adapter
  </p>
<p>
<strong>Figure 13.8</strong>
<br/>
   When migrating a monolith to microservices, the services and monolith often need to access each
   other’s data. This interaction is facilitated by the integration glue, which consists of adapters that implement APIs.
   Some APIs are messaging based. Other APIs are RPI based.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0473_original/original_page.png" alt="Original Page 473">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   در این بخش، ابتدا طراحی integration glue را توضیح می‌دهم. من در مورد prob-
   lemsهایی که حل می‌کند و گزینه‌های پیاده‌سازی مختلف، صحبت می‌کنم. پس از آن من استراتژی‌های management transaction را توضیح می‌دهم، از جمله استفاده از sagasها. من در مورد اینکه چگونه گاهی اوقات requir-
   ment برای حفظ data consistency، ترتیبی که در آن servicesها را استخراج می‌کنید، تغییر می‌دهد، بحث می‌کنم.
  </p>
<p>
   بیایید ابتدا به طراحی integration glue نگاهی بیندازیم.
  </p>
<h3><strong>13.3.1 Designing the integration glue</strong></h3>
<p>
   هنگام پیاده‌سازی یک feature به عنوان یک service یا استخراج یک service از monolith،
   شما باید integration glue را توسعه دهید که service را قادر می‌سازد تا با
   monolith همکاری کند. این شامل کد در service و monolith است که از نوعی
   IPC mechanism استفاده می‌کند. ساختار integration glue به نوع IPC
   mechanism که استفاده می‌شود، بستگی دارد. اگر، به عنوان مثال، service، monolith را با استفاده از REST فراخوانی می‌کند،
   سپس integration glue شامل یک REST client در service و web controllersها
   در monolith است. از طرف دیگر، اگر monolith به domain eventsهایی که
   توسط service منتشر می‌شوند، subscribe می‌کند، سپس integration glue شامل یک event-publishing adapter در
   service و event handlersها در monolith است.
  </p>
<h3><strong>DESIGNING THE INTEGRATION GLUE API</strong></h3>
<p>
   اولین گام در طراحی integration glue این است که تصمیم بگیرید که چه APIsهایی را ارائه می‌دهد
   به domain logic. دو سبک مختلف از interface وجود دارد که می‌توانید از بین آنها انتخاب کنید،
   بسته به اینکه شما در حال querying data هستید یا updating data. بیایید بگوییم که شما در حال کار کردن هستید-
   ing on Delayed Delivery Service، که نیاز دارد customer contact info را بازیابی کند
   از monolith. business logic service نیاز ندارد که IPC mecha-
   nism را بداند که integration glue برای بازیابی اطلاعات استفاده می‌کند. بنابراین، آن mecha-
   nism باید توسط یک interface encapsulated شود. از آنجایی که Delayed Delivery Service در حال
   querying data است، تعریف کردن یک CustomerContactInfoRepository منطقی است:
  </p>
<pre><code class="language-java">
interface CustomerContactInfoRepository {
CustomerContactInfo findCustomerContactInfo(long customerId)
}
  </code></pre>
<p>
   business logic service می‌تواند این API را بدون دانستن اینکه چگونه integration
   glue، data را بازیابی می‌کند، فراخوانی کند.
  </p>
<p>
   بیایید یک service متفاوت را در نظر بگیریم. تصور کنید که شما در حال استخراج delivery manage-
   ment از FTGO monolith هستید. monolith نیاز دارد که Delivery Service را برای
   schedule, reschedule، و cancel deliveriesها فراخوانی کند. یک بار دیگر، جزئیات زیربنایی
   IPC mechanism برای business logic مهم نیستند و باید توسط
   یک interface encapsulated شوند. در این سناریو، monolith باید یک service operation را فراخوانی کند، بنابراین استفاده از یک
   repository منطقی نیست. یک رویکرد بهتر، تعریف یک service interface است، مانند
   زیر:
  </p>
<pre><code class="language-java">
interface DeliveryService {
void scheduleDelivery(...);
void rescheduleDelivery(...);
void cancelDelivery(...);
}
  </code></pre>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0474_original/original_page.png" alt="Original Page 474">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   business logic monolith، این API را بدون دانستن نحوه پیاده‌سازی آن فراخوانی می‌کند
   توسط integration glue.
  </p>
<p>
   اکنون که ما طراحی interface را دیده‌ایم، بیایید نگاهی به سبک‌های تعامل و IPC
   mechanismsها بیندازیم.
  </p>
<h3><strong>PICKING AN INTERACTION STYLE AND IPC MECHANISM</strong></h3>
<p>
   یک تصمیم طراحی مهم که شما باید هنگام طراحی integration glue بگیرید،
   انتخاب سبک‌های تعامل و IPC mechanismsهایی است که service و
   monolith را قادر می‌سازد تا با هم همکاری کنند. همانطور که در فصل 3 توضیح داده شد، چندین تعامل وجود دارد
   stylesها و IPC mechanismsها برای انتخاب. اینکه کدام یک را باید استفاده کنید، بستگی دارد به
   آنچه که یک party—the service یا monolith—در order برای query کردن یا آپدیت کردن نیاز دارد
   party دیگر
  </p>
<p>
   اگر یک party نیاز به query کردن data متعلق به party دیگر داشته باشد، چندین وجود دارد
   گزینه‌ها. یک گزینه این است که، همانطور که شکل 13.9 نشان می‌دهد، برای adapter که
   interface repository را پیاده‌سازی می‌کند، یک API از data provider را فراخوانی کنید. این API معمولاً از یک
   request/response interaction style، مانند REST یا gRPC استفاده می‌کند. به عنوان مثال، Delayed
   Delivery Service ممکن است اطلاعات تماس مشتری را با فراخوانی یک REST API بازیابی کند
   که توسط FTGO monolith پیاده‌سازی شده است.
  </p>
<p>
   در این مثال، domain logic Delayed Delivery Service، customer را بازیابی می‌کند
   contact info با فراخوانی interface CustomerContactInfoRepository. the imple-
   mentation of this interface، REST API monolith را فراخوانی می‌کند.
  </p>
<p>
   یک مزیت مهم از querying data با فراخوانی یک query API، سادگی آن است.
   نقطه ضعف اصلی این است که به طور بالقوه ناکارآمد است. یک consumer ممکن است نیاز داشته باشد که a
   تعداد زیادی requests را انجام دهد. یک provider ممکن است مقدار زیادی data را برگرداند. یک
   نقطه ضعف دیگر این است که در دسترس بودن را کاهش می‌دهد زیرا IPC همزمان است. در نتیجه،
   استفاده از یک query API ممکن است عملی نباشد.
  </p>
<p>
   Delayed
   <br/>
   Delivery Service
   <br/>
   Customer
   <br/>
   ContactInfo
   <br/>
   Repository
   <br/>
   GET/customers/{customerId}
   <br/>
   FTGO
   <br/>
   monolith
   <br/>
   Monolith
   <br/>
   database
   <br/>
   REST
   <br/>
   API
   <br/>
   REST
   <br/>
   client
  </p>
<p>
<strong>Figure 13.9</strong>
<br/>
   The adapter that implements the CustomerContactInfoRepository interface invokes the
   monolith’s REST API to retrieve the customer information.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0475_original/original_page.png" alt="Original Page 475">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   یک رویکرد جایگزین این است که data consumer یک replica از data را حفظ کند،
   همانطور که در شکل 13.10 نشان داده شده است. replica اساساً یک view از نوع CQRS است. the data consumer
   replica را با subscribing به domain eventsهایی که توسط data
   provider منتشر می‌شوند، به‌روز نگه می‌دارد.
  </p>
<p>
   استفاده از یک replica دارای چندین مزیت است. از سربار querying مکرر
   data provider اجتناب می‌کند. در عوض، همانطور که هنگام توصیف CQRS در فصل 7 بحث شد، شما می‌توانید
   replica را برای پشتیبانی از queriesهای کارآمد طراحی کنید. با این حال، یکی از معایب استفاده از یک replica،
   پیچیدگی نگهداری آن است. یک چالش بالقوه، همانطور که بعداً
   در این بخش توضیح داده شد، نیاز به تغییر monolith برای publish کردن domain eventsها است.
  </p>
<p>
   اکنون که ما در مورد نحوه انجام queriesها بحث کردیم، بیایید در نظر بگیریم که چگونه updatesها را انجام دهیم. یکی
   چالش با انجام updatesها، نیاز به حفظ data consistency در سراسر
   service و monolith است. party که درخواست update را می‌دهد (the requestor)
   database خود را آپدیت کرده یا نیاز به آپدیت آن دارد. بنابراین ضروری است که هر دو update انجام شوند.
  </p>
<p>
   راه‌حل این است که service و monolith با استفاده از transactional mes-
   saging که توسط یک framework پیاده‌سازی شده است، مانند Eventuate Tram، ارتباط برقرار کنند. در سناریوهای ساده،
   requestor می‌تواند یک پیام notification ارسال کند یا یک event را برای trigger کردن یک update منتشر کند. در
   سناریوهای پیچیده‌تر، requestor باید از یک saga برای حفظ data consistency استفاده کند.
   بخش 13.3.2 پیامدهای استفاده از sagasها را مورد بحث قرار می‌دهد.
  </p>
<h3><strong>IMPLEMENTING AN ANTI-CORRUPTION LAYER</strong></h3>
<p>
   تصور کنید که شما در حال پیاده‌سازی یک feature جدید به عنوان یک service کاملاً جدید هستید. شما محدود نشده‌اید
   توسط code base monolith، بنابراین شما می‌توانید از تکنیک‌های توسعه مدرن استفاده کنید
  </p>
<p>
   Delayed
   <br/>
   Delivery Service
   <br/>
   FTGO
   <br/>
   monolith
   <br/>
   Monolith
   <br/>
   database
   <br/>
   Service
   <br/>
   database
   <br/>
   Event
   <br/>
   publisher
   <br/>
   Customer event channel
   <br/>
   Customer
   <br/>
   domain
   <br/>
   event
   <br/>
   Event
   <br/>
   subscriber
   <br/>
   Database
   <br/>
   adapter
   <br/>
   Customer
   <br/>
   ContactInfo
   <br/>
   Repository
   <br/>
   query()
   <br/>
   update()
  </p>
<p>
<strong>Figure 13.10</strong>
<br/>
   The integration glue replicates data from the monolith to the service. The monolith publishes
   domain events, and an event handler implemented by the service updates the service’s database.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0476_original/original_page.png" alt="Original Page 476">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   مانند DDD و یک domain model جدید و pristine را توسعه دهید. همچنین، از آنجایی که FTGO
   domain monolith به خوبی تعریف نشده و تا حدودی out-of-date است، شما احتمالاً
   مفاهیم را متفاوت مدل‌سازی می‌کنید. در نتیجه، domain model service شما classes
   names، field names و field valuesهای متفاوتی خواهد داشت. به عنوان مثال، Delayed Delivery Service دارای یک
   Delivery entity با responsibilitiesهای narrowly focused است، در حالی که FTGO monolith
   دارای یک entity Order با تعداد زیادی از responsibilitiesها است. از آنجایی که دو
   domain modelsها متفاوت هستند، شما باید آنچه DDD آن را یک anti-corruption
   layer (ACL) می‌نامد را پیاده‌سازی کنید تا service بتواند با monolith ارتباط برقرار کند.
  </p>
<p>
   هدف از یک ACL، جلوگیری از آلوده شدن domain model یک monolith legacy به یک
   domain model service است. این یک layer از کد است که بین domain modelsهای مختلف، ترجمه می‌کند.
   به عنوان مثال، همانطور که شکل 13.11 نشان می‌دهد، Delayed Delivery Service دارای یک
   interface CustomerContactInfoRepository است، که یک متد findCustomerContact-
   Info() را تعریف می‌کند که CustomerContactInfo را برمی‌گرداند. کلاس که
   interface CustomerContactInfoRepository را پیاده‌سازی می‌کند، باید بین زبان ubiquitous
   Delayed Delivery Service و FTGO monolith، ترجمه کند.
  </p>
<p>
   پیاده‌سازی findCustomerContactInfo()، monolith FTGO را برای
   بازیابی اطلاعات مشتری فراخوانی می‌کند و response را به CustomerContact-
   Info ترجمه می‌کند. در این مثال، ترجمه کاملاً ساده است، اما در سناریوهای دیگر می‌تواند
   بسیار پیچیده باشد و شامل، به عنوان مثال، mapping valuesها مانند status codes باشد.
  </p>
<p>
   Pattern: Anti-corruption layer
   <br/>
   A software layer that translates between two different domain models in order to
   prevent concepts from one model polluting another. See https://microservices.io/
   patterns/refactoring/anti-corruption-layer.html.
  </p>
<p>
   Delayed
   <br/>
   Delivery Service
   <br/>
   FTGO
   <br/>
   monolith
   <br/>
   REST
   <br/>
   API
   <br/>
   API
   <br/>
   Translation layer
   <br/>
   GET/user/{userId}
   <br/>
   Monolith layer
   <br/>
   REST client
   <br/>
   Customer
   <br/>
   ContactInfo
   <br/>
   Repository
   <br/>
   Ubiquitous language of service
   <br/>
   Ubiquitous language of monolith
   <br/>
   Anti-corruption layer
  </p>
<p>
<strong>Figure 13.11</strong>
<br/>
   A service adapter that invokes the monolith must translate between the service’s domain model
   and the monolith’s domain model.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0477_original/original_page.png" alt="Original Page 477">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   یک event subscriber، که domain eventsها را مصرف می‌کند، همچنین دارای یک ACL است. Domain
   eventsها بخشی از domain model منتشرکننده هستند. یک event handler باید
   domain eventsها را به domain model مشترک، ترجمه کند. به عنوان مثال، همانطور که شکل 13.12 نشان می‌دهد،
   FTGO monolith، Order domain eventsها را منتشر می‌کند. Delivery Service دارای یک event
   handler است که به آن eventsها subscribe می‌کند.
  </p>
<p>
   event handler باید domain eventsها را از زبان domain monolith به
   Delivery Service ترجمه کند. ممکن است نیاز داشته باشد که class و attribute namesها را mapping کند
   و به طور بالقوه attribute valuesها را mapping کند.
  </p>
<p>
   این فقط servicesها نیستند که از یک anti-corruption layer استفاده می‌کنند. یک monolith نیز از یک ACL استفاده می‌کند
   هنگام فراخوانی service و هنگام subscribe کردن به domain eventsهایی که توسط یک ser-
   vice منتشر می‌شوند. به عنوان مثال، FTGO monolith یک delivery را با ارسال یک notification
   message به Delivery Service schedule می‌کند. این پیام notification را با فراخوانی یک متد در
   interface DeliveryService ارسال می‌کند. کلاس implementation، پارامترهای آن را به یک
   message ترجمه می‌کند که Delivery Service آن را درک می‌کند.
  </p>
<h3><strong>HOW THE MONOLITH PUBLISHES AND SUBSCRIBES TO DOMAIN EVENTS</strong></h3>
<p>
   Domain eventsها یک mechanism همکاری مهم هستند. برای یک
   service که به تازگی توسعه یافته است، publish و consume کردن eventsها ساده است. این می‌تواند از یکی از mecha-
   nismsهایی که در فصل 3 توضیح داده شد، مانند فریم‌ورک Eventuate Tram استفاده کند. یک service
   حتی ممکن است با استفاده از event sourcing، که در فصل 6 توضیح داده شد، eventsها را منتشر کند. این poten-
   tially چالش برانگیز است، هرچند، تغییر monolith برای publish و consume کردن eventsها.
  </p>
<p>
   دو روش مختلف وجود دارد که یک monolith می‌تواند domain eventsها را publish کند.
   یک رویکرد، استفاده از همان domain event publishing mechanism است که توسط
  </p>
<p>
   Delayed
   <br/>
   Delivery
   <br/>
   Service
   <br/>
   FTGO
   <br/>
   monolith
   <br/>
   Event handler
   <br/>
   Translation layer
   <br/>
   Messaging client
   <br/>
   Ubiquitous language of service
   <br/>
   Ubiquitous language of monolith
   <br/>
   Anti-corruption layer
   <br/>
   Event channel
   <br/>
   Order
   <br/>
   event
   <br/>
   Event
   <br/>
   publisher
  </p>
<p>
<strong>Figure 13.12</strong>
<br/>
   An event handler must translate from the event publisher’s domain model to the subscriber’s domain
   model.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0478_original/original_page.png" alt="Original Page 478">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   services. شما تمام مکان‌هایی را در کد پیدا می‌کنید که یک entity خاص را تغییر می‌دهند و یک
   call به یک event publishing API وارد می‌کنید. مشکل این رویکرد این است که تغییر یک
   monolith همیشه آسان نیست. ممکن است زمان‌بر و مستعد خطا باشد که تمام
   مکان‌ها را پیدا کرده و callsها را برای publish کردن events وارد کنید. برای بدتر کردن اوضاع، برخی از
   business logic monolith ممکن است از stored proceduresهایی تشکیل شده باشد که نمی‌توانند به راحتی
   domain eventsها را publish کنند.
  </p>
<p>
   یک رویکرد دیگر، publish کردن domain eventsها در سطح database است. شما می‌توانید، برای
   به عنوان مثال، از transaction logic tailing یا polling استفاده کنید، که در فصل 3 توضیح داده شده است. یک
   benefit اصلی استفاده از transaction tailing این است که شما مجبور نیستید که monolith را تغییر دهید. the
   معایب اصلی publish کردن eventsها در سطح database این است که اغلب مشکل است که
   دلیل update را شناسایی کرده و event business سطح بالا را publish کنید. در نتیجه، service
   معمولاً eventsهایی را که نشان دهنده تغییرات در
   tablesها هستند، به جای business entitiesها، publish می‌کند.
  </p>
<p>
   خوشبختانه، معمولاً برای monolith، subscribe کردن به domain eventsها
   published as servicesها آسان‌تر است. اغلب اوقات، شما می‌توانید event handlersها را با استفاده از یک framework بنویسید، مانند
   Eventuate Tram. اما گاهی اوقات، حتی برای monolith، subscribe کردن به
   eventsها چالش برانگیز است. به عنوان مثال، monolith ممکن است به زبانی نوشته شود که نداشته باشد
   a message broker client. در آن موقعیت، شما نیاز دارید که یک application "helper" کوچک بنویسید-
   tion که به eventsها subscribe می‌کند و database monolith را مستقیماً آپدیت می‌کند.
  </p>
<p>
   اکنون که ما به نحوه طراحی integration glue نگاه کردیم که یک ser-
   vice و monolith را قادر می‌سازد تا با هم همکاری کنند، بیایید نگاهی به یک چالش دیگر بیندازیم که ممکن است با آن روبرو شوید
   هنگام migrating به microservicesها: حفظ data consistency در یک service و
   monolith.
  </p>
<h3><strong>13.3.2 Maintaining data consistency across a service and a monolith</strong></h3>
<p>
   هنگامی که شما یک service را توسعه می‌دهید، ممکن است حفظ data consis-
   tency در service و monolith را چالش برانگیز بدانید. یک service operation ممکن است نیاز به update
   data در monolith داشته باشد، یا یک monolith operation ممکن است نیاز به آپدیت کردن data در ser-
   vice داشته باشد. به عنوان مثال، تصور کنید که شما Kitchen Service را از monolith استخراج کردید. شما
   نیاز دارید که عملیات order-management monolith، مانند create-
   Order() و cancelOrder() را تغییر دهید، تا از sagasها استفاده کنید تا Ticket را با
   Order، consistent نگه دارید.
  </p>
<p>
   با این حال، مشکل استفاده از sagasها این است که monolith ممکن است a will-
   ing participant نباشد. همانطور که در فصل 4 توضیح داده شد، sagasها باید از compensating transactionsها
   برای undo کردن تغییرات استفاده کنند. به عنوان مثال، Create Order Saga، شامل یک compensating transac-
   tion است که یک Order را در صورت رد شدن توسط Kitchen Service رد شده نشان می‌دهد. prob-
   lem با compensating transactionsها در monolith این است که شما ممکن است نیاز داشته باشید
   تغییرات متعددی و زمان‌بری را در monolith ایجاد کنید تا از آنها پشتیبانی کنید.
   <br/>
   monolith ممکن است همچنین نیاز به پیاده‌سازی countermeasuresها برای handle کردن کمبود
   isolation بین sagasها. هزینه این تغییرات کد می‌تواند یک مانع بزرگ برای
   استخراج یک service باشد.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0479_original/original_page.png" alt="Original Page 479">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   خوشبختانه، بسیاری از sagasها، پیاده‌سازی آسان دارند. همانطور که در فصل 4 پوشش داده شد، اگر
   transactionsهای monolith یا pivot transactionsها یا retriable transactionsها هستند، سپس
   پیاده‌سازی sagasها باید آسان باشد. شما حتی ممکن است بتوانید
   پیاده‌سازی را با مرتب کردن دقیق sequence of service extractions ساده کنید تا
   transactionsهای monolith هرگز نیازی به compensatable نداشته باشند. یا ممکن است نسبتاً
   دشوار باشد که monolith را برای پشتیبانی از compensating transactionsها تغییر دهید. برای درک
   اینکه چرا پیاده‌سازی compensating transactionsها در monolith گاهی اوقات چالش برانگیز است،
   بیایید به برخی از نمونه‌ها نگاهی بیندازیم، که با یک نمونه به ویژه مشکل‌ساز شروع می‌کنیم.
  </p>
<h3><strong>THE CHALLENGE OF CHANGING THE MONOLITH TO SUPPORT COMPENSATABLE TRANSACTIONS</strong></h3>
<p>
   بیایید به مشکل compensating transactionsها بپردازیم که شما باید هنگام حل کنید
   استخراج Kitchen Service از monolith. این refactoring شامل تقسیم شدن است
   Order entity و ایجاد یک Ticket entity در Kitchen Service. این بر numerousها تأثیر می‌گذارد
   commandsها که توسط monolith پیاده‌سازی شده‌اند، از جمله createOrder().
  </p>
<p>
   monolith، command createOrder() را به عنوان یک ACID transac-
   tion واحد پیاده‌سازی می‌کند که شامل مراحل زیر است:
   <ol>
<li>
     Validate order details.
    </li>
<li>
     Verify that the consumer can place an order.
    </li>
<li>
     Authorize consumer’s credit card.
    </li>
<li>
     Create an Order.
    </li>
</ol>
</p>
<p>
   شما نیاز دارید که این ACID transaction را با یک saga که شامل مراحل زیر است، جایگزین کنید:
  </p>
<ol>
<li>
    In the monolith
    <ul>
<li>
      Create an Order in an APPROVAL_PENDING state.
     </li>
<li>
      Verify that the consumer can place an order.
     </li>
</ul>
</li>
</ol>
<p>
   Key saga terminology
   <br/>
   من در فصل 4 sagasها را پوشش می‌دهم. در اینجا برخی از اصطلاحات کلیدی آورده شده است:
   <ul>
<li>
     Saga—A sequence of local transactions coordinated through asynchronous
     messaging.
    </li>
<li>
     Compensating transaction—A transaction that undoes the updates made by a
     local transaction.
    </li>
<li>
     Countermeasure—A design technique used to handle the lack of isolation
     between sagas.
    </li>
<li>
     Semantic lock—A countermeasure that sets a flag in a record that is being
     updated by a saga.
    </li>
<li>
     Compensatable transaction—A transaction that needs a compensating trans-
     action because one of the transactions that follows it in the saga can fail.
    </li>
<li>
     Pivot transaction—A transaction that is the saga’s go/no-go point. If it suc-
     ceeds, then the saga will run to completion.
    </li>
<li>
     Retriable transaction—A transaction that follows the pivot transaction and is
     guaranteed to succeed.
    </li>
</ul>
</p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0480_original/original_page.png" alt="Original Page 480">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<ol>
<li>
    In the monolith
    <ul>
<li>
      – Create an Order in an APPROVAL_PENDING state.
     </li>
<li>
      – Verify that the consumer can place an order.
     </li>
</ul>
</li>
<li>
    In the Kitchen Service
    <ul>
<li>
      – Validate order details.
     </li>
<li>
      – Create a Ticket in the CREATE_PENDING state.
     </li>
</ul>
</li>
<li>
    In the monolith
    <ul>
<li>
      – Authorize consumer’s credit card.
     </li>
<li>
      – Change state of Order to APPROVED.
     </li>
</ul>
</li>
<li>
    In Kitchen Service
    <ul>
<li>
      – Change the state of the Ticket to AWAITING_ACCEPTANCE.
     </li>
</ul>
</li>
</ol>
<p>
   This saga is similar to CreateOrderSaga described in chapter 4. It consists of four local
   transactions, two in the monolith and two in Kitchen Service. The first transaction
   creates an Order in the APPROVAL_PENDING state. The second transaction creates a
   Ticket in the CREATE_PENDING state. The third transaction authorizes the Consumer
   credit card and changes the state of the order to APPROVED. The fourth and final trans-
   action changes the state of the Ticket to AWAITING_ACCEPTANCE.
  </p>
<p>
   The challenge with implementing this saga is that the first step, which creates the
   Order, must be compensatable. That’s because the second local transaction, which
   occurs in Kitchen Service, might fail and require the monolith to undo the updates
   performed by the first local transaction. As a result, the Order entity needs to have an
   APPROVAL_PENDING, a semantic lock countermeasure, described in chapter 4, that
   indicates an Order is in the process of being created.
  </p>
<p>
   The problem with introducing a new Order entity state is that it potentially requires
   widespread changes to the monolith. You might need to change every place in the
   code that touches an Order entity. Making these kinds of widespread changes to the
   monolith is time consuming and not the best investment of development resources.
   It’s also potentially risky, because the monolith is often difficult to test.
  </p>
<h3><strong>SAGAS DON’T ALWAYS REQUIRE THE MONOLITH TO SUPPORT COMPENSATABLE TRANSACTIONS</strong></h3>
<p>
   Sagasها بسیار domain-specific هستند. برخی، مانند موردی که به تازگی به آن نگاه کردیم، نیاز دارند
   monolith از compensating transactionsها پشتیبانی کند. اما کاملاً ممکن است که وقتی شما
   یک service را استخراج می‌کنید، شما می‌توانید sagasهایی را طراحی کنید که نیازی به monolith نداشته باشند تا
   compensating transactionsها را پیاده‌سازی کند. این به این دلیل است که یک monolith فقط نیاز دارد تا sup-
   port کردن compensating transactionsها را در صورتی که transactionsهایی که به دنبال transaction monolith
   می‌آیند، می‌توانند شکست بخورند. اگر هر یک از transactionsهای monolith یا یک pivot transaction یا یک
   retriable transaction باشد، سپس monolith هرگز نیازی به اجرای یک compensating trans-
   action ندارد. در نتیجه، شما فقط نیاز دارید که تغییرات minimalی را در monolith ایجاد کنید تا sup-
   port sagasها شود.
  </p>
<p>
   به عنوان مثال، تصور کنید که به جای استخراج Kitchen Service، شما Order
   Service را استخراج می‌کنید. این refactoring شامل splitting شدن است
   Order entity و ایجاد یک Order entity کم حجم در Order Service. همچنین بر commandsهای متعددی، از جمله
   createOrder()، تأثیر می‌گذارد، که از monolith به Order Service منتقل می‌شود. به order to
   استخراج Order Service، شما نیاز دارید که command createOrder() را برای استفاده از a
   saga، با استفاده از مراحل زیر، تغییر دهید:
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0481_original/original_page.png" alt="Original Page 481">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<ol>
<li>
    Order Service
    <ul>
<li>
      – Create an Order in an APPROVAL_PENDING state.
     </li>
</ul>
</li>
<li>
    Monolith
    <ul>
<li>
      – Verify that the consumer can place an order.
     </li>
<li>
      – Validate order details and create a Ticket.
     </li>
<li>
      – Authorize consumer’s credit card.
     </li>
</ul>
</li>
<li>
    Order Service
    <ul>
<li>
      – Change state of Order to APPROVED.
     </li>
</ul>
</li>
</ol>
<p>
   This saga consists of three local transactions, one in the monolith and two in Order
   Service. The first transaction, which is in Order Service, creates an Order in the
   APPROVAL_PENDING state. The second transaction, which is in the monolith, verifies
   that the consumer can place orders, authorizes their credit card, and creates a
   Ticket. The third transaction, which is in Order Service, changes the state of the
   Order to APPROVED.
  </p>
<p>
   The monolith’s transaction is the saga’s pivot transaction—the point of no return
   for the saga. If the monolith’s transaction completes, then the saga will run until com-
   pletion. Only the first and second steps of this saga can fail. The third transaction
   can’t fail, so the second transaction in the monolith never needs to be rolled back. As
   a result, all the complexity of supporting compensatable transactions is in Order
   Service, which is much more testable than the monolith.
  </p>
<p>
   If all the sagas that you need to write when extracting a service have this struc-
   ture, you’ll need to make far fewer changes to the monolith. What’s more, it’s possi-
   ble to carefully sequence the extraction of services to ensure that the monolith’s
   transactions are either pivot transactions or retriable transactions. Let’s look at how
   to do that.
  </p>
<h3><strong>SEQUENCING THE EXTRACTION OF SERVICES TO AVOID IMPLEMENTING COMPENSATING TRANSACTIONS IN THE MONOLITH</strong></h3>
<p>
   همانطور که دیدیم، استخراج Kitchen Service، مستلزم آن است که monolith، com-
   pensating transactionsها را پیاده‌سازی کند، در حالی که استخراج Order Service اینگونه نیست. این نشان می‌دهد که
   ترتیب استخراج servicesها مهم است. با مرتب کردن دقیق استخراج
   servicesها، شما به طور بالقوه می‌توانید از ایجاد تغییرات گسترده در
   monolith برای پشتیبانی از compensating transactionsها اجتناب کنید. ما می‌توانیم اطمینان حاصل کنیم که transactionsهای monolith
   یا pivot transactionsها هستند یا retriable transactionsها. به عنوان مثال، اگر ما
   ابتدا Order Service را از FTGO monolith استخراج کنیم و سپس Consumer
   Service را استخراج کنیم، استخراج Kitchen Service آسان خواهد بود. بیایید نگاهی دقیق‌تر
   به نحوه انجام این کار بیندازیم.
  </p>
<p>
   هنگامی که ما Consumer Service را استخراج کردیم، command createOrder() از
   saga زیر استفاده می‌کند:
  </p>
<ol>
<li>
    Order Service: create an Order in an APPROVAL_PENDING state.
   </li>
<li>
    Consumer Service: verify that the consumer can place an order.
   </li>
</ol>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0482_original/original_page.png" alt="Original Page 482">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<ol>
<li>
    Order Service: create an Order in an APPROVAL_PENDING state.
   </li>
<li>
    Consumer Service: verify that the consumer can place an order.
   </li>
<li>
    Monolith
    <ul>
<li>
      – Validate order details and create a Ticket.
     </li>
<li>
      – Authorize consumer’s credit card.
     </li>
</ul>
</li>
<li>
    Order Service: change state of Order to APPROVED.
   </li>
</ol>
<p>
   در این saga، transaction monolith، pivot transaction است. Order Service imple-
   ments، the compensatable transaction.
  </p>
<p>
   اکنون که ما Consumer Service را استخراج کردیم، می‌توانیم Kitchen Service را استخراج کنیم. اگر ما
   این service را استخراج کنیم، command createOrder() از saga زیر استفاده می‌کند:
  </p>
<ol>
<li>
    Order Service: create an Order in an APPROVAL_PENDING state.
   </li>
<li>
    Consumer Service: verify that the consumer can place an order.
   </li>
<li>
    Kitchen Service: validate order details and create a PENDING Ticket.
   </li>
<li>
    Monolith: authorize consumer’s credit card.
   </li>
<li>
    Kitchen Service: change state of Ticket to APPROVED.
   </li>
<li>
    Order Service: change state of Order to APPROVED.
   </li>
</ol>
<p>
   In this saga، transaction monolith هنوز هم pivot transaction است. Order Service و
   Kitchen Service، compensating transactionsها را پیاده‌سازی می‌کنند.
  </p>
<p>
   ما حتی می‌توانیم با استخراج Accounting Service به refactor کردن monolith ادامه دهیم. اگر
   ما این service را استخراج کنیم، command createOrder() از saga زیر استفاده می‌کند:
  </p>
<ol>
<li>
    Order Service: create an Order in an APPROVAL_PENDING state.
   </li>
<li>
    Consumer Service: verify that the consumer can place an order.
   </li>
<li>
    Kitchen Service: validate order details and create a PENDING Ticket.
   </li>
<li>
    Accounting Service: authorize consumer’s credit card.
   </li>
<li>
    Kitchen Service: change state of Ticket to APPROVED.
   </li>
<li>
    Order Service: change state of Order to APPROVED.
   </li>
</ol>
<p>
   همانطور که مشاهده می‌کنید، با sequencing دقیق extractionsها، شما می‌توانید از استفاده از sagasها اجتناب کنید
   که نیاز به ایجاد تغییرات پیچیده در monolith دارند. بیایید اکنون به نحوه handle کردن نگاهی بیندازیم
   security هنگامی که به یک microservice architecture مهاجرت می‌کنید.
  </p>
<h3><strong>13.3.3 Handling authentication and authorization</strong></h3>
<p>
   یکی دیگر از مسائل طراحی که شما باید هنگام refactoring یک application monolithic به
   یک microservice architecture رسیدگی کنید، تطبیق mechanism security monolith برای پشتیبانی از
   servicesها است. فصل 11 نحوه handle کردن security را در یک microservice architec-
   ture شرح می‌دهد. یک application مبتنی بر microservices از tokensهایی مانند JSON Web tokens (JWT) استفاده می‌کند،
   برای انتقال user identity. این بسیار متفاوت از یک application traditional، mono-
   lithic معمولی است که از session state درون حافظه استفاده می‌کند و user iden-
   tity را با استفاده از یک thread local انتقال می‌دهد. چالش هنگام تبدیل یک application monolithic
   به یک microservice architecture این است که شما نیاز دارید که از هر دو mechanism security مبتنی بر monolith و
   JWT به طور همزمان پشتیبانی کنید.
  </p>
<p>
   خوشبختانه، یک راه ساده برای حل این مشکل وجود دارد که فقط به آن نیاز دارد
   شما فقط یک تغییر کوچک در login request handler monolith ایجاد کنید. شکل 13.13
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0483_original/original_page.png" alt="Original Page 483">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   در این بخش، من ابتدا design integration glue را توصیف می‌کنم. من در مورد prob-
   blemsهایی که حل می‌کند و گزینه‌های پیاده‌سازی مختلف، صحبت می‌کنم. پس از آن من استراتژی‌های مدیریت تراکنش را توضیح می‌دهم، از جمله استفاده از sagasها. من بحث می‌کنم که چگونه گاهی اوقات requir-
   ment برای حفظ data consistency، ترتیبی که در آن servicesها را استخراج می‌کنید را تغییر می‌دهد.
  </p>
<h3><strong>13.3.3 Handling authentication and authorization</strong></h3>
<p>
   یکی دیگر از مسائل طراحی که شما نیاز دارید که هنگام refactoring یک application monolithic به
   a microservice architecture رسیدگی کنید، تطبیق mechanism security monolith برای پشتیبانی از
   servicesها است. فصل 11 نحوه handle کردن security را در یک microservice architec-
   ture شرح می‌دهد. یک application مبتنی بر microservices از tokensهایی مانند JSON Web tokens (JWT) استفاده می‌کند،
   برای انتقال user identity. این بسیار متفاوت از یک application traditional، mono-
   lithic معمولی است که از session state درون حافظه استفاده می‌کند و user iden-
   tity را با استفاده از یک thread local انتقال می‌دهد. چالش هنگام تبدیل یک application monolithic
   به یک microservice architecture این است که شما نیاز دارید که از هر دو mechanism security مبتنی بر monolith و
   JWT-based به طور همزمان پشتیبانی کنید.
  </p>
<p>
   خوشبختانه، یک راه ساده برای حل این مشکل وجود دارد که فقط به آن نیاز دارد
   شما یک تغییر کوچک را به login request handler monolith اعمال کنید. شکل 13.13
  </p>
<p>
   FTGO Monolith
   <br/>
   Order History Service
   <br/>
   POST/login
   <br/>
   GET/orders
   <br/>
   Authorization: TOKEN
   <br/>
   ...
   <br/>
   HTTP/1.1 200 OK
   <br/>
   Set-cookie: JSESSIONID=...
   <br/>
   Set-cookie: USERINFO=TOKEN
   <br/>
   ...
   <br/>
   GET/orders
   <br/>
   Cookie: JSESSIONID=...
   <br/>
   Cookie: USERINFO=TOKEN
   <br/>
   ...
   <br/>
   Browser-based
   <br/>
   SPA application
   <br/>
   Log in with user
   <br/>
   ID and password.
   <br/>
   User
   <br/>
   database
   <br/>
   API
   <br/>
   gateway
   <br/>
   userId: xxx
   <br/>
   roles:[a, b, c]
   <br/>
   ...
   <br/>
   OrderHistory
   <br/>
   RequestHandler
   <br/>
   Login
   <br/>
   handler
   <br/>
   Initializes
   <br/>
   Query
   <br/>
   POST/login
   <br/>
   Log in with user
   <br/>
   ID and password.
   <br/>
   Return session cookie.
   <br/>
   Provide JWT.
   <br/>
   Provide session cookie.
   <br/>
   Contains user information,
   <br/>
   such as ID and roles
   <br/>
   In-memory
   <br/>
   session
  </p>
<p>
<strong>Figure 13.13</strong>
<br/>
   The login handler is enhanced to set a USERINFO cookie, which is a JWT containing user
   information. API Gateway transfers the USERINFO cookie to an authorization header when it invokes a
   service.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0484_original/original_page.png" alt="Original Page 484">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   در این بخش، ابتدا طراحی integration glue را توصیف می‌کنم. من در مورد prob-
   lemsهایی که حل می‌کند و گزینه‌های پیاده‌سازی مختلف، صحبت می‌کنم. پس از آن من استراتژی‌های management transaction را توضیح می‌دهم، از جمله استفاده از sagasها. من بحث می‌کنم که چگونه گاهی اوقات requir-
   ment برای حفظ data consistency، ترتیبی که در آن servicesها را استخراج می‌کنید را تغییر می‌دهد.
  </p>
<p>
   در آن مثال، LoginHandler، USERINFO cookie را تنظیم می‌کند. API gateway از
   cookie USERINFO به یک header Authorization هنگام فراخوانی a service، منتقل می‌کند.
  </p>
<h3><strong>THE MONOLITH’S LOGINHANDLER SETS THE USERINFO COOKIE</strong></h3>
<p>
   LoginHandler، POST of user’s credentials را پردازش می‌کند. این، user را authentication
   می‌کند و اطلاعاتی در مورد user را در session ذخیره می‌کند. این اغلب توسط یک
   security framework، مانند Spring Security یا Passport for NodeJS پیاده‌سازی می‌شود. اگر applica-
   tion برای استفاده از session in-memory پیش‌فرض configure شده باشد، پاسخ HTTP، یک ses-
   sion cookie را تنظیم می‌کند، مانند JSESSIONID. به order to support the migration to microservices،
   LoginHandler همچنین باید cookie USERINFO را که شامل JWT است که
   user را توصیف می‌کند، تنظیم کند.
  </p>
<h3><strong>THE API GATEWAY MAPS THE USERINFO COOKIE TO THE AUTHORIZATION HEADER</strong></h3>
<p>
   API gateway، همانطور که در فصل 8 توضیح داده شد، مسئول request routing و API
   composition است. این، هر request را با ایجاد یک یا چند requests به monolith
   و servicesها handle می‌کند. هنگامی که API gateway یک service را فراخوانی می‌کند، cookie USERINFO را validate
   می‌کند و آن را در header Authorization request HTTP service منتقل می‌کند. با
   mapping cookie به header Authorization، API gateway تضمین می‌کند که
   user identity را به service به روشی استاندارد منتقل می‌کند که مستقل از نوع
   client است.
  </p>
<p>
   در نهایت، ما به احتمال زیاد login و user management را به servicesها استخراج خواهیم کرد. اما
   همانطور که مشاهده می‌کنید، با ایجاد تنها یک تغییر کوچک در login handler monolith، این
   اکنون برای servicesها امکان‌پذیر است که به اطلاعات user دسترسی داشته باشند. این به شما امکان می‌دهد تا بر devel-
   oping servicesهایی تمرکز کنید که بیشترین ارزش را برای کسب‌وکار فراهم می‌کنند و استخراج less
   valuable servicesها، مانند user management، را به تاخیر می‌اندازید.
  </p>
<p>
   اکنون که ما به نحوه handle کردن security هنگام refactoring به microser-
   vicesها نگاه کردیم، بیایید یک مثال از پیاده‌سازی یک feature جدید به عنوان یک service را ببینیم.
  </p>
<h3><strong>13.4 Implementing a new feature as a service: handling misdelivered orders</strong></h3>
<p>
   بیایید بگوییم که شما موظف شده‌اید که نحوه handle کردن misdelivered ordersها را توسط FTGO بهبود بخشید.
   تعداد فزاینده‌ای از مشتریان در مورد نحوه ser-
   vice handle ordersها که تحویل داده نمی‌شوند، شکایت کرده‌اند. اکثر ordersها در زمان مقرر تحویل داده می‌شوند، اما
   از زمان به زمان ordersها یا دیر تحویل داده می‌شوند یا اصلاً تحویل داده نمی‌شوند. برای مثال،
   the courier توسط ترافیک غیرمنتظره بد، به تاخیر می‌افتد، بنابراین order دریافت شده و
   دیر تحویل داده می‌شود. یا شاید تا زمانی که the courier به رستوران می‌رسد، بسته شده باشد،
   و تحویل انجام نمی‌شود. برای بدتر کردن اوضاع، اولین بار که cus-
   tomer service در مورد misdelivery می‌شنود، زمانی است که آنها یک ایمیل عصبانی از
   یک customer ناراضی دریافت می‌کنند.
  </p>
<p>
   A true story: My missing ice cream
   <br/>
   یک شب شنبه، من احساس تنبلی می‌کردم و با استفاده از یک برنامه تحویل غذا شناخته شده، یک order
   برای تحویل ice cream از Smitten ثبت کردم. هرگز نشان داده نشد. تنها
   ارتباط از شرکت، یک ایمیل در صبح روز بعد بود که می‌گفت order من
   لغو شده است. من همچنین یک پیام صوتی از یک عامل service بسیار گیج
   دریافت کردم که به وضوح نمی‌دانست در مورد چه چیزی تماس می‌گیرد. شاید تماس
   توسط یکی از توییت‌های من که آنچه را که اتفاق افتاده بود، توصیف می‌کرد، درخواست شده باشد. به وضوح، شرکت تحویل
   هیچ مکانیزمی برای handling مناسب اشتباهات اجتناب‌ناپذیر ایجاد نکرده بود.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0485_original/original_page.png" alt="Original Page 485">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   علت اصلی بسیاری از این مشکلات تحویل، الگوریتم زمان‌بندی تحویل ابتدایی است
   که توسط application FTGO استفاده می‌شود. یک زمان‌بند sophisticatedتر در حال
   توسعه است، اما برای چند ماه به پایان نخواهد رسید. راه‌حل موقت این است که
   FTGO، به طور فعال سفارشات با تاخیر یا لغو شده را با عذرخواهی از cus-
   tomer، و در برخی موارد ارائه compensation قبل از اینکه customer شکایت کند، handle کند.
  </p>
<p>
   وظیفه شما این است که یک feature جدید را پیاده‌سازی کنید که موارد زیر را انجام می‌دهد:
   <ol>
<li>
     Notify the customer when their order won’t be delivered on time.
    </li>
<li>
     Notify the customer when their order can’t be delivered because it can’t be
     picked up before the restaurant closes.
    </li>
<li>
     Notify customer service when an order can’t be delivered on time so that they
     can proactively rectify the situation by compensating the customer.
    </li>
<li>
     Track delivery statistics.
    </li>
</ol>
</p>
<p>
   این feature جدید، نسبتاً ساده است. کد جدید باید state of هر Order را ردیابی کند، و
   اگر یک Order نتواند طبق وعده تحویل داده شود، کد باید به customer و cus-
   tomer support، مثلاً با ارسال یک ایمیل، اطلاع دهد.
  </p>
<p>
   اما چگونه—یا شاید دقیق‌تر، کجا—شما باید این feature جدید را پیاده‌سازی کنید؟
   یک رویکرد، پیاده‌سازی یک module جدید در monolith است. مشکل
   در آنجا این است که توسعه و تست این کد دشوار خواهد بود. علاوه بر این، این
   رویکرد، اندازه monolith را افزایش می‌دهد و در نتیجه monolith hell را حتی
   بدتر می‌کند. قانون Holes را از قبل به یاد داشته باشید: وقتی در یک سوراخ هستید، بهتر است
   از کندن دست بکشید. به جای بزرگ‌تر کردن monolith، یک رویکرد بسیار بهتر، imple-
   ment این features جدید به عنوان یک service است.
  </p>
<h3><strong>13.4.1 The design of Delayed Delivery Service</strong></h3>
<p>
   ما این feature را به عنوان یک service به نام Delayed Order Service پیاده‌سازی خواهیم کرد. شکل 13.14
   معماری application FTGO را پس از پیاده‌سازی این service نشان می‌دهد. the appli-
   cation شامل FTGO monolith، service جدید Delayed Delivery و یک
   API Gateway است. Delayed Delivery Service دارای یک API است که یک query opera-
   tion واحد به نام getDelayedOrders() را تعریف می‌کند، که سفارشات در حال حاضر با تاخیر یا غیرقابل تحویل را برمی‌گرداند. API Gateway، request getDelayedOrders() را به service route می‌کند و همه
   requestsهای دیگر را به monolith. The integration glue، به Delayed Order Service دسترسی به data monolith را می‌دهد.
  </p>
<p>
   domain model Delayed Order Service شامل entitiesهای مختلفی از جمله
   DelayedOrderNotification, Order و Restaurant است. the core logic توسط
   کلاس DelayedOrderService پیاده‌سازی می‌شود. این به طور دوره‌ای توسط یک timer فراخوانی می‌شود تا سفارشاتی را پیدا کند
   که به موقع تحویل داده نمی‌شوند. این کار را با querying Orders و Restaurants انجام می‌دهد. اگر
   یک Order نتواند به موقع تحویل داده شود، DelayedOrderService به consumer و
   customer service اطلاع می‌دهد.
  </p>
<p>
   Delayed Order Service متعلق به entityهای Order و Restaurant نیست. در عوض،
   این data از FTGO monolith، replicated شده است. علاوه بر این، service
   اطلاعات تماس customer را ذخیره نمی‌کند، بلکه آن را از monolith بازیابی می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0486_original/original_page.png" alt="Original Page 486">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   بیایید به طراحی integration glue نگاهی بیندازیم که به Delayed Order Service دسترسی می‌دهد
   به data monolith.
  </p>
<h3><strong>13.4.2 Designing the integration glue for Delayed Delivery Service</strong></h3>
<p>
   حتی اگر یک service که یک feature جدید را پیاده‌سازی می‌کند، classesهای entity خود را تعریف کند، این
   معمولاً به data که متعلق به monolith است، دسترسی دارد. Delayed Delivery Service نیز اینطور است
   استثنایی ندارد. این یک entity DelayedOrderNotification دارد، که نشان‌دهنده یک notification است
   که به consumer ارسال کرده است. اما همانطور که اشاره کردم، entityهای Order و Restaurant آن، data را از FTGO monolith تکرار می‌کنند. این
   همچنین نیاز دارد که اطلاعات تماس user را برای اطلاع دادن به user، query کند. در نتیجه، ما نیاز داریم
   integration glue را پیاده‌سازی کنیم که Delivery Service را قادر می‌سازد تا به data monolith دسترسی داشته باشد.
  </p>
<p>
   شکل 13.15، طراحی integration glue را نشان می‌دهد. FTGO monolith،
   domain eventsهای Order و Restaurant را منتشر می‌کند. Delivery Service این eventsها را مصرف می‌کند
   و replicasهای آن entitiesها را آپدیت می‌کند. FTGO monolith، یک REST
  </p>
<p>
   Monolith
   <br/>
   ???
   <br/>
   API gateway
   <br/>
   REST
   <br/>
   API
   <br/>
   Integration
   <br/>
   glue
   <br/>
   Delayed
   <br/>
   Order
   <br/>
   Service
   <br/>
   GetDelayedOrders()
   <br/>
   REST
   <br/>
   API
   <br/>
   Notiﬁcation
   <br/>
   Service
   <br/>
   CRM system
   <br/>
   Create case.
   <br/>
   Send apology
   <br/>
   notiﬁcation.
   <br/>
   Need to design.
   <br/>
   ???
   <br/>
   «Service»
   <br/>
   DelayedDelivery
   <br/>
   Service
   <br/>
   «stereotype»
   <br/>
   Order
   <br/>
   «entity»
   <br/>
   Notiﬁcation
   <br/>
   «entity»
   <br/>
   Restaurant
   <br/>
   «repository»
   <br/>
   Customer
   <br/>
   ContactInfo
   <br/>
   Repository
   <br/>
   «entity»
   <br/>
   OpeningHours
  </p>
<p>
<strong>Figure 13.14</strong>
<br/>
   The design of Delayed Delivery Service. The integration glue provides Delayed Delivery
   Service access to data owned by the monolith, such as the Order and Restaurant entities, and the customer
   contact information.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0487_original/original_page.png" alt="Original Page 487">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   endpoint برای querying اطلاعات تماس مشتری. Delivery Service این را فراخوانی می‌کند
   endpoint زمانی که نیاز دارد به یک user اطلاع دهد که سفارش آنها به موقع تحویل داده نمی‌شود.
  </p>
<p>
   بیایید به طراحی هر بخش از integration، با شروع از REST API برای
   بازیابی اطلاعات تماس مشتری، نگاهی بیندازیم.
  </p>
<h3><strong>QUERYING CUSTOMER CONTACT INFORMATION USING CUSTOMERCONTACTINFOREPOSITORY</strong></h3>
<p>
   همانطور که در بخش 13.3.1 توضیح داده شد، چند روش مختلف وجود دارد که یک service، مانند
   Delayed Delivery Service می‌تواند data monolith را بخواند. ساده‌ترین گزینه این است که
   Delayed Order Service data را با استفاده از query API monolith بازیابی کند. این
   رویکرد، هنگام بازیابی اطلاعات تماس User، منطقی است. آنجا نیست
   هیچ مسئله latency یا performance، وجود دارد زیرا Delayed Delivery Service به ندرت نیاز دارد که
   اطلاعات تماس یک user را بازیابی کند، و میزان data کاملاً کوچک است.
  </p>
<p>
   CustomerContactInfoRepository یک interface است که Delayed Delivery را فعال می‌کند
   Service برای بازیابی contact info یک consumer. این توسط یک Customer-
   ContactInfoProxy پیاده‌سازی شده است، که با فراخوانی monolith’s، اطلاعات user را بازیابی می‌کند
   getCustomerContactInfo() REST endpoint.
  </p>
<h3><strong>PUBLISHING AND CONSUMING ORDER AND RESTAURANT DOMAIN EVENTS</strong></h3>
<p>
   متاسفانه، برای Delayed Delivery Service عملی نیست که monolith را برای
   state of همه Ordersهای باز و ساعات کار رستوران query کند. این به این دلیل است که ineffi-
   cient است که مکرراً مقدار زیادی data را از طریق شبکه منتقل کنید. در نتیجه،
   Delayed Delivery Service باید از گزینه دوم و پیچیده‌تر استفاده کند و a main-
   tain یک replica از Orders و Restaurants با subscribing به eventsهایی که توسط
   monolith منتشر می‌شوند. مهم است به یاد داشته باشید که replica یک کپی کامل از
   data از monolith نیست—فقط یک زیرمجموعه کوچک از attributesهای Order و
   Restaurant entities را ذخیره می‌کند.
  </p>
<p>
   Monolith
   <br/>
   Event
   <br/>
   subscriber
   <br/>
   Delayed Order Service
   <br/>
   Domain
   <br/>
   event
   <br/>
   publisher
   <br/>
   REST
   <br/>
   endpoint
   <br/>
   Customer
   <br/>
   ContactInfo
   <br/>
   Proxy
   <br/>
   &lt;Repository&gt;
   <br/>
   Customer
   <br/>
   ContactInfo
   <br/>
   Repository
   <br/>
   Restaurant events
   <br/>
   getCustomerContactInfo()
   <br/>
   Order events
   <br/>
   Restaurant
   <br/>
   events
   <br/>
   Order
   <br/>
   events
  </p>
<p>
<strong>Figure 13.15</strong>
<br/>
   The integration glue provides Delayed Delivery Service with access to the data owned by
   the monolith.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0488_original/original_page.png" alt="Original Page 488">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   همانطور که قبلاً در بخش 13.3.1 توضیح داده شد، چند روش مختلف وجود دارد که ما
   می‌توانیم monolith FTGO را تغییر دهیم تا domain eventsهای Order و Restaurant را publish کند.
   یک گزینه این است که تمام مکان‌هایی را در monolith که Ordersها و
   Restaurantsها را آپدیت می‌کنند، اصلاح کنیم تا domain eventsهای سطح بالا را publish کنند. گزینه دوم،
   tail کردن transaction logها برای تکرار تغییرات به عنوان eventsها است. در این سناریوی خاص، ما نیاز داریم
   دو database را همزمان کنیم. ما نیازی نداریم که monolith FTGO،
   domain eventsهای سطح بالا را منتشر کند، بنابراین هر دو رویکرد خوب هستند.
  </p>
<p>
   Delayed Order Service، event handlersهایی را پیاده‌سازی می‌کند که به eventsها از
   monolith subscribe کرده و entitiesهای Order و Restaurant آن را آپدیت می‌کند. جزئیات event
   handlersها به این بستگی دارد که آیا monolith، eventsهای سطح بالای خاصی را منتشر می‌کند یا low-
   level change eventsها را منتشر می‌کند. در هر صورت، شما می‌توانید به یک event handler به عنوان ترجمه یک
   event در bounded context monolith به آپدیت یک entity در service’s
   bounded context فکر کنید.
  </p>
<p>
   یک مزیت مهم از استفاده از یک replica، این است که Delayed Order Service را فعال می‌کند
   تا به طور کارآمد سفارشات و ساعات کار رستوران را query کند. یک نقطه ضعف،
   با این حال، این است که پیچیده‌تر است. نقطه ضعف دیگر این است که نیاز دارد که mono-
   lith برای publish کردن eventsهای Order و Restaurant لازم. خوشبختانه، زیرا
   Delayed Delivery Service فقط به آنچه که اساساً یک زیرمجموعه از columnsهای
   جداول ORDERS و RESTAURANT نیاز دارد، ما نباید با problemsهایی که در
   بخش 13.3.1 توضیح داده شد، مواجه شویم.
  </p>
<p>
   پیاده‌سازی یک feature جدید مانند delayed order management به عنوان یک standalone
   service، توسعه، تست و deployment آن را تسریع می‌کند. علاوه بر این، این
   شما را قادر می‌سازد تا feature را با استفاده از یک technology stack کاملاً جدید به جای
   technology stack قدیمی monolith، پیاده‌سازی کنید. همچنین از رشد monolith جلوگیری می‌کند. Delayed order man-
   agement، تنها یکی از بسیاری از featuresهای جدیدی است که برای application FTGO برنامه‌ریزی شده است. the
   تیم FTGO می‌تواند بسیاری از این featuresها را به عنوان servicesهای جداگانه پیاده‌سازی کند.
  </p>
<p>
   متاسفانه، شما نمی‌توانید تمام تغییرات را به عنوان servicesهای جدید پیاده‌سازی کنید. اغلب شما
   باید تغییرات گسترده‌ای را در monolith برای پیاده‌سازی featuresهای جدید یا تغییر
   featuresهای موجود ایجاد کنید. هر توسعه‌ای که شامل monolith باشد، به احتمال زیاد کند
   و دردناک خواهد بود. اگر شما می‌خواهید تحویل این featuresها را سرعت ببخشید، شما باید
   monolith را با مهاجرت functionality از monolith به servicesها، جدا کنید. بیایید نگاهی بیندازیم به
   نحوه انجام این کار.
  </p>
<h3><strong>13.5 Breaking apart the monolith: extracting delivery management</strong></h3>
<p>
   برای تسریع تحویل featuresهایی که توسط یک monolith پیاده‌سازی شده‌اند، شما نیاز دارید که
   monolith را به servicesها تقسیم کنید. به عنوان مثال، بیایید تصور کنیم که شما می‌خواهید
   delivery management FTGO را با پیاده‌سازی یک الگوریتم مسیریابی جدید، بهبود بخشید. آ
   مانع اصلی برای توسعه delivery management این است که با order درهم آمیخته است
   management و بخشی از code base monolithic است. توسعه، تست و deploy-
   ing delivery management احتمالاً کند خواهد بود. به منظور تسریع توسعه آن،
   شما نیاز دارید که delivery management را به یک Delivery Service استخراج کنید.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0489_original/original_page.png" alt="Original Page 489">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   من این بخش را با توصیف delivery management و نحوه قرارگیری فعلی آن آغاز می‌کنم
   embedded درون monolith. در مرحله بعد، طراحی جدید و مستقل را مورد بحث قرار می‌دهم
   Delivery Service و API آن. سپس نحوه همکاری Delivery Service و FTGO را شرح می‌دهم
   monolith. در نهایت، من در مورد برخی از تغییراتی که ما نیاز داریم برای ایجاد
   monolith برای پشتیبانی از Delivery Service.
  </p>
<p>
   اجازه دهید با بررسی طراحی موجود شروع کنیم.
  </p>
<h3><strong>13.5.1 Overview of existing delivery management functionality</strong></h3>
<p>
   Delivery management مسئول زمان‌بندی couriersها است که ordersها را در
   restaurantsها برمی‌دارند و آنها را به مصرف‌کنندگان تحویل می‌دهند. هر courier دارای یک plan است که یک schedule
   از actionsهای pickup و deliver است. یک pickup action به Courier می‌گوید که یک order را
   از یک رستوران در یک زمان خاص بردارد. یک deliver action به Courier می‌گوید که یک
   order را به یک consumer تحویل دهد. plansها هر زمان که ordersها ثبت، لغو یا
   بازبینی می‌شوند، و با تغییر مکان و در دسترس بودن couriersها، بازبینی می‌شوند.
  </p>
<p>
   Delivery management یکی از قدیمی‌ترین بخش‌های application FTGO است. همانطور که fig-
   ure 13.16 نشان می‌دهد، در order management، embedded است. بخش زیادی از کد برای man-
   aging deliveriesها در OrderService است. علاوه بر این، هیچ representation صریحی از
   Delivery وجود ندارد. این در entity Order، که دارای fieldsهای مختلف مربوط به delivery است،
   مانند scheduledPickupTime و scheduledDeliveryTime.
  </p>
<p>
   Commandsهای متعددی که توسط monolith پیاده‌سازی شده‌اند، delivery manage-
   ment، از جمله موارد زیر را فراخوانی می‌کنند:
   <ul>
<li>
     
     acceptOrder()—هنگامی فراخوانی می‌شود که یک رستوران یک order را می‌پذیرد و
     متعهد می‌شود که آن را تا یک زمان مشخص آماده کند. این operation، delivery management را فراخوانی می‌کند تا a
     delivery را زمان‌بندی کند.
    </li>
<li>
     
     cancelOrder()—هنگامی فراخوانی می‌شود که یک consumer، یک order را لغو می‌کند. در صورت لزوم، it
     delivery را لغو می‌کند.
    </li>
<li>
     
     noteCourierLocationUpdated()—توسط application موبایل courier فراخوانی می‌شود
     برای آپدیت کردن location courier. این، rescheduling deliveriesها را trigger می‌کند.
    </li>
<li>
     
     noteCourierAvailabilityChanged()—توسط application موبایل courier فراخوانی می‌شود-
     tion برای آپدیت کردن availability courier. این، rescheduling deliveriesها را trigger می‌کند.
    </li>
</ul>
   همچنین، queriesهای مختلف، data که توسط delivery management نگهداری می‌شود، از جمله
   زیر را بازیابی می‌کنند:
   <ul>
<li>
     
     getCourierPlan()—توسط application موبایل courier فراخوانی شده و
     plan courier را برمی‌گرداند
    </li>
<li>
     
     getOrderStatus()—status of order را برمی‌گرداند، که شامل delivery-related
     اطلاعاتی مانند courier اختصاص داده شده و ETA
    </li>
<li>
     
     getOrderHistory()—اطلاعات مشابه getOrderStatus() را برمی‌گرداند به جز
     در مورد multiple orders
    </li>
</ul>
</p>
<p>
   اغلب آنچه که به یک service استخراج می‌شود، همانطور که در بخش 13.2.3 ذکر شد، یک کل است
   vertical slice، با controllersها در بالا و جداول database در پایین. ما می‌توانیم
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0490_original/original_page.png" alt="Original Page 490">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   endpoint برای querying اطلاعات تماس مشتری. Delivery Service این را فراخوانی می‌کند
   endpoint زمانی که نیاز دارد به یک user اطلاع دهد که سفارش آنها به موقع تحویل داده نمی‌شود.
  </p>
<p>
   در این بخش، من ابتدا design integration glue را توصیف می‌کنم. من در مورد prob-
   blemsهایی که حل می‌کند و گزینه‌های پیاده‌سازی مختلف، صحبت می‌کنم. پس از آن من استراتژی‌های مدیریت تراکنش را توضیح می‌دهم، از جمله استفاده از sagasها. من بحث می‌کنم که چگونه گاهی اوقات requir-
   ment برای حفظ data consistency، ترتیبی که در آن servicesها را استخراج می‌کنید را تغییر می‌دهد.
  </p>
<p>
   در آن مثال، LoginHandler، USERINFO cookie را تنظیم می‌کند. API gateway از
   cookie USERINFO به یک header Authorization هنگام فراخوانی a service، منتقل می‌کند.
  </p>
<h3><strong>PUBLISHING AND CONSUMING ORDER AND RESTAURANT DOMAIN EVENTS</strong></h3>
<p>
   متاسفانه، برای Delayed Delivery Service عملی نیست که monolith را برای
   state of همه Ordersهای باز و ساعات کار رستوران query کند. این به این دلیل است که ineffi-
   cient است که مکرراً مقدار زیادی data را از طریق شبکه منتقل کنید. در نتیجه،
   Delayed Delivery Service باید از گزینه دوم و پیچیده‌تر استفاده کند و a main-
   tain یک replica از Orders و Restaurants با subscribing به eventsهایی که توسط
   monolith منتشر می‌شوند. مهم است به یاد داشته باشید که replica یک کپی کامل از
   data از monolith نیست—فقط یک زیرمجموعه کوچک از attributesهای Order و
   Restaurant entities را ذخیره می‌کند.
  </p>
<p>
   Monolith
   <br/>
   Event
   <br/>
   subscriber
   <br/>
   Delayed Order Service
   <br/>
   Domain
   <br/>
   event
   <br/>
   publisher
   <br/>
   REST
   <br/>
   endpoint
   <br/>
   Customer
   <br/>
   ContactInfo
   <br/>
   Proxy
   <br/>
   &lt;Repository&gt;
   <br/>
   Customer
   <br/>
   ContactInfo
   <br/>
   Repository
   <br/>
   Ubiquitous language of service
   <br/>
   Ubiquitous language of monolith
   <br/>
   Anti-corruption layer
   <br/>
   Event channel
   <br/>
   Order
   <br/>
   event
   <br/>
   Event
   <br/>
   publisher
  </p>
<p>
<strong>Figure 13.12</strong>
<br/>
   The integration glue provides Delayed Delivery Service with access to the data owned by
   the monolith.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0491_original/original_page.png" alt="Original Page 491">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   به عنوان مثال، در بخش 13.3.1، ما فرض کردیم که به منظور
   انتخاب entityهای Order و Restaurant، به دلیل مشکلاتی که قبلاً توضیح داده شد،
   به جای درخواست مستقیم از monolith، از یک replica از entitiesها استفاده می‌کنیم.
  </p>
<h3><strong>13.5.2 Overview of Delivery Service</strong></h3>
<p>
   service جدید پیشنهادی Delivery Service مسئول زمان‌بندی، rescheduling و
   لغو deliveriesها است. شکل 13.17 یک نمای سطح بالا از معماری application
   FTGO را پس از استخراج Delivery Service نشان می‌دهد. معماری شامل
   monolith FTGO و Delivery Service است. آنها با استفاده از integration
   glue همکاری می‌کنند، که شامل APIsها در هر دوی آنها می‌شود. Delivery Service دارد
   domain model و database خود را دارد.
  </p>
<p>
   به منظور fleshing out این معماری و تعیین domain model service، ما
   نیاز داریم به سوالات زیر پاسخ دهیم:
   <ul>
<li>
     کدام behavior و data به Delivery Service منتقل می‌شوند؟
    </li>
<li>
     چه APIای را Delivery Service به monolith ارائه می‌کند؟
    </li>
<li>
     چه APIای را monolith به Delivery Service ارائه می‌کند؟
    </li>
</ul>
</p>
<p>
   این مسائل به هم مرتبط هستند، زیرا توزیع responsibilities بین
   monolith و service، بر APIsها تأثیر می‌گذارد. به عنوان مثال، Delivery Service نیاز خواهد داشت
   فراخوانی یک API ارائه شده توسط monolith برای دسترسی به data در data-
   base monolith و بالعکس. بعداً، من طراحی integration glue را توصیف می‌کنم که فعال می‌کند
  </p>
<p>
   Monolith
   <br/>
   domain model
   <br/>
   Integration glue
   <br/>
   What API does the Delivery Service
   <br/>
   expose to the monolith?
   <br/>
   Delivery Service
   <br/>
   domain model
   <br/>
   FTGO Monolith
   <br/>
   Delivery Service
   <br/>
   Delivery
   <br/>
   Service
   <br/>
   database
   <br/>
   Monolith
   <br/>
   database
   <br/>
   Adapter
   <br/>
   Adapter
   <br/>
   What API does the monolith
   <br/>
   expose to the Delivery Service?
   <br/>
   Which behavior and
   <br/>
   data is moved to the
   <br/>
   Delivery Service?
  </p>
<p>
<strong>Figure 13.17</strong>
<br/>
   The high-level view of the FTGO application after extracting Delivery Service. The FTGO
   monolith and Delivery Service collaborate using the integration glue, which consists of APIs in each of them.
   The two key decisions that need to be made are which functionality and data are moved to Delivery Service
   and how do the monolith and Delivery Service collaborate via APIs?
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0492_original/original_page.png" alt="Original Page 492">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   to collaborate. But first, let’s look at the
   design of Delivery Service’s domain model.
  </p>
<h3><strong>13.5.3 Designing the Delivery Service domain model</strong></h3>
<p>
   برای اینکه بتوانیم delivery management را استخراج کنیم، ابتدا باید classesهایی را شناسایی کنیم که
   آن را پیاده‌سازی می‌کنند. پس از انجام این کار، ما می‌توانیم تصمیم بگیریم که کدام classesها را به Delivery
   Service منتقل کنیم تا domain logic آن را تشکیل دهیم. در برخی موارد، ما نیاز خواهیم داشت که
   classesها را split کنیم. ما همچنین نیاز داریم که تصمیم بگیریم که چه dataای را بین service و monolith تکرار کنیم.
  </p>
<p>
   بیایید با شناسایی classesهایی که delivery management را پیاده‌سازی می‌کنند، شروع کنیم.
  </p>
<h3><strong>IDENTIFYING WHICH ENTITIES AND THEIR FIELDS ARE PART OF DELIVERY MANAGEMENT</strong></h3>
<p>
   اولین گام در فرآیند طراحی Delivery Service، بررسی دقیق کد delivery management و
   شناسایی entitiesها و fieldsهای شرکت‌کننده است. Fig-
   ure 13.18، entitiesها و fieldsهایی را نشان می‌دهد که بخشی از delivery management هستند. برخی از
   fieldsها، ورودی‌های الگوریتم delivery-scheduling هستند، و برخی دیگر خروجی‌ها هستند. the
   شکل نشان می‌دهد که کدام یک از آن fieldsها، توسط functionalityهای دیگری که توسط
   monolith پیاده‌سازی شده‌اند، نیز استفاده می‌شوند.
  </p>
<p>
   الگوریتم delivery scheduling، attributesهای مختلفی از جمله Order’s
   restaurant، promisedDeliveryTime، و deliveryAddress و location Courier،
   availability و current plans را می‌خواند. این، plans Courierها را آپدیت می‌کند،
   scheduledPickupTime Order’s، و scheduledDeliveryTime. همانطور که مشاهده می‌کنید، fieldsهایی که توسط delivery
   management استفاده می‌شوند، توسط monolith نیز استفاده می‌شوند.
  </p>
<p>
   Order
   <br/>
   «Monolith Read/Write»
   <br/>
   «Service Read»
   <br/>
   state
   <br/>
   deliveryAddress
   <br/>
   promisedDeliveryTime
   <br/>
   preparedByTime
   <br/>
   «Service Read/Write»
   <br/>
   «Monolith Read»
   <br/>
   scheduledPickupTime
   <br/>
   scheduledDeliveryTime
   <br/>
   Restaurant
   <br/>
   «Read»
   <br/>
   address
   <br/>
   Courier
   <br/>
   «Monolith Read/Write»
   <br/>
   «Service Read»
   <br/>
   Location
   <br/>
   availability
   <br/>
   «Service Read/Write»
   <br/>
   «Monolith Read»
   <br/>
   Plan
   <br/>
   Task
  </p>
<p>
<strong>Figure 13.18</strong>
<br/>
   The entities and fields that are accessed by delivery management
   <br/>
   and other functionality implemented by the monolith. A field can be read or written
   or both. It can be accessed by delivery management, the monolith, or both.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0493_original/original_page.png" alt="Original Page 493">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<h3><strong>DECIDING WHICH DATA TO MIGRATE TO DELIVERY SERVICE</strong></h3>
<p>
   اکنون که ما entitiesها و fieldsهایی را شناسایی کردیم که در delivery manage-
   ment شرکت دارند، گام بعدی این است که تصمیم بگیریم کدام یک از آنها را باید به service منتقل کنیم. در یک
   سناریوی ایده‌آل، dataای که توسط service دسترسی دارد، منحصراً توسط service استفاده می‌شود، بنابراین ما
   می‌توانیم به سادگی آن data را به service منتقل کرده و کار را تمام کنیم. متاسفانه، این به ندرت ساده است،
   و این وضعیت نیز از این قاعده مستثنی نیست. تمام entitiesها و fieldsهایی که توسط delivery man-
   agement استفاده می‌شوند، همچنین توسط functionalityهای دیگری که توسط monolith پیاده‌سازی شده‌اند، استفاده می‌شوند.
  </p>
<p>
   در نتیجه، هنگام تعیین اینکه چه dataای را به service منتقل کنیم، ما نیاز داریم که دو مسئله را در نظر داشته باشیم.
   اولین مورد این است: چگونه service به dataای دسترسی دارد که در
   monolith باقی می‌ماند؟ دومی این است: چگونه monolith به dataای دسترسی دارد که به
   service منتقل شده است؟ همچنین، همانطور که قبلاً در بخش 13.3 توضیح داده شد، ما نیاز داریم که با دقت
   در نظر بگیریم که چگونه data consistency را بین service و monolith حفظ کنیم.
  </p>
<p>
   مسئولیت اساسی Delivery Service، مدیریت courier plansها و
   آپدیت کردن fieldsهای scheduledPickupTime Order’s و scheduledDeliveryTime است. این
   بنابراین، منطقی است که آن fieldsها را داشته باشد. ما همچنین می‌توانیم Cou-
   rier.location و Courier.availability fieldsها را به Delivery Service منتقل کنیم. اما چون
   ما در تلاش هستیم که کوچک‌ترین تغییر ممکن را ایجاد کنیم، ما این fieldsها را در mono-
   lith برای حالا رها می‌کنیم.
  </p>
<h3><strong>THE DESIGN OF THE DELIVERY SERVICE DOMAIN LOGIC</strong></h3>
<p>
   شکل 13.19، طراحی domain model Delivery Service را نشان می‌دهد. هسته
   service شامل domain classesهایی مانند Delivery و Courier است. the Delivery-
   ServiceImpl class، نقطه ورود به business logic delivery management است. این،
   interfacesهای DeliveryService و CourierService را پیاده‌سازی می‌کند، که توسط
   DeliveryServiceEventsHandler و DeliveryServiceNotificationsHandlers،
   که بعداً در این بخش توضیح داده شده‌اند، فراخوانی می‌شوند.
  </p>
<p>
   The delivery management business logic، عمدتاً کدی است که از monolith کپی شده است.
   <br/>
   به عنوان مثال، ما Order entity را از monolith به Delivery Service کپی می‌کنیم،
   آن را به Delivery تغییر نام می‌دهیم، و تمام fieldsها را به جز مواردی که توسط delivery manage-
   ment استفاده می‌شوند، حذف می‌کنیم. ما همچنین entity Courier را کپی کرده و اکثر fieldsهای آن را حذف می‌کنیم. به منظور
   توسعه domain logic برای Delivery Service، ما نیاز خواهیم داشت که کد را از
   monolith جدا کنیم. ما نیاز خواهیم داشت که وابستگی‌های متعددی را بشکنیم، که احتمالاً
   وقت‌گیر است. یک بار دیگر، refactor کردن کد با استفاده از یک زبان statically
   typed، بسیار آسان‌تر است، زیرا compiler، دوست شما خواهد بود.
  </p>
<p>
   Delivery Service یک service مستقل نیست. بیایید به طراحی inte-
   gration glue نگاهی بیندازیم که Delivery Service و FTGO monolith را قادر می‌سازد که با هم همکاری کنند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0494_original/original_page.png" alt="Original Page 494">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<h3><strong>13.5.4 The design of the Delivery Service integration glue</strong></h3>
<p>
   monolith FTGO، نیاز دارد Delivery Service را برای manage deliveriesها فراخوانی کند. the
   monolith همچنین نیاز دارد که data را با Delivery Service تبادل کند. این همکاری،
   توسط integration glue فعال شده است. شکل 13.20، طراحی Delivery Ser-
   vice integration glue را نشان می‌دهد. Delivery Service دارای یک delivery management API است. این نیز
   publish می‌کند domain eventsهای Delivery و Courier. FTGO monolith،
   domain eventsهای Courier را منتشر می‌کند.
  </p>
<p>
   بیایید به طراحی هر بخش از integration glue نگاهی بیندازیم، با Delivery شروع می‌کنیم
   API service برای managing deliveriesها.
  </p>
<h3><strong>THE DESIGN OF THE DELIVERY SERVICE API</strong></h3>
<p>
   Delivery Service باید یک API ارائه دهد که monolith را قادر می‌سازد تا schedule، revise،
   و cancel deliveriesها را انجام دهد. همانطور که در این کتاب دیده‌اید، رویکرد ترجیحی این است که
   از asynchronous messaging استفاده کنید، زیرا این، coupling شل را ترویج می‌دهد و
   قابلیت دسترسی را افزایش می‌دهد. یک رویکرد این است که Delivery Service، به Order domain
   eventsها که توسط monolith منتشر می‌شوند، subscribe کند. بسته به نوع event، این ایجاد می‌کند،
  </p>
<p>
   Delivery Service
   <br/>
   DeliveryServiceImpl
   <br/>
   &lt;interface&gt;
   <br/>
   DeliveryService
   <br/>
   void schedule(...)
   <br/>
   void reschedule(...)
   <br/>
   void cancel(...)
   <br/>
   &lt;interface&gt;
   <br/>
   CourierService
   <br/>
   noteCourierLocationUpdated(...)
   <br/>
   noteCourierAvailabilityUpdated(...)
   <br/>
   &lt;entity&gt;
   <br/>
   Courier
   <br/>
   &lt;entity&gt;
   <br/>
   Delivery
   <br/>
   &lt;value object&gt;
   <br/>
   Plan
   <br/>
   DeliveryService
   <br/>
   EventsHandlers
   <br/>
   DeliveryService
   <br/>
   NotiﬁcationHandlers
  </p>
<p>
<strong>Figure 13.19</strong>
<br/>
   The design of the Delivery Service's domain model
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0495_original/original_page.png" alt="Original Page 495">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   revises و cancels یک Delivery. یک مزیت این رویکرد این است که monolith، نیازی به
   فراخوانی صریح Delivery Service ندارد. نقطه ضعف تکیه بر domain eventsها این است که
   نیازمند آن است که Delivery Service بداند که چگونه هر event Order بر corre-
   sponding Delivery تأثیر می‌گذارد.
  </p>
<p>
   یک رویکرد بهتر این است که Delivery Service یک API مبتنی بر notification را پیاده‌سازی کند
   که monolith را قادر می‌سازد تا صریحاً به Delivery Service بگوید که deliveriesها را ایجاد، revise و
   cancel کند. API Delivery Service شامل یک کانال notification message و سه نوع message است:
   ScheduleDelivery, ReviseDelivery یا CancelDelivery. A
   notification message حاوی اطلاعات Order است که توسط Delivery Service مورد نیاز است. برای
   به عنوان مثال، یک notification ScheduleDelivery شامل زمان و مکان pickup و
   زمان و مکان delivery است. یک مزیت مهم این رویکرد این است که Delivery
   Service دانش دقیقی از چرخه حیات Order ندارد. این کاملاً متمرکز است
   بر managing deliveriesها و هیچ اطلاعی از ordersها ندارد.
  </p>
<p>
   این API، تنها راه همکاری Delivery Service و FTGO monolith نیست.
   آنها همچنین نیاز به تبادل data دارند.
  </p>
<h3><strong>HOW THE DELIVERY SERVICE ACCESSES THE FTGO MONOLITH’S DATA</strong></h3>
<p>
   Delivery Service نیاز دارد به data location Courier و availability، که
   متعلق به monolith است، دسترسی داشته باشد. از آنجایی که این به طور بالقوه میزان زیادی از data است، این کار عملی نیست-
   cal برای service برای query کردن مکرر monolith. در عوض، یک رویکرد بهتر این است که
   monolith، data را به Delivery Service با publish کردن domain eventsهای Courier،
   CourierLocationUpdated و CourierAvailabilityUpdated، تکرار کند. Delivery Service
   دارای یک CourierEventSubscriber است که به domain eventsها subscribe کرده و
   version از Courier را آپدیت می‌کند. همچنین ممکن است rescheduling deliveriesها را trigger کند.
  </p>
<p>
   Delivery
   <br/>
   Service
   <br/>
   FTGO
   <br/>
   monolith
   <br/>
   Courier events
   <br/>
   Courier events
   <br/>
   Delivery events
   <br/>
   Delivery Service
   <br/>
   notiﬁcations
   <br/>
   Delivery events
   <br/>
   Courier events
   <br/>
   Courier
   <br/>
   event
   <br/>
   subscriber
   <br/>
   Delivery
   <br/>
   event
   <br/>
   subscriber
   <br/>
   Delivery
   <br/>
   Service
   <br/>
   proxy
   <br/>
   Messaging
   <br/>
   adapter
   <br/>
   Messaging
   <br/>
   adapter
   <br/>
   Delivery
   <br/>
   Service
   <br/>
   notiﬁcations
   <br/>
   handlers
   <br/>
   &lt;interface&gt;
   <br/>
   DeliveryService
   <br/>
   &lt;interface&gt;
   <br/>
   DeliveryService
   <br/>
   &lt;interface&gt;
   <br/>
   CourierService
  </p>
<p>
<strong>Figure 13.20</strong>
<br/>
   The design of the Delivery Service integration glue. Delivery Service has a delivery
   management API. The service and the FTGO monolith synchronize data by exchanging domain events.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0496_original/original_page.png" alt="Original Page 496">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<h3><strong>HOW THE FTGO MONOLITH ACCESSES THE DELIVERY SERVICE DATA</strong></h3>
<p>
   monolith FTGO، نیاز دارد که dataای را که به Delivery Service منتقل شده است، بخواند،
   مانند plansهای Courier. در تئوری، monolith می‌تواند service را query کند، اما این کار
   نیازمند تغییرات گسترده در monolith است. در حال حاضر، آسان‌تر است که
   domain model و database schema monolith بدون تغییر باقی بماند و data را از
   service به monolith، تکرار کنیم.
  </p>
<p>
   آسان‌ترین راه برای انجام این کار این است که Delivery Service domain eventsهای Courier و
   Delivery را منتشر کند. service یک event CourierPlanUpdated را هنگامی که
   plan Courier را آپدیت می‌کند، و یک event DeliveryScheduleUpdate را هنگامی که یک
   Delivery را آپدیت می‌کند، منتشر می‌کند. monolith این domain eventsها را مصرف کرده و database خود را آپدیت می‌کند.
  </p>
<p>
   اکنون که ما به چگونگی تعامل monolith FTGO و Delivery Service نگاه کردیم،
   بیایید نحوه تغییر monolith را ببینیم.
  </p>
<h3><strong>13.5.5 Changing the FTGO monolith to interact with Delivery Service</strong></h3>
<p>
   از بسیاری جهات، پیاده‌سازی Delivery Service، بخش آسان‌تری از استخراج است
   process. تغییر دادن monolith FTGO، بسیار دشوارتر است. خوشبختانه، replicat-
   ing data از service به monolith، اندازه تغییر را کاهش می‌دهد. اما ما
   هنوز هم نیاز داریم که monolith را برای manage deliveriesها با فراخوانی Delivery Service، تغییر دهیم.
  </p>
<p>
   بیایید نگاهی به نحوه انجام این کار بیندازیم.
  </p>
<h3><strong>DEFINING A DELIVERYSERVICE INTERFACE</strong></h3>
<p>
   اولین گام، encapsulated کردن کد delivery management با یک interface Java است
   متناظر با API مبتنی بر messaging که قبلاً تعریف شد. این interface، که در
   شکل 13.21 نشان داده شده است، متدهایی را برای زمان‌بندی، rescheduling و
   لغو deliveriesها تعریف می‌کند.
  </p>
<p>
   &lt;interface&gt;
   <br/>
   DeliveryService
   <br/>
   DeliveryServiceImpl
   <br/>
   void schedule(...)
   <br/>
   void reschedule(...)
   <br/>
   void cancel(...)
   <br/>
   Delivery
   <br/>
   management
   <br/>
   Delivery
   <br/>
   management
   <br/>
   client
  </p>
<p>
<strong>Figure 13.21</strong>
<br/>
   The first step is to define DeliveryService, which
   <br/>
   is a coarse-grained, remotable API for invoking the delivery
   <br/>
   management logic.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0497_original/original_page.png" alt="Original Page 497">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   در نهایت، ما این interface را با یک proxy که messagesها را به
   service delivery ارسال می‌کند، پیاده‌سازی می‌کنیم. اما در ابتدا، ما این API را با یک کلاس پیاده‌سازی می‌کنیم که
   کد delivery management را فراخوانی می‌کند.
  </p>
<p>
   The DeliveryService interface یک interface coarse-grained است که برای
   پیاده‌سازی توسط یک IPC mechanism مناسب است. این، متدهای schedule()، reschedule() و
   cancel() را تعریف می‌کند، که با انواع پیام notification که قبلاً تعریف شد، مطابقت دارد.
  </p>
<h3><strong>REFACTORING THE MONOLITH TO CALL THE DELIVERYSERVICE INTERFACE</strong></h3>
<p>
   در مرحله بعد، همانطور که شکل 13.22 نشان می‌دهد، ما نیاز داریم که تمام مکان‌هایی را در FTGO monolith شناسایی کنیم
   که delivery management را فراخوانی می‌کنند و آنها را تغییر دهیم تا از interface DeliveryService استفاده کنند.
   این ممکن است مدتی طول بکشد و یکی از چالش برانگیزترین جنبه‌های استخراج است
   یک service از monolith.
  </p>
<p>
   مطمئناً کمک می‌کند اگر monolith به زبانی statically typed، مانند Java، نوشته شده باشد،
   زیرا ابزارها کار بهتری در شناسایی dependenciesها انجام می‌دهند. اگر اینطور نباشد، امیدوارم
   شما برخی از تست‌های خودکار را با پوشش کافی از بخش‌هایی از کد دارید که
   نیاز به تغییر دارند.
  </p>
<h3><strong>IMPLEMENTING THE DELIVERYSERVICE INTERFACE</strong></h3>
<p>
   گام نهایی، جایگزینی کلاس DeliveryServiceImpl با یک proxy است که ارسال می‌کند
   پیام‌های notification به Delivery Service مستقل. اما به جای دور انداختن
   implementation موجود بلافاصله، ما از یک design، که در شکل 13.23 نشان داده شده است، استفاده می‌کنیم، که
   monolith را قادر می‌سازد تا به صورت پویا بین implementation موجود و
   Delivery Service، سوئیچ کند. ما interface DeliveryService را با یک کلاس پیاده‌سازی می‌کنیم که
   از یک feature toggle dynamic برای تعیین اینکه آیا implementation موجود را فراخوانی کند یا خیر
   Delivery Service.
  </p>
<p>
   &lt;interface&gt;
   <br/>
   DeliveryService
   <br/>
   DeliveryServiceImpl
   <br/>
   void schedule(...)
   <br/>
   void reschedule(...)
   <br/>
   void cancel(...)
   <br/>
   Delivery
   <br/>
   management
   <br/>
   Delivery
   <br/>
   management
   <br/>
   client
  </p>
<p>
<strong>Figure 13.22</strong>
<br/>
   The second step is to change the FTGO monolith to
   <br/>
   invoke delivery management via the DeliveryService interface.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0498_original/original_page.png" alt="Original Page 498">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   در نهایت، به کمک این روش، ما interface DeliveryService را با یک کلاس proxy پیاده‌سازی می‌کنیم که
   messagesها را به Delivery Service ارسال می‌کند. اما به جای دور انداختن
   implementation موجود، ما از یک design، که در شکل 13.23 نشان داده شده است، استفاده می‌کنیم که
   monolith را قادر می‌سازد تا به صورت پویا بین implementation موجود و
   Delivery Service، سوئیچ کند. ما interface DeliveryService را با یک کلاس پیاده‌سازی می‌کنیم که
   از یک feature toggle dynamic برای تعیین اینکه آیا implementation موجود را فراخوانی کند یا خیر
   Delivery Service.
  </p>
<p>
   این رویکرد، خطر rolling out Delivery Service را به طور قابل توجهی کاهش می‌دهد. ما
   می‌توانیم Delivery Service را deploy و تست کنیم. و سپس، هنگامی که مطمئن شدیم کار می‌کند، می‌توانیم
   toggle را برای هدایت traffic به آن، فعال کنیم. اگر سپس متوجه شدیم که Delivery Service آنطور که انتظار می‌رود کار نمی‌کند، می‌توانیم به پیاده‌سازی قدیمی برگردیم.
  </p>
<p>
   هنگامی که مطمئن شدیم که Delivery Service همانطور که انتظار می‌رود کار می‌کند، می‌توانیم سپس
   کد delivery management را از monolith حذف کنیم.
  </p>
<p>
   Delivery Service و Delayed Order Service، مثال‌هایی از servicesهایی هستند که
   تیم FTGO در طول سفر خود به microservice architecture، توسعه خواهند داد.
   جایی که آنها پس از پیاده‌سازی این servicesها، در مرحله بعد می‌روند، بستگی به اولویت‌های
   کسب‌وکار دارد. یک مسیر احتمالی، استخراج Order History Service است که در chap-
   تر 7 توضیح داده شده است. استخراج این service، تا حدی نیاز به Delivery Service را از بین می‌برد تا
   data را به monolith، تکرار کند.
  </p>
<p>
   About feature toggles
   <br/>
   Feature togglesها، یا feature flagsها، به شما این امکان را می‌دهند که بدون نیاز به
   relasing آنها به کاربران، تغییرات کد را deploy کنید. آنها همچنین شما را قادر می‌سازند تا به صورت پویا رفتار
   application را با deploying کد جدید، تغییر دهید. این مقاله از Martin Fowler یک
   بررسی عالی از این موضوع ارائه می‌دهد: https://martinfowler.com/articles/feature-toggles
   .html.
  </p>
<p>
   &lt;interface&gt;
   <br/>
   DeliveryService
   <br/>
   void schedule(...)
   <br/>
   void reschedule(...)
   <br/>
   void cancel(...)
   <br/>
   FeatureToggleBased
   <br/>
   DeliveryServiceImpl
   <br/>
   DeliveryServiceImpl
   <br/>
   DeliveryServiceProxy
   <br/>
   Delivery
   <br/>
   management
   <br/>
   Invokes
   <br/>
   Invokes
   <br/>
   Sends
   <br/>
   message
   <br/>
   Delivery
   <br/>
   management
   <br/>
   client
   <br/>
   Delivery notiﬁcations
  </p>
<p>
<strong>Figure 13.23</strong>
<br/>
   The final step is to implement DeliveryService with a proxy class that sends
   messages Delivery Service. A feature toggle controls whether the FTGO monolith uses the old
   implementation or the new Delivery Service.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0499_original/original_page.png" alt="Original Page 499">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   بعد از پیاده‌سازی Order History Service، تیم FTGO می‌تواند سپس
   servicesها را به ترتیبی که در بخش 13.3.2 توضیح داده شد، استخراج کند: Order Service, Consumer Service,
   Kitchen Service و غیره. همانطور که تیم FTGO هر service را استخراج می‌کند، maintain-
   ability و testability application آنها به تدریج بهبود می‌یابد، و سرعت توسعه آنها
   افزایش می‌یابد.
  </p>
<h3><strong>Summary</strong></h3>
<ul>
<li>
    
    قبل از migrating به یک microservice architecture، مهم است که مطمئن شوید
    مشکلات تحویل نرم‌افزار شما نتیجه outgrown شدن معماری mono-
    lithic شما است. شما ممکن است بتوانید تحویل را با بهبود
    software development process خود، تسریع کنید.
   </li>
<li>
    
    مهم است که با توسعه افزایشی یک stran-
    gler application به microservicesها مهاجرت کنید. یک strangler application یک application جدید است که شامل
    microservicesهایی است که شما در اطراف application monolithic موجود می‌سازید. شما
    باید value را در اوایل و اغلب نشان دهید تا اطمینان حاصل شود که کسب‌وکار
    از effort migration پشتیبانی می‌کند.
   </li>
<li>
    
    یک راه عالی برای معرفی microservicesها به معماری شما، implement کردن است
    features جدید به عنوان servicesها. انجام این کار به شما امکان می‌دهد تا به سرعت و به راحتی یک
    feature را با استفاده از یک technology و development process مدرن، توسعه دهید. این یک راه خوب است برای
    به سرعت نشان دادن ارزش migrating به microservicesها.
   </li>
<li>
    
    یک راه برای شکستن monolith این است که presentation tier را از
    backend جدا کنید، که منجر به دو monolith کوچک‌تر می‌شود. اگرچه این یک
    بهبود بزرگ نیست، اما به این معنی است که شما می‌توانید هر monolith را به طور مستقل deploy کنید.
    به عنوان مثال، این به تیم UI اجازه می‌دهد تا به راحتی بر روی طراحی UI تکرار شوند
    بدون تأثیر بر backend.
   </li>
<li>
    
    راه اصلی برای شکستن monolith، migrating افزایشی function-
    ality از monolith به servicesها است. مهم است که بر استخراج
    servicesهایی تمرکز کنید که بیشترین benefit را ارائه می‌دهند. به عنوان مثال، شما توسعه را تسریع خواهید کرد
    اگر شما یک service را استخراج کنید که functionalityای را پیاده‌سازی می‌کند که فعالانه در حال
    توسعه است.
   </li>
<li>
    
    servicesهای newly developed تقریباً همیشه باید با monolith تعامل داشته باشند. A
    service اغلب نیاز دارد که به data monolith دسترسی داشته باشد و functionality آن را فراخوانی کند. The
    monolith گاهی اوقات نیاز دارد که به data یک service دسترسی داشته باشد و functionality آن را فراخوانی کند.
    برای پیاده‌سازی این همکاری، integration glue را توسعه دهید، که شامل
    inbound و outbound adaptersها در monolith می‌شود.
   </li>
<li>
    
    برای جلوگیری از آلوده شدن domain model monolith به domain model service،
    integration glue باید از یک anti-corruption layer استفاده کند، که یک layer از
    software است که بین domain modelsها ترجمه می‌کند.
   </li>
<li>
    
    یک راه برای به حداقل رساندن تأثیر بر monolith در استخراج یک service، این است که
    data را که به service منتقل شده بود، به database monolith تکرار کنید.
    از آنجایی که schema monolith بدون تغییر باقی مانده است، این امر
    نیاز به ایجاد تغییرات بالقوه گسترده در code base monolith را از بین می‌برد.
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0500_original/original_page.png" alt="Original Page 500">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<ul>
<li>
    
    Developing a service often requires you to implement sagas that involve the
    monolith. But it can be challenging to implement a compensatable transaction
    that requires making widespread changes to the monolith. Consequently, you
    sometimes need to carefully sequence the extraction of services to avoid imple-
    menting compensatable transactions in the monolith.
   </li>
<li>
    
    When refactoring to a microservice architecture, you need to simultaneously
    support the monolithic application’s existing security mechanism, which is often
    based on an in-memory session, and the token-based security mechanism used
    by the services. Fortunately, a simple solution is to modify the monolith’s login
    handler to generate a cookie containing a security token, which is then for-
    warded to the services by the API gateway.
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0501_original/original_page.png" alt="Original Page 501">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   index
   <br/>
   Numerics
   <br/>
   2PC (two-phase commit) 112
   <br/>
   3rd party registration pattern 84–85, 108
   <br/>
   4+1 view model of software architecture 35–37
   <br/>
   500 status code, HTTP 367
  </p>
<p>
   A
   <br/>
   AbstractAutowiringHttpRequestHandler class 423
   <br/>
   AbstractHttpHandler class 423
   <br/>
   accept() method 165, 172
   <br/>
   acceptance tests 335–338
   <br/>
   defining 336
   <br/>
   executing specifications using Cucumber 338
   <br/>
   writing using Gherkin 337–338
   <br/>
   acceptOrder() method 460
   <br/>
   Access Token 28, 354, 357
   <br/>
   ACD (Atomicity, Consistency, Durability) 111
   <br/>
   ACID (Atomicity, Consistency, Isolation, Dur-
   ability) transactions 98, 110
   <br/>
   ACLs (access control lists) 350
   <br/>
   ActiveMQ message broker 92
   <br/>
   add() method 310
   <br/>
   addOrder() method 249–250
   <br/>
   AggregateRepository class 206–208
   <br/>
   aggregates 147, 374, 439
   <br/>
   consistency boundaries 155
   <br/>
   creating, finding, and updating 207–208
   <br/>
   defining aggregate commands 207
   <br/>
   defining with ReflectiveMutableCommand-
   ProcessingAggregate class 206–207
   <br/>
   designing business logic with 159–160
   <br/>
   event sourcing
   <br/>
   aggregate history 186, 199–200
   <br/>
   aggregate methods and events 189–191
   <br/>
   event sourcing-based Order aggregate
   191–193
   <br/>
   persisting aggregates using events 186–188
   <br/>
   event sourcing and aggregate history 199–200
   <br/>
   explicit boundaries 154–155
   <br/>
   granularity 158
   <br/>
   identifying 155
   <br/>
   Order aggregate 175–180
   <br/>
   methods 177–180
   <br/>
   state machine 176–177
   <br/>
   structure of 175–176
   <br/>
   rules for 155–157
   <br/>
   Ticket aggregate 169–173
   <br/>
   behavior of 170–171
   <br/>
   KitchenService domain service 171–172
   <br/>
   KitchenServiceCommandHandler class
   172–173
   <br/>
   structure of Ticket class 170
   <br/>
   traditional persistence and aggregate
   <br/>
   history 186
   <br/>
   aliases 285
   <br/>
   Alternative pattern 22
   <br/>
   AMI (Amazon Machine Image) 390
   <br/>
   anomalies 126
   <br/>
   Anti-corruption layer pattern 447
   <br/>
   AOP (aspect-oriented programming) 373, 378
   <br/>
   Apache Flume 370
   <br/>
   Apache Kafka 92
   <br/>
   Apache Openwhisk 416
   <br/>
   Apache Shiro 351
   <br/>
   API composition pattern 221–228
   <br/>
   benefits and drawbacks of 227–228
   <br/>
   increased overhead 227
   <br/>
   lack of transactional data consistency
   <br/>
   228
   <br/>
   risk of reduced availability 227–228
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0503_original/original_page.png" alt="Original Page 503">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   برنامه‌ریزی برای این‌که چه dataای به service، منتقل شود، نیازمند این است که شما
   مسائل مختلفی را در نظر بگیرید. در اینجا به برخی از این مسائل اشاره می‌کنیم.
  </p>
<p>
   یکی از راه‌ها، این است که با تغییر کد monolith، داده‌ها را به سرویس منتقل کنیم. با این حال، این می‌تواند باعث شود که
   تغییرات گسترده در monolith ایجاد شود.
  </p>
<h3><strong>HOW THE FTGO MONOLITH ACCESSES THE DELIVERY SERVICE DATA</strong></h3>
<p>
   The FTGO monolith، نیاز دارد به dataای که به Delivery Service منتقل شده است، دسترسی داشته باشد،
   مانند Courier plansها. در تئوری، monolith می‌تواند service را query کند، اما این کار
   نیازمند تغییرات گسترده در monolith است. در عوض، رویکرد بهتر این است که
   monolith، data را به Delivery Service با publish کردن domain eventsهای Courier،
   CourierLocationUpdated و CourierAvailabilityUpdated، تکرار کند. Delivery Service
   دارای یک CourierEventSubscriber است که به domain eventsها subscribe کرده و
   version از Courier را آپدیت می‌کند.
  </p>
<p>
   Monolith
   <br/>
   Event
   <br/>
   subscriber
   <br/>
   Delayed Order Service
   <br/>
   Domain
   <br/>
   event
   <br/>
   publisher
   <br/>
   REST
   <br/>
   endpoint
   <br/>
   Customer
   <br/>
   ContactInfo
   <br/>
   Proxy
   <br/>
   &lt;Repository&gt;
   <br/>
   Customer
   <br/>
   ContactInfo
   <br/>
   Repository
   <br/>
   Ubiquitous language of service
   <br/>
   Ubiquitous language of monolith
   <br/>
   Anti-corruption layer
   <br/>
   Event channel
   <br/>
   Order
   <br/>
   event
   <br/>
   Event
   <br/>
   publisher
  </p>
<p>
<strong>Figure 13.12</strong>
<br/>
   The integration glue provides Delayed Delivery Service with access to the data owned by
   the monolith.
  </p>
<p>
   بنابراین، یکی از این مسائل این است که monolith چگونه به داده‌های سرویس دسترسی پیدا می‌کند.
  </p>
<p>
   اکنون، پس از استخراج Delivery Service، به داده‌هایی که باید monolith به service دسترسی داشته باشد، نیاز داریم. به عنوان مثال:
  </p>
<p>
   با پیاده‌سازی این تعامل، ما این ویژگی را حفظ می‌کنیم که برای استخراج features به تغییر کمتری در monolith نیاز داریم.
  </p>
<h3><strong>THE DESIGN OF THE DELIVERY SERVICE API</strong></h3>
<p>
   همانطور که در طول این کتاب دیده‌اید، رویکرد ترجیحی، استفاده از پیام‌رسانی ناهمزمان است،
   زیرا coupling شل را ترویج می‌کند و
   availability را افزایش می‌دهد.
  </p>
<p>
   API Delivery Service، شامل یک کانال notification message است و سه نوع از messagesها را تعریف می‌کند:
   ScheduleDelivery, ReviseDelivery یا CancelDelivery. A
   notification message حاوی اطلاعات Order است که توسط Delivery Service مورد نیاز است.
  </p>
<p>
   بنابراین، یک مزیت مهم از این رویکرد این است که Delivery
   Service دانش دقیقی از چرخه حیات Order ندارد.
  </p>
<p>
   به طور کلی، یک service به جای این‌که به طور مستقیم به monolith متکی باشد، به تبادل data از طریق domain eventsها تکیه می‌کند.
  </p>
<p>
   این امر از طریق یک ساختار در معماری ما تسهیل می‌شود:
  </p>
<p>
   در این بخش به چگونگی تعامل با monolith و service می‌پردازیم.
  </p>
<h3><strong>13.5.2 Overview of Delivery Service</strong></h3>
<p>
   Service جدید که ما طراحی می‌کنیم مسئول زمان‌بندی، rescheduling و
   لغو deliveriesها است.
  </p>
<p>
   همانطور که در شکل 13.17 نشان داده شده است،
   application FTGO پس از استخراج Delivery Service را نشان می‌دهد.
  </p>
<p>
   معماری شامل monolith FTGO و Delivery Service است.
  </p>
<p>
   آنها با استفاده از integration glue، که شامل APIsها در هر دوی آنها می‌شود، همکاری می‌کنند.
  </p>
<p>
   Delivery Service دارای domain model و database خود است.
  </p>
<p>
   در این معماری ما نیاز داریم که مشخص کنیم:
  </p>
<ol>
<li>
    کدام behavior و data به Delivery Service منتقل می‌شوند؟
   </li>
<li>
    چه APIای را Delivery Service به monolith ارائه می‌کند؟
   </li>
<li>
    چه APIای را monolith به Delivery Service ارائه می‌کند؟
   </li>
</ol>
<p>
   این مسائل به هم مرتبط هستند، زیرا توزیع responsibilities بین
   monolith و service، بر APIsها تأثیر می‌گذارد. به عنوان مثال، Delivery Service نیاز خواهد داشت
   فراخوانی یک API ارائه شده توسط monolith برای دسترسی به data در data-
   base monolith و بالعکس.
  </p>
<p>
   APIهای زیادی در application ما وجود دارد که در شکل 13.17 نشان داده شده است.
  </p>
<p>
   APIها نشان‌دهنده نقاط پایانی هستند. در نتیجه، استفاده از API، یکی از مهمترین مسائل طراحی service است.
  </p>
<p>
   به‌عنوان‌مثال، وقتی می‌خواهیم یک service را ایجاد کنیم، باید از APIی استفاده کنیم که در شکل 13.17 نشان داده شده است.
  </p>
<h3><strong>DESIGNING THE DELIVERY SERVICE API</strong></h3>
<p>
   به‌عنوان بخشی از تعامل، ما به یک API نیاز داریم.
  </p>
<p>
   API باید به گونه‌ای طراحی شود که به راحتی بتواند توسط آن مورد استفاده قرار گیرد، یعنی
   باید ساده باشد.
  </p>
<p>
   Delivery Service باید یک API ارائه دهد که monolith را قادر می‌سازد تا schedule، revise،
   و cancel deliveriesها را انجام دهد.
  </p>
<p>
   یک مزیت مهم از این رویکرد این است که Delivery
   Service دانش دقیقی از چرخه حیات Order ندارد.
  </p>
<p>
   این API، تنها راه همکاری Delivery Service و FTGO monolith نیست.
  </p>
<p>
   در مرحله بعد، ما یک نمونه را بررسی می‌کنیم.
  </p>
<p>
   نمودار 13.15، یک طراحی سطح بالا از integration glue را نشان می‌دهد.
  </p>
<h3><strong>13.5.4 The design of the Delivery Service integration glue</strong></h3>
<p>
   به‌منظور ایجاد یک تعامل با monolith و service، ما به یک integration glue نیاز داریم.
  </p>
<p>
   FTGO monolith به service نیاز دارد. به عنوان مثال، یک service را فراخوانی می‌کنیم و data را مبادله می‌کنیم.
  </p>
<p>
   FTGO monolith از داده‌هایی که به Delivery Service تعلق دارد، استفاده می‌کند.
  </p>
<p>
   در حالی‌که این‌ dataها، dataهای زیادی را تشکیل می‌دهند.
  </p>
<p>
   با این حال، یک راه بهتر برای ایجاد تعامل، این است که با استفاده از eventsها، data را از monolith به Delivery Service منتقل کنیم.
  </p>
<p>
   همان‌طور که در شکل 13.20 نشان داده شده است، ما نیاز داریم به:
  </p>
<ul>
<li>
    ارائه دسترسی به data مورد نیاز service از طریق یک API با REST
   </li>
<li>
    با استفاده از domain eventsها، data را بین monolith و service همگام‌سازی کنید.
   </li>
</ul>
<p>
   ما می‌توانیم از domain eventsهای courier استفاده کنیم و همچنین از داده‌هایی که در مورد Order موجود است.
  </p>
<p>
   Delivery Service، از این eventsها استفاده می‌کند.
  </p>
<p>
   بنابراین، ما به یک event handler نیاز داریم.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0504_original/original_page.png" alt="Original Page 504">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   endpoint برای querying اطلاعات تماس مشتری. Delivery Service این را فراخوانی می‌کند
   endpoint زمانی که نیاز دارد به یک user اطلاع دهد که سفارش آنها به موقع تحویل داده نمی‌شود.
  </p>
<p>
   در این مثال، LoginHandler، USERINFO cookie را تنظیم می‌کند. API gateway از
   cookie USERINFO به یک header Authorization هنگام فراخوانی a service، منتقل می‌کند.
  </p>
<p>
   در شکل 13.22 به مراحل استفاده از interface DeliveryService در monolith برای invoke کردن delivery management اشاره شده است.
  </p>
<h3><strong>HOW THE FTGO MONOLITH ACCESSES THE DELIVERY SERVICE DATA</strong></h3>
<p>
   به منظور دسترسی به dataای که به Delivery Service منتقل شده است، ما نیاز داریم که data را از monolith کپی کنیم.
  </p>
<p>
   برای جلوگیری از مشکلات،  بهترین رویکرد این است که با نشر domain eventsها، داده‌ها را از monolith به Delivery Service منتقل کنید.
  </p>
<p>
   ساختار کلی serviceها در این تصویر دیده می‌شود.
  </p>
<p>
   ما می‌توانیم از رویکرد مشابهی با تکرار data و به اشتراک‌گذاری داده‌ها استفاده کنیم.
  </p>
<p>
   در ادامه به این موارد اشاره می‌کنیم.
  </p>
<h3><strong>13.5.4 The design of the Delivery Service integration glue</strong></h3>
<p>
   همان‌طور که ما به یک معماری microservice مهاجرت می‌کنیم، مسائل زیادی در مورد data، باید حل شود.
  </p>
<p>
   API جدید ما برای استفاده از data به monolith نیاز دارد.
  </p>
<p>
   همان‌طور که اشاره شد،
   API باید داده‌های مربوط به عملکرد delivery management را در برگیرد.
  </p>
<p>
   اکنون در این بخش به طراحی integration glue با استفاده از domain eventsها می‌پردازیم.
  </p>
<p>
   با توجه به طراحی، ما نیاز داریم که یک معماری را پیاده‌سازی کنیم:
  </p>
<ul>
<li>
    FTGO monolith.
   </li>
<li>
    Delivery Service.
   </li>
<li>
    هر دو باید با هم ارتباط برقرار کنند، یعنی یک تعامل.
   </li>
</ul>
<p>
   همان‌طور که در شکل نشان داده شده است، ما به:
  </p>
<ul>
<li>
    یک API management برای یک service.
   </li>
<li>
    به‌علاوه، یک  API برای برقراری ارتباط با monolith.
   </li>
</ul>
<p>
   علاوه بر این، باید مطمئن شویم که یک تعامل از طریق eventsها داریم.
  </p>
<p>
   از آن‌جایی‌که ما با architecture و classها سروکار داریم، لازم است که مشخص کنیم چگونه monolith و service با یکدیگر تعامل دارند.
  </p>
<p>
   سپس به این نتیجه می‌رسیم که از این service باید استفاده شود.
  </p>
<p>
   ما از یک interface به نام DeliveryService استفاده می‌کنیم.
  </p>
<p>
   The DeliveryService API از سه متد schedule، reschedule و cancel تشکیل شده است.
  </p>
<p>
   در مرحله بعد، ما باید ساختار monolith را در نظر بگیریم.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0505_original/original_page.png" alt="Original Page 505">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   index
   <br/>
   business logic (continued)
   <br/>
   generating 164–165
   <br/>
   identifying 162–163
   <br/>
   publishing 166–167
   <br/>
   reasons to publish 160–161
   <br/>
   domain model design 152–160
   <br/>
   aggregates 154–160
   <br/>
   problem with fuzzy boundaries 153–154
   <br/>
   event sourcing 184–202
   <br/>
   benefits of 199–200
   <br/>
   drawbacks of 200–202
   <br/>
   event publishing 194–195
   <br/>
   evolving domain events 198–199
   <br/>
   handling concurrent updates using optimis-
   tic locking 193–194
   <br/>
   idempotent message processing 197
   <br/>
   overview of 186–193
   <br/>
   snapshots, improving performance with
   195–196
   <br/>
   traditional persistence 185–186
   <br/>
   event store implementation 202–209
   <br/>
   Eventuate client framework for Java 205–209
   <br/>
   Eventuate Local event store 203–205
   <br/>
   Kitchen Service business logic 168–173
   <br/>
   Order Service business logic 173–182
   <br/>
   Order aggregate 175–180
   <br/>
   OrderService class 180–182
   <br/>
   organization patterns 147–152
   <br/>
   Domain model pattern 150–151
   <br/>
   domain-driven design 151–152
   <br/>
   Transaction script pattern 149–150
   <br/>
   sagas and event sourcing together 209–218
   <br/>
   creating orchestration-based saga 211–212
   <br/>
   implementing choreography-based sagas
   using event sourcing 210
   <br/>
   implementing event sourcing-based saga
   participant 213–216
   <br/>
   implementing saga orchestrators using event
   sourcing 216–218
   <br/>
   Business logic design patterns
   <br/>
   Aggregate 147, 152–160
   <br/>
   Domain event 160
   <br/>
   Domain model 150–151
   <br/>
   Event sourcing 184
   <br/>
   Transaction script 149–150
   <br/>
   business logic layer 38, 436
   <br/>
   by value countermeasure 131–132
  </p>
<p>
   C
   <br/>
   caching 262, 288
   <br/>
   cancel() operation 177
   <br/>
   cancelOrder() method 460
   <br/>
   CAP theorem 113
   <br/>
   CCP (Common Closure Principle) 56
   <br/>
   centralized sessions 354
   <br/>
   change failure rate 31
   <br/>
   choreography 111
   <br/>
   choreography-based sagas 118–121
   <br/>
   benefits and drawbacks of 121
   <br/>
   implementing Create Order saga 118–119
   <br/>
   implementing using event sourcing 210
   <br/>
   reliable event-based communication 120–121
   <br/>
   CI (Continuous Integration) 6, 306, 357
   <br/>
   Circuit breaker pattern 77–80
   <br/>
   developing robust RPI proxies 79
   <br/>
   recovering from unavailable services 79–80
   <br/>
   Client concept 358
   <br/>
   Client-side discovery pattern 82–83
   <br/>
   command message 86
   <br/>
   Command query responsibility segregation. See
   <br/>
   CQRS pattern
   <br/>
   command/reply-based messaging 102–103
   <br/>
   commands 41
   <br/>
   commit tests stage 306
   <br/>
   committed records 130
   <br/>
   Common Closure Principle (CCP) 56–57
   <br/>
   communication
   <br/>
   flexible 93
   <br/>
   secure interprocess 350
   <br/>
   communication patterns 23–25
   <br/>
   commutative update countermeasure 130
   <br/>
   compensatable transactions 116, 128, 450
   <br/>
   compensating transaction 450
   <br/>
   compile-time tests 297
   <br/>
   component tests 306, 339–340
   <br/>
   for FTGO Order Service
   <br/>
   OrderServiceComponentTestStepDefinitions
   <br/>
   class 341–344
   <br/>
   running 344–345
   <br/>
   writing 340–345
   <br/>
   in-process component tests 339
   <br/>
   out-of-process component tests 339–340
   <br/>
   condition expression 248
   <br/>
   Conduit 381
   <br/>
   ConfigMap 402
   <br/>
   configurable services 360–364
   <br/>
   pull-based externalized configuration 363–364
   <br/>
   push-based externalized configuration 362–363
   <br/>
   @ConfigurationProperties class 276
   <br/>
   consumer contract testing 301–303
   <br/>
   for asynchronous request/response
   <br/>
   interaction 332–335
   <br/>
   for messaging APIs 305
   <br/>
   for publish/subscribe-style interactions
   <br/>
   328–330
   <br/>
   for REST-based request/response style
   <br/>
   interactions 324–326
   <br/>
   consumer group 94
   <br/>
   consumer-driven contract test 28, 302
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0506_original/original_page.png" alt="Original Page 506">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   revises, and cancels a Delivery. A benefit of this approach is that the monolith doesn’t
   need to explicitly invoke Delivery Service. The drawback of relying on domain events
   is that it requires Delivery Service to know how each Order event impacts the corre-
   sponding Delivery.
  </p>
<p>
   In this saga, the monolith’s transaction is the pivot transaction. Order Service imple-
   ments the compensatable transaction.
  </p>
<p>
   A better approach is for Delivery Service to implement a notification-based API
   that enables the monolith to explicitly tell Delivery Service to create, revise, and
   cancel deliveries. Delivery Service’s API consists of a message notification channel
   and three message types: ScheduleDelivery, ReviseDelivery, or CancelDelivery. A
   notification message contains Order information needed by Delivery Service. For
   example, a ScheduleDelivery notification contains the pickup time and location and
   the delivery time and location. An important benefit of this approach is that Delivery
   Service doesn’t have detailed knowledge of the Order lifecycle. It’s entirely focused
   on managing deliveries and has no knowledge of orders.
  </p>
<p>
   This API isn’t the only way that Delivery Service and the FTGO monolith collab-
   orate. They also need to exchange data.
  </p>
<p>
   در اینجا، ما بر روش‌هایی که monolith dataها را به اشتراک می‌گذارد، تمرکز می‌کنیم.
  </p>
<h3><strong>HOW THE FTGO MONOLITH ACCESSES THE DELIVERY SERVICE DATA</strong></h3>
<p>
   به‌عنوان مثال، در نظر بگیرید که چگونه monolith FTGO می‌تواند به dataهای Delivery Service دسترسی داشته باشد.
  </p>
<p>
   به‌عنوان مثال، monolith، نیاز به داده‌ها دارد که  Courier را برنامه‌ریزی کند.
  </p>
<p>
   برای دستیابی به این dataها، بهترین رویکرد این است که:
  </p>
<ol>
<li>
    monolith داده‌ها را به Delivery Service تکرار کند.
   </li>
<li>
    با انتشار domain eventsهای Courier، آن را به سرویس ارسال می‌کند.
   </li>
</ol>
<p>
   در زیر، در مورد چگونگی انجام این کار بحث می‌کنیم.
  </p>
<p>
   ما به بحث در مورد طراحی کلی می‌پردازیم.
  </p>
<p>
   در این معماری، ما یک رابطی داریم.
  </p>
<p>
   FTGO monolith، با یک REST API، عمل می‌کند.
  </p>
<p>
   سپس، در این بخش ما به APIهای مورد نیاز برای service اشاره می‌کنیم.
  </p>
<p>
   FTGO monolith این API را برای دسترسی به data service تعریف می‌کند.
  </p>
<p>
   اکنون، به طراحی integration glue نگاه می‌کنیم.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0507_original/original_page.png" alt="Original Page 507">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   بعد از این‌که یک API به monolith اضافه کردیم، باید موارد زیر را بررسی کنیم:
  </p>
<ul>
<li>
    چگونه monolith و service، با یکدیگر تعامل می‌کنند؟
   </li>
<li>
    چگونه data را رد و بدل می‌کنند؟
   </li>
</ul>
<p>
   ما به یک entity نیاز داریم.
  </p>
<p>
   همچنین، ما به یک adapter برای تعامل با service نیاز داریم.
  </p>
<p>
   در نهایت، ما به این نتیجه می‌رسیم که چگونه monolith با service تعامل دارد.
  </p>
<h3><strong>13.5.2 Overview of Delivery Service</strong></h3>
<p>
   به‌عنوان‌مثال، یک API از monolith.
  </p>
<p>
   بنابراین، data را به اشتراک می‌گذاریم.
  </p>
<h3><strong>THE DESIGN OF THE DELIVERY SERVICE API</strong></h3>
<p>
   API باید به گونه‌ای طراحی شود که به راحتی بتواند توسط آن مورد استفاده قرار گیرد.
  </p>
<p>
   با استفاده از رویکرد مبتنی بر messaging، ما به یک رابط مناسب می‌رسیم.
  </p>
<p>
   ما به  API Delivery Service نیاز داریم.
  </p>
<p>
   این API، شامل کانال‌های message و پیام‌های notification می‌شود.
  </p>
<p>
   برای نمونه، یک notification شامل:
  </p>
<ul>
<li>
    زمان pickup.
   </li>
<li>
    مکان delivery.
   </li>
</ul>
<p>
   از آن‌جایی‌که ما service را از monolith جدا کردیم، service اطلاعاتی در مورد ordersها ندارد.
  </p>
<p>
   به‌طور کلی، در این سناریو، ما با استفاده از یک API به data service دسترسی داریم.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0508_original/original_page.png" alt="Original Page 508">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   من این بخش را با نگاهی به service با جزئیات بیشتر آغاز می‌کنم و
   به این می‌پردازیم که چگونه می‌توان معماری‌ها را طراحی کرد.
  </p>
<h3><strong>13.5.4 The design of the Delivery Service integration glue</strong></h3>
<p>
   همان‌طور که قبلاً اشاره شد، برای ایجاد تعامل، ما نیاز داریم که یک API را برای مدیریت
   و تعامل به monolith با service، تعریف کنیم.
  </p>
<p>
   ما همچنین به چگونگی تعامل با data در monolith، نیاز داریم.
  </p>
<p>
   ما به این نتیجه می‌رسیم که domain eventsها، ساده‌ترین رویکرد هستند.
  </p>
<p>
   FTGO monolith، به سادگی domain eventsها را منتشر می‌کند.
  </p>
<p>
   ما این تعامل‌ها را در شکل 13.12 مشاهده می‌کنیم.
  </p>
<p>
   به‌طور خلاصه،
  </p>
<ul>
<li>
    FTGO monolith به domain eventsها publish می‌شود.
   </li>
<li>
    Delivery Service به domain eventsها subscribe می‌شود.
   </li>
<li>
    Delivery Service data را در داخل خود کپی می‌کند.
   </li>
</ul>
<p>
   در مرحله بعد، ما به این نتیجه می‌رسیم که چگونه در سطح monolith یک API و
   ساختار را باید ایجاد کنیم.
  </p>
<p>
   به‌عنوان مثال، هنگامی که شما باید یک service را برای اجرا تعریف کنید، باید از موارد مختلفی آگاه باشید.
  </p>
<p>
   به‌عنوان‌مثال، ما باید یک interface مانند شکل 13.21 را ایجاد کنیم.
  </p>
<p>
   با استفاده از رابط‌ها، ما می‌توانیم APIهای مختلفی ایجاد کنیم.
  </p>
<p>
   یکی از این گزینه‌ها، ایجاد یک message است که از سه متد اصلی تشکیل شده است.
  </p>
<p>
   ساختار کلی معماری.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0509_original/original_page.png" alt="Original Page 509">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   به عنوان یک گام بعدی، ما نیاز داریم که عملکرد تحویل داده شده را در نظر بگیریم.
  </p>
<p>
   ما عملکرد خود را با اضافه کردن سه متد به این service، ایجاد می‌کنیم.
  </p>
<p>
   این شامل ScheduleDelivery، RescheduleDelivery و CancelDelivery می‌شود.
  </p>
<p>
   با ایجاد یک service، ما می‌توانیم مشکلات را در order مدیریت کنیم.
  </p>
<p>
   از آنجا، ما به طراحی intergration glue می‌رویم.
  </p>
<p>
   ما به این نتیجه می‌رسیم که چگونه the FTGO monolith باید به این service دسترسی داشته باشد.
  </p>
<p>
   در نهایت، ما به این سوال پاسخ می‌دهیم که با چه dataای درگیر هستیم.
  </p>
<h3><strong>THE DESIGN OF THE DELIVERY SERVICE API</strong></h3>
<p>
   ما همچنین باید یک API از طریق پیام‌ها ایجاد کنیم.
  </p>
<p>
   ما باید به داده‌هایی که از monolith کپی شده‌اند، دسترسی داشته باشیم.
  </p>
<p>
   برای آن، ما از رویکردی که قبلاً در موردش صحبت شد، استفاده می‌کنیم،つまり،  API بر اساس messaging را تعریف می‌کنیم.
  </p>
<p>
   به‌عنوان‌مثال، باید به یک data در monolith، دسترسی داشته باشیم.
  </p>
<p>
   بنابراین، باید از یک API مانند 13.15 استفاده کنیم.
  </p>
<p>
   برخی از این‌ APIها، REST API هستند.
  </p>
<p>
   اکنون ما نحوه عملکرد service را پوشش داده‌ایم.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0510_original/original_page.png" alt="Original Page 510">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   برای این‌که بتونیم domain logic Delivery Service را تعریف کنیم، ما به موارد زیر نیاز داریم:
  </p>
<ul>
<li>
    ما نیاز داریم APIها را طراحی کنیم.
   </li>
<li>
    در مرحله بعد، ما به تعریف یک service نیاز داریم.
   </li>
<li>
    و در نهایت، data‌ها را sync کنیم.
   </li>
</ul>
<p>
   با توجه به موارد بالا، در نظر بگیرید که چگونه باید معماری را طراحی کنیم.
  </p>
<p>
   در این context، ما ابتدا در مورد یک 
   API از جنس REST صحبت می‌کنیم، که معمولاً یک راه‌حل ساده و آسان است.
  </p>
<p>
   برخی از مفاهیم در این زمینه عبارتند از:
  </p>
<ul>
<li>
    حتی اگر یک 
    service را طراحی می‌کنیم، به یک interface نیاز داریم.
   </li>
<li>
    یکی از راه‌هایی که ما می‌توانیم از آن استفاده کنیم، فراخوانی یک API توسط
    CustomerContactInfoRepository است.
   </li>
</ul>
<p>
   برای مثال، در زیر یک نمونه‌ API را می‌بینیم.
  </p>
<p>
   در بخش قبلی، ما به این نتیجه رسیدیم که در اینجا برای آن، باید از یک 
   REST API استفاده کنیم.
  </p>
<p>
   در نظر داشته باشید که چگونه یک monolith به یک 
   API ساده، دسترسی پیدا می‌کند.
  </p>
<p>
   ما باید یک رابط مناسب بین serviceها ایجاد کنیم.
  </p>
<h3><strong>HOW THE FTGO MONOLITH ACCESSES THE DELIVERY SERVICE DATA</strong></h3>
<p>
   service به dataها در monolith دسترسی دارد.
  </p>
<p>
   در این بخش، ما از یک رویکرد متفاوت برای تولید یک system از این context استفاده می‌کنیم.
  </p>
<p>
   ما از یک روش پیام‌رسانی استفاده می‌کنیم.
  </p>
<p>
   به دلیل رویکرد messaging، ما به جای این‌که یک API بزرگ ایجاد کنیم، به این نتیجه می‌رسیم که یک event را publish کنیم.
  </p>
<p>
   ما با استفاده از یک event به صورت asynchronous، به یک تعامل دست پیدا می‌کنیم.
  </p>
<p>
   این امر از طریق سه متد امکان‌پذیر است:
  </p>
<ul>
<li>
    به‌جای استفاده از یک API، از eventها استفاده می‌کنیم.
   </li>
<li>
    به‌عنوان‌مثال، ما می‌توانیم یک event را به نام Order event داشته باشیم.
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0511_original/original_page.png" alt="Original Page 511">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   در گام بعدی، ما به چگونگی ایجاد یک interface از جنس REST برای service و
   monolith، نگاه می‌کنیم.
  </p>
<p>
   این کار ساده است و معمولاً برای این کار از یک پروکسی استفاده می‌شود.
  </p>
<p>
   به عنوان مثال، وقتی می‌خواهیم یک service را برای یک درخواست ایجاد کنیم، باید از یک API استفاده کنیم.
  </p>
<p>
   ما می‌توانیم  Delivery Service و the FTGO monolith را به گونه‌ای طراحی کنیم که با هم هم‌کاری داشته باشند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0512_original/original_page.png" alt="Original Page 512">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   پس از این‌که ما dataها را در داخل یک monolith و service تکرار کردیم، ما
   همچنین باید در مورد domain eventsها و نحوه استفاده از آنها برای انتقال dataها، فکر کنیم.
  </p>
<p>
   همان‌طور که ما در مورد معماری صحبت کردیم، باید یک overview از serviceها و
   monolith را با هم در نظر بگیریم.
  </p>
<p>
   درحالی‌که این مسئله پیچیده‌تر از یک سیستم است، باید در مورد هر عملیات، design داشته باشیم.
  </p>
<p>
   ما همچنین باید در مورد ایجاد یک رابط برای service، thinking کنیم.
  </p>
<p>
   سپس ما باید ساختار را در نظر بگیریم.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0513_original/original_page.png" alt="Original Page 513">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   index
   <br/>
   Eventuate client framework for Java 205–209
   <br/>
   AggregateRepository class 207–208
   <br/>
   defining aggregate commands 207
  </p>
<p>
   (ادامه)
  </p>
<p>
   بنابراین، ما در مورد مسائل بسیاری بحث کردیم.
  </p>
<p>
   ما همچنین در مورد استفاده از domain eventsها، صحبت کردیم.
  </p>
<p>
   برای نمونه ما از موارد زیر استفاده می‌کنیم:
  </p>
<ul>
<li>
    فراخوانی REST API و استفاده از یک service.
   </li>
<li>
    در اینجا ما به بحث در مورد تکرار dataها می‌پردازیم.
   </li>
</ul>
<p>
   ما از یک API برای دسترسی به data در service استفاده می‌کنیم.
  </p>
<p>
   بنابراین، ما تصمیم می‌گیریم که چه چیزهایی را می‌خواهیم.
  </p>
<p>
   همچنین ما در مورد چگونگی یکپارچه‌سازی monolith و serviceها بحث می‌کنیم.
  </p>
<p>
   همچنین به مثال‌های مختلفی اشاره می‌کنیم.
  </p>
<p>
   همچنین، من به این اشاره می‌کنم که چگونه یک رابط را ایجاد کنیم.
  </p>
<p>
   در این بخش، ما همچنین به یک رویکرد خاص یعنی یک event-based service می‌پردازیم.
  </p>
<p>
   داده‌های اصلی.
  </p>
<p>
   ما این روش‌ها را در شکل 13.15 مشاهده می‌کنیم.
  </p>
<p>
   به‌عنوان‌مثال: ما به یک API و یک proxy نیاز داریم.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0514_original/original_page.png" alt="Original Page 514">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   (ادامه)
  </p>
<p>
   INDEX
   <br/>
   event store implementation (continued)
   <br/>
   defining aggregates with ReflectiveMutable-
   <br/>
   CommandProcessingAggregate
   <br/>
   class 206–207
   <br/>
   defining domain events 207
   <br/>
   subscribing to domain events 208–209
   <br/>
   Eventuate Local event store 203–205
   <br/>
   consuming events by subscribing to event
   <br/>
   broker 205
   <br/>
   event relay propagates events from database to
   <br/>
   message broker 205
   <br/>
   schema 203–205
   <br/>
   event storming 162
   <br/>
   event-driven I/O 269
   <br/>
   @EventHandlerMethod annotation 208
   <br/>
   events. See Domain events
   <br/>
   @EventSubscriber annotation 208
   <br/>
   Eventuate framework 101, 202, 205–209
   <br/>
   and updating aggregates with the Aggregate-
   <br/>
   Repository class 207–208
   <br/>
   defining aggregate commands 207
   <br/>
   defining aggregates with ReflectiveMutable-
   <br/>
   CommandProcessingAggregate class
   <br/>
   206–207
   <br/>
   defining domain events 207
   <br/>
   subscribing to domain events 208–209
   <br/>
   Eventuate Local event store 203–205
   <br/>
   consuming events by subscribing to event
   <br/>
   broker 205
   <br/>
   event relay propagates events from database to
   <br/>
   message broker 205
   <br/>
   schema 203–205
   <br/>
   Eventuate Tram 100, 166
   <br/>
   Eventuate Tram Saga framework 140–142
   <br/>
   Exception tracking pattern 28, 366, 376–377
   <br/>
   Express framework 289–290
   <br/>
   external API patterns 253–291
   <br/>
   API gateway 76, 227, 254, 259–272
   <br/>
   API gateway implementation 271–291
   <br/>
   using GraphQL 279–291
   <br/>
   using Netflix Zuul 273
   <br/>
   using off-the-shelf products/services 271–272
   <br/>
   using Spring Cloud Gateway 273–275
   <br/>
   API gateway pattern 76, 227, 254, 259–271
   <br/>
   benefits of 267
   <br/>
   design issues 268–271
   <br/>
   drawbacks of 267
   <br/>
   Netflix example 267–268
   <br/>
   overview of 259–266
   <br/>
   Backends for frontends 254, 262, 264–266
   <br/>
   design issues 254–259
   <br/>
   browser-based JavaScript applications 258
   <br/>
   FTGO mobile client 255–258
   <br/>
   third-party applications 258–259
   <br/>
   web applications 258
   <br/>
   externalized configuration 361
   <br/>
   pull-based 363–364
   <br/>
   push-based 262–263
   <br/>
   Externalized Configuration pattern 28, 361
  </p>
<p>
   F
   <br/>
   Factory object, DDD 151
   <br/>
   fault isolation 6
   <br/>
   feature flags 469
   <br/>
   feature toggles 469
   <br/>
   filter expression 247
   <br/>
   filter parameter 229
   <br/>
   find() operation 204
   <br/>
   findAvailableRestaurants() query operation 231
   <br/>
   findCustomerContactInfo() method 447
   <br/>
   findOrder() operation 221–222, 224
   <br/>
   findOrderHistory() query operation 229–231,
   <br/>
   251–252
   <br/>
   defining index for 245–247
   <br/>
   implementing 247
   <br/>
   FindRestaurantRequestHandler class 421–422
   <br/>
   Fission framework 416
   <br/>
   Fluentd 370
   <br/>
   Flume 370
   <br/>
   fold operation 187
   <br/>
   FTGO application
   <br/>
   API design issues for mobile client 255–258
   <br/>
   changing monolith to interact with
   <br/>
   Delivery Service 467–470
   <br/>
   component tests for Order Service 340–345
   <br/>
   deploying with Kubernetes 399–415
   <br/>
   API gateway 405–406
   <br/>
   Restaurant Service 402–405
   <br/>
   service meshes 407–415
   <br/>
   zero-downtime deployments 406–407
   <br/>
   microservice architecture of 12–13
   <br/>
   monolithic architecture of 3–4
   <br/>
   ftgo-db-secret 404
   <br/>
   FtgoGraphQLClient class 290
   <br/>
   functional decomposition 10
   <br/>
   fuzzy boundaries 153–154
  </p>
<p>
   G
   <br/>
   GDPR (General Data Protection Regulation) 201
   <br/>
   generalization pattern 22
   <br/>
   GET REST endpoint 271
   <br/>
   getDelayedOrders() method 456
   <br/>
   getOrderDetails() query 368
   <br/>
   Gherkin
   <br/>
   executing specifications using Cucumber 338
   <br/>
   writing acceptance tests 337–338
   <br/>
   GoLang (Go language) 4, 380
   <br/>
   Google Cloud functions 416
   <br/>
   graph-based schema 280
   <br/>
   GraphQL 279, 281–291
   <br/>
   connecting schema to data 285–287
   <br/>
   defining schema 282–284
   <br/>
   executing queries 284–285
   <br/>
   integrating Apollo GraphQL server with
   <br/>
   Express 289–290
   <br/>
   load optimization using batching and caching 288
   <br/>
   writing client 290–291
   <br/>
   gRPC 76–77
  </p>
<p>
   H
   <br/>
   handleHttpRequest() method 421
   <br/>
   handleRequest() method 417
   <br/>
   health check 82, 365
   <br/>
   Health check API pattern 27, 366–368
   <br/>
   implementing endpoint 367–368
   <br/>
   invoking endpoint 368
   <br/>
   hexagonal architecture 3, 38–40
   <br/>
   high-level design patterns 20
   <br/>
   Honeybadger 377
   <br/>
   HttpServletResponse 422
   <br/>
   Humble, Jez 30
  </p>
<p>
   I
   <br/>
   idempotent message processing 96, 197
   <br/>
   CQRS views 240–241
   <br/>
   event sourcing-based saga participant 213
   <br/>
   with NoSQL-based event store 197
   <br/>
   with RDBMS-based event store 197
   <br/>
   idempotentUpdate() method 250–251
   <br/>
   IDL (interface definition language) 69
   <br/>
   -ilities 8, 34, 37
   <br/>
   Implementation view 35
   <br/>
   inbound adapters 3, 38
   <br/>
   infrastructure patterns 23–24
   <br/>
   init system, Linux 390
   <br/>
   in-memory security context 353
   <br/>
   instrumentation libraries 373
   <br/>
   integration glue 444–449
   <br/>
   designing API for 444–445
   <br/>
   for Delayed Delivery Service 457–459, 465–467
   <br/>
   CustomerContactInfoRepository
   <br/>
   interface 458
   <br/>
   design of API 465–466
   <br/>
   how Delivery Service accesses FTGO
   <br/>
   data 466
   <br/>
   how FTGO accesses data 467
   <br/>
   publishing and consuming Order and
   <br/>
   Restaurant domain events 458–459
   <br/>
   how monolith publishes and subscribes to
   <br/>
   domain events 448–449
   <br/>
   implementing anti-corruption layer 446–448
   <br/>
   picking interaction style and IPC
   <br/>
   mechanism 445–446
   <br/>
   integration tests 319–335
   <br/>
   asynchronous request/response
   <br/>
   interactions 330–335
   <br/>
   example contract 331–332
   <br/>
   tests for asynchronous request/response
   <br/>
   interaction 332–335
   <br/>
   persistence integration tests 321–322
   <br/>
   publish/subscribe-style interactions 326–330
   <br/>
   contract for publishing OrderCreated
   <br/>
   event 327–328
   <br/>
   tests for Order History Service 329–330
   <br/>
   tests for Order Service 328–329
   <br/>
   REST-based request/response style
   <br/>
   interactions 322–326
   <br/>
   example contract 324
   <br/>
   tests for API gateway OrderServiceProxy
   <br/>
   325–326
   <br/>
   tests for Order Service 324–325
   <br/>
   interaction styles 67–68, 87–89
   <br/>
   asynchronous 104–105
   <br/>
   one-way notifications 89
   <br/>
   publish/async responses 89
   <br/>
   publish/subscribe 89
   <br/>
   request/response and asynchronous request/
   <br/>
   response 87–88
  </p>
<p>
   interface definition language (IDL) 69
   <br/>
   invariants 153
   <br/>
   IPC (interprocess communication) 24, 65,
   <br/>
   93–109
   <br/>
   overview of 66–72
   <br/>
   defining APIs 68–69
   <br/>
   evolving APIs 69–71
   <br/>
   interaction styles 67–68
   <br/>
   message formats 71–72
   <br/>
   using asynchronous Messaging pattern 85–103
   <br/>
   competing receivers and message
   <br/>
   ordering 94–95
   <br/>
   creating API specification 89–90
   <br/>
   duplicate messages 95–97
   <br/>
   improving availability 103–108
   <br/>
   interaction styles 87–89
   <br/>
   libraries and frameworks for 100–103
   <br/>
   message brokers 90–94
   <br/>
   overview of 86–87
   <br/>
   transactional messaging 97–100
   <br/>
   using synchronous Remote procedure invoca-
   tion pattern 72–85
   <br/>
   Circuit breaker pattern 77–80
   <br/>
   gRPC 76–77
   <br/>
   REST 73–76
   <br/>
   service discovery 80–85
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0515_original/original_page.png" alt="Original Page 515">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   به عنوان مثال، در حال حاضر ما در مورد کدهایی بحث می‌کنیم که یک
   فراخوانی service انجام می‌دهند، یعنی آن باید با استفاده از interfaceهای مختلفی تعامل داشته باشد.
  </p>
<p>
   با استفاده از یک proxy، ما می‌توانیم service را فراخوانی کنیم.
  </p>
<p>
   ما باید از data موجود در monolith و همچنین service استفاده کنیم.
  </p>
<p>
   بنابراین، ما در حال توسعه بخش‌های مختلف architectureهستیم.
  </p>
<h3><strong>13.5.5 Changing the FTGO monolith to interact with Delivery Service</strong></h3>
<p>
   به‌طور خلاصه، این serviceها از یکدیگر data رد و بدل می‌کنند.
  </p>
<p>
   زمانی که ما می‌خواهیم تعامل داشته باشیم، می‌توانیم یک 
   API ایجاد کنیم.
  </p>
<p>
   با توجه به رویکردهای داده‌شده، ما باید بر اساس مراحل زیر عمل کنیم:
  </p>
<ol>
<li>
    ما باید به سمت ایجاد یک  Interface برای serviceها حرکت کنیم.
   </li>
<li>
    API serviceها.
   </li>
</ol>
<p>
   بنابراین، ما به یک API که ساده‌تر است، نیاز داریم.
  </p>
<p>
   برای مثال:
  </p>
<p>
   The DeliveryService interface را طراحی می‌کنیم.
  </p>
<p>
   یک interface.
  </p>
<p>
   که سه متد را تعریف می‌کند:
  </p>
<ul>
<li>
    ScheduleDelivery.
   </li>
<li>
    RescheduleDelivery.
   </li>
<li>
    CancelDelivery.
   </li>
</ul>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0516_original/original_page.png" alt="Original Page 516">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   در این context، شما باید تصمیم بگیرید که چگونه APIها را تعریف کنید.
  </p>
<p>
   بنابراین، با توجه به رویکردهای مختلف، در مورد این‌که data چگونه در حال حرکت است، تصمیم‌گیری می‌کنیم.
  </p>
<p>
   در مرحله بعد، ما باید در مورد نحوه ایجاد یک database برای service جدید، thinking کنیم.
  </p>
<p>
   بنابراین، ما باید data را در نظر بگیریم.
  </p>
<p>
   در این مورد، شما به یک service نیاز دارید.
  </p>
<p>
   APIها همچنین باید شامل آن باشند.
  </p>
<p>
   شما همچنین باید به این بیندیشید که چگونه data به monolith، دسترسی پیدا می‌کند.
  </p>
<p>
   برای مثال، یک service برای اطلاع دادن به userها ایجاد می‌شود.
  </p>
<p>
   ما همچنین باید در مورد این‌که چگونه تعامل با monolith باید باشد، فکر کنیم.
  </p>
<p>
   ما برای این کار از یک API استفاده می‌کنیم.
  </p>
<p>
   در طول این chapter، ما به مسائل زیادی اشاره کردیم.
  </p>
<p>
   فهرست مطالب:
  </p>
<p>
   فهرست مطالب:
   <br/>
   index
   <br/>
   Asynchronous messaging pattern (continued)
   <br/>
   libraries and frameworks for 100–103
   <br/>
   basic messaging 101
   <br/>
   command/reply-based messaging 102–103
   <br/>
   domain event publishing 102
   <br/>
   message brokers 90–94
   <br/>
   benefits and drawbacks of 93–94
   <br/>
   brokerless messaging 91–92
   <br/>
   implementing message channels using 93
   <br/>
   overview of 92
   <br/>
   overview of 86–87
   <br/>
   transactional messaging 97–100
   <br/>
   publishing events using Polling publisher
   <br/>
   pattern 98–99
   <br/>
   publishing events using Transaction log tail-
   <br/>
   ing pattern 99–100
   <br/>
   using database table as message queue
   <br/>
   97–98
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0517_original/original_page.png" alt="Original Page 517">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   زمانی که ما با یک system مبتنی بر service روبرو هستیم، لازم است که به موارد متعددی بپردازیم.
  </p>
<p>
   همچنین از آنجایی‌که serviceها در یک monolith نگهداری می‌شوند، باید اطمینان حاصل کنیم که
   به درستی این تعامل‌ها شکل می‌گیرند.
  </p>
<p>
   در این context، ما در مورد تعامل با service، با استفاده از domain eventsها، بحث خواهیم کرد.
  </p>
<p>
   API که به service اجازه می‌دهد که به data monolith، دسترسی داشته باشد، باید طراحی شود.
  </p>
<p>
   برای مثال، ما در حال بررسی یک API هستیم.
  </p>
<p>
   ما باید در مورد طراحی domain model برای service، اطلاعاتی را جمع‌آوری کنیم.
  </p>
<p>
   ما به‌طور خاص به این اشاره می‌کنیم که چگونه service باید dataهای monolith را بخواند.
  </p>
<p>
   بنابراین، ما به یک adapter و یک proxy برای ایجاد تعامل، نیاز داریم.
  </p>
<p>
   اکنون بیایید به چگونگی ایجاد ارتباط با data که به monolith تعلق دارد، نگاهی بیندازیم.
  </p>
<p>
   به‌عنوان‌مثال، ما از یک event استفاده می‌کنیم، یعنی یک domain event.
  </p>
<p>
   با این‌که serviceها در یک environment جداگانه هستند، ما به بررسی این‌که چگونه باید آنها را به
   monolith متصل کنیم، می‌پردازیم.
  </p>
<p>
   پس ما به domain eventها نیاز داریم.
  </p>
<p>
   به‌عنوان‌مثال، ما باید یک OrderCreated event را منتشر کنیم.
  </p>
<p>
   در این معماری، ما فرض را بر این می‌گیریم که داده‌ها به‌صورت صحیح
   نگهداری می‌شوند.
  </p>
<p>
   ما نیازی به بررسی detailsهای بسیار در مورد order نداریم.
  </p>
<p>
   ما همچنین باید معماری را درک کنیم،
  </p>
<p>
   به‌عنوان‌مثال، ما باید در مورد یک طراحی برای Order صحبت کنیم.
  </p>
<p>
   سپس ما به یک API، از یک Service، نیاز داریم.
  </p>
<p>
   برای آن ما نیاز داریم که یک interface را در نظر بگیریم.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0518_original/original_page.png" alt="Original Page 518">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>CHAPTER 13</strong></h2>
<h3><strong>Refactoring to microservices</strong></h3>
<p>
   من در این‌جا می‌خواهم API service را ارائه دهم.
  </p>
<p>
   در حالت ایده‌آل،  API از یک 
   interface ساده تشکیل می‌شود.
  </p>
<p>
   همچنین، باید از یک متد برای 
   schedule کردن، re-schedule کردن و cancel کردن Delivery استفاده کنیم.
  </p>
<p>
   ما می‌توانیم به سادگی، این methodsها را از یک کلاس به یک class دیگر، کپی کنیم.
  </p>
<p>
   ما از یک API به عنوان یک مثال استفاده می‌کنیم.
  </p>
<p>
   همچنین، همان‌طور که در فصل 13.3.1 دیدیم، یک API بر اساس  messaging.
  </p>
<p>
   در نظر داشته باشید که چگونه یک service، می‌تواند برای سهولت کار،
   messagesها را انجام دهد.
  </p>
<p>
   ما می‌توانیم از یک  interface برای schedule کردن، reschedule کردن و cancel کردن Delivery استفاده کنیم.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0519_original/original_page.png" alt="Original Page 519">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<h2><strong>INDEX</strong></h2>
<p>
   VIP (virtual IP) address 83
   <br/>
   VirtualService 413
   <br/>
   VMs (virtual machines) 26
  </p>
<p>
   W
   <br/>
   WAR (Web Application Archive) file 2
   <br/>
   WebSockets 257
  </p>
<p>
   X
   <br/>
   XML message 71
  </p>
<p>
   Z
   <br/>
   ZeroMQ 91
   <br/>
   Zipkin 373
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0520_original/original_page.png" alt="Original Page 520">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>
   Enables
   <br/>
   Enables
   <br/>
   Architecture:
   <br/>
   Microservice
   <br/>
   architecture
   <br/>
   Organization:
   <br/>
   Small, autonomous,
   <br/>
   cross-functional teams
   <br/>
   Process:
   <br/>
   DevOps/continuous delivery/deployment
   <br/>
   Enables
   <br/>
   Rapid, frequent,
   <br/>
   and reliable delivery
   <br/>
   of software
  </p>
<p>
   تحویل سریع، مکرر و قابل اطمینان از applicationهای بزرگ و پیچیده، نیازمند ترکیبی از DevOps است، که شامل continuous delivery/deployment، تیم‌های کوچک و مستقل و معماری microservice است.
  </p>
<p>
   Small, autonomous,
   <br/>
   loosely coupled teams
   <br/>
   Each service has
   <br/>
   its own source
   <br/>
   code repository.
   <br/>
   Each service has
   <br/>
   its own automated
   <br/>
   deployment pipeline.
   <br/>
   Small, simple,
   <br/>
   reliable, easy to
   <br/>
   maintain services
   <br/>
   Order management team
   <br/>
   Restaurant management team
   <br/>
   Delivery management team
   <br/>
   FTGO development
   <br/>
   Production
   <br/>
   Jenkins Cl
   <br/>
   Deployment pipeline
   <br/>
   Order Service
   <br/>
   source code
   <br/>
   repository
   <br/>
   Order Service
   <br/>
   Jenkins Cl
   <br/>
   Deployment pipeline
   <br/>
   Restaurant Service
   <br/>
   source code
   <br/>
   repository
   <br/>
   Restaurant Service
   <br/>
   Jenkins Cl
   <br/>
   Deployment pipeline
   <br/>
   Delivery Service
   <br/>
   source code
   <br/>
   repository
   <br/>
   Delivery Service
  </p>
<p>
   معماری microservice یک application را به عنوان مجموعه‌ای از servicesها که loosely coupled هستند، ساختار می‌دهد
   که در اطراف business capabilitiesها سازماندهی شده‌اند. هر تیم، servicesهای خود را به طور مستقل توسعه، تست و deploy می‌کند.
  </p>
</div>
</div>
                <div class="page-images">
</div>
            </div>
            <div class="page original-page">
                <img src="page_0521_original/original_page.png" alt="Original Page 521">
            </div>
        </div>
        <div class="dual-page-spread">
            <div class="page persian-page">
                <div class="translated-content">
<div>
<p>
   Chris Richardson
   <br/>
   S
   <br/>
   uccessfully developing microservices-based applications
   <br/>
   requires mastering a new set of architectural insights and
   <br/>
   practices. In this unique book, microservice architecture
   <br/>
   pioneer and Java Champion Chris Richardson collects, cata-
   <br/>
   logues, and explains 44 patterns that solve problems such as
   <br/>
   service decomposition, transaction management, querying,
   <br/>
   and inter-service communication.
  </p>
<p>
   Microservices Patterns teaches you how to develop and deploy
   <br/>
   production-quality microservices-based applications. This
   <br/>
   invaluable set of design patterns builds on decades of dis-
   <br/>
   tributed system experience, adding new patterns for writing
   <br/>
   services and composing them into systems that scale and
   <br/>
   perform reliably under real-world conditions. More than just
   <br/>
   a patterns catalog, this practical guide offers experience-driven
   <br/>
   advice to help you design, implement, test, and deploy your
   <br/>
   microservices-based application.
  </p>
<p>
   What’s Inside
   <br/>
   ● How (and why!) to use the microservice architecture
   <br/>
   ● Service decomposition strategies
   <br/>
   ● Transaction management and querying patterns
   <br/>
   ● Effective testing strategies
   <br/>
   ● Deployment patterns including containers and serverless
  </p>
<p>
   Written for enterprise developers familiar with standard enter-
   <br/>
   prise application architecture. Examples are in Java.
  </p>
<p>
   Chris Richardson is a Java Champion, a JavaOne rock star,
   <br/>
   author of Manning’s POJOs in Action, and the creator of the
   <br/>
   original CloudFoundry.com.
  </p>
<p>
   To download their free eBook in PDF, ePub, and Kindle formats, owners
   <br/>
   of this book should visit manning.com/books/microservices-patterns
   <br/>
   $49.99 / Can $65.99 [INCLUDING eBOOK]
  </p>
<p>
   Microservices Patterns
   <br/>
   SOFTWARE DEVELOPMENT
   <br/>
   M A N N I N G
   <br/>
   “
   <br/>
   A comprehensive overview
   <br/>
   of the challenges teams face
   <br/>
   when moving to microservices,
   <br/>
   with industry-tested solutions
   <br/>
   to these problems.”
   <br/>
   —Tim Moore, Lightbend
   <br/>
   “
   <br/>
   Pragmatic treatment of
   <br/>
   an important new
   <br/>
   architectural landscape.”
   <br/>
   —Simeon Leyzerzon
   <br/>
   Excelsior Software
   <br/>
   “
   <br/>
   A solid compendium of
   <br/>
   information that will quicken
   <br/>
   your migration to this modern
   <br/>
   cloud-based architecture.”
   <br/>
   —John Guthrie, Dell/EMC
   <br/>
   “
   <br/>
   How to understand the
   <br/>
   microservices approach, and
   <br/>
   how to use it in real life.”
   <br/>
   —Potito Coluccelli
   <br/>
   Bizmatica Econocom
   <br/>
   See first page
  </p>
</div>
</div>
                <div class="page-images">
<div class="page-image"><img alt="Image from page 522" src="page_0522/image_1.png"/></div>
<div class="page-image"><img alt="Image from page 522" src="page_0522/image_2.png"/></div>
<div class="page-image"><img alt="Image from page 522" src="page_0522/image_3.png"/></div>
<div class="page-image"><img alt="Image from page 522" src="page_0522/image_4.png"/></div>
</div>
            </div>
            <div class="page original-page">
                <img src="page_0522_original/original_page.png" alt="Original Page 522">
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            if (window.Prism) {
                Prism.highlightAll();
            }
        });
    </script>
</body>
</html>